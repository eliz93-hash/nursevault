<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<link rel="manifest" id="__nvManifest">
<script>
(function(){
  var m = {"name": "NurseVault \u2014 Nursing School Handouts", "short_name": "NurseVault", "description": "Nursing school handouts, past questions, results and more.", "start_url": "./", "display": "standalone", "background_color": "#080c10", "theme_color": "#38bdf8", "orientation": "portrait-primary", "icons": [{"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAIOUlEQVR4nO2dPZYUOwxGNZw55xEQELIMUtK3AdbKBkhJWQYhAQFEvIBjXtF0dbnKkixZ94b89JRd37Xk+ul5EjDh5avXPzU/7/u3r0+anwe/YFIH0A75VZDjOkxcJ1HC3gtS9MEk7ZAt8EcgxH2YlA2rhX4PZPif8hNRJfR7VJeh5OC9Qv/2wxeVz/n8/o3K5xxRUYZSA7YIvlbIr2IhRyURSgxUK/izw96LlhQVRFh2gBqhzxL4IzSEWFWG5QY1GvxVQr/HqAyribDUYK6Gf/XQ73FVhpUkWGIgBH+MyiKkHsCV4BP6x1yRIbMIKQ88S/C1rsZkOfaMIqQ74LPhtw6P102qPaKNL5sEaQ42SvBnB/6IKOPOIkKKgzwTfu0ARA/8ETPnI4ME4Q+wN/yaJzp76PeYMUfRJQh7cN6r/qqh38N7zqKKEPKgPFf9asG/xXMOI0oQ7oC8wl89+Ld4zWc0CcIcDMGPQTURQhyER/gJ/jk85jqCBNMPwDr8BH8M63mfLcHUH94TfoIfA8vzMFOCaT/YKvwE3xarczJLghczfijhz8uVOe45l7O+ncPdOovwE/w5WJwn70rgWgEI/1qcnfuIlcDNtqOB0fLkxeLceVUClx+iHX6CHxPt8+ghgXkLRPjroN0SebRDpgIQ/npkk8BMAMJfl0wSPFt9sBYEPyftvEX/Fg6TCqC1+hP+/PSew1lVQF0Awg+3RJZAVQDCD3tElcDtTjDhBy0JNFET4JGZhB8aGhJoVgEVAar/ni3wRytzwwLQ98NZIu0HTPcAhB/2iLIfGBKAvh9GiLAfuCyARvkh/KCRgZEsmrRA0W9/Qz6sMnVJAFof0GRmKzTlYbgK4bdYsVaet8/v30zpHE5XgNHVf+WTCGP0ZEO7CqjtAej7wQvNrJ0SYPTKD6s/HDGakbMZ7RaA1ge88GyFpnwzHEAUugRg9QdvvKoAFQBKMyQAqz9YMloFejgUgGf9ISs92b1cAVj9wQPrKvBQAFZ/yM5Rhi9VAFZ/8MSyCuwKwOoPq/AoyyaXQVn9QRurTJ0WgIfeICpXsnlXgJH2h9UfrBjJ1l6mT1UAVn+IztmMqu4BWP3BGu2M/SUAV39gVe5lu7sC0P5AFs5kVa0Fov0BLzSz9ocAtD+wOrcZ76oAtD+Qjd7MqrRAtD/gjVbmeCMMSvNbAPp/qMI264cVgP4fstKT3eEWiP4fZqGRPfYAUBoEgNK8EGEDDPVomX9YAY42EfT/MJujDB5lmBYISoMAUBoEgNIgAJQGAaA0z9kvgVZ6VCPqWLNeDXz56vXP3V+TyiVQWz79+89ff/bu448JR5Kfo1+x+vbDl928Tvk9wZW5F/zbv0MEPxDAiUfB3/u3iGAPm2AHzoRf4/9BPwgApUEAY0ZXcaqALQgApUEAQ7RWb6qAHQgApUEAKA0CQGkQAEqDAIZo3cnljrAdCAClQQBjRldvVn9bEABKgwAOXF3FWf3t4XFoJ1qYe+7qEnw/divA6BcOwX3effyxG/BHfwf7jLy9+Pz929en7O8FZ4Sgz+f7t69P6VugqO8mW1TIqGPNDJtgKA0CQGkQAEqDAFCahwJwKRSiM/oFbi9Efl0O0jskgPi0zNMCQWkQAEozLAD7AJiFRvYOBeDuI2SlJ7u/BWAjDFXYZp09AJRGRQD2AeCNVua6BGAfANnozewfArAPgNW5zbjaHoA2CLzQzFq3ALRBkIUzWf1LANogWJV72Va9DEobBNZoZ+yUALRBEJ2zGb0rwEgbRBUAK0aytZfp0y0QVQCiciWbJo9CUAVAG6tM7QrA1SBYhUdZvlQBekoNVQC06MnS1db8oQBUAcjOUYYv7wGoAuCB5eov0iEAVQCy0pPdoatAVAGwxHr1F+GNMChOlwCPSglVACwYXf17W3cqAJSmWwCqAHjhtfqLnKwAo1eEkACOGM3I2YyqtUA8JAdeaGbttAC0QmCFZ+vTmLIJRgK4ZVYmLvf0j361au9gaJtARCcvV/enJhWAYIM2Vpm6LIDGM0K0QqCRgZEsDlWA0Q2xCBJUZmbr0zDdBCMB7BFlnzgswJGBSAC3aIVfow1XqQC8MwDeaGVOrQViPwA9ROj7t7jdCEMCiNL3b1EVgP0A7BGp79+iXgGQAG6JGn4RoxYICaAROfwiIs8WH6pJm0Aer8hFlsXLbBOsVQUaWSYUzp+rWau/iPFVICSoR6bwizhcBkWCOmQLv8jA+wBnefT+gMi1YLMviIHFufN6usD1EYYjCUT0VxGwxeJ8eT5a4/pKZM/AaInykD38Is4VoGFRCUSoBl5YnZsZD1VOeSneohKIUA08WCn8IpMqQMOqEohQDbSxPA8zH6ef/hx/jwQiiDAL63mf/S7JdAFE7CUQQYSzeMz17PCLBBFAxEcCEUQ4wmt+I4RfJJAADUSYQ7XgN0IdTMNLAhFE8JzDaOEXCSqASL8EIohwBe85ixh+kcACNDyrQWNVGWbMUdTgN0IfXMO7GmzJLsPM+YgefpEkAoick0DE7q5wdCGijDtD+EUSCdCIIkJjthDRxpcl+I1UB9s4K4HInOeEtOTIcuzZwi+SVIBGFhEyUSX4jbQHvuWKCCLI0LhaqTIHv5F+AFsQ4RyVg99YZiCNqxI0VpdhdF+yUvhFFhSgMSqCyDoyaGzGVwt+Y8lB3aIhg0geIbSuPq0a+i3LD3CLlghbZkthcR+iQvAbZQa6xUKEe2jJ4XWzrVLwG+UGfIuXDFGpGPotpQd/SxUZqod+CxOxw2oyEPr7MCmdZBOCwPfBJA0QRQrCfh0mzghtOQi5Df8BVyNch7+ahwEAAAAASUVORK5CYII=", "sizes": "192x192", "type": "image/png", "purpose": "any maskable"}, {"src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAZI0lEQVR4nO3dPZZkxREG0IDDOcLAwGQZcuVqA6xVG5Arl2VgYmAgCxmtYnpmurrrJ38iIu+1pZmiXmZ+34v3uuebAMr6/ocf/9z59//x+2/f7Pz7gcfZvJDI7kCfTWGAPGxGWKh7wD9LQYB1bDaYQNCPpRjAeDYVPEHQ76UYwONsHriRsK9BKYDb2ChwhcDvQSGAt9kY8H8C/wwKAbywETiWwCdCIeBcFj7HEPjcQiHgFBY6rQl9nqEM0JnFTSsCn5kUAjqxmClP6LODMkB1FjAlCX0yUQaoyKKlDKFPBcoAVViopCb0qUwZIDOLk5QE/+3+/q9ft/y9v/z805a/tyJFgIwsStIQ+i92BfpsCsMLZYAsLES2Oy34uwb8s04rCIoAu1mAbHFC6Av6MU4oBsoAO1h0LNU1+IX9Wl1LgSLAShYb03ULfWGfU7dSoAwwmwXGNF2CX+DX1KUQKALMYmExXPXgF/g9VS8EigCjWVAMUzX4Bf6ZqhYCRYBRLCSeVi34BT5vqVYIFAGeZQHxsErBL/S5R6UyoAjwKAuHu1UJfqHPCFXKgCLAvSwYblYh+IU+M1UoA4oAt7JQ+FD24Bf67JC9DCgCfMQC4arMwS/0ySRzGVAEuMbC4CtZg1/oU0HWMqAI8CULgr8IfhhHESA7C4GIyBf+Qp9OspUBJYAIBeB4gh/WUQTIxMU/VKbgF/qcKFMZUATO5KIfRvBDLooAu7jYB8kS/oJ/rF0B4jqOlaUIKAHncKEPIPjryRIGo7j2t8ty7RWB/lzg5jKEv8P/bVkO+t2sj7dlWB9KQG8ublO7g9+h/kmGg7wia+iT3WtIEejJRW1G8O+1+6DuzvpSBBjHxWxkZ/ifeDDvPox5Ye2tpQT04UI24K5/DYFfg/W4hiJQnwtYnLv+eXYfsIxhnc6jBNTm4hUl+OcQ+r1Zu3MoAjW5aAXtCv+Oh6fAP5s1PY4SUI8LVsyO8O92SAp93mKdP08JqMXFKsJd/3OEPvew7p+jCNTgIhXgrv8xQp8R7IXHKAH5uUDJrQ7/6oed0Gcm++M+SkBuLk5S7vrvI/hZyV65jyKQk4uSkLv+2wh9MrB/bqME5OOCJLMy/B1cMI799DElIBcXIwl3/e8T+lRif71PEcjBRUjAXf91gp/K7LfrlID9XIDNhP/bBD+d2HtvUwL28uVvtCr8qxw+Qp8T2I+fUwL28cVv4K7/c4KfE9mbn1ME1vOFL+au/xPBD/bqa0rAWr7shYT/C8EPX7NvXygB6/iiFxH+gh9uYQ8rAav4khdYEf4ODejl9D2tBMznC57o9Lt+wQ/PO31/KwLzfLv7A3Ql/IU/jJB1L606e3b8w2in0KwmOHnkn/Wwgg5O3vcmAeP5Qgc7NfwFP6xz6hmgBIzlyxzoxPAX/LDPieeBEjCOL3KQ2eGfbaNHCH/I4MSzQQkYw5c4wGnhL/ghn9POCSXgeb7AJ50U/oIf8jvpzFACnuPHAJ8g/IFsMu3V2WeYHxF8jvb0oJkLT/ADI5xylpgEPMYE4AHCH6gg0x6eebaZBDxGa7rTCeGf6dAAxjjhfDEJuI8JwB2EP1BVlr1tEpCHtnSj7uGf5XAA5ut+5pgE3MYE4AbCH+gkw543CdhPAfiA8Ac6yrD3lYC9jEne0Tn8M2x+IIfO55HHAdf5Yq6YFf67N1qE8Ae+1vlsUgLe5hHAG4Q/cJoMZ8OsM9LjgLdpRV/oGv4ZNjdQQ9fzyiTgcyYArwh/gP1nhknAGgrA/wl/gE92nx1KwHzGIdEz/HdvXqCPjmeZxwEmAMIf4AM7zxSTgHmOLgDCH+A2SkA/RxeAGYQ/0FXHEnCyYwvAjOYn/IHuupWAk6cAR74E0Sn8BT+wS6dz78SXAo+bAAh/gDF2nUEmAWMcVQCEP8BYSkBdxxSAThdW+AOZdDqTOmXFR44pADPsuPvvtNGAPnacTX4y4DlHFIAuo3/hD2TWpQScMgVoXwCEP8A6SkAdrQuA8AdYTwmooW0BEP4A+ygB+bUtAKMJf4D7dCkBXbUsAKMbm/AHeEyHEtB1CtCuAAh/gFyUgJxaFYAOF0j4Ax11ONs6ZMxrrQrAaKvv/jtsEIBrVp9x3gd4X5sCUH30L/yBE1QvAZ2mAC0KgPAHqEMJyKF8ARD+APUoAfuVLwCVCX/gZM7AvUoXgMp3/xY+wNqz0BTgc2ULgPAH6EEJ2KNkARD+AL0oAeuVLABVCX+A65yRa5UrAFXv/i1sgI+tOitNAYoVgKrhD0A+p5eAUgVgJM/9AXKq/D5AJWUKQLVmdSH8Ae5X9eyslFUlCkDV0X/VBQyQgfcB5ipRAEYS/gB1VC0BFaQvACOblPAHqKdiCagwBUhfAACA8VIXAHf/AESYAsyQtgAIfwBeUwLGSlsAqhH+APM5a8dJWQAq3v0D0McJU4B0BaBi+GukAOt4FDBGugJQjfAHWM/Z+7xUBaDa3b8FCLDPijO48xQgVQEYxXN/AEbpminf7f4AF9ma0Ufc/TND14PmNXuHkX75+adS++b7H37884/ff/tm9+eIaDgBMPoHOEu1RwFZpCgAle7+hT9APpXO5iyZt70AVHvxD4AzdXshcHsBGMXoH+BsHgXcZ2sByNCAbiX8AfKrdFbvzsAWE4BOjQyA3LpkzrYCsLv53KNSowQ4XaUze2cWlp8AzG5ilRYSAC9mn90dpgBbCsCoxtPhAgBQ06gM2jUFKD8BmMndP0BdzvD3LS8AVe7+LRyA+qo8CtgxBTABAIADLS0A7v4BWM0U4G0mAABwoGUFwN0/ALuYAnzNBOAV4Q/QlzP+c0sKQJW7fwB4VLUpQJkJgNE/AM+q8ihghekFoNLv/AeADFZkZ4kJgLt/AEYxBXgxtQC4+weAx8zO0PQTAHf/AIxmCjCxAFS4+xf+AOeqkAEzszT9BAAAGG9KAajwc/8Vmh8Ac83Mguy/F8AEAAAOlLYAuPsHYIUKU4AZhheACi//AUAlM7I15QTA3T8AK504BRhaANz9A8AcozM23QTA3T8AO5w2BUhXAACA+YYVgBGjCXf/AOyUfQow8jGACQAAHGhIAcj+8p+7fwBulT0zRmVumglAxhckAGCkTFmXpgAAAOs8XQC8/AdANye8DGgCAAAHeqoAePkPgK6yZ8izGbx9ApDphQgAWCFD9m0vALNkb24A5Nc5Sx4uANlf/gOAzHa/DNh2AgAAXNeyAHQe2QCwVtdMeagAGP8DwPN2PgZoNwHo2tQA2KdjtrQrAADAx+4uAMb/ADDOrscArSYAHUc0AOTQLWNaFQAA4DZ3FYDM4/9uzQyAfGZlzY7HACYAAHAgBQAADrS0ABj/A1Bd5scA97i5AIx4/g8AzHNPVnsEAAAHWlYAjP8B6KLDY4CbCoDxPwDUcGtmewQAAAdaUgCM/wHopvpjABMAADjQhwXA838AqOWW7C47ATD+B2C3ylk0vQCs/s1GAFDdiuwsOwEAAB73bgHw/B8Aavoow0tOACo/cwGgl6qZNLUAeP4PAI+ZnaElJwAAwHOuFoCsz/+rjloA6CtrNr2X5SYAAHCgaQXA838AeM7MLDUBAIADvVkAPP8HgPtkzahrmW4CAAAHmlIAPP8HgDFmZaoJAAAcqEwByPpsBQAuKmXVVwUg6wuAAMBj3sr2MhMAAGCc4QXAC4AAMNaMbDUBAIADlSgAlV6qAOBsVTKrRAEAAMb6rAD4CQAA6OnLjB86AfACIADMMTpjPQIAgAOlLwBVXqYAgIsK2ZW+AAAA4ykAAHCgvwqAnwAAgN5eZ/2wCYCfAACAuUZmrUcAAHCg1AWgwluUAPCW7BmWugAAAHMoAABwIAUAAA6kAADAgb6L8DsATubHN1nNmssl+4tqjPf9Dz/++cfvv30zZAJgQwPAGqMyN+0jAK0UgOoyZ9l3uz8AsM5//vm3D/83//j3fxd8EmA3BQAauyXwP/r/KATQkwIADT0S/B/9WYoA9KIAQCMjg//an60IQA8KADQwM/iv/V2KANSW9qcAgNusDP8Mfy8whgIAhe0O4d1/P/A4BQCKyhK+WT4HcB8FAArKFrrZPg/wsW/9OwBQS9awzfq5gK99/8OPfz49AZjx7wBk/tWJsFP2kM3++WCHGZk2Ins9AoAiqoRrlc8Jp1MAAOBACgAUUO2uutrnhRMpAABwIAUAkqt6N131c8MpFAAAOJACAIlVv4uu/vmhMwUAAA6kAADAgRQAADiQAgBJdXl+3uW/A7pRAADgQAoAABxIAQCAAykAAHAgBQAADqQAAMCBFAAAOJACAAAHUgAgqX/8+7+7P8IQXf47oBsFAAAOpAAAwIEUAAA4kAIAiVV/fl7980NnCgAAHEgBgOSq3kVX/dxwCgUAAA6kAEAB1e6mq31eOJECAAAHeroA/PLzTyM+x2f+/q9fh/+ZUF2Vu+oqnxNWmZFpI7L32z9+/+2bAZ8FWCB7uGb/fMCLP37/7RuPAKCYrCGb9XMBb1MAoKBsYZvt8wAfUwCgqCyhm+VzAPdRAKCw3eG7++8HHqcAQHG7Qlj4Q23f7f4AwPMuYfyff/5t2d8F1KYAQCMzi4Dgh14UAGhoZBEQ/NCTAgCNfRnetxQCgQ9nSFsA/v6vX6f8mmE4mXCHtTL/avshPwUgqAFgjVGZ+23Ey+8EHvKnAQCpXTI/7SMA1jC9ySXzuHAUaw5y8IuAAOBACgAAHEgBAIADpS4AJzwPBaCn7BmWugAAAHMMKwDe7AWAuUZm7V8FwO8CAIDeXme9RwAAcCAFAAAOlL4AZH+LEgC+VCG70hcAAGC8oQXATwIAwByjM/azAuAnAQCgpy8z3iMAADhQiQJQ4WUKAIiok1klCgAAMNbwAuBFQAAYa0a2mgAAwIG+KgB+EgAAenkr28tMAKq8VAHAuSplVZkCAACMM6UAeBEQAMaYlakmAABwoDcLQNYXASs9WwHgLFkz6lqmmwAAwIGmFQDvAQDAc2ZmqQkAABzoagHwHgAA3CZrNr2X5SYAAHCgqQXAewAA8JjZGVpyApB11ALAeapm0rsFIOt7AADA+z7K8JITAADgOdMLgPcAAOA+K7Kz7ASg6jMXAPqonEUfFgDvAQBALbdkd9kJAADwuCUFYNazjMqjFwBqm5VBq96dMwEAgAPdVAC8BwAANdya2csmAB4DANBF9fF/hEcAAHCkmwuAxwAAkNs9Wb10AuAxAADVdRj/R3gEAABHUgAA4EB3FYAR7wF4DABAVZnH//dmtAkAAByoVQEwBQBglm4Zc3cByPwYAACq2TH+j2g2AQAAbtOuAHQb0QCwX8dseagAeAwAAM/bNf6PaDgBiOjZ1ADYo2umtCwAAMD7Hi4AHgMAwON2jv8jGk8Auo5sAFinc5ZsLwCmAACcJkP2PVUARjwGmKlzcwNgruwZ8mwGb58AAADrPV0Asr8MmL3BAZDPzOzY/fLfhQkAABwoTQHI8EIEAMyUKeuGFAAvAwLQRfbMGJW5aSYAAMA6wwqAlwEBqO6El/8uTAAA4EDpCoApAAA7ZL/7H21oAcj+MiAAVDU6Y9NNACJMAQBY67S7/4gJBcAUAADGmpGtKScAEaYAAKxx4t1/ROICAADMM6UAjBpVmAIAMFOFu/9Zj9ZNAADgQNMKQIWXAU0BAM5VIQNmZmn6CcDsFygqLAAAxpp99md++e9iagGoMAUAgIxmZ2j6CUCEKQAA47j7fzG9AJgCAMB9VmRniQlAhCkAAM9z9//JkgJQ4fcCAMAzsv/c/5fKTABWMAUA6MsZ/7llBaDKFMACAeinyuh/5XtzJgAAcKClBcAUAIDV3P2/zQQAAA60vACYAgCwirv/60wA3qEEANTlDH/flgJQZQoAANdUvvuPaDAB8CgAgC9VGf3vtK0AVPo3ApQAgDoqndk7s7D8BCCiRxMDoIYumbO1AJgCADBSpbN6dwa2mABErGlklRYWwGlWnNFd7v4jEhSAkQ2o04UBIJeRGbP77j8iQQGIyPFF3MoUACCfSmdzlsxLUQBG8igA4CxG/49JUwCyNKJbKQEA+1U7izNl3Xe7P8AMv/z8U7lFARE97zKguq77Ms0EIKLeC4FKBsA+1Ub/me7+I5IVgIqUAID1nL3PS1cAqk0BIixEgJVWnbmd7/4jEhaAiJolAIA+uod/RNICUJEpAMB8ztpx0haAilMACxNgHqP/sdIWgAglAIAXwn+81AUAAJgjfQEwBQA4m7v/OdIXgNGUAIA6KoZ/FSUKwOgmpQQA5Fc1/Cvc/UcUKQARdb7QLykBAPerenZWyqoyBWC0leOeqgsZYIeVZ+aJo/+LUgWg6qMAAPI5dfR/UaoARNQtAaYAAB/z3H+dcgWgMiUA4Dpn5FolC0DVKUCEBQ7wlsrP/Sve/UcULQARSgBAF8J/j7IFIEIJAKhO+O9TugBUpwQAJ3MG7lW+AFSeAkTYAMCZVp997v6/Vr4ARCgBAJUI/xxaFIAIJQCgAuGfR5sCMIMSADBO9fDvplUB6NDMlACgow5nW4eMea1VAYio/yggosdGAbjYcaYZ/X+sXQGIUAIAshD+ebUsADMoAQD36RD+nbUtADMamxIAcJsu4d/17j+icQGIUAIAdhD+NbQuABFKAMBKwr+O9gUgQgkAWEH413JEAZhFCQB40SX8T3JMAejU6JQAIJNOZ1KnrPjIMQUgos+jgIheGw6oa9dZZPT/vKMKQIQSADCK8K/tuP/gi+9/+PHP0X/mzkD2LAxYpdtZd2L4Rxw4AbjoNAmIMA0A1hD+fRxbAGZRAoCuuoX/6Y4uALOanxIAdNMx/E+++484vABEKAEAHxH+PR3/BVzMeCkwYn8YG5sBj+p6fgn/F8dPAC46TgIi9m9goKbdZ4fwn08BeEUJANh/Zgj/NXwZb+j6OCBifxkB8up8Rgn/r5kAvKHrJCAixwYH8slwNgj/tXwp75g1CYjYv9kylBEgh87nkfC/zhfzgc4lIEIRgJN1P4OE//s8AvjAzAWUIXwzHADAehn2vvDfSwG4gRIAdJJhzwv//XxJd+j+OCAiRyEB5jjhnBH+tzMBuEP3SUBEngMCGCvL3hb+efiyHnDCJCAiTykBHnfKmSL872cC8IATJgERuQ4O4H6Z9rDwz8eX9oSZk4CIczYvMNZJZ4fwf5wJwBNmL7xMoZvpQAGuy7RXhX9uvrwBTpoEROQqJsCL084J4f88X+Agp5WACEUAMjjxbBD+Y/gSB5pdAiLybXYlAPY58TwQ/uP4Igc7sQREKAKw0qlngPAfy5c5waklIEIRgJlO3vfCfzxf6CQrSkDE2QcCnOL0fS785/BjgJOsWrBZgzbrgQXVZN1Lwr8+X+wCJz8SiMhbUiCz0/e04J/PF7zI6Y8EIhQBuIU9LPxX8SUvpAS8UATga/btC+G/ji96MSXgE0UA7NXXhP9avuwNVpWACIcLZGVvfk74r+cL38g04HOKACewHz8n+PfxxW9mGvA2ZYBO7L23Cf+9fPkJKAHXKQJUZr9dJ/z3cwGSWFkCIhxMMJP99T7hn4OLkIxpwMeUATKynz4m+HNxMRIyDbiNIkAG9s9thH8+LkhSq0tARN2DLEIZYC175T7CPycXJTnTgPsoAsxkf9xH8Ofm4hRgGvAYZYAR7IXHCP/8XKAidpSAiB6HX4QywH2s++cI/xpcpGJMA56nDPAW6/x5gr8WF6sg04BxlIGzWdPjCP96XLCidpWAiJ6H5oVC0Ju1O4fwr8lFK04RmEcZ6ME6nUfw1+biNbCzBET0P2AvFIIarMc1hH99LmAjpgFr7T6AeWHtrSX4+3AhmzEN2EspmMv6ctfPOC5mU4pAHrsP7aqsoU92ryHB35OL2tzuIhDhIL9m96GehfXxtgzrQ/D35uIeIEMJiHDQ3yPD4T+Sa3+7LNde+PfnAh9EEehpV2C4jmMJflZzoQ+TpQRECBCIyBP8EcL/NC72oRQB2Evws5uLfrhMRSBCGaC3TKEfIfhP5+ITEYoAzCT4ycgi4C/ZSsCFMkBF2UL/QvhzYSHwFUUAHif4qcKC4KqsRSBCGSCXrKEfIfi5zsLgQ5mLQIQywB6ZQz9C8PMxC4SbZS8CEcoAc2UP/QjBz+0sFO5WoQhEKAOMUSH0IwQ/97NgeFiVIhChDHCfKqEfIfh5nIXD0yoVgQhlgLdVCv0Iwc/zLCCGqVYELhSCM1UL/AvBzygWEsNVLQIXCkFPVQP/QvAzmgXFNNWLwIVCUFP1wL8Q/MxiYTFdlyJwoRDk1CXwLwQ/s1lgLNWtDFwoBWt1C/sLoc9KFhtbdC0CrykFY3QN+9cEPztYdGx3Qhl4TTF42wlB/5rQZzcLkDROKwLXdC0IpwX8NYKfLCxEUlIGbrerMAj02wl9MrIoSU0RoDLBT2YWJ2UoA1Qg9KnCQqUkZYBMhD4VWbSUpwywg9CnOguYVpQBZhL6dGIx05pCwDMEPp1Z3BxDGeAWQp9TWOgcSyEgQuBzLgsf/k8hOIPAhxc2AlyhEPQg8OFtNgbcSCGoQeDDbWwUeIJSsJewh8fZPDCBYjCWoIfxbCpYSDF4n6CHdWw2SKR7QRDwkIfNCIXtLgwCHer6HxOMiNHQ0QBcAAAAAElFTkSuQmCC", "sizes": "512x512", "type": "image/png", "purpose": "any maskable"}]};
  var blob = new Blob([JSON.stringify(m)], {type:'application/json'});
  document.getElementById('__nvManifest').href = URL.createObjectURL(blob);
})();
</script>
<meta name="theme-color" content="#38bdf8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NurseVault">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAIOUlEQVR4nO2dPZYUOwxGNZw55xEQELIMUtK3AdbKBkhJWQYhAQFEvIBjXtF0dbnKkixZ94b89JRd37Xk+ul5EjDh5avXPzU/7/u3r0+anwe/YFIH0A75VZDjOkxcJ1HC3gtS9MEk7ZAt8EcgxH2YlA2rhX4PZPif8hNRJfR7VJeh5OC9Qv/2wxeVz/n8/o3K5xxRUYZSA7YIvlbIr2IhRyURSgxUK/izw96LlhQVRFh2gBqhzxL4IzSEWFWG5QY1GvxVQr/HqAyribDUYK6Gf/XQ73FVhpUkWGIgBH+MyiKkHsCV4BP6x1yRIbMIKQ88S/C1rsZkOfaMIqQ74LPhtw6P102qPaKNL5sEaQ42SvBnB/6IKOPOIkKKgzwTfu0ARA/8ETPnI4ME4Q+wN/yaJzp76PeYMUfRJQh7cN6r/qqh38N7zqKKEPKgPFf9asG/xXMOI0oQ7oC8wl89+Ld4zWc0CcIcDMGPQTURQhyER/gJ/jk85jqCBNMPwDr8BH8M63mfLcHUH94TfoIfA8vzMFOCaT/YKvwE3xarczJLghczfijhz8uVOe45l7O+ncPdOovwE/w5WJwn70rgWgEI/1qcnfuIlcDNtqOB0fLkxeLceVUClx+iHX6CHxPt8+ghgXkLRPjroN0SebRDpgIQ/npkk8BMAMJfl0wSPFt9sBYEPyftvEX/Fg6TCqC1+hP+/PSew1lVQF0Awg+3RJZAVQDCD3tElcDtTjDhBy0JNFET4JGZhB8aGhJoVgEVAar/ni3wRytzwwLQ98NZIu0HTPcAhB/2iLIfGBKAvh9GiLAfuCyARvkh/KCRgZEsmrRA0W9/Qz6sMnVJAFof0GRmKzTlYbgK4bdYsVaet8/v30zpHE5XgNHVf+WTCGP0ZEO7CqjtAej7wQvNrJ0SYPTKD6s/HDGakbMZ7RaA1ge88GyFpnwzHEAUugRg9QdvvKoAFQBKMyQAqz9YMloFejgUgGf9ISs92b1cAVj9wQPrKvBQAFZ/yM5Rhi9VAFZ/8MSyCuwKwOoPq/AoyyaXQVn9QRurTJ0WgIfeICpXsnlXgJH2h9UfrBjJ1l6mT1UAVn+IztmMqu4BWP3BGu2M/SUAV39gVe5lu7sC0P5AFs5kVa0Fov0BLzSz9ocAtD+wOrcZ76oAtD+Qjd7MqrRAtD/gjVbmeCMMSvNbAPp/qMI264cVgP4fstKT3eEWiP4fZqGRPfYAUBoEgNK8EGEDDPVomX9YAY42EfT/MJujDB5lmBYISoMAUBoEgNIgAJQGAaA0z9kvgVZ6VCPqWLNeDXz56vXP3V+TyiVQWz79+89ff/bu448JR5Kfo1+x+vbDl928Tvk9wZW5F/zbv0MEPxDAiUfB3/u3iGAPm2AHzoRf4/9BPwgApUEAY0ZXcaqALQgApUEAQ7RWb6qAHQgApUEAKA0CQGkQAEqDAIZo3cnljrAdCAClQQBjRldvVn9bEABKgwAOXF3FWf3t4XFoJ1qYe+7qEnw/divA6BcOwX3effyxG/BHfwf7jLy9+Pz929en7O8FZ4Sgz+f7t69P6VugqO8mW1TIqGPNDJtgKA0CQGkQAEqDAFCahwJwKRSiM/oFbi9Efl0O0jskgPi0zNMCQWkQAEozLAD7AJiFRvYOBeDuI2SlJ7u/BWAjDFXYZp09AJRGRQD2AeCNVua6BGAfANnozewfArAPgNW5zbjaHoA2CLzQzFq3ALRBkIUzWf1LANogWJV72Va9DEobBNZoZ+yUALRBEJ2zGb0rwEgbRBUAK0aytZfp0y0QVQCiciWbJo9CUAVAG6tM7QrA1SBYhUdZvlQBekoNVQC06MnS1db8oQBUAcjOUYYv7wGoAuCB5eov0iEAVQCy0pPdoatAVAGwxHr1F+GNMChOlwCPSglVACwYXf17W3cqAJSmWwCqAHjhtfqLnKwAo1eEkACOGM3I2YyqtUA8JAdeaGbttAC0QmCFZ+vTmLIJRgK4ZVYmLvf0j361au9gaJtARCcvV/enJhWAYIM2Vpm6LIDGM0K0QqCRgZEsDlWA0Q2xCBJUZmbr0zDdBCMB7BFlnzgswJGBSAC3aIVfow1XqQC8MwDeaGVOrQViPwA9ROj7t7jdCEMCiNL3b1EVgP0A7BGp79+iXgGQAG6JGn4RoxYICaAROfwiIs8WH6pJm0Aer8hFlsXLbBOsVQUaWSYUzp+rWau/iPFVICSoR6bwizhcBkWCOmQLv8jA+wBnefT+gMi1YLMviIHFufN6usD1EYYjCUT0VxGwxeJ8eT5a4/pKZM/AaInykD38Is4VoGFRCUSoBl5YnZsZD1VOeSneohKIUA08WCn8IpMqQMOqEohQDbSxPA8zH6ef/hx/jwQiiDAL63mf/S7JdAFE7CUQQYSzeMz17PCLBBFAxEcCEUQ4wmt+I4RfJJAADUSYQ7XgN0IdTMNLAhFE8JzDaOEXCSqASL8EIohwBe85ixh+kcACNDyrQWNVGWbMUdTgN0IfXMO7GmzJLsPM+YgefpEkAoick0DE7q5wdCGijDtD+EUSCdCIIkJjthDRxpcl+I1UB9s4K4HInOeEtOTIcuzZwi+SVIBGFhEyUSX4jbQHvuWKCCLI0LhaqTIHv5F+AFsQ4RyVg99YZiCNqxI0VpdhdF+yUvhFFhSgMSqCyDoyaGzGVwt+Y8lB3aIhg0geIbSuPq0a+i3LD3CLlghbZkthcR+iQvAbZQa6xUKEe2jJ4XWzrVLwG+UGfIuXDFGpGPotpQd/SxUZqod+CxOxw2oyEPr7MCmdZBOCwPfBJA0QRQrCfh0mzghtOQi5Df8BVyNch7+ahwEAAAAASUVORK5CYII=">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="NurseVault">
<title>NurseVault â€” Nursing School Handouts</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Instrument+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// PDF.js config â€” set after load too in case script is deferred
function initPdfJs(){
  if(typeof pdfjsLib!=='undefined'){
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    window['pdfjs-dist/build/pdf']=pdfjsLib;
  }
}
initPdfJs();
window.addEventListener('load', initPdfJs);
</script>
<style>
:root {
  --bg:#080c10;--bg2:#0d1117;--bg3:#131920;--bg4:#191f28;
  --border:rgba(100,180,255,0.08);--border-hover:rgba(100,180,255,0.18);
  --accent:#38bdf8;--accent2:#818cf8;--accent3:#34d399;--accent4:#fb7185;
  --text:#e2eaf4;--text2:#7a92aa;--text3:#3d5068;
  --card:#0f1520;--card-hover:#151d2a;
  --nd1:#38bdf8;--nd2:#818cf8;--hnd1:#34d399;--hnd2:#fb7185;
}
/* LIGHT THEME â€” golden & army green */
body.light {
  --bg:#f5f0e8;--bg2:#ede8da;--bg3:#e3dccb;--bg4:#d9d0bc;
  --border:rgba(100,80,20,0.14);--border-hover:rgba(100,80,20,0.30);
  --accent:#b8860b;--accent2:#4a5e2a;--accent3:#4a7c3f;--accent4:#c0392b;
  --text:#2c2410;--text2:#5a4e2c;--text3:#8a7a52;
  --card:#ede8da;--card-hover:#e3dccb;
  --nd1:#b8860b;--nd2:#4a5e2a;--hnd1:#4a7c3f;--hnd2:#c0392b;
}
body.light{background:var(--bg);color:var(--text);}
body.light body::after{display:none;}
body.light .auth-brand-name,body.light .logo-text{background:linear-gradient(135deg,#b8860b,#4a5e2a);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;}
body.light .btn-primary,body.light .btn-action,body.light .btn-submit,body.light .btn-submit-green,body.light .pv-dl-btn{background:linear-gradient(135deg,#b8860b,#4a5e2a);}
body.light .auth-tab.active{background:rgba(184,134,11,.15);border-color:#b8860b;color:#b8860b;}
body.light .inp:focus,body.light .sel-inp:focus,body.light .search-inp:focus,body.light .sel:focus{border-color:#b8860b;}
body.light .nav-item.active{background:rgba(184,134,11,.12);color:#b8860b;}
body.light .user-av,.light .logo-icon,.light .auth-brand-icon{background:linear-gradient(135deg,#b8860b,#4a5e2a);}
body.light .class-card:hover{box-shadow:0 12px 32px rgba(100,80,20,.15);}
body.light #authPage{/* uses same background image */}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Instrument Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 10% 20%,rgba(56,189,248,.04) 0%,transparent 60%),radial-gradient(ellipse 60% 40% at 90% 80%,rgba(129,140,248,.04) 0%,transparent 60%);pointer-events:none;z-index:0;}

/* LAYOUT */
.app{display:flex;min-height:100vh;}
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;transition:transform .3s;overflow-y:auto;}
.main{flex:1;margin-left:260px;min-height:100vh;position:relative;z-index:1;}

/* AUTH */
#authPage{position:fixed;inset:0;background:linear-gradient(135deg, #080c10 0%, #0d1520 50%, #080c10 100%) center center / cover no-repeat;display:flex;align-items:center;justify-content:center;z-index:9999;overflow-y:auto;}
.auth-wrap{width:100%;max-width:420px;padding:20px;animation:fadeUp .5s ease;margin:auto;}
.auth-card{background:rgba(8,12,16,0.88);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:20px;padding:40px 36px;}
.auth-brand{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.auth-brand-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.auth-brand-name{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.auth-sub{color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;margin-bottom:28px;}
.auth-tabs{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:24px;}
.auth-tab{padding:9px 4px;text-align:center;border-radius:8px;cursor:pointer;font-size:12px;color:var(--text2);background:var(--bg3);border:1px solid var(--border);font-family:'DM Mono',monospace;transition:all .2s;}
.auth-tab:hover{border-color:var(--border-hover);color:var(--text);}
.auth-tab.active{background:rgba(56,189,248,.12);border-color:var(--accent);color:var(--accent);}
.inp-label{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;display:block;}
.inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:11px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;margin-bottom:14px;}
.inp:focus{border-color:var(--accent);}
.inp.error{border-color:var(--accent4);}
.sel-inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:11px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;margin-bottom:14px;appearance:none;cursor:pointer;}
.sel-inp:focus{border-color:var(--accent);}
.inp-err{font-size:11px;color:var(--accent4);font-family:'DM Mono',monospace;margin-top:-10px;margin-bottom:12px;display:none;}
.inp-err.show{display:block;}
.btn-primary{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:4px;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(56,189,248,.25);}
.auth-switch{text-align:center;margin-top:16px;font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;}
.auth-switch span{color:var(--accent);cursor:pointer;text-decoration:underline;}
.auth-notice{background:rgba(251,191,36,.07);border:1px solid rgba(251,191,36,.2);border-radius:10px;padding:10px 14px;font-size:11px;color:#fbbf24;font-family:'DM Mono',monospace;margin-bottom:18px;line-height:1.6;}
.auth-info{background:rgba(56,189,248,.07);border:1px solid rgba(56,189,248,.2);border-radius:10px;padding:10px 14px;font-size:11px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:18px;line-height:1.6;}

/* SIDEBAR */
.sidebar-logo{padding:20px 20px 8px;display:flex;align-items:center;gap:10px;}
.logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.logo-text{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.sidebar-section-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;letter-spacing:.1em;text-transform:uppercase;padding:0 14px;margin:14px 0 6px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;border-radius:8px;cursor:pointer;color:var(--text2);font-size:13.5px;transition:all .2s;margin:1px 8px;}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:rgba(56,189,248,.1);color:var(--accent);}
.nav-item .ni{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.sidebar-user{margin-top:auto;border-top:1px solid var(--border);padding:14px 16px;}
.user-row{display:flex;align-items:center;gap:10px;}
.user-av{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
.user-nm{font-size:13px;font-weight:600;}
.user-rl{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.logout-btn{width:100%;margin-top:8px;padding:8px;background:transparent;border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.05em;}
.logout-btn:hover{border-color:var(--accent4);color:var(--accent4);}
.user-av-img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.profile-btn{background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:10px;width:100%;text-align:left;}
.profile-btn:hover .user-av{box-shadow:0 0 0 2px var(--accent);}
/* â”€â”€ User Management Cards â”€â”€ */
.users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:16px;}
.user-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;display:flex;flex-direction:column;gap:14px;animation:fadeUp .35s ease forwards;opacity:0;position:relative;overflow:hidden;transition:border-color .2s,transform .2s;}
.user-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));}
.user-card.role-admin::before{background:linear-gradient(90deg,#fbbf24,#f59e0b);}
.user-card.role-teacher::before{background:linear-gradient(90deg,var(--accent),var(--accent2));}
.user-card.role-student::before{background:linear-gradient(90deg,var(--accent3),#059669);}
.user-card:hover{border-color:var(--border-hover);transform:translateY(-2px);}
.user-card-avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:white;flex-shrink:0;overflow:hidden;border:2px solid var(--border);}
.user-card-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.user-card-head{display:flex;align-items:center;gap:12px;}
.user-card-info{flex:1;min-width:0;}
.user-card-name{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-card-role{font-size:10px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-top:2px;}
.user-card-meta{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.user-card-field{background:var(--bg3);border-radius:8px;padding:8px 10px;}
.user-card-field-lbl{font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);margin-bottom:3px;}
.user-card-field-val{font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-card-actions{display:flex;gap:8px;}
/* â”€â”€ Profile Modal â”€â”€ */
.profile-modal-av-wrap{position:relative;width:90px;height:90px;margin:0 auto 20px;cursor:pointer;}
.profile-modal-av{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:700;color:white;overflow:hidden;border:3px solid var(--border);}
.profile-modal-av img{width:100%;height:100%;object-fit:cover;}
.profile-av-edit-badge{position:absolute;bottom:0;right:0;width:26px;height:26px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;border:2px solid var(--bg2);cursor:pointer;transition:transform .2s;}
.profile-av-edit-badge:hover{transform:scale(1.15);}
.profile-section-title{font-size:10px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);margin:18px 0 10px;border-bottom:1px solid var(--border);padding-bottom:6px;}

/* â”€â”€ Document Vault â”€â”€ */
.doc-vault-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
.doc-vault-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;transition:border-color .2s;}
.doc-vault-item:hover{border-color:var(--border-hover);}
.doc-vault-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.doc-vault-name{flex:1;font-size:13px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.doc-vault-meta{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;}
.doc-vault-actions{display:flex;gap:6px;flex-shrink:0;}
.doc-vault-btn{padding:5px 9px;border:1px solid var(--border);background:var(--bg4);border-radius:6px;color:var(--text2);font-size:11px;cursor:pointer;transition:all .2s;font-family:'DM Mono',monospace;}
.doc-vault-btn:hover{border-color:var(--accent);color:var(--accent);}
.doc-vault-btn.danger:hover{border-color:var(--accent4);color:var(--accent4);}
.doc-upload-zone{border:2px dashed var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;margin-top:8px;}
.doc-upload-zone:hover,.doc-upload-zone.drag-over{border-color:var(--accent);background:rgba(56,189,248,.04);}
.doc-upload-zone-icon{font-size:24px;margin-bottom:6px;}
.doc-upload-zone-text{font-size:12px;color:var(--text2);}
.doc-upload-zone-sub{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;}
.prof-id-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;background:rgba(56,189,248,.1);color:var(--accent);border:1px solid rgba(56,189,248,.2);margin-bottom:2px;}
.doc-empty{text-align:center;padding:20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;}
.doc-preview-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.doc-preview-modal.open{opacity:1;pointer-events:all;}
.doc-preview-inner{background:var(--bg2);border:1px solid var(--border);border-radius:16px;width:90vw;max-width:860px;max-height:90vh;display:flex;flex-direction:column;}
.doc-preview-header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);}
.doc-preview-title{flex:1;font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.doc-preview-actions{display:flex;gap:8px;}
.doc-preview-body{flex:1;overflow:auto;padding:20px;}

/* â”€â”€ Messaging System â”€â”€ */
.msg-layout{display:flex;height:calc(100vh - 64px);overflow:hidden;}
.msg-sidebar{width:280px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg2);flex-shrink:0;}
.msg-sidebar-head{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.msg-sidebar-title{font-weight:700;font-size:15px;flex:1;}
.msg-new-btn{width:30px;height:30px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s;color:var(--text2);}
.msg-new-btn:hover{border-color:var(--accent);color:var(--accent);}
.msg-search{padding:10px 14px;border-bottom:1px solid var(--border);}
.msg-search input{width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:'DM Mono',monospace;outline:none;transition:border-color .2s;}
.msg-search input:focus{border-color:var(--accent);}
.msg-channels{flex:1;overflow-y:auto;padding:8px;}
.msg-channel-group-label{font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);padding:10px 8px 4px;}
.msg-channel-item{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:10px;cursor:pointer;transition:background .15s;position:relative;margin-bottom:2px;}
.msg-channel-item:hover{background:var(--bg3);}
.msg-channel-item.active{background:var(--card-hover);border:1px solid var(--border-hover);}
.msg-channel-av{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;font-weight:700;overflow:hidden;}
.msg-channel-av img{width:100%;height:100%;object-fit:cover;}
.msg-channel-info{flex:1;min-width:0;}
.msg-channel-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msg-channel-preview{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'DM Mono',monospace;margin-top:1px;}
.msg-channel-time{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;flex-shrink:0;}
.msg-unread{width:18px;height:18px;border-radius:50%;background:var(--accent);color:#000;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;position:absolute;top:8px;right:8px;}
.msg-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.msg-main-head{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid var(--border);background:var(--bg2);}
.msg-main-av{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;overflow:hidden;flex-shrink:0;}
.msg-main-av img{width:100%;height:100%;object-fit:cover;}
.msg-main-name{font-weight:700;font-size:15px;}
.msg-main-sub{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;}
.msg-body{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:4px;}
.msg-date-divider{text-align:center;margin:12px 0 8px;}
.msg-date-divider span{font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);background:var(--bg3);padding:3px 10px;border-radius:20px;border:1px solid var(--border);}
.msg-bubble-wrap{display:flex;align-items:flex-end;gap:8px;margin-bottom:4px;}
.msg-bubble-wrap.mine{flex-direction:row-reverse;}
.msg-bubble-wrap.mine .msg-av-sm{display:none;}
.msg-av-sm{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;overflow:hidden;align-self:flex-end;}
.msg-av-sm img{width:100%;height:100%;object-fit:cover;}
.msg-bubble-col{display:flex;flex-direction:column;max-width:68%;}
.msg-sender-name{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:3px;padding-left:2px;}
.msg-bubble{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.55;word-break:break-word;position:relative;}
.msg-bubble.them{background:var(--bg3);border:1px solid var(--border);color:var(--text);border-bottom-left-radius:4px;}
.msg-bubble.mine{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-bottom-right-radius:4px;}
.msg-bubble.lecture{background:linear-gradient(135deg,rgba(251,113,133,.15),rgba(251,191,36,.08));border:1px solid rgba(251,113,133,.2);color:var(--text);border-bottom-left-radius:4px;}
.msg-bubble.lecture::before{content:'ðŸ“¢';position:absolute;top:-8px;left:10px;font-size:12px;}
.msg-bubble-time{font-size:9px;font-family:'DM Mono',monospace;margin-top:3px;padding-left:2px;}
.msg-bubble-wrap.mine .msg-bubble-time{text-align:right;color:rgba(255,255,255,.6);}
.msg-bubble-wrap:not(.mine) .msg-bubble-time{color:var(--text3);}
.msg-input-bar{display:flex;align-items:flex-end;gap:10px;padding:14px 20px;border-top:1px solid var(--border);background:var(--bg2);}
.msg-input-wrap{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:10px 14px;transition:border-color .2s;}
.msg-input-wrap:focus-within{border-color:var(--accent);}
.msg-input{width:100%;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:'Instrument Sans',sans-serif;resize:none;max-height:100px;line-height:1.5;}
.msg-send-btn{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:opacity .2s;flex-shrink:0;}
.msg-send-btn:hover{opacity:.85;}
.msg-icon-btn{width:38px;height:38px;border-radius:10px;background:var(--bg3);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:all .2s;flex-shrink:0;color:var(--text2);}
.msg-icon-btn:hover{border-color:var(--accent);color:var(--accent);}
.msg-icon-btn.rec-active{background:rgba(251,113,133,.15);border-color:#fb7185;color:#fb7185;animation:pulse 1s ease-in-out infinite;}
/* File bubble */
.msg-file-bubble{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;cursor:pointer;max-width:270px;transition:opacity .2s;}
.msg-file-bubble:hover{opacity:.82;}
.msg-file-bubble.mine{background:rgba(255,255,255,.15);}
.msg-file-bubble.them{background:var(--bg4,var(--bg3));border:1px solid var(--border);}
.msg-file-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.msg-file-info{flex:1;min-width:0;}
.msg-file-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msg-file-meta{font-size:10px;font-family:'DM Mono',monospace;opacity:.6;margin-top:2px;}
/* Image bubble */
.msg-img-thumb{max-width:220px;border-radius:12px;overflow:hidden;cursor:pointer;display:inline-block;}
.msg-img-thumb img{width:100%;display:block;}
/* Voice bubble */
.msg-voice-bubble{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:14px;min-width:200px;max-width:280px;}
.msg-voice-play{width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;transition:transform .15s;}
.msg-voice-play:hover{transform:scale(1.08);}
.msg-voice-bars{flex:1;display:flex;align-items:center;gap:2px;height:28px;cursor:pointer;}
.msg-voice-bar-item{flex:1;border-radius:2px;transition:opacity .2s;}
.msg-voice-dur{font-size:10px;font-family:'DM Mono',monospace;flex-shrink:0;}
/* Recording bar */
.msg-record-bar{display:none;align-items:center;gap:12px;padding:12px 20px;border-top:1px solid var(--border);background:var(--bg2);}
.msg-record-bar.active{display:flex;}
.msg-rec-timer{font-family:'DM Mono',monospace;font-size:14px;font-weight:700;color:#fb7185;min-width:48px;}
.msg-rec-wave{flex:1;height:32px;background:var(--bg3);border-radius:8px;overflow:hidden;display:flex;align-items:center;gap:2px;padding:0 8px;}
.msg-rec-wave-bar{flex:1;border-radius:2px;background:#fb7185;transition:height .12s;}
.msg-rec-cancel{padding:7px 13px;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--text2);font-size:12px;cursor:pointer;font-family:'DM Mono',monospace;transition:all .2s;}
.msg-rec-cancel:hover{border-color:#fb7185;color:#fb7185;}
.msg-rec-send{padding:7px 13px;border:none;border-radius:8px;background:#fb7185;color:#fff;font-size:12px;cursor:pointer;font-family:'DM Mono',monospace;font-weight:700;transition:opacity .2s;}
@keyframes recPulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(1.2);}}
.msg-rec-send:hover{opacity:.85;}
.msg-empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text3);}
.msg-empty-icon{font-size:48px;opacity:.4;}
.msg-empty-text{font-size:14px;font-weight:600;color:var(--text2);}
.msg-empty-sub{font-size:12px;font-family:'DM Mono',monospace;}
.new-chat-modal-body{padding:16px;}
.msg-recipient-list{display:flex;flex-direction:column;gap:4px;max-height:calc(50vh - 60px);overflow-y:auto;}
.msg-recipient-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .2s;}
.msg-recipient-item:hover{border-color:var(--accent);background:var(--card-hover);}
.msg-recipient-av{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;overflow:hidden;flex-shrink:0;}
.msg-recipient-av img{width:100%;height:100%;object-fit:cover;}
.msg-typing{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;padding:4px 20px 0;}
.msg-announce-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;background:rgba(251,113,133,.1);border:1px solid rgba(251,113,133,.2);border-radius:6px;font-size:10px;color:#fb7185;font-family:'DM Mono',monospace;margin-left:8px;}
@media(max-width:640px){.msg-sidebar{width:100%;position:absolute;z-index:10;height:100%;}.msg-sidebar.mobile-hidden{display:none;}.msg-main{width:100%;}.msg-back-btn{display:flex!important;}}
/* â”€â”€ Classmates Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.msg-classmates{width:240px;border-left:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg2);flex-shrink:0;transition:width .3s;}
.msg-classmates-head{padding:14px 14px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.msg-classmates-title{font-size:12px;font-weight:700;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.08em;color:var(--text2);display:flex;align-items:center;gap:6px;}
.msg-classmates-sub{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;}
.msg-classmates-search{padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.msg-classmates-search input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:6px 10px;color:var(--text);font-size:12px;font-family:'Instrument Sans',sans-serif;outline:none;}
.msg-classmates-search input:focus{border-color:var(--accent);}
.msg-classmates-list{flex:1;overflow-y:auto;padding:6px;}
.msg-classmate-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:9px;cursor:pointer;transition:all .15s;border:1px solid transparent;}
.msg-classmate-item:hover{background:var(--bg3);border-color:var(--border-hover);}
.msg-classmate-av{width:30px;height:30px;border-radius:8px;background:rgba(129,140,248,.2);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;overflow:hidden;}
.msg-classmate-av img{width:100%;height:100%;object-fit:cover;}
.msg-classmate-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.msg-classmate-matric{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msg-classmate-btn{flex-shrink:0;padding:4px 8px;background:var(--accent);border:none;border-radius:6px;color:#fff;font-size:10px;font-weight:600;cursor:pointer;opacity:0;transition:opacity .15s;font-family:'DM Mono',monospace;}
.msg-classmate-item:hover .msg-classmate-btn{opacity:1;}
.msg-other-class-btn{width:100%;margin:8px 0 4px;padding:9px 12px;background:var(--bg3);border:1.5px dashed var(--border-hover);border-radius:9px;color:var(--text2);font-size:12px;font-family:'Instrument Sans',sans-serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .2s;}
.msg-other-class-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(56,189,248,.06);}
.msg-class-section-hd{font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);padding:8px 4px 4px;margin-top:4px;}
/* Hide classmates panel on smaller screens */
@media(max-width:1000px){.msg-classmates{display:none;}}
@media(max-width:640px){.msg-sidebar{width:100%;position:absolute;z-index:10;height:100%;}.msg-sidebar.mobile-hidden{display:none;}.msg-main{width:100%;}.msg-back-btn{display:flex!important;}}

.msg-back-btn{display:none;cursor:pointer;padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--text2);align-items:center;gap:5px;}
.msg-notification-dot{width:8px;height:8px;border-radius:50%;background:var(--accent4);display:inline-block;margin-left:6px;vertical-align:middle;animation:pulse 1.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.role-badge-lg{display:inline-flex;padding:4px 12px;border-radius:6px;font-size:11px;font-family:'DM Mono',monospace;font-weight:700;text-transform:uppercase;letter-spacing:.07em;}
.class-chip{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;transition:all .2s;margin:1px 8px;font-family:'DM Mono',monospace;}
.class-chip:hover{background:var(--bg3);color:var(--text);}
.class-chip.active{color:white;}
.class-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* TOPBAR */
.topbar{display:flex;align-items:center;gap:14px;padding:22px 28px 0;flex-wrap:wrap;}
.topbar-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;}
.search-box{position:relative;flex:1;min-width:200px;max-width:360px;}
.search-box .si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px;}
.search-inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:9px 14px 9px 36px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s;}
.search-inp:focus{border-color:var(--accent);}
.search-inp::placeholder{color:var(--text3);}
.btn-action{display:flex;align-items:center;gap:7px;padding:9px 16px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-action:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(56,189,248,.2);}
.btn-ghost{display:flex;align-items:center;gap:7px;padding:9px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;color:var(--text2);font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-ghost:hover{border-color:var(--border-hover);color:var(--text);}

/* CONTENT */
.content{padding:24px 28px 48px;}
.classes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;}
.class-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px;cursor:pointer;transition:all .25s;animation:fadeUp .4s ease forwards;opacity:0;position:relative;overflow:hidden;}
.class-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--class-color,var(--accent)),transparent);}
.class-card:hover{border-color:var(--border-hover);background:var(--card-hover);transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.3);}
.class-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.class-badge{padding:4px 10px;border-radius:6px;font-family:'DM Mono',monospace;font-size:11px;font-weight:500;}
.class-count{font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;}
.class-name{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:4px;}
.class-fullname{font-size:12px;color:var(--text2);margin-bottom:16px;}
.class-stats{display:flex;gap:16px;}
.class-stat{font-size:12px;color:var(--text2);}
.class-stat strong{color:var(--text);font-family:'Syne',sans-serif;}
.add-class-card{background:transparent;border:1px dashed var(--border);border-radius:16px;padding:22px;cursor:pointer;transition:all .25s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-height:140px;color:var(--text3);animation:fadeUp .4s ease forwards;opacity:0;}
.add-class-card:hover{border-color:var(--accent);color:var(--accent);background:rgba(56,189,248,.03);}
.add-class-card .plus{font-size:28px;}
.add-class-card span{font-size:13px;font-family:'DM Mono',monospace;}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);margin-bottom:20px;flex-wrap:wrap;}
.bc-item{cursor:pointer;transition:color .2s;}
.bc-item:hover{color:var(--accent);}
.bc-sep{color:var(--text3);}
.bc-current{color:var(--text2);}
.courses-list{display:flex;flex-direction:column;gap:10px;}
.course-row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .2s;animation:fadeUp .3s ease forwards;opacity:0;}
.course-row:hover{border-color:var(--border-hover);background:var(--card-hover);}
.course-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.course-info{flex:1;min-width:0;}
.course-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:600;margin-bottom:2px;}
.course-code{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.course-meta{font-size:12px;color:var(--text3);text-align:right;white-space:nowrap;}
.course-meta strong{display:block;color:var(--text2);font-family:'Syne',sans-serif;font-size:14px;}
.add-course-btn{background:transparent;border:1px dashed var(--border);border-radius:12px;padding:14px 20px;display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--text3);transition:all .2s;font-size:13px;font-family:'DM Mono',monospace;animation:fadeUp .3s ease forwards;opacity:0;animation-delay:.15s;}
.add-course-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(56,189,248,.03);}
.handouts-list{display:flex;flex-direction:column;gap:10px;}
.handout-row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .2s;animation:fadeUp .3s ease forwards;opacity:0;}
.handout-row:hover{border-color:var(--border-hover);background:var(--card-hover);}
.file-badge{padding:4px 8px;border-radius:5px;font-size:10px;font-family:'DM Mono',monospace;font-weight:500;text-transform:uppercase;flex-shrink:0;}
.fb-pdf{background:rgba(251,113,133,.15);color:var(--accent4);}
.fb-doc{background:rgba(56,189,248,.15);color:var(--accent);}
.fb-ppt{background:rgba(251,191,36,.15);color:#fbbf24;}
.fb-img{background:rgba(52,211,153,.15);color:var(--accent3);}
.handout-info{flex:1;min-width:0;}
.handout-title{font-size:14px;font-weight:500;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.handout-teacher{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.handout-date{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;white-space:nowrap;}
.handout-actions{display:flex;gap:6px;}
.icon-btn{width:30px;height:30px;border-radius:7px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);font-size:13px;transition:all .2s;}
.icon-btn:hover{border-color:var(--accent);color:var(--accent);}
.add-handout-btn{background:transparent;border:1px dashed var(--border);border-radius:12px;padding:12px 20px;display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--text3);transition:all .2s;font-size:13px;font-family:'DM Mono',monospace;animation:fadeUp .3s ease forwards;opacity:0;animation-delay:.1s;}
.add-handout-btn:hover{border-color:var(--accent3);color:var(--accent3);background:rgba(52,211,153,.03);}
.sec-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px;flex-wrap:wrap;}
.sec-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;}
.sec-sub{font-size:12px;color:var(--text2);margin-top:2px;}

/* MODALS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;}
.overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:18px;width:100%;max-width:480px;animation:scaleIn .25s ease;max-height:90vh;overflow-y:auto;}
.modal-wide{max-width:580px;}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:22px 24px 18px;border-bottom:1px solid var(--border);}
.modal-ht{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;}
.modal-x{width:30px;height:30px;border-radius:7px;background:var(--bg3);border:none;color:var(--text2);cursor:pointer;font-size:17px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.modal-x:hover{background:var(--border);color:var(--text);}
.modal-bd{padding:22px 24px 24px;}
.form-g{margin-bottom:15px;}
.form-g .inp-label{margin-bottom:5px;}
.sel{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:11px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;appearance:none;cursor:pointer;}
.sel:focus{border-color:var(--accent);}
.drop-area{border:2px dashed var(--border);border-radius:12px;padding:32px 20px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px;}
.drop-area:hover{border-color:var(--accent);background:rgba(56,189,248,.03);}
.drop-area.has-file{border-color:var(--accent3);background:rgba(52,211,153,.05);}
.drop-ico{font-size:32px;margin-bottom:8px;}
.drop-txt{font-size:13px;color:var(--text2);}
.drop-txt strong{color:var(--accent);}
.drop-fmts{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:4px;}
.btn-submit{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-submit:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(56,189,248,.25);}
.btn-submit-green{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent3),#059669);border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-submit-green:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(52,211,153,.25);}

/* ======= PAST QUESTIONS ======= */
.pq-topbar-sub{font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;margin-top:3px;}
.pq-controls{display:flex;align-items:center;gap:10px;padding:16px 28px 0;flex-wrap:wrap;}
.pq-filter-sel{background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:8px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s;appearance:none;cursor:pointer;}
.pq-filter-sel:focus{border-color:var(--accent2);}
.pq-bank-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;}
.pq-bank-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px;transition:all .25s;animation:fadeUp .4s ease forwards;opacity:0;position:relative;overflow:hidden;}
.pq-bank-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent2),var(--accent));}
.pq-bank-card:hover{border-color:var(--border-hover);background:var(--card-hover);transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.3);}
.pq-bank-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:10px;}
.pq-bank-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;flex:1;line-height:1.4;}
.pq-bank-badge{padding:3px 9px;border-radius:5px;font-family:'DM Mono',monospace;font-size:10px;font-weight:600;flex-shrink:0;}
.pq-bank-meta{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;margin-bottom:14px;}
.pq-bank-stats{display:flex;gap:14px;margin-bottom:16px;}
.pq-bank-stat{font-size:12px;color:var(--text2);}
.pq-bank-stat strong{color:var(--text);font-family:'Syne',sans-serif;}
.pq-bank-footer{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.pq-best-score{font-size:11px;font-family:'DM Mono',monospace;flex:1;}
.pq-mode-btns{display:flex;gap:6px;}
.pq-mode-btn{display:flex;align-items:center;gap:5px;padding:7px 13px;border:none;border-radius:8px;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
.pq-mode-btn.exam{background:linear-gradient(135deg,#fb7185,#e11d48);color:white;}
.pq-mode-btn.study{background:linear-gradient(135deg,#34d399,#059669);color:white;}
.pq-mode-btn:hover{transform:translateY(-1px);filter:brightness(1.1);}
.pq-del-btn{width:30px;height:30px;border-radius:7px;background:transparent;border:1px solid var(--border);color:var(--text3);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.pq-del-btn:hover{border-color:var(--accent4);color:var(--accent4);background:rgba(251,113,133,.1);}
.pq-empty{text-align:center;padding:60px 20px;}
.pq-empty-ico{font-size:48px;margin-bottom:12px;}
.pq-empty-t{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:6px;}
.pq-empty-s{font-size:13px;color:var(--text2);}

/* Mode Picker Modal */
.mode-picker-overlay{position:fixed;inset:0;z-index:3500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);}
.mode-picker-overlay.open{display:flex;animation:fadeUp .3s ease;}
.mode-picker-card{background:var(--bg2);border:1px solid var(--border);border-radius:22px;padding:36px 32px;max-width:500px;width:90%;animation:scaleIn .25s ease;}
.mode-picker-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:6px;text-align:center;}
.mode-picker-sub{font-size:13px;color:var(--text2);text-align:center;margin-bottom:28px;font-family:'DM Mono',monospace;}
.mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.mode-card{border-radius:14px;padding:22px 18px;cursor:pointer;transition:all .25s;border:2px solid transparent;text-align:center;}
.mode-card.exam-mode{background:rgba(251,113,133,.08);border-color:rgba(251,113,133,.2);}
.mode-card.study-mode{background:rgba(52,211,153,.08);border-color:rgba(52,211,153,.2);}
.mode-card:hover.exam-mode{border-color:#fb7185;transform:translateY(-3px);box-shadow:0 10px 28px rgba(251,113,133,.2);}
.mode-card:hover.study-mode{border-color:#34d399;transform:translateY(-3px);box-shadow:0 10px 28px rgba(52,211,153,.2);}
.mode-card-ico{font-size:36px;margin-bottom:10px;}
.mode-card-name{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:6px;}
.mode-card.exam-mode .mode-card-name{color:#fb7185;}
.mode-card.study-mode .mode-card-name{color:#34d399;}
.mode-card-desc{font-size:12px;color:var(--text2);line-height:1.6;}
.mode-card-tags{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-top:10px;}
.mode-tag{padding:2px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:10px;}
.mode-card.exam-mode .mode-tag{background:rgba(251,113,133,.15);color:#fb7185;}
.mode-card.study-mode .mode-tag{background:rgba(52,211,153,.15);color:#34d399;}
.mode-picker-cancel{display:block;width:100%;margin-top:14px;padding:10px;background:transparent;border:1px solid var(--border);border-radius:9px;color:var(--text2);font-family:'DM Mono',monospace;font-size:12px;cursor:pointer;transition:all .2s;}
.mode-picker-cancel:hover{border-color:var(--border-hover);color:var(--text);}

/* Import Modal */
.pq-import-wrap{display:flex;flex-direction:column;gap:0;}
.pq-import-tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:18px;}
.pq-import-tab{padding:9px 6px;text-align:center;border-radius:8px;cursor:pointer;font-size:12px;color:var(--text2);background:var(--bg3);border:1px solid var(--border);font-family:'DM Mono',monospace;transition:all .2s;}
.pq-import-tab.active{background:rgba(129,140,248,.12);border-color:var(--accent2);color:var(--accent2);}
.pq-import-tab:hover{border-color:var(--border-hover);color:var(--text);}
.pq-import-info{background:rgba(129,140,248,.07);border:1px solid rgba(129,140,248,.2);border-radius:10px;padding:11px 14px;font-size:11px;color:var(--accent2);font-family:'DM Mono',monospace;margin-bottom:16px;line-height:1.8;}
.pq-import-info code{background:rgba(129,140,248,.15);padding:1px 5px;border-radius:3px;}
.pq-paste-area{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:12px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;transition:border-color .2s;resize:vertical;min-height:200px;line-height:1.7;}
.pq-paste-area:focus{border-color:var(--accent2);}
.pq-paste-area::placeholder{color:var(--text3);}
.pq-parse-preview{background:var(--bg3);border:1px solid var(--border);border-radius:10px;margin:14px 0;overflow:hidden;max-height:260px;overflow-y:auto;}
.pq-preview-hd{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);position:sticky;top:0;background:var(--bg3);}
.pq-preview-q{padding:10px 14px;border-bottom:1px solid var(--border);font-size:12px;}
.pq-preview-q:last-child{border-bottom:none;}
.pq-preview-qn{font-weight:600;margin-bottom:4px;color:var(--text);font-size:12px;}
.pq-preview-opts{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.pq-preview-opt{padding:2px 8px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;background:var(--bg4);color:var(--text2);}
.pq-preview-opt.correct{background:rgba(52,211,153,.15);color:var(--accent3);}
.pq-ai-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:11px;background:linear-gradient(135deg,rgba(129,140,248,.15),rgba(56,189,248,.1));border:1px solid rgba(129,140,248,.3);border-radius:9px;color:var(--accent2);font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;margin-bottom:10px;}
.pq-ai-btn:hover{background:linear-gradient(135deg,rgba(129,140,248,.25),rgba(56,189,248,.2));transform:translateY(-1px);}
.pq-ai-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.pq-ai-status{font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);padding:8px 12px;background:var(--bg3);border-radius:8px;border:1px solid var(--border);margin-bottom:10px;display:none;line-height:1.6;}
.pq-ai-status.show{display:block;}
.pq-ai-spin{display:inline-block;width:10px;height:10px;border:2px solid var(--border);border-top-color:var(--accent2);border-radius:50%;animation:spin .7s linear infinite;margin-right:6px;vertical-align:middle;}

/* Quiz Overlay */
.quiz-overlay{position:fixed;inset:0;z-index:3000;display:none;flex-direction:column;background:var(--bg);}
.quiz-overlay.open{display:flex;animation:fadeUp .3s ease;}
.quiz-topbar{display:flex;align-items:center;gap:12px;padding:12px 20px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.quiz-mode-pill{padding:4px 12px;border-radius:20px;font-family:'DM Mono',monospace;font-size:10px;font-weight:700;letter-spacing:.04em;flex-shrink:0;}
.quiz-mode-pill.exam{background:rgba(251,113,133,.15);color:#fb7185;border:1px solid rgba(251,113,133,.3);}
.quiz-mode-pill.study{background:rgba(52,211,153,.15);color:#34d399;border:1px solid rgba(52,211,153,.3);}
.quiz-title-block{flex:1;min-width:0;}
.quiz-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.quiz-subtitle{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.quiz-progress-bar-wrap{width:160px;flex-shrink:0;}
.quiz-progress-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:4px;display:flex;justify-content:space-between;}
.quiz-progress-bar{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden;}
.quiz-progress-fill{height:100%;border-radius:3px;transition:width .4s ease;}
.quiz-progress-fill.exam{background:linear-gradient(90deg,#fb7185,#e11d48);}
.quiz-progress-fill.study{background:linear-gradient(90deg,#34d399,#059669);}
.quiz-timer{display:flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;font-size:13px;color:var(--text2);background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 11px;flex-shrink:0;}
.quiz-timer.warn{color:var(--accent4);border-color:var(--accent4);animation:pulse .8s ease infinite;}
.quiz-body{flex:1;overflow-y:auto;padding:28px 20px;display:flex;flex-direction:column;align-items:center;}
.quiz-card{width:100%;max-width:700px;}
.quiz-qnum{font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.quiz-qnum-badge{padding:2px 9px;border-radius:4px;font-size:10px;}
.quiz-qnum-badge.exam{background:rgba(251,113,133,.15);color:#fb7185;}
.quiz-qnum-badge.study{background:rgba(52,211,153,.15);color:#34d399;}
.quiz-question{font-family:'Syne',sans-serif;font-size:19px;font-weight:700;line-height:1.55;margin-bottom:24px;color:var(--text);}
.quiz-options{display:flex;flex-direction:column;gap:10px;}
.quiz-opt{display:flex;align-items:flex-start;gap:12px;padding:14px 18px;background:var(--card);border:2px solid var(--border);border-radius:12px;cursor:pointer;transition:all .22s;animation:fadeUp .3s ease forwards;opacity:0;}
.quiz-opt:hover:not(.disabled){transform:translateX(4px);}
.quiz-opt:hover:not(.disabled).exam-opt{border-color:#fb7185;background:rgba(251,113,133,.06);}
.quiz-opt:hover:not(.disabled).study-opt{border-color:#34d399;background:rgba(52,211,153,.06);}
.quiz-opt.selected.exam-opt{border-color:#fb7185;background:rgba(251,113,133,.1);}
.quiz-opt.selected.study-opt{border-color:var(--accent2);background:rgba(129,140,248,.1);}
.quiz-opt.correct{border-color:var(--accent3)!important;background:rgba(52,211,153,.12)!important;}
.quiz-opt.wrong{border-color:var(--accent4)!important;background:rgba(251,113,133,.1)!important;}
.quiz-opt.disabled{cursor:default;}
.quiz-opt-key{width:28px;height:28px;border-radius:7px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:12px;font-weight:600;flex-shrink:0;transition:all .2s;color:var(--text2);}
.quiz-opt.selected.exam-opt .quiz-opt-key{background:#fb7185;border-color:#fb7185;color:white;}
.quiz-opt.selected.study-opt .quiz-opt-key{background:var(--accent2);border-color:var(--accent2);color:white;}
.quiz-opt.correct .quiz-opt-key{background:var(--accent3)!important;border-color:var(--accent3)!important;color:white!important;}
.quiz-opt.wrong .quiz-opt-key{background:var(--accent4)!important;border-color:var(--accent4)!important;color:white!important;}
.quiz-opt-text{font-size:14px;line-height:1.5;padding-top:4px;}
.quiz-feedback{border-radius:10px;padding:13px 16px;margin-top:16px;font-size:13px;line-height:1.6;animation:fadeUp .3s ease;}
.quiz-feedback.correct-fb{background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.25);color:var(--accent3);}
.quiz-feedback.wrong-fb{background:rgba(251,113,133,.07);border:1px solid rgba(251,113,133,.2);color:var(--accent4);}
.quiz-feedback.reveal-fb{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.2);color:#fbbf24;}
.quiz-feedback strong{font-family:'Syne',sans-serif;}
/* exam mode â€” no feedback until submit */
.quiz-exam-hint{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;padding:10px 14px;background:rgba(251,113,133,.05);border:1px solid rgba(251,113,133,.12);border-radius:8px;margin-top:12px;}
.quiz-footer{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:var(--bg2);border-top:1px solid var(--border);flex-shrink:0;gap:12px;flex-wrap:wrap;}
.quiz-nav-btn{display:flex;align-items:center;gap:7px;padding:9px 18px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;color:var(--text2);font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.quiz-nav-btn:hover:not(:disabled){border-color:var(--border-hover);color:var(--text);}
.quiz-nav-btn:disabled{opacity:.3;cursor:not-allowed;}
.quiz-submit-btn{display:flex;align-items:center;gap:7px;padding:9px 20px;border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}
.quiz-submit-btn.exam-sub{background:linear-gradient(135deg,#fb7185,#e11d48);}
.quiz-submit-btn.study-sub{background:linear-gradient(135deg,#34d399,#059669);}
.quiz-submit-btn:hover{transform:translateY(-1px);}
.quiz-end-exam-btn{display:flex;align-items:center;gap:6px;padding:9px 18px;background:transparent;border:1px solid rgba(251,113,133,.3);border-radius:9px;color:#fb7185;font-family:'Syne',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;}
.quiz-end-exam-btn:hover{background:rgba(251,113,133,.1);border-color:#fb7185;}
.quiz-dot-nav{display:flex;gap:5px;flex-wrap:wrap;max-width:300px;}
.quiz-dot{width:10px;height:10px;border-radius:50%;background:var(--bg4);cursor:pointer;transition:all .2s;border:1px solid var(--border);}
.quiz-dot.answered.exam{background:rgba(251,113,133,.6);}
.quiz-dot.answered.study{background:var(--accent2);}
.quiz-dot.current{transform:scale(1.4);}
.quiz-dot.current.exam{background:#fb7185;}
.quiz-dot.current.study{background:var(--accent);}
.quiz-dot.correct{background:var(--accent3)!important;}
.quiz-dot.wrong{background:var(--accent4)!important;}

/* Results screen */
.quiz-result-overlay{position:fixed;inset:0;z-index:3100;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);backdrop-filter:blur(10px);}
.quiz-result-overlay.open{display:flex;animation:fadeUp .4s ease;}
.quiz-result-card{background:var(--bg2);border:1px solid var(--border);border-radius:22px;padding:36px 30px;max-width:500px;width:92%;text-align:center;animation:scaleIn .3s ease;max-height:90vh;overflow-y:auto;}
.quiz-result-icon{font-size:52px;margin-bottom:10px;}
.quiz-result-mode-badge{display:inline-block;padding:3px 12px;border-radius:20px;font-family:'DM Mono',monospace;font-size:10px;font-weight:700;margin-bottom:12px;}
.quiz-result-mode-badge.exam{background:rgba(251,113,133,.15);color:#fb7185;}
.quiz-result-mode-badge.study{background:rgba(52,211,153,.15);color:#34d399;}
.quiz-result-title{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;margin-bottom:6px;}
.quiz-result-sub{font-size:12px;color:var(--text2);margin-bottom:20px;font-family:'DM Mono',monospace;}
.quiz-result-score-ring{width:110px;height:110px;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;flex-direction:column;}
.quiz-result-score-pct{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;}
.quiz-result-score-lbl{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.quiz-result-breakdown{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;}
.quiz-result-stat{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 8px;}
.quiz-result-stat-val{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:2px;}
.quiz-result-stat-lbl{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;}
.quiz-result-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.quiz-result-btn{padding:9px 18px;border-radius:9px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;border:none;}
.quiz-result-btn.primary-exam{background:linear-gradient(135deg,#fb7185,#e11d48);color:white;}
.quiz-result-btn.primary-study{background:linear-gradient(135deg,#34d399,#059669);color:white;}
.quiz-result-btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text2);}
.quiz-result-btn:hover{transform:translateY(-1px);}
.review-banner{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:8px 14px;font-size:11px;color:#fbbf24;font-family:'DM Mono',monospace;margin-bottom:16px;display:flex;align-items:center;gap:8px;}

@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}

/* STATS */
.stats-strip{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;}
.stat-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;}
.stat-lbl{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px;}
.stat-val{font-family:'Syne',sans-serif;font-size:24px;font-weight:700;}
.stat-s{font-size:11px;color:var(--text2);margin-top:2px;}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-size:13px;z-index:9999;display:flex;align-items:center;gap:8px;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:slideUp .3s ease;max-width:300px;}
.toast-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--accent3);}

/* PREVIEW â€” FULL SCREEN VIEWER */
.pv-overlay{position:fixed;inset:0;z-index:2000;display:none;flex-direction:column;background:var(--bg);}
.pv-overlay.open{display:flex;animation:fadeUp .25s ease;}

/* Top bar */
.pv-topbar{display:flex;align-items:center;gap:12px;padding:12px 18px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.pv-back{display:flex;align-items:center;gap:7px;padding:7px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;font-family:'DM Mono',monospace;transition:all .2s;white-space:nowrap;}
.pv-back:hover{border-color:var(--border-hover);color:var(--text);}
.pv-title-block{flex:1;min-width:0;}
.pv-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pv-subtitle{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pv-badge{padding:4px 10px;border-radius:6px;font-family:'DM Mono',monospace;font-size:11px;font-weight:600;text-transform:uppercase;flex-shrink:0;}
.pv-dl-btn{display:flex;align-items:center;gap:7px;padding:8px 18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:8px;color:white;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0;}
.pv-dl-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(56,189,248,.3);}
.pv-dl-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none;}

/* Toolbar (zoom, controls) */
.pv-toolbar{display:flex;align-items:center;gap:8px;padding:8px 18px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.pv-tool-btn{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:7px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:15px;transition:all .2s;flex-shrink:0;}
.pv-tool-btn:hover{border-color:var(--border-hover);color:var(--text);}
.pv-tool-btn:disabled{opacity:.3;cursor:not-allowed;}
.pv-zoom-val{font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);min-width:42px;text-align:center;}
.pv-sep{width:1px;height:20px;background:var(--border);margin:0 4px;flex-shrink:0;}
.pv-pg-info{font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);white-space:nowrap;}
.pv-toolbar-label{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;}
.pv-fullscreen-btn{margin-left:auto;display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:7px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:12px;font-family:'DM Mono',monospace;transition:all .2s;white-space:nowrap;}
.pv-fullscreen-btn:hover{border-color:var(--border-hover);color:var(--text);}

/* Viewer body */
.pv-body{flex:1;overflow:auto;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:24px;background:var(--bg);position:relative;}

/* PDF canvas */
.pv-pdf-wrap{display:flex;flex-direction:column;align-items:center;gap:16px;width:100%;}
.pv-canvas-page{background:white;border-radius:4px;box-shadow:0 4px 24px rgba(0,0,0,.4);display:block;max-width:100%;}

/* Image viewer */
.pv-img-wrap{display:flex;align-items:center;justify-content:center;width:100%;min-height:100%;}
.pv-img-display{border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5);transition:transform .2s;cursor:zoom-in;display:block;}
.pv-img-display.zoomed{cursor:zoom-out;}

/* Placeholder for unsupported types */
.pv-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:60px 20px;text-align:center;width:100%;}
.pv-ph-ico{font-size:80px;line-height:1;margin-bottom:4px;}
.pv-ph-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;}
.pv-ph-sub{font-size:14px;color:var(--text2);max-width:400px;line-height:1.6;}
.pv-ph-fname{font-family:'DM Mono',monospace;font-size:12px;color:var(--text3);background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 14px;margin-top:4px;}
.pv-meta-strip{display:flex;gap:24px;flex-wrap:wrap;padding:14px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-top:20px;}
.pv-meta-item{display:flex;flex-direction:column;gap:3px;}
.pv-meta-lbl{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;}
.pv-meta-val{font-size:13px;color:var(--text);}

/* Spinner */
.pv-spinner{display:flex;flex-direction:column;align-items:center;gap:16px;padding:60px;}
.pv-spin-ring{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.pv-spin-txt{font-size:13px;color:var(--text2);font-family:'DM Mono',monospace;}

/* Info panel (right side on desktop) */
.pv-info-panel{position:fixed;right:0;top:0;bottom:0;width:280px;background:var(--bg2);border-left:1px solid var(--border);z-index:2001;transform:translateX(100%);transition:transform .3s;overflow-y:auto;display:flex;flex-direction:column;}
.pv-info-panel.open{transform:translateX(0);}
.pv-info-hd{padding:16px;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:space-between;}
.pv-info-close{background:none;border:none;color:var(--text2);cursor:pointer;font-size:18px;}
.pv-info-body{padding:16px;display:flex;flex-direction:column;gap:14px;}
.pv-info-field{display:flex;flex-direction:column;gap:4px;}
.pv-info-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;}
.pv-info-value{font-size:13px;color:var(--text);line-height:1.5;}

@media(max-width:600px){
  .pv-topbar{padding:10px 12px;gap:8px;}
  .pv-toolbar{padding:6px 12px;}
  .pv-body{padding:12px;}
  .pv-title{font-size:14px;}
}

/* legacy (keep for modals) */
.btn-row{display:flex;gap:10px;}
.btn-row .btn-ghost,.btn-row .btn-action{flex:1;justify-content:center;}
.preview-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:var(--bg3);border-radius:10px;padding:14px 16px;margin-bottom:16px;}
.pmeta-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;}
.pmeta-val{font-size:13px;color:var(--text2);}

/* RESULTS */
.results-table-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px;}
.results-table{width:100%;border-collapse:collapse;font-size:13px;}
.results-table th{text-align:left;padding:11px 14px;font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3);white-space:nowrap;}
.results-table td{padding:11px 14px;border-bottom:1px solid var(--border);vertical-align:middle;}
.results-table tr:last-child td{border-bottom:none;}
.results-table tr:hover td{background:var(--card-hover);}
.score-pill{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-family:'DM Mono',monospace;font-size:12px;font-weight:600;}
.score-a{background:rgba(52,211,153,.15);color:var(--accent3);}
.score-b{background:rgba(56,189,248,.15);color:var(--accent);}
.score-c{background:rgba(251,191,36,.15);color:#fbbf24;}
.score-f{background:rgba(251,113,133,.15);color:var(--accent4);}
.result-type-badge{display:inline-flex;padding:2px 8px;border-radius:5px;font-size:10px;font-family:'DM Mono',monospace;font-weight:600;text-transform:uppercase;}
.rt-test{background:rgba(129,140,248,.15);color:var(--accent2);}
.rt-exam{background:rgba(251,113,133,.15);color:var(--accent4);}
.results-empty{padding:48px 20px;text-align:center;color:var(--text3);}
/* BULK PASTE IMPORT */
.paste-area{width:100%;min-height:130px;background:var(--bg3);border:2px dashed var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;resize:vertical;transition:border-color .2s;line-height:1.7;}
.paste-area:focus{border-color:var(--accent);}
.paste-area::placeholder{color:var(--text3);}
.parse-preview{margin-top:14px;border-radius:10px;overflow:hidden;border:1px solid var(--border);}
.parse-preview-hd{padding:9px 14px;background:var(--bg3);font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);display:flex;justify-content:space-between;align-items:center;}
.parse-row{display:grid;grid-template-columns:22px 100px 1fr 70px 60px 60px 24px;gap:8px;align-items:center;padding:8px 14px;border-bottom:1px solid var(--border);font-size:12px;}
.parse-row:last-child{border-bottom:none;}
.parse-row.parse-err{background:rgba(251,113,133,.06);}
.parse-row.parse-ok{background:rgba(52,211,153,.04);}
.parse-status{font-size:14px;flex-shrink:0;}
.parse-matric{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.parse-name{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.parse-score{font-family:'Syne',sans-serif;font-weight:700;text-align:center;}
.parse-grade{text-align:center;font-weight:700;font-family:'Syne',sans-serif;}
.parse-warn{font-size:10px;color:var(--accent4);font-family:'DM Mono',monospace;}
.parse-del{background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:2px;line-height:1;}
.parse-del:hover{color:var(--accent4);}
.modal-tabs{display:flex;border-bottom:1px solid var(--border);margin:-22px -24px 20px;padding:0 24px;}
.modal-tab{padding:12px 18px;font-size:13px;font-family:'DM Mono',monospace;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;}
.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.modal-tab:hover:not(.active){color:var(--text);}
.results-empty-ico{font-size:40px;margin-bottom:10px;}
.results-empty-t{font-family:'Syne',sans-serif;font-size:15px;color:var(--text2);margin-bottom:4px;}
.results-empty-s{font-size:12px;font-family:'DM Mono',monospace;}
.results-filter-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;align-items:center;}
.results-filter-bar .sel{max-width:180px;}
.my-result-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px 20px;display:flex;align-items:center;gap:16px;animation:fadeUp .3s ease forwards;opacity:0;}
.my-result-card:not(:last-child){margin-bottom:10px;}
.my-result-score{width:56px;height:56px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:16px;font-weight:800;flex-shrink:0;line-height:1.1;}
.my-result-info{flex:1;min-width:0;}
.my-result-title{font-size:14px;font-weight:600;margin-bottom:3px;}
.my-result-meta{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.my-result-grade{font-size:11px;font-family:'DM Mono',monospace;font-weight:700;}

/* MOBILE */
.mob-menu{display:none;position:fixed;top:14px;left:14px;z-index:200;background:var(--bg2);border:1px solid var(--border);border-radius:9px;width:38px;height:38px;align-items:center;justify-content:center;cursor:pointer;font-size:16px;}
.sidebar-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

@media(max-width:860px){
  .main{margin-left:0;}.sidebar{transform:translateX(-100%);}.sidebar.open{transform:translateX(0);}
  .mob-menu{display:flex;}.sidebar-bg.open{display:block;}.topbar{padding-top:60px;}
  .stats-strip{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:520px){
  .classes-grid{grid-template-columns:1fr;}.content{padding:16px 16px 48px;}
  .topbar{padding:60px 16px 0;}.stats-strip{grid-template-columns:1fr 1fr;}
}

.empty{text-align:center;padding:60px 20px;color:var(--text2);}
.empty-ico{font-size:40px;margin-bottom:12px;opacity:.5;}
.empty-t{font-family:'Syne',sans-serif;font-size:16px;color:var(--text);margin-bottom:6px;}
.empty-s{font-size:13px;}
.divider{height:1px;background:var(--border);margin:20px 0;}
.admin-crown{color:#fbbf24;margin-left:4px;}

/* SAVED ACCOUNTS DROPDOWN */
.inp-wrap{position:relative;margin-bottom:14px;}
.inp-wrap .inp{margin-bottom:0;}
.saved-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg2);border:1px solid var(--border-hover);border-radius:10px;z-index:9000;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,.4);display:none;}
.saved-dropdown.open{display:block;}
.saved-dropdown-hd{padding:8px 12px 6px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);}
.saved-account-item{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;transition:background .15s;}
.saved-account-item:hover{background:var(--bg3);}
.saved-account-item.active{background:var(--bg3);}
.saved-account-av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;}
.saved-account-info{flex:1;min-width:0;}
.saved-account-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.saved-account-email{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.saved-account-role{font-size:10px;font-family:'DM Mono',monospace;padding:2px 6px;border-radius:4px;flex-shrink:0;}
.saved-account-del{width:22px;height:22px;border-radius:5px;background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
.saved-account-del:hover{background:rgba(251,113,133,.15);color:var(--accent4);}
.saved-dropdown-empty{padding:14px 12px;font-size:12px;color:var(--text3);text-align:center;font-family:'DM Mono',monospace;}

/* PASSWORD FIELD WRAPPER */
.pass-wrap{position:relative;margin-bottom:14px;}
.pass-wrap .inp{margin-bottom:0;padding-right:42px;}
.pass-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text3);font-size:16px;line-height:1;transition:color .2s;padding:4px;}
.pass-toggle:hover{color:var(--accent);}

/* SAVE PASSWORD MODAL */
/* save-modal removed */
/* ===== FOLDER UPLOAD OVERLAY ===== */
.fu-overlay{position:fixed;inset:0;z-index:3000;display:none;flex-direction:column;background:var(--bg);}
.fu-overlay.open{display:flex;animation:fadeUp .25s ease;}
.fu-topbar{display:flex;align-items:center;gap:14px;padding:14px 20px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.fu-back{display:flex;align-items:center;gap:7px;padding:7px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;font-family:'DM Mono',monospace;transition:all .2s;}
.fu-back:hover{border-color:var(--border-hover);color:var(--text);}
.fu-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;flex:1;}
.fu-body{flex:1;display:flex;overflow:hidden;}
.fu-left{width:340px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg2);flex-shrink:0;}
.fu-right{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:20px;}

/* Drop zone */
.fu-dropzone{margin:20px;border:2px dashed var(--border);border-radius:16px;padding:36px 20px;text-align:center;cursor:pointer;transition:all .25s;flex-shrink:0;}
.fu-dropzone:hover,.fu-dropzone.drag-over{border-color:var(--accent);background:rgba(56,189,248,.04);}
.fu-dropzone.has-files{border-color:var(--accent3);background:rgba(52,211,153,.04);}
.fu-dz-ico{font-size:40px;margin-bottom:10px;}
.fu-dz-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:6px;}
.fu-dz-sub{font-size:12px;color:var(--text2);line-height:1.6;}
.fu-dz-sub strong{color:var(--accent);}
.fu-dz-hint{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:8px;}
.fu-dz-btns{display:flex;gap:8px;justify-content:center;margin-top:14px;flex-wrap:wrap;}
.fu-dz-btn{padding:8px 16px;border-radius:8px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:var(--bg3);color:var(--text2);}
.fu-dz-btn:hover{border-color:var(--accent);color:var(--accent);}
.fu-dz-btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;border:none;}

/* File tree */
.fu-tree-hd{padding:12px 16px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.fu-tree-hd span{color:var(--accent);}
.fu-tree{flex:1;overflow-y:auto;padding:0 8px 12px;}
.fu-folder-group{margin-bottom:4px;}
.fu-folder-label{display:flex;align-items:center;gap:7px;padding:6px 8px;border-radius:6px;font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;cursor:pointer;transition:background .15s;user-select:none;}
.fu-folder-label:hover{background:var(--bg3);}
.fu-folder-label .fu-fold-ico{font-size:13px;}
.fu-folder-label .fu-fold-name{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fu-folder-label .fu-fold-count{font-size:10px;color:var(--text3);}
.fu-file-item{display:flex;align-items:center;gap:8px;padding:5px 8px 5px 26px;border-radius:6px;font-size:12px;color:var(--text2);cursor:pointer;transition:background .15s;}
.fu-file-item:hover{background:var(--bg3);}
.fu-file-item.selected{background:rgba(56,189,248,.1);color:var(--accent);}
.fu-file-item.excluded{opacity:.35;text-decoration:line-through;}
.fu-file-ico{font-size:13px;flex-shrink:0;}
.fu-file-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fu-file-size{font-size:10px;color:var(--text3);white-space:nowrap;}
.fu-file-cb{width:14px;height:14px;accent-color:var(--accent);cursor:pointer;flex-shrink:0;}

/* Right panel â€” settings & progress */
.fu-section-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.fu-assignment-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.fu-field{display:flex;flex-direction:column;gap:5px;}
.fu-field label{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;}
.fu-sel{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s;appearance:none;cursor:pointer;}
.fu-sel:focus{border-color:var(--accent);}

/* File preview table */
.fu-files-table{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.fu-files-thead{display:grid;grid-template-columns:auto 1fr 120px 100px 80px;gap:0;padding:10px 14px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);}
.fu-files-row{display:grid;grid-template-columns:auto 1fr 120px 100px 80px;gap:0;padding:10px 14px;border-bottom:1px solid var(--border);align-items:center;transition:background .15s;}
.fu-files-row:last-child{border-bottom:none;}
.fu-files-row:hover{background:var(--card-hover);}
.fu-files-row.excluded-row{opacity:.4;}
.fu-file-cell{font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 6px;}
.fu-file-cell:first-child{padding-left:0;}
.fu-type-tag{padding:3px 7px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;font-weight:600;text-transform:uppercase;}
.fu-row-sel{font-size:13px;width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text2);appearance:none;cursor:pointer;outline:none;font-family:'DM Mono',monospace;}
.fu-row-sel:focus{border-color:var(--accent);}

/* Progress */
.fu-progress-wrap{display:flex;flex-direction:column;gap:10px;}
.fu-prog-item{display:flex;flex-direction:column;gap:5px;}
.fu-prog-row{display:flex;align-items:center;justify-content:space-between;font-size:12px;}
.fu-prog-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text2);}
.fu-prog-stat{font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);white-space:nowrap;margin-left:8px;}
.fu-prog-bar{height:4px;border-radius:2px;background:var(--bg3);overflow:hidden;}
.fu-prog-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s;}
.fu-prog-fill.done{background:var(--accent3);}
.fu-prog-fill.error{background:var(--accent4);}

/* Summary bar */
.fu-summary{display:flex;align-items:center;gap:16px;padding:14px 20px;background:var(--bg2);border-top:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.fu-sum-stat{display:flex;flex-direction:column;gap:2px;min-width:60px;}
.fu-sum-val{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;}
.fu-sum-lbl{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;}
.fu-sum-sep{width:1px;height:28px;background:var(--border);flex-shrink:0;}
.fu-action-btns{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap;}
.fu-btn-cancel{padding:9px 18px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.fu-btn-cancel:hover{border-color:var(--accent4);color:var(--accent4);}
.fu-btn-upload{padding:9px 24px;background:linear-gradient(135deg,var(--accent3),#059669);border:none;border-radius:8px;color:white;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}
.fu-btn-upload:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(52,211,153,.3);}
.fu-btn-upload:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none;}
.fu-empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:60px 20px;text-align:center;color:var(--text2);}
.fu-empty-ico{font-size:48px;opacity:.4;}
.fu-empty-t{font-family:'Syne',sans-serif;font-size:16px;color:var(--text);}
.fu-empty-s{font-size:13px;color:var(--text2);}

@media(max-width:780px){
  .fu-body{flex-direction:column;}
  .fu-left{width:100%;height:280px;border-right:none;border-bottom:1px solid var(--border);}
  .fu-assignment-grid{grid-template-columns:1fr;}
  .fu-files-thead,.fu-files-row{grid-template-columns:auto 1fr 80px 80px;}
  .fu-files-row .fu-file-cell:nth-child(4){display:none;}
  .fu-files-thead .fu-file-cell:nth-child(4){display:none;}
}

/* â”€â”€ VOICE CALL STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.call-btn{display:none;align-items:center;justify-content:center;width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;transition:all .2s;margin-left:auto;flex-shrink:0;}
.call-btn.voice{background:rgba(52,211,153,.15);color:var(--accent3);}
.call-btn.group{background:rgba(129,140,248,.15);color:var(--accent2);}
.call-btn:hover{transform:scale(1.1);}
.call-btn svg{width:17px;height:17px;}
#callOverlay{position:fixed;inset:0;background:rgba(8,12,16,.97);z-index:5000;display:none;flex-direction:column;align-items:center;justify-content:center;gap:0;}
#callOverlay.active{display:flex;}
.call-ov-av{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:700;color:white;margin-bottom:18px;box-shadow:0 0 0 0 rgba(56,189,248,.4);animation:callPulse 2s ease-in-out infinite;}
@keyframes callPulse{0%,100%{box-shadow:0 0 0 0 rgba(56,189,248,.35);}50%{box-shadow:0 0 0 18px rgba(56,189,248,0);}}
.call-ov-name{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;color:#e2eaf4;margin-bottom:8px;}
.call-ov-status{font-family:'DM Mono',monospace;font-size:13px;color:var(--text3);margin-bottom:10px;}
.call-ov-timer{font-family:'DM Mono',monospace;font-size:28px;font-weight:700;color:var(--accent3);margin-bottom:32px;min-height:36px;}
.call-ov-btns{display:flex;gap:24px;align-items:center;justify-content:center;}
.call-ov-btn{width:60px;height:60px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:22px;transition:all .2s;}
.call-ov-btn:hover{transform:scale(1.08);}
.call-ov-btn.end{background:#ef4444;}
.call-ov-btn.mute{background:var(--bg3);border:1px solid var(--border);}
.call-ov-btn.mute.active{background:rgba(251,191,36,.2);border-color:#fbbf24;}
.call-ov-btn.speaker{background:var(--bg3);border:1px solid var(--border);}
.call-ov-btn.speaker.active{background:rgba(52,211,153,.2);border-color:var(--accent3);}
.call-ov-participants{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;max-width:340px;margin-bottom:20px;}
.call-ov-part{display:flex;flex-direction:column;align-items:center;gap:4px;}
.call-ov-part-av{width:46px;height:46px;border-radius:50%;background:var(--bg3);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:var(--text);}
.call-ov-part-av.speaking{border-color:var(--accent3);box-shadow:0 0 0 3px rgba(52,211,153,.25);}
.call-ov-part-name{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;max-width:60px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.call-incoming{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#0d1117,#131920);border:1px solid rgba(52,211,153,.4);border-radius:18px;padding:16px 22px;display:none;flex-direction:column;align-items:center;gap:12px;z-index:4999;box-shadow:0 12px 40px rgba(0,0,0,.6);min-width:280px;animation:slideUp .3s ease;}
.call-incoming.active{display:flex;}
.call-inc-row{display:flex;align-items:center;gap:14px;width:100%;}
.call-inc-av{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent3),var(--accent));display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:white;animation:callPulse 1.5s ease-in-out infinite;}
.call-inc-info{flex:1;}
.call-inc-name{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:#e2eaf4;}
.call-inc-type{font-family:'DM Mono',monospace;font-size:11px;color:var(--accent3);}
.call-inc-btns{display:flex;gap:12px;width:100%;justify-content:center;}
.call-inc-btn{flex:1;padding:10px;border:none;border-radius:12px;cursor:pointer;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;transition:all .2s;}
.call-inc-btn.accept{background:linear-gradient(135deg,var(--accent3),#059669);color:white;}
.call-inc-btn.decline{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3);}
.call-inc-btn:hover{transform:translateY(-1px);}
</style>
</head>
<body>

<!-- ===== AUTH PAGE ===== -->
<div id="authPage">
  <div class="auth-wrap">
    <div class="auth-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0;">
        <div class="auth-brand">
          <div class="auth-brand-icon">ðŸ¥</div>
          <div class="auth-brand-name">NurseVault</div>
        </div>
        <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);transition:all .2s;">ðŸŒ™</button>
      </div>
      <div class="auth-sub">// nursing school handouts &amp; resources</div>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="auth-tabs">
          <div class="auth-tab active" onclick="switchAuth('login')">Sign In</div>
          <div class="auth-tab" onclick="switchAuth('signup')">Create Account</div>
        </div>

        <label class="inp-label">Username</label>
        <div class="inp-wrap">
          <input class="inp" id="loginUsername" type="text" placeholder="Enter your username"
            autocomplete="off"
            onfocus="openSavedDropdown()"
            oninput="filterSavedDropdown(this.value)"
            onkeydown="handleUsernameKey(event)">
          <div class="saved-dropdown" id="savedDropdown">
            <div class="saved-dropdown-hd">Saved Accounts</div>
            <div id="savedList"></div>
          </div>
        </div>

        <label class="inp-label">Password</label>
        <div class="pass-wrap">
          <input class="inp" id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            autocomplete="current-password"
            onkeydown="if(event.key==='Enter')doLogin()">
          <button class="pass-toggle" type="button" onclick="togglePassVis('loginPassword',this)" title="Show/hide password">ðŸ‘</button>
        </div>

        <div class="inp-err" id="loginErr">Invalid username or password.</div>
        <button class="btn-primary" onclick="doLogin()">Sign In â†’</button>
        <div class="auth-switch" style="margin-top:10px;"><span onclick="switchAuth('forgot')" style="color:var(--text3);">Forgot password?</span></div>
        <div class="auth-switch">No account? <span onclick="switchAuth('signup')">Register here</span></div>
      </div>


      <!-- FORGOT PASSWORD -->
      <div id="forgotForm" style="display:none">
        <div class="auth-tabs">
          <div class="auth-tab" onclick="switchAuth('login')">Sign In</div>
          <div class="auth-tab" onclick="switchAuth('signup')">Create Account</div>
        </div>
        <div style="text-align:center;margin-bottom:18px;">
          <div style="font-size:28px;margin-bottom:8px;">ðŸ”‘</div>
          <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--text);margin-bottom:4px;">Reset Password</div>
          <div style="font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;">Enter your username and new password</div>
        </div>
        <label class="inp-label">Username</label>
        <input class="inp" id="forgotUsername" type="text" placeholder="Enter your username">
        <label class="inp-label" style="margin-top:12px;">New Password</label>
        <div class="pass-wrap">
          <input class="inp" id="forgotNewPass" type="password" placeholder="Min. 6 characters">
          <button class="pass-toggle" type="button" onclick="togglePassVis('forgotNewPass',this)" title="Show/hide">ðŸ‘</button>
        </div>
        <label class="inp-label" style="margin-top:12px;">Confirm New Password</label>
        <div class="pass-wrap">
          <input class="inp" id="forgotConfPass" type="password" placeholder="Re-enter new password" onkeydown="if(event.key==='Enter')doForgotPassword()">
          <button class="pass-toggle" type="button" onclick="togglePassVis('forgotConfPass',this)" title="Show/hide">ðŸ‘</button>
        </div>
        <div class="inp-err" id="forgotErr" style="display:none;"></div>
        <div id="forgotSuccess" style="display:none;background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.3);border-radius:9px;padding:10px 14px;font-size:12px;color:var(--accent3);font-family:'DM Mono',monospace;margin-top:8px;">âœ“ Password changed! You can now sign in.</div>
        <button class="btn-primary" onclick="doForgotPassword()" style="margin-top:14px;">Reset Password â†’</button>
        <div class="auth-switch" style="margin-top:12px;"><span onclick="switchAuth('login')">â† Back to Sign In</span></div>
      </div>
      <!-- SIGNUP -->
      <div id="signupForm" style="display:none">
        <div class="auth-tabs">
          <div class="auth-tab" onclick="switchAuth('login')">Sign In</div>
          <div class="auth-tab active" onclick="switchAuth('signup')">Create Account</div>
        </div>
        <div class="auth-notice">âš ï¸ Student accounts only. Lecturer accounts are created by the Admin â€” contact your administrator.</div>
        <label class="inp-label">Full Name</label>
        <input class="inp" id="signupName" type="text" placeholder="e.g. Amaka Eze">
        <label class="inp-label">Username</label>
        <input class="inp" id="signupUsername" type="text" placeholder="Choose a username (no spaces)" autocomplete="off">
        <label class="inp-label">Matric Number</label>
        <input class="inp" id="signupMatric" type="text" placeholder="e.g. NSG/2023/001" autocomplete="off">
        <label class="inp-label">Your Class</label>
        <select class="sel-inp" id="signupClass">
          <option value="nd1">ND ONE â€” National Diploma Year One</option>
          <option value="nd2">ND TWO â€” National Diploma Year Two</option>
          <option value="hnd1">HND ONE â€” Higher National Diploma Year One</option>
          <option value="hnd2">HND TWO â€” Higher National Diploma Year Two</option>
        </select>
        <label class="inp-label">Password</label>
        <input class="inp" id="signupPassword" type="password" placeholder="Min. 6 characters">
        <label class="inp-label">Confirm Password</label>
        <input class="inp" id="signupConfirm" type="password" placeholder="Re-enter password" onkeydown="if(event.key==='Enter')doSignup()">
        <div class="inp-err" id="signupErr">Please check your details.</div>
        <button class="btn-primary" onclick="doSignup()">Create Account â†’</button>
        <div class="auth-switch">Already registered? <span onclick="switchAuth('login')">Sign in</span></div>
      </div>
    </div>
  </div>
</div>

<!-- save-modal removed: auto-saves silently -->

<!-- ===== APP ===== -->
<div class="app" id="appWrap" style="display:none">
  <button class="mob-menu" onclick="toggleSidebar()">â˜°</button>
  <div class="sidebar-bg" id="sidebarBg" onclick="closeSidebar()"></div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ðŸ¥</div>
      <div class="logo-text">NurseVault</div>
    </div>
    <div class="sidebar-section-label">Navigation</div>
    <div class="nav-item active" onclick="navGo('dashboard')"><span class="ni">âŠž</span> Dashboard</div>
    <div class="nav-item" onclick="navGo('allhandouts')"><span class="ni">ðŸ“„</span> All Handouts</div>
    <div class="nav-item" onclick="navGo('results')"><span class="ni">ðŸ“Š</span> Results</div>
    <div class="nav-item" onclick="navGo('pastquestions')"><span class="ni">ðŸ§ </span> Past Questions</div>
    <div class="nav-item" onclick="navGo('messages')" id="navMessages"><span class="ni">ðŸ’¬</span> Messages <span id="msgNavBadge" style="display:none" class="msg-notification-dot"></span></div>
    <div class="nav-item teacher-el" onclick="openModal('uploadModal')"><span class="ni">â¬†</span> Upload Handout</div>
    <div class="nav-item teacher-el" onclick="openFolderUpload()"><span class="ni">ðŸ“‚</span> Upload Folder</div>
    <div class="sidebar-section-label">Classes</div>
    <div id="sidebarClasses"></div>
    <div class="nav-item admin-el" onclick="navGo('users')"><span class="ni">ðŸ‘¥</span> User Management</div>
    <div class="sidebar-user">
      <button class="profile-btn" onclick="openMyProfile()">
        <div class="user-av" id="sidebarAv">S</div>
        <div style="flex:1;min-width:0;">
          <div class="user-nm" id="sidebarNm" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Student</div>
          <div class="user-rl" id="sidebarRl">student</div>
        </div>
        <span style="font-size:12px;color:var(--text3);">âœŽ</span>
      </button>
      <button class="logout-btn" onclick="doLogout()">â† Sign Out</button>
    </div>
  </div>

  <!-- MAIN VIEWS -->
  <div class="main">

    <!-- DASHBOARD -->
    <div id="viewDashboard" class="view">
      <div class="topbar">
        <div class="topbar-title" id="dashTitle">Dashboard</div>
        <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);transition:all .2s;flex-shrink:0;">ðŸŒ™</button>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Search handoutsâ€¦" oninput="globalSearch(this.value)"></div>
        <button class="btn-action teacher-el" onclick="openModal('uploadModal')">â¬† Upload</button>
        <button class="btn-ghost teacher-el" onclick="openFolderUpload()" style="gap:7px;">ðŸ“‚ Upload Folder</button>
        <button class="btn-action admin-el" onclick="openModal('addClassModal')">ï¼‹ Add Class</button>
      </div>
      <div class="content">
        <div class="stats-strip" id="statsStrip"></div>
        <div class="sec-header">
          <div><div class="sec-title">Classes</div><div class="sec-sub">Select a class to browse courses and handouts</div></div>
          <button class="btn-ghost admin-el" onclick="openModal('addClassModal')">ï¼‹ Add Class</button>
        </div>
        <div class="classes-grid" id="classesGrid"></div>
      </div>
    </div>

    <!-- CLASS VIEW -->
    <div id="viewClass" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title" id="classViewTitle">Class</div>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Search coursesâ€¦" oninput="searchCourses(this.value)"></div>
        <button class="btn-action teacher-el" onclick="openAddCourseModal()">ï¼‹ Add Course</button>
      </div>
      <div class="content">
        <div class="breadcrumb" id="classBc"></div>
        <div class="sec-header">
          <div><div class="sec-title" id="classCoursesTitle">Courses</div><div class="sec-sub" id="classCourseSub"></div></div>
          <button class="btn-ghost teacher-el" onclick="openAddCourseModal()">ï¼‹ Add Course</button>
        </div>
        <div class="courses-list" id="coursesList"></div>
      </div>
    </div>

    <!-- COURSE VIEW -->
    <div id="viewCourse" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title" id="courseViewTitle">Course</div>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Search handoutsâ€¦" oninput="searchHandouts(this.value)"></div>
        <button class="btn-action teacher-el" onclick="openAddHandoutModal()">â¬† Add Handout</button>
      </div>
      <div class="content">
        <div class="breadcrumb" id="courseBc"></div>
        <div class="sec-header">
          <div><div class="sec-title" id="courseHandoutsTitle">Handouts</div><div class="sec-sub" id="courseHandoutSub"></div></div>
          <button class="btn-ghost teacher-el" onclick="openAddHandoutModal()">â¬† Add Handout</button>
        </div>
        <div class="handouts-list" id="handoutsList"></div>
      </div>
    </div>

    <!-- ALL HANDOUTS -->
    <div id="viewAllHandouts" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">All Handouts</div>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Searchâ€¦" oninput="searchAllHandouts(this.value)"></div>
      </div>
      <div class="content">
        <div class="handouts-list" id="allHandoutsList"></div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="viewResults" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">Results</div>
        <button class="btn-action admin-el" onclick="openSpreadsheetImport()" style="gap:7px;">ðŸ“Š Upload Spreadsheet</button>
        <button class="btn-ghost admin-el" onclick="openPasteImport()" style="gap:7px;">ðŸ“‹ Paste Import</button>
        <button class="btn-ghost admin-el" onclick="openModal_addResult()">ï¼‹ Add Result</button>
      </div>
      <div class="content">

        <!-- ADMIN VIEW â€” sees ALL results -->
        <div id="resultsTeacherPanel" style="display:none">
          <div class="results-filter-bar">
            <select class="sel" id="resultFilterClass" onchange="filterResultsByClass()" style="max-width:160px;">
              <option value="">All Classes</option>
            </select>
            <select class="sel" id="resultFilterType" onchange="renderResultsTable()" style="max-width:130px;">
              <option value="">All Types</option>
              <option value="test">Tests</option>
              <option value="exam">Exams</option>
            </select>
            <select class="sel" id="resultFilterCourse" onchange="renderResultsTable()" style="max-width:210px;">
              <option value="">All Courses</option>
            </select>
            <input class="search-inp" id="resultFilterSearch" placeholder="Search name / matricâ€¦" oninput="renderResultsTable()" style="max-width:190px;padding:8px 12px;">
            <div style="flex:1"></div>
            <button class="btn-ghost" onclick="exportResultsCSV()" style="font-size:12px;">â¬‡ Export CSV</button>
            <button class="btn-ghost" onclick="showCGPASummary()" style="font-size:12px;color:var(--accent2);border-color:var(--accent2);">ðŸ“ˆ CGPA Summary</button>
          </div>
          <div class="results-table-wrap">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Matric No.</th>
                  <th>Student</th>
                  <th>Type</th>
                  <th>Title</th>
                  <th>Course</th>
                  <th>Class</th>
                  <th>Score</th>
                  <th>Grade</th>
                  <th>GP</th>
                  <th>CGPA</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="resultsTableBody"></tbody>
            </table>
          </div>
          <div id="resultsTableEmpty" class="results-empty" style="display:none">
            <div class="results-empty-ico">ðŸ“Š</div>
            <div class="results-empty-t">No results uploaded yet</div>
            <div class="results-empty-s">Upload a spreadsheet or use Paste Import to add student results</div>
          </div>
        </div>

        <!-- STUDENT VIEW â€” own results only, matched by matric number -->
        <div id="resultsStudentPanel" style="display:none">
          <div style="margin-bottom:18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <select class="sel" id="studentResultFilterType" onchange="renderStudentResults()" style="max-width:160px;">
              <option value="">All Types</option>
              <option value="test">Tests</option>
              <option value="exam">Exams</option>
            </select>
            <select class="sel" id="studentResultFilterCourse" onchange="renderStudentResults()" style="max-width:220px;">
              <option value="">All Courses</option>
            </select>
          </div>
          <div id="studentResultsSummary" style="display:none;margin-bottom:20px;"></div>
          <div id="studentResultsList"></div>
        </div>

      </div>
    </div>

    <!-- PAST QUESTIONS -->
    <div id="viewPastQuestions" class="view" style="display:none">
      <div class="topbar">
        <div>
          <div class="topbar-title">Past Questions</div>
          <div class="pq-topbar-sub">// practice mode â€” multiple choice</div>
        </div>
        <button class="btn-action admin-el" onclick="openPQImport()" style="background:linear-gradient(135deg,var(--accent2),var(--accent));">â¬† Import Questions</button>
      </div>
      <div class="pq-controls">
        <select class="pq-filter-sel" id="pqFilterCourse" onchange="renderPQBanks()">
          <option value="">All Courses</option>
        </select>
        <select class="pq-filter-sel" id="pqFilterYear" onchange="renderPQBanks()">
          <option value="">All Years</option>
        </select>
        <div style="flex:1"></div>
        <span id="pqBankCount" style="font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;"></span>
      </div>
      <div class="content" style="padding-top:16px;">
        <div class="pq-bank-grid" id="pqBankGrid"></div>
        <div class="pq-empty" id="pqEmpty" style="display:none">
          <div class="pq-empty-ico">ðŸ§ </div>
          <div class="pq-empty-t">No Question Banks Yet</div>
          <div class="pq-empty-s admin-el">Import past questions to let students practise</div>
          <div class="pq-empty-s" id="pqEmptyStudentMsg" style="display:none">No question banks available yet â€” check back later</div>
          <button class="btn-action admin-el" onclick="openPQImport()" style="margin-top:18px;background:linear-gradient(135deg,var(--accent2),var(--accent));">â¬† Import Questions</button>
        </div>
      </div>
    </div>

    <!-- USERS (admin only) -->
    <div id="viewUsers" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">User Management <span id="userCountBadge" style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);font-weight:400;margin-left:8px;"></span></div>
        <input class="search-inp" id="userSearch" placeholder="Search name, username, matricâ€¦" oninput="renderUsers()" style="max-width:180px;padding:8px 12px;">
        <select class="sel" id="userRoleFilter" onchange="renderUsers()" style="max-width:130px;font-size:12px;padding:6px 10px;">
          <option value="">All Roles</option>
          <option value="student">Students</option>
          <option value="teacher">Lecturers</option>
          <option value="admin">Admin</option>
        </select>
        <select class="sel" id="userClassFilter" onchange="renderUsers()" style="max-width:140px;font-size:12px;padding:6px 10px;">
          <option value="">All Classes</option>
        </select>
        <button class="btn-action" onclick="openModal('addLecturerModal')">ï¼‹ Add Lecturer</button>
        <button class="btn-action" onclick="openNominalRollImport()" style="background:rgba(129,140,248,.15);color:var(--accent2);border:1px solid var(--accent2);">ðŸ“¥ Import Nominal Roll</button>
        <button class="btn-action" onclick="removeAllStudents()" style="background:rgba(251,113,133,.12);color:var(--accent4);border:1px solid rgba(251,113,133,.35);">ðŸ—‘ Remove All Students</button>
        <button class="btn-action" id="revealAllPwdBtn" onclick="toggleAllPasswords()" style="background:rgba(56,189,248,.10);color:var(--accent);border:1px solid rgba(56,189,248,.3);">ðŸ‘ Reveal All Passwords</button>
        <button class="btn-action" onclick="resetAllStudentPasswords()" style="background:rgba(52,211,153,.12);color:var(--accent3);border:1px solid rgba(52,211,153,.35);">&#128273; Reset Student Passwords</button>

      </div>
      <div class="content" style="padding-top:16px;">
        <div id="usersGrid" class="users-grid"></div>
      </div>
    </div>

    <!-- MESSAGES VIEW -->
    <div id="viewMessages" class="view" style="display:none">
      <div class="msg-layout">
        <!-- Sidebar: channel list -->
        <div class="msg-sidebar" id="msgSidebarPane">
          <div class="msg-sidebar-head">
            <span class="msg-sidebar-title">ðŸ’¬ Messages</span>
            <button class="msg-new-btn" onclick="openNewChat()" title="New message">ï¼‹</button>
          </div>
          <div class="msg-search">
            <input id="msgSearchInp" placeholder="Search chatsâ€¦" oninput="filterMsgChannels(this.value)">
          </div>
          <div class="msg-channels" id="msgChannelList"></div>
        </div>
        <!-- Main chat area -->
        <div class="msg-main" id="msgMainPane">
          <div class="msg-empty-state" id="msgEmptyState">
            <div class="msg-empty-icon">ðŸ’¬</div>
            <div class="msg-empty-text">No conversation selected</div>
            <div class="msg-empty-sub">Choose a chat or start a new one</div>
          </div>
          <div id="msgActiveChat" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
            <div class="msg-main-head">
              <button class="msg-back-btn" id="msgBackBtn" onclick="msgGoBack()">â† Back</button>
              <div class="msg-main-av" id="msgChatAv">ðŸ’¬</div>
              <div>
                <div class="msg-main-name" id="msgChatName">Chat</div>
                <div class="msg-main-sub" id="msgChatSub">â€”</div>
              </div>
              <span id="msgAnnounceBadge" class="msg-announce-badge" style="display:none">ðŸ“¢ Class Broadcast</span>
              <button class="call-btn voice" id="callVoiceBtn" onclick="startVoiceCall()" title="Voice call">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 10.8 19.79 19.79 0 0118 2.18 2 2 0 0120 4.18v3a2 2 0 01-1.44 1.93 16 16 0 00-4.72 3.72 16 16 0 003.72 4.72A2 2 0 0122 16.92z"/></svg>
              </button>
              <button class="call-btn group" id="callGroupBtn" onclick="startGroupCall()" title="Group call">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
              </button>
            </div>
            <div class="msg-body" id="msgBody"></div>
            <div class="msg-typing" id="msgTypingIndicator" style="display:none"></div>
            <div id="msgReadonlyNotice" style="display:none;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-top:1px solid var(--border);background:var(--bg2);font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;">
              ðŸ”’ You cannot send messages in this channel.
            </div>
            <!-- Voice recording bar â€” STATE 1: recording -->
            <div class="msg-record-bar" id="msgRecordBar">
              <span style="font-size:18px;animation:recPulse 1s ease-in-out infinite;">ðŸŽ™</span>
              <div class="msg-rec-timer" id="msgRecTimer">0:00</div>
              <div class="msg-rec-wave" id="msgRecWave" style="flex:1;"></div>
              <button class="msg-rec-cancel" onclick="cancelVoiceRecord()">âœ• Cancel</button>
              <button class="msg-rec-send" onclick="stopRecordingForPreview()" style="background:#fb7185;">Stop â– </button>
            </div>

            <!-- Voice preview bar â€” STATE 2: pre-listen before sending -->
            <div id="msgVoicePreviewBar" style="display:none;align-items:center;gap:10px;padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2);">
              <button id="voicePreviewPlayBtn" onclick="toggleVoicePreview()" style="width:36px;height:36px;border-radius:50%;border:none;background:#fb7185;color:#fff;font-size:16px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;">â–¶</button>
              <div style="flex:1;position:relative;height:32px;background:var(--bg3);border-radius:8px;overflow:hidden;cursor:pointer;" id="voicePreviewProgress" onclick="seekVoicePreview(event)">
                <div id="voicePreviewBar" style="height:100%;background:rgba(251,113,133,.25);width:0%;transition:width .1s linear;pointer-events:none;"></div>
                <div id="voicePreviewWaveStatic" style="position:absolute;inset:0;display:flex;align-items:center;gap:2px;padding:0 8px;pointer-events:none;"></div>
              </div>
              <div id="voicePreviewTimer" style="font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);min-width:38px;text-align:right;flex-shrink:0;">0:00</div>
              <button onclick="cancelVoicePreview()" style="padding:6px 11px;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--text2);font-size:12px;cursor:pointer;font-family:'DM Mono',monospace;transition:all .2s;flex-shrink:0;">Re-record</button>
              <button onclick="sendVoicePreview()" style="padding:6px 13px;border:none;border-radius:8px;background:#fb7185;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Mono',monospace;flex-shrink:0;">Send â–²</button>
            </div>
            <!-- Normal input bar -->
            <div class="msg-input-bar" id="msgInputBar">
              <input type="file" id="msgFileInput" multiple accept="*/*" style="display:none" onchange="handleMsgFileAttach(this)">
              <button class="msg-icon-btn" onclick="document.getElementById('msgFileInput').click()" title="Attach file">ðŸ“Ž</button>
              <div class="msg-input-wrap" style="flex:1;">
                <textarea class="msg-input" id="msgTextInp" placeholder="Type a messageâ€¦" rows="1" onkeydown="msgKeydown(event)" oninput="msgAutoResize(this)"></textarea>
              </div>
              <button class="msg-icon-btn" id="msgVoiceBtn" onclick="startVoiceRecord()" title="Voice message">ðŸŽ™</button>
              <button class="msg-send-btn" onclick="sendMessage()" title="Send">âž¤</button>
            </div>
          </div>
        </div>
      </div>

        <!-- Classmates Panel (right column, students only) -->
        <div class="msg-classmates" id="msgClassmatesPanel" style="display:none;">
          <div class="msg-classmates-head">
            <div class="msg-classmates-title">ðŸŽ“ <span id="msgClassmatesTitle">My Class</span></div>
            <div class="msg-classmates-sub" id="msgClassmatesSub">Your classmates</div>
          </div>
          <div class="msg-classmates-search">
            <input id="msgClassmatesSearch" placeholder="Search classmatesâ€¦" oninput="filterClassmates(this.value)">
          </div>
          <div class="msg-classmates-list" id="msgClassmatesList"></div>
          <div style="padding:8px 10px;border-top:1px solid var(--border);flex-shrink:0;">
            <button class="msg-other-class-btn" onclick="openOtherClassPanel()">
              ðŸ” Message another class
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- OTHER CLASS PANEL MODAL -->
<div class="overlay" id="otherClassModal">
  <div class="modal" style="max-width:440px;max-height:86vh;display:flex;flex-direction:column;overflow:hidden;">
    <div class="modal-hd" style="flex-shrink:0;">
      <div class="modal-ht">ðŸ“¨ Message Another Class</div>
      <button class="modal-x" onclick="closeModal('otherClassModal')">âœ•</button>
    </div>
    <div style="flex:1;overflow-y:auto;padding:16px;">
      <!-- Class selector tabs -->
      <div style="margin-bottom:12px;">
        <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;font-weight:600;margin-bottom:8px;">Select a Class</div>
        <div id="otherClassTabs" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>
      <!-- Search within selected class -->
      <div style="margin-bottom:10px;">
        <input class="inp" id="otherClassSearch" placeholder="Search by name or matricâ€¦" oninput="filterOtherClassList(this.value)" style="margin:0;">
      </div>
      <div id="otherClassResultCount" style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:6px;padding:0 2px;"></div>
      <div id="otherClassStudentList" class="msg-recipient-list"></div>
    </div>
  </div>
</div>

<!-- NEW CHAT MODAL -->
<div class="overlay" id="newChatModal">
  <div class="modal" style="max-width:440px;max-height:86vh;display:flex;flex-direction:column;overflow:hidden;">
    <div class="modal-hd" style="flex-shrink:0;">
      <div class="modal-ht">ðŸ’¬ New Message</div>
      <button class="modal-x" onclick="closeModal('newChatModal')">âœ•</button>
    </div>
    <div class="new-chat-modal-body" style="flex:1;overflow-y:auto;padding:16px;">

      <!-- Channels section (admin/teacher only) -->
      <div id="newChatGroupSection" style="display:none">
        <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:8px;text-transform:uppercase;letter-spacing:.1em;font-weight:600;">ðŸ“£ Broadcast Channels</div>
        <div id="newChatGroupList" class="msg-recipient-list" style="margin-bottom:14px;"></div>
        <div style="border-top:1px solid var(--border);padding-top:14px;margin-bottom:10px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;font-weight:600;">ðŸ‘¤ Direct Message</div>
      </div>

      <!-- Class filter â€” always visible when sending DMs -->
      <div id="newChatClassFilterWrap" style="margin-bottom:12px;">
        <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;font-weight:600;margin-bottom:8px;">ðŸŽ“ Select Class</div>
        <div style="position:relative;">
          <select id="newChatClassFilter" onchange="applyNewChatFilters()" style="width:100%;background:var(--bg3);border:1.5px solid var(--accent);border-radius:10px;padding:11px 40px 11px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;cursor:pointer;appearance:none;-webkit-appearance:none;transition:border-color .2s;">
            <option value="">â€” All Classes â€”</option>
          </select>
          <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--accent);font-size:18px;line-height:1;">â–¾</div>
        </div>
      </div>

      <!-- Search -->
      <div style="margin-bottom:10px;">
        <input class="inp" id="newChatSearch" placeholder="Search by name or matric numberâ€¦" oninput="applyNewChatFilters()" style="margin:0;">
      </div>

      <!-- Results count -->
      <div id="newChatResultCount" style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:6px;padding:0 2px;"></div>

      <!-- Recipient list -->
      <div id="newChatDmList" class="msg-recipient-list"></div>
    </div>
  </div>
</div>

<!-- ===== MODALS ===== -->

<!-- ===== MY PROFILE MODAL ===== -->
<div class="overlay" id="myProfileModal">
  <div class="modal" style="max-width:460px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ‘¤ My Profile</div>
      <button class="modal-x" onclick="closeModal('myProfileModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <!-- Avatar -->
      <div class="profile-modal-av-wrap" onclick="document.getElementById('myAvatarFile').click()" title="Click to change photo">
        <div class="profile-modal-av" id="myProfileAv">A</div>
        <div class="profile-av-edit-badge">ðŸ“·</div>
      </div>
      <input type="file" id="myAvatarFile" accept="image/*" style="display:none" onchange="handleAvatarUpload(this,'me')">
      <div style="text-align:center;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:16px;">Click photo to change</div>

      <div class="profile-section-title">Personal Information</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;grid-column:1/-1;">
          <label class="inp-label">Full Name</label>
          <input class="inp" id="myProfileName" placeholder="Your full name" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Phone Number</label>
          <input class="inp" id="myProfilePhone" placeholder="e.g. 08012345678" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;" id="myMatricWrap">
          <label class="inp-label">Matric Number</label>
          <input class="inp" id="myProfileMatric" placeholder="e.g. NSG/23/001" style="margin:0;">
        </div>
      </div>

      <div class="profile-section-title">Account</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Username</label>
          <input class="inp" id="myProfileUsername" style="margin:0;opacity:.6;" readonly>
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Role</label>
          <div style="padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;" id="myProfileRoleBadge"></div>
        </div>
      </div>

      <div class="profile-section-title">Change Password</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;">
          <label class="inp-label">New Password</label>
          <input class="inp" id="myProfileNewPass" type="password" placeholder="Leave blank to keep current" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Confirm Password</label>
          <input class="inp" id="myProfileConfPass" type="password" placeholder="Repeat new password" style="margin:0;">
        </div>
      </div>

      <!-- PROFESSIONAL IDs -->
      <div class="profile-section-title" id="myProfIdSection">ðŸ¥ Professional Numbers</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;" id="myProfIdFields">
        <div class="form-g" style="margin:0;grid-column:1/-1;">
          <label class="inp-label">BIA Number <span style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">(Biomedical Institution Accreditation)</span></label>
          <input class="inp" id="myProfileBIA" placeholder="e.g. BIA/2024/001" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RN Indexing Number</label>
          <input class="inp" id="myProfileRNIndex" placeholder="e.g. NRN/IDX/001" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RM Indexing Number</label>
          <input class="inp" id="myProfileRMIndex" placeholder="e.g. NRM/IDX/001" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RN Exam Number</label>
          <input class="inp" id="myProfileRNExam" placeholder="e.g. RN/EXAM/2024/001" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RM Exam Number</label>
          <input class="inp" id="myProfileRMExam" placeholder="e.g. RM/EXAM/2024/001" style="margin:0;">
        </div>
      </div>

      <!-- DOCUMENT VAULT -->
      <div class="profile-section-title" id="myDocVaultSection">ðŸ“ My Document Vault</div>
      <div id="myDocVaultList" class="doc-vault-list"></div>
      <div class="doc-upload-zone" id="myDocUploadZone" onclick="document.getElementById('myDocFileInp').click()" ondragover="docDragOver(event,'myDocUploadZone')" ondragleave="docDragLeave(event,'myDocUploadZone')" ondrop="docDrop(event,'me')">
        <div class="doc-upload-zone-icon">ðŸ“¤</div>
        <div class="doc-upload-zone-text">Click or drag files to upload</div>
        <div class="doc-upload-zone-sub">PDF, DOCX, images, spreadsheets â€” up to 10 MB each</div>
      </div>
      <input type="file" id="myDocFileInp" multiple style="display:none" onchange="handleDocUpload(this,'me')">

      <button class="btn-submit" onclick="saveMyProfile()" style="margin-top:20px;background:linear-gradient(135deg,var(--accent2),var(--accent));">ðŸ’¾ Save Profile â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€ NOMINAL ROLL IMPORT MODAL â”€â”€ -->
<div class="overlay" id="nominalRollModal">
  <div class="modal" style="max-width:560px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“‹ Import Nominal Roll</div>
      <button class="modal-x" onclick="closeModal('nominalRollModal')">âœ•</button>
    </div>
    <div class="modal-bd">

      <!-- Upload zone -->
      <div id="nominalDropZone" style="border:2px dashed var(--border);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg2);"
           onclick="document.getElementById('nominalFileInp').click()"
           ondragover="event.preventDefault();this.style.borderColor='var(--accent2)';this.style.background='rgba(129,140,248,.08)'"
           ondragleave="this.style.borderColor='var(--border)';this.style.background='var(--bg2)'"
           ondrop="nominalHandleDrop(event)">
        <div style="font-size:40px;margin-bottom:10px;">ðŸ“Š</div>
        <div style="font-size:14px;font-weight:600;color:var(--text);">Drop any spreadsheet here or click to browse</div>
        <div style="font-size:11px;color:var(--text3);margin-top:6px;font-family:'DM Mono',monospace;">.xlsx Â· .xls Â· .csv Â· .doc Â· .docx â€” any column layout, auto-detected</div>
      </div>
      <input type="file" id="nominalFileInp" accept=".xlsx,.xls,.csv,.doc,.docx" style="display:none" onchange="nominalHandleFile(this.files[0])">

      <!-- Column mapping feedback -->
      <div id="nominalMappingInfo" style="display:none;margin-top:14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;">
        <div style="font-size:11px;font-weight:700;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px;">ðŸ” Detected Columns</div>
        <div id="nominalMappingTags" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>

      <!-- Preview table -->
      <div id="nominalPreview" style="display:none;margin-top:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
          <div id="nominalPreviewTitle" style="font-size:13px;font-weight:600;color:var(--text);">Preview</div>
          <select class="sel" id="nominalClassSelect" style="font-size:12px;padding:6px 10px;max-width:200px;">
            <option value="">â€” Override Class (optional) â€”</option>
          </select>
        </div>
        <div style="overflow-x:auto;max-height:280px;overflow-y:auto;border-radius:10px;border:1px solid var(--border);">
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead id="nominalPreviewHead" style="position:sticky;top:0;background:var(--bg3);z-index:1;"></thead>
            <tbody id="nominalPreviewBody"></tbody>
          </table>
        </div>
        <div style="margin-top:6px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">
          Surname column used for username &amp; password (e.g. IBRAHIM â†’ username: ibrahim123, password: ibrahim123123)
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn-submit" onclick="nominalImportConfirm()" style="background:linear-gradient(135deg,var(--accent3),#059669);flex:1;min-width:160px;">âœ… Import & Create Accounts</button>
          <button class="btn-ghost" onclick="nominalReset()" style="flex:1;min-width:120px;">ðŸ”„ Upload Different File</button>
        </div>
      </div>

      <div id="nominalImportResult" style="display:none;margin-top:16px;padding:14px;border-radius:10px;"></div>
    </div>
  </div>
</div>

<!-- Document Preview Modal -->
<div class="doc-preview-modal" id="docPreviewModal">
  <div class="doc-preview-inner">
    <div class="doc-preview-header">
      <span id="docPreviewTitle" class="doc-preview-title">Document</span>
      <div class="doc-preview-actions">
        <button class="doc-vault-btn" onclick="printDocPreview()" style="color:var(--accent3);border-color:rgba(52,211,153,.3);">ðŸ–¨ Print</button>
        <button class="doc-vault-btn" onclick="downloadDocPreview()">â¬‡ Download</button>
        <button class="doc-vault-btn danger" onclick="closeDocPreview()">âœ• Close</button>
      </div>
    </div>
    <div class="doc-preview-body" id="docPreviewBody"></div>
  </div>
</div>

<!-- ===== EDIT USER MODAL (admin only) ===== -->
<div class="overlay" id="editUserModal">
  <div class="modal" style="max-width:480px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">âœï¸ Edit User Profile</div>
      <button class="modal-x" onclick="closeModal('editUserModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <input type="hidden" id="editUserId">

      <!-- Avatar -->
      <div class="profile-modal-av-wrap" onclick="document.getElementById('editAvatarFile').click()" title="Click to change photo">
        <div class="profile-modal-av" id="editUserAv">A</div>
        <div class="profile-av-edit-badge">ðŸ“·</div>
      </div>
      <input type="file" id="editAvatarFile" accept="image/*" style="display:none" onchange="handleAvatarUpload(this,'edit')">
      <div style="text-align:center;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:16px;">Click photo to change</div>

      <div class="profile-section-title">Personal Information</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;grid-column:1/-1;">
          <label class="inp-label">Full Name</label>
          <input class="inp" id="editUserName" placeholder="Full name" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Phone Number</label>
          <input class="inp" id="editUserPhone" placeholder="e.g. 08012345678" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Date of Birth</label>
          <input class="inp" id="editUserDob" placeholder="e.g. 01/01/2000" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Sex</label>
          <select class="sel" id="editUserSex" style="margin:0;">
            <option value="">â€” Select â€”</option>
            <option value="Female">Female</option>
            <option value="Male">Male</option>
          </select>
        </div>
        <div class="form-g" style="margin:0;" id="editMatricWrap">
          <label class="inp-label">Matric Number</label>
          <input class="inp" id="editUserMatric" placeholder="e.g. NACON/ND/HND/SET50/001" style="margin:0;">
        </div>
      </div>

      <div class="profile-section-title">Military / College Records</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;">
          <label class="inp-label">SVC Number</label>
          <input class="inp" id="editUserSvc" placeholder="e.g. 19NA/78/0526F" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Rank</label>
          <input class="inp" id="editUserRank" placeholder="e.g. LCPL, SN, PTE" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">BIA Number</label>
          <input class="inp" id="editUserBia" placeholder="e.g. BIA130820251739" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RRR Number</label>
          <input class="inp" id="editUserRrr" placeholder="e.g. 351303118414" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RN Index</label>
          <input class="inp" id="editUserRnIndex" placeholder="RN Index No." style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RM Index</label>
          <input class="inp" id="editUserRmIndex" placeholder="RM Index No." style="margin:0;">
        </div>
      </div>

      <div class="profile-section-title">Account</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Username</label>
          <input class="inp" id="editUserUsername" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Class</label>
          <select class="sel" id="editUserClass" style="margin:0;"></select>
        </div>
      </div>

      <div class="profile-section-title">Reset Password (optional)</div>
      <div class="form-g" style="margin:0;">
        <label class="inp-label">New Password</label>
        <input class="inp" id="editUserPass" type="password" placeholder="Leave blank to keep current" style="margin:0;">
      </div>

      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn-submit" onclick="saveEditUser()" style="flex:1;background:linear-gradient(135deg,var(--accent2),var(--accent));">ðŸ’¾ Save Changes â†’</button>
        <button class="btn-ghost" onclick="confirmDeleteUser()" style="color:var(--accent4);border-color:rgba(251,113,133,.3);">ðŸ—‘ Remove</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Class -->
<div class="overlay" id="addClassModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Add New Class</div><button class="modal-x" onclick="closeModal('addClassModal')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-g"><label class="inp-label">Class Name</label><input class="inp" id="newClassName" placeholder="e.g. ND THREE"></div>
      <div class="form-g"><label class="inp-label">Full Name</label><input class="inp" id="newClassFull" placeholder="e.g. National Diploma Year Three"></div>
      <div class="form-g"><label class="inp-label">Color</label>
        <select class="sel" id="newClassColor">
          <option value="blue">Blue</option><option value="purple">Purple</option>
          <option value="green">Green</option><option value="red">Red</option>
          <option value="yellow">Yellow</option><option value="pink">Pink</option>
        </select>
      </div>
      <button class="btn-submit" onclick="addClass()">Create Class â†’</button>
    </div>
  </div>
</div>

<!-- Add Course -->
<div class="overlay" id="addCourseModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Add Course</div><button class="modal-x" onclick="closeModal('addCourseModal')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-g"><label class="inp-label">Course Title</label><input class="inp" id="newCourseTitle" placeholder="e.g. Anatomy and Physiology I"></div>
      <div class="form-g"><label class="inp-label">Course Code</label><input class="inp" id="newCourseCode" placeholder="e.g. NSG 101"></div>
      <div class="form-g"><label class="inp-label">Lecturer</label><input class="inp" id="newCourseLecturer" placeholder="e.g. Dr. Adaora Obi"></div>
      <div class="form-g"><label class="inp-label">Class</label><select class="sel" id="newCourseClass"></select></div>
      <button class="btn-submit" onclick="addCourse()">Add Course â†’</button>
    </div>
  </div>
</div>

<!-- Add Handout -->
<div class="overlay" id="addHandoutModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Add Handout</div><button class="modal-x" onclick="closeModal('addHandoutModal')">âœ•</button></div>
    <div class="modal-bd">
      <div class="drop-area" id="handoutDrop" onclick="document.getElementById('handoutFile').click()">
        <div class="drop-ico" id="dropIco">ðŸ“</div>
        <div class="drop-txt" id="dropTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
        <div class="drop-fmts">PDF Â· DOC Â· DOCX Â· PPT Â· PPTX Â· PNG Â· JPG</div>
      </div>
      <input type="file" id="handoutFile" style="display:none" accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp" onchange="handoutFileChosen(this)">
      <div class="form-g"><label class="inp-label">Title</label><input class="inp" id="newHandoutTitle" placeholder="e.g. Week 3 Lecture Notes"></div>
      <div class="form-g"><label class="inp-label">Course</label><select class="sel" id="newHandoutCourse"></select></div>
      <div class="form-g"><label class="inp-label">File Type</label>
        <select class="sel" id="newHandoutType">
          <option value="pdf">PDF</option><option value="doc">DOC/DOCX</option>
          <option value="ppt">PPT/PPTX</option><option value="img">Image</option>
        </select>
      </div>
      <button class="btn-submit-green" onclick="addHandout()">Upload Handout â†’</button>
    </div>
  </div>
</div>

<!-- Upload Modal (sidebar) -->
<div class="overlay" id="uploadModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Upload Handout</div><button class="modal-x" onclick="closeModal('uploadModal')">âœ•</button></div>
    <div class="modal-bd">
      <div class="drop-area" onclick="document.getElementById('uploadFile').click()">
        <div class="drop-ico" id="uploadDropIco">ðŸ“</div>
        <div class="drop-txt" id="uploadDropTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
        <div class="drop-fmts">PDF Â· DOC Â· DOCX Â· PPT Â· PPTX Â· PNG Â· JPG</div>
      </div>
      <input type="file" id="uploadFile" style="display:none" accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp" onchange="uploadFileChosen(this)">
      <div class="form-g"><label class="inp-label">Title</label><input class="inp" id="uploadTitle" placeholder="e.g. Pharmacology Week 5 Notes"></div>
      <div class="form-g"><label class="inp-label">Class</label><select class="sel" id="uploadClass" onchange="filterUploadCourses()"></select></div>
      <div class="form-g"><label class="inp-label">Course</label><select class="sel" id="uploadCourse"></select></div>
      <div class="form-g"><label class="inp-label">File Type</label>
        <select class="sel" id="uploadType">
          <option value="pdf">PDF</option><option value="doc">DOC/DOCX</option>
          <option value="ppt">PPT/PPTX</option><option value="img">Image</option>
        </select>
      </div>
      <button class="btn-submit" onclick="submitUpload()">Upload â†’</button>
    </div>
  </div>
</div>

<!-- ===== SPREADSHEET IMPORT MODAL (admin only) ===== -->
<div class="overlay" id="ssImportModal">
  <div class="modal" style="max-width:760px;max-height:93vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“Š Upload Results Spreadsheet</div>
      <button class="modal-x" onclick="closeModal('ssImportModal')">âœ•</button>
    </div>
    <div class="modal-bd">

      <!-- Info banner -->
      <div style="background:rgba(56,189,248,.07);border:1px solid rgba(56,189,248,.2);border-radius:10px;padding:12px 16px;font-size:11.5px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:18px;line-height:2;">
        ðŸ“Œ Upload an <strong>.xlsx</strong> or <strong>.csv</strong> file with student results.<br>
        Required column: <code>Score</code> â€” Recommended: <code>Matric No.</code> &nbsp;Â·&nbsp; <code>Name</code> &nbsp;Â·&nbsp; <code>Total</code> &nbsp;Â·&nbsp; <code>Remarks</code><br>
        The system will <strong>auto-match each row to a student</strong> using their matric number. Unmatched rows are saved as unlinked and can still be seen by the student once their matric is updated.
      </div>

      <!-- Meta fields -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px;">
        <div class="form-g" style="margin:0">
          <label class="inp-label">Result Type</label>
          <select class="sel" id="ssType">
            <option value="test">Test / CA</option>
            <option value="exam">Exam</option>
          </select>
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Title / Description</label>
          <input class="inp" id="ssTitle" placeholder="e.g. Mid-Term Test 1 â€” 2024" style="margin:0">
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Class</label>
          <select class="sel" id="ssClass" onchange="ssFilterCourses()"></select>
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Course</label>
          <select class="sel" id="ssCourse"></select>
        </div>
      </div>

      <!-- Drop zone -->
      <div id="ssDropZone" onclick="document.getElementById('ssFileInput').click()"
           ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
           ondragleave="this.style.borderColor=''"
           ondrop="event.preventDefault();this.style.borderColor='';document.getElementById('ssFileInput').files=event.dataTransfer.files;ssFileChosen(document.getElementById('ssFileInput'))"
           style="border:2px dashed var(--border);border-radius:14px;padding:28px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;margin-bottom:14px;">
        <div style="font-size:32px;margin-bottom:8px;" id="ssDropIco">ðŸ“Š</div>
        <div style="font-size:14px;font-weight:600;color:var(--text);" id="ssDropTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px;font-family:'DM Mono',monospace;">.xlsx &nbsp;Â·&nbsp; .xls &nbsp;Â·&nbsp; .csv</div>
      </div>
      <input type="file" id="ssFileInput" style="display:none" accept=".xlsx,.xls,.csv" onchange="ssFileChosen(this)">

      <!-- Status line -->
      <div id="ssStatus" style="display:none;font-size:12px;font-family:'DM Mono',monospace;padding:8px 12px;border-radius:8px;background:var(--bg3);margin-bottom:14px;"></div>

      <!-- Preview -->
      <div id="ssPreviewWrap" style="display:none;">
        <div class="parse-preview">
          <div class="parse-preview-hd">
            <span id="ssPreviewCount"></span>
            <span id="ssPreviewErrors" style="color:var(--accent4);"></span>
          </div>
          <!-- Column headers -->
          <div class="parse-row" style="background:var(--bg3);padding:6px 14px;grid-template-columns:22px 110px 1fr 70px 60px 80px 24px;">
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">âœ“</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">MATRIC NO.</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">STUDENT NAME</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">SCORE</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">GRADE</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">MATCH</span>
            <span></span>
          </div>
          <div id="ssPreviewBody"></div>
        </div>

        <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;">
            <span style="color:var(--accent3);">âœ“ matched</span> = student found by matric &nbsp;Â·&nbsp;
            <span style="color:#fbbf24;">âš  unlinked</span> = matric not in system yet
          </div>
          <button class="btn-submit" id="ssImportBtn" onclick="ssImportAll()" style="width:auto;padding:11px 28px;background:linear-gradient(135deg,var(--accent2),var(--accent));" disabled>
            âœ“ Import <span id="ssImportBtnCount">0</span> Results â†’
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Paste Import Modal (Admin only) -->
<div class="overlay" id="pasteImportModal">
  <div class="modal" style="max-width:720px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“‹ Paste Import Results</div>
      <button class="modal-x" onclick="closeModal('pasteImportModal')">âœ•</button>
    </div>
    <div class="modal-bd">

      <!-- Step 1: Settings -->
      <div id="pasteStep1">
        <div style="background:rgba(56,189,248,.07);border:1px solid rgba(56,189,248,.2);border-radius:10px;padding:11px 14px;font-size:11px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:16px;line-height:1.8;">
          â„¹ï¸ Paste a list of results copied from Excel, Google Sheets, or any table.<br>
          Each row = one student. Columns auto-detected from: <strong>Matric No Â· Name Â· Score Â· Total</strong><br>
          Accepted formats: <code>tab-separated</code>, <code>comma-separated</code>, or <code>space-separated</code>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
          <div class="form-g" style="margin:0">
            <label class="inp-label">Result Type</label>
            <select class="sel" id="piType"><option value="test">Test</option><option value="exam">Exam</option></select>
          </div>
          <div class="form-g" style="margin:0">
            <label class="inp-label">Title / Description</label>
            <input class="inp" id="piTitle" placeholder="e.g. Mid-Term Test 1" style="margin:0">
          </div>
          <div class="form-g" style="margin:0">
            <label class="inp-label">Class</label>
            <select class="sel" id="piClass" onchange="piFilterCourses()"></select>
          </div>
          <div class="form-g" style="margin:0">
            <label class="inp-label">Course</label>
            <select class="sel" id="piCourse"></select>
          </div>
        </div>

        <div class="form-g">
          <label class="inp-label">Paste Data Here</label>
          <textarea class="paste-area" id="piPasteBox" placeholder="Paste your data hereâ€¦&#10;&#10;Example (tab or comma separated):&#10;NSG/23/001&#9;Amaka Eze&#9;78&#9;100&#10;NSG/23/002&#9;Chidi Obi&#9;65&#9;100&#10;NSG/23/003&#9;Funke Bello&#9;54&#9;100&#10;&#10;Or just name + score:&#10;Amaka Eze&#9;78&#10;Chidi Obi&#9;65" oninput="piParseAndPreview()"></textarea>
        </div>

        <div id="piPreviewWrap" style="display:none">
          <div class="parse-preview">
            <div class="parse-preview-hd">
              <span id="piPreviewCount">0 rows parsed</span>
              <span id="piPreviewErrors" style="color:var(--accent4)"></span>
            </div>
            <!-- Column headers -->
            <div class="parse-row" style="background:var(--bg3);padding:6px 14px;">
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">âœ“</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">MATRIC NO.</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">STUDENT NAME</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">SCORE</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">GRADE</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">STATUS</span>
              <span></span>
            </div>
            <div id="piPreviewBody"></div>
          </div>

          <div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;" id="piSummary"></div>
            <button class="btn-submit" onclick="piImportAll()" id="piImportBtn" style="width:auto;padding:11px 28px;">
              âœ“ Import All Valid Rows
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Add Result (Teacher/Admin only) -->
<div class="overlay" id="addResultModal">
  <div class="modal modal-wide">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“Š Upload Result</div>
      <button class="modal-x" onclick="closeModal('addResultModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g">
          <label class="inp-label">Result Type</label>
          <select class="sel" id="newResultType">
            <option value="test">Test</option>
            <option value="exam">Exam</option>
          </select>
        </div>
        <div class="form-g">
          <label class="inp-label">Title / Description</label>
          <input class="inp" id="newResultTitle" placeholder="e.g. Mid-Term Test, Final Exam">
        </div>
        <div class="form-g">
          <label class="inp-label">Class</label>
          <select class="sel" id="newResultClass" onchange="filterResultModalCourses();filterResultModalStudents()"></select>
        </div>
        <div class="form-g">
          <label class="inp-label">Course</label>
          <select class="sel" id="newResultCourse"></select>
        </div>
        <div class="form-g">
          <label class="inp-label">Student</label>
          <select class="sel" id="newResultStudent"></select>
        </div>
        <div class="form-g">
          <label class="inp-label">Score (%)</label>
          <input class="inp" id="newResultScore" type="number" min="0" max="100" placeholder="e.g. 78">
        </div>
        <div class="form-g">
          <label class="inp-label">Total Marks</label>
          <input class="inp" id="newResultTotal" type="number" min="1" placeholder="e.g. 100">
        </div>
        <div class="form-g">
          <label class="inp-label">Remarks (optional)</label>
          <input class="inp" id="newResultRemarks" placeholder="e.g. Excellent performance">
        </div>
      </div>
      <button class="btn-submit" onclick="submitResult()">Save Result â†’</button>
    </div>
  </div>
</div>

<!-- Add Lecturer (Admin only) -->
<div class="overlay" id="addLecturerModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Create Lecturer Account</div><button class="modal-x" onclick="closeModal('addLecturerModal')">âœ•</button></div>
    <div class="modal-bd">
      <div style="background:rgba(56,189,248,.07);border:1px solid rgba(56,189,248,.2);border-radius:10px;padding:12px 14px;font-size:11px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:18px;line-height:1.7;">
        â„¹ï¸ Only you (Admin) can create lecturer accounts. Share the credentials with the lecturer so they can sign in.
      </div>
      <div class="form-g"><label class="inp-label">Lecturer Full Name</label><input class="inp" id="lecturerName" placeholder="e.g. Dr. Adaora Obi"></div>
      <div class="form-g"><label class="inp-label">Username</label><input class="inp" id="lecturerUsername" type="text" placeholder="e.g. dr.adaora"></div>
      <div class="form-g"><label class="inp-label">Temporary Password</label><input class="inp" id="lecturerPassword" placeholder="Set a temporary password for them"></div>
      <button class="btn-submit" onclick="addLecturerAccount()">Create Lecturer Account â†’</button>
    </div>
  </div>
</div>

<!-- ===== FOLDER UPLOAD FULL-SCREEN ===== -->
<div class="fu-overlay" id="fuOverlay">

  <!-- Top bar -->
  <div class="fu-topbar">
    <button class="fu-back" onclick="closeFolderUpload()">â† Back</button>
    <div class="fu-title">ðŸ“‚ Folder Upload</div>
    <div style="font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;" id="fuTopStats"></div>
  </div>

  <!-- Body: left tree + right config -->
  <div class="fu-body">

    <!-- LEFT: Drop zone + file tree -->
    <div class="fu-left">

      <!-- Drop zone -->
      <div class="fu-dropzone" id="fuDropzone"
        ondragover="fuDragOver(event)"
        ondragleave="fuDragLeave(event)"
        ondrop="fuDrop(event)"
        onclick="document.getElementById('fuFolderInput').click()">
        <div class="fu-dz-ico" id="fuDzIco">ðŸ“‚</div>
        <div class="fu-dz-title" id="fuDzTitle">Drop a folder here</div>
        <div class="fu-dz-sub" id="fuDzSub">
          Drag &amp; drop a folder from your computer,<br>
          Google Drive, USB drive, or any storage
        </div>
        <div class="fu-dz-hint">Supports: PDF, DOC, DOCX, PPT, PPTX, PNG, JPG, GIF, WEBP</div>
        <div class="fu-dz-btns">
          <button class="fu-dz-btn primary" onclick="event.stopPropagation();document.getElementById('fuFolderInput').click()">ðŸ“ Choose Folder</button>
          <button class="fu-dz-btn" onclick="event.stopPropagation();document.getElementById('fuFilesInput').click()">ðŸ“„ Choose Files</button>
        </div>
      </div>

      <!-- Hidden folder/file inputs -->
      <input type="file" id="fuFolderInput" style="display:none" webkitdirectory multiple onchange="fuFolderChosen(this)">
      <input type="file" id="fuFilesInput" style="display:none" multiple
        accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp"
        onchange="fuFilesChosen(this)">

      <!-- File tree -->
      <div class="fu-tree-hd">
        <span>Files <span id="fuTreeCount">0</span></span>
        <div style="display:flex;gap:8px;">
          <span style="cursor:pointer;color:var(--accent2);" onclick="fuSelectAll(true)">All</span>
          <span style="cursor:pointer;color:var(--accent4);" onclick="fuSelectAll(false)">None</span>
        </div>
      </div>
      <div class="fu-tree" id="fuTree">
        <div class="fu-empty-state" style="padding:30px 20px;">
          <div class="fu-empty-ico">ðŸ“‚</div>
          <div class="fu-empty-t" style="font-size:13px;">No folder selected</div>
          <div class="fu-empty-s" style="font-size:11px;">Drop a folder or click above</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Assignment + file list + progress -->
    <div class="fu-right" id="fuRight">

      <!-- Empty state -->
      <div class="fu-empty-state" id="fuEmptyState">
        <div class="fu-empty-ico">â¬†ï¸</div>
        <div class="fu-empty-t">No files loaded yet</div>
        <div class="fu-empty-s">Drop a folder from your computer, Google Drive,<br>USB drive, or any external storage on the left</div>
      </div>

      <!-- Assignment panel (shown when files loaded) -->
      <div id="fuAssignPanel" style="display:none;">
        <div class="fu-section-title">ðŸ“Œ Assign to Class &amp; Course</div>
        <div style="background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.15);border-radius:10px;padding:11px 14px;font-size:12px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:16px;line-height:1.6;">
          â„¹ï¸ Set a default class &amp; course for all files. You can override individual files in the table below.
        </div>
        <div class="fu-assignment-grid">
          <div class="fu-field">
            <label>Default Class</label>
            <select class="fu-sel" id="fuDefaultClass" onchange="fuClassChanged()">
              <option value="">â€” Select class â€”</option>
            </select>
          </div>
          <div class="fu-field">
            <label>Default Course</label>
            <select class="fu-sel" id="fuDefaultCourse">
              <option value="">â€” Select course â€”</option>
            </select>
          </div>
        </div>

        <div class="fu-section-title" style="margin-top:8px;">ðŸ“‹ Files to Upload (<span id="fuSelectedCount">0</span> selected)</div>
        <div class="fu-files-table">
          <div class="fu-files-thead">
            <div class="fu-file-cell" style="width:20px;padding:0;"></div>
            <div class="fu-file-cell">File Name</div>
            <div class="fu-file-cell">Folder Path</div>
            <div class="fu-file-cell">Type</div>
            <div class="fu-file-cell">Size</div>
          </div>
          <div id="fuFileRows"></div>
        </div>
      </div>

      <!-- Progress panel -->
      <div id="fuProgressPanel" style="display:none;">
        <div class="fu-section-title">â¬†ï¸ Uploading Filesâ€¦</div>
        <div class="fu-progress-wrap" id="fuProgressWrap"></div>
      </div>

      <!-- Done panel -->
      <div id="fuDonePanel" style="display:none;text-align:center;padding:60px 20px;">
        <div style="font-size:64px;margin-bottom:16px;">âœ…</div>
        <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:700;margin-bottom:8px;" id="fuDoneTitle">Upload Complete!</div>
        <div style="font-size:14px;color:var(--text2);margin-bottom:28px;" id="fuDoneSub"></div>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
          <button class="fu-btn-cancel" onclick="fuReset()">Upload Another Folder</button>
          <button class="fu-btn-upload" onclick="closeFolderUpload()">Go to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom summary bar -->
  <div class="fu-summary" id="fuSummaryBar" style="display:none;">
    <div class="fu-sum-stat"><div class="fu-sum-val" id="fuSumFiles" style="color:var(--accent)">0</div><div class="fu-sum-lbl">Files</div></div>
    <div class="fu-sum-sep"></div>
    <div class="fu-sum-stat"><div class="fu-sum-val" id="fuSumSelected" style="color:var(--accent3)">0</div><div class="fu-sum-lbl">Selected</div></div>
    <div class="fu-sum-sep"></div>
    <div class="fu-sum-stat"><div class="fu-sum-val" id="fuSumSize" style="color:var(--accent2)">0 KB</div><div class="fu-sum-lbl">Total Size</div></div>
    <div class="fu-sum-sep"></div>
    <div class="fu-sum-stat"><div class="fu-sum-val" id="fuSumFolders" style="color:var(--accent4)">0</div><div class="fu-sum-lbl">Folders</div></div>
    <div class="fu-action-btns">
      <button class="fu-btn-cancel" onclick="closeFolderUpload()">Cancel</button>
      <button class="fu-btn-upload" id="fuUploadBtn" onclick="fuStartUpload()" disabled>â¬† Upload Selected Files</button>
    </div>
  </div>

</div>

<!-- ===== FULL SCREEN PREVIEW VIEWER ===== -->
<div class="pv-overlay" id="pvOverlay">

  <!-- Top bar -->
  <div class="pv-topbar">
    <button class="pv-back" onclick="closePreview()">â† Back</button>
    <div class="pv-title-block">
      <div class="pv-title" id="pvTitle">Handout Preview</div>
      <div class="pv-subtitle" id="pvSubtitle"></div>
    </div>
    <span class="pv-badge fb-pdf" id="pvBadge" style="display:none"></span>
    <button class="pv-dl-btn" id="pvDlBtn" onclick="doDownload()">â¬‡ Download</button>
    <button class="pv-tool-btn" onclick="toggleInfoPanel()" title="Details" style="width:auto;padding:0 12px;gap:6px;font-size:12px;font-family:'DM Mono',monospace;">â„¹ Info</button>
  </div>

  <!-- Toolbar (zoom + page nav) -->
  <div class="pv-toolbar" id="pvToolbar">
    <!-- page nav (PDF only) -->
    <span class="pv-toolbar-label" id="pvPageLabel" style="display:none">Page:</span>
    <button class="pv-tool-btn" id="pvPrevPage" onclick="pvChangePage(-1)" style="display:none" title="Previous page">â€¹</button>
    <span class="pv-pg-info" id="pvPageInfo" style="display:none">1 / 1</span>
    <button class="pv-tool-btn" id="pvNextPage" onclick="pvChangePage(1)" style="display:none" title="Next page">â€º</button>
    <div class="pv-sep" id="pvPageSep" style="display:none"></div>
    <!-- zoom -->
    <span class="pv-toolbar-label">Zoom:</span>
    <button class="pv-tool-btn" id="pvZoomOut" onclick="pvZoom(-0.15)" title="Zoom out">âˆ’</button>
    <span class="pv-zoom-val" id="pvZoomVal">100%</span>
    <button class="pv-tool-btn" id="pvZoomIn" onclick="pvZoom(0.15)" title="Zoom in">+</button>
    <button class="pv-tool-btn" onclick="pvResetZoom()" title="Reset zoom" style="font-size:11px;font-family:'DM Mono',monospace;width:auto;padding:0 8px;">1:1</button>
    <div class="pv-sep"></div>
    <button class="pv-tool-btn" onclick="pvFitWidth()" title="Fit to width" style="font-size:11px;font-family:'DM Mono',monospace;width:auto;padding:0 8px;">Fit</button>
    <button class="pv-fullscreen-btn" onclick="pvToggleFullscreen()">â›¶ Fullscreen</button>
  </div>

  <!-- Viewer body -->
  <div class="pv-body" id="pvBody">
    <div class="pv-spinner" id="pvSpinner">
      <div class="pv-spin-ring"></div>
      <div class="pv-spin-txt">Loading previewâ€¦</div>
    </div>
  </div>

  <!-- Info panel (slides in from right) -->
  <div class="pv-info-panel" id="pvInfoPanel">
    <div class="pv-info-hd">
      <span>File Details</span>
      <button class="pv-info-close" onclick="toggleInfoPanel()">âœ•</button>
    </div>
    <div class="pv-info-body">
      <div class="pv-info-field"><div class="pv-info-label">Title</div><div class="pv-info-value" id="pvInfoTitle">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">File Type</div><div class="pv-info-value" id="pvInfoType">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">Uploaded By</div><div class="pv-info-value" id="pvInfoLecturer">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">Date</div><div class="pv-info-value" id="pvInfoDate">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">Course</div><div class="pv-info-value" id="pvInfoCourse">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">Class</div><div class="pv-info-value" id="pvInfoClass">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">File Size</div><div class="pv-info-value" id="pvInfoSize">â€”</div></div>
      <div style="margin-top:8px;">
        <button class="pv-dl-btn" style="width:100%;justify-content:center;" onclick="doDownload()">â¬‡ Download File</button>
      </div>
    </div>
  </div>

</div>

<script>
// ============================================================
// CONSTANTS
// ============================================================
const ADMIN_USERNAME = 'admin';
const ADMIN_PASSWORD = 'elite123';
const ADMIN_NAME     = 'Admin';

const colorMap = {
  blue:  {color:'var(--nd1)', bg:'rgba(56,189,248,.12)'},
  purple:{color:'var(--nd2)', bg:'rgba(129,140,248,.12)'},
  green: {color:'var(--hnd1)',bg:'rgba(52,211,153,.12)'},
  red:   {color:'var(--hnd2)',bg:'rgba(251,113,133,.12)'},
  yellow:{color:'#fbbf24',    bg:'rgba(251,191,36,.12)'},
  pink:  {color:'#f472b6',    bg:'rgba(244,114,182,.12)'},
};
const fileIco={pdf:'ðŸ“„',doc:'ðŸ“',ppt:'ðŸ“Š',img:'ðŸ–¼ï¸'};
const fileBg ={pdf:'rgba(251,113,133,.1)',doc:'rgba(56,189,248,.1)',ppt:'rgba(251,191,36,.1)',img:'rgba(52,211,153,.1)'};

// ============================================================
// DATABASE â€” localStorage
// ============================================================
function seedDB(){
  return {
    classes:[
      {id:'nd1', name:'ND ONE', full:'National Diploma Year One',       color:'blue'},
      {id:'nd2', name:'ND TWO', full:'National Diploma Year Two',       color:'purple'},
      {id:'hnd1',name:'HND ONE',full:'Higher National Diploma Year One',color:'green'},
      {id:'hnd2',name:'HND TWO',full:'Higher National Diploma Year Two',color:'red'},
    ],
    courses:[
      {id:'c1', classId:'nd1', title:'Anatomy and Physiology I',             code:'NSG 101',lecturer:'Dr. Adaora Obi',      creditUnits:3},
      {id:'c2', classId:'nd1', title:'Fundamentals of Nursing Practice',     code:'NSG 102',lecturer:'Mrs. Ngozi Eze',      creditUnits:4},
      {id:'c3', classId:'nd1', title:'Medical Microbiology',                 code:'NSG 103',lecturer:'Dr. Emeka Okafor',   creditUnits:3},
      {id:'c4', classId:'nd1', title:'Nutrition and Dietetics',              code:'NSG 104',lecturer:'Mrs. Amaka Dike',     creditUnits:2},
      {id:'c5', classId:'nd2', title:'Anatomy and Physiology II',            code:'NSG 201',lecturer:'Dr. Adaora Obi',      creditUnits:3},
      {id:'c6', classId:'nd2', title:'Medical and Surgical Nursing',         code:'NSG 202',lecturer:'Mrs. Ngozi Eze',      creditUnits:4},
      {id:'c7', classId:'nd2', title:'Pharmacology I',                       code:'NSG 203',lecturer:'Dr. Chukwu Nwosu',   creditUnits:3},
      {id:'c8', classId:'nd2', title:'Community Health Nursing',             code:'NSG 204',lecturer:'Mrs. Funke Bello',    creditUnits:3},
      {id:'c9', classId:'hnd1',title:'Advanced Medical-Surgical Nursing',    code:'NSG 301',lecturer:'Dr. Emeka Okafor',   creditUnits:4},
      {id:'c10',classId:'hnd1',title:'Maternal and Child Health Nursing',    code:'NSG 302',lecturer:'Mrs. Yetunde Adeyemi',creditUnits:3},
      {id:'c11',classId:'hnd1',title:'Pharmacology II',                      code:'NSG 303',lecturer:'Dr. Chukwu Nwosu',   creditUnits:3},
      {id:'c12',classId:'hnd1',title:'Psychiatric and Mental Health Nursing',code:'NSG 304',lecturer:'Dr. Sola Adesanya',  creditUnits:3},
      {id:'c13',classId:'hnd2',title:'Nursing Research Methods',             code:'NSG 401',lecturer:'Prof. Bisi Adewale', creditUnits:3},
      {id:'c14',classId:'hnd2',title:'Nursing Management & Leadership',      code:'NSG 402',lecturer:'Mrs. Amaka Dike',     creditUnits:3},
      {id:'c15',classId:'hnd2',title:'Critical Care Nursing',                code:'NSG 403',lecturer:'Dr. Adaora Obi',      creditUnits:4},
      {id:'c16',classId:'hnd2',title:'Clinical Practicum & Supervision',     code:'NSG 404',lecturer:'Mrs. Ngozi Eze',      creditUnits:4},
    ],
    handouts:[],
    users:[],
    results:[],   // { id, type, title, courseId, classId, studentId, studentName, score, total, grade, date, uploadedBy, remarks }
    pastQuestions:[], // { id, title, year, type, courseId, questions:[], createdBy, createdAt }
    messages:[],      // all chat messages
    dmThreads:[],     // opened DM thread IDs (for both-side visibility)
    _version: 8,
  };
}

// â”€â”€ Restore users from backup key if main DB lost them â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _restoreUsersFromBackup(dbObj){
  try {
    if(!dbObj.users||dbObj.users.length===0){
      const raw=localStorage.getItem('nv_users_backup');
      if(raw){
        const backed=JSON.parse(raw);
        if(backed&&backed.length>0){ dbObj.users=backed; }
      }
    }
  } catch(e){}
  return dbObj;
}

function loadDB(){
  try{
    const raw = localStorage.getItem('nv_db');
    if(!raw) {
      // Try restoring from user backup before returning seed
      const bkp = _restoreUsersFromBackup(seedDB());
      return bkp;
    }
    const parsed = JSON.parse(raw);
    // If version is old, migrate important data into a fresh DB
    if(!parsed._version || parsed._version < 8){
      console.log('DB version upgrade â€” migrating to v8');
      const fresh = seedDB();
      // Preserve ALL admin-created data across the version bump
      fresh.messages      = parsed.messages      || [];
      fresh.results       = parsed.results       || [];
      fresh.handouts      = parsed.handouts      || [];
      fresh.pastQuestions = parsed.pastQuestions || [];
      fresh.dmThreads     = parsed.dmThreads     || [];
      fresh.adminPhone    = parsed.adminPhone    || '';
      fresh.adminAvatar   = parsed.adminAvatar   || '';
      // Preserve ALL existing users (teachers + manually-added/imported students)
      fresh.users = (parsed.users||[]).slice();
      // Preserve custom classes if they exist; fall back to seed defaults
      if(parsed.classes && parsed.classes.length > 0){
        fresh.classes = parsed.classes.slice();
      }
      // Preserve custom courses if they exist
      if(parsed.courses && parsed.courses.length > 0){
        fresh.courses = parsed.courses.slice();
      }
      fresh._version = 8;
      localStorage.setItem('nv_db', JSON.stringify(fresh));
      return fresh;
    }
    // Patch missing arrays
    if(!parsed.pastQuestions) parsed.pastQuestions=[];
    if(!parsed.messages)      parsed.messages=[];
    if(!parsed.users)         parsed.users=[];
    if(!parsed.classes)       parsed.classes=[];
    if(!parsed.courses)       parsed.courses=[];
    if(!parsed.handouts)      parsed.handouts=[];
    if(!parsed.results)       parsed.results=[];
    if(!parsed.dmThreads)     parsed.dmThreads=[];
    // If users array is empty but backup exists, restore it
    if(!parsed.users||parsed.users.length===0) _restoreUsersFromBackup(parsed);
    return parsed;
  } catch(e){
    return seedDB();
  }
}
// â”€â”€ Cross-tab / cross-window sync via BroadcastChannel + storage event â”€â”€
let _nvChannel = null;
try { _nvChannel = new BroadcastChannel('nv_sync'); } catch(e){}

function saveMsgFileData(msgId, fileData){
  // Store file/voice data for a message in its own localStorage key
  try{
    localStorage.setItem('nv_msgfile_'+msgId, fileData);
    return true;
  } catch(e){
    // Quota exceeded â€” try clearing old message file entries to make room
    try{
      const keys=[];
      for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k&&k.startsWith('nv_msgfile_')) keys.push(k); }
      // Remove oldest half
      keys.slice(0, Math.ceil(keys.length/2)).forEach(k=>{ try{localStorage.removeItem(k);}catch(e2){} });
      localStorage.setItem('nv_msgfile_'+msgId, fileData);
      return true;
    } catch(e2){
      return false;
    }
  }
}
function loadMsgFileData(msgId){ try{ return localStorage.getItem('nv_msgfile_'+msgId)||null; }catch(e){ return null; } }

function saveDB(){
  try{
    // Ensure all arrays exist before saving
    if(!db.messages) db.messages=[];
    if(!db.users) db.users=[];
    if(!db.classes) db.classes=[];
    if(!db.courses) db.courses=[];
    if(!db.handouts) db.handouts=[];
    if(!db.results) db.results=[];
    if(!db.pastQuestions) db.pastQuestions=[];
    if(!db.dmThreads) db.dmThreads=[];
    // Always stamp current version so migration never re-runs
    db._version = 8;

    // Strip large fileData from messages before saving to main DB
    // (file data is stored separately via saveMsgFileData)
    const msgsToSave = db.messages.map(m=>{
      if(!m.fileData) return m;
      const {fileData, ...rest} = m;
      return rest;
    });
    const dbToSave = {...db, messages: msgsToSave};

    try{
      localStorage.setItem('nv_db', JSON.stringify(dbToSave));
    } catch(e){
      // Quota exceeded for main DB â€” try removing old message file data and retry
      for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k&&k.startsWith('nv_msgfile_')){ try{localStorage.removeItem(k);}catch(e2){} } }
      try{ localStorage.setItem('nv_db', JSON.stringify(dbToSave)); }catch(e2){ console.warn('saveDB failed even after cleanup:', e2); }
    }
    // Notify other tabs
    if(_nvChannel){ try{ _nvChannel.postMessage({type:'db_updated',ts:Date.now()}); }catch(e){} }
    // Keep user backup in sync
    try{ localStorage.setItem('nv_users_backup', JSON.stringify(db.users||[])); }catch(e){}
  } catch(e){ console.warn('saveDB failed:', e); }
}

function _onExternalDBUpdate(){
  _reloadDbFromStorage();
  // Refresh message UI if open
  if(typeof renderMsgChannels === 'function'){
    try{
      const inp = document.getElementById('msgSearchInp');
      renderMsgChannels(inp ? inp.value : '');
    }catch(e){}
  }
  if(typeof renderMsgBody === 'function' && typeof activeThreadId !== 'undefined' && activeThreadId){
    try{ renderMsgBody(activeThreadId); }catch(e){}
  }
}

// BroadcastChannel listener (same origin, different tab)
if(_nvChannel){
  _nvChannel.onmessage = function(e){
    if(e.data && e.data.type === 'db_updated') _onExternalDBUpdate();
  };
}
// storage event (different window / different browser profile on same origin)
window.addEventListener('storage', function(e){
  if(e.key === 'nv_db') _onExternalDBUpdate();
});

let db = loadDB();

// In-memory file store (not persisted)
const fileStore = {};

let currentRole = 'student';
let currentUser = {};
let currentClassId = null;
let currentCourseId = null;
let previewId = null;

// ============================================================
// SAVED ACCOUNTS â€” quick login dropdown
// ============================================================
const SA_KEY = 'nv_saved_accs_v5'; // new key â€” avoids old corrupt data

function getSavedAccounts(){
  try{ return JSON.parse(localStorage.getItem(SA_KEY)) || []; } catch(e){ return []; }
}
function saveAccount(username, password, name, role){
  try{
    let arr = getSavedAccounts().filter(a => a.u !== username);
    arr.unshift({ u: username, p: password, n: name, r: role });
    localStorage.setItem(SA_KEY, JSON.stringify(arr.slice(0, 8)));
  } catch(e){}
}
function removeSavedAccount(username){
  try{
    const arr = getSavedAccounts().filter(a => a.u !== username);
    localStorage.setItem(SA_KEY, JSON.stringify(arr));
    renderSavedDropdown();
  } catch(e){}
}

function renderSavedDropdown(filter){
  const list = document.getElementById('savedList');
  if(!list) return;
  const all = getSavedAccounts();
  const q = (filter||'').toLowerCase();
  const shown = q ? all.filter(a => a.u.includes(q) || (a.n||'').toLowerCase().includes(q)) : all;
  if(!shown.length){ list.innerHTML = '<div class="saved-dropdown-empty">No saved accounts</div>'; return; }
  const rc = r => r==='admin'?'rgba(251,191,36,.15)':r==='teacher'?'rgba(56,189,248,.15)':'rgba(52,211,153,.15)';
  const rt = r => r==='admin'?'#fbbf24':r==='teacher'?'var(--accent)':'var(--accent3)';
  list.innerHTML = shown.map(a=>`
    <div class="saved-account-item" onclick="fillSaved('${a.u}','${encodeURIComponent(a.p)}')">
      <div class="saved-account-av">${(a.n||a.u)[0].toUpperCase()}</div>
      <div class="saved-account-info">
        <div class="saved-account-name">${a.n||a.u}</div>
        <div class="saved-account-email">${a.u}</div>
      </div>
      <span class="saved-account-role" style="background:${rc(a.r)};color:${rt(a.r)}">${a.r}</span>
      <button class="saved-account-del" onclick="event.stopPropagation();removeSavedAccount('${a.u}')" title="Remove">âœ•</button>
    </div>`).join('');
}

function openSavedDropdown(){
  const dd = document.getElementById('savedDropdown');
  const list = getSavedAccounts();
  if(!dd||!list.length) return;
  renderSavedDropdown(document.getElementById('loginUsername').value);
  dd.classList.add('open');
}
function closeSavedDropdown(){
  const dd = document.getElementById('savedDropdown');
  if(dd) dd.classList.remove('open');
}
function filterSavedDropdown(val){
  const dd = document.getElementById('savedDropdown');
  const list = getSavedAccounts();
  if(!dd||!list.length){ if(dd) dd.classList.remove('open'); return; }
  renderSavedDropdown(val);
  dd.classList.add('open');
}
function handleUsernameKey(e){
  const dd = document.getElementById('savedDropdown');
  if(!dd||!dd.classList.contains('open')) return;
  const items = dd.querySelectorAll('.saved-account-item');
  let active = dd.querySelector('.saved-account-item.active');
  const idx = active ? Array.from(items).indexOf(active) : -1;
  if(e.key === 'ArrowDown'){
    e.preventDefault();
    if(active) active.classList.remove('active');
    const next = items[idx + 1] || items[0];
    if(next) next.classList.add('active');
  } else if(e.key === 'ArrowUp'){
    e.preventDefault();
    if(active) active.classList.remove('active');
    const prev = items[idx - 1] || items[items.length - 1];
    if(prev) prev.classList.add('active');
  } else if(e.key === 'Enter'){
    if(active){ e.preventDefault(); active.click(); }
  } else if(e.key === 'Escape'){
    closeSavedDropdown();
  }
}
function fillSaved(u, ep){
  document.getElementById('loginUsername').value = u;
  document.getElementById('loginPassword').value = decodeURIComponent(ep);
  closeSavedDropdown();
}
document.addEventListener('click', function(e){
  if(!e.target.closest('#savedDropdown') && !e.target.closest('#loginUsername')) closeSavedDropdown();
});

// ============================================================
// PASSWORD VISIBILITY
// ============================================================
function togglePassVis(inputId, btn){
  const inp = document.getElementById(inputId);
  if(!inp) return;
  if(inp.type==='password'){ inp.type='text'; btn.textContent='ðŸ™ˆ'; }
  else { inp.type='password'; btn.textContent='ðŸ‘'; }
}

// ============================================================
// THEME TOGGLE  (golden + army green light theme)
// ============================================================
function toggleTheme(){
  const isLight = document.body.classList.toggle('light');
  localStorage.setItem('nv_theme', isLight ? 'light' : 'dark');
  document.querySelectorAll('.theme-btn').forEach(b => b.textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™');
}
(function applyTheme(){
  if(localStorage.getItem('nv_theme') === 'light'){
    document.body.classList.add('light');
    document.querySelectorAll('.theme-btn').forEach(b => b.textContent = 'â˜€ï¸');
  }
})();

// ============================================================
// AUTH â€” switch between login / signup tabs
// ============================================================
function switchAuth(mode){
  const lf = document.getElementById('loginForm');
  const sf = document.getElementById('signupForm');
  const ff = document.getElementById('forgotForm');
  if(!lf||!sf) return;
  lf.style.display = mode==='login'  ? '' : 'none';
  sf.style.display = mode==='signup' ? '' : 'none';
  if(ff) ff.style.display = mode==='forgot' ? '' : 'none';
  ['loginErr','signupErr'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove('show');
  });
  closeSavedDropdown();
  if(mode==='signup'){
    const sel = document.getElementById('signupClass');
    if(sel) sel.innerHTML = db.classes.map(c=>`<option value="${c.id}">${c.name} â€” ${c.full}</option>`).join('');
  }
}

function doForgotPassword(){
  const username = (document.getElementById('forgotUsername').value||'').trim().toLowerCase();
  const newPass  = document.getElementById('forgotNewPass').value;
  const confPass = document.getElementById('forgotConfPass').value;
  const errEl    = document.getElementById('forgotErr');
  const okEl     = document.getElementById('forgotSuccess');
  errEl.style.display='none'; okEl.style.display='none';
  function fail(msg){ errEl.textContent=msg; errEl.style.display='block'; errEl.classList.add('show'); }
  if(!username)      return fail('Please enter your username.');
  if(!newPass)       return fail('Please enter a new password.');
  if(newPass.length<6) return fail('Password must be at least 6 characters.');
  if(newPass!==confPass) return fail('Passwords do not match.');
  const user = (db.users||[]).find(u=>(u.username||'').toLowerCase()===username);
  if(!user) return fail('Username not found. Check spelling and try again.');
  user.password = newPass;
  saveDB();
  okEl.style.display='block';
  document.getElementById('forgotNewPass').value='';
  document.getElementById('forgotConfPass').value='';
  setTimeout(function(){ switchAuth('login'); document.getElementById('loginUsername').value=username; }, 2000);
}

// ============================================================
// LOGIN
// ============================================================
function doLogin(){
  closeSavedDropdown();
  const username = (document.getElementById('loginUsername').value||'').trim().toLowerCase();
  const pass     = (document.getElementById('loginPassword').value||'');
  const errEl    = document.getElementById('loginErr');

  errEl.classList.remove('show');

  if(!username || !pass){
    errEl.textContent = 'Please enter username and password.';
    errEl.classList.add('show');
    return;
  }

  // Admin check
  if(username === ADMIN_USERNAME && pass === ADMIN_PASSWORD){
    currentRole = 'admin';
    currentUser = { id: 'admin', name: ADMIN_NAME, username: ADMIN_USERNAME, role: 'admin', cls: 'All', phone: db.adminPhone||'', avatar: db.adminAvatar||'' };
    saveAccount(username, pass, ADMIN_NAME, 'admin');
    launchApp();
    return;
  }

  // Student / teacher check
  const user = db.users.find(u => (u.username||'').toLowerCase() === username && u.password === pass);
  if(!user){
    errEl.textContent = 'Incorrect username or password.';
    errEl.classList.add('show');
    return;
  }

  currentRole = user.role || 'student';
  currentUser = user;
  saveAccount(username, pass, user.name, user.role);
  launchApp();
}

// ============================================================
// SIGNUP
// ============================================================
function doSignup(){
  const name     = (document.getElementById('signupName').value||'').trim();
  const username = (document.getElementById('signupUsername').value||'').trim().toLowerCase().replace(/\s+/g,'');
  const matric   = (document.getElementById('signupMatric')&&document.getElementById('signupMatric').value||'').trim().toUpperCase();
  const cls      = (document.getElementById('signupClass').value||'nd1');
  const pass     = (document.getElementById('signupPassword').value||'');
  const confirm  = (document.getElementById('signupConfirm').value||'');
  const errEl    = document.getElementById('signupErr');

  errEl.classList.remove('show');

  function fail(msg){ errEl.textContent = msg; errEl.classList.add('show'); }

  if(!name)            return fail('Please enter your full name.');
  if(!username)        return fail('Please choose a username.');
  if(username.length < 3) return fail('Username must be at least 3 characters.');
  if(!/^[a-z0-9_.-]+$/.test(username)) return fail('Username: only letters, numbers, _ . - allowed.');
  if(!pass)            return fail('Please enter a password.');
  if(pass.length < 6)  return fail('Password must be at least 6 characters.');
  if(pass !== confirm) return fail('Passwords do not match.');
  if(username === ADMIN_USERNAME) return fail('That username is not available.');
  if(db.users.find(u => (u.username||'').toLowerCase() === username)) return fail('Username already taken.');

  const clsObj = db.classes.find(c => c.id === cls);
  const newUser = {
    id: 'u_' + Date.now(),
    name, username, matric, password: pass,
    role: 'student',
    cls: clsObj ? clsObj.name : 'ND ONE',
    classId: cls
  };
  db.users.push(newUser);
  saveDB();

  currentRole = 'student';
  currentUser = newUser;
  saveAccount(username, pass, name, 'student');
  toast('Welcome, ' + name + '! ðŸŽ‰');
  launchApp();
}

// ============================================================
// LAUNCH APP
// ============================================================
function launchApp(){
  document.getElementById('authPage').style.display = 'none';
  document.getElementById('appWrap').style.display  = 'flex';
  setupRoleUI();
  renderSidebar();
  renderDashboard();
}

// Initialise signup class dropdown on page load
document.getElementById('signupClass').innerHTML =
  db.classes.map(c=>`<option value="${c.id}">${c.name} â€” ${c.full}</option>`).join('');

// ============================================================
// LOGOUT
// ============================================================
function doLogout(){
  currentUser={}; currentRole='student';
  currentClassId=null; currentCourseId=null; previewId=null;
  document.getElementById('appWrap').style.display  = 'none';
  document.getElementById('authPage').style.display = 'flex';
  switchAuth('login');
  document.getElementById('loginUsername').value = '';
  const pwEl = document.getElementById('loginPassword');
  pwEl.value = ''; pwEl.type = 'password';
  const tog = document.querySelector('.pass-toggle');
  if(tog) tog.textContent = 'ðŸ‘';
}

// ============================================================
// FILE STORAGE (localStorage, chunked)
// ============================================================
function saveFileData(hid, data){ try{ localStorage.setItem('nv_file_'+hid, JSON.stringify(data)); }catch(e){ toast('Storage full â€” file preview unavailable.'); } }
function loadFileData(hid){ try{ const s=localStorage.getItem('nv_file_'+hid); return s?JSON.parse(s):null; }catch(e){ return null; } }

// ============================================================
// ROLE UI
// ============================================================
function setupRoleUI(){
  const displayName = currentUser.name || currentUser.username || 'User';
  document.getElementById('sidebarNm').textContent=displayName;
  document.getElementById('sidebarRl').textContent=currentRole;
  document.getElementById('sidebarAv').textContent=displayName[0].toUpperCase();
  const isT=currentRole==='teacher'||currentRole==='admin';
  const isA=currentRole==='admin';
  document.querySelectorAll('.teacher-el').forEach(el=>el.style.display=isT?'':'none');
  document.querySelectorAll('.admin-el').forEach(el=>el.style.display=isA?'':'none');
  updateSidebarAvatar();
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar(){
  document.getElementById('sidebarClasses').innerHTML=db.classes.map(cl=>{
    const c=colorMap[cl.color];
    return `<div class="class-chip" id="chip-${cl.id}" onclick="goToClass('${cl.id}')">
      <div class="class-dot" style="background:${c.color}"></div>${cl.name}
    </div>`;
  }).join('');
}

// ============================================================
// NAV
// ============================================================
function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  document.getElementById(id).style.display='';
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.class-chip').forEach(c=>c.classList.remove('active'));
  if(id!=='viewMessages' && typeof stopMsgPoll==='function') stopMsgPoll();
  closeSidebar();
  // Init PeerJS after login
  if(id!=='authPage' && myId && myId() && typeof initCallPeer==='function'){
    if(!window._peer || window._peer.destroyed) initCallPeer();
  }
}
function navGo(name){
  if(name==='dashboard'){showView('viewDashboard');renderDashboard();document.querySelector('.nav-item').classList.add('active');}
  else if(name==='allhandouts'){showView('viewAllHandouts');renderAllHandouts(db.handouts);}
  else if(name==='results'){showView('viewResults');renderResultsView();}
  else if(name==='pastquestions'){showView('viewPastQuestions');renderPQBanks();}
  else if(name==='users'){showView('viewUsers');renderUsers();}
  else if(name==='messages'){showView('viewMessages');renderMessaging();}
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(){
  if(!db.results) db.results=[];
  const totalH=db.handouts.length, totalC=db.courses.length, totalCls=db.classes.length, totalU=db.users.length+1;
  const totalR=db.results.length;
  document.getElementById('statsStrip').innerHTML=`
    <div class="stat-box"><div class="stat-lbl">Classes</div><div class="stat-val" style="color:var(--accent)">${totalCls}</div><div class="stat-s">Active programs</div></div>
    <div class="stat-box"><div class="stat-lbl">Courses</div><div class="stat-val" style="color:var(--accent2)">${totalC}</div><div class="stat-s">Across all classes</div></div>
    <div class="stat-box"><div class="stat-lbl">Handouts</div><div class="stat-val" style="color:var(--accent3)">${totalH}</div><div class="stat-s">Total uploaded</div></div>
    <div class="stat-box"><div class="stat-lbl">Results</div><div class="stat-val" style="color:#fbbf24">${totalR}</div><div class="stat-s">Test &amp; exam scores</div></div>
    <div class="stat-box"><div class="stat-lbl">Users</div><div class="stat-val" style="color:var(--accent4)">${totalU}</div><div class="stat-s">Registered accounts</div></div>
  `;
  const grid=document.getElementById('classesGrid');
  grid.innerHTML=db.classes.map((cl,i)=>{
    const c=colorMap[cl.color];
    const courses=db.courses.filter(co=>co.classId===cl.id);
    const handouts=db.handouts.filter(h=>courses.some(co=>co.id===h.courseId));
    return `<div class="class-card" style="--class-color:${c.color};animation-delay:${i*.07}s" onclick="goToClass('${cl.id}')">
      <div class="class-card-top">
        <span class="class-badge" style="background:${c.bg};color:${c.color}">${cl.name}</span>
        <span class="class-count">${courses.length} courses</span>
      </div>
      <div class="class-name">${cl.name}</div>
      <div class="class-fullname">${cl.full}</div>
      <div class="class-stats">
        <div class="class-stat"><strong>${courses.length}</strong> Courses</div>
        <div class="class-stat"><strong>${handouts.length}</strong> Handouts</div>
      </div>
    </div>`;
  }).join('')+(currentRole==='admin'?`
    <div class="add-class-card" style="animation-delay:${db.classes.length*.07}s" onclick="openModal('addClassModal')">
      <div class="plus">ï¼‹</div><span>Add New Class</span>
    </div>`:'');

  const h=new Date().getHours();
  const greet=h<12?'Good morning':h<18?'Good afternoon':'Good evening';
  const firstName = (currentUser.name||currentUser.username||'there').split(' ')[0];
  document.getElementById('dashTitle').textContent=`${greet}, ${firstName} ðŸ‘‹`;
}

// ============================================================
// CLASS VIEW
// ============================================================
function goToClass(classId){
  currentClassId=classId;
  const cl=db.classes.find(c=>c.id===classId);
  const c=colorMap[cl.color];
  showView('viewClass');
  document.querySelectorAll('.class-chip').forEach(ch=>ch.classList.remove('active'));
  const chip=document.getElementById('chip-'+classId);
  if(chip){chip.classList.add('active');chip.style.color=c.color;chip.style.background=c.bg;}
  document.getElementById('classViewTitle').textContent=cl.name;
  document.getElementById('classBc').innerHTML=`
    <span class="bc-item" onclick="navGo('dashboard')">Dashboard</span>
    <span class="bc-sep">â€º</span><span class="bc-current">${cl.name}</span>`;
  document.getElementById('classCoursesTitle').textContent=`${cl.name} â€” Courses`;
  document.getElementById('classCourseSub').textContent=cl.full;
  renderCourses(classId);
}

function renderCourses(classId,filter=''){
  const courses=db.courses.filter(c=>c.classId===classId&&(!filter||c.title.toLowerCase().includes(filter)||c.code.toLowerCase().includes(filter)));
  const cl=db.classes.find(c=>c.id===classId);
  const color=colorMap[cl.color].color, bg=colorMap[cl.color].bg;
  const list=document.getElementById('coursesList');
  let html=courses.map((co,i)=>{
    const hCount=db.handouts.filter(h=>h.courseId===co.id).length;
    return `<div class="course-row" style="animation-delay:${i*.05}s" onclick="goToCourse('${co.id}')">
      <div class="course-icon" style="background:${bg};color:${color}">ðŸ“š</div>
      <div class="course-info">
        <div class="course-title">${co.title}</div>
        <div class="course-code">${co.code} Â· ${co.lecturer}</div>
      </div>
      <div class="course-meta"><strong>${hCount}</strong> handout${hCount!==1?'s':''}</div>
    </div>`;
  }).join('');
  if(!courses.length) html=`<div class="empty"><div class="empty-ico">ðŸ“­</div><div class="empty-t">No courses yet</div><div class="empty-s">Add the first course for this class</div></div>`;
  if(currentRole==='teacher'||currentRole==='admin') html+=`<div class="add-course-btn" onclick="openAddCourseModal()"><span>ï¼‹</span> Add New Course</div>`;
  list.innerHTML=html;
}

// ============================================================
// COURSE VIEW
// ============================================================
function goToCourse(courseId){
  currentCourseId=courseId;
  const co=db.courses.find(c=>c.id===courseId);
  const cl=db.classes.find(c=>c.id===co.classId);
  showView('viewCourse');
  document.getElementById('courseViewTitle').textContent=co.code;
  document.getElementById('courseBc').innerHTML=`
    <span class="bc-item" onclick="navGo('dashboard')">Dashboard</span>
    <span class="bc-sep">â€º</span>
    <span class="bc-item" onclick="goToClass('${cl.id}')">${cl.name}</span>
    <span class="bc-sep">â€º</span><span class="bc-current">${co.title}</span>`;
  document.getElementById('courseHandoutsTitle').textContent=co.title;
  document.getElementById('courseHandoutSub').textContent=`${co.code} Â· ${co.lecturer}`;
  renderHandouts(courseId);
}

function renderHandouts(courseId,filter=''){
  const handouts=db.handouts.filter(h=>h.courseId===courseId&&(!filter||h.title.toLowerCase().includes(filter)));
  const list=document.getElementById('handoutsList');
  let html=handouts.map((h,i)=>`
    <div class="handout-row" style="animation-delay:${i*.05}s" onclick="openPreview('${h.id}')">
      <div class="file-badge fb-${h.type}">${h.type.toUpperCase()}</div>
      <div style="width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;background:${fileBg[h.type]};flex-shrink:0">${fileIco[h.type]}</div>
      <div class="handout-info">
        <div class="handout-title">${h.title}</div>
        <div class="handout-teacher">${h.lecturer}</div>
      </div>
      <div class="handout-date">${h.date}</div>
      <div class="handout-actions">
        <div class="icon-btn" title="Preview" onclick="event.stopPropagation();openPreview('${h.id}')">ðŸ‘</div>
        ${currentRole==='teacher'||currentRole==='admin'?`<div class="icon-btn" title="Delete" onclick="event.stopPropagation();deleteHandout('${h.id}')">ðŸ—‘</div>`:''}
      </div>
    </div>`).join('');
  if(!handouts.length) html=`<div class="empty"><div class="empty-ico">ðŸ“‚</div><div class="empty-t">No handouts yet</div><div class="empty-s">Upload the first handout for this course</div></div>`;
  if(currentRole==='teacher'||currentRole==='admin') html+=`<div class="add-handout-btn" onclick="openAddHandoutModal()"><span>ðŸ“Ž</span> Add New Handout</div>`;
  list.innerHTML=html;
}

// ============================================================
// ALL HANDOUTS
// ============================================================
function renderAllHandouts(handouts){
  const list=document.getElementById('allHandoutsList');
  let html=handouts.map((h,i)=>{
    const co=db.courses.find(c=>c.id===h.courseId)||{title:'Unknown',classId:''};
    const cl=db.classes.find(c=>c.id===co.classId)||{name:'',color:'blue'};
    const cc=colorMap[cl.color]||colorMap.blue;
    return `<div class="handout-row" style="animation-delay:${i*.03}s" onclick="openPreview('${h.id}')">
      <div class="file-badge fb-${h.type}">${h.type.toUpperCase()}</div>
      <div style="width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;background:${fileBg[h.type]};flex-shrink:0">${fileIco[h.type]}</div>
      <div class="handout-info">
        <div class="handout-title">${h.title}</div>
        <div class="handout-teacher">${co.title} Â· <span style="color:${cc.color}">${cl.name}</span></div>
      </div>
      <div class="handout-date">${h.date}</div>
      <div class="handout-actions"><div class="icon-btn" onclick="event.stopPropagation();openPreview('${h.id}')">ðŸ‘</div></div>
    </div>`;
  }).join('');
  if(!handouts.length) html=`<div class="empty"><div class="empty-ico">ðŸ“­</div><div class="empty-t">No handouts found</div><div class="empty-s">Handouts will appear here once uploaded</div></div>`;
  list.innerHTML=html;
}

// ============================================================
// USERS (admin)
// ============================================================
// â”€â”€ Avatar helpers â”€â”€
function avatarHtml(user, size=56){
  if(!user) return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:${Math.round(size*.4)}px;font-weight:700;color:white;">?</div>`;
  if(user.avatar){
    return `<img src="${user.avatar}" style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover;border:2px solid var(--border);" onerror="this.style.display='none'">`;
  }
  const initials = (user.name||user.username||'?')[0].toUpperCase();
  const roleGrad = user.role==='admin'?'#fbbf24,#f59e0b':user.role==='teacher'?'var(--accent),var(--accent2)':'var(--accent3),#059669';
  return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:linear-gradient(135deg,${roleGrad});display:flex;align-items:center;justify-content:center;font-size:${Math.round(size*.38)}px;font-weight:700;color:white;flex-shrink:0;">${initials}</div>`;
}

function updateSidebarAvatar(){
  const av = document.getElementById('sidebarAv');
  if(!av) return;
  if(currentUser.avatar){
    av.innerHTML=`<img src="${currentUser.avatar}" class="user-av-img" onerror="this.parentElement.textContent='${(currentUser.name||'?')[0].toUpperCase()}'">`;
  } else {
    av.innerHTML=(currentUser.name||currentUser.username||'?')[0].toUpperCase();
  }
}

function renderUsers(){
  const search=(document.getElementById('userSearch')?.value||'').toLowerCase();
  const roleFilter=(document.getElementById('userRoleFilter')?.value||'');
  const classFilter=(document.getElementById('userClassFilter')?.value||'');

  // Populate class filter dropdown (once)
  const clSel=document.getElementById('userClassFilter');
  if(clSel && clSel.options.length<=1){
    (db.classes||[]).forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c.id; opt.textContent=c.name;
      clSel.appendChild(opt);
    });
    if(classFilter) clSel.value=classFilter;
  }

  const adminUser={id:'admin',name:ADMIN_NAME,username:ADMIN_USERNAME,role:'admin',cls:'All',isAdmin:true,
    avatar: db.adminAvatar||null, phone: db.adminPhone||'', matric:''};
  let all=[adminUser,...(db.users||[])];

  // Apply filters
  if(roleFilter) all=all.filter(u=>u.role===roleFilter);
  if(classFilter) all=all.filter(u=>u.classId===classFilter||u.id==='admin');
  if(search) all=all.filter(u=>
    (u.name||'').toLowerCase().includes(search)||
    (u.username||'').toLowerCase().includes(search)||
    (u.matric||'').toLowerCase().includes(search)||
    (u.role||'').toLowerCase().includes(search)
  );

  // Update count badge
  const badge=document.getElementById('userCountBadge');
  if(badge) badge.textContent=`(${all.length} shown Â· ${(db.users||[]).length+1} total)`;

  const roleColor={admin:'#fbbf24',teacher:'var(--accent)',student:'var(--accent3)'};
  const roleBg={admin:'rgba(251,191,36,.12)',teacher:'rgba(56,189,248,.12)',student:'rgba(52,211,153,.12)'};

  const grid = document.getElementById('usersGrid');
  if(!grid) return;
  if(!all.length){
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text3);font-family:'DM Mono',monospace;font-size:13px;">No users match your filters.</div>`;
    return;
  }
  grid.innerHTML = all.map((u,i)=>{
    const cl = (db.classes||[]).find(c=>c.id===u.classId);
    return `<div class="user-card role-${u.role}" style="animation-delay:${Math.min(i,20)*.03}s">
      <div class="user-card-head">
        <div class="user-card-avatar">${avatarHtml(u,56)}</div>
        <div class="user-card-info">
          <div class="user-card-name">${escHtml(u.name||u.username)}${u.isAdmin?'<span class="admin-crown">ðŸ‘‘</span>':''}</div>
          <div class="user-card-role" style="color:${roleColor[u.role]||'var(--text2)'}">
            <span style="background:${roleBg[u.role]};padding:2px 8px;border-radius:5px;">${u.role}</span>
          </div>
        </div>
      </div>
      <div class="user-card-meta">
        <div class="user-card-field">
          <div class="user-card-field-lbl">Username</div>
          <div class="user-card-field-val">${escHtml(u.username||'â€”')}</div>
        </div>
        <div class="user-card-field">
          <div class="user-card-field-lbl">Class</div>
          <div class="user-card-field-val">${cl?escHtml(cl.name):u.cls||'â€”'}</div>
        </div>
        <div class="user-card-field">
          <div class="user-card-field-lbl">Matric No.</div>
          <div class="user-card-field-val" style="font-size:10px;">${escHtml(u.matric||'â€”')}</div>
        </div>
        <div class="user-card-field">
          <div class="user-card-field-lbl">Password</div>
          <div class="user-card-field-val" style="letter-spacing:.05em;display:flex;align-items:center;gap:6px;">
            ${u.isAdmin
              ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'
              : `<span class="pwd-mask" id="pwd-${u.id}">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                 <button type="button" title="Show/hide password"
                   style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:13px;padding:0;line-height:1;flex-shrink:0;"
                   onclick="(function(btn){
                     var s=document.getElementById('pwd-${u.id}');
                     if(s.dataset.vis==='1'){s.textContent='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';s.dataset.vis='0';btn.textContent='ðŸ‘';}
                     else{s.textContent='${escHtml(u.password||'')}';s.dataset.vis='1';btn.textContent='ðŸ™ˆ';}
                   })(this)">ðŸ‘</button>`
            }
          </div>
        </div>
        ${u.role==='student'&&(u.svc||u.bia||u.rrr)?`
        <div class="user-card-field" style="grid-column:1/-1;border-top:1px solid var(--border);padding-top:8px;margin-top:4px;">
          <div class="user-card-field-lbl">SVC / BIA / RRR</div>
          <div class="user-card-field-val" style="font-size:10px;font-family:'DM Mono',monospace;">${[u.svc,u.bia,u.rrr].filter(Boolean).join(' Â· ')}</div>
        </div>`:''}
      </div>
      <div class="user-card-actions">
        <button class="btn-action" onclick="openEditUser('${u.id}')" style="flex:1;padding:8px;font-size:11px;">âœï¸ Edit</button>
        ${!u.isAdmin?`<button class="icon-btn" title="Remove" onclick="confirmDeleteUser('${u.id}')" style="color:var(--accent4);">ðŸ—‘</button>`:''}
      </div>
    </div>`;
  }).join('');
}

function toggleAllPasswords(){
  const btn=document.getElementById('revealAllPwdBtn');
  const spans=document.querySelectorAll('.pwd-mask');
  const allRevealed=[...spans].every(s=>s.dataset.vis==='1');
  spans.forEach(s=>{
    const uid=s.id.replace('pwd-','');
    const u=db.users.find(x=>x.id===uid);
    if(!u) return;
    if(allRevealed){s.textContent='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';s.dataset.vis='0';}
    else{s.textContent=u.password||'';s.dataset.vis='1';}
  });
  // update individual eye buttons
  document.querySelectorAll('.pwd-mask').forEach(s=>{
    const sib=s.nextElementSibling;
    if(sib) sib.textContent=s.dataset.vis==='1'?'ðŸ™ˆ':'ðŸ‘';
  });
  btn.textContent=allRevealed?'ðŸ‘ Reveal All Passwords':'ðŸ™ˆ Hide All Passwords';
}

function confirmDeleteUser(id){
  if(!id) return;
  if(!confirm('Remove this user account? This cannot be undone.')) return;
  db.users=db.users.filter(u=>u.id!==id);
  saveDB(); renderUsers(); closeModal('editUserModal'); toast('User removed');
}

// â”€â”€ OPEN EDIT USER (admin) â”€â”€
function openEditUser(uid){
  let u;
  if(uid==='admin'){
    u={id:'admin',name:ADMIN_NAME,username:ADMIN_USERNAME,role:'admin',cls:'All',isAdmin:true,
       avatar:db.adminAvatar||null,phone:db.adminPhone||'',matric:''};
  } else {
    u=db.users.find(x=>x.id===uid);
  }
  if(!u){toast('User not found');return;}
  document.getElementById('editUserId').value=uid;
  document.getElementById('editUserName').value=u.name||'';
  document.getElementById('editUserPhone').value=u.phone||'';
  document.getElementById('editUserMatric').value=u.matric||'';
  document.getElementById('editUserUsername').value=u.username||'';
  document.getElementById('editUserPass').value='';
  // New fields
  document.getElementById('editUserDob').value=u.dob||'';
  document.getElementById('editUserSex').value=u.sex||'';
  document.getElementById('editUserSvc').value=u.svc||'';
  document.getElementById('editUserRank').value=u.rank||'';
  document.getElementById('editUserBia').value=u.bia||'';
  document.getElementById('editUserRrr').value=u.rrr||'';
  document.getElementById('editUserRnIndex').value=u.rnIndex||'';
  document.getElementById('editUserRmIndex').value=u.rmIndex||'';
  // Class select
  const clSel=document.getElementById('editUserClass');
  clSel.innerHTML='<option value="">â€” None â€”</option>'+db.classes.map(c=>`<option value="${c.id}"${c.id===u.classId?' selected':''}>${c.name}</option>`).join('');
  // Show/hide matric field
  document.getElementById('editMatricWrap').style.display=u.role==='student'?'':'none';
  // Avatar
  const av=document.getElementById('editUserAv');
  if(u.avatar) av.innerHTML=`<img src="${u.avatar}" class="user-av-img">`;
  else av.innerHTML=(u.name||u.username||'?')[0].toUpperCase();
  av.dataset.avatar=u.avatar||'';
  openModal('editUserModal');
}

function saveEditUser(){
  const uid=document.getElementById('editUserId').value;
  const name=document.getElementById('editUserName').value.trim();
  const phone=document.getElementById('editUserPhone').value.trim();
  const matric=document.getElementById('editUserMatric').value.trim().toUpperCase();
  const username=document.getElementById('editUserUsername').value.trim().toLowerCase();
  const pass=document.getElementById('editUserPass').value.trim();
  const classId=document.getElementById('editUserClass').value;
  const avatar=document.getElementById('editUserAv').dataset.avatar||'';

  if(!name) return toast('Name is required');

  if(uid==='admin'){
    // Update admin info in db
    db.adminPhone=phone;
    db.adminAvatar=avatar;
    // Update currentUser if this is the admin
    if(currentRole==='admin'){
      currentUser.phone=phone;
      currentUser.avatar=avatar;
      currentUser.name=name;
      document.getElementById('sidebarNm').textContent=name;
      updateSidebarAvatar();
    }
  } else {
    const u=db.users.find(x=>x.id===uid);
    if(!u){toast('User not found');return;}
    // Check username uniqueness
    if(username!==u.username&&db.users.find(x=>x.id!==uid&&(x.username||'').toLowerCase()===username)){
      return toast('Username already taken by another user');
    }
    u.name=name;
    u.phone=phone;
    u.matric=matric;
    u.username=username||u.username;
    if(pass) u.password=pass;
    u.classId=classId||u.classId;
    u.avatar=avatar;
    // Save new fields
    u.dob     = document.getElementById('editUserDob').value.trim();
    u.sex     = document.getElementById('editUserSex').value;
    u.svc     = document.getElementById('editUserSvc').value.trim().toUpperCase();
    u.rank    = document.getElementById('editUserRank').value.trim().toUpperCase();
    u.bia     = document.getElementById('editUserBia').value.trim().toUpperCase();
    u.rrr     = document.getElementById('editUserRrr').value.trim();
    u.rnIndex = document.getElementById('editUserRnIndex').value.trim();
    u.rmIndex = document.getElementById('editUserRmIndex').value.trim();
    const cl=db.classes.find(c=>c.id===u.classId);
    u.cls=cl?cl.name:'â€”';
    // If editing self
    if(uid===currentUser.id){
      currentUser.name=name;currentUser.phone=phone;
      currentUser.matric=matric;currentUser.avatar=avatar;
      document.getElementById('sidebarNm').textContent=name;
      updateSidebarAvatar();
    }
  }
  saveDB();
  renderUsers();
  closeModal('editUserModal');
  toast('Profile updated âœ“');
}

// â”€â”€ AVATAR UPLOAD â”€â”€
function handleAvatarUpload(inp, target){
  const file=inp.files[0];
  if(!file) return;
  if(file.size>2*1024*1024){toast('Image must be under 2MB');return;}
  const reader=new FileReader();
  reader.onload=e=>{
    const dataUrl=e.target.result;
    if(target==='me'){
      document.getElementById('myProfileAv').innerHTML=`<img src="${dataUrl}" class="user-av-img">`;
      document.getElementById('myProfileAv').dataset.avatar=dataUrl;
    } else {
      document.getElementById('editUserAv').innerHTML=`<img src="${dataUrl}" class="user-av-img">`;
      document.getElementById('editUserAv').dataset.avatar=dataUrl;
    }
  };
  reader.readAsDataURL(file);
}

// â”€â”€ MY PROFILE â”€â”€
function openMyProfile(){
  const u=currentUser;
  // Avatar
  const av=document.getElementById('myProfileAv');
  if(u.avatar) av.innerHTML=`<img src="${u.avatar}" class="user-av-img">`;
  else av.innerHTML=(u.name||u.username||'?')[0].toUpperCase();
  av.dataset.avatar=u.avatar||'';
  // Fields
  document.getElementById('myProfileName').value=u.name||'';
  document.getElementById('myProfilePhone').value=u.phone||'';
  document.getElementById('myProfileMatric').value=u.matric||'';
  document.getElementById('myProfileUsername').value=u.username||'';
  document.getElementById('myProfileNewPass').value='';
  document.getElementById('myProfileConfPass').value='';
  // Role badge
  const roleColor={admin:'#fbbf24',teacher:'var(--accent)',student:'var(--accent3)'};
  document.getElementById('myProfileRoleBadge').innerHTML=`<span class="role-badge-lg" style="background:${currentRole==='admin'?'rgba(251,191,36,.15)':currentRole==='teacher'?'rgba(56,189,248,.15)':'rgba(52,211,153,.15)'};color:${roleColor[currentRole]||'var(--text2)'}">${currentRole}</span>`;
  // Show matric only for students
  document.getElementById('myMatricWrap').style.display=currentRole==='student'?'':'none';
  // Professional IDs (show for students only)
  const showProfIds = currentRole==='student';
  document.getElementById('myProfIdSection').style.display=showProfIds?'':'none';
  document.getElementById('myProfIdFields').style.display=showProfIds?'':'none';
  document.getElementById('myDocVaultSection').style.display='';
  if(showProfIds){
    document.getElementById('myProfileBIA').value=u.bia||'';
    document.getElementById('myProfileRNIndex').value=u.rnIndex||'';
    document.getElementById('myProfileRMIndex').value=u.rmIndex||'';
    document.getElementById('myProfileRNExam').value=u.rnExam||'';
    document.getElementById('myProfileRMExam').value=u.rmExam||'';
  }
  // Document vault
  renderMyDocVault();
  openModal('myProfileModal');
}

function saveMyProfile(){
  const name=document.getElementById('myProfileName').value.trim();
  const phone=document.getElementById('myProfilePhone').value.trim();
  const matric=document.getElementById('myProfileMatric').value.trim().toUpperCase();
  const newPass=document.getElementById('myProfileNewPass').value;
  const confPass=document.getElementById('myProfileConfPass').value;
  const avatar=document.getElementById('myProfileAv').dataset.avatar||'';

  if(!name) return toast('Name cannot be empty');
  if(newPass&&newPass!==confPass) return toast('Passwords do not match');
  if(newPass&&newPass.length<4) return toast('Password must be at least 4 characters');

  if(currentRole==='admin'){
    db.adminPhone=phone;
    db.adminAvatar=avatar;
    currentUser.phone=phone;
    currentUser.avatar=avatar;
    currentUser.name=name;
  } else {
    const u=db.users.find(x=>x.id===currentUser.id);
    if(u){
      u.name=name; u.phone=phone; u.matric=matric; u.avatar=avatar;
      if(newPass) u.password=newPass;
      // Professional IDs (students)
      if(currentRole==='student'){
        u.bia=document.getElementById('myProfileBIA').value.trim().toUpperCase();
        u.rnIndex=document.getElementById('myProfileRNIndex').value.trim().toUpperCase();
        u.rmIndex=document.getElementById('myProfileRMIndex').value.trim().toUpperCase();
        u.rnExam=document.getElementById('myProfileRNExam').value.trim().toUpperCase();
        u.rmExam=document.getElementById('myProfileRMExam').value.trim().toUpperCase();
        currentUser.bia=u.bia; currentUser.rnIndex=u.rnIndex;
        currentUser.rmIndex=u.rmIndex; currentUser.rnExam=u.rnExam; currentUser.rmExam=u.rmExam;
      }
      currentUser.name=name; currentUser.phone=phone;
      currentUser.matric=matric; currentUser.avatar=avatar;
    }
  }
  saveDB();
  document.getElementById('sidebarNm').textContent=name;
  updateSidebarAvatar();
  closeModal('myProfileModal');
  toast('Profile saved âœ“');
}

function removeUser(id){
  confirmDeleteUser(id);
}



// ============================================================
// RESULTS â€” upload & display test/exam scores
// ============================================================
function calcGrade(score){
  if(score>=70) return 'A';
  if(score>=60) return 'B';
  if(score>=50) return 'C';
  if(score>=45) return 'D';
  return 'F';
}
function gradeClass(g){
  if(g==='A') return 'score-a';
  if(g==='B') return 'score-b';
  if(g==='C'||g==='D') return 'score-c';
  return 'score-f';
}
function gradeColor(g){
  if(g==='A') return 'var(--accent3)';
  if(g==='B') return 'var(--accent)';
  if(g==='C'||g==='D') return '#fbbf24';
  return 'var(--accent4)';
}
function gradeBg(g){
  if(g==='A') return 'rgba(52,211,153,.15)';
  if(g==='B') return 'rgba(56,189,248,.15)';
  if(g==='C'||g==='D') return 'rgba(251,191,36,.15)';
  return 'rgba(251,113,133,.15)';
}

// â”€â”€ GPA / CGPA engine (Nigerian polytechnic 5-point scale) â”€â”€
// A=5, B=4, C=3, D=2, F=0
function gradeToPoint(g){
  if(g==='A') return 5;
  if(g==='B') return 4;
  if(g==='C') return 3;
  if(g==='D') return 2;
  return 0; // F
}

// Get the effective credit units for a course (fallback to 3 if not set)
function getCourseUnits(courseId){
  const co = (db.courses||[]).find(c=>c.id===courseId);
  return (co && co.creditUnits) ? co.creditUnits : 3;
}

// For a given list of result records, compute:
// { totalCreditUnits, totalQualityPoints, gpa }
// Only "exam" type results are used for GPA (one per course â€” highest if duplicates)
function computeGPA(results){
  if(!results || !results.length) return {totalCreditUnits:0, totalQualityPoints:0, gpa:0};

  // Prefer exam > test. If multiple exams per course, take highest score.
  const courseMap = {};
  results.forEach(r=>{
    const cid = r.courseId || '__none__';
    const g   = r.grade || calcGrade(r.score);
    const pts = gradeToPoint(g);
    const cu  = getCourseUnits(cid);
    if(!courseMap[cid]){
      courseMap[cid] = {grade:g, pts, cu, score:r.score, type:r.type};
    } else {
      // prefer exam over test; then higher score wins
      const prev = courseMap[cid];
      const currIsExam = r.type==='exam';
      const prevIsExam = prev.type==='exam';
      if((currIsExam && !prevIsExam) || (currIsExam===prevIsExam && r.score > prev.score)){
        courseMap[cid] = {grade:g, pts, cu, score:r.score, type:r.type};
      }
    }
  });

  let totalCU = 0, totalQP = 0;
  Object.values(courseMap).forEach(({pts,cu})=>{ totalCU+=cu; totalQP+=(pts*cu); });
  const gpa = totalCU > 0 ? totalQP/totalCU : 0;
  return {totalCreditUnits:totalCU, totalQualityPoints:totalQP, gpa};
}

// Compute GPA for a specific class/semester
function computeSemesterGPA(results, classId){
  return computeGPA(results.filter(r=>r.classId===classId));
}

// Compute CGPA across all classes
function computeCGPA(results){
  return computeGPA(results);
}

// Get all results for a specific student (by matric or studentId)
function getResultsForStudent(matric, studentId){
  if(!db.results) return [];
  return db.results.filter(r=>{
    if(studentId && r.studentId===studentId) return true;
    if(matric && r.matric && r.matric.trim().toUpperCase()===matric.trim().toUpperCase()) return true;
    return false;
  });
}

// Grade class for GPA display
function cgpaClass(cgpa){
  if(cgpa>=4.5) return 'Distinction';
  if(cgpa>=3.5) return 'Upper Credit';
  if(cgpa>=2.5) return 'Lower Credit';
  if(cgpa>=1.5) return 'Pass';
  return 'Fail';
}
function cgpaColor(cgpa){
  if(cgpa>=4.5) return 'var(--accent3)';
  if(cgpa>=3.5) return 'var(--accent)';
  if(cgpa>=2.5) return '#fbbf24';
  if(cgpa>=1.5) return 'var(--text2)';
  return 'var(--accent4)';
}

function renderResultsView(){
  if(!db.results) db.results = [];
  const isAdmin = currentRole==='admin';
  const isTeacher = currentRole==='teacher';
  // Only admin sees the full table; teachers and students see the student panel
  // (teachers in this system don't have their own results view â€” kept simple)
  document.getElementById('resultsTeacherPanel').style.display = isAdmin ? '' : 'none';
  document.getElementById('resultsStudentPanel').style.display = isAdmin ? 'none' : '';

  if(isAdmin){
    const cf = document.getElementById('resultFilterClass');
    cf.innerHTML = '<option value="">All Classes</option>' +
      db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    document.getElementById('resultFilterCourse').innerHTML = '<option value="">All Courses</option>' +
      db.courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
    document.getElementById('resultFilterType').value = '';
    const si = document.getElementById('resultFilterSearch');
    if(si) si.value = '';
    renderResultsTable();
  } else {
    // Populate course filter for student
    const myResults = getMyResults();
    const myCourseIds = [...new Set(myResults.map(r=>r.courseId).filter(Boolean))];
    const csel = document.getElementById('studentResultFilterCourse');
    csel.innerHTML = '<option value="">All Courses</option>' +
      myCourseIds.map(cid=>{
        const co = db.courses.find(c=>c.id===cid);
        return co ? `<option value="${cid}">${co.code} â€” ${co.title}</option>` : '';
      }).join('');
    renderStudentResults();
  }
}

function filterResultsByClass(){
  const classId = document.getElementById('resultFilterClass').value;
  const courses = classId ? db.courses.filter(c=>c.classId===classId) : db.courses;
  document.getElementById('resultFilterCourse').innerHTML =
    '<option value="">All Courses</option>' +
    courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
  renderResultsTable();
}

function renderResultsTable(){
  if(!db.results) db.results=[];
  const classId  = document.getElementById('resultFilterClass').value;
  const type     = document.getElementById('resultFilterType').value;
  const courseId = document.getElementById('resultFilterCourse').value;
  const search   = (document.getElementById('resultFilterSearch')?.value||'').toLowerCase().trim();

  let results = db.results.slice();
  if(classId)  results = results.filter(r=>r.classId===classId);
  if(type)     results = results.filter(r=>r.type===type);
  if(courseId) results = results.filter(r=>r.courseId===courseId);
  if(search)   results = results.filter(r=>
    (r.studentName||'').toLowerCase().includes(search) ||
    (r.matric||'').toLowerCase().includes(search) ||
    (r.title||'').toLowerCase().includes(search)
  );

  const tbody  = document.getElementById('resultsTableBody');
  const empty  = document.getElementById('resultsTableEmpty');

  if(!results.length){
    tbody.innerHTML='';
    empty.style.display='';
    return;
  }
  empty.style.display='none';

  tbody.innerHTML = results.map(r=>{
    const co = db.courses.find(c=>c.id===r.courseId)||{title:'â€”',code:'â€”'};
    const cl = db.classes.find(c=>c.id===r.classId)||{name:'â€”'};
    const g  = r.grade || calcGrade(r.score);
    const gp = gradeToPoint(g);
    const cu = co.creditUnits || 3;
    // Compute this student's CGPA across all their results
    const studentRes = (db.results||[]).filter(sr=>{
      if(r.studentId && sr.studentId===r.studentId) return true;
      if(r.matric && sr.matric && sr.matric.trim().toUpperCase()===r.matric.trim().toUpperCase()) return true;
      return false;
    });
    const cgpaData = computeCGPA(studentRes);
    const linkedBadge = r.studentId
      ? `<span style="color:var(--accent3);font-size:10px;font-family:'DM Mono',monospace;">âœ“ linked</span>`
      : `<span style="color:var(--accent4);font-size:10px;font-family:'DM Mono',monospace;">unlinked</span>`;
    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:11px;">
        <div>${r.matric||'â€”'}</div>
        <div style="margin-top:2px;">${linkedBadge}</div>
      </td>
      <td style="font-weight:500">${r.studentName}</td>
      <td><span class="result-type-badge rt-${r.type}">${r.type}</span></td>
      <td style="font-size:12px;">${r.title}</td>
      <td style="color:var(--text2);font-size:12px">${co.code}<br><span style="color:var(--text3);font-size:10px;">${co.title}</span></td>
      <td style="color:var(--text2);font-size:12px">${cl.name}</td>
      <td><span class="score-pill ${gradeClass(g)}">${r.score}${r.total&&r.total!==100?'/'+r.total:''}</span></td>
      <td><strong style="color:${gradeColor(g)};font-family:'Syne',sans-serif;font-size:16px;">${g}</strong></td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:${gradeColor(g)};white-space:nowrap;">
        ${gp}<span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;"> Ã—${cu}CU</span>
      </td>
      <td style="white-space:nowrap;">
        <strong style="color:${cgpaColor(cgpaData.gpa)};font-family:'Syne',sans-serif;font-size:14px;">${cgpaData.gpa.toFixed(2)}</strong>
        <div style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">${cgpaClass(cgpaData.gpa)}</div>
      </td>
      <td style="color:var(--text3);font-size:11px;font-family:'DM Mono',monospace">${r.date}</td>
      <td><button class="icon-btn" title="Delete" onclick="deleteResult('${r.id}')">ðŸ—‘</button></td>
    </tr>`;
  }).join('');
}

// â”€â”€ Helper: get results belonging to current student (by studentId OR matric) â”€â”€
function getMyResults(){
  if(!db.results) return [];
  return db.results.filter(r=>{
    // Primary match: linked studentId
    if(r.studentId && r.studentId === currentUser.id) return true;
    // Secondary match: matric number (case-insensitive)
    if(r.matric && currentUser.matric &&
       r.matric.trim().toUpperCase() === currentUser.matric.trim().toUpperCase()) return true;
    return false;
  });
}

function renderStudentResults(){
  if(!db.results) db.results=[];
  const typeFilter   = document.getElementById('studentResultFilterType').value;
  const courseFilter = document.getElementById('studentResultFilterCourse')?.value||'';

  const allMine = getMyResults();
  const myResults = allMine.filter(r=>
    (!typeFilter   || r.type===typeFilter) &&
    (!courseFilter || r.courseId===courseFilter)
  );

  // Summary strip â€” with CGP and CGPA
  const summaryEl = document.getElementById('studentResultsSummary');
  if(allMine.length>0 && summaryEl){
    const avg  = allMine.reduce((s,r)=>s+r.score,0)/allMine.length;
    const best = Math.max(...allMine.map(r=>r.score));
    const cgpaData = computeCGPA(allMine);
    const cgpa     = cgpaData.gpa;
    const cgp      = cgpaData.totalQualityPoints;
    const totalCU  = cgpaData.totalCreditUnits;
    const classify = cgpaClass(cgpa);
    const cColor   = cgpaColor(cgpa);

    // Per-semester GPA breakdown
    const classes = [...new Set(allMine.map(r=>r.classId).filter(Boolean))];
    const semRows = classes.map(cid=>{
      const cl    = (db.classes||[]).find(c=>c.id===cid)||{name:cid};
      const sData = computeSemesterGPA(allMine, cid);
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg3);border-radius:7px;font-size:12px;">
        <span style="color:var(--text2);font-family:'DM Mono',monospace;">${cl.name}</span>
        <span style="font-weight:700;color:${cgpaColor(sData.gpa)};font-family:'Syne',sans-serif;">${sData.gpa.toFixed(2)} <span style="font-size:10px;color:var(--text3);">GPA</span></span>
      </div>`;
    }).join('');

    summaryEl.style.display='';
    summaryEl.innerHTML=`
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:14px;">
        <div class="stat-box">
          <div class="stat-lbl">CGPA</div>
          <div class="stat-val" style="color:${cColor};font-size:26px;font-family:'Syne',sans-serif;font-weight:800;">${cgpa.toFixed(2)}</div>
          <div style="font-size:10px;font-family:'DM Mono',monospace;color:${cColor};margin-top:2px;">${classify}</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Total CGP</div>
          <div class="stat-val" style="color:var(--accent2);font-size:22px;">${cgp.toFixed(1)}</div>
          <div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);margin-top:2px;">${totalCU} credit units</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Avg Score</div>
          <div class="stat-val" style="color:${gradeColor(calcGrade(avg))};font-size:20px;">${avg.toFixed(1)}%</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Best Score</div>
          <div class="stat-val" style="color:var(--accent3);font-size:20px;">${best}%</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Matric No.</div>
          <div class="stat-val" style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text2);">${currentUser.matric||'â€”'}</div>
        </div>
      </div>
      ${semRows ? `<div style="margin-bottom:4px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px;">Semester GPA Breakdown</div>
      <div style="display:flex;flex-direction:column;gap:6px;">${semRows}</div>` : ''}`;
  } else if(summaryEl){
    summaryEl.style.display='none';
  }

  const list = document.getElementById('studentResultsList');
  if(!myResults.length){
    list.innerHTML = `<div class="results-empty">
      <div class="results-empty-ico">ðŸ“‹</div>
      <div class="results-empty-t">${allMine.length?'No results for this filter':'No results yet'}</div>
      <div class="results-empty-s">${allMine.length?'Try changing the filter above':'Your results will appear here once uploaded. Make sure your matric number is set in your profile.'}</div>
      ${!currentUser.matric?`<div style="margin-top:12px;padding:10px 14px;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:8px;font-size:12px;color:#fbbf24;font-family:'DM Mono',monospace;">âš  You have no matric number saved. Ask admin to update your profile.</div>`:''}
    </div>`;
    return;
  }

  list.innerHTML = myResults.map((r,i)=>{
    const co  = db.courses.find(c=>c.id===r.courseId)||{title:'â€”',code:'â€”',creditUnits:3};
    const cl  = db.classes.find(c=>c.id===r.classId)||{name:''};
    const g   = r.grade || calcGrade(r.score);
    const pct = r.score;
    const cu  = co.creditUnits || 3;
    const gp  = gradeToPoint(g);
    const qp  = (gp * cu).toFixed(0);
    return `<div class="my-result-card" style="animation-delay:${i*.05}s">
      <div class="my-result-score" style="background:${gradeBg(g)};color:${gradeColor(g)};border:2px solid ${gradeColor(g)};">
        <div style="font-size:18px;font-weight:800;">${pct}%</div>
        <div style="font-size:12px;font-weight:700;">${g}</div>
      </div>
      <div class="my-result-info" style="flex:1;">
        <div class="my-result-title">${r.title}</div>
        <div class="my-result-meta">${co.code} â€” ${co.title}</div>
        <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:2px;">${cl.name?cl.name+' Â· ':''}${r.date}</div>
        ${r.remarks?`<div style="font-size:11px;color:var(--text2);margin-top:4px;font-style:italic;padding:4px 8px;background:var(--bg3);border-radius:5px;">"${r.remarks}"</div>`:''}
      </div>
      <div style="text-align:right;flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
        <span class="result-type-badge rt-${r.type}">${r.type}</span>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:4px 9px;text-align:center;">
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:${gradeColor(g)};">${gp} pts</div>
          <div style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">${cu} CU Â· QP: ${qp}</div>
        </div>
        ${r.total&&r.total!==100?`<div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">${r.score}/${r.total} marks</div>`:''}
      </div>
    </div>`;
  }).join('');
}

function openModal_addResult(){
  if(!db.results) db.results=[];
  // Populate class dropdown
  const clSel = document.getElementById('newResultClass');
  clSel.innerHTML = db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  filterResultModalCourses();
  filterResultModalStudents();
  // Reset inputs
  document.getElementById('newResultType').value='test';
  document.getElementById('newResultTitle').value='';
  document.getElementById('newResultScore').value='';
  document.getElementById('newResultTotal').value='100';
  document.getElementById('newResultRemarks').value='';
  openModal('addResultModal');
}

function filterResultModalCourses(){
  const classId = document.getElementById('newResultClass').value;
  document.getElementById('newResultCourse').innerHTML =
    db.courses.filter(c=>c.classId===classId)
      .map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function filterResultModalStudents(){
  const classId = document.getElementById('newResultClass').value;
  const students = db.users.filter(u=>u.role==='student' && u.classId===classId);
  const sel = document.getElementById('newResultStudent');
  if(!students.length){
    sel.innerHTML='<option value="">â€” No students in this class â€”</option>';
  } else {
    sel.innerHTML = students.map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
  }
}

function submitResult(){
  if(!db.results) db.results=[];
  const type       = document.getElementById('newResultType').value;
  const title      = document.getElementById('newResultTitle').value.trim();
  const classId    = document.getElementById('newResultClass').value;
  const courseId   = document.getElementById('newResultCourse').value;
  const studentId  = document.getElementById('newResultStudent').value;
  const scoreRaw   = document.getElementById('newResultScore').value;
  const totalRaw   = document.getElementById('newResultTotal').value;
  const remarks    = document.getElementById('newResultRemarks').value.trim();

  if(!title)         return toast('Please enter a title.');
  if(!courseId)      return toast('Please select a course.');
  if(!studentId)     return toast('Please select a student.');
  if(scoreRaw==='')  return toast('Please enter a score.');

  const score = parseFloat(scoreRaw);
  const total = totalRaw ? parseFloat(totalRaw) : 100;
  if(isNaN(score)||score<0||score>100) return toast('Score must be between 0 and 100.');

  const student = db.users.find(u=>u.id===studentId);
  if(!student) return toast('Student not found.');

  const now = new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date = months[now.getMonth()]+' '+now.getDate()+', '+now.getFullYear();

  const result = {
    id: 'r_'+Date.now(),
    type, title, classId, courseId,
    studentId, studentName: student.name,
    matric: student.matric||'',
    score, total, grade: calcGrade(score),
    date, uploadedBy: currentUser.name,
    remarks: remarks||''
  };

  db.results.push(result);
  saveDB();
  closeModal('addResultModal');
  renderResultsTable();
  toast(`Result saved for ${student.name} âœ“`);
}

function showCGPASummary(){
  if(!db.results || !db.results.length){
    alert('No results uploaded yet.'); return;
  }

  // Group all results by student (keyed by matric OR studentId)
  const studentMap = {};
  db.results.forEach(r=>{
    const key = r.matric ? r.matric.trim().toUpperCase() : (r.studentId || r.studentName);
    if(!studentMap[key]){
      studentMap[key] = {
        name: r.studentName,
        matric: r.matric || 'â€”',
        studentId: r.studentId,
        results: []
      };
    }
    studentMap[key].results.push(r);
  });

  const rows = Object.values(studentMap).map(st=>{
    const cgpaData = computeCGPA(st.results);
    const cgpa     = cgpaData.gpa;
    const cgp      = cgpaData.totalQualityPoints;
    const totalCU  = cgpaData.totalCreditUnits;
    const classify = cgpaClass(cgpa);
    const cColor   = cgpaColor(cgpa);

    // Per-semester GPAs
    const classesTaken = [...new Set(st.results.map(r=>r.classId).filter(Boolean))];
    const semCells = classesTaken.map(cid=>{
      const cl = (db.classes||[]).find(c=>c.id===cid)||{name:cid};
      const sd = computeSemesterGPA(st.results, cid);
      return `<div style="font-size:10px;color:var(--text2);font-family:'DM Mono',monospace;white-space:nowrap;">${cl.name}: <strong style="color:${cgpaColor(sd.gpa)};">${sd.gpa.toFixed(2)}</strong></div>`;
    }).join('');

    const linkedBadge = st.studentId
      ? `<span style="background:rgba(52,211,153,.15);color:var(--accent3);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;">linked</span>`
      : `<span style="background:rgba(251,113,133,.1);color:var(--accent4);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;">unlinked</span>`;

    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:11px;">${st.matric}<br>${linkedBadge}</td>
      <td style="font-weight:600;">${st.name}</td>
      <td style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:${cColor};">${cgpa.toFixed(2)}</td>
      <td style="font-size:11px;color:${cColor};font-family:'DM Mono',monospace;">${classify}</td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--accent2);">${cgp.toFixed(1)}</td>
      <td style="font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;">${totalCU} CU</td>
      <td>${semCells}</td>
    </tr>`;
  });

  // Sort by CGPA descending
  const studentArr = Object.values(studentMap).map(st=>({
    ...st, cgpaData: computeCGPA(st.results)
  })).sort((a,b)=>b.cgpaData.gpa - a.cgpaData.gpa);

  const sortedRows = studentArr.map((st,idx)=>{
    const cgpa     = st.cgpaData.gpa;
    const cgp      = st.cgpaData.totalQualityPoints;
    const totalCU  = st.cgpaData.totalCreditUnits;
    const classify = cgpaClass(cgpa);
    const cColor   = cgpaColor(cgpa);
    const classesTaken = [...new Set(st.results.map(r=>r.classId).filter(Boolean))];
    const semCells = classesTaken.map(cid=>{
      const cl = (db.classes||[]).find(c=>c.id===cid)||{name:cid};
      const sd = computeSemesterGPA(st.results, cid);
      return `<div style="font-size:10px;color:var(--text2);font-family:'DM Mono',monospace;">${cl.name}: <strong style="color:${cgpaColor(sd.gpa)};">${sd.gpa.toFixed(2)}</strong></div>`;
    }).join('');
    const linkedBadge = st.studentId
      ? `<span style="background:rgba(52,211,153,.15);color:var(--accent3);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;">linked</span>`
      : `<span style="background:rgba(251,113,133,.1);color:var(--accent4);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;">unlinked</span>`;
    const rankEmoji = idx===0?'ðŸ¥‡':idx===1?'ðŸ¥ˆ':idx===2?'ðŸ¥‰':'';
    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:var(--text3);">${rankEmoji} #${idx+1}</td>
      <td style="font-family:'DM Mono',monospace;font-size:11px;">${st.matric}<br>${linkedBadge}</td>
      <td style="font-weight:600;">${st.name}</td>
      <td style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:${cColor};">${cgpa.toFixed(2)}</td>
      <td style="font-size:11px;color:${cColor};font-family:'DM Mono',monospace;font-weight:700;">${classify}</td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--accent2);">${cgp.toFixed(1)}</td>
      <td style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">${totalCU} CU</td>
      <td>${semCells}</td>
    </tr>`;
  }).join('');

  document.getElementById('cgpaSummaryContent').innerHTML = `
    <div style="background:var(--bg3);border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:12px;color:var(--accent);font-family:'DM Mono',monospace;border:1px solid rgba(56,189,248,.15);">
      â„¹ï¸ CGPA uses the 5-point Nigerian polytechnic scale: A=5, B=4, C=3, D=2, F=0. Exam results take priority over tests per course. Sorted by highest CGPA.
    </div>
    <div class="results-table-wrap">
      <table class="results-table" style="font-size:13px;">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Matric</th>
            <th>Student Name</th>
            <th>CGPA</th>
            <th>Classification</th>
            <th>Total CGP</th>
            <th>Credit Units</th>
            <th>Sem. GPAs</th>
          </tr>
        </thead>
        <tbody>${sortedRows}</tbody>
      </table>
    </div>
  `;
  openModal('cgpaSummaryModal');
}

function deleteResult(id){
  if(!confirm('Delete this result?')) return;
  db.results = db.results.filter(r=>r.id!==id);
  saveDB();
  renderResultsTable();
  toast('Result deleted');
}

// ============================================================
// SPREADSHEET IMPORT â€” admin uploads .xlsx / .csv
// ============================================================
let _ssRows = []; // parsed & matched rows ready for import

function openSpreadsheetImport(){
  if(!db.results) db.results=[];
  // Populate dropdowns
  const clSel = document.getElementById('ssClass');
  clSel.innerHTML = db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  ssFilterCourses();
  document.getElementById('ssType').value='test';
  document.getElementById('ssTitle').value='';
  document.getElementById('ssFileInput').value='';
  document.getElementById('ssDropZone').classList.remove('has-file');
  document.getElementById('ssDropIco').textContent='ðŸ“Š';
  document.getElementById('ssDropTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
  document.getElementById('ssPreviewWrap').style.display='none';
  document.getElementById('ssStatus').style.display='none';
  _ssRows=[];
  openModal('ssImportModal');
}

function ssFilterCourses(){
  const classId = document.getElementById('ssClass').value;
  document.getElementById('ssCourse').innerHTML =
    db.courses.filter(c=>c.classId===classId)
      .map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function ssFileChosen(inp){
  const file = inp.files[0];
  if(!file) return;
  document.getElementById('ssDropIco').textContent='â³';
  document.getElementById('ssDropTxt').innerHTML=`Reading <strong>${file.name}</strong>â€¦`;
  document.getElementById('ssStatus').style.display='none';
  const ext = file.name.split('.').pop().toLowerCase();
  const reader = new FileReader();
  if(ext==='csv'){
    reader.onload = e => ssParseCSV(e.target.result, file.name);
    reader.readAsText(file);
  } else if(ext==='xlsx'||ext==='xls'){
    reader.onload = e => ssParseXLSX(e.target.result, file.name);
    reader.readAsArrayBuffer(file);
  } else {
    ssShowStatus('âš  Unsupported file. Use .xlsx, .xls, or .csv','error');
    document.getElementById('ssDropIco').textContent='âŒ';
    document.getElementById('ssDropTxt').innerHTML='Unsupported file type';
  }
}

function ssParseCSV(text, fname){
  // Parse CSV â€” handle quoted fields
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2){ ssShowStatus('âš  CSV has no data rows','error'); return; }
  const parse = line => {
    const cols=[]; let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){ inQ=!inQ; }
      else if(c===','&&!inQ){ cols.push(cur.trim()); cur=''; }
      else cur+=c;
    }
    cols.push(cur.trim());
    return cols;
  };
  const headers = parse(lines[0]).map(h=>h.toLowerCase().replace(/[^a-z0-9]/g,''));
  const rows = lines.slice(1).map(l=>{ const c=parse(l); return headers.reduce((o,h,i)=>{o[h]=c[i]||'';return o;},{}); });
  ssProcessRows(rows, fname);
}

function ssParseXLSX(buf, fname){
  try{
    // Use SheetJS if available
    if(typeof XLSX !== 'undefined'){
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const raw = XLSX.utils.sheet_to_json(ws, {defval:''});
      // normalise header keys
      const norm = raw.map(row=>{
        const o={};
        Object.entries(row).forEach(([k,v])=>{ o[k.toLowerCase().replace(/[^a-z0-9]/g,'')]=String(v).trim(); });
        return o;
      });
      ssProcessRows(norm, fname);
    } else {
      // Fallback: try to load SheetJS dynamically
      ssShowStatus('â³ Loading spreadsheet libraryâ€¦','info');
      const s=document.createElement('script');
      s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      s.onload=()=>ssParseXLSX(buf, fname);
      s.onerror=()=>ssShowStatus('âš  Could not load spreadsheet library. Try a .csv file instead.','error');
      document.head.appendChild(s);
    }
  } catch(e){
    ssShowStatus('âš  Error reading spreadsheet: '+e.message,'error');
  }
}

function ssProcessRows(rows, fname){
  if(!rows.length){ ssShowStatus('âš  No data rows found in file','error'); return; }

  // Detect columns â€” look for matric, name, score, total, remarks
  // Common column name variants
  const findCol = (row, variants) => {
    const keys = Object.keys(row);
    for(const v of variants){
      const k = keys.find(k=>k.includes(v));
      if(k) return k;
    }
    return null;
  };
  const sample = rows[0];
  const colMatric  = findCol(sample,['matric','reg','registration','student_id','studentid','id']);
  const colName    = findCol(sample,['name','student','fullname','studentname']);
  const colScore   = findCol(sample,['score','mark','marks','result','obtained','scored']);
  const colTotal   = findCol(sample,['total','outof','max','maximum','fullmark','fullmarks']);
  const colRemarks = findCol(sample,['remark','remarks','comment','note']);

  if(!colScore){ ssShowStatus('âš  Cannot find a score/marks column. Make sure your spreadsheet has a "Score" or "Marks" column.','error'); return; }

  _ssRows = rows.map((row,i)=>{
    const matric  = (colMatric  ? row[colMatric]  : '').trim().toUpperCase();
    const name    = (colName    ? row[colName]    : '').trim();
    const scoreRaw= colScore ? row[colScore] : '';
    const totalRaw= colTotal ? row[colTotal] : '';
    const remarks = colRemarks ? row[colRemarks] : '';

    if(!scoreRaw && scoreRaw!==0){ return {status:'skip', reason:'No score', matric, name, raw:row}; }
    const score = parseFloat(String(scoreRaw).replace(/[^0-9.]/g,''));
    const total = totalRaw ? parseFloat(String(totalRaw).replace(/[^0-9.]/g,'')) : 100;
    if(isNaN(score)){ return {status:'skip', reason:'Invalid score: '+scoreRaw, matric, name, raw:row}; }

    // Normalise to percentage
    let pct = score;
    if(total && total>0 && total!==100) pct = Math.round((score/total)*1000)/10;
    if(pct<0||pct>100){ return {status:'skip', reason:`Score ${pct}% out of range`, matric, name, raw:row}; }

    // Match student by matric, then by name
    const students = db.users.filter(u=>u.role==='student');
    let matched = null;
    if(matric) matched = students.find(u=>(u.matric||'').trim().toUpperCase()===matric);
    if(!matched && name){
      const nl=name.toLowerCase();
      matched = students.find(u=>u.name.toLowerCase()===nl)
             || students.find(u=>u.name.toLowerCase().includes(nl)||nl.includes(u.name.toLowerCase()));
    }

    const grade = calcGrade(pct);
    return {
      status: 'ok',
      matric: matched?(matched.matric||matric):matric,
      name:   matched?matched.name:name,
      score:  pct,
      rawScore: score,
      total:  total||100,
      grade,
      remarks: remarks||'',
      studentId: matched?matched.id:null,
      matched: !!matched,
      removed: false,
    };
  }).filter(r=>r!==null);

  const ok  = _ssRows.filter(r=>r.status==='ok').length;
  const skip= _ssRows.filter(r=>r.status==='skip').length;
  const linked = _ssRows.filter(r=>r.status==='ok'&&r.matched).length;

  document.getElementById('ssDropIco').textContent='âœ…';
  document.getElementById('ssDropTxt').innerHTML=`<strong>${fname}</strong> â€” ${rows.length} rows read`;
  document.getElementById('ssDropZone').classList.add('has-file');
  ssShowStatus(`âœ“ ${ok} valid rows Â· ${linked} matched to registered students Â· ${skip} skipped`,'ok');
  ssRenderPreview();
}

function ssRenderPreview(){
  const wrap = document.getElementById('ssPreviewWrap');
  const body = document.getElementById('ssPreviewBody');
  const count= document.getElementById('ssPreviewCount');
  const errs = document.getElementById('ssPreviewErrors');

  wrap.style.display='';
  const visible = _ssRows.filter(r=>!r.removed);
  const ok   = visible.filter(r=>r.status==='ok');
  const skip = visible.filter(r=>r.status==='skip');
  count.textContent=`${ok.length} valid Â· ${skip.length} skipped`;
  errs.textContent = skip.length?`${skip.length} row${skip.length>1?'s':''} skipped`:'';

  document.getElementById('ssImportBtn').disabled = ok.length===0;
  document.getElementById('ssImportBtnCount').textContent=ok.length;

  body.innerHTML = _ssRows.map((r,i)=>{
    if(r.removed) return '';
    const isOk = r.status==='ok';
    const gc = isOk?gradeColor(r.grade):'var(--accent4)';
    const matchBadge = isOk?(r.matched
      ?`<span style="color:var(--accent3);font-size:10px;">âœ“ matched</span>`
      :`<span style="color:#fbbf24;font-size:10px;">âš  unlinked</span>`)
      :`<span style="color:var(--accent4);font-size:10px;">${r.reason||'skip'}</span>`;
    return `<div class="parse-row ${isOk?'parse-ok':'parse-err'}" style="grid-template-columns:22px 110px 1fr 70px 60px 80px 24px;">
      <span class="parse-status">${isOk?'âœ…':'âŒ'}</span>
      <span class="parse-matric">${r.matric||'â€”'}</span>
      <span class="parse-name">${r.name||'â€”'}</span>
      <span class="parse-score" style="color:${gc}">${isOk?r.score+'%':'â€”'}</span>
      <span class="parse-grade" style="color:${gc};font-weight:700;">${isOk?r.grade:'â€”'}</span>
      <span>${matchBadge}</span>
      <button class="parse-del" onclick="ssRemoveRow(${i})" title="Remove">âœ•</button>
    </div>`;
  }).join('');
}

function ssRemoveRow(i){
  _ssRows[i].removed=true;
  ssRenderPreview();
}

function ssShowStatus(msg, type){
  const el=document.getElementById('ssStatus');
  el.style.display='block';
  el.style.color=type==='error'?'var(--accent4)':type==='ok'?'var(--accent3)':'var(--accent2)';
  el.textContent=msg;
}

function ssImportAll(){
  const type    = document.getElementById('ssType').value;
  const title   = document.getElementById('ssTitle').value.trim();
  const classId = document.getElementById('ssClass').value;
  const courseId= document.getElementById('ssCourse').value;

  if(!title)    return toast('Please enter a result title (e.g. "Mid-Term Test 2024")');
  if(!courseId) return toast('Please select a course.');

  const valid = _ssRows.filter(r=>!r.removed&&r.status==='ok');
  if(!valid.length) return toast('No valid rows to import.');

  const now=new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date=months[now.getMonth()]+' '+now.getDate()+', '+now.getFullYear();

  let imported=0;
  valid.forEach(r=>{
    db.results.push({
      id:          'r_'+Date.now()+'_'+imported,
      type, title, classId, courseId,
      studentId:   r.studentId||null,
      studentName: r.name||'Unknown',
      matric:      r.matric||'',
      score:       r.score,
      total:       r.total||100,
      grade:       r.grade,
      date,
      uploadedBy:  currentUser.name,
      remarks:     r.remarks||''
    });
    imported++;
  });

  saveDB();
  closeModal('ssImportModal');
  renderResultsView();
  toast(`âœ“ ${imported} result${imported!==1?'s':''} imported from spreadsheet`);
}

function exportResultsCSV(){
  if(!db.results||!db.results.length){ toast('No results to export'); return; }
  const classId  = document.getElementById('resultFilterClass').value;
  const type     = document.getElementById('resultFilterType').value;
  const courseId = document.getElementById('resultFilterCourse').value;
  let results = db.results.slice();
  if(classId)  results=results.filter(r=>r.classId===classId);
  if(type)     results=results.filter(r=>r.type===type);
  if(courseId) results=results.filter(r=>r.courseId===courseId);
  if(!results.length){ toast('No results match the current filter'); return; }

  const header = ['Matric No.','Student','Type','Title','Course','Class','Score (%)','Total','Grade','Date','Uploaded By','Remarks'];
  const rows = results.map(r=>{
    const co=db.courses.find(c=>c.id===r.courseId)||{title:'â€”',code:'â€”'};
    const cl=db.classes.find(c=>c.id===r.classId)||{name:'â€”'};
    return [r.matric||'â€”',r.studentName,r.type,r.title,`${co.code} â€” ${co.title}`,cl.name,r.score,r.total,r.grade,r.date,r.uploadedBy||'â€”',r.remarks||'â€”'];
  });
  const csv = [header,...rows].map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href=url; a.download='results_export.csv'; a.click();
  URL.revokeObjectURL(url);
  toast('CSV exported âœ“');
}

// ============================================================
// PASTE IMPORT â€” bulk result upload from pasted text
// ============================================================
let _piRows = [];  // parsed rows: {matric, name, score, total, grade, status, warn, removed}

function openPasteImport(){
  if(!db.results) db.results=[];
  // Populate dropdowns
  const clSel = document.getElementById('piClass');
  clSel.innerHTML = db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  piFilterCourses();
  // Reset
  document.getElementById('piType').value = 'test';
  document.getElementById('piTitle').value = '';
  document.getElementById('piPasteBox').value = '';
  document.getElementById('piPreviewWrap').style.display = 'none';
  _piRows = [];
  openModal('pasteImportModal');
}

function piFilterCourses(){
  const classId = document.getElementById('piClass').value;
  document.getElementById('piCourse').innerHTML =
    db.courses.filter(c=>c.classId===classId)
      .map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function piParseAndPreview(){
  const raw = document.getElementById('piPasteBox').value;
  if(!raw.trim()){ document.getElementById('piPreviewWrap').style.display='none'; _piRows=[]; return; }

  const lines = raw.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
  _piRows = lines.map((line, idx) => piParseLine(line, idx));

  piRenderPreview();
}

function piParseLine(line, idx){
  // Detect separator: tab > comma > multiple spaces
  let parts;
  if(line.includes('\t'))       parts = line.split('\t').map(s=>s.trim());
  else if(line.includes(','))   parts = line.split(',').map(s=>s.trim());
  else                          parts = line.split(/\s{2,}/).map(s=>s.trim());

  // Remove empty parts
  parts = parts.filter(p=>p.length>0);

  if(parts.length < 2){
    return {matric:'', name:line, score:null, total:100, grade:'', status:'err', warn:'Cannot parse â€” need at least name and score', raw:line, removed:false};
  }

  // Heuristic: detect matric number (contains / or - or digits only or starts with letter+digits pattern)
  let matric = '', name = '', score = null, total = 100;

  // Check if first column looks like a matric number
  const looksLikeMatric = p => /[\/\-]/.test(p) || /^[A-Z]{0,5}\d{2,}/.test(p) || /^\d{4,}/.test(p);
  // Check if something is a number (score)
  const isNum = p => /^\d+(\.\d+)?$/.test(p);

  let remaining = [...parts];

  // Extract matric if present
  if(looksLikeMatric(remaining[0])){
    matric = remaining.shift();
  }

  // Extract numbers from the end (score, optional total)
  const nums = [];
  while(remaining.length > 0 && isNum(remaining[remaining.length-1])){
    nums.unshift(remaining.pop());
  }

  // Everything left is the name
  name = remaining.join(' ');

  if(nums.length >= 2){ score = parseFloat(nums[0]); total = parseFloat(nums[1]); }
  else if(nums.length === 1){ score = parseFloat(nums[0]); total = 100; }

  if(!name) name = '(unknown)';

  if(score === null){
    return {matric, name, score:null, total, grade:'', status:'err', warn:'No score found', raw:line, removed:false};
  }

  // Normalise score to percentage
  let pct = score;
  if(total && total !== 100) pct = Math.round((score / total) * 100 * 10) / 10;
  if(pct < 0 || pct > 100){
    return {matric, name, score:pct, total, grade:'', status:'err', warn:`Score ${pct}% out of range`, raw:line, removed:false};
  }

  // Try to match to a registered student
  const classId = document.getElementById('piClass').value;
  const students = db.users.filter(u=>u.role==='student');
  let matched = null;

  // Match by matric first
  if(matric) matched = students.find(u=>(u.matric||'').toUpperCase()===matric.toUpperCase());
  // Then by name (case-insensitive, partial)
  if(!matched && name){
    const nl = name.toLowerCase();
    matched = students.find(u=>u.name.toLowerCase()===nl)
           || students.find(u=>u.name.toLowerCase().includes(nl)||nl.includes(u.name.toLowerCase()));
  }

  const grade = calcGrade(pct);
  const warn  = !matched ? 'Student not in system â€” will save as unlinked' : '';
  const status = 'ok';

  return {
    matric: matched ? (matched.matric||matric) : matric,
    name:   matched ? matched.name : name,
    score:  pct,
    total,
    grade,
    status,
    warn,
    raw:    line,
    removed: false,
    studentId: matched ? matched.id : null,
  };
}

function piRenderPreview(){
  const visible = _piRows.filter(r=>!r.removed);
  const okCount  = visible.filter(r=>r.status==='ok').length;
  const errCount = visible.filter(r=>r.status==='err').length;

  document.getElementById('piPreviewWrap').style.display = '';
  document.getElementById('piPreviewCount').textContent = `${visible.length} row${visible.length!==1?'s':''} parsed`;
  document.getElementById('piPreviewErrors').textContent = errCount ? `${errCount} error${errCount!==1?'s':''}` : '';

  document.getElementById('piSummary').textContent =
    `${okCount} valid Â· ${errCount} skipped`;
  document.getElementById('piImportBtn').disabled = okCount===0;

  document.getElementById('piPreviewBody').innerHTML = _piRows.map((r,i)=>{
    if(r.removed) return '';
    const isOk  = r.status==='ok';
    const gc    = isOk ? gradeColor(r.grade) : 'var(--accent4)';
    return `<div class="parse-row ${isOk?'parse-ok':'parse-err'}">
      <span class="parse-status">${isOk?'âœ…':'âŒ'}</span>
      <span class="parse-matric" title="${r.matric||'â€”'}">${r.matric||'â€”'}</span>
      <span class="parse-name">${r.name}</span>
      <span class="parse-score" style="color:${gc}">${r.score!==null?r.score+'%':'â€”'}</span>
      <span class="parse-grade" style="color:${gc}">${r.grade||'â€”'}</span>
      <span class="parse-warn">${r.warn||'<span style="color:var(--accent3);font-size:10px">matched</span>'}</span>
      <button class="parse-del" onclick="piRemoveRow(${i})" title="Remove row">âœ•</button>
    </div>`;
  }).join('');
}

function piRemoveRow(idx){
  _piRows[idx].removed = true;
  piRenderPreview();
}

function piImportAll(){
  const type    = document.getElementById('piType').value;
  const title   = document.getElementById('piTitle').value.trim();
  const classId = document.getElementById('piClass').value;
  const courseId= document.getElementById('piCourse').value;

  if(!title)   return toast('Please enter a title before importing.');
  if(!courseId) return toast('Please select a course.');

  const now = new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date = months[now.getMonth()]+' '+now.getDate()+', '+now.getFullYear();

  const valid = _piRows.filter(r=>!r.removed && r.status==='ok');
  if(!valid.length) return toast('No valid rows to import.');

  let imported = 0;
  valid.forEach(r=>{
    db.results.push({
      id:          'r_'+Date.now()+'_'+imported,
      type, title, classId, courseId,
      studentId:   r.studentId||null,
      studentName: r.name,
      matric:      r.matric||'',
      score:       r.score,
      total:       r.total||100,
      grade:       r.grade,
      date,
      uploadedBy:  currentUser.name,
      remarks:     ''
    });
    imported++;
  });

  saveDB();
  closeModal('pasteImportModal');
  renderResultsTable();
  toast(`âœ“ ${imported} result${imported!==1?'s':''} imported successfully`);
}

// ============================================================
// ADD LECTURER (admin only)
// ============================================================
function addLecturerAccount(){
  const name    =document.getElementById('lecturerName').value.trim();
  const username=document.getElementById('lecturerUsername').value.trim().toLowerCase().replace(/\s+/g,'');
  const pass    =document.getElementById('lecturerPassword').value.trim();
  if(!name||!username||!pass){toast('Please fill in all fields');return;}
  if(username.length<3){toast('Username must be at least 3 characters');return;}
  if(pass.length<4){toast('Password must be at least 4 characters');return;}
  if(username===ADMIN_USERNAME){toast('That username is reserved');return;}
  if(db.users.find(u=>(u.username||'').toLowerCase()===username)){toast('An account with that username already exists');return;}
  const u={id:'u_'+Date.now(),name,username,password:pass,role:'teacher',cls:'All',classId:null};
  db.users.push(u); saveDB();
  closeModal('addLecturerModal');
  document.getElementById('lecturerName').value='';
  document.getElementById('lecturerUsername').value='';
  document.getElementById('lecturerPassword').value='';
  renderUsers();
  toast(`Lecturer account for "${name}" created âœ“`);
}

// ============================================================
// ADD CLASS
// ============================================================
function addClass(){
  const name=document.getElementById('newClassName').value.trim();
  const full=document.getElementById('newClassFull').value.trim();
  const color=document.getElementById('newClassColor').value;
  if(!name||!full){toast('Please fill in all fields');return;}
  db.classes.push({id:'cls_'+Date.now(),name,full,color});
  saveDB(); closeModal('addClassModal');
  document.getElementById('newClassName').value='';
  document.getElementById('newClassFull').value='';
  renderDashboard(); renderSidebar();
  toast(`Class "${name}" created âœ“`);
}

// ============================================================
// ADD COURSE
// ============================================================
function openAddCourseModal(){
  const sel=document.getElementById('newCourseClass');
  sel.innerHTML=db.classes.map(cl=>`<option value="${cl.id}">${cl.name}</option>`).join('');
  if(currentClassId) sel.value=currentClassId;
  openModal('addCourseModal');
}
function addCourse(){
  const title=document.getElementById('newCourseTitle').value.trim();
  const code=document.getElementById('newCourseCode').value.trim();
  const lecturer=document.getElementById('newCourseLecturer').value.trim();
  const classId=document.getElementById('newCourseClass').value;
  if(!title||!code){toast('Please fill in title and code');return;}
  const creditUnits = parseInt(document.getElementById('newCourseCreditUnits')?.value)||3;
  db.courses.push({id:'co_'+Date.now(),classId,title,code,lecturer:lecturer||currentUser.name,creditUnits});
  saveDB(); closeModal('addCourseModal');
  document.getElementById('newCourseTitle').value='';
  document.getElementById('newCourseCode').value='';
  document.getElementById('newCourseLecturer').value='';
  if(currentClassId===classId) renderCourses(classId);
  renderDashboard();
  toast(`Course "${title}" added âœ“`);
}

// ============================================================
// ADD HANDOUT
// ============================================================
function openAddHandoutModal(){
  const sel=document.getElementById('newHandoutCourse');
  const courses=currentClassId?db.courses.filter(c=>c.classId===currentClassId):db.courses;
  sel.innerHTML=courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
  if(currentCourseId) sel.value=currentCourseId;
  document.getElementById('handoutDrop').classList.remove('has-file');
  document.getElementById('dropIco').textContent='ðŸ“';
  document.getElementById('dropTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
  document.getElementById('handoutFile').value='';
  document.getElementById('newHandoutTitle').value='';
  openModal('addHandoutModal');
}

function addHandout(){
  const title=document.getElementById('newHandoutTitle').value.trim();
  const courseId=document.getElementById('newHandoutCourse').value;
  const type=document.getElementById('newHandoutType').value;
  const fileInp=document.getElementById('handoutFile');
  if(!title){toast('Please enter a title');return;}
  const id='h_'+Date.now();
  const now=new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date=months[now.getMonth()]+' '+now.getDate();
  const handout={id,courseId,title,type,date,lecturer:currentUser.name};

  const doFinish=()=>{
    db.handouts.push(handout); saveDB();
    closeModal('addHandoutModal');
    if(currentCourseId===courseId) renderHandouts(courseId);
    renderDashboard();
    toast(`Handout "${title}" uploaded âœ“`);
  };

  if(fileInp.files[0]){
    const file=fileInp.files[0];
    const reader=new FileReader();
    reader.onload=e=>{saveFileData(id,{name:file.name,dataUrl:e.target.result,mime:file.type});doFinish();};
    reader.readAsDataURL(file);
  } else { doFinish(); }
}

function deleteHandout(id){
  if(!confirm('Delete this handout?')) return;
  db.handouts=db.handouts.filter(h=>h.id!==id);
  deleteFileData(id);
  saveDB();
  if(currentCourseId) renderHandouts(currentCourseId);
  renderDashboard();
  toast('Handout deleted');
}

// ============================================================
// UPLOAD MODAL
// ============================================================
function filterUploadCourses(){
  const classId=document.getElementById('uploadClass').value;
  document.getElementById('uploadCourse').innerHTML=db.courses.filter(c=>c.classId===classId).map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}
function openModal(id){
  if(id==='uploadModal'){
    document.getElementById('uploadClass').innerHTML=db.classes.map(cl=>`<option value="${cl.id}">${cl.name}</option>`).join('');
    filterUploadCourses();
    document.getElementById('uploadDropIco').textContent='ðŸ“';
    document.getElementById('uploadDropTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
    document.getElementById('uploadFile').value='';
    document.getElementById('uploadTitle').value='';
  }
  document.getElementById(id).classList.add('open');
}
function submitUpload(){
  const title=document.getElementById('uploadTitle').value.trim();
  const courseId=document.getElementById('uploadCourse').value;
  const type=document.getElementById('uploadType').value;
  const fileInp=document.getElementById('uploadFile');
  if(!title||!courseId){toast('Please fill in all fields');return;}
  const id='h_'+Date.now();
  const now=new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date=months[now.getMonth()]+' '+now.getDate();
  const handout={id,courseId,title,type,date,lecturer:currentUser.name};
  const doFinish=()=>{
    db.handouts.push(handout); saveDB();
    closeModal('uploadModal');
    renderDashboard();
    toast(`"${title}" uploaded âœ“`);
  };
  if(fileInp.files[0]){
    const file=fileInp.files[0];
    const reader=new FileReader();
    reader.onload=e=>{saveFileData(id,{name:file.name,dataUrl:e.target.result,mime:file.type});doFinish();};
    reader.readAsDataURL(file);
  } else { doFinish(); }
}

function autoDetectType(fname,selId){
  const sel=document.getElementById(selId);
  if(fname.endsWith('.pdf')) sel.value='pdf';
  else if(/\.(doc|docx)$/.test(fname)) sel.value='doc';
  else if(/\.(ppt|pptx)$/.test(fname)) sel.value='ppt';
  else if(/\.(png|jpg|jpeg|gif|webp)$/.test(fname)) sel.value='img';
}
function handoutFileChosen(inp){
  if(!inp.files[0]) return;
  document.getElementById('handoutDrop').classList.add('has-file');
  document.getElementById('dropIco').textContent='âœ…';
  document.getElementById('dropTxt').innerHTML=`<strong>${inp.files[0].name}</strong>`;
  autoDetectType(inp.files[0].name.toLowerCase(),'newHandoutType');
}
function uploadFileChosen(inp){
  if(!inp.files[0]) return;
  document.getElementById('uploadDropIco').textContent='âœ…';
  document.getElementById('uploadDropTxt').innerHTML=`<strong>${inp.files[0].name}</strong>`;
  autoDetectType(inp.files[0].name.toLowerCase(),'uploadType');
}

// ============================================================
// FILE STORE â€” persisted to localStorage (base64)
// Key: nv_file_{handoutId}  Value: JSON {name,dataUrl,mime}
// ============================================================
function saveFileData(handoutId, fileData){
  try{
    localStorage.setItem('nv_file_'+handoutId, JSON.stringify(fileData));
    fileStore[handoutId]=fileData;
  }catch(e){
    // localStorage quota exceeded â€” keep in memory only
    fileStore[handoutId]=fileData;
    console.warn('File too large to persist, kept in memory only');
  }
}
function loadFileData(handoutId){
  if(fileStore[handoutId]) return fileStore[handoutId];
  try{
    const s=localStorage.getItem('nv_file_'+handoutId);
    if(s){ const d=JSON.parse(s); fileStore[handoutId]=d; return d; }
  }catch(e){}
  return null;
}
function deleteFileData(handoutId){
  delete fileStore[handoutId];
  try{ localStorage.removeItem('nv_file_'+handoutId); }catch(e){}
}

// ============================================================
// PREVIEW â€” FULL SCREEN VIEWER
// ============================================================
let pvState = {
  handoutId: null,
  zoom: 1,
  page: 1,
  totalPages: 1,
  pdfDoc: null,
  isImg: false,
  imgZoomed: false,
};

// Load PDF.js lazily
let pdfJsLoaded = false;
function loadPdfJs(cb){
  if(pdfJsLoaded){ cb(); return; }
  const s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  s.onload=()=>{
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    pdfJsLoaded=true; cb();
  };
  document.head.appendChild(s);
}

function openPreview(id){
  const h=db.handouts.find(x=>x.id===id);
  if(!h) return;
  pvState.handoutId=id;
  pvState.zoom=1;
  pvState.page=1;
  pvState.totalPages=1;
  pvState.pdfDoc=null;
  pvState.isImg=false;
  pvState.imgZoomed=false;

  const co=db.courses.find(c=>c.id===h.courseId)||{title:'Unknown',code:'',classId:''};
  const cl=db.classes.find(c=>c.id===co.classId)||{name:'Unknown',color:'blue'};

  // Populate top bar
  document.getElementById('pvTitle').textContent=h.title;
  document.getElementById('pvSubtitle').textContent=`${co.code} â€” ${co.title} Â· ${h.lecturer}`;

  const badge=document.getElementById('pvBadge');
  badge.textContent=h.type.toUpperCase();
  badge.className='pv-badge fb-'+h.type;
  badge.style.display='';

  // Populate info panel
  document.getElementById('pvInfoTitle').textContent=h.title;
  document.getElementById('pvInfoType').textContent=h.type.toUpperCase();
  document.getElementById('pvInfoLecturer').textContent=h.lecturer;
  document.getElementById('pvInfoDate').textContent=h.date;
  document.getElementById('pvInfoCourse').textContent=`${co.code} â€” ${co.title}`;
  document.getElementById('pvInfoClass').textContent=cl.name;

  // Show overlay
  document.getElementById('pvOverlay').classList.add('open');
  document.body.style.overflow='hidden';

  // Show spinner
  pvShowSpinner();

  const fd = loadFileData(id);

  if(!fd){
    // No file stored
    pvShowNoFile(h);
    document.getElementById('pvInfoSize').textContent='No file stored';
    document.getElementById('pvDlBtn').disabled=true;
    return;
  }

  // File size display
  const sizeBytes = Math.round((fd.dataUrl.length * 3)/4);
  document.getElementById('pvInfoSize').textContent = formatBytes(sizeBytes);
  document.getElementById('pvDlBtn').disabled=false;

  const isImage = h.type==='img' || (fd.mime && fd.mime.startsWith('image/'));
  const isPdf   = h.type==='pdf' || fd.mime==='application/pdf';

  if(isImage){
    pvState.isImg=true;
    pvShowImage(fd, h);
    pvHidePdfNav();
  } else if(isPdf){
    pvState.isImg=false;
    pvHidePdfNav();
    loadPdfJs(()=> pvLoadPdf(fd.dataUrl));
  } else {
    // DOC / PPT â€” show rich placeholder with external viewer option
    pvState.isImg=false;
    pvHidePdfNav();
    pvShowDocPlaceholder(h, fd, co, cl);
  }
}

function formatBytes(b){
  if(b<1024) return b+' B';
  if(b<1048576) return (b/1024).toFixed(1)+' KB';
  return (b/1048576).toFixed(1)+' MB';
}

function pvShowSpinner(){
  document.getElementById('pvBody').innerHTML=`
    <div class="pv-spinner">
      <div class="pv-spin-ring"></div>
      <div class="pv-spin-txt">Loading previewâ€¦</div>
    </div>`;
}

function pvShowNoFile(h){
  const icons={pdf:'ðŸ“„',doc:'ðŸ“',ppt:'ðŸ“Š',img:'ðŸ–¼ï¸'};
  document.getElementById('pvBody').innerHTML=`
    <div class="pv-placeholder">
      <div class="pv-ph-ico">${icons[h.type]||'ðŸ“Ž'}</div>
      <div class="pv-ph-title">No File Attached</div>
      <div class="pv-ph-sub">This handout was added as a title-only entry. The lecturer has not uploaded a file yet.</div>
      <div class="pv-ph-fname">${h.title.toLowerCase().replace(/\s+/g,'-')}.${h.type}</div>
      <div class="pv-meta-strip">
        <div class="pv-meta-item"><div class="pv-meta-lbl">Type</div><div class="pv-meta-val">${h.type.toUpperCase()}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Lecturer</div><div class="pv-meta-val">${h.lecturer}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Date</div><div class="pv-meta-val">${h.date}</div></div>
      </div>
    </div>`;
  pvHidePdfNav();
}

function pvShowImage(fd, h){
  const body=document.getElementById('pvBody');
  body.innerHTML=`<div class="pv-img-wrap" id="pvImgWrap">
    <img class="pv-img-display" id="pvImgEl" src="${fd.dataUrl}" alt="${h.title}"
      onclick="pvToggleImgZoom(this)"
      style="max-width:100%;transform-origin:center center;">
  </div>`;
  const img=document.getElementById('pvImgEl');
  img.onload=()=>{ pvApplyImgZoom(); };
}

function pvApplyImgZoom(){
  const img=document.getElementById('pvImgEl');
  if(!img) return;
  img.style.transform=`scale(${pvState.zoom})`;
  document.getElementById('pvZoomVal').textContent=Math.round(pvState.zoom*100)+'%';
}

function pvToggleImgZoom(img){
  pvState.imgZoomed=!pvState.imgZoomed;
  pvState.zoom=pvState.imgZoomed?2:1;
  img.classList.toggle('zoomed', pvState.imgZoomed);
  pvApplyImgZoom();
}

// PDF rendering with PDF.js
async function pvLoadPdf(dataUrl){
  try{
    const raw=atob(dataUrl.split(',')[1]);
    const arr=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++) arr[i]=raw.charCodeAt(i);
    const loadingTask=pdfjsLib.getDocument({data:arr});
    pvState.pdfDoc=await loadingTask.promise;
    pvState.totalPages=pvState.pdfDoc.numPages;
    pvShowPdfNav();
    await pvRenderPdfPage(pvState.page);
  }catch(err){
    document.getElementById('pvBody').innerHTML=`
      <div class="pv-placeholder">
        <div class="pv-ph-ico">âš ï¸</div>
        <div class="pv-ph-title">PDF could not be rendered</div>
        <div class="pv-ph-sub">${err.message}</div>
      </div>`;
  }
}

async function pvRenderPdfPage(pageNum){
  if(!pvState.pdfDoc) return;
  pvShowSpinner();
  const page=await pvState.pdfDoc.getPage(pageNum);
  const body=document.getElementById('pvBody');

  // Build a scrollable wrap with all pages or single page
  body.innerHTML=`<div class="pv-pdf-wrap" id="pvPdfWrap"></div>`;
  const wrap=document.getElementById('pvPdfWrap');

  const viewport=page.getViewport({scale:pvState.zoom*1.5});
  const canvas=document.createElement('canvas');
  canvas.className='pv-canvas-page';
  canvas.width=viewport.width;
  canvas.height=viewport.height;
  canvas.style.width='min('+Math.round(viewport.width)+'px, 100%)';
  wrap.appendChild(canvas);

  const ctx=canvas.getContext('2d');
  await page.render({canvasContext:ctx,viewport}).promise;

  // Update page info
  document.getElementById('pvPageInfo').textContent=`${pageNum} / ${pvState.totalPages}`;
  document.getElementById('pvPrevPage').disabled=pageNum<=1;
  document.getElementById('pvNextPage').disabled=pageNum>=pvState.totalPages;
}

function pvShowPdfNav(){
  ['pvPageLabel','pvPrevPage','pvPageInfo','pvNextPage','pvPageSep'].forEach(id=>{
    document.getElementById(id).style.display='';
  });
  document.getElementById('pvPageInfo').textContent=`${pvState.page} / ${pvState.totalPages}`;
}
function pvHidePdfNav(){
  ['pvPageLabel','pvPrevPage','pvPageInfo','pvNextPage','pvPageSep'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
}

async function pvChangePage(delta){
  const next=pvState.page+delta;
  if(next<1||next>pvState.totalPages) return;
  pvState.page=next;
  await pvRenderPdfPage(pvState.page);
}

function pvShowDocPlaceholder(h, fd, co, cl){
  const icons={doc:'ðŸ“',ppt:'ðŸ“Š'};
  const colors={doc:'var(--accent)',ppt:'#fbbf24'};
  const labels={doc:'Word Document',ppt:'PowerPoint Presentation'};
  document.getElementById('pvBody').innerHTML=`
    <div class="pv-placeholder">
      <div class="pv-ph-ico" style="font-size:90px">${icons[h.type]||'ðŸ“Ž'}</div>
      <div class="pv-ph-title" style="color:${colors[h.type]||'var(--text)'}">${labels[h.type]||'Document'}</div>
      <div class="pv-ph-fname">${fd.name||h.title}</div>
      <div class="pv-ph-sub" style="margin-top:4px">
        This file type cannot be rendered directly in the browser.<br>
        Download the file to open it in Microsoft Office, LibreOffice, or Google Drive.
      </div>
      <div class="pv-meta-strip">
        <div class="pv-meta-item"><div class="pv-meta-lbl">File</div><div class="pv-meta-val" style="color:${colors[h.type]||'var(--accent)'}">${(fd.name||h.title)}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Size</div><div class="pv-meta-val">${formatBytes(Math.round((fd.dataUrl.length*3)/4))}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Lecturer</div><div class="pv-meta-val">${h.lecturer}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Course</div><div class="pv-meta-val">${co.code} â€” ${co.title}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Class</div><div class="pv-meta-val">${cl.name}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Date</div><div class="pv-meta-val">${h.date}</div></div>
      </div>
      <button class="pv-dl-btn" style="margin-top:8px;font-size:15px;padding:12px 32px;" onclick="doDownload()">â¬‡ Download to View</button>
    </div>`;
}

// ---- Zoom controls ----
function pvZoom(delta){
  if(pvState.isImg){
    pvState.zoom=Math.max(0.2,Math.min(5,pvState.zoom+delta));
    pvApplyImgZoom();
  } else if(pvState.pdfDoc){
    pvState.zoom=Math.max(0.3,Math.min(4,pvState.zoom+delta));
    document.getElementById('pvZoomVal').textContent=Math.round(pvState.zoom*100)+'%';
    pvRenderPdfPage(pvState.page);
  }
}
function pvResetZoom(){
  pvState.zoom=1;
  pvState.imgZoomed=false;
  if(pvState.isImg){ pvApplyImgZoom(); }
  else if(pvState.pdfDoc){ document.getElementById('pvZoomVal').textContent='100%'; pvRenderPdfPage(pvState.page); }
}
function pvFitWidth(){
  pvState.zoom=1;
  pvState.imgZoomed=false;
  if(pvState.isImg){ pvApplyImgZoom(); }
  else if(pvState.pdfDoc){ document.getElementById('pvZoomVal').textContent='100%'; pvRenderPdfPage(pvState.page); }
}

// ---- Fullscreen ----
function pvToggleFullscreen(){
  const el=document.getElementById('pvOverlay');
  if(!document.fullscreenElement){ el.requestFullscreen&&el.requestFullscreen(); }
  else { document.exitFullscreen&&document.exitFullscreen(); }
}

// ---- Info panel ----
function toggleInfoPanel(){
  document.getElementById('pvInfoPanel').classList.toggle('open');
}

// ---- Close ----
function closePreview(){
  document.getElementById('pvOverlay').classList.remove('open');
  document.getElementById('pvInfoPanel').classList.remove('open');
  document.body.style.overflow='';
  pvState.pdfDoc=null;
}

// Keyboard shortcuts in viewer
document.addEventListener('keydown', e=>{
  if(!document.getElementById('pvOverlay').classList.contains('open')) return;
  if(e.key==='Escape') closePreview();
  if(e.key==='ArrowRight'||e.key==='ArrowDown') pvChangePage(1);
  if(e.key==='ArrowLeft'||e.key==='ArrowUp') pvChangePage(-1);
  if(e.key==='+'||e.key==='=') pvZoom(0.15);
  if(e.key==='-') pvZoom(-0.15);
});

function doDownload(){
  if(!pvState.handoutId){ toast('No file selected'); return; }
  const h=db.handouts.find(x=>x.id===pvState.handoutId);
  const fd=loadFileData(pvState.handoutId);
  if(!fd){ toast('No file attached to this handout'); return; }
  const a=document.createElement('a');
  a.href=fd.dataUrl;
  a.download=fd.name||`${h.title.toLowerCase().replace(/\s+/g,'-')}.${h.type}`;
  a.click();
  toast('Download started â¬‡');
}

// ============================================================
// SEARCH
// ============================================================
function globalSearch(q){
  if(!q){renderDashboard();return;}
  const filtered=db.handouts.filter(h=>h.title.toLowerCase().includes(q.toLowerCase()));
  const grid=document.getElementById('classesGrid');
  if(!filtered.length){grid.innerHTML=`<div class="empty" style="grid-column:1/-1"><div class="empty-ico">ðŸ”</div><div class="empty-t">No results for "${q}"</div></div>`;return;}
  grid.innerHTML=`<div style="grid-column:1/-1;font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.07em">${filtered.length} result${filtered.length!==1?'s':''} for "${q}"</div>`
    +filtered.map((h,i)=>{
      const co=db.courses.find(c=>c.id===h.courseId)||{title:'',code:'',classId:''};
      const cl=db.classes.find(c=>c.id===co.classId)||{name:'',color:'blue'};
      return `<div class="handout-row" style="animation-delay:${i*.04}s" onclick="openPreview('${h.id}')">
        <div class="file-badge fb-${h.type}">${h.type}</div>
        <div style="width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;background:${fileBg[h.type]};flex-shrink:0">${fileIco[h.type]}</div>
        <div class="handout-info"><div class="handout-title">${h.title}</div><div class="handout-teacher">${co.title} Â· <span style="color:${colorMap[cl.color]?.color||'var(--accent)'}">${cl.name}</span></div></div>
        <div class="handout-date">${h.date}</div>
      </div>`;
    }).join('');
}
function searchCourses(q){if(currentClassId)renderCourses(currentClassId,q.toLowerCase());}
function searchHandouts(q){if(currentCourseId)renderHandouts(currentCourseId,q.toLowerCase());}
function searchAllHandouts(q){renderAllHandouts(db.handouts.filter(h=>h.title.toLowerCase().includes(q.toLowerCase())));}

// ============================================================
// MODALS & UTILS
// ============================================================
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

function toast(msg){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const el=document.createElement('div');
  el.className='toast';
  el.innerHTML=`<div class="toast-dot"></div><span>${msg}</span>`;
  document.body.appendChild(el);
  setTimeout(()=>el.style.opacity='0',2800);
  setTimeout(()=>el.remove(),3200);
}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarBg').classList.toggle('open');
}
function closeSidebar(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarBg').classList.remove('open');
}

// ============================================================
// FOLDER UPLOAD SYSTEM
// ============================================================

// Supported file types
const SUPPORTED_TYPES = {
  'application/pdf': 'pdf',
  'application/msword': 'doc',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'doc',
  'application/vnd.ms-powerpoint': 'ppt',
  'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'ppt',
  'image/png': 'img', 'image/jpeg': 'img', 'image/jpg': 'img',
  'image/gif': 'img', 'image/webp': 'img',
};
const EXT_MAP = {
  pdf:'pdf', doc:'doc', docx:'doc', ppt:'ppt', pptx:'ppt',
  png:'img', jpg:'img', jpeg:'img', gif:'img', webp:'img',
};

// State
let fuFiles = []; // array of {id, file, name, path, folder, size, type, checked, courseId, progress}

function openFolderUpload() {
  closeSidebar();
  // Populate class dropdowns
  const cls = document.getElementById('fuDefaultClass');
  cls.innerHTML = '<option value="">â€” Select class â€”</option>' +
    db.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('fuDefaultCourse').innerHTML = '<option value="">â€” Select course â€”</option>';
  fuReset();
  document.getElementById('fuOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeFolderUpload() {
  document.getElementById('fuOverlay').classList.remove('open');
  document.body.style.overflow = '';
  renderDashboard();
}

function fuReset() {
  fuFiles = [];
  document.getElementById('fuFolderInput').value = '';
  document.getElementById('fuFilesInput').value = '';
  document.getElementById('fuTree').innerHTML = `
    <div class="fu-empty-state" style="padding:30px 20px;">
      <div class="fu-empty-ico">ðŸ“‚</div>
      <div class="fu-empty-t" style="font-size:13px;">No folder selected</div>
      <div class="fu-empty-s" style="font-size:11px;">Drop a folder or click above</div>
    </div>`;
  document.getElementById('fuTreeCount').textContent = '0';
  document.getElementById('fuEmptyState').style.display = '';
  document.getElementById('fuAssignPanel').style.display = 'none';
  document.getElementById('fuProgressPanel').style.display = 'none';
  document.getElementById('fuDonePanel').style.display = 'none';
  document.getElementById('fuSummaryBar').style.display = 'none';
  document.getElementById('fuUploadBtn').disabled = true;
  document.getElementById('fuDzIco').textContent = 'ðŸ“‚';
  document.getElementById('fuDzTitle').textContent = 'Drop a folder here';
  document.getElementById('fuDzSub').innerHTML = 'Drag &amp; drop a folder from your computer,<br>Google Drive, USB drive, or any storage';
  document.getElementById('fuDropzone').classList.remove('has-files', 'drag-over');
  document.getElementById('fuTopStats').textContent = '';
}

// ---- Drag & Drop ----
function fuDragOver(e) {
  e.preventDefault(); e.stopPropagation();
  document.getElementById('fuDropzone').classList.add('drag-over');
}
function fuDragLeave(e) {
  e.preventDefault();
  document.getElementById('fuDropzone').classList.remove('drag-over');
}
async function fuDrop(e) {
  e.preventDefault(); e.stopPropagation();
  document.getElementById('fuDropzone').classList.remove('drag-over');
  const items = e.dataTransfer.items;
  if (!items || items.length === 0) return;

  const allFiles = [];
  const promises = [];
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    if (item.kind !== 'file') continue;
    if (item.webkitGetAsEntry) {
      const entry = item.webkitGetAsEntry();
      if (entry) promises.push(fuReadEntry(entry, '', allFiles));
    } else {
      const file = item.getAsFile();
      if (file) allFiles.push({ file, path: file.name, folder: '' });
    }
  }
  await Promise.all(promises);
  fuProcessFiles(allFiles);
}

function fuReadEntry(entry, basePath, results) {
  return new Promise(resolve => {
    if (entry.isFile) {
      entry.getFile(file => {
        results.push({ file, path: basePath ? basePath + '/' + file.name : file.name, folder: basePath });
        resolve();
      }, () => resolve());
    } else if (entry.isDirectory) {
      const reader = entry.createReader();
      const readAll = () => {
        reader.readEntries(async entries => {
          if (!entries.length) { resolve(); return; }
          const subPath = basePath ? basePath + '/' + entry.name : entry.name;
          await Promise.all(entries.map(e => fuReadEntry(e, subPath, results)));
          readAll();
        }, () => resolve());
      };
      readAll();
    } else resolve();
  });
}

// ---- Input: folder picker ----
function fuFolderChosen(inp) {
  const files = Array.from(inp.files);
  const allFiles = files.map(f => {
    const path = f.webkitRelativePath || f.name;
    const parts = path.split('/');
    const folder = parts.length > 1 ? parts.slice(0, -1).join('/') : '';
    return { file: f, path, folder };
  });
  fuProcessFiles(allFiles);
}

// ---- Input: multi-file picker (no folder) ----
function fuFilesChosen(inp) {
  const files = Array.from(inp.files);
  const allFiles = files.map(f => ({ file: f, path: f.name, folder: '' }));
  fuProcessFiles(allFiles);
}

// ---- Core processing ----
function fuProcessFiles(rawList) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const today = new Date();
  const dateStr = months[today.getMonth()] + ' ' + today.getDate();

  // Filter to supported types only
  const valid = rawList.filter(({ file }) => {
    const ext = file.name.split('.').pop().toLowerCase();
    const mime = file.type;
    return EXT_MAP[ext] || SUPPORTED_TYPES[mime];
  });

  if (!valid.length) {
    toast('No supported files found in this folder.');
    return;
  }

  fuFiles = valid.map((item, i) => {
    const ext = item.file.name.split('.').pop().toLowerCase();
    const type = EXT_MAP[ext] || SUPPORTED_TYPES[item.file.type] || 'doc';
    return {
      id: 'fu_' + Date.now() + '_' + i,
      file: item.file,
      name: item.file.name,
      path: item.path,
      folder: item.folder || 'Root',
      size: item.file.size,
      type,
      checked: true,
      courseId: '',
      date: dateStr,
      progress: 0,
      status: 'pending',
    };
  });

  fuRenderTree();
  fuRenderFileRows();
  fuUpdateSummary();

  document.getElementById('fuEmptyState').style.display = 'none';
  document.getElementById('fuAssignPanel').style.display = '';
  document.getElementById('fuProgressPanel').style.display = 'none';
  document.getElementById('fuDonePanel').style.display = 'none';
  document.getElementById('fuSummaryBar').style.display = '';
  document.getElementById('fuUploadBtn').disabled = false;

  const dz = document.getElementById('fuDropzone');
  dz.classList.add('has-files');
  document.getElementById('fuDzIco').textContent = 'âœ…';
  document.getElementById('fuDzTitle').textContent = `${fuFiles.length} file${fuFiles.length !== 1 ? 's' : ''} loaded`;
  document.getElementById('fuDzSub').innerHTML = `<strong style="color:var(--accent3)">${fuFiles.length} supported files</strong> from ${[...new Set(fuFiles.map(f => f.folder))].length} folder(s).<br>Click to replace.`;

  toast(`${fuFiles.length} file${fuFiles.length !== 1 ? 's' : ''} loaded âœ“`);
}

// ---- Tree renderer ----
function fuRenderTree() {
  const tree = document.getElementById('fuTree');
  document.getElementById('fuTreeCount').textContent = fuFiles.length;

  // Group by folder
  const groups = {};
  fuFiles.forEach(f => {
    if (!groups[f.folder]) groups[f.folder] = [];
    groups[f.folder].push(f);
  });

  const typeIco = { pdf: 'ðŸ“„', doc: 'ðŸ“', ppt: 'ðŸ“Š', img: 'ðŸ–¼ï¸' };

  tree.innerHTML = Object.entries(groups).map(([folder, files]) => `
    <div class="fu-folder-group">
      <div class="fu-folder-label">
        <span class="fu-fold-ico">ðŸ“</span>
        <span class="fu-fold-name">${folder}</span>
        <span class="fu-fold-count">${files.length}</span>
      </div>
      ${files.map(f => `
        <div class="fu-file-item ${f.checked ? 'selected' : ''}" onclick="fuToggleFile('${f.id}')">
          <input class="fu-file-cb" type="checkbox" ${f.checked ? 'checked' : ''} onclick="event.stopPropagation();fuToggleFile('${f.id}')">
          <span class="fu-file-ico">${typeIco[f.type] || 'ðŸ“Ž'}</span>
          <span class="fu-file-name">${f.name}</span>
          <span class="fu-file-size">${formatFuBytes(f.size)}</span>
        </div>`).join('')}
    </div>`).join('');
}

// ---- File rows table ----
function fuRenderFileRows() {
  const tbody = document.getElementById('fuFileRows');
  const typeClr = { pdf: 'var(--accent4)', doc: 'var(--accent)', ppt: '#fbbf24', img: 'var(--accent3)' };
  const typeBg  = { pdf: 'rgba(251,113,133,.12)', doc: 'rgba(56,189,248,.12)', ppt: 'rgba(251,191,36,.12)', img: 'rgba(52,211,153,.12)' };

  const courseOptions = (selId, fileId) => {
    const defaultClass = document.getElementById('fuDefaultClass').value;
    const courses = defaultClass ? db.courses.filter(c => c.classId === defaultClass) : db.courses;
    return `<select class="fu-row-sel" id="${selId}" onchange="fuFileCoursePick('${fileId}',this.value)">
      <option value="">â€” Default â€”</option>
      ${courses.map(c => `<option value="${c.id}">${c.code}</option>`).join('')}
    </select>`;
  };

  tbody.innerHTML = fuFiles.map((f, i) => `
    <div class="fu-files-row ${!f.checked ? 'excluded-row' : ''}" id="fuRow_${f.id}">
      <div class="fu-file-cell" style="padding:0 6px;">
        <input class="fu-file-cb" type="checkbox" ${f.checked ? 'checked' : ''} onchange="fuToggleFile('${f.id}')">
      </div>
      <div class="fu-file-cell" style="font-weight:500;" title="${f.name}">${f.name}</div>
      <div class="fu-file-cell" style="color:var(--text3);" title="${f.folder}">${f.folder || 'Root'}</div>
      <div class="fu-file-cell">
        <span class="fu-type-tag" style="background:${typeBg[f.type]};color:${typeClr[f.type]}">${f.type.toUpperCase()}</span>
      </div>
      <div class="fu-file-cell" style="color:var(--text3);">${formatFuBytes(f.size)}</div>
    </div>`).join('');

  document.getElementById('fuSelectedCount').textContent = fuFiles.filter(f => f.checked).length;
}

function fuToggleFile(id) {
  const f = fuFiles.find(x => x.id === id);
  if (!f) return;
  f.checked = !f.checked;
  fuRenderTree();
  fuRenderFileRows();
  fuUpdateSummary();
}

function fuSelectAll(checked) {
  fuFiles.forEach(f => f.checked = checked);
  fuRenderTree();
  fuRenderFileRows();
  fuUpdateSummary();
}

function fuClassChanged() {
  const classId = document.getElementById('fuDefaultClass').value;
  const courses = classId ? db.courses.filter(c => c.classId === classId) : db.courses;
  document.getElementById('fuDefaultCourse').innerHTML =
    '<option value="">â€” Select course â€”</option>' +
    courses.map(c => `<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function fuFileCoursePick(fileId, courseId) {
  const f = fuFiles.find(x => x.id === fileId);
  if (f) f.courseId = courseId;
}

function fuUpdateSummary() {
  const selected = fuFiles.filter(f => f.checked);
  const totalSize = fuFiles.reduce((a, f) => a + f.size, 0);
  const folders = new Set(fuFiles.map(f => f.folder)).size;
  document.getElementById('fuSumFiles').textContent = fuFiles.length;
  document.getElementById('fuSumSelected').textContent = selected.length;
  document.getElementById('fuSumSize').textContent = formatFuBytes(totalSize);
  document.getElementById('fuSumFolders').textContent = folders;
  document.getElementById('fuUploadBtn').disabled = selected.length === 0;
  document.getElementById('fuTopStats').textContent =
    `${selected.length} of ${fuFiles.length} files selected Â· ${formatFuBytes(totalSize)}`;
}

function formatFuBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

// ---- Upload ----
async function fuStartUpload() {
  const selected = fuFiles.filter(f => f.checked);
  if (!selected.length) { toast('No files selected'); return; }

  const defaultCourseId = document.getElementById('fuDefaultCourse').value;
  const defaultClassId  = document.getElementById('fuDefaultClass').value;

  // Validate: every selected file must have a course (either its own override or the default)
  const unassigned = selected.filter(f => !f.courseId && !defaultCourseId);
  if (unassigned.length) {
    toast(`Please select a default course for all files (${unassigned.length} unassigned)`);
    document.getElementById('fuDefaultCourse').style.borderColor = 'var(--accent4)';
    setTimeout(() => document.getElementById('fuDefaultCourse').style.borderColor = '', 2000);
    return;
  }

  // Switch UI to progress view
  document.getElementById('fuAssignPanel').style.display = 'none';
  document.getElementById('fuEmptyState').style.display = 'none';
  document.getElementById('fuProgressPanel').style.display = '';
  document.getElementById('fuUploadBtn').disabled = true;
  document.getElementById('fuUploadBtn').textContent = 'Uploadingâ€¦';

  // Build progress items
  const wrap = document.getElementById('fuProgressWrap');
  wrap.innerHTML = selected.map(f => `
    <div class="fu-prog-item" id="fuProg_${f.id}">
      <div class="fu-prog-row">
        <span class="fu-prog-name">${f.name}</span>
        <span class="fu-prog-stat" id="fuProgStat_${f.id}">Waitingâ€¦</span>
      </div>
      <div class="fu-prog-bar"><div class="fu-prog-fill" id="fuProgFill_${f.id}" style="width:0%"></div></div>
    </div>`).join('');

  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const today = new Date();
  const dateStr = months[today.getMonth()] + ' ' + today.getDate();

  let successCount = 0, errorCount = 0;

  for (const f of selected) {
    const courseId = f.courseId || defaultCourseId;
    const stat = document.getElementById('fuProgStat_' + f.id);
    const fill = document.getElementById('fuProgFill_' + f.id);

    stat.textContent = 'Readingâ€¦';
    fill.style.width = '20%';

    try {
      // Read file as dataURL
      const dataUrl = await new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = e => res(e.target.result);
        reader.onerror = () => rej(new Error('Read failed'));
        reader.readAsDataURL(f.file);
      });

      fill.style.width = '60%';
      stat.textContent = 'Savingâ€¦';

      // Create handout record
      const hid = 'h_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6);
      const handout = {
        id: hid, courseId,
        title: f.name.replace(/\.[^.]+$/, ''), // strip extension
        type: f.type, date: dateStr,
        lecturer: currentUser.name,
        fromFolder: true,
        folderPath: f.folder,
      };

      // Save file data persistently
      saveFileData(hid, { name: f.name, dataUrl, mime: f.file.type });

      // Save handout to DB
      db.handouts.push(handout);
      saveDB();

      fill.style.width = '100%';
      fill.classList.add('done');
      stat.textContent = 'âœ“ Done';
      stat.style.color = 'var(--accent3)';
      successCount++;

    } catch (err) {
      fill.style.width = '100%';
      fill.classList.add('error');
      stat.textContent = 'âœ— Error';
      stat.style.color = 'var(--accent4)';
      errorCount++;
    }

    // Small delay between files for UX smoothness
    await new Promise(r => setTimeout(r, 120));
  }

  // Show done panel
  document.getElementById('fuProgressPanel').style.display = 'none';
  document.getElementById('fuDonePanel').style.display = '';
  document.getElementById('fuDoneTitle').textContent =
    errorCount === 0 ? 'Upload Complete! ðŸŽ‰' : `Upload Finished with ${errorCount} error${errorCount > 1 ? 's' : ''}`;
  document.getElementById('fuDoneSub').textContent =
    `${successCount} file${successCount !== 1 ? 's' : ''} uploaded successfully` +
    (errorCount ? ` Â· ${errorCount} failed` : '') +
    ` Â· They are now available in handouts.`;

  document.getElementById('fuTopStats').textContent = `âœ“ ${successCount} uploaded`;

  toast(`${successCount} file${successCount !== 1 ? 's' : ''} uploaded successfully âœ“`);
}

// ============================================================
// PAST QUESTIONS â€” DB helpers
// ============================================================
function getPQBanks(){ if(!db.pastQuestions) db.pastQuestions=[]; return db.pastQuestions; }
function getPQAttempts(){ try{ return JSON.parse(localStorage.getItem('nv_pq_attempts')||'{}'); }catch(e){ return {}; } }
function savePQAttempts(obj){ try{ localStorage.setItem('nv_pq_attempts', JSON.stringify(obj)); }catch(e){} }
function getBestScore(bankId){ const a=getPQAttempts()[bankId]; return a||null; }
function recordAttempt(bankId, correct, total, pct){
  const all=getPQAttempts();
  const prev=all[bankId];
  if(!prev||pct>prev.pct){ all[bankId]={correct,total,pct,date:new Date().toLocaleDateString()}; savePQAttempts(all); }
}

// ============================================================
// PAST QUESTIONS â€” RENDER BANKS
// ============================================================
function renderPQBanks(){
  if(!db.pastQuestions) db.pastQuestions=[];
  const banks=db.pastQuestions;
  const grid=document.getElementById('pqBankGrid');
  const empty=document.getElementById('pqEmpty');
  const courseFilter=document.getElementById('pqFilterCourse').value;
  const yearFilter=document.getElementById('pqFilterYear').value;

  const coursesSel=document.getElementById('pqFilterCourse');
  const yearsSel=document.getElementById('pqFilterYear');
  const allYears=[...new Set(banks.map(b=>b.year).filter(Boolean))].sort().reverse();
  const curYear=yearsSel.value;
  yearsSel.innerHTML='<option value="">All Years</option>'+allYears.map(y=>`<option value="${y}"${y===curYear?' selected':''}>${y}</option>`).join('');
  const allCourseIds=[...new Set(banks.map(b=>b.courseId).filter(Boolean))];
  const curCourse=coursesSel.value;
  coursesSel.innerHTML='<option value="">All Courses</option>'+allCourseIds.map(cid=>{
    const co=db.courses.find(c=>c.id===cid);
    return co?`<option value="${cid}"${cid===curCourse?' selected':''}>${co.code} â€” ${co.title}</option>`:'';
  }).join('');

  let filtered=banks;
  if(courseFilter) filtered=filtered.filter(b=>b.courseId===courseFilter);
  if(yearFilter) filtered=filtered.filter(b=>b.year===yearFilter);

  document.getElementById('pqBankCount').textContent=`${filtered.length} bank${filtered.length!==1?'s':''}`;

  if(!filtered.length){ 
    grid.innerHTML=''; 
    empty.style.display=''; 
    // Show student message if not admin
    const studentMsg=document.getElementById('pqEmptyStudentMsg');
    if(studentMsg) studentMsg.style.display=(currentRole==='admin')?'none':'';
    return; 
  }
  empty.style.display='none';

  const typeLabel={exam:'Final Exam',test:'Test / Quiz',mock:'Mock Exam'};
  const typeColor={exam:'rgba(251,113,133,.15)',test:'rgba(56,189,248,.15)',mock:'rgba(251,191,36,.15)'};
  const typeTxt={exam:'var(--accent4)',test:'var(--accent)',mock:'#fbbf24'};

  grid.innerHTML=filtered.map((bank,i)=>{
    const co=db.courses.find(c=>c.id===bank.courseId);
    const best=getBestScore(bank.id);
    const examBest=getBestScore(bank.id+'_exam');
    const studyBest=getBestScore(bank.id+'_study');
    let scoreHtml='';
    if(examBest||studyBest){
      scoreHtml=`<div style="display:flex;gap:8px;flex-wrap:wrap;">`;
      if(examBest) scoreHtml+=`<span class="pq-best-score" style="color:${examBest.pct>=60?'#fb7185':'var(--text3)'}">ðŸŽ¯ Exam: ${examBest.pct}%</span>`;
      if(studyBest) scoreHtml+=`<span class="pq-best-score" style="color:${studyBest.pct>=60?'var(--accent3)':'var(--text3)'}">ðŸ“– Study: ${studyBest.pct}%</span>`;
      scoreHtml+=`</div>`;
    } else {
      scoreHtml=`<span class="pq-best-score" style="color:var(--text3)">Not attempted</span>`;
    }
    return `<div class="pq-bank-card" style="animation-delay:${i*.06}s">
      <div class="pq-bank-header">
        <div class="pq-bank-title">${escHtml(bank.title)}</div>
        <div class="pq-bank-badge" style="background:${typeColor[bank.type]||'rgba(129,140,248,.15)'};color:${typeTxt[bank.type]||'var(--accent2)'}">
          ${typeLabel[bank.type]||bank.type}
        </div>
      </div>
      <div class="pq-bank-meta">${co?co.code+' â€” '+co.title:'Unknown Course'}${bank.year?' Â· '+bank.year:''}</div>
      <div class="pq-bank-stats">
        <div class="pq-bank-stat"><strong>${bank.questions.length}</strong> Questions</div>
        <div class="pq-bank-stat"><strong>${bank.year||'â€”'}</strong> Year</div>
        <div class="pq-bank-stat"><strong>${bank.questions.filter(q=>q.answer!==null&&q.answer!==undefined).length}</strong> w/ Answers</div>
      </div>
      <div class="pq-bank-footer">
        ${scoreHtml}
        <div style="display:flex;gap:6px;align-items:center;margin-left:auto;">
          ${currentRole==='admin'?`<button class="pq-del-btn" onclick="deletePQBank('${bank.id}',event)" title="Delete bank">ðŸ—‘</button>`:''}
          ${currentRole==='admin'?`<button class="pq-del-btn" onclick="openPQAnswerImport('${bank.id}',event)" title="Import Answers" style="width:auto;padding:0 10px;font-size:10px;font-family:'DM Mono',monospace;color:var(--accent2);border-color:rgba(129,140,248,.3);">ðŸ— Answers</button>`:''}
          <button class="pq-mode-btn study" onclick="startQuiz('${bank.id}','study')" title="Study Mode â€” instant feedback">ðŸ“– Study</button>
          <button class="pq-mode-btn exam" onclick="startQuiz('${bank.id}','exam')" title="Exam Mode â€” submit to see results">ðŸŽ¯ Exam</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function deletePQBank(id,e){
  e.stopPropagation();
  if(!confirm('Delete this question bank? This cannot be undone.')) return;
  db.pastQuestions=db.pastQuestions.filter(b=>b.id!==id);
  saveDB();
  renderPQBanks();
  toast('Question bank deleted.');
}

// ============================================================
// PAST QUESTIONS â€” ANSWER IMPORT (admin only)
// ============================================================
let _ansImportBankId=null;

function openPQAnswerImport(bankId,e){
  if(e) e.stopPropagation();
  _ansImportBankId=bankId;
  const bank=db.pastQuestions.find(b=>b.id===bankId);
  if(!bank){toast('Bank not found.');return;}
  document.getElementById('pqAnsImportTitle').textContent=`Import Answers: ${bank.title}`;
  document.getElementById('pqAnsImportCount').textContent=`${bank.questions.length} questions`;
  document.getElementById('pqAnsImportBox').value='';
  document.getElementById('pqAnsImportPreview').style.display='none';
  document.getElementById('pqAnsImportPreviewBody').innerHTML='';
  document.getElementById('pqAnsImportModal').classList.add('open');
}

function pqAnsPreview(){
  const raw=document.getElementById('pqAnsImportBox').value.trim();
  const bank=db.pastQuestions.find(b=>b.id===_ansImportBankId);
  if(!bank||!raw){document.getElementById('pqAnsImportPreview').style.display='none';return;}

  // Parse answers: accept formats like:
  // "1. C" | "1) C" | "1 C" | "C" (one per line) | "A B C D â€¦" (space separated) | "A,B,C,D" (comma)
  const lines=raw.split('\n').map(l=>l.trim()).filter(Boolean);
  let answers=[];

  // Detect if it's one-per-line with numbers, or just letters, or space/comma separated
  if(lines.length===1){
    // Single line â€” try comma or space separated letters
    const parts=lines[0].split(/[,\s]+/).map(s=>s.trim()).filter(Boolean);
    answers=parts.map(p=>{
      const m=p.match(/^[A-Ea-e]$/);
      return m?p.toUpperCase():null;
    });
  } else {
    answers=lines.map(line=>{
      // "1. C" or "1) C" or "Q1: C" or just "C"
      const m=line.match(/^(?:(?:Q?\d+[\.\)\:]\s*))?([A-Ea-e])[\.\)]?\s*$/i)||
               line.match(/^(?:Q?\d+[\.\)\:]?\s+)?([A-Ea-e])\b/i);
      return m?m[1].toUpperCase():null;
    });
  }

  const body=document.getElementById('pqAnsImportPreviewBody');
  const rows=bank.questions.slice(0,answers.length);
  let matched=0,total=rows.length;
  body.innerHTML=rows.map((q,i)=>{
    const ans=answers[i];
    const ansIdx=ans?ans.charCodeAt(0)-65:null;
    const prev=q.answer!==null&&q.answer!==undefined?String.fromCharCode(65+q.answer):null;
    const valid=ansIdx!==null&&ansIdx>=0&&ansIdx<q.options.length;
    if(valid) matched++;
    const opts=['A','B','C','D','E'];
    return `<div class="pq-preview-q" style="${valid?'':'opacity:.45'}">
      <div class="pq-preview-qn" style="display:flex;align-items:center;justify-content:space-between;gap:6px;">
        <span>${i+1}. ${escHtml(q.question.slice(0,80))}${q.question.length>80?'â€¦':''}</span>
        <span style="flex-shrink:0;font-family:'DM Mono',monospace;font-size:11px;">
          ${prev?`<span style="color:var(--text3);">was ${prev} â†’</span> `:''}
          ${valid?`<span style="color:var(--accent3);font-weight:700;">${ans}</span>`:`<span style="color:var(--accent4);">?</span>`}
        </span>
      </div>
    </div>`;
  }).join('');

  // Store parsed answers for apply
  document.getElementById('pqAnsImportPreview').style.display='';
  document.getElementById('pqAnsMatchCount').textContent=`${matched} of ${total} answers matched`;
  document.getElementById('pqAnsApplyBtn').disabled=matched===0;
  // Store parsed answers in a data attribute for apply step
  document.getElementById('pqAnsImportBox').dataset.parsed=JSON.stringify(answers);
}

function applyPQAnswers(){
  const bank=db.pastQuestions.find(b=>b.id===_ansImportBankId);
  if(!bank){toast('Bank not found.');return;}
  const raw=document.getElementById('pqAnsImportBox').dataset.parsed;
  if(!raw){toast('No answers to apply.');return;}
  const answers=JSON.parse(raw);
  let applied=0;
  answers.forEach((ans,i)=>{
    if(i>=bank.questions.length) return;
    if(ans===null) return;
    const ansIdx=ans.charCodeAt(0)-65;
    if(ansIdx>=0&&ansIdx<bank.questions[i].options.length){
      bank.questions[i].answer=ansIdx;
      applied++;
    }
  });
  saveDB();
  document.getElementById('pqAnsImportModal').classList.remove('open');
  renderPQBanks();
  toast(`âœ“ ${applied} answer${applied!==1?'s':''} imported into "${bank.title}"`);}



function escHtml(s){ const d=document.createElement('div');d.textContent=s||'';return d.innerHTML; }

// ============================================================
// PAST QUESTIONS â€” IMPORT
// ============================================================
function openPQImport(){
  const sel=document.getElementById('pqBankCourse');
  sel.innerHTML=db.courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
  document.getElementById('pqPasteBox').value='';
  document.getElementById('pqPreviewSection').style.display='none';
  document.getElementById('pqAIAnswerSection').style.display='none';
  document.getElementById('pqBankTitle').value='';
  document.getElementById('pqBankYear').value=new Date().getFullYear();
  document.getElementById('pqAIStatus').className='pq-ai-status';
  document.getElementById('pqAIAnswerStatus').className='pq-ai-status';
  document.getElementById('pqDocStatus').style.display='none';
  document.getElementById('pqDocIco').textContent='ðŸ“';
  document.getElementById('pqDocTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
  switchPQTab('paste');
  _parsedQuestions=[];
  openModal('pqImportModal');
}

let _parsedQuestions=[];

function parsePQText(raw){
  if(!raw||!raw.trim()) return [];
  const questions=[];

  // â”€â”€ Strategy 1: Split by numbered question starters (most common format)
  // Matches: "1.", "1)", "Q1.", "Q1)", "Question 1.", etc. at start of line
  const qStartRx=/^(?:Q(?:uestion)?\s*)?(\d+)[\.\)]\s+/im;
  if(qStartRx.test(raw)){
    // Split on lines that start a new question number
    const parts=raw.split(/(?=^(?:Q(?:uestion)?\s*)?\d+[\.\)]\s)/im).map(s=>s.trim()).filter(Boolean);
    for(const part of parts){
      const q=_parseSingleBlock(part);
      if(q) questions.push(q);
    }
    if(questions.length) return questions;
  }

  // â”€â”€ Strategy 2: Split by blank lines
  const blocks=raw.split(/\n{2,}/).map(b=>b.trim()).filter(Boolean);
  for(const block of blocks){
    const q=_parseSingleBlock(block);
    if(q) questions.push(q);
  }
  if(questions.length) return questions;

  // â”€â”€ Strategy 3: Try the whole text as a continuous stream line by line
  const streamQ=_parseStream(raw);
  return streamQ;
}

function _parseSingleBlock(block){
  const lines=block.split('\n').map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return null;

  let questionLines=[];
  let options=[];
  let answer=null;
  let explanation='';
  let i=0;

  // First line: strip leading question number/label
  const firstLine=lines[0]
    .replace(/^(?:Q(?:uestion)?\s*)?\d+[\.\)]\s*/i,'')
    .replace(/^Q\s*:\s*/i,'')
    .trim();
  if(firstLine) questionLines.push(firstLine);
  i=1;

  while(i<lines.length){
    const line=lines[i];

    // Answer key line: "Answer: C", "Ans: B", "Correct Answer: A", "Key: D", "ANS: C"
    const ansMatch=line.match(/^(?:answer|ans(?:wer)?|correct\s*answer|key|ans\.?)[\s:\-]+([A-Ea-e])\b/i);
    if(ansMatch){
      answer=ansMatch[1].toUpperCase().charCodeAt(0)-65;
      i++; continue;
    }

    // Explanation line
    const expMatch=line.match(/^(?:explanation|explanations?|note|reason|rationale|solution)[\s:\-]+(.+)/i);
    if(expMatch){ explanation=expMatch[1]; i++; continue; }

    // Option pattern: A. / A) / (A) / *A. / *A) / a. / a) â€” with optional asterisk for correct
    const optMatch=line.match(/^(\*?)\(?([A-Ea-e])\)?[\.\)]\s*(.+)/);
    if(optMatch){
      const isCorrect=optMatch[1]==='*';
      options.push(optMatch[3]);
      if(isCorrect) answer=options.length-1;
      i++; continue;
    }

    // Option numbered variant: "1." "2." as options (rare)
    // If options already started, append to last option
    if(options.length>0 && !line.match(/^(?:Q(?:uestion)?\s*)?\d+[\.\)]\s/i)){
      options[options.length-1]+=' '+line; i++; continue;
    }

    // Otherwise it's a continuation of the question text
    if(!options.length) questionLines.push(line);
    i++;
  }

  const question=questionLines.join(' ').trim();
  if(!question) return null;
  // Accept even questions with 1 option (some formats list only choices)
  if(options.length<2) return null;

  return {
    id:'q_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
    question, options, answer, explanation
  };
}

function _parseStream(raw){
  // Line-by-line state machine for when there's no blank line separation
  const lines=raw.split('\n').map(l=>l.trim()).filter(Boolean);
  const questions=[];
  let cur=null;

  const flush=()=>{
    if(cur && cur.question && cur.options.length>=2){
      questions.push({
        id:'q_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
        question:cur.question, options:cur.options, answer:cur.answer, explanation:cur.explanation||''
      });
    }
    cur=null;
  };

  for(const line of lines){
    // New question starts
    const qMatch=line.match(/^(?:Q(?:uestion)?\s*)?(\d+)[\.\)]\s+(.+)/i);
    if(qMatch){ flush(); cur={question:qMatch[2].trim(),options:[],answer:null,explanation:''}; continue; }

    if(!cur) continue;

    const ansMatch=line.match(/^(?:answer|ans(?:wer)?|correct\s*answer|key)[\s:\-]+([A-Ea-e])\b/i);
    if(ansMatch){ cur.answer=ansMatch[1].toUpperCase().charCodeAt(0)-65; continue; }

    const expMatch=line.match(/^(?:explanation|note|reason|rationale)[\s:\-]+(.+)/i);
    if(expMatch){ cur.explanation=expMatch[1]; continue; }

    const optMatch=line.match(/^(\*?)\(?([A-Ea-e])\)?[\.\)]\s*(.+)/);
    if(optMatch){
      const isCorrect=optMatch[1]==='*';
      cur.options.push(optMatch[3]);
      if(isCorrect) cur.answer=cur.options.length-1;
      continue;
    }

    // Continuation of question if no options yet
    if(!cur.options.length) cur.question+=' '+line;
    else cur.options[cur.options.length-1]+=' '+line;
  }
  flush();
  return questions;
}

function savePQBank(){
  const title=(document.getElementById('pqBankTitle').value||'').trim();
  const year=(document.getElementById('pqBankYear').value||'').trim();
  const courseId=document.getElementById('pqBankCourse').value;
  const type=document.getElementById('pqBankType').value;

  if(!title){ toast('Please enter a bank title.'); document.getElementById('pqBankTitle').focus(); return; }
  if(!_parsedQuestions.length){ toast('No questions found. Check your format.'); return; }

  const bank={
    id:'pqb_'+Date.now(),
    title, year, courseId, type,
    questions:_parsedQuestions,
    createdBy:currentUser.name||currentUser.username||'Unknown',
    createdAt:new Date().toLocaleDateString()
  };
  if(!db.pastQuestions) db.pastQuestions=[];
  db.pastQuestions.unshift(bank);
  saveDB();
  closeModal('pqImportModal');
  renderPQBanks();
  toast(`${_parsedQuestions.length} questions imported into "${title}" âœ“`);
  _parsedQuestions=[];
}

// ============================================================
// QUIZ ENGINE â€” DUAL MODE
// ============================================================
let qz={bank:null,mode:'exam',questions:[],current:0,answers:{},reviewed:false,startTime:null,timerInterval:null};

function startQuiz(bankId,mode){
  const bank=db.pastQuestions.find(b=>b.id===bankId);
  if(!bank){ toast('Bank not found.'); return; }
  qz.bank=bank; qz.mode=mode;
  qz.questions=[...bank.questions];
  qz.current=0; qz.answers={}; qz.reviewed=false;
  qz.startTime=Date.now();

  // Set mode pill + progress fill class
  const modePill=document.getElementById('quizModePill');
  modePill.textContent=mode==='exam'?'ðŸŽ¯ EXAM MODE':'ðŸ“– STUDY MODE';
  modePill.className='quiz-mode-pill '+(mode==='exam'?'exam':'study');
  document.getElementById('quizProgFill').className='quiz-progress-fill '+(mode==='exam'?'exam':'study');

  document.getElementById('quizTitle').textContent=bank.title;
  const co=db.courses.find(c=>c.id===bank.courseId);
  document.getElementById('quizSubtitle').textContent=(co?co.code+' Â· ':'')+(bank.year||'');

  // Footer end-exam btn only in exam mode
  const endBtn=document.getElementById('quizEndExamBtn');
  if(endBtn) endBtn.style.display=mode==='exam'?'':'none';

  document.getElementById('quizOverlay').classList.add('open');
  startTimer();
  renderQuizQuestion();
}

function startTimer(){
  clearInterval(qz.timerInterval);
  qz.timerInterval=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-qz.startTime)/1000);
    const m=String(Math.floor(elapsed/60)).padStart(2,'0');
    const s=String(elapsed%60).padStart(2,'0');
    const el=document.getElementById('quizTimer');
    el.textContent=`â± ${m}:${s}`;
  },1000);
}

function exitQuiz(){
  const hasWork=Object.keys(qz.answers).length>0;
  if(hasWork && !qz.reviewed){
    if(!confirm('Exit? Your progress will be lost.')) return;
  }
  clearInterval(qz.timerInterval);
  document.getElementById('quizOverlay').classList.remove('open');
  document.getElementById('quizResultOverlay').classList.remove('open');
  renderPQBanks();
}

function renderQuizQuestion(){
  const q=qz.questions[qz.current];
  const total=qz.questions.length;
  const idx=qz.current;
  const pct=Math.round(((idx+1)/total)*100);
  const mode=qz.mode;

  // Progress
  document.getElementById('quizProgLabel').textContent=`Q${idx+1} / ${total}`;
  document.getElementById('quizProgPct').textContent=pct+'%';
  document.getElementById('quizProgFill').style.width=pct+'%';

  // Buttons
  document.getElementById('quizPrevBtn').disabled=idx===0;
  const isLast=idx===total-1;
  document.getElementById('quizNextBtn').style.display=isLast?'none':'';
  const subBtn=document.getElementById('quizSubmitBtn');
  subBtn.style.display=isLast?'':'none';
  subBtn.className='quiz-submit-btn '+(mode==='exam'?'exam-sub':'study-sub');
  subBtn.textContent=mode==='exam'?'Submit Exam âœ“':'Finish âœ“';

  // Dot nav
  const dots=document.getElementById('quizDotNav');
  dots.innerHTML=qz.questions.map((_,i)=>{
    let cls='quiz-dot';
    if(i===idx) cls+=` current ${mode}`;
    else if(qz.reviewed){
      const a=qz.answers[i];
      if(a===undefined) cls='quiz-dot';
      else if(a===qz.questions[i].answer) cls+=' correct';
      else cls+=' wrong';
    } else if(qz.answers[i]!==undefined) cls+=` answered ${mode}`;
    return `<div class="${cls}" onclick="quizJump(${i})" title="Q${i+1}"></div>`;
  }).join('');

  // Card content
  const userAns=qz.answers[idx];
  const isAnswered=userAns!==undefined;
  const isReview=qz.reviewed;
  const showAnswer=(mode==='study' && isAnswered) || isReview; // study: show immediately; exam: only after review

  const optKeys=['A','B','C','D','E'];

  let bannerHtml='';
  if(isReview){
    bannerHtml=`<div class="review-banner">ðŸ“– Review Mode â€” correct answers are now revealed</div>`;
  } else if(mode==='exam' && !isReview){
    bannerHtml=`<div class="quiz-exam-hint">ðŸ”’ Exam Mode â€” answers hidden until you submit. You can change your selection anytime.</div>`;
  }

  const optHtml=q.options.map((opt,oi)=>{
    let optCls=`quiz-opt ${mode}-opt`;
    const hasAnswerKey = q.answer!==null && q.answer!==undefined;

    if(showAnswer){
      // Both modes after reveal: green=correct, red=wrong
      optCls+=' disabled';
      if(hasAnswerKey && oi===q.answer) optCls+=' correct';
      else if(oi===userAns && userAns!==q.answer) optCls+=' wrong';
      else if(oi===userAns && !hasAnswerKey) optCls+=' selected '+mode+'-opt';
    } else if(mode==='exam'){
      // Exam mode before submit: just show selection, no green/red
      if(oi===userAns) optCls+=' selected exam-opt';
    } else if(mode==='study' && isAnswered){
      // Study mode after answering: lock + green/red immediately
      optCls+=' disabled';
      if(hasAnswerKey && oi===q.answer) optCls+=' correct';
      else if(oi===userAns && oi!==q.answer) optCls+=' wrong';
      else if(oi===userAns && !hasAnswerKey) optCls+=' selected study-opt';
    } else if(oi===userAns){
      optCls+=' selected';
    }
    // Exam mode: allow changing before submit; Study mode: lock after first pick
    const canClick = !isReview && (mode==='exam' || !isAnswered);
    const clickHandler = canClick ? `onclick="selectOption(${oi})"` : '';
    return `<div class="${optCls}" style="animation-delay:${oi*.07}s;opacity:0" ${clickHandler}>
      <div class="quiz-opt-key">${optKeys[oi]}</div>
      <div class="quiz-opt-text">${escHtml(opt)}</div>
    </div>`;
  }).join('');

  let feedbackHtml='';
  if(showAnswer && userAns!==undefined){
    const isCorrect=userAns===q.answer;
    if(isCorrect){
      feedbackHtml=`<div class="quiz-feedback correct-fb">âœ… <strong>Correct!</strong>${q.explanation?' â€” '+escHtml(q.explanation):''}</div>`;
    } else {
      const correctTxt=q.answer!==null&&q.answer!==undefined?` Correct answer: <strong>${optKeys[q.answer]}. ${escHtml(q.options[q.answer]||'')}</strong>`:'';
      feedbackHtml=`<div class="quiz-feedback wrong-fb">âŒ <strong>Wrong.</strong>${correctTxt}${q.explanation?'<br>ðŸ’¡ '+escHtml(q.explanation):''}</div>`;
    }
  } else if(showAnswer && userAns===undefined && q.answer!==null&&q.answer!==undefined){
    feedbackHtml=`<div class="quiz-feedback reveal-fb">â­ Skipped. Correct answer: <strong>${optKeys[q.answer]}. ${escHtml(q.options[q.answer]||'')}</strong></div>`;
  }

  // In study mode if answered, auto-generate answer via AI if answer is null
  document.getElementById('quizCard').innerHTML=`
    ${bannerHtml}
    <div class="quiz-qnum">
      <span class="quiz-qnum-badge ${mode}">Q${idx+1}</span>
      ${idx+1} of ${total}
    </div>
    <div class="quiz-question">${escHtml(q.question)}</div>
    <div class="quiz-options">${optHtml}</div>
    ${feedbackHtml}
  `;
  document.getElementById('quizBody').scrollTop=0;
}

function selectOption(oi){
  if(qz.reviewed) return;
  // Study mode: lock after first answer; Exam mode: allow changing
  if(qz.mode==='study' && qz.answers[qz.current]!==undefined) return;
  qz.answers[qz.current]=oi;
  renderQuizQuestion();
  // Study mode: auto-advance after 1.4s if not last
  if(qz.mode==='study' && qz.current<qz.questions.length-1){
    setTimeout(()=>{
      if(!qz.reviewed && qz.answers[qz.current]!==undefined && qz.current<qz.questions.length-1) quizNav(1);
    },1400);
  }
}

function quizNav(dir){
  qz.current=Math.max(0,Math.min(qz.questions.length-1,qz.current+dir));
  renderQuizQuestion();
}
function quizJump(i){ qz.current=i; renderQuizQuestion(); }

function quizSubmit(){
  const total=qz.questions.length;
  const answered=Object.keys(qz.answers).length;
  const unanswered=total-answered;
  if(unanswered>0){
    if(!confirm(`You have ${unanswered} unanswered question${unanswered>1?'s':''}. Submit anyway?`)) return;
  }
  clearInterval(qz.timerInterval);
  qz.reviewed=true; // Mark reviewed so green/red shows during result review
  showQuizResult();
}

function endExamEarly(){
  if(!confirm('End exam early and see your results?')) return;
  clearInterval(qz.timerInterval);
  qz.reviewed=true;
  showQuizResult();
}

function showQuizResult(){
  const total=qz.questions.length;
  let correct=0, wrong=0, skipped=0;
  qz.questions.forEach((q,i)=>{
    const a=qz.answers[i];
    if(a===undefined) skipped++;
    else if(q.answer===null||q.answer===undefined) skipped++; // no answer key
    else if(a===q.answer) correct++;
    else wrong++;
  });
  const graded=total-qz.questions.filter((_,i)=>{
    const q=qz.questions[i];
    return qz.answers[i]!==undefined && (q.answer===null||q.answer===undefined);
  }).length;
  const pct=graded>0?Math.round((correct/graded)*100):0;
  recordAttempt(qz.bank.id+'_'+qz.mode, correct, graded, pct);

  const mode=qz.mode;
  const icon=pct>=80?'ðŸ†':pct>=60?'ðŸŽ‰':pct>=40?'ðŸ’ª':'ðŸ“š';
  const title=pct>=80?'Excellent!':pct>=60?'Good Job!':pct>=40?'Keep Practising!':'Study More!';

  document.getElementById('qrIcon').textContent=icon;
  document.getElementById('qrTitle').textContent=title;
  document.getElementById('qrModeBadge').textContent=mode==='exam'?'ðŸŽ¯ Exam Mode':'ðŸ“– Study Mode';
  document.getElementById('qrModeBadge').className='quiz-result-mode-badge '+(mode==='exam'?'exam':'study');
  document.getElementById('qrSub').textContent=`${qz.bank.title} Â· ${new Date().toLocaleDateString()}`;
  document.getElementById('qrPct').textContent=pct+'%';
  document.getElementById('qrCorrect').textContent=correct;
  document.getElementById('qrWrong').textContent=wrong;
  document.getElementById('qrSkipped').textContent=skipped;

  const ring=document.getElementById('qrRing');
  const ringColor=pct>=80?'rgba(52,211,153,.2)':pct>=60?'rgba(56,189,248,.2)':pct>=40?'rgba(251,191,36,.2)':'rgba(251,113,133,.15)';
  const ringBorder=pct>=80?'3px solid var(--accent3)':pct>=60?'3px solid var(--accent)':pct>=40?'3px solid #fbbf24':'3px solid var(--accent4)';
  ring.style.background=ringColor; ring.style.border=ringBorder;
  document.getElementById('qrPct').style.color=pct>=80?'var(--accent3)':pct>=60?'var(--accent)':pct>=40?'#fbbf24':'var(--accent4)';

  // Review button - always available after result
  document.getElementById('qrReviewBtn').className='quiz-result-btn '+(mode==='exam'?'primary-exam':'primary-study');
  document.getElementById('qrRetryExamBtn').style.display=mode==='exam'?'':'none';
  document.getElementById('qrRetryStudyBtn').style.display=mode==='study'?'':'none';

  document.getElementById('quizResultOverlay').classList.add('open');
}

function reviewQuiz(){
  // reviewed is already true from submit; close result panel and show questions with green/red
  document.getElementById('quizResultOverlay').classList.remove('open');
  qz.current=0;
  renderQuizQuestion();
}

function retryQuiz(mode){
  document.getElementById('quizResultOverlay').classList.remove('open');
  const bankId=qz.bank.id;
  const m=mode||qz.mode;
  qz.answers={}; qz.current=0; qz.reviewed=false; qz.mode=m;
  qz.startTime=Date.now();
  // Update pill
  const modePill=document.getElementById('quizModePill');
  modePill.textContent=m==='exam'?'ðŸŽ¯ EXAM MODE':'ðŸ“– STUDY MODE';
  modePill.className='quiz-mode-pill '+(m==='exam'?'exam':'study');
  document.getElementById('quizProgFill').className='quiz-progress-fill '+(m==='exam'?'exam':'study');
  const endBtn=document.getElementById('quizEndExamBtn');
  if(endBtn) endBtn.style.display=m==='exam'?'':'none';
  startTimer();
  renderQuizQuestion();
}

function closeQuizResult(){
  clearInterval(qz.timerInterval);
  document.getElementById('quizResultOverlay').classList.remove('open');
  document.getElementById('quizOverlay').classList.remove('open');
  renderPQBanks();
}

// ============================================================
// IMPORT â€” TAB SWITCHING
// ============================================================
function switchPQTab(tab){
  document.getElementById('pqPasteTab').style.display=tab==='paste'?'':'none';
  document.getElementById('pqDocTab').style.display=tab==='doc'?'':'none';
  document.getElementById('pqAITab').style.display=tab==='ai'?'':'none';
  document.getElementById('pqTabPaste').classList.toggle('active',tab==='paste');
  document.getElementById('pqTabDoc').classList.toggle('active',tab==='doc');
  document.getElementById('pqTabAI').classList.toggle('active',tab==='ai');
  if(tab!=='ai'&&tab!=='paste'){
    document.getElementById('pqPreviewSection').style.display='none';
    document.getElementById('pqAIAnswerSection').style.display='none';
  }
}

// ============================================================
// IMPORT â€” DOCUMENT UPLOAD (txt/pdf text extraction)
// ============================================================
function handlePQDocUpload(input){
  const file=input.files[0];
  if(!file) return;
  const status=document.getElementById('pqDocStatus');
  const drop=document.getElementById('pqDocIco');
  const txt=document.getElementById('pqDocTxt');
  status.style.display='block';
  status.textContent='Reading fileâ€¦';

  const ext=file.name.split('.').pop().toLowerCase();

  if(ext==='txt'){
    const reader=new FileReader();
    reader.onload=e=>{
      const raw=e.target.result;
      processDocText(raw, file.name);
      status.textContent=`âœ“ Loaded: ${file.name}`;
      drop.textContent='âœ…'; txt.innerHTML=`<strong>${file.name}</strong> loaded`;
    };
    reader.readAsText(file);
  } else if(ext==='pdf'){
    // Use PDF.js from CDN if available, else read as text
    status.textContent='Extracting text from PDFâ€¦';
    const reader=new FileReader();
    reader.onload=async e=>{
      try{
        // Try PDF.js
        const pdfjsLibRef=window.pdfjsLib||window['pdfjs-dist/build/pdf'];
        if(pdfjsLibRef){
          const pdf=await pdfjsLibRef.getDocument({data:e.target.result}).promise;
          let fullText='';
          for(let i=1;i<=pdf.numPages;i++){
            const page=await pdf.getPage(i);
            const content=await page.getTextContent();
            fullText+=content.items.map(it=>it.str).join(' ')+'\n';
          }
          processDocText(fullText, file.name);
          status.textContent=`âœ“ Extracted ${pdf.numPages} pages from ${file.name}`;
          drop.textContent='âœ…'; txt.innerHTML=`<strong>${file.name}</strong> â€” ${pdf.numPages} pages`;
        } else {
          status.textContent='âš  PDF.js not loaded. Use TXT or paste text directly.';
        }
      }catch(err){
        status.textContent='âš  Could not extract PDF text. Try a text-based PDF or use paste.';
      }
    };
    reader.readAsArrayBuffer(file);
  } else if(ext==='docx'||ext==='doc'){
    status.textContent='Extracting text from documentâ€¦';
    const reader=new FileReader();
    reader.onload=async e=>{
      try{
        if(window.mammoth){
          const result=await mammoth.extractRawText({arrayBuffer:e.target.result});
          processDocText(result.value, file.name);
          status.textContent=`âœ“ Extracted text from ${file.name}`;
          drop.textContent='âœ…'; txt.innerHTML=`<strong>${file.name}</strong> loaded`;
        } else {
          // Fallback: treat as text
          const text=new TextDecoder().decode(e.target.result).replace(/[^\x20-\x7E\n]/g,' ');
          processDocText(text, file.name);
          status.textContent=`âœ“ Loaded ${file.name} (basic extraction)`;
          drop.textContent='âœ…'; txt.innerHTML=`<strong>${file.name}</strong> loaded`;
        }
      }catch(err){
        status.textContent='âš  Could not extract document. Try a .txt file.';
      }
    };
    reader.readAsArrayBuffer(file);
  } else {
    status.textContent='âš  Unsupported file type. Use TXT, PDF, or DOCX.';
  }
}

function processDocText(text, filename){
  // Auto-fill title from filename
  const titleEl=document.getElementById('pqBankTitle');
  if(!titleEl.value) titleEl.value=filename.replace(/\.[^.]+$/,'');
  // Put text into paste box and parse
  document.getElementById('pqPasteBox').value=text;
  switchPQTab('paste');
  pqParseAndPreview();
}

// ============================================================
// IMPORT â€” PASTE PREVIEW
// ============================================================
function pqParseAndPreview(){
  const raw=document.getElementById('pqPasteBox').value;
  _parsedQuestions=parsePQText(raw);
  const section=document.getElementById('pqPreviewSection');
  const list=document.getElementById('pqPreviewList');
  const count=document.getElementById('pqPreviewCount');
  const err=document.getElementById('pqPreviewErr');
  const aiAns=document.getElementById('pqAIAnswerSection');

  if(!_parsedQuestions.length){ section.style.display='none'; aiAns.style.display='none'; return; }
  section.style.display='';
  count.textContent=`${_parsedQuestions.length} question${_parsedQuestions.length!==1?'s':''} parsed`;
  const noAns=_parsedQuestions.filter(q=>q.answer===null||q.answer===undefined).length;
  err.textContent=noAns?`âš  ${noAns} missing answers`:'âœ“ All answers present';
  err.style.color=noAns?'var(--accent4)':'var(--accent3)';

  // Show AI answer button only if some questions lack answers
  aiAns.style.display=noAns>0?'':'none';
  const aiAnswerTxtEl=document.getElementById('pqAIAnswerTxt');
  if(aiAnswerTxtEl) aiAnswerTxtEl.textContent=`âœ¨ Auto-Generate Answers Online (${noAns} missing)`;

  list.innerHTML=_parsedQuestions.slice(0,6).map((q,i)=>{
    const opts=q.options.map((o,oi)=>`<span class="pq-preview-opt${oi===q.answer?' correct':''}">${String.fromCharCode(65+oi)}. ${escHtml(o)}</span>`).join('');
    const ansLabel=q.answer!==null&&q.answer!==undefined
      ?`<span style="color:var(--accent3);font-size:10px;margin-left:4px;">âœ“ Ans:${String.fromCharCode(65+(q.answer||0))}</span>`
      :`<span style="color:var(--accent4);font-size:10px;margin-left:4px;">âš  No answer</span>`;
    return `<div class="pq-preview-q">
      <div class="pq-preview-qn">${i+1}. ${escHtml(q.question)}${ansLabel}</div>
      <div class="pq-preview-opts">${opts}</div>
    </div>`;
  }).join('') + (_parsedQuestions.length>6?`<div style="padding:10px 14px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">â€¦ and ${_parsedQuestions.length-6} more questions</div>`:'');
}

// ============================================================
// AI â€” GENERATE QUESTIONS FOR A COURSE
// ============================================================
async function aiGenerateQuestions(){
  const courseId=document.getElementById('pqBankCourse').value;
  const course=db.courses.find(c=>c.id===courseId);
  const topic=(document.getElementById('pqAITopic').value||'').trim();
  const type=document.getElementById('pqBankType').value;
  const typeLabel={exam:'final exam',test:'class test',mock:'mock exam'};
  const btn=document.getElementById('pqAIGenBtn');
  const statusEl=document.getElementById('pqAIStatus');

  btn.disabled=true;
  document.getElementById('pqAIBtnTxt').innerHTML=`<span class="pq-ai-spin"></span> Generating with AIâ€¦`;
  statusEl.className='pq-ai-status show';
  statusEl.innerHTML='ðŸ” Searching for relevant questions and generatingâ€¦';

  const courseName=course?course.title:'Nursing';
  const courseCode=course?course.code:'';
  const numQ=topic.match(/(\d+)\s*question/i)?parseInt(topic.match(/(\d+)\s*question/i)[1]):15;

  const prompt=`You are an expert nursing educator. Generate exactly ${numQ} multiple-choice past questions for a ${typeLabel[type]||'exam'} in ${courseName} (${courseCode}).
${topic?'Additional instructions: '+topic:''}

Requirements:
- Each question must be realistic nursing/medical examination style
- Provide exactly 4 options (A, B, C, D)  
- Mark the correct answer clearly
- Include a brief explanation

Output in this EXACT format (no other text, no markdown, no preamble):

1. [Question text]
A. [Option]
B. [Option]
*C. [Correct Option]
D. [Option]
Explanation: [Brief explanation]

[blank line between questions]

Generate all ${numQ} questions now:`;

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-sonnet-4-5-20251001',
        max_tokens:4000,
        messages:[{role:'user',content:prompt}]
      })
    });
    const data=await resp.json();
    const text=data.content.filter(c=>c.type==='text').map(c=>c.text).join('\n');

    if(!text.trim()){
      statusEl.innerHTML='âš  No response from AI. Check your network.';
      btn.disabled=false;
      document.getElementById('pqAIBtnTxt').textContent='âœ¨ Generate Questions with AI';
      return;
    }

    // Parse and populate
    _parsedQuestions=parsePQText(text);
    if(!_parsedQuestions.length){
      statusEl.innerHTML='âš  Could not parse AI output. Try again or use paste mode.';
    } else {
      // Auto-fill title
      const yr=document.getElementById('pqBankYear').value||new Date().getFullYear();
      if(!document.getElementById('pqBankTitle').value){
        document.getElementById('pqBankTitle').value=`${courseName} ${typeLabel[type]||'Questions'} ${yr}`;
      }
      // Show preview
      document.getElementById('pqPreviewSection').style.display='';
      const noAns=_parsedQuestions.filter(q=>q.answer===null||q.answer===undefined).length;
      document.getElementById('pqPreviewCount').textContent=`${_parsedQuestions.length} questions generated`;
      document.getElementById('pqPreviewErr').textContent=noAns?`âš  ${noAns} missing answers`:'âœ“ All answers included';
      document.getElementById('pqPreviewErr').style.color=noAns?'var(--accent4)':'var(--accent3)';
      document.getElementById('pqPreviewList').innerHTML=_parsedQuestions.slice(0,5).map((q,i)=>{
        const opts=q.options.map((o,oi)=>`<span class="pq-preview-opt${oi===q.answer?' correct':''}">${String.fromCharCode(65+oi)}. ${escHtml(o)}</span>`).join('');
        return `<div class="pq-preview-q"><div class="pq-preview-qn">${i+1}. ${escHtml(q.question)}</div><div class="pq-preview-opts">${opts}</div></div>`;
      }).join('') + (_parsedQuestions.length>5?`<div style="padding:10px 14px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">â€¦and ${_parsedQuestions.length-5} more</div>`:'');
      statusEl.innerHTML=`âœ… ${_parsedQuestions.length} questions generated successfully! Review above then click Save.`;
    }
  }catch(err){
    statusEl.innerHTML='âš  Network error. Check your internet connection.';
  }
  btn.disabled=false;
  document.getElementById('pqAIBtnTxt').textContent='âœ¨ Generate Questions with AI';
}

// ============================================================
// AI â€” GENERATE ANSWERS FOR QUESTIONS WITHOUT ANSWERS
// ============================================================
async function aiGenerateAnswers(){
  const missingAns=_parsedQuestions.filter(q=>q.answer===null||q.answer===undefined);
  if(!missingAns.length){ toast('All questions already have answers.'); return; }

  const btn=document.getElementById('pqAIAnswerBtn');
  const statusEl=document.getElementById('pqAIAnswerStatus');
  btn.disabled=true;
  document.getElementById('pqAIAnswerTxt').innerHTML=`<span class="pq-ai-spin"></span> Looking up answers onlineâ€¦`;
  statusEl.className='pq-ai-status show';
  statusEl.innerHTML=`Searching for correct answers to ${missingAns.length} questionsâ€¦`;

  const courseId=document.getElementById('pqBankCourse').value;
  const course=db.courses.find(c=>c.id===courseId);
  const courseName=course?course.title:'Nursing';

  const qBlock=missingAns.map((q,i)=>{
    const opts=q.options.map((o,oi)=>`${String.fromCharCode(65+oi)}. ${o}`).join('\n');
    return `Q${i+1}: ${q.question}\n${opts}`;
  }).join('\n\n');

  const prompt=`You are an expert in ${courseName}. For each question below, identify the correct answer and provide a brief explanation. Use web search if needed.

${qBlock}

For EACH question, respond ONLY in this exact format (one per line, no extra text):
Q1: [LETTER] | [Brief explanation]
Q2: [LETTER] | [Brief explanation]
...

Example:
Q1: C | The pancreas produces insulin through beta cells in the islets of Langerhans.
Q2: B | Normal adult resting heart rate is 60-100 beats per minute.`;

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-sonnet-4-5-20251001',
        max_tokens:2000,
        messages:[{role:'user',content:prompt}]
      })
    });
    const data=await resp.json();
    const text=data.content.filter(c=>c.type==='text').map(c=>c.text).join('\n');

    // Parse Q1: C | explanation format
    let filled=0;
    const lines=text.split('\n').filter(l=>l.trim());
    lines.forEach(line=>{
      const m=line.match(/Q(\d+):\s*([A-Ea-e])\s*\|\s*(.+)/i);
      if(m){
        const qIdx=parseInt(m[1])-1;
        const ansLetter=m[2].toUpperCase();
        const explanation=m[3].trim();
        if(qIdx>=0 && qIdx<missingAns.length){
          const ansIdx=ansLetter.charCodeAt(0)-65;
          missingAns[qIdx].answer=ansIdx;
          missingAns[qIdx].explanation=explanation;
          filled++;
        }
      }
    });

    if(filled>0){
      statusEl.innerHTML=`âœ… Filled ${filled} of ${missingAns.length} answers. Refreshing previewâ€¦`;
      pqParsePreviewFromParsed();
    } else {
      statusEl.innerHTML='âš  Could not parse AI answer format. Try again.';
    }
  }catch(err){
    statusEl.innerHTML='âš  Network error. Could not reach AI.';
  }
  btn.disabled=false;
  document.getElementById('pqAIAnswerTxt').textContent=`âœ¨ Auto-Generate Answers Online`;
}

function pqParsePreviewFromParsed(){
  const section=document.getElementById('pqPreviewSection');
  const list=document.getElementById('pqPreviewList');
  const count=document.getElementById('pqPreviewCount');
  const err=document.getElementById('pqPreviewErr');
  section.style.display='';
  const noAns=_parsedQuestions.filter(q=>q.answer===null||q.answer===undefined).length;
  count.textContent=`${_parsedQuestions.length} questions`;
  err.textContent=noAns?`âš  ${noAns} still missing answers`:'âœ“ All answers present';
  err.style.color=noAns?'var(--accent4)':'var(--accent3)';
  list.innerHTML=_parsedQuestions.slice(0,6).map((q,i)=>{
    const opts=q.options.map((o,oi)=>`<span class="pq-preview-opt${oi===q.answer?' correct':''}">${String.fromCharCode(65+oi)}. ${escHtml(o)}</span>`).join('');
    const ansLabel=q.answer!==null&&q.answer!==undefined
      ?`<span style="color:var(--accent3);font-size:10px;margin-left:4px;">âœ“ ${String.fromCharCode(65+(q.answer||0))}</span>`
      :`<span style="color:var(--accent4);font-size:10px;margin-left:4px;">âš  No answer</span>`;
    return `<div class="pq-preview-q"><div class="pq-preview-qn">${i+1}. ${escHtml(q.question)}${ansLabel}</div><div class="pq-preview-opts">${opts}</div></div>`;
  }).join('') + (_parsedQuestions.length>6?`<div style="padding:10px 14px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">â€¦and ${_parsedQuestions.length-6} more</div>`:'');
  if(noAns===0) document.getElementById('pqAIAnswerSection').style.display='none';
}
// On load: remove any previously auto-seeded ND2 student accounts
(function removeSeededStudents(){
  if(!db || !db.users) return;
  const seededIds = /^u_nd2_ca50_/;
  const before = db.users.length;
  db.users = db.users.filter(function(u){ return !seededIds.test(u.id); });
  if(db.users.length < before){ saveDB(); console.log('Removed ' + (before - db.users.length) + ' seeded ND2 accounts'); }
})();

</script>
<!-- ===== PAST QUESTIONS IMPORT MODAL ===== -->
<div class="overlay" id="pqImportModal">
  <div class="modal" style="max-width:700px;max-height:94vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ§  Import Past Questions</div>
      <button class="modal-x" onclick="closeModal('pqImportModal')">âœ•</button>
    </div>
    <div class="modal-bd pq-import-wrap">

      <!-- Import method tabs -->
      <div class="pq-import-tabs" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <div class="pq-import-tab active" id="pqTabPaste" onclick="switchPQTab('paste')">ðŸ“‹ Paste Text</div>
        <div class="pq-import-tab" id="pqTabDoc" onclick="switchPQTab('doc')">ðŸ“„ Document</div>
        <div class="pq-import-tab" id="pqTabAI" onclick="switchPQTab('ai')">âœ¨ AI Generate</div>
      </div>

      <!-- Bank metadata (always visible) -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
        <div class="form-g" style="margin:0">
          <label class="inp-label">Bank Title</label>
          <input class="inp" id="pqBankTitle" placeholder="e.g. Anatomy Final 2023" style="margin:0">
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Year</label>
          <input class="inp" id="pqBankYear" placeholder="e.g. 2023" style="margin:0">
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Course</label>
          <select class="sel" id="pqBankCourse"></select>
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Exam Type</label>
          <select class="sel" id="pqBankType">
            <option value="exam">Final Exam</option>
            <option value="test">Test / Quiz</option>
            <option value="mock">Mock Exam</option>
          </select>
        </div>
      </div>

      <!-- TAB: PASTE -->
      <div id="pqPasteTab">
        <div class="pq-import-info">
          â„¹ï¸ Paste questions one per blank-line block. Options: <code>A.</code> <code>B.</code> <code>C.</code> <code>D.</code><br>
          Mark correct answer with <code>*</code> prefix (e.g. <code>*C. Pancreas</code>) or on a new line: <code>Answer: C</code><br>
          Optional: <code>Explanation: â€¦</code> â€” or leave blank and use <strong>âœ¨ AI Generate Answers</strong> after import.
        </div>
        <div class="form-g">
          <label class="inp-label">Paste Questions</label>
          <textarea class="pq-paste-area" id="pqPasteBox" placeholder="1. Which organ produces insulin?
A. Liver
B. Kidney
*C. Pancreas
D. Stomach
Explanation: The pancreas beta cells produce insulin.

2. Normal adult heart rate range:
A. 40-60 bpm
*B. 60-100 bpm
C. 100-120 bpm
D. 120-140 bpm" oninput="pqParseAndPreview()"></textarea>
        </div>
      </div>

      <!-- TAB: DOCUMENT UPLOAD -->
      <div id="pqDocTab" style="display:none">
        <div class="pq-import-info">
          ðŸ“„ Upload a <code>.txt</code>, <code>.pdf</code>, or <code>.docx</code> file containing past questions. The system will extract text and auto-parse them into the same format as paste.
          For best results, ensure questions are numbered and options are on separate lines.
        </div>
        <div class="drop-area" id="pqDocDrop" onclick="document.getElementById('pqDocFile').click()" style="margin-bottom:12px;">
          <div class="drop-ico" id="pqDocIco">ðŸ“</div>
          <div class="drop-txt" id="pqDocTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
          <div class="drop-fmts">TXT Â· PDF (text-based) Â· DOCX</div>
        </div>
        <input type="file" id="pqDocFile" style="display:none" accept=".txt,.pdf,.docx,.doc" onchange="handlePQDocUpload(this)">
        <div id="pqDocStatus" style="display:none;font-size:12px;font-family:'DM Mono',monospace;color:var(--text2);padding:8px 12px;background:var(--bg3);border-radius:8px;margin-bottom:10px;"></div>
      </div>

      <!-- TAB: AI GENERATE -->
      <div id="pqAITab" style="display:none">
        <div class="pq-import-info">
          âœ¨ AI will search the internet and generate past-style exam questions for your selected course. Questions will include multiple-choice options and correct answers with explanations.
        </div>
        <div class="form-g">
          <label class="inp-label">Additional Topic / Instructions (optional)</label>
          <input class="inp" id="pqAITopic" placeholder="e.g. focus on cardiac anatomy, 2022 syllabus, 20 questions" style="margin-bottom:0;">
        </div>
        <button class="pq-ai-btn" id="pqAIGenBtn" onclick="aiGenerateQuestions()">
          <span id="pqAIBtnTxt">âœ¨ Generate Questions with AI</span>
        </button>
        <div class="pq-ai-status" id="pqAIStatus"></div>
      </div>

      <!-- Shared preview -->
      <div id="pqPreviewSection" style="display:none">
        <div class="pq-parse-preview">
          <div class="pq-preview-hd">
            <span id="pqPreviewCount">0 questions parsed</span>
            <span id="pqPreviewErr" style="color:var(--accent4)"></span>
          </div>
          <div id="pqPreviewList"></div>
        </div>
      </div>

      <!-- AI Answer generation for paste/doc questions without answers -->
      <div id="pqAIAnswerSection" style="display:none;margin-top:4px;">
        <button class="pq-ai-btn" id="pqAIAnswerBtn" onclick="aiGenerateAnswers()">
          <span id="pqAIAnswerTxt">âœ¨ Auto-Generate Answers Online (for missing answers)</span>
        </button>
        <div class="pq-ai-status" id="pqAIAnswerStatus"></div>
      </div>

      <button class="btn-submit" onclick="savePQBank()" style="background:linear-gradient(135deg,var(--accent2),var(--accent));margin-top:10px;">ðŸ’¾ Save Question Bank â†’</button>
    </div>
  </div>
</div>

<!-- ===== ANSWER IMPORT MODAL (admin only) ===== -->
<div class="overlay" id="pqAnsImportModal">
  <div class="modal" style="max-width:580px;max-height:88vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht" id="pqAnsImportTitle">ðŸ— Import Answers</div>
      <button class="modal-x" onclick="document.getElementById('pqAnsImportModal').classList.remove('open')">âœ•</button>
    </div>
    <div class="modal-bd">
      <div style="background:rgba(129,140,248,.07);border:1px solid rgba(129,140,248,.2);border-radius:10px;padding:11px 14px;font-size:11px;color:var(--accent2);font-family:'DM Mono',monospace;margin-bottom:16px;line-height:1.9;">
        ðŸ— Paste only the answer key â€” one answer per line (A / B / C / D / E).<br>
        Each line maps to the corresponding question number.<br>
        Accepted formats: &nbsp;<code>1. C</code> &nbsp;|&nbsp; <code>C</code> &nbsp;|&nbsp; <code>A,B,C,D,B,â€¦</code> &nbsp;|&nbsp; <code>A B C D B â€¦</code>
      </div>
      <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);margin-bottom:8px;" id="pqAnsImportCount"></div>
      <div class="form-g">
        <label class="inp-label">Paste Answer Key</label>
        <textarea class="pq-paste-area" id="pqAnsImportBox" placeholder="1. C&#10;2. A&#10;3. B&#10;4. D&#10;5. C&#10;â€¦&#10;&#10;Or space/comma separated:&#10;C A B D C A D B C A" oninput="pqAnsPreview()" style="min-height:160px;"></textarea>
      </div>
      <div id="pqAnsImportPreview" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent2);" id="pqAnsMatchCount"></span>
          <button class="btn-submit" id="pqAnsApplyBtn" onclick="applyPQAnswers()" style="width:auto;padding:9px 24px;background:linear-gradient(135deg,var(--accent2),var(--accent));" disabled>âœ“ Apply Answers</button>
        </div>
        <div class="pq-parse-preview" style="max-height:320px;overflow-y:auto;">
          <div class="pq-preview-hd" style="position:sticky;top:0;">
            <span>Preview â€” answers mapped to questions</span>
          </div>
          <div id="pqAnsImportPreviewBody"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== QUIZ OVERLAY ===== -->
<div class="quiz-overlay" id="quizOverlay">
  <div class="quiz-topbar">
    <button class="pv-back" onclick="exitQuiz()">â† Exit</button>
    <div class="quiz-mode-pill exam" id="quizModePill">ðŸŽ¯ EXAM MODE</div>
    <div class="quiz-title-block">
      <div class="quiz-title" id="quizTitle">Question Bank</div>
      <div class="quiz-subtitle" id="quizSubtitle"></div>
    </div>
    <div class="quiz-progress-bar-wrap">
      <div class="quiz-progress-label">
        <span id="quizProgLabel">Q1 / 10</span>
        <span id="quizProgPct">0%</span>
      </div>
      <div class="quiz-progress-bar"><div class="quiz-progress-fill exam" id="quizProgFill" style="width:0%"></div></div>
    </div>
    <div class="quiz-timer" id="quizTimer">â± 00:00</div>
  </div>
  <div class="quiz-body" id="quizBody">
    <div class="quiz-card" id="quizCard"></div>
  </div>
  <div class="quiz-footer">
    <button class="quiz-nav-btn" id="quizPrevBtn" onclick="quizNav(-1)" disabled>â† Prev</button>
    <div class="quiz-dot-nav" id="quizDotNav"></div>
    <button class="quiz-nav-btn" id="quizNextBtn" onclick="quizNav(1)">Next â†’</button>
    <button class="quiz-end-exam-btn" id="quizEndExamBtn" onclick="endExamEarly()">â›³ End Exam</button>
    <button class="quiz-submit-btn exam-sub" id="quizSubmitBtn" onclick="quizSubmit()" style="display:none">Submit Exam âœ“</button>
  </div>
</div>

<!-- ===== QUIZ RESULT OVERLAY ===== -->
<div class="quiz-result-overlay" id="quizResultOverlay">
  <div class="quiz-result-card">
    <div class="quiz-result-icon" id="qrIcon">ðŸŽ‰</div>
    <div class="quiz-result-mode-badge exam" id="qrModeBadge">ðŸŽ¯ Exam Mode</div>
    <div class="quiz-result-title" id="qrTitle">Quiz Complete!</div>
    <div class="quiz-result-sub" id="qrSub"></div>
    <div class="quiz-result-score-ring" id="qrRing">
      <div class="quiz-result-score-pct" id="qrPct">0%</div>
      <div class="quiz-result-score-lbl">Score</div>
    </div>
    <div class="quiz-result-breakdown">
      <div class="quiz-result-stat">
        <div class="quiz-result-stat-val" id="qrCorrect" style="color:var(--accent3)">0</div>
        <div class="quiz-result-stat-lbl">Correct</div>
      </div>
      <div class="quiz-result-stat">
        <div class="quiz-result-stat-val" id="qrWrong" style="color:var(--accent4)">0</div>
        <div class="quiz-result-stat-lbl">Wrong</div>
      </div>
      <div class="quiz-result-stat">
        <div class="quiz-result-stat-val" id="qrSkipped" style="color:var(--text2)">0</div>
        <div class="quiz-result-stat-lbl">Skipped</div>
      </div>
    </div>
    <div class="quiz-result-actions">
      <button class="quiz-result-btn ghost" onclick="closeQuizResult()">âœ• Close</button>
      <button class="quiz-result-btn primary-study" id="qrRetryStudyBtn" onclick="retryQuiz('study')">ðŸ“– Study Mode</button>
      <button class="quiz-result-btn primary-exam" id="qrRetryExamBtn" onclick="retryQuiz('exam')">â†º Retry Exam</button>
      <button class="quiz-result-btn ghost" id="qrReviewBtn" onclick="reviewQuiz()">ðŸ“‹ Review Answers</button>
    </div>
  </div>
</div>


<!-- CGPA SUMMARY MODAL -->
<div class="overlay" id="cgpaSummaryModal">
  <div class="modal" style="max-width:720px;max-height:90vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“ˆ Student CGPA Summary</div>
      <button class="modal-x" onclick="closeModal('cgpaSummaryModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <div id="cgpaSummaryContent"></div>
    </div>
  </div>
</div>
<!-- ===== DOCUMENT VAULT LOGIC ===== -->
<script>
// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFileIcon(name){
  const ext=(name||'').split('.').pop().toLowerCase();
  const m={pdf:'ðŸ“„',docx:'ðŸ“',doc:'ðŸ“',xlsx:'ðŸ“Š',xls:'ðŸ“Š',csv:'ðŸ“Š',pptx:'ðŸ“‘',ppt:'ðŸ“‘',png:'ðŸ–¼',jpg:'ðŸ–¼',jpeg:'ðŸ–¼',gif:'ðŸ–¼',webp:'ðŸ–¼',txt:'ðŸ“ƒ',mp4:'ðŸŽ¬',mp3:'ðŸŽµ'};
  return m[ext]||'ðŸ“Ž';
}
function fmtFileSize(bytes){
  if(bytes<1024) return bytes+'B';
  if(bytes<1024*1024) return (bytes/1024).toFixed(1)+'KB';
  return (bytes/(1024*1024)).toFixed(1)+'MB';
}
function docIconBg(name){
  const ext=(name||'').split('.').pop().toLowerCase();
  if(['pdf'].includes(ext)) return 'rgba(251,113,133,.15)';
  if(['docx','doc','txt'].includes(ext)) return 'rgba(56,189,248,.15)';
  if(['xlsx','xls','csv'].includes(ext)) return 'rgba(52,211,153,.15)';
  if(['png','jpg','jpeg','gif','webp'].includes(ext)) return 'rgba(251,191,36,.15)';
  return 'rgba(129,140,248,.15)';
}

// â”€â”€â”€ Render document list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMyDocVault(){
  const u=currentUser;
  const docs=u.documents||[];
  const list=document.getElementById('myDocVaultList');
  if(!docs.length){
    list.innerHTML=`<div class="doc-empty">ðŸ“­ No documents saved yet.<br>Upload your first document below.</div>`;
    return;
  }
  list.innerHTML=docs.map((d,i)=>`
    <div class="doc-vault-item" id="dvitem_${i}">
      <div class="doc-vault-icon" style="background:${docIconBg(d.name)}">${getFileIcon(d.name)}</div>
      <div style="flex:1;min-width:0;">
        <div class="doc-vault-name">${d.name}</div>
        <div class="doc-vault-meta">${fmtFileSize(d.size)} &nbsp;Â·&nbsp; ${d.date}</div>
      </div>
      <div class="doc-vault-actions">
        <button class="doc-vault-btn" onclick="previewDoc(${i})" title="View / Print">ðŸ‘ View</button>
        <button class="doc-vault-btn" onclick="downloadDoc(${i})" title="Download">â¬‡</button>
        <button class="doc-vault-btn danger" onclick="deleteDoc(${i})" title="Delete">ðŸ—‘</button>
      </div>
    </div>`).join('');
}

// â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleDocUpload(inp, target){
  const files=[...inp.files];
  if(!files.length) return;
  const maxSz=10*1024*1024;
  let ok=0;
  files.forEach(file=>{
    if(file.size>maxSz){toast(`${file.name} exceeds 10MB limit`);return;}
    const reader=new FileReader();
    reader.onload=e=>{
      const doc={
        name:file.name,
        type:file.type||'application/octet-stream',
        size:file.size,
        date:new Date().toLocaleDateString(),
        data:e.target.result
      };
      const u=db.users.find(x=>x.id===currentUser.id);
      if(!u.documents) u.documents=[];
      u.documents.push(doc);
      if(!currentUser.documents) currentUser.documents=[];
      currentUser.documents.push(doc);
      saveDB();
      renderMyDocVault();
      ok++;
      if(ok===files.filter(f=>f.size<=maxSz).length) toast(`${ok} document${ok>1?'s':''} uploaded âœ“`);
    };
    reader.readAsDataURL(file);
  });
  inp.value='';
}

// â”€â”€â”€ Drag-drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function docDragOver(e,zoneId){e.preventDefault();document.getElementById(zoneId).classList.add('drag-over');}
function docDragLeave(e,zoneId){document.getElementById(zoneId).classList.remove('drag-over');}
function docDrop(e,target){
  e.preventDefault();
  const zoneId=target==='me'?'myDocUploadZone':'myDocUploadZone';
  document.getElementById(zoneId).classList.remove('drag-over');
  const dt=e.dataTransfer;
  if(dt.files.length){
    const fakeInp=document.createElement('input');
    fakeInp.files=dt.files;
    handleDocUpload(fakeInp,'me');
  }
}

// â”€â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteDoc(idx){
  if(!confirm('Delete this document? This cannot be undone.')) return;
  const u=db.users.find(x=>x.id===currentUser.id);
  if(!u.documents) return;
  u.documents.splice(idx,1);
  currentUser.documents=[...u.documents];
  saveDB();
  renderMyDocVault();
  toast('Document deleted');
}

// â”€â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadDoc(idx){
  const docs=currentUser.documents||[];
  const d=docs[idx];
  if(!d) return;
  const a=document.createElement('a');
  a.href=d.data;
  a.download=d.name;
  a.click();
}

// â”€â”€â”€ Preview & Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _previewDoc=null;
function previewDoc(idx){
  const docs=currentUser.documents||[];
  const d=docs[idx];
  if(!d) return;
  _previewDoc=d;
  document.getElementById('docPreviewTitle').textContent=d.name;
  const body=document.getElementById('docPreviewBody');
  body.innerHTML='<div style="text-align:center;padding:40px;color:var(--text3);font-family:\'DM Mono\',monospace;">Loadingâ€¦</div>';
  document.getElementById('docPreviewModal').classList.add('open');

  const ext=(d.name||'').split('.').pop().toLowerCase();
  if(['png','jpg','jpeg','gif','webp'].includes(ext)){
    body.innerHTML=`<img src="${d.data}" style="max-width:100%;border-radius:8px;display:block;margin:auto;">`;
  } else if(ext==='pdf'){
    body.innerHTML=`<embed src="${d.data}" type="application/pdf" style="width:100%;height:70vh;border-radius:8px;">`;
  } else if(['docx','doc'].includes(ext)){
    // Use mammoth to render docx in browser
    const base64=d.data.split(',')[1];
    const bytes=Uint8Array.from(atob(base64),c=>c.charCodeAt(0));
    mammoth.convertToHtml({arrayBuffer:bytes.buffer}).then(r=>{
      body.innerHTML=`<div style="font-family:'Instrument Sans',sans-serif;line-height:1.7;padding:10px 20px;color:var(--text);max-width:700px;margin:auto;">${r.value}</div>`;
    }).catch(()=>{
      body.innerHTML=`<div class="doc-empty">âš  Cannot preview this file type.<br>Please download it to view.</div>`;
    });
  } else if(['txt'].includes(ext)){
    const base64=d.data.split(',')[1];
    const text=decodeURIComponent(escape(atob(base64)));
    body.innerHTML=`<pre style="font-family:'DM Mono',monospace;font-size:13px;line-height:1.6;color:var(--text);white-space:pre-wrap;padding:10px 20px;">${text.replace(/</g,'&lt;')}</pre>`;
  } else {
    body.innerHTML=`<div class="doc-empty" style="padding:60px;">${getFileIcon(d.name)}<br><br>Preview not available for this file type.<br><br><button class="doc-vault-btn" onclick="downloadDoc(${idx})" style="margin-top:10px;">â¬‡ Download to view</button></div>`;
  }
}

function closeDocPreview(){
  document.getElementById('docPreviewModal').classList.remove('open');
  _previewDoc=null;
}

function downloadDocPreview(){
  if(!_previewDoc) return;
  const a=document.createElement('a');
  a.href=_previewDoc.data;
  a.download=_previewDoc.name;
  a.click();
}

function printDocPreview(){
  if(!_previewDoc) return;
  const ext=(_previewDoc.name||'').split('.').pop().toLowerCase();
  const win=window.open('','_blank');
  if(!win) return toast('Pop-up blocked â€“ allow pop-ups to print');
  
  if(['png','jpg','jpeg','gif','webp'].includes(ext)){
    win.document.write(`<!DOCTYPE html><html><head><title>${_previewDoc.name}</title>
    <style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;}img{max-width:100%;}</style>
    </head><body><img src="${_previewDoc.data}" onload="window.print();window.close();">
</body></html>`);
  } else if(ext==='pdf'){
    win.document.write(`<!DOCTYPE html><html><head><title>${_previewDoc.name}</title>
    <style>body{margin:0;}embed{width:100vw;height:100vh;}</style>
    </head><body><embed src="${_previewDoc.data}" type="application/pdf"></body></html>`);
    setTimeout(()=>{try{win.print();}catch(e){}},1000);
  } else {
    const body=document.getElementById('docPreviewBody').innerHTML;
    win.document.write(`<!DOCTYPE html><html><head><title>${_previewDoc.name}</title>
    <style>body{font-family:sans-serif;max-width:800px;margin:30px auto;line-height:1.7;}@media print{body{margin:0;}}</style>
    </head><body>${body}<script>window.onload=()=>{window.print();window.close();}<\/script></body></html>`);
  }
  win.document.close();
}

// â”€â”€â”€ Close preview on backdrop click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('docPreviewModal').addEventListener('click',function(e){
  if(e.target===this) closeDocPreview();
});

// ============================================================
// MESSAGING SYSTEM
// ============================================================
/*
  THREAD TYPES:
  - "announce:<classId>"   â†’ Announcement â€” lecturers/admin post; ALL can REPLY
  - "classgroup:<classId>" â†’ Class group â€” all students + lecturers + admin can post
  - "dm:<idA>:<idB>"       â†’ Direct message

  PERMISSIONS:
  - Students:  reply in announce, send in classgroup, DM any student/lecturer (NOT admin)
  - Lecturers: post in announce/classgroup, DM anyone (students, lecturers, admin), send files
  - Admin:     post in announce/classgroup, DM lecturers freely, send files
  - Files:     any user who can send text can send any file type
  - Voice:     any user who can send text can record and send voice messages
*/

let activeThreadId = null;
let msgPollInterval = null;
let _mediaRecorder = null;
let _audioChunks = [];
let _recTimerInterval = null;
let _recSeconds = 0;
let _currentAudio = null;
let _currentPlayBtnId = null;

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dmThreadId(a, b){ return 'dm:'+[a,b].sort().join(':'); }
function myId(){ return currentUser.id||'admin'; }
function escHtml(t){ return (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s){ return (s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function fmtSize(b){ if(!b) return ''; if(b<1024) return b+'B'; if(b<1048576) return (b/1024).toFixed(1)+'KB'; return (b/1048576).toFixed(1)+'MB'; }
function fmtDur(s){ if(!s) return '0:00'; const m=Math.floor(s/60); return m+':'+(s%60<10?'0':'')+Math.floor(s%60); }
function fileIcon(name){
  const e=(name||'').split('.').pop().toLowerCase();
  const m={pdf:'ðŸ“„',doc:'ðŸ“',docx:'ðŸ“',xls:'ðŸ“Š',xlsx:'ðŸ“Š',csv:'ðŸ“Š',ppt:'ðŸ“‘',pptx:'ðŸ“‘',
    txt:'ðŸ“ƒ',zip:'ðŸ—œ',rar:'ðŸ—œ',mp4:'ðŸŽ¬',mp3:'ðŸŽµ',wav:'ðŸŽµ',mov:'ðŸŽ¬',avi:'ðŸŽ¬'};
  return m[e]||'ðŸ“Ž';
}
function fmtMsgTime(ts){
  const now=Date.now(),d=new Date(ts),diff=now-ts;
  if(diff<60000) return 'just now';
  if(diff<3600000) return Math.floor(diff/60000)+'m ago';
  if(diff<86400000) return d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
  return d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
}

// â”€â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAllUsers(){
  const admin={id:'admin',name:(typeof ADMIN_NAME!=='undefined'?ADMIN_NAME:'Administrator'),
    username:'admin',role:'admin',cls:'All',avatar:db.adminAvatar||'',matric:''};
  return [admin,...(db.users||[])];
}

// â”€â”€â”€ Permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function canSendIn(threadId){
  if(!threadId) return false;
  // All logged-in users can send in any channel/DM they are part of
  if(threadId.startsWith('announce:')||threadId.startsWith('classgroup:')){
    return true; // everyone can post in all class channels
  }
  if(threadId.startsWith('dm:')){
    // Only the two participants of a DM thread can send in it
    const parts=threadId.split(':').slice(1);
    return parts.includes(myId());
  }
  return false;
}

function canSeeThread(threadId){
  // All users can see all class channels and their own DMs
  if(threadId.startsWith('announce:')||threadId.startsWith('classgroup:')){
    return true;
  }
  if(threadId.startsWith('dm:')){
    return threadId.split(':').slice(1).includes(myId());
  }
  return false;
}

// â”€â”€â”€ Thread list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMyThreads(){
  if(!db.messages) db.messages=[];
  const role=currentRole, myClassId=currentUser.classId||'';
  const threads={};
  db.messages.forEach(m=>{
    const tid=m.threadId;
    if(!canSeeThread(tid)) return;
    if(!threads[tid]) threads[tid]={threadId:tid,messages:[],lastMsg:null};
    threads[tid].messages.push(m);
    if(!threads[tid].lastMsg||m.timestamp>threads[tid].lastMsg.timestamp)
      threads[tid].lastMsg=m;
  });
  // Ensure structural channels always show (even empty)
  const classes=db.classes||[];
  if(role==='teacher'||role==='admin'){
    classes.forEach(cl=>{
      ['announce:'+cl.id,'classgroup:'+cl.id].forEach(tid=>{
        if(!threads[tid]) threads[tid]={threadId:tid,messages:[],lastMsg:null};
      });
    });
  } else {
    // Students see ALL class channels (not just their own)
    classes.forEach(cl=>{
      ['announce:'+cl.id,'classgroup:'+cl.id].forEach(tid=>{
        if(!threads[tid]) threads[tid]={threadId:tid,messages:[],lastMsg:null};
      });
    });
  }
  // Also include any explicitly opened DM threads (even if no messages yet)
  const openedDMs = db.dmThreads || [];
  openedDMs.forEach(tid=>{
    if(canSeeThread(tid) && !threads[tid]){
      threads[tid]={threadId:tid,messages:[],lastMsg:null};
    }
  });
  const seen=new Set();
  return Object.values(threads).filter(t=>{
    if(seen.has(t.threadId)) return false; seen.add(t.threadId); return true;
  });
}

// â”€â”€â”€ Thread metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function threadMeta(thread){
  const tid=thread.threadId||thread;
  const allU=getAllUsers();
  if(tid.startsWith('announce:')){
    const cl=(db.classes||[]).find(c=>c.id===tid.split(':')[1]);
    return {name:`ðŸ“¢ ${cl?cl.name:'Class'} â€” Announcements`,
      sub:cl?`Lecturer announcements Â· ${cl.full}`:'Announcements',
      icon:'ðŸ“¢',bg:'rgba(251,113,133,.12)',isGroup:true,isAnnounce:true};
  }
  if(tid.startsWith('classgroup:')){
    const cl=(db.classes||[]).find(c=>c.id===tid.split(':')[1]);
    return {name:`ðŸ‘¥ ${cl?cl.name:'Class'} â€” Group Chat`,
      sub:cl?`Class group Â· ${cl.full}`:'Class group',
      icon:'ðŸ‘¥',bg:'rgba(52,211,153,.12)',isGroup:true,isAnnounce:false};
  }
  if(tid.startsWith('dm:')){
    const otherId=tid.split(':').slice(1).find(p=>p!==myId());
    let other=allU.find(u=>u.id===otherId);
    if(!other){
      // Fallback: try to get name from last message sent by the other person
      const lastMsgByOther=(db.messages||[]).filter(m=>m.threadId===tid&&m.senderId===otherId).slice(-1)[0];
      const fallbackName=lastMsgByOther?lastMsgByOther.senderName:otherId||'Unknown';
      other={name:fallbackName,avatar:'',role:'student',matric:''};
    }
    const dn=other.name||other.username||'User';
    const clsName=other.role==='student'&&other.classId
      ?((db.classes||[]).find(c=>c.id===other.classId)||{}).name||'':'';
    const roleLabel=other.role==='teacher'?'Lecturer':other.role==='admin'?'Administrator'
      :`Student${clsName?' Â· '+clsName:''}${other.matric?' Â· '+other.matric:''}`;
    const label=other.role==='student'&&other.matric?`${dn} (${other.matric})`:dn;
    return {name:label,sub:roleLabel,icon:dn[0]?.toUpperCase()||'?',avatar:other.avatar||'',
      bg:other.role==='teacher'?'rgba(56,189,248,.15)':other.role==='admin'?'rgba(251,191,36,.15)':'rgba(129,140,248,.15)',
      isGroup:false,isAnnounce:false,otherId};
  }
  return {name:'Chat',sub:'',icon:'ðŸ’¬',bg:'var(--bg3)',isGroup:false,isAnnounce:false};
}

function countUnread(thread){
  return (thread.messages||[]).filter(m=>m.senderId!==myId()&&!(m.readBy||[]).includes(myId())).length;
}

// â”€â”€â”€ Sidebar render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMessaging(){
  if(!db.messages) db.messages=[];
  renderMsgChannels();
  renderClassmatesPanel();
  startMsgPoll();
}

function renderMsgChannels(filter=''){
  const threads=getMyThreads();
  const container=document.getElementById('msgChannelList');
  if(!container) return;
  threads.sort((a,b)=>{
    const ao=a.threadId.startsWith('announce:'),bo=b.threadId.startsWith('announce:');
    const ag=a.threadId.startsWith('classgroup:'),bg2=b.threadId.startsWith('classgroup:');
    if(ao&&!bo)return -1; if(!ao&&bo)return 1;
    if(ag&&!bg2)return -1; if(!ag&&bg2)return 1;
    return (b.lastMsg?b.lastMsg.timestamp:0)-(a.lastMsg?a.lastMsg.timestamp:0);
  });
  const f=(filter||'').toLowerCase();
  let annH='',grpH='',dmH='';
  threads.forEach(t=>{
    const meta=threadMeta(t);
    const lm=t.lastMsg;
    let preview='No messages yet';
    if(lm){
      const fn=(lm.senderName||lm.senderId||'User').split(' ')[0];
      if(lm.msgType==='file') preview=`${fn}: ðŸ“Ž ${lm.fileName||'File'}`;
      else if(lm.msgType==='voice') preview=`${fn}: ðŸŽ™ Voice message`;
      else if(lm.msgType==='image') preview=`${fn}: ðŸ–¼ Image`;
      else preview=`${fn}: ${(lm.text||'').slice(0,36)}${(lm.text||'').length>36?'â€¦':''}`;
    }
    if(f&&!meta.name.toLowerCase().includes(f)&&!preview.toLowerCase().includes(f)) return;
    const unread=countUnread(t);
    const av=meta.avatar?`<img src="${meta.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`:`<span>${meta.icon}</span>`;
    const ac=t.threadId===activeThreadId?'active':'';
    const item=`<div class="msg-channel-item ${ac}" onclick="openThread('${t.threadId}')">
      <div class="msg-channel-av" style="background:${meta.bg}">${av}</div>
      <div class="msg-channel-info">
        <div class="msg-channel-name">${meta.name}</div>
        <div class="msg-channel-preview">${escHtml(preview)}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;">
        <div class="msg-channel-time">${lm?fmtMsgTime(lm.timestamp):''}</div>
        ${unread?`<div class="msg-unread">${unread>9?'9+':unread}</div>`:''}
      </div>
    </div>`;
    if(t.threadId.startsWith('announce:')) annH+=item;
    else if(t.threadId.startsWith('classgroup:')) grpH+=item;
    else dmH+=item;
  });
  let html='';
  if(annH) html+=`<div class="msg-channel-group-label">ðŸ“¢ Announcements</div>${annH}`;
  if(grpH) html+=`<div class="msg-channel-group-label">ðŸ‘¥ Class Groups</div>${grpH}`;
  if(dmH) html+=`<div class="msg-channel-group-label">ðŸ’¬ Direct Messages</div>${dmH}`;
  if(!html) html=`<div style="text-align:center;padding:30px 20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">No conversations yet.<br>Tap ï¼‹ to start!</div>`;
  container.innerHTML=html;
  const total=threads.reduce((s,t)=>s+countUnread(t),0);
  const badge=document.getElementById('msgNavBadge');
  if(badge) badge.style.display=total?'inline-block':'none';
}

function filterMsgChannels(v){ renderMsgChannels(v); }

// â”€â”€â”€ Open thread â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openThread(threadId){
  activeThreadId=threadId;
  // Persist DM thread so it shows up on both sides even before first message
  if(threadId.startsWith('dm:')){
    if(!db.dmThreads) db.dmThreads=[];
    if(!db.dmThreads.includes(threadId)){
      db.dmThreads.push(threadId);
      saveDB();
    }
  }
  const meta=threadMeta({threadId});
  const avEl=document.getElementById('msgChatAv');
  avEl.style.background=meta.bg;
  avEl.innerHTML=meta.avatar?`<img src="${meta.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">`:`<span>${meta.icon}</span>`;
  document.getElementById('msgChatName').textContent=meta.name;
  document.getElementById('msgChatSub').textContent=meta.sub;
  const badge=document.getElementById('msgAnnounceBadge');
  badge.style.display=meta.isAnnounce?'inline-flex':'none';
  if(meta.isAnnounce) badge.textContent='ðŸ“¢ Announcement Channel';

  const canSend=canSendIn(threadId);
  const inputBar=document.getElementById('msgInputBar');
  const roNotice=document.getElementById('msgReadonlyNotice');
  // Students in announce channel: they can reply so always show input
  // The old "readonly" notice is only shown if canSend is false
  if(inputBar) inputBar.style.display=canSend?'flex':'none';
  if(roNotice) roNotice.style.display=canSend?'none':'flex';

  // Update placeholder
  const inp=document.getElementById('msgTextInp');
  if(inp){
    if(threadId.startsWith('announce:')&&currentRole==='student') inp.placeholder='Reply to announcementâ€¦';
    else if(threadId.startsWith('announce:')) inp.placeholder='Write an announcementâ€¦';
    else if(threadId.startsWith('classgroup:')) inp.placeholder='Message the groupâ€¦';
    else inp.placeholder='Type a messageâ€¦';
  }

  document.getElementById('msgEmptyState').style.display='none';
  document.getElementById('msgActiveChat').style.cssText='display:flex;flex-direction:column;height:100%;overflow:hidden;';
  renderMsgChannels(document.getElementById('msgSearchInp')?document.getElementById('msgSearchInp').value:'');
  markThreadRead(threadId);
  renderMsgBody(threadId);
  if(window.innerWidth<=640){
    document.getElementById('msgSidebarPane').classList.add('mobile-hidden');
    document.getElementById('msgBackBtn').style.display='flex';
  }
  // Update call buttons for current thread
  setTimeout(updateCallButtons, 50);
}

function msgGoBack(){
  document.getElementById('msgSidebarPane').classList.remove('mobile-hidden');
  document.getElementById('msgBackBtn').style.display='none';
  activeThreadId=null;
  document.getElementById('msgEmptyState').style.display='flex';
  document.getElementById('msgActiveChat').style.cssText='display:none;';
}

// â”€â”€â”€ Render messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMsgBody(threadId){
  if(!db.messages) db.messages=[];
  const msgs=db.messages.filter(m=>m.threadId===threadId).sort((a,b)=>a.timestamp-b.timestamp);
  // Restore fileData from separate storage for file/image/voice messages
  msgs.forEach(m=>{
    if(!m.fileData && (m.msgType==='file'||m.msgType==='image'||m.msgType==='voice')){
      const fd=loadMsgFileData(m.id);
      if(fd) m.fileData=fd;
    }
  });
  const body=document.getElementById('msgBody');
  if(!body) return;
  let html='', lastDate='';
  msgs.forEach(m=>{
    const d=new Date(m.timestamp);
    const ds=d.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'});
    if(ds!==lastDate){ html+=`<div class="msg-date-divider"><span>${ds}</span></div>`; lastDate=ds; }
    const isMine=m.senderId===myId();
    const isAnn=(m.senderRole==='teacher'||m.senderRole==='admin')&&threadId.startsWith('announce:')&&!isMine;
    const bubCls=isMine?'mine':isAnn?'lecture':'them';
    const avBg=m.senderRole==='admin'?'rgba(251,191,36,.2)':m.senderRole==='teacher'?'rgba(56,189,248,.2)':'rgba(52,211,153,.2)';
    const avC=m.senderAvatar?`<img src="${m.senderAvatar}">`:(m.senderName||'?')[0].toUpperCase();
    const ts=d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
    const roleTag=m.senderRole==='teacher'?` <span style="font-size:9px;opacity:.5;">(Lecturer)</span>`:m.senderRole==='admin'?` <span style="font-size:9px;opacity:.5;">(Admin)</span>`:'';
    const bubContent=buildBubble(m,bubCls,isMine);
    html+=`<div class="msg-bubble-wrap ${isMine?'mine':''}">
      <div class="msg-av-sm" style="background:${avBg}">${avC}</div>
      <div class="msg-bubble-col">
        ${!isMine?`<div class="msg-sender-name">${escHtml(m.senderName)}${roleTag}</div>`:''}
        ${bubContent}
        <div class="msg-bubble-time">${ts}</div>
      </div>
    </div>`;
  });
  if(!msgs.length) html=`<div class="msg-empty-state" style="flex:1;"><div style="font-size:36px;opacity:.3;">ðŸ’¬</div><div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);">No messages yet.</div></div>`;
  body.innerHTML=html; body.scrollTop=body.scrollHeight;
}

function buildBubble(m, bubCls, isMine){
  if(m.msgType==='image'){
    if(!m.fileData) return `<div class="msg-bubble ${bubCls}" style="opacity:.5;">ðŸ–¼ Image unavailable</div>`;
    return `<div class="msg-img-thumb" onclick="previewImg('${escAttr(m.fileData)}','${escAttr(m.fileName||'Image')}')">
      <img src="${m.fileData}" alt="${escHtml(m.fileName||'Image')}" style="max-width:220px;border-radius:12px;display:block;">
    </div>`;
  }
  if(m.msgType==='file'){
    if(!m.fileData) return `<div class="msg-bubble ${bubCls}" style="opacity:.5;">ðŸ“Ž ${escHtml(m.fileName||'File')} â€” unavailable</div>`;
    const ic=fileIcon(m.fileName);
    const bg=isMine?'rgba(255,255,255,.15)':'rgba(56,189,248,.1)';
    return `<div class="msg-file-bubble ${isMine?'mine':'them'}" onclick="downloadFile('${escAttr(m.fileData)}','${escAttr(m.fileName||'file')}')">
      <div class="msg-file-icon" style="background:${bg}">${ic}</div>
      <div class="msg-file-info">
        <div class="msg-file-name" style="${isMine?'color:#fff':''}">${escHtml(m.fileName||'File')}</div>
        <div class="msg-file-meta">${fmtSize(m.fileSize)} Â· tap to download</div>
      </div>
    </div>`;
  }
  if(m.msgType==='voice'){
    if(!m.fileData) return `<div class="msg-bubble ${bubCls}" style="opacity:.5;">ðŸŽ™ Voice message unavailable</div>`;
    const dur=fmtDur(m.voiceDuration);
    const pid='vp_'+m.id;
    const bars=Array.from({length:22},()=>`<div class="msg-voice-bar-item" style="height:${4+Math.floor(Math.random()*20)}px;background:${isMine?'rgba(255,255,255,.5)':'var(--accent)'};border-radius:2px;"></div>`).join('');
    const bubBg=isMine?`linear-gradient(135deg,var(--accent),var(--accent2))`:`var(--bg3)`;
    const bubBorder=isMine?'none':`1px solid var(--border)`;
    const playBg=isMine?'rgba(255,255,255,.25)':'var(--accent)';
    return `<div class="msg-voice-bubble" style="background:${bubBg};border:${bubBorder};">
      <button class="msg-voice-play" id="${pid}" style="background:${playBg};color:#fff;" onclick="toggleVoice('${escAttr(m.fileData)}','${pid}')">â–¶</button>
      <div class="msg-voice-bars">${bars}</div>
      <div class="msg-voice-dur" style="${isMine?'color:rgba(255,255,255,.6)':''}">${dur}</div>
    </div>`;
  }
  // Plain text
  return `<div class="msg-bubble ${bubCls}">${escHtml(m.text||'').replace(/\n/g,'<br>')}</div>`;
}

// â”€â”€â”€ Image preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function previewImg(src, name){
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:3000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;cursor:zoom-out;';
  ov.onclick=()=>document.body.removeChild(ov);
  ov.innerHTML=`<div style="font-size:12px;color:rgba(255,255,255,.6);font-family:'DM Mono',monospace;">${escHtml(name)}</div>
    <img src="${src}" style="max-width:90vw;max-height:80vh;border-radius:10px;object-fit:contain;" onclick="event.stopPropagation()">
    <button onclick="event.stopPropagation();downloadFile('${escAttr(src)}','${escAttr(name)}')" style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:13px;font-family:'Instrument Sans',sans-serif;">â¬‡ Download</button>`;
  document.body.appendChild(ov);
}
function downloadFile(data, name){
  const a=document.createElement('a'); a.href=data; a.download=name||'file'; a.click();
}

// â”€â”€â”€ Voice playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleVoice(src, btnId){
  const btn=document.getElementById(btnId);
  if(_currentAudio&&!_currentAudio.paused){
    _currentAudio.pause();
    const old=document.getElementById(_currentPlayBtnId||'');
    if(old) old.textContent='â–¶';
    if(btnId===_currentPlayBtnId){ _currentAudio=null; _currentPlayBtnId=null; return; }
  }
  _currentAudio=new Audio(src);
  _currentPlayBtnId=btnId;
  if(btn) btn.textContent='â¸';
  _currentAudio.play().catch(()=>{ if(btn) btn.textContent='â–¶'; });
  _currentAudio.onended=()=>{ if(btn) btn.textContent='â–¶'; _currentAudio=null; _currentPlayBtnId=null; };
}

// â”€â”€â”€ Send text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMessage(){
  if(!activeThreadId) return;
  const inp=document.getElementById('msgTextInp');
  const text=(inp.value||'').trim();
  if(!text) return;
  if(!canSendIn(activeThreadId)){ toast('You cannot send messages here.'); return; }
  pushMsg({threadId:activeThreadId,msgType:'text',text});
  inp.value=''; inp.style.height='auto';
}

// â”€â”€â”€ File attach â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMsgFileAttach(inp){
  if(!inp.files||!inp.files.length) return;
  if(!activeThreadId){ toast('Open a conversation first.'); inp.value=''; return; }
  if(!canSendIn(activeThreadId)){ toast('You cannot send files here.'); inp.value=''; return; }
  const MAX=20*1024*1024;
  Array.from(inp.files).forEach(file=>{
    if(file.size>MAX){ toast(`${file.name} is over 20 MB.`); return; }
    const rd=new FileReader();
    rd.onload=e=>{
      const isImg=/^image\//i.test(file.type);
      pushMsg({threadId:activeThreadId,msgType:isImg?'image':'file',
        fileData:e.target.result,fileName:file.name,fileSize:file.size,text:''});
    };
    rd.readAsDataURL(file);
  });
  inp.value='';
}

// â”€â”€â”€ Voice record â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ Voice Recording â€” 2-state: Record â†’ Preview â†’ Send â”€â”€â”€â”€â”€â”€
let _voiceBlob     = null;   // recorded audio blob
let _voiceDataURL  = null;   // base64 data url
let _voiceDuration = 0;      // seconds recorded
let _previewAudio  = null;   // Audio object for preview playback
let _previewRAF    = null;   // requestAnimationFrame handle
let _recordStream  = null;   // mic stream (so we can stop tracks)
let _voiceStaticWave = [];   // snapshot of waveform bars for preview

function startVoiceRecord(){
  if(!activeThreadId){ toast('Open a conversation first.'); return; }
  if(!canSendIn(activeThreadId)){ toast('You cannot send messages here.'); return; }
  if(!navigator.mediaDevices){ toast('Voice messages not supported in this browser.'); return; }

  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    _recordStream = stream;
    _audioChunks  = [];
    _recSeconds   = 0;
    _voiceBlob    = null;
    _voiceDataURL = null;
    _voiceStaticWave = [];

    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
               : MediaRecorder.isTypeSupported('audio/webm')             ? 'audio/webm'
               : 'audio/ogg';

    _mediaRecorder = new MediaRecorder(stream, {mimeType: mime});
    _mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) _audioChunks.push(e.data); };

    _mediaRecorder.onstop = () => {
      // Stop mic tracks
      if(_recordStream){ _recordStream.getTracks().forEach(t=>t.stop()); _recordStream=null; }
      if(_audioChunks.length === 0){ _hideRecBar(); return; }

      _voiceBlob = new Blob(_audioChunks, {type: mime});
      _voiceDuration = _recSeconds;

      // Convert to data URL so we can play and later send
      const rd = new FileReader();
      rd.onload = ev => {
        _voiceDataURL = ev.target.result;
        _hideRecBar();
        _showPreviewBar();
      };
      rd.onerror = () => { toast('Failed to process audio.'); _hideRecBar(); };
      rd.readAsDataURL(_voiceBlob);
    };

    _mediaRecorder.start(100);
    _showRecBar();

    _recTimerInterval = setInterval(()=>{
      _recSeconds++;
      const el = document.getElementById('msgRecTimer');
      if(el) el.textContent = fmtDur(_recSeconds);
      _animateRecWave();
      if(_recSeconds >= 180) stopRecordingForPreview(); // 3-min max
    }, 1000);

  }).catch(err => {
    let msg = 'Microphone access denied.';
    if(err.name==='NotAllowedError'||err.name==='PermissionDeniedError')
      msg = 'Microphone permission denied. Click the ðŸ”’ lock icon in your address bar â†’ allow Microphone â†’ reload.';
    else if(err.name==='NotFoundError')
      msg = 'No microphone found. Please connect a microphone and try again.';
    else if(err.name==='NotReadableError')
      msg = 'Microphone in use by another app. Close other apps and try again.';
    toast(msg);
  });
}

// Called by "Stop â– " button â€” stops recording, shows preview
function stopRecordingForPreview(){
  if(_mediaRecorder && _mediaRecorder.state !== 'inactive'){
    // Snapshot the current wave for the static preview display
    const bars = document.getElementById('msgRecWave');
    if(bars) _voiceStaticWave = Array.from(bars.children).map(b=>b.style.height);
    _mediaRecorder.stop();  // triggers _mediaRecorder.onstop â†’ _showPreviewBar
  }
}

// Cancel during recording
function cancelVoiceRecord(){
  if(_mediaRecorder && _mediaRecorder.state !== 'inactive'){
    _mediaRecorder.onstop = ()=>{};  // suppress preview
    _mediaRecorder.stop();
  }
  if(_recordStream){ _recordStream.getTracks().forEach(t=>t.stop()); _recordStream=null; }
  _hideRecBar();
}

function _showRecBar(){
  const rb = document.getElementById('msgRecordBar');
  const ib = document.getElementById('msgInputBar');
  const pv = document.getElementById('msgVoicePreviewBar');
  if(rb) rb.classList.add('active');
  if(ib) ib.style.display = 'none';
  if(pv) pv.style.display = 'none';
  const vb = document.getElementById('msgVoiceBtn');
  if(vb) vb.classList.add('rec-active');
}

function _hideRecBar(){
  const rb = document.getElementById('msgRecordBar');
  if(rb) rb.classList.remove('active');
  const vb = document.getElementById('msgVoiceBtn');
  if(vb) vb.classList.remove('rec-active');
  if(_recTimerInterval){ clearInterval(_recTimerInterval); _recTimerInterval=null; }
  const te = document.getElementById('msgRecTimer'); if(te) te.textContent='0:00';
  const we = document.getElementById('msgRecWave');  if(we) we.innerHTML='';
}

function _animateRecWave(){
  const wave = document.getElementById('msgRecWave');
  if(!wave || !_mediaRecorder || _mediaRecorder.state==='inactive') return;
  wave.innerHTML = Array.from({length:18}, ()=>
    `<div class="msg-rec-wave-bar" style="height:${4+Math.floor(Math.random()*24)}px;"></div>`
  ).join('');
}

// â”€â”€ Preview bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _showPreviewBar(){
  const pv = document.getElementById('msgVoicePreviewBar');
  const ib = document.getElementById('msgInputBar');
  if(!pv) return;
  pv.style.display = 'flex';
  if(ib) ib.style.display = 'none';

  // Draw static waveform snapshot in preview
  const waveEl = document.getElementById('voicePreviewWaveStatic');
  if(waveEl){
    if(_voiceStaticWave.length){
      waveEl.innerHTML = _voiceStaticWave.map(h=>
        `<div style="flex:1;border-radius:2px;background:#fb7185;opacity:.5;height:${h};"></div>`
      ).join('');
    } else {
      // Generate placeholder bars if we didn't catch any
      waveEl.innerHTML = Array.from({length:20},()=>
        `<div style="flex:1;border-radius:2px;background:#fb7185;opacity:.5;height:${4+Math.floor(Math.random()*22)}px;"></div>`
      ).join('');
    }
  }

  // Reset progress and timer
  const bar   = document.getElementById('voicePreviewBar');
  const timer = document.getElementById('voicePreviewTimer');
  if(bar)   bar.style.width='0%';
  if(timer) timer.textContent = fmtDur(_voiceDuration);

  // Reset play button
  const btn = document.getElementById('voicePreviewPlayBtn');
  if(btn) btn.textContent = 'â–¶';

  // Stop any previous preview audio
  _stopPreviewPlayback();
}

function _hidePreviewBar(){
  const pv = document.getElementById('msgVoicePreviewBar');
  if(pv) pv.style.display='none';
  _stopPreviewPlayback();
  // Restore input bar
  if(canSendIn(activeThreadId||'')){
    const ib = document.getElementById('msgInputBar');
    if(ib) ib.style.display='flex';
  }
  _voiceBlob    = null;
  _voiceDataURL = null;
  _voiceDuration= 0;
  _voiceStaticWave = [];
}

function _stopPreviewPlayback(){
  if(_previewAudio){
    _previewAudio.pause();
    _previewAudio = null;
  }
  if(_previewRAF){ cancelAnimationFrame(_previewRAF); _previewRAF=null; }
  const btn = document.getElementById('voicePreviewPlayBtn');
  if(btn) btn.textContent='â–¶';
}

// Play / Pause the preview
function toggleVoicePreview(){
  if(!_voiceDataURL){ toast('No audio to play.'); return; }

  if(_previewAudio && !_previewAudio.paused){
    // Pause
    _previewAudio.pause();
    const btn = document.getElementById('voicePreviewPlayBtn');
    if(btn) btn.textContent='â–¶';
    if(_previewRAF){ cancelAnimationFrame(_previewRAF); _previewRAF=null; }
    return;
  }

  if(!_previewAudio){
    _previewAudio = new Audio(_voiceDataURL);
    _previewAudio.onended = ()=>{
      const btn = document.getElementById('voicePreviewPlayBtn');
      if(btn) btn.textContent='â–¶';
      const bar = document.getElementById('voicePreviewBar');
      if(bar) bar.style.width='100%';
      if(_previewRAF){ cancelAnimationFrame(_previewRAF); _previewRAF=null; }
      _previewAudio = null;
    };
    _previewAudio.onerror = ()=>{ toast('Could not play audio. Try re-recording.'); _stopPreviewPlayback(); };
  }

  _previewAudio.play().then(()=>{
    const btn = document.getElementById('voicePreviewPlayBtn');
    if(btn) btn.textContent='â¸';
    _tickPreviewProgress();
  }).catch(()=>{ toast('Playback failed. Try re-recording.'); });
}

function _tickPreviewProgress(){
  if(!_previewAudio || _previewAudio.paused){ _previewRAF=null; return; }
  const dur  = _previewAudio.duration||_voiceDuration||1;
  const pct  = Math.min((_previewAudio.currentTime/dur)*100, 100);
  const bar  = document.getElementById('voicePreviewBar');
  const timer= document.getElementById('voicePreviewTimer');
  if(bar)   bar.style.width = pct+'%';
  if(timer) timer.textContent = fmtDur(Math.floor(_previewAudio.currentTime));
  _previewRAF = requestAnimationFrame(_tickPreviewProgress);
}

// Seek by clicking the progress bar
function seekVoicePreview(event){
  if(!_previewAudio && !_voiceDataURL) return;
  const el  = document.getElementById('voicePreviewProgress');
  if(!el)   return;
  const pct = event.offsetX / el.offsetWidth;

  if(!_previewAudio){
    _previewAudio = new Audio(_voiceDataURL);
    _previewAudio.onended = ()=>{
      const btn=document.getElementById('voicePreviewPlayBtn');
      if(btn) btn.textContent='â–¶';
      _previewAudio=null;
    };
  }
  _previewAudio.currentTime = pct * (_previewAudio.duration||_voiceDuration||0);
  const bar   = document.getElementById('voicePreviewBar');
  const timer = document.getElementById('voicePreviewTimer');
  if(bar)   bar.style.width = (pct*100)+'%';
  if(timer) timer.textContent = fmtDur(Math.floor(_previewAudio.currentTime));
}

// Re-record: hide preview, restart recording
function cancelVoicePreview(){
  _stopPreviewPlayback();
  _hidePreviewBar();
  // Small delay so UI settles before asking for mic again
  setTimeout(()=>startVoiceRecord(), 120);
}

// Send the previewed voice note
function sendVoicePreview(){
  if(!_voiceDataURL){ toast('No audio recorded.'); return; }
  if(!activeThreadId){ toast('No conversation selected.'); return; }
  if(!canSendIn(activeThreadId)){ toast('You cannot send messages here.'); return; }

  // Stop playback first
  _stopPreviewPlayback();

  // Capture these before hiding (which clears them)
  const dataURL  = _voiceDataURL;
  const duration = _voiceDuration;
  const threadId = activeThreadId;

  _hidePreviewBar();

  pushMsg({
    threadId : threadId,
    msgType  : 'voice',
    fileData : dataURL,
    voiceDuration: duration,
    text     : ''
  });
}

// Legacy alias (kept in case anything calls it)
function stopAndSendVoice(){ stopRecordingForPreview(); }

// â”€â”€â”€ Push message to db â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pushMsg(data){
  if(!db.messages) db.messages=[];
  const senderId = myId();
  const msgId='msg_'+Date.now()+'_'+Math.random().toString(36).slice(2);
  // Store file/voice data separately to avoid bloating main DB
  let fileDataRef = null;
  if(data.fileData){
    const ok = saveMsgFileData(msgId, data.fileData);
    if(!ok){ toast('Storage full \u2014 could not send. Try deleting old messages.'); return; }
    fileDataRef = data.fileData;
  }
  const msg = {
    id:msgId,
    threadId:data.threadId,
    senderId:senderId,
    senderName:currentUser.name||currentUser.username||'User',
    senderRole:currentRole,
    senderAvatar:currentUser.avatar||'',
    msgType:data.msgType||'text',
    text:data.text||'',
    fileData:fileDataRef,
    fileName:data.fileName||null,
    fileSize:data.fileSize||null,
    voiceDuration:data.voiceDuration||null,
    timestamp:Date.now(),
    readBy:[senderId]
  };
  db.messages.push(msg);
  saveDB();
  renderMsgBody(data.threadId);
  renderMsgChannels();
}

// â”€â”€â”€ Mark read â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function markThreadRead(threadId){
  if(!db.messages) return;
  let changed=false;
  db.messages.filter(m=>m.threadId===threadId&&!(m.readBy||[]).includes(myId())).forEach(m=>{
    if(!m.readBy) m.readBy=[];
    m.readBy.push(myId());
    changed=true;
  });
  if(changed) saveDB();
}

// â”€â”€â”€ New chat modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewChat(){
  const myUid=myId(), allU=getAllUsers();

  // â”€â”€ Channels section (teacher / admin only) â”€â”€
  const chanSection=document.getElementById('newChatGroupSection');
  const chanList=document.getElementById('newChatGroupList');
  if(currentRole==='teacher'||currentRole==='admin'){
    chanSection.style.display='block';
    const chans=[];
    (db.classes||[]).forEach(cl=>{
      chans.push({tid:'announce:'+cl.id,  icon:'ðŸ“¢', name:cl.name+' â€” Announcements', sub:'Broadcast to '+cl.full, bg:'rgba(251,113,133,.12)'});
      chans.push({tid:'classgroup:'+cl.id,icon:'ðŸ‘¥', name:cl.name+' â€” Group Chat',    sub:'Class group Â· '+cl.full, bg:'rgba(52,211,153,.12)'});
    });
    chanList.innerHTML=chans.map(g=>
      `<div class="msg-recipient-item" onclick="startChatWith('${g.tid}',true)">
        <div class="msg-recipient-av" style="background:${g.bg};font-size:16px;">${g.icon}</div>
        <div>
          <div style="font-size:13px;font-weight:600;">${g.name}</div>
          <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">${g.sub}</div>
        </div>
      </div>`
    ).join('');
  } else {
    chanSection.style.display='none';
  }

  // â”€â”€ Build full DM target list â”€â”€
  let targets=[];
  if(currentRole==='admin'){
    targets=allU.filter(u=>u.role==='teacher');
  } else if(currentRole==='teacher'){
    targets=allU.filter(u=>u.id!==myUid);
  } else {
    // Students can DM any student (any class) or any lecturer â€” NOT admin
    targets=allU.filter(u=>u.id!==myUid && u.role!=='admin');
  }

  const allTargets=targets.map(u=>({
    id:u.id, name:u.name||u.username||'', role:u.role,
    avatar:u.avatar||'', matric:u.matric||'', classId:u.classId||''
  }));

  // Store full list for filtering
  document.getElementById('newChatDmList').dataset.all=JSON.stringify(allTargets);

  // â”€â”€ Populate class dropdown â”€â”€
  const filterSel=document.getElementById('newChatClassFilter');
  const studentTargets=allTargets.filter(u=>u.role==='student');
  const classIds=[...new Set(studentTargets.map(u=>u.classId).filter(Boolean))];
  // Always show all available classes from db
  const classOptions=(db.classes||[]).map(c=>
    `<option value="${c.id}">${c.name} â€” ${c.full}</option>`
  ).join('');
  filterSel.innerHTML='<option value="">â€” All Classes â€”</option>'+classOptions;
  filterSel.value='';

  // â”€â”€ Reset search and render â”€â”€
  document.getElementById('newChatSearch').value='';
  applyNewChatFilters();
  openModal('newChatModal');
}

// â”€â”€ Apply both class-filter + search together â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyNewChatFilters(){
  const raw=document.getElementById('newChatDmList').dataset.all;
  if(!raw) return;
  let targets=JSON.parse(raw);

  // 1. Class filter
  const classSel=document.getElementById('newChatClassFilter');
  const classFilter=classSel ? classSel.value : '';
  if(classFilter){
    targets=targets.filter(u=> u.role!=='student' || u.classId===classFilter);
  }

  // 2. Text search
  const q=(document.getElementById('newChatSearch').value||'').trim().toLowerCase();
  if(q){
    const classMap=(db.classes||[]).reduce((m,c)=>{
      m[c.id]=(c.name+' '+c.full).toLowerCase(); return m;
    },{});
    targets=targets.filter(u=>
      (u.name||'').toLowerCase().includes(q) ||
      (u.matric||'').toLowerCase().includes(q) ||
      (classMap[u.classId]||'').includes(q)
    );
  }

  // 3. Show result count
  const countEl=document.getElementById('newChatResultCount');
  if(countEl){
    const total=targets.length;
    const classLabel=classFilter ? ((db.classes||[]).find(c=>c.id===classFilter)||{}).name||classFilter : 'all classes';
    countEl.textContent=total===0 ? 'No users found' : `${total} user${total!==1?'s':''} Â· ${classLabel}`;
  }

  renderNewChatDmList(targets);
}

// Keep old name as alias for any legacy calls
function filterNewChatList(q){ applyNewChatFilters(); }

function renderNewChatDmList(targets){
  const list=document.getElementById('newChatDmList');
  if(!list) return;
  if(!targets||!targets.length){
    list.innerHTML=`<div style="text-align:center;padding:24px 20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">No users found.<br>Try a different class or search term.</div>`;
    return;
  }

  const classSel=document.getElementById('newChatClassFilter');
  const filterVal=classSel ? classSel.value : '';

  const admins   =targets.filter(u=>u.role==='admin');
  const lecturers=targets.filter(u=>u.role==='teacher');
  const students =targets.filter(u=>u.role==='student');
  students.sort((a,b)=>(a.classId||'').localeCompare(b.classId||'')||(a.name||'').localeCompare(b.name||''));

  let html='';
  const hdr=(label)=>`<div style="font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);padding:10px 4px 4px;border-top:1px solid var(--border);margin-top:4px;">${label}</div>`;

  if(admins.length)    html+=hdr('ðŸ”‘ Admin')    +admins.map(dmItem).join('');
  if(lecturers.length) html+=hdr('ðŸ« Lecturers')+lecturers.map(dmItem).join('');

  if(students.length){
    // If a specific class is chosen or only 1 class â€” flat list under "Students"
    const classIds=[...new Set(students.map(u=>u.classId).filter(Boolean))];
    if(filterVal || classIds.length<=1){
      const cls=(db.classes||[]).find(c=>c.id===(filterVal||classIds[0]));
      const label=cls ? `ðŸŽ“ ${cls.name} â€” ${cls.full}` : 'ðŸŽ“ Students';
      html+=hdr(label)+students.map(dmItem).join('');
    } else {
      // Multiple classes â€” group by class
      classIds.forEach(cid=>{
        const cls=(db.classes||[]).find(c=>c.id===cid);
        const label=cls ? `ðŸŽ“ ${cls.name} â€” ${cls.full}` : 'ðŸŽ“ '+cid;
        const group=students.filter(u=>u.classId===cid);
        if(group.length) html+=hdr(label)+group.map(dmItem).join('');
      });
      const noClass=students.filter(u=>!u.classId);
      if(noClass.length) html+=hdr('ðŸŽ“ Students (no class)')+noClass.map(dmItem).join('');
    }
  }

  list.innerHTML=html;
}

function dmItem(u){
  const cls=(db.classes||[]).find(c=>c.id===u.classId);
  const clsName=cls?cls.name:u.classId||'';
  const sub=u.role==='teacher'?'Lecturer':u.role==='admin'?'Administrator'
    :`Student${clsName?' Â· '+clsName:''}${u.matric?' Â· '+u.matric:''}`;
  const avBg=u.role==='teacher'?'rgba(56,189,248,.2)':u.role==='admin'?'rgba(251,191,36,.2)':'rgba(129,140,248,.2)';
  const avC=u.avatar
    ?`<img src="${u.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`
    :(u.name||'?')[0].toUpperCase();
  const nm=u.matric
    ?`${escHtml(u.name)} <span style="font-size:10px;opacity:.5;">(${escHtml(u.matric)})</span>`
    :escHtml(u.name||u.id);
  return `<div class="msg-recipient-item" onclick="startChatWith('${u.id}',false)" style="cursor:pointer;">
    <div class="msg-recipient-av" style="background:${avBg}">${avC}</div>
    <div style="flex:1;min-width:0;">
      <div style="font-size:13px;font-weight:600;">${nm}</div>
      <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">${escHtml(sub)}</div>
    </div>
  </div>`;
}

function startChatWith(targetId, isChannel){
  closeModal('newChatModal');
  const tid=isChannel?targetId:dmThreadId(myId(),targetId);
  navGo('messages');
  setTimeout(()=>openThread(tid),100);
}

// â”€â”€â”€ Input helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function msgKeydown(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }
function msgAutoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,100)+'px'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASSMATES PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _classmatesAll = []; // full list for filtering
let _otherClassId  = null; // selected class in "other class" modal
let _otherClassAll = []; // full list for other class modal

function renderClassmatesPanel(){
  const panel = document.getElementById('msgClassmatesPanel');
  if(!panel) return;

  // Only show for students who belong to a class
  if(currentRole !== 'student' || !currentUser.classId){
    panel.style.display = 'none';
    return;
  }

  const cls = (db.classes||[]).find(c => c.id === currentUser.classId);
  if(!cls){ panel.style.display='none'; return; }

  panel.style.display = 'flex';

  // Set header
  const titleEl = document.getElementById('msgClassmatesTitle');
  const subEl   = document.getElementById('msgClassmatesSub');
  if(titleEl) titleEl.textContent = cls.name;
  if(subEl){
    const count = (db.users||[]).filter(u=>u.role==='student'&&u.classId===cls.id).length;
    subEl.textContent = count + ' classmate' + (count!==1?'s':'');
  }

  // Build classmate list (all students in same class, excluding self)
  _classmatesAll = (db.users||[])
    .filter(u => u.role==='student' && u.classId===currentUser.classId && u.id!==myId())
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  renderClassmatesList(_classmatesAll);
}

function renderClassmatesList(list){
  const container = document.getElementById('msgClassmatesList');
  if(!container) return;

  if(!list.length){
    container.innerHTML = `<div style="text-align:center;padding:20px 10px;color:var(--text3);font-size:11px;font-family:'DM Mono',monospace;">No classmates found</div>`;
    return;
  }

  container.innerHTML = list.map(u => {
    const av = u.avatar
      ? `<img src="${u.avatar}">`
      : (u.name||'?')[0].toUpperCase();
    return `<div class="msg-classmate-item" onclick="startDMWith('${u.id}')">
      <div class="msg-classmate-av">${av}</div>
      <div style="flex:1;min-width:0;">
        <div class="msg-classmate-name">${escHtml(u.name||u.username)}</div>
        ${u.matric?`<div class="msg-classmate-matric">${escHtml(u.matric)}</div>`:''}
      </div>
      <button class="msg-classmate-btn" onclick="event.stopPropagation();startDMWith('${u.id}')">DM</button>
    </div>`;
  }).join('');
}

function filterClassmates(q){
  if(!q){ renderClassmatesList(_classmatesAll); return; }
  const ql = q.toLowerCase();
  const filtered = _classmatesAll.filter(u =>
    (u.name||'').toLowerCase().includes(ql) ||
    (u.matric||'').toLowerCase().includes(ql) ||
    (u.username||'').toLowerCase().includes(ql)
  );
  renderClassmatesList(filtered);
}

// Quick-start DM from classmates panel
function startDMWith(targetId){
  const tid = dmThreadId(myId(), targetId);
  openThread(tid);
  // On mobile, hide classmates panel
  if(window.innerWidth <= 1000){
    const panel = document.getElementById('msgClassmatesPanel');
    if(panel) panel.style.display='none';
  }
}

// â”€â”€â”€ Other Class Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openOtherClassPanel(){
  _otherClassId = null;
  _otherClassAll = [];

  // Build class tabs (all classes except own)
  const myClassId = currentUser.classId||'';
  const classes = (db.classes||[]);

  const tabsEl = document.getElementById('otherClassTabs');
  if(tabsEl){
    tabsEl.innerHTML = classes.map(c => {
      const studentCount = (db.users||[]).filter(u=>u.role==='student'&&u.classId===c.id).length;
      const isOwn = c.id === myClassId;
      return `<button
        id="otherClassTab_${c.id}"
        onclick="selectOtherClass('${c.id}')"
        style="padding:7px 14px;border-radius:8px;border:1.5px solid ${isOwn?'var(--border)':'var(--border-hover)'};
               background:${isOwn?'var(--bg3)':'var(--bg3)'};color:${isOwn?'var(--text3)':'var(--text)'};
               font-size:12px;font-family:'Instrument Sans',sans-serif;cursor:${isOwn?'default':'pointer'};
               font-weight:600;transition:all .2s;opacity:${isOwn?'.4':'1'};"
        ${isOwn?'disabled title="Your own class"':''}>
        ${escHtml(c.name)}
        <span style="font-size:10px;font-weight:400;opacity:.6;margin-left:3px;">(${studentCount})</span>
      </button>`;
    }).join('');
  }

  // Clear list
  const listEl = document.getElementById('otherClassStudentList');
  const countEl = document.getElementById('otherClassResultCount');
  const searchEl = document.getElementById('otherClassSearch');
  if(listEl) listEl.innerHTML = `<div style="text-align:center;padding:24px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">ðŸ‘† Select a class above to see students</div>`;
  if(countEl) countEl.textContent = '';
  if(searchEl) searchEl.value = '';

  openModal('otherClassModal');
}

function selectOtherClass(classId){
  _otherClassId = classId;
  const cls = (db.classes||[]).find(c=>c.id===classId);

  // Update tab styles
  (db.classes||[]).forEach(c=>{
    const tab = document.getElementById('otherClassTab_'+c.id);
    if(!tab) return;
    if(c.id===classId){
      tab.style.borderColor='var(--accent)';
      tab.style.background='rgba(56,189,248,.1)';
      tab.style.color='var(--accent)';
    } else if(c.id===currentUser.classId){
      tab.style.borderColor='var(--border)';
      tab.style.background='var(--bg3)';
      tab.style.color='var(--text3)';
    } else {
      tab.style.borderColor='var(--border-hover)';
      tab.style.background='var(--bg3)';
      tab.style.color='var(--text)';
    }
  });

  // Load students from this class
  _otherClassAll = (db.users||[])
    .filter(u=>u.role==='student'&&u.classId===classId)
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  const searchEl = document.getElementById('otherClassSearch');
  if(searchEl) searchEl.value='';
  renderOtherClassList(_otherClassAll);
}

function filterOtherClassList(q){
  if(!_otherClassId){ return; }
  if(!q){ renderOtherClassList(_otherClassAll); return; }
  const ql=q.toLowerCase();
  renderOtherClassList(_otherClassAll.filter(u=>
    (u.name||'').toLowerCase().includes(ql)||(u.matric||'').toLowerCase().includes(ql)
  ));
}

function renderOtherClassList(list){
  const listEl  = document.getElementById('otherClassStudentList');
  const countEl = document.getElementById('otherClassResultCount');
  if(!listEl) return;

  const cls = (db.classes||[]).find(c=>c.id===_otherClassId);
  if(countEl){
    countEl.textContent = list.length===0
      ? 'No students found'
      : `${list.length} student${list.length!==1?'s':''} Â· ${cls?cls.name:_otherClassId}`;
  }

  if(!list.length){
    listEl.innerHTML=`<div style="text-align:center;padding:24px 20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">No students found in this class.</div>`;
    return;
  }

  listEl.innerHTML = list.map(u=>{
    const av = u.avatar
      ? `<img src="${u.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`
      : (u.name||'?')[0].toUpperCase();
    return `<div class="msg-recipient-item" onclick="startDMFromOtherClass('${u.id}')" style="cursor:pointer;">
      <div class="msg-recipient-av" style="background:rgba(129,140,248,.2)">${av}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;">${escHtml(u.name||u.username)}</div>
        <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">
          ${u.matric?escHtml(u.matric)+' Â· ':''}${cls?escHtml(cls.name):''}
        </div>
      </div>
      <button style="flex-shrink:0;padding:5px 10px;background:var(--accent);border:none;border-radius:7px;color:#fff;font-size:11px;font-weight:600;cursor:pointer;font-family:'DM Mono',monospace;"
        onclick="event.stopPropagation();startDMFromOtherClass('${u.id}')">DM</button>
    </div>`;
  }).join('');
}

function startDMFromOtherClass(targetId){
  closeModal('otherClassModal');
  navGo('messages');
  setTimeout(()=>openThread(dmThreadId(myId(),targetId)),100);
}

// â”€â”€â”€ Poll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _reloadDbFromStorage(){
  try{
    const raw = localStorage.getItem('nv_db');
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(!parsed) return;
    // If version is old, trigger a full reload to get the migrated DB
    if(!parsed._version || parsed._version < 8) return;
    // Always patch missing arrays before assigning
    if(!parsed.messages) parsed.messages = [];
    if(!parsed.users) parsed.users = [];
    if(!parsed.classes) parsed.classes = [];
    if(!parsed.courses) parsed.courses = [];
    if(!parsed.results) parsed.results = [];
    if(!parsed.handouts) parsed.handouts = [];
    if(!parsed.pastQuestions) parsed.pastQuestions = [];
    if(!parsed.dmThreads) parsed.dmThreads = [];
    // Restore fileData for messages that had files (stored separately)
    parsed.messages.forEach(m=>{
      if(!m.fileData && (m.msgType==='file'||m.msgType==='image'||m.msgType==='voice')){
        const fd = loadMsgFileData(m.id);
        if(fd) m.fileData = fd;
      }
    });
    // Assign unconditionally â€” always reflect the latest stored state
    db = parsed;
  } catch(e){}
}

function startMsgPoll(){
  stopMsgPoll();
  msgPollInterval=setInterval(()=>{
    if(document.getElementById('viewMessages').style.display==='none') return;
    _reloadDbFromStorage();
    renderMsgChannels(document.getElementById('msgSearchInp')?document.getElementById('msgSearchInp').value:'');
    if(activeThreadId) renderMsgBody(activeThreadId);
    // Refresh classmates count in header (in case new students register)
    const subEl=document.getElementById('msgClassmatesSub');
    if(subEl&&currentUser.classId){
      const count=(db.users||[]).filter(u=>u.role==='student'&&u.classId===currentUser.classId&&u.id!==myId()).length;
      subEl.textContent=count+' classmate'+(count!==1?'s':'');
    }
  },1000);
}
function stopMsgPoll(){ if(msgPollInterval){clearInterval(msgPollInterval);msgPollInterval=null;} }

// ============================================================
// REMOVE ALL STUDENTS (admin only)
// ============================================================
function removeAllStudents(){
  const count = (db.users||[]).filter(u=>u.role==='student').length;
  if(count === 0){ toast('No student accounts to remove'); return; }
  if(!confirm('Remove all ' + count + ' student account' + (count!==1?'s':'') + '? This cannot be undone.')) return;
  db.users = (db.users||[]).filter(u=>u.role!=='student');
  saveDB();
  renderUsers();
  toast('\u2713 ' + count + ' student account' + (count!==1?'s':'')+' removed');
}

function resetAllStudentPasswords(){
  const students = (db.users||[]).filter(u=>u.role==='student');
  if(students.length === 0){ toast('No student accounts found'); return; }
  if(!confirm('Reset passwords for all ' + students.length + ' students to their surname + 123?')) return;
  let count = 0;
  students.forEach(function(u){
    // Derive surname: use stored surname field, or first word of name
    let surname = u.surname || (u.name ? u.name.trim().split(/\s+/)[0] : '');
    surname = surname.toLowerCase().replace(/[^a-z0-9]/g,'');
    if(!surname) surname = 'student';
    u.password = surname + '123';
    count++;
  });
  saveDB();
  renderUsers();
  toast('\u2713 Passwords reset for ' + count + ' students (surname + 123)');
}

// ============================================================
// NOMINAL ROLL IMPORT (admin only) â€” Smart Auto-Parse Engine
// ============================================================

let _nominalParsedRows = [];
let _nominalColMap = {};   // field â†’ column index
let _nominalRawHeaders = []; // original header strings

function openNominalRollImport(){
  const sel = document.getElementById('nominalClassSelect');
  sel.innerHTML = '<option value="">â€” Override Class (optional) â€”</option>' +
    (db.classes||[]).map(c=>`<option value="${c.id}">${c.name}${c.full?' â€” '+c.full:''}</option>`).join('');
  nominalReset();
  openModal('nominalRollModal');
}

function nominalReset(){
  document.getElementById('nominalPreview').style.display='none';
  document.getElementById('nominalMappingInfo').style.display='none';
  document.getElementById('nominalImportResult').style.display='none';
  document.getElementById('nominalFileInp').value='';
  _nominalParsedRows=[];
  _nominalColMap={};
  _nominalRawHeaders=[];
  // Reset drop zone
  const dz=document.getElementById('nominalDropZone');
  dz.style.display='';
  dz.style.borderColor='var(--border)';
  dz.style.background='var(--bg2)';
}

function nominalHandleDrop(e){
  e.preventDefault();
  const dz=document.getElementById('nominalDropZone');
  dz.style.borderColor='var(--border)';
  dz.style.background='var(--bg2)';
  const file=e.dataTransfer.files[0];
  if(file) nominalHandleFile(file);
}

function nominalHandleFile(file){
  if(!file) return;
  const ext=file.name.split('.').pop().toLowerCase();
  if(!['xlsx','xls','csv','doc','docx'].includes(ext)){toast('Please upload an .xlsx, .xls, .csv, .doc, or .docx file');return;}

  // Show loading state
  const dz=document.getElementById('nominalDropZone');
  const dzOrig=dz.innerHTML;
  dz.innerHTML='<div style="font-size:30px;margin-bottom:8px;">&#9203;</div><div style="font-size:13px;color:var(--text2);">Reading spreadsheet\u2026</div>';

  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      let rows=[];
      if(ext==='csv'){
        rows=nominalParseCSV(ev.target.result);
        dz.innerHTML=dzOrig;
        if(!rows||rows.length<2){toast('Spreadsheet appears empty or unreadable');return;}
        nominalAutoDetect(rows);
      } else if(ext==='doc'||ext==='docx'){
        mammoth.extractRawText({arrayBuffer:ev.target.result}).then(function(result){
          dz.innerHTML=dzOrig;
          const lines=result.value.split(/\r?\n/).filter(l=>l.trim()!=='');
          if(!lines||lines.length<2){toast('Word document appears empty or has no tabular data');return;}
          const delim=lines[0].includes('\t')?'\t':',';
          rows=lines.map(l=>l.split(delim).map(c=>c.trim()));
          if(!rows||rows.length<2){toast('Could not find tabular data in the Word document');return;}
          nominalAutoDetect(rows);
        }).catch(function(err){
          dz.innerHTML=dzOrig;
          toast('Could not read Word file: '+err.message);
        });
        return;
      } else {
        const wb=XLSX.read(ev.target.result,{type:'array',cellDates:true,dateNF:'yyyy-mm-dd'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:false,dateNF:'yyyy-mm-dd'});
        dz.innerHTML=dzOrig;
        if(!rows||rows.length<2){toast('Spreadsheet appears empty or unreadable');return;}
        nominalAutoDetect(rows);
      }
    }catch(err){
      dz.innerHTML=dzOrig;
      toast('Could not read file: '+err.message);
    }
  };
  if(ext==='csv') reader.readAsText(file);
  else reader.readAsArrayBuffer(file);
}

function nominalParseCSV(text){
  return text.split(/\r?\n/).map(row=>{
    const cells=[]; let cur='', inQ=false;
    for(let i=0;i<row.length;i++){
      const ch=row[i];
      if(ch==='"'){ inQ=!inQ; }
      else if(ch===','&&!inQ){ cells.push(cur.trim()); cur=''; }
      else cur+=ch;
    }
    cells.push(cur.trim());
    return cells;
  }).filter(r=>r.some(c=>String(c).trim()!==''));
}

// Normalize a header string for matching
function nominalNorm(h){
  return String(h).toLowerCase()
    .replace(/[^a-z0-9]/g,'')
    .replace(/\s+/g,'');
}

// Smart header row detection â€” finds the row most likely to be the header
function nominalFindHeaderRow(rows){
  // Score each of the first 10 rows: more text-like cells = more likely header
  let bestRow=0, bestScore=-1;
  const limit=Math.min(10,rows.length);
  for(let i=0;i<limit;i++){
    const r=rows[i];
    let score=0;
    r.forEach(c=>{
      const v=String(c).trim();
      if(!v) return;
      // Headers are usually short text (not numbers, not long sentences)
      if(v.length>0 && v.length<40 && isNaN(v)) score+=2;
      if(/name|matric|matricno|matric\s*no|phone|class|sex|gender|dob|date|birth|reg|no\b|number|rrr|index|level|dept|programme|set|batch|rank|svc|bia|state|address/i.test(v)) score+=5;
    });
    if(score>bestScore){ bestScore=score; bestRow=i; }
  }
  return bestRow;
}

// Map a normalized header to a known field
function nominalMapHeader(norm){
  const maps={
    surname:      ['surname','lastname','familyname','last','lname'],
    firstName:    ['firstname','fname','givenname','forename','first'],
    otherName:    ['othername','othernames','middlename','middle','initials'],
    name:         ['name','fullname','studentname','studentnames','student','candidatename','sn','s/n'],
    matric:       ['matric','matricno','matricnumber','matriculationno','registrationnumber','regnum','regno','admno','admissionnumber','admissionno','matno','matnumber','matriculationno','matric123','matriculation'],
    cls:          ['class','classname','level','programme','dept','department','set','batch','intake','course','group'],
    phone:        ['phone','phoneno','phonenumber','mobile','mobileno','tel','telephone','contact','gsm'],
    dob:          ['dob','dateofbirth','birthdate','datebirth','birth'],
    sex:          ['sex','gender','m/f'],
    rrr:          ['rrr','remitanumber','remita','remitatransaction','rrrno'],
    bia:          ['bia','bianumber','biaid','accreditation'],
    rnIndex:      ['rnindex','rnindexno','rnindexnumber','regnurse'],
    rmIndex:      ['rmindex','rmindexno','rmindexnumber','regmidwife'],
    rnExam:       ['rnexam','rnexamno','rnexamnumber','nurseexam'],
    rmExam:       ['rmexam','rmexamno','rmexamnumber','midwifeexam'],
    state:        ['state','stateoforigin','origin','lga','localgovt'],
    address:      ['address','homeaddress','residentialaddress'],
    rank:         ['rank','militaryrank','armyrank'],
    svc:          ['svc','servicenumber','armynumber','servicenum'],
    email:        ['email','emailaddress','mail'],
  };
  for(const [field,aliases] of Object.entries(maps)){
    if(aliases.includes(norm)) return field;
    // Partial match â€” norm contains alias or alias contains norm
    for(const a of aliases){
      if(norm.includes(a)||a.includes(norm)) return field;
    }
  }
  return null;
}

// Heuristic: detect if a column looks like names (based on first few data rows)
function nominalColLooksLikeName(rows, headerRow, colIdx){
  let nameCount=0;
  for(let i=headerRow+1;i<Math.min(headerRow+8,rows.length);i++){
    const v=String(rows[i][colIdx]||'').trim();
    if(!v) continue;
    // Multi-word name (e.g. "John Doe") or single-word surname (3+ alpha chars)
    if(v.length>=3 && v.length<=50 && /^[a-zA-Z\s\-'\.]+$/.test(v)) nameCount++;
  }
  return nameCount>=2;
}

function nominalAutoDetect(rows){
  const headerRow=nominalFindHeaderRow(rows);
  _nominalRawHeaders=rows[headerRow];
  const normHeaders=_nominalRawHeaders.map(nominalNorm);

  // Build column map
  _nominalColMap={};
  normHeaders.forEach((norm,idx)=>{
    if(!norm) return;
    const field=nominalMapHeader(norm);
    if(field && !(_nominalColMap[field]>=0)){
      _nominalColMap[field]=idx;
    }
  });

  // If no name/surname column found, try heuristic on all unmapped text columns
  const hasNameCol = (_nominalColMap.name>=0) || (_nominalColMap.surname>=0);
  if(!hasNameCol){
    for(let i=0;i<normHeaders.length;i++){
      if(nominalColLooksLikeName(rows,headerRow,i)){
        _nominalColMap.name=i; break;
      }
    }
  }

  // If matric still not detected, try raw header string match for "MATRIC NO" variants
  if(!(_nominalColMap.matric>=0)){
    for(let i=0;i<_nominalRawHeaders.length;i++){
      const raw=String(_nominalRawHeaders[i]).toLowerCase().trim();
      if(/matric|mat\.?\s*no|mat\s*no|matr/i.test(raw)){
        _nominalColMap.matric=i; break;
      }
    }
  }

  const dataRows=rows.slice(headerRow+1).filter(r=>r.some(c=>String(c).trim()!==''));

  const hasAnyNameCol = (_nominalColMap.name>=0) || (_nominalColMap.surname>=0);
  if(!hasAnyNameCol){
    toast('Could not detect a Name or Surname column. Make sure the spreadsheet has a header row.');
    return;
  }

  // Show detected columns as tags
  const tagContainer=document.getElementById('nominalMappingTags');
  const fieldLabels={
    surname:'Surname', firstName:'First Name', otherName:'Other Name',
    name:'Full Name', matric:'Matric', cls:'Class', phone:'Phone', dob:'DOB',
    sex:'Sex', rrr:'RRR', bia:'BIA', rnIndex:'RN Index', rmIndex:'RM Index',
    rnExam:'RN Exam', rmExam:'RM Exam', state:'State', address:'Address',
    rank:'Rank', svc:'SVC', email:'Email'};
  const colors={
    surname:'var(--accent)', firstName:'var(--accent)', otherName:'var(--accent)',
    name:'var(--accent)', matric:'var(--accent2)', cls:'var(--accent3)',
    phone:'#fb923c', dob:'#a78bfa', sex:'#f472b6', rrr:'#34d399', bia:'#60a5fa',
    rnIndex:'#fbbf24', rmIndex:'#f87171', rnExam:'#c084fc', rmExam:'#4ade80',
    state:'#38bdf8', address:'#e879f9', rank:'#facc15', svc:'#86efac', email:'#67e8f9'};

  tagContainer.innerHTML=Object.entries(_nominalColMap).map(([field,idx])=>{
    const header=_nominalRawHeaders[idx]||field;
    const col=colors[field]||'var(--text2)';
    const spanStyle='display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:10px;font-family:monospace;background:'+col+'1a;border:1px solid '+col+'55;color:'+col+';';
    return '<span style="'+spanStyle+'"><b>'+(fieldLabels[field]||field)+'</b> <span style="opacity:.6;">\u2190 &quot;'+escHtml(String(header))+'&quot;</span></span>';
  }).join('');
  document.getElementById('nominalMappingInfo').style.display='';

  nominalBuildPreview(dataRows);
}

function nominalGetCell(row, field){
  const idx=_nominalColMap[field];
  if(idx===undefined||idx<0) return '';
  return String(row[idx]||'').trim();
}

function nominalBuildPreview(dataRows){
  const usedUsernames={};
  // Check if spreadsheet has separate surname / firstname columns
  const hasSurnameCol  = _nominalColMap.surname  >= 0;
  const hasFirstNameCol= _nominalColMap.firstName >= 0;
  const hasOtherNameCol= _nominalColMap.otherName >= 0;

  _nominalParsedRows=dataRows.map(row=>{
    let surname='', firstName='', otherName='', fullName='';

    if(hasSurnameCol){
      // Separate columns â€” compose full name as "Surname Firstname Othername"
      surname    = nominalGetCell(row,'surname').trim();
      firstName  = hasFirstNameCol ? nominalGetCell(row,'firstName').trim() : '';
      otherName  = hasOtherNameCol ? nominalGetCell(row,'otherName').trim() : '';
      fullName   = [surname, firstName, otherName].filter(Boolean).join(' ');
    } else {
      // Single name column â€” parse it
      const raw = nominalGetCell(row,'name').trim();
      if(!raw) return null;
      fullName = raw;
      // Handle "SURNAME, Firstname Othername" format
      if(raw.includes(',')){
        const parts = raw.split(',');
        surname   = parts[0].trim();
        const rest= parts[1].trim().split(/\s+/);
        firstName = rest[0]||'';
        otherName = rest.slice(1).join(' ');
      } else {
        // "Surname Firstname Othername" â€” first word is surname
        const parts = raw.split(/\s+/);
        surname   = parts[0]||'';
        firstName = parts[1]||'';
        otherName = parts.slice(2).join(' ');
      }
    }

    if(!fullName && !surname) return null;

    // Derive clean surname for username/password
    const surnameClean = surname.toLowerCase().replace(/[^a-z0-9]/g,'') || 'student';

    // Assign unique username: surname + 123 (e.g. smith123)
    let uname = surnameClean + '123';
    if(usedUsernames[uname]){
      usedUsernames[uname]++;
      uname = surnameClean + usedUsernames[uname] + '123';
    } else {
      usedUsernames[uname] = 1;
    }
    // Avoid clash with existing db users
    let finalUname = uname, counter = 2;
    while(db.users.find(u=>(u.username||'').toLowerCase()===finalUname)){
      finalUname = surnameClean+counter+'123'; counter++;
    }

    return {
      name:        fullName || surname,
      surname:     surname,
      firstName:   firstName,
      otherName:   otherName,
      username:    finalUname,
      password:    finalUname+'123',
      matric:      nominalGetCell(row,'matric').toUpperCase(),
      cls:         nominalGetCell(row,'cls'),
      phone:       nominalGetCell(row,'phone'),
      dob:         nominalGetCell(row,'dob'),
      sex:         nominalGetCell(row,'sex'),
      rrr:         nominalGetCell(row,'rrr'),
      bia:         nominalGetCell(row,'bia').toUpperCase(),
      rnIndex:     nominalGetCell(row,'rnIndex'),
      rmIndex:     nominalGetCell(row,'rmIndex'),
      rnExam:      nominalGetCell(row,'rnExam'),
      rmExam:      nominalGetCell(row,'rmExam'),
      state:       nominalGetCell(row,'state'),
      address:     nominalGetCell(row,'address'),
      rank:        nominalGetCell(row,'rank').toUpperCase(),
      svc:         nominalGetCell(row,'svc').toUpperCase(),
      email:       nominalGetCell(row,'email'),
      _surname:    surnameClean,
    };
  }).filter(Boolean);

  // Build dynamic preview columns
  const detectedFields = Object.keys(_nominalColMap);
  // Always show name breakdown columns if detected separately
  let nameFields = [];
  if(hasSurnameCol)  nameFields.push('surname');
  if(hasFirstNameCol)nameFields.push('firstName');
  if(hasOtherNameCol)nameFields.push('otherName');
  if(!hasSurnameCol) nameFields.push('name'); // fallback to combined name

  const extraFields = detectedFields.filter(f=>!['name','surname','firstName','otherName'].includes(f));
  const previewFields = [...nameFields,'username','password',...extraFields];

  const fieldLabels={
    name:'Full Name', surname:'Surname', firstName:'First Name', otherName:'Other Name',
    username:'Username', password:'Password', matric:'Matric',
    cls:'Class', phone:'Phone', dob:'DOB', sex:'Sex', rrr:'RRR', bia:'BIA',
    rnIndex:'RN Index', rmIndex:'RM Index', rnExam:'RN Exam', rmExam:'RM Exam',
    state:'State', address:'Address', rank:'Rank', svc:'SVC', email:'Email'};

  const thead=document.getElementById('nominalPreviewHead');
  const tbody=document.getElementById('nominalPreviewBody');

  thead.innerHTML='<tr>'+previewFields.map(f=>'<th style="padding:8px 12px;text-align:left;font-size:10px;font-family:monospace;color:var(--text3);white-space:nowrap;border-bottom:1px solid var(--border);text-transform:uppercase;letter-spacing:.05em;">'+( fieldLabels[f]||f)+'</th>').join('')+'</tr>';

  const monoFont='monospace';
  const accentField={username:'var(--accent2)',password:'var(--accent)',surname:'var(--accent)',firstName:'var(--accent)',otherName:'var(--accent)',name:''};

  tbody.innerHTML=_nominalParsedRows.slice(0,100).map(r=>`<tr style="border-bottom:1px solid var(--border);">
    ${previewFields.map(f=>{
      const val=r[f]||'';
      const col=accentField[f]?'color:'+accentField[f]+';font-family:'+monoFont+';':'color:var(--text2);';
      return `<td style="padding:6px 12px;font-size:12px;white-space:nowrap;${col}">${escHtml(String(val))}</td>`;
    }).join('')}
  </tr>`).join('');

  document.getElementById('nominalPreviewTitle').textContent=
    `${_nominalParsedRows.length} student${_nominalParsedRows.length!==1?'s':''} detected`+
    (_nominalParsedRows.length>100?' (showing first 100)':'');
  document.getElementById('nominalImportResult').style.display='none';
  document.getElementById('nominalPreview').style.display='';
}


function nominalImportConfirm(){
  if(!_nominalParsedRows.length){toast('No data to import');return;}
  const classId=document.getElementById('nominalClassSelect').value;
  const cls=classId?db.classes.find(c=>c.id===classId):null;
  let added=0, updated=0;

  _nominalParsedRows.forEach(r=>{
    let assignedClassId=classId||'';
    let assignedCls=cls?cls.name:'';
    if(!assignedClassId && r.cls){
      const match=db.classes.find(c=>
        c.name.toLowerCase()===r.cls.toLowerCase()||
        (c.full&&c.full.toLowerCase()===r.cls.toLowerCase())||
        r.cls.toLowerCase().includes(c.name.toLowerCase())
      );
      if(match){assignedClassId=match.id;assignedCls=match.name;}
    }

    const existing=db.users.find(u=>
      (r.matric&&u.matric&&u.matric===r.matric)||
      (u.username&&u.username.toLowerCase()===r.username.toLowerCase())
    );

    if(existing){
      const defaultPass=r._surname?r._surname.toUpperCase()+'123':r.username.toUpperCase()+'123';
      const keepPass=existing.password&&existing.password!==defaultPass&&existing.password!=='student123';
      existing.name=r.name;
      if(r.surname)   existing.surname=r.surname;
      if(r.firstName) existing.firstName=r.firstName;
      if(r.otherName) existing.otherName=r.otherName;
      if(r.matric)    existing.matric=r.matric;
      if(r.phone)     existing.phone=r.phone;
      if(r.dob)       existing.dob=r.dob;
      if(r.sex)       existing.sex=r.sex;
      if(r.rrr)       existing.rrr=r.rrr;
      if(r.bia)       existing.bia=r.bia;
      if(r.rnIndex)   existing.rnIndex=r.rnIndex;
      if(r.rmIndex)   existing.rmIndex=r.rmIndex;
      if(r.rnExam)    existing.rnExam=r.rnExam;
      if(r.rmExam)    existing.rmExam=r.rmExam;
      if(r.state)     existing.state=r.state;
      if(r.address)   existing.address=r.address;
      if(r.rank)      existing.rank=r.rank;
      if(r.svc)       existing.svc=r.svc;
      if(r.email)     existing.email=r.email;
      if(assignedClassId){existing.classId=assignedClassId;existing.cls=assignedCls;}
      if(!keepPass)   existing.password=r.password;
      updated++;
    } else {
      db.users.push({
        id:        'u_nr_'+Date.now()+'_'+Math.random().toString(36).slice(2,7),
        name:      r.name,
        surname:   r.surname||'',
        firstName: r.firstName||'',
        otherName: r.otherName||'',
        username:  r.username,
        password:  r.password,
        role:      'student',
        classId:   assignedClassId||'',
        cls:       assignedCls||r.cls||'',
        matric:    r.matric||'',
        phone:     r.phone||'',
        avatar:    '',
        dob:       r.dob||'',
        sex:       r.sex||'',
        rrr:       r.rrr||'',
        bia:       r.bia||'',
        rnIndex:   r.rnIndex||'',
        rmIndex:   r.rmIndex||'',
        rnExam:    r.rnExam||'',
        rmExam:    r.rmExam||'',
        state:     r.state||'',
        address:   r.address||'',
        rank:      r.rank||'',
        svc:       r.svc||'',
        email:     r.email||'',
        documents: [],
      });
      added++;
    }
  });

  saveDB();
  renderUsers();

  // Store IDs of all just-imported/updated users for the save button
  window._nominalLastImportedIds = _nominalParsedRows.map(r=>r.username);

  const detectedCount=Object.keys(_nominalColMap).length;
  const res=document.getElementById('nominalImportResult');
  res.style.display='';
  res.style.background=added||updated?'rgba(52,211,153,.1)':'rgba(251,191,36,.1)';
  res.style.border='1px solid '+(added||updated?'var(--accent3)':'#fbbf24');
  res.style.borderRadius='10px';
  res.style.padding='14px';
  res.innerHTML='<div style="font-weight:700;font-size:14px;color:'+(added||updated?'var(--accent3)':'#fbbf24')+';margin-bottom:6px;">'
    +(added||updated?'\u2705 Import Complete':'\u2139\ufe0f No Changes')+'</div>'
    +'<div style="font-size:12px;color:var(--text2);font-family:monospace;line-height:1.9;">'
    +'<div>\ud83c\udd95 New accounts created: <b>'+added+'</b></div>'
    +'<div>\ud83d\udd04 Existing accounts updated: <b>'+updated+'</b></div>'
    +'<div style="margin-top:8px;font-size:11px;color:var(--text3);">'+detectedCount+' fields auto-detected. Login: username = surname123, password = surname123123.</div>'
    +'</div>'
    +(added||updated
      ? '<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">'
        +'<button class="btn-submit" onclick="nominalSaveImported()" style="background:linear-gradient(135deg,#38bdf8,#818cf8);flex:1;min-width:160px;font-size:13px;">ðŸ’¾ Save Profile List</button>'
        +'<button class="btn-ghost" onclick="nominalReset()" style="flex:1;min-width:120px;font-size:13px;">ðŸ“‚ Import Another</button>'
        +'</div>'
      : '');
  _nominalParsedRows=[];
  document.getElementById('nominalPreview').style.display='none';
  document.getElementById('nominalMappingInfo').style.display='none';
  toast('\u2713 '+added+' created, '+updated+' updated');
}

function nominalSaveImported(){
  // â”€â”€ Step 1: Force-save the entire DB to localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let appSaveOk = false;
  try {
    saveDB();
    // Verify the save actually worked by reading back and checking user count
    const raw = localStorage.getItem('nv_db');
    if(raw){
      const parsed = JSON.parse(raw);
      if(parsed.users && parsed.users.length === db.users.length) appSaveOk = true;
    }
  } catch(e){ appSaveOk = false; }

  // â”€â”€ Step 2: Write a dedicated user-backup key as extra insurance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    const userBackup = db.users.map(u=>({
      id:u.id,name:u.name,surname:u.surname||'',firstName:u.firstName||'',
      otherName:u.otherName||'',username:u.username,password:u.password,
      role:u.role,classId:u.classId||'',cls:u.cls||'',matric:u.matric||'',
      phone:u.phone||'',dob:u.dob||'',sex:u.sex||'',rrr:u.rrr||'',
      bia:u.bia||'',rnIndex:u.rnIndex||'',rmIndex:u.rmIndex||'',
      rnExam:u.rnExam||'',rmExam:u.rmExam||'',state:u.state||'',
      address:u.address||'',rank:u.rank||'',svc:u.svc||'',email:u.email||'',
      documents:u.documents||[],avatar:u.avatar||''
    }));
    localStorage.setItem('nv_users_backup', JSON.stringify(userBackup));
  } catch(e){ /* backup failed â€” main save may still be fine */ }

  // â”€â”€ Step 3: Show result feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const usernames = window._nominalLastImportedIds || [];
  const importedCount = db.users.filter(u=>u.role==='student' && usernames.includes(u.username)).length;
  const totalStudents = db.users.filter(u=>u.role==='student').length;

  const res = document.getElementById('nominalImportResult');
  if(appSaveOk){
    res.innerHTML = res.innerHTML.replace(
      /<button[^>]*onclick="nominalSaveImported\(\)"[^>]*>.*?<\/button>/,
      '<button class="btn-submit" disabled style="background:linear-gradient(135deg,#34d399,#059669);flex:1;min-width:160px;font-size:13px;opacity:.85;">âœ… Saved to App</button>'
    );
    toast('âœ… All '+totalStudents+' student profiles saved â€” they will persist after logout');

    // Show a confirmation banner inside the result box
    const banner = document.createElement('div');
    banner.style.cssText='margin-top:10px;padding:10px 12px;background:rgba(52,211,153,.12);border:1px solid var(--accent3);border-radius:8px;font-size:12px;color:var(--accent3);font-family:monospace;';
    banner.innerHTML='ðŸ”’ <b>'+totalStudents+' student profiles are now saved in the app.</b><br>'
      +'<span style="color:var(--text2);">Profiles will remain intact after logout, refresh, or closing the browser tab.</span>';
    res.appendChild(banner);

    // Also offer an Excel download as a portable backup
    const dlBtn = document.createElement('button');
    dlBtn.className='btn-ghost';
    dlBtn.style.cssText='margin-top:8px;width:100%;font-size:12px;';
    dlBtn.textContent='â¬‡ï¸ Also download as Excel backup';
    dlBtn.onclick = nominalExportExcel;
    res.appendChild(dlBtn);

  } else {
    // App save failed (likely storage quota) â€” auto-fallback to Excel download
    toast('âš ï¸ Browser storage full â€” downloading Excel backup instead');
    nominalExportExcel();

    const banner = document.createElement('div');
    banner.style.cssText='margin-top:10px;padding:10px 12px;background:rgba(251,113,133,.12);border:1px solid var(--accent4);border-radius:8px;font-size:12px;color:var(--accent4);font-family:monospace;';
    banner.innerHTML='âš ï¸ <b>Storage limit reached.</b><br>'
      +'<span style="color:var(--text2);">Profiles were imported this session but could not be saved in the browser. '
      +'An Excel file has been downloaded as a backup â€” re-import it next time to restore profiles.</span>';
    res.appendChild(banner);
  }
}

// â”€â”€ Export imported students to Excel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nominalExportExcel(){
  const usernames = window._nominalLastImportedIds || [];
  const students = db.users.filter(u=>u.role==='student'&&(usernames.length?usernames.includes(u.username):true));
  if(!students.length){ toast('No student profiles to export'); return; }

  const header = ['Surname','First Name','Other Name','Full Name','Username','Password','Matric No.','Class','Phone','DOB','Sex','RRR','BIA','RN Index','RM Index','RN Exam','RM Exam','State','Address','Rank','Service','Email'];
  const rows = students.map(u=>[
    u.surname||'',u.firstName||'',u.otherName||'',u.name||'',
    u.username||'',u.password||'',u.matric||'',u.cls||'',
    u.phone||'',u.dob||'',u.sex||'',u.rrr||'',u.bia||'',
    u.rnIndex||'',u.rmIndex||'',u.rnExam||'',u.rmExam||'',
    u.state||'',u.address||'',u.rank||'',u.svc||'',u.email||''
  ]);

  try {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([header,...rows]);
    ws['!cols'] = header.map((_,i)=>{
      const max=Math.max(header[i].length,...rows.map(r=>String(r[i]||'').length));
      return {wch:Math.min(Math.max(max+2,10),40)};
    });
    XLSX.utils.book_append_sheet(wb,ws,'Imported Students');
    const now=new Date();
    const stamp=now.getFullYear()+''+(now.getMonth()+1).toString().padStart(2,'0')+now.getDate().toString().padStart(2,'0');
    XLSX.writeFile(wb,'nominal_roll_'+stamp+'.xlsx');
    toast('ðŸ“¥ Excel backup downloaded');
  } catch(e){
    const csv=[header,...rows].map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='nominal_roll.csv'; a.click();
    URL.revokeObjectURL(url);
    toast('ðŸ“¥ CSV backup downloaded');
  }
}



</script>


<script>
// â”€â”€ Service Worker Registration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){
  window.addEventListener('load', function(){
    // SW encoded as base64 data URI â€” works for single-file PWA deployments
    var swCode = [
      "const CACHE='nv1';",
      "self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])).then(()=>self.skipWaiting())); });",
      "self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k)))).then(()=>self.clients.claim())); });",
      "self.addEventListener('fetch',e=>{ if(e.request.method!=='GET')return; e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(resp=>{ if(resp&&resp.status===200){const c=resp.clone();caches.open(CACHE).then(ca=>ca.put(e.request,c));}return resp;}).catch(()=>caches.match('./')||new Response('Offline',{status:503})))); });"
    ].join('\n');
    var b64 = btoa(unescape(encodeURIComponent(swCode)));
    var swUrl = 'data:application/javascript;base64,' + b64;
    navigator.serviceWorker.register(swUrl, {scope: './'})
      .then(reg => console.log('[NurseVault] SW registered:', reg.scope))
      .catch(err => {
        // Data URI SW not supported in this browser â€” PWA offline caching unavailable
        console.info('[NurseVault] SW skipped (single-file mode):', err.message);
      });
  });
}

// â”€â”€ PWA Install Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _deferredInstallPrompt = null;
window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault();
  _deferredInstallPrompt = e;
  // Show install banner after 3s if not dismissed
  setTimeout(showInstallBanner, 3000);
});

function showInstallBanner(){
  if(!_deferredInstallPrompt) return;
  if(document.getElementById('nvInstallBanner')) return;
  const banner = document.createElement('div');
  banner.id = 'nvInstallBanner';
  banner.innerHTML = `
    <div style="
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:linear-gradient(135deg,#0d1117,#131920);
      border:1px solid rgba(56,189,248,0.3);border-radius:14px;
      padding:14px 20px;display:flex;align-items:center;gap:14px;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:99999;
      font-family:'Syne',sans-serif;min-width:280px;max-width:340px;
      animation:slideUp .3s ease;">
      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAIOUlEQVR4nO2dPZYUOwxGNZw55xEQELIMUtK3AdbKBkhJWQYhAQFEvIBjXtF0dbnKkixZ94b89JRd37Xk+ul5EjDh5avXPzU/7/u3r0+anwe/YFIH0A75VZDjOkxcJ1HC3gtS9MEk7ZAt8EcgxH2YlA2rhX4PZPif8hNRJfR7VJeh5OC9Qv/2wxeVz/n8/o3K5xxRUYZSA7YIvlbIr2IhRyURSgxUK/izw96LlhQVRFh2gBqhzxL4IzSEWFWG5QY1GvxVQr/HqAyribDUYK6Gf/XQ73FVhpUkWGIgBH+MyiKkHsCV4BP6x1yRIbMIKQ88S/C1rsZkOfaMIqQ74LPhtw6P102qPaKNL5sEaQ42SvBnB/6IKOPOIkKKgzwTfu0ARA/8ETPnI4ME4Q+wN/yaJzp76PeYMUfRJQh7cN6r/qqh38N7zqKKEPKgPFf9asG/xXMOI0oQ7oC8wl89+Ld4zWc0CcIcDMGPQTURQhyER/gJ/jk85jqCBNMPwDr8BH8M63mfLcHUH94TfoIfA8vzMFOCaT/YKvwE3xarczJLghczfijhz8uVOe45l7O+ncPdOovwE/w5WJwn70rgWgEI/1qcnfuIlcDNtqOB0fLkxeLceVUClx+iHX6CHxPt8+ghgXkLRPjroN0SebRDpgIQ/npkk8BMAMJfl0wSPFt9sBYEPyftvEX/Fg6TCqC1+hP+/PSew1lVQF0Awg+3RJZAVQDCD3tElcDtTjDhBy0JNFET4JGZhB8aGhJoVgEVAar/ni3wRytzwwLQ98NZIu0HTPcAhB/2iLIfGBKAvh9GiLAfuCyARvkh/KCRgZEsmrRA0W9/Qz6sMnVJAFof0GRmKzTlYbgK4bdYsVaet8/v30zpHE5XgNHVf+WTCGP0ZEO7CqjtAej7wQvNrJ0SYPTKD6s/HDGakbMZ7RaA1ge88GyFpnwzHEAUugRg9QdvvKoAFQBKMyQAqz9YMloFejgUgGf9ISs92b1cAVj9wQPrKvBQAFZ/yM5Rhi9VAFZ/8MSyCuwKwOoPq/AoyyaXQVn9QRurTJ0WgIfeICpXsnlXgJH2h9UfrBjJ1l6mT1UAVn+IztmMqu4BWP3BGu2M/SUAV39gVe5lu7sC0P5AFs5kVa0Fov0BLzSz9ocAtD+wOrcZ76oAtD+Qjd7MqrRAtD/gjVbmeCMMSvNbAPp/qMI264cVgP4fstKT3eEWiP4fZqGRPfYAUBoEgNK8EGEDDPVomX9YAY42EfT/MJujDB5lmBYISoMAUBoEgNIgAJQGAaA0z9kvgVZ6VCPqWLNeDXz56vXP3V+TyiVQWz79+89ff/bu448JR5Kfo1+x+vbDl928Tvk9wZW5F/zbv0MEPxDAiUfB3/u3iGAPm2AHzoRf4/9BPwgApUEAY0ZXcaqALQgApUEAQ7RWb6qAHQgApUEAKA0CQGkQAEqDAIZo3cnljrAdCAClQQBjRldvVn9bEABKgwAOXF3FWf3t4XFoJ1qYe+7qEnw/divA6BcOwX3effyxG/BHfwf7jLy9+Pz929en7O8FZ4Sgz+f7t69P6VugqO8mW1TIqGPNDJtgKA0CQGkQAEqDAFCahwJwKRSiM/oFbi9Efl0O0jskgPi0zNMCQWkQAEozLAD7AJiFRvYOBeDuI2SlJ7u/BWAjDFXYZp09AJRGRQD2AeCNVua6BGAfANnozewfArAPgNW5zbjaHoA2CLzQzFq3ALRBkIUzWf1LANogWJV72Va9DEobBNZoZ+yUALRBEJ2zGb0rwEgbRBUAK0aytZfp0y0QVQCiciWbJo9CUAVAG6tM7QrA1SBYhUdZvlQBekoNVQC06MnS1db8oQBUAcjOUYYv7wGoAuCB5eov0iEAVQCy0pPdoatAVAGwxHr1F+GNMChOlwCPSglVACwYXf17W3cqAJSmWwCqAHjhtfqLnKwAo1eEkACOGM3I2YyqtUA8JAdeaGbttAC0QmCFZ+vTmLIJRgK4ZVYmLvf0j361au9gaJtARCcvV/enJhWAYIM2Vpm6LIDGM0K0QqCRgZEsDlWA0Q2xCBJUZmbr0zDdBCMB7BFlnzgswJGBSAC3aIVfow1XqQC8MwDeaGVOrQViPwA9ROj7t7jdCEMCiNL3b1EVgP0A7BGp79+iXgGQAG6JGn4RoxYICaAROfwiIs8WH6pJm0Aer8hFlsXLbBOsVQUaWSYUzp+rWau/iPFVICSoR6bwizhcBkWCOmQLv8jA+wBnefT+gMi1YLMviIHFufN6usD1EYYjCUT0VxGwxeJ8eT5a4/pKZM/AaInykD38Is4VoGFRCUSoBl5YnZsZD1VOeSneohKIUA08WCn8IpMqQMOqEohQDbSxPA8zH6ef/hx/jwQiiDAL63mf/S7JdAFE7CUQQYSzeMz17PCLBBFAxEcCEUQ4wmt+I4RfJJAADUSYQ7XgN0IdTMNLAhFE8JzDaOEXCSqASL8EIohwBe85ixh+kcACNDyrQWNVGWbMUdTgN0IfXMO7GmzJLsPM+YgefpEkAoick0DE7q5wdCGijDtD+EUSCdCIIkJjthDRxpcl+I1UB9s4K4HInOeEtOTIcuzZwi+SVIBGFhEyUSX4jbQHvuWKCCLI0LhaqTIHv5F+AFsQ4RyVg99YZiCNqxI0VpdhdF+yUvhFFhSgMSqCyDoyaGzGVwt+Y8lB3aIhg0geIbSuPq0a+i3LD3CLlghbZkthcR+iQvAbZQa6xUKEe2jJ4XWzrVLwG+UGfIuXDFGpGPotpQd/SxUZqod+CxOxw2oyEPr7MCmdZBOCwPfBJA0QRQrCfh0mzghtOQi5Df8BVyNch7+ahwEAAAAASUVORK5CYII=" style="width:42px;height:42px;border-radius:10px;">
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:700;color:#e2eaf4;">Install NurseVault</div>
        <div style="font-size:11px;color:#7a92aa;margin-top:2px;">Add to home screen for offline access</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <button onclick="doInstallPWA()" style="
          background:linear-gradient(135deg,#38bdf8,#818cf8);border:none;
          border-radius:8px;padding:7px 14px;color:white;font-size:12px;
          font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;">Install</button>
        <button onclick="dismissInstallBanner()" style="
          background:none;border:none;color:#7a92aa;font-size:11px;
          cursor:pointer;font-family:'DM Mono',monospace;">Not now</button>
      </div>
    </div>
  `;
  document.body.appendChild(banner);
}

function doInstallPWA(){
  if(!_deferredInstallPrompt) return;
  _deferredInstallPrompt.prompt();
  _deferredInstallPrompt.userChoice.then(result => {
    if(result.outcome === 'accepted') toast('\u2713 NurseVault installed!');
    _deferredInstallPrompt = null;
    dismissInstallBanner();
  });
}

function dismissInstallBanner(){
  const b = document.getElementById('nvInstallBanner');
  if(b) b.remove();
  _deferredInstallPrompt = null;
}

window.addEventListener('appinstalled', function(){
  toast('\u2713 NurseVault added to home screen!');
  dismissInstallBanner();
});
</script>
<style>
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
</style>

<!-- CALL OVERLAY -->
<div id="callOverlay">
  <div class="call-ov-av" id="callOvAv">?</div>
  <div class="call-ov-name" id="callOvName">Calling...</div>
  <div class="call-ov-status" id="callOvStatus">Calling...</div>
  <div class="call-ov-timer" id="callOvTimer"></div>
  <div class="call-ov-participants" id="callOvParticipants" style="display:none;"></div>
  <div class="call-ov-btns">
    <button class="call-ov-btn mute" id="callMuteBtn" onclick="toggleCallMute()" title="Mute">ðŸŽ¤</button>
    <button class="call-ov-btn end" onclick="endCall()" title="End call">ðŸ“µ</button>
    <button class="call-ov-btn speaker" id="callSpeakerBtn" onclick="toggleSpeaker()" title="Speaker">ðŸ”Š</button>
  </div>
</div>
<!-- INCOMING CALL NOTIFICATION -->
<div class="call-incoming" id="callIncoming">
  <div class="call-inc-row">
    <div class="call-inc-av" id="callIncAv">?</div>
    <div class="call-inc-info">
      <div class="call-inc-name" id="callIncName">Unknown</div>
      <div class="call-inc-type" id="callIncType">ðŸ“ž Incoming voice call</div>
    </div>
  </div>
  <div class="call-inc-btns">
    <button class="call-inc-btn accept" onclick="acceptCall()">Accept</button>
    <button class="call-inc-btn decline" onclick="declineCall()">Decline</button>
  </div>
</div>




<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NURSEVAULT VOICE CALL ENGINE â€” PeerJS Edition
// Real cross-device calls via PeerJS cloud signaling
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _peer          = null;   // PeerJS instance
let _peerId        = null;   // our PeerJS ID (= 'nv_' + userId)
let _callState     = null;   // null | 'outgoing' | 'incoming' | 'active'
let _callType      = null;   // 'dm' | 'group'
let _activeCall    = null;   // current PeerJS MediaConnection (dm)
let _groupCalls    = {};     // peerId -> MediaConnection (group)
let _localStream   = null;
let _remoteAudios  = {};     // peerId -> <audio>
let _callTimerInt  = null;
let _callTimerSec  = 0;
let _callMuted     = false;
let _callSpeaker   = true;
let _callerId      = null;
let _callerName    = null;
let _callThreadId  = null;
let _callParticipants = [];
let _peerInitTries = 0;

// â”€â”€ Make a PeerJS-compatible ID from a user ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvPeerId(uid){ return 'nv' + uid.replace(/[^a-zA-Z0-9]/g,''); }

// â”€â”€ Initialize PeerJS (called after login) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initCallPeer(){
  if(!myId()) return;
  if(_peer && !_peer.destroyed) return;
  _peerId = nvPeerId(myId());
  try{
    _peer = new Peer(_peerId, {
      host: '0.peerjs.com', port: 443, path: '/', secure: true,
      debug: 0,
      config:{ iceServers:[
        {urls:'stun:stun.l.google.com:19302'},
        {urls:'stun:stun1.l.google.com:19302'}
      ]}
    });

    _peer.on('open', id => {
      console.log('[NurseVault] PeerJS connected:', id);
    });

    // â”€â”€ Handle incoming call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _peer.on('call', incomingCall => {
      if(_callState){ incomingCall.close(); return; } // busy
      _callerId     = incomingCall.peer;
      _callerName   = incomingCall.metadata && incomingCall.metadata.callerName ? incomingCall.metadata.callerName : 'Someone';
      const callType= incomingCall.metadata && incomingCall.metadata.callType ? incomingCall.metadata.callType : 'dm';
      const className= incomingCall.metadata && incomingCall.metadata.className ? incomingCall.metadata.className : '';
      _callThreadId = incomingCall.metadata && incomingCall.metadata.threadId ? incomingCall.metadata.threadId : '';
      _callType     = callType;
      _activeCall   = incomingCall;

      // Show incoming call UI
      const inc = document.getElementById('callIncoming');
      inc.dataset.callObj = 'pending';
      document.getElementById('callIncAv').textContent   = (_callerName||'?')[0].toUpperCase();
      document.getElementById('callIncName').textContent  = _callerName;
      document.getElementById('callIncType').textContent  =
        callType === 'group' ? 'ðŸ‘¥ ' + className + ' group call' : 'ðŸ“ž Incoming voice call';
      inc.classList.add('active');
      // Ringtone pulse on avatar
      _callState = 'incoming';
      // Auto-decline after 30s
      setTimeout(()=>{ if(_callState==='incoming') declineCall(); }, 30000);
    });

    _peer.on('error', err => {
      console.warn('[NurseVault] PeerJS error:', err.type, err.message);
      if(err.type === 'unavailable-id'){
        // ID taken â€” add suffix and retry
        _peerInitTries++;
        if(_peerInitTries < 3){
          _peer.destroy();
          _peer = null;
          _peerId = nvPeerId(myId()) + _peerInitTries;
          setTimeout(initCallPeer, 1000);
        }
      }
      if(err.type === 'peer-unavailable'){
        toast('ðŸ“µ User is not available for calls right now');
        _resetCallState();
      }
      if(err.type === 'network' || err.type === 'server-error'){
        setTimeout(()=>{ if(_peer&&_peer.destroyed){ initCallPeer(); } }, 3000);
      }
    });

    _peer.on('disconnected', ()=>{
      setTimeout(()=>{ if(_peer&&!_peer.destroyed){ try{_peer.reconnect();}catch(e){} } }, 2000);
    });

  } catch(e){
    console.warn('[NurseVault] PeerJS init failed:', e);
  }
}

// Hook into login so peer initializes after sign-in
const _origDoLogin = typeof doLogin === 'function' ? doLogin : null;
document.addEventListener('DOMContentLoaded', ()=>{
  // Re-init peer if user is already logged in (page reload)
  setTimeout(()=>{ if(myId()) initCallPeer(); }, 500);
});

// showView hook is in original function

// â”€â”€ Update call buttons in chat header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateCallButtons(){
  const vBtn = document.getElementById('callVoiceBtn');
  const gBtn = document.getElementById('callGroupBtn');
  if(!vBtn || !gBtn || !activeThreadId) return;
  const isDM    = activeThreadId.startsWith('dm:');
  const isGroup = activeThreadId.startsWith('classgroup:') || activeThreadId.startsWith('announce:');
  const isTeacher = currentRole==='teacher' || currentRole==='admin';
  vBtn.style.display = isDM ? 'flex' : 'none';
  gBtn.style.display = (isGroup && isTeacher) ? 'flex' : 'none';
}

// Hook updateCallButtons into openThread
// openThread hook already in original function

// â”€â”€ Start 1-on-1 voice call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startVoiceCall(){
  if(_callState){ toast('Already in a call'); return; }
  if(!_peer || _peer.destroyed){ toast('Connectingâ€¦ try again in a moment'); initCallPeer(); return; }
  if(!activeThreadId || !activeThreadId.startsWith('dm:')){ toast('Open a DM first'); return; }

  const parts  = activeThreadId.split(':').slice(1);
  const peerId = parts.find(id => id !== myId());
  if(!peerId){ toast('Cannot find peer'); return; }
  const peer   = getAllUsers().find(u => u.id === peerId);
  const peerName = peer ? (peer.name||peer.username) : 'User';
  const remotePeerId = nvPeerId(peerId);

  _startCallMedia().then(stream => {
    _localStream = stream;
    _callState   = 'outgoing';
    _callType    = 'dm';
    _callParticipants = [{id: peerId, name: peerName}];
    _showCallOverlay(peerName, 'ðŸ“ž Calling ' + peerName + 'â€¦');

    const call = _peer.call(remotePeerId, stream, {
      metadata:{ callerName: currentUser.name||currentUser.username||'Someone', callType:'dm', threadId: activeThreadId }
    });
    _activeCall = call;
    _bindCallEvents(call, peerId);

    // Timeout if no answer in 30s
    setTimeout(()=>{ if(_callState==='outgoing'){ toast('ðŸ“µ No answer'); _resetCallState(); } }, 30000);

  }).catch(()=>{ toast('ðŸŽ¤ Microphone access denied'); });
}

// â”€â”€ Start group call (teacher/admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGroupCall(){
  if(_callState){ toast('Already in a call'); return; }
  if(!_peer || _peer.destroyed){ toast('Connectingâ€¦ try again in a moment'); initCallPeer(); return; }
  if(!activeThreadId){ toast('Open a class channel first'); return; }

  const classId  = activeThreadId.split(':')[1];
  const classObj = (db.classes||[]).find(c => c.id === classId);
  const className= classObj ? classObj.name : 'Class';
  const students = (db.users||[]).filter(u => u.role==='student' && u.classId===classId);

  if(!students.length){ toast('No students in this class'); return; }

  _startCallMedia().then(stream => {
    _localStream = stream;
    _callState   = 'outgoing';
    _callType    = 'group';
    _callParticipants = students.map(u => ({id: u.id, name: u.name||u.username}));
    _showCallOverlay(className + ' Group Call', 'ðŸ“ž Calling ' + students.length + ' student' + (students.length!==1?'s':'') + 'â€¦');
    _showGroupParticipants();

    // Call each student
    students.forEach(u => {
      const remotePeerId = nvPeerId(u.id);
      try{
        const call = _peer.call(remotePeerId, stream, {
          metadata:{ callerName: currentUser.name||currentUser.username||'Lecturer', callType:'group', className, threadId: activeThreadId }
        });
        _groupCalls[u.id] = call;
        _bindCallEvents(call, u.id);
      } catch(e){ console.warn('Could not call', u.id, e); }
    });

    // Start timer immediately for group (students join when they accept)
    _callState = 'active';
    _startCallTimer();
    document.getElementById('callOvStatus').textContent = 'ðŸŸ¢ Live â€” waiting for studentsâ€¦';

  }).catch(()=>{ toast('ðŸŽ¤ Microphone access denied'); });
}

// â”€â”€ Accept incoming call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function acceptCall(){
  document.getElementById('callIncoming').classList.remove('active');
  if(!_activeCall){ _callState = null; return; }
  _startCallMedia().then(stream => {
    _localStream = stream;
    _callState   = 'active';
    const callerDisplayName = _callerName || 'Caller';
    _showCallOverlay(callerDisplayName, 'ðŸ”— Connectingâ€¦');
    _activeCall.answer(stream);
    _bindCallEvents(_activeCall, _callerId);
    _startCallTimer();
    document.getElementById('callOvStatus').textContent = 'ðŸŸ¢ Connected';
  }).catch(()=>{ toast('ðŸŽ¤ Microphone access denied'); _resetCallState(); });
}

// â”€â”€ Decline incoming call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function declineCall(){
  document.getElementById('callIncoming').classList.remove('active');
  if(_activeCall){ try{ _activeCall.close(); }catch(e){} }
  _callState = null;
  _activeCall = null;
}

// â”€â”€ End call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function endCall(){
  if(_activeCall){ try{ _activeCall.close(); }catch(e){} }
  Object.values(_groupCalls).forEach(c=>{ try{ c.close(); }catch(e){} });
  _resetCallState();
  toast('ðŸ“µ Call ended');
}

// â”€â”€ Bind events to a PeerJS MediaConnection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _bindCallEvents(call, peerId){
  call.on('stream', remoteStream => {
    if(!_remoteAudios[peerId]){
      const audio = document.createElement('audio');
      audio.autoplay = true;
      audio.setAttribute('playsinline','');
      document.body.appendChild(audio);
      _remoteAudios[peerId] = audio;
    }
    _remoteAudios[peerId].srcObject = remoteStream;
    if(_callState === 'outgoing'){ _callState = 'active'; _startCallTimer(); }
    document.getElementById('callOvStatus').textContent = 'ðŸŸ¢ Connected';
    _updateParticipantSpeaking(peerId, true);
  });

  call.on('close', ()=>{
    if(_remoteAudios[peerId]){ _remoteAudios[peerId].remove(); delete _remoteAudios[peerId]; }
    delete _groupCalls[peerId];
    const remaining = Object.keys(_remoteAudios).length;
    if(remaining === 0 && _callState === 'active'){
      toast('ðŸ“µ Call ended');
      _resetCallState();
    }
  });

  call.on('error', err=>{
    console.warn('[NurseVault] call error:', err);
    toast('ðŸ“µ Call connection failed');
    _resetCallState();
  });
}

// â”€â”€ Media â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _startCallMedia(){
  return navigator.mediaDevices.getUserMedia({ audio:true, video:false });
}

// â”€â”€ Reset all call state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _resetCallState(){
  if(_callTimerInt){ clearInterval(_callTimerInt); _callTimerInt=null; }
  if(_localStream){ _localStream.getTracks().forEach(t=>t.stop()); _localStream=null; }
  Object.values(_remoteAudios).forEach(el=>{ try{el.remove();}catch(e){} });
  _remoteAudios = {}; _groupCalls = {};
  _callState=null; _callType=null; _activeCall=null;
  _callerId=null; _callerName=null; _callTimerSec=0;
  _callMuted=false;
  document.getElementById('callOverlay').classList.remove('active');
  document.getElementById('callIncoming').classList.remove('active');
}

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _showCallOverlay(name, status){
  document.getElementById('callOvAv').textContent    = (name||'?')[0].toUpperCase();
  document.getElementById('callOvName').textContent  = name;
  document.getElementById('callOvStatus').textContent= status;
  document.getElementById('callOvTimer').textContent = '';
  document.getElementById('callOvParticipants').style.display = 'none';
  document.getElementById('callOverlay').classList.add('active');
}

function _startCallTimer(){
  if(_callTimerInt) return;
  _callTimerSec = 0;
  _callTimerInt = setInterval(()=>{
    _callTimerSec++;
    const m = Math.floor(_callTimerSec/60).toString().padStart(2,'0');
    const s = (_callTimerSec%60).toString().padStart(2,'0');
    const el = document.getElementById('callOvTimer');
    if(el) el.textContent = m+':'+s;
  }, 1000);
}

function _showGroupParticipants(){
  const el = document.getElementById('callOvParticipants');
  if(!el) return;
  el.style.display = 'flex';
  el.innerHTML = _callParticipants.map(p=>
    `<div class="call-ov-part">
      <div class="call-ov-part-av" id="part_${p.id}">${(p.name||'?')[0].toUpperCase()}</div>
      <div class="call-ov-part-name">${(p.name||'').split(' ')[0]}</div>
    </div>`
  ).join('');
}

function _updateParticipantSpeaking(peerId, speaking){
  const el = document.getElementById('part_'+peerId);
  if(el) el.classList.toggle('speaking', speaking);
}

// â”€â”€ Mute / Speaker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleCallMute(){
  _callMuted = !_callMuted;
  if(_localStream) _localStream.getAudioTracks().forEach(t=> t.enabled = !_callMuted);
  const btn = document.getElementById('callMuteBtn');
  if(btn){ btn.textContent = _callMuted ? 'ðŸ”‡' : 'ðŸŽ¤'; btn.classList.toggle('active', _callMuted); }
  toast(_callMuted ? 'ðŸ”‡ Muted' : 'ðŸŽ¤ Unmuted');
}

function toggleSpeaker(){
  _callSpeaker = !_callSpeaker;
  Object.values(_remoteAudios).forEach(el=> el.muted = !_callSpeaker);
  const btn = document.getElementById('callSpeakerBtn');
  if(btn){ btn.textContent = _callSpeaker ? 'ðŸ”Š' : 'ðŸ”ˆ'; btn.classList.toggle('active', _callSpeaker); }
}
</script>

</body>
</html>
