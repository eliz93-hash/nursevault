<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" id="__nvManifest">
<script>
(function(){
  var m = {"name": "NurseVault â€” Nursing School Handouts", "short_name": "NurseVault", "description": "Nursing school handouts, past questions, results and more.", "start_url": "./", "display": "standalone", "background_color": "#1F4E54", "theme_color": "#3E8E95", "orientation": "portrait-primary", "icons": [{"src": "./icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable"}, {"src": "./icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable"}]};
  var blob = new Blob([JSON.stringify(m)], {type:'application/json'});
  document.getElementById('__nvManifest').href = URL.createObjectURL(blob);
})();
</script>
<meta name="theme-color" content="#3E8E95">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NurseVault">
<link rel="apple-touch-icon" href="./icon-192.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="NurseVault">
<title>NurseVault â€” Nursing School Handouts</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Instrument+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// PDF.js config â€” set after load too in case script is deferred
function initPdfJs(){
  if(typeof pdfjsLib!=='undefined'){
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    window['pdfjs-dist/build/pdf']=pdfjsLib;
  }
}
initPdfJs();
window.addEventListener('load', initPdfJs);
</script>
<style>
:root {
  --bg:#1F4E54;--bg2:#1B3F44;--bg3:#163439;--bg4:#122b2f;
  --border:rgba(255,255,255,0.10);--border-hover:rgba(255,255,255,0.22);
  --accent:#3E8E95;--accent2:#BFD2C5;--accent3:#5aada0;--accent4:#e07b7b;
  --text:#FFFFFF;--text2:#E6ECEE;--text3:#A7B5B8;
  --card:#245B61;--card-hover:#2a6870;
  --nd1:#3E8E95;--nd2:#BFD2C5;--hnd1:#5aada0;--hnd2:#e07b7b;
}
/* â”€â”€ DARK THEME â€” true deep dark â”€â”€ */
body.dark {
  --bg:#0a0a0f;--bg2:#111118;--bg3:#18181f;--bg4:#1e1e27;
  --border:rgba(255,255,255,0.07);--border-hover:rgba(255,255,255,0.18);
  --accent:#4fb3bc;--accent2:#a8d5cb;--accent3:#5aada0;--accent4:#f87171;
  --text:#eef2f6;--text2:#c0cdd8;--text3:#6d8394;
  --card:#13131a;--card-hover:#1a1a23;
  --nd1:#4fb3bc;--nd2:#a8d5cb;--hnd1:#5aada0;--hnd2:#f87171;
}
body.dark{background:var(--bg);color:var(--text);}
body.dark::after{background:radial-gradient(ellipse 70% 40% at 15% 10%,rgba(79,179,188,.05) 0%,transparent 60%),radial-gradient(ellipse 50% 35% at 85% 90%,rgba(168,213,203,.03) 0%,transparent 60%);}
body.dark .sidebar{background:var(--bg2);}
body.dark .modal,body.dark .overlay .modal{background:#13131a;border-color:rgba(255,255,255,.08);}
body.dark .inp,body.dark .sel-inp,body.dark .search-inp,body.dark .sel{background:#1e1e27;border-color:rgba(255,255,255,.08);color:var(--text);}
body.dark .nv-card{background:#13131a;}
body.dark .nv-tabs{background:rgba(0,0,0,.5);}
body.dark .nv-tab-btn.active{background:#1e1e2a;color:var(--text);}
body.dark .nv-input{background:#1e1e27;border-color:rgba(255,255,255,.08);color:var(--text);}
body.dark .nv-btn-secondary{background:rgba(255,255,255,.05);}
body.dark .topbar{background:rgba(10,10,15,.95);border-color:rgba(255,255,255,.06);}
body.dark .btn-cancel{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.08);}
body.dark details[style*="background:var(--bg3)"],body.dark .auth-notice-like{background:#1e1e27;}
body.dark .skill-card,body.dark .drug-card,body.dark .nv-pq-bank-card{background:#13131a;}
body.dark .msg-sidebar{background:#111118;}
body.dark .msg-bubble-me{background:rgba(79,179,188,.25);}
body.dark .nv-dash-tile{background:#13131a;}

/* â”€â”€ LIGHT THEME â€” soft teal & grey â”€â”€ */
body.light {
  --bg:#e8f0f1;--bg2:#d6dddf;--bg3:#c8d4d6;--bg4:#b8c6c9;
  --border:rgba(30,70,80,0.14);--border-hover:rgba(30,70,80,0.30);
  --accent:#3E8E95;--accent2:#245B61;--accent3:#5aada0;--accent4:#c0392b;
  --text:#122b2f;--text2:#2c5158;--text3:#5a787c;
  --card:#d6dddf;--card-hover:#c8d4d6;
  --nd1:#3E8E95;--nd2:#245B61;--hnd1:#5aada0;--hnd2:#c0392b;
}
body.light{background:var(--bg);color:var(--text);}
body.light body::after{display:none;}
body.light .auth-brand-name,body.light .logo-text{background:linear-gradient(135deg,#3E8E95,#245B61);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;}
body.light .btn-primary,body.light .btn-action,body.light .btn-submit,body.light .btn-submit-green,body.light .pv-dl-btn{background:linear-gradient(135deg,#3E8E95,#245B61);}
body.light .auth-tab.active{background:rgba(62,142,149,.15);border-color:#3E8E95;color:#3E8E95;}
body.light .inp:focus,body.light .sel-inp:focus,body.light .search-inp:focus,body.light .sel:focus{border-color:#3E8E95;}
body.light .nav-item.active{background:rgba(62,142,149,.12);color:#3E8E95;}
body.light .user-av,.light .logo-icon,.light .auth-brand-icon{background:linear-gradient(135deg,#3E8E95,#245B61);}
body.light .class-card:hover{box-shadow:0 12px 32px rgba(30,70,80,.15);}
body.light #authPage{/* uses same background image */}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Instrument Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 10% 20%,rgba(62,142,149,.07) 0%,transparent 60%),radial-gradient(ellipse 60% 40% at 90% 80%,rgba(191,210,197,.06) 0%,transparent 60%);pointer-events:none;z-index:0;}

/* LAYOUT */
.app{display:flex;min-height:100vh;}
/* Theme toggle button */
.theme-btn{display:inline-flex;align-items:center;gap:5px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:5px 11px;cursor:pointer;font-size:13px;color:var(--text2);transition:all .22s;white-space:nowrap;font-family:'Instrument Sans',sans-serif;}
.theme-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--card);}
.theme-btn-label{font-size:11px;font-family:'DM Mono',monospace;letter-spacing:.03em;}
@media(max-width:640px){.theme-btn-label{display:none;}}
.sidebar{width:260px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:100;transition:transform .3s;overflow-y:auto;}
.main{flex:1;margin-left:260px;min-height:100vh;position:relative;z-index:1;}

/* AUTH */
#authPage{position:fixed;inset:0;background:url('./auth-bg.jpg') center center / cover no-repeat;display:flex;align-items:center;justify-content:center;z-index:9999;overflow-y:auto;}
.auth-wrap{width:100%;max-width:420px;padding:20px;animation:fadeUp .5s ease;margin:auto;}
.auth-card{background:rgba(8,12,16,0.88);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:20px;padding:40px 36px;}
.auth-brand{display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.auth-brand-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.auth-brand-name{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.auth-sub{color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;margin-bottom:28px;}
.auth-tabs{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:24px;}
.auth-tab{padding:9px 4px;text-align:center;border-radius:8px;cursor:pointer;font-size:12px;color:var(--text2);background:var(--bg3);border:1px solid var(--border);font-family:'DM Mono',monospace;transition:all .2s;}
.auth-tab:hover{border-color:var(--border-hover);color:var(--text);}
.auth-tab.active{background:rgba(62,142,149,.12);border-color:var(--accent);color:var(--accent);}
.inp-label{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;display:block;}
.inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:11px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;margin-bottom:14px;}
.inp:focus{border-color:var(--accent);}
.inp.error{border-color:var(--accent4);}
.sel-inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:11px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;margin-bottom:14px;appearance:none;cursor:pointer;}
.sel-inp:focus{border-color:var(--accent);}
.inp-err{font-size:11px;color:var(--accent4);font-family:'DM Mono',monospace;margin-top:-10px;margin-bottom:12px;display:none;}
.inp-err.show{display:block;}
.btn-primary{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:4px;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(62,142,149,.25);}
.auth-switch{text-align:center;margin-top:16px;font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;}
.auth-switch span{color:var(--accent);cursor:pointer;text-decoration:underline;}
.auth-notice{background:rgba(251,191,36,.07);border:1px solid rgba(251,191,36,.2);border-radius:10px;padding:10px 14px;font-size:11px;color:#fbbf24;font-family:'DM Mono',monospace;margin-bottom:18px;line-height:1.6;}
.auth-info{background:rgba(62,142,149,.07);border:1px solid rgba(62,142,149,.2);border-radius:10px;padding:10px 14px;font-size:11px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:18px;line-height:1.6;}

/* SIDEBAR */
.sidebar-logo{padding:20px 20px 8px;display:flex;align-items:center;gap:10px;}
.logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.logo-text{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.sidebar-section-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;letter-spacing:.1em;text-transform:uppercase;padding:0 14px;margin:14px 0 6px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;border-radius:8px;cursor:pointer;color:var(--text2);font-size:13.5px;transition:all .2s;margin:1px 8px;}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:rgba(62,142,149,.1);color:var(--accent);}
.nav-item .ni{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.sidebar-user{margin-top:auto;border-top:1px solid var(--border);padding:14px 16px;}
.user-row{display:flex;align-items:center;gap:10px;}
.user-av{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
.user-nm{font-size:13px;font-weight:600;}
.user-rl{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.logout-btn{width:100%;margin-top:8px;padding:8px;background:transparent;border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.05em;}
.logout-btn:hover{border-color:var(--accent4);color:var(--accent4);}
.user-av-img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
.profile-btn{background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;gap:10px;width:100%;text-align:left;}
.profile-btn:hover .user-av{box-shadow:0 0 0 2px var(--accent);}
/* â”€â”€ User Management Cards â”€â”€ */
.users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:16px;}
.user-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;display:flex;flex-direction:column;gap:14px;animation:fadeUp .35s ease forwards;opacity:0;position:relative;overflow:hidden;transition:border-color .2s,transform .2s;}
.user-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));}
.user-card.role-admin::before{background:linear-gradient(90deg,#fbbf24,#f59e0b);}
.user-card.role-teacher::before{background:linear-gradient(90deg,var(--accent),var(--accent2));}
.user-card.role-student::before{background:linear-gradient(90deg,var(--accent3),#3E8E95);}
.user-card:hover{border-color:var(--border-hover);transform:translateY(-2px);}
.user-card-avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:white;flex-shrink:0;overflow:hidden;border:2px solid var(--border);}
.user-card-avatar img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.user-card-head{display:flex;align-items:center;gap:12px;}
.user-card-info{flex:1;min-width:0;}
.user-card-name{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-card-role{font-size:10px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-top:2px;}
.user-card-meta{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.user-card-field{background:var(--bg3);border-radius:8px;padding:8px 10px;}
.user-card-field-lbl{font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);margin-bottom:3px;}
.user-card-field-val{font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-card-actions{display:flex;gap:8px;}
/* â”€â”€ Profile Modal â”€â”€ */
.profile-modal-av-wrap{position:relative;width:90px;height:90px;margin:0 auto 20px;cursor:pointer;}
.profile-modal-av{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:700;color:white;overflow:hidden;border:3px solid var(--border);}
.profile-modal-av img{width:100%;height:100%;object-fit:cover;}
.profile-av-edit-badge{position:absolute;bottom:0;right:0;width:26px;height:26px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;border:2px solid var(--bg2);cursor:pointer;transition:transform .2s;}
.profile-av-edit-badge:hover{transform:scale(1.15);}
.profile-section-title{font-size:10px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);margin:18px 0 10px;border-bottom:1px solid var(--border);padding-bottom:6px;}

/* â”€â”€ Document Vault â”€â”€ */
.doc-vault-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
.doc-vault-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;transition:border-color .2s;}
.doc-vault-item:hover{border-color:var(--border-hover);}
.doc-vault-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.doc-vault-name{flex:1;font-size:13px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.doc-vault-meta{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;}
.doc-vault-actions{display:flex;gap:6px;flex-shrink:0;}
.doc-vault-btn{padding:5px 9px;border:1px solid var(--border);background:var(--bg4);border-radius:6px;color:var(--text2);font-size:11px;cursor:pointer;transition:all .2s;font-family:'DM Mono',monospace;}
.doc-vault-btn:hover{border-color:var(--accent);color:var(--accent);}
.doc-vault-btn.danger:hover{border-color:var(--accent4);color:var(--accent4);}
.doc-upload-zone{border:2px dashed var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;margin-top:8px;}
.doc-upload-zone:hover,.doc-upload-zone.drag-over{border-color:var(--accent);background:rgba(62,142,149,.04);}
.doc-upload-zone-icon{font-size:24px;margin-bottom:6px;}
.doc-upload-zone-text{font-size:12px;color:var(--text2);}
.doc-upload-zone-sub{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;}
.prof-id-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;background:rgba(62,142,149,.1);color:var(--accent);border:1px solid rgba(62,142,149,.2);margin-bottom:2px;}
.doc-empty{text-align:center;padding:20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;}
.doc-preview-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:2000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.doc-preview-modal.open{opacity:1;pointer-events:all;}
.doc-preview-inner{background:var(--bg2);border:1px solid var(--border);border-radius:16px;width:90vw;max-width:860px;max-height:90vh;display:flex;flex-direction:column;}
.doc-preview-header{display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid var(--border);}
.doc-preview-title{flex:1;font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.doc-preview-actions{display:flex;gap:8px;}
.doc-preview-body{flex:1;overflow:auto;padding:20px;}

/* â”€â”€ Messaging System â”€â”€ */
.msg-layout{display:flex;height:calc(100vh - 64px);overflow:hidden;}
.msg-sidebar{width:280px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg2);flex-shrink:0;}
.msg-sidebar-head{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.msg-sidebar-title{font-weight:700;font-size:15px;flex:1;}
.msg-new-btn{width:30px;height:30px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s;color:var(--text2);}
.msg-new-btn:hover{border-color:var(--accent);color:var(--accent);}
.msg-search{padding:10px 14px;border-bottom:1px solid var(--border);}
.msg-search input{width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;font-family:'DM Mono',monospace;outline:none;transition:border-color .2s;}
.msg-search input:focus{border-color:var(--accent);}
.msg-channels{flex:1;overflow-y:auto;padding:8px;}
.msg-channel-group-label{font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);padding:10px 8px 4px;}
.msg-channel-item{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:10px;cursor:pointer;transition:background .15s;position:relative;margin-bottom:2px;}
.msg-channel-item:hover{background:var(--bg3);}
.msg-channel-item.active{background:var(--card-hover);border:1px solid var(--border-hover);}
.msg-channel-av{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;font-weight:700;overflow:hidden;}
.msg-channel-av img{width:100%;height:100%;object-fit:cover;}
.msg-channel-info{flex:1;min-width:0;}
.msg-channel-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msg-channel-preview{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'DM Mono',monospace;margin-top:1px;}
.msg-channel-time{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;flex-shrink:0;}
.msg-unread{width:18px;height:18px;border-radius:50%;background:var(--accent);color:#000;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;position:absolute;top:8px;right:8px;}
.msg-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.msg-main-head{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid var(--border);background:var(--bg2);}
.msg-main-av{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;overflow:hidden;flex-shrink:0;}
.msg-main-av img{width:100%;height:100%;object-fit:cover;}
.msg-main-name{font-weight:700;font-size:15px;}
.msg-main-sub{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;}
.msg-body{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:4px;}
.msg-date-divider{text-align:center;margin:12px 0 8px;}
.msg-date-divider span{font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);background:var(--bg3);padding:3px 10px;border-radius:20px;border:1px solid var(--border);}
.msg-bubble-wrap{display:flex;align-items:flex-end;gap:8px;margin-bottom:4px;}
.msg-bubble-wrap.mine{flex-direction:row-reverse;}
.msg-bubble-wrap.mine .msg-av-sm{display:none;}
.msg-av-sm{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;overflow:hidden;align-self:flex-end;}
.msg-av-sm img{width:100%;height:100%;object-fit:cover;}
.msg-bubble-col{display:flex;flex-direction:column;max-width:68%;}
.msg-sender-name{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:3px;padding-left:2px;}
.msg-bubble{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.55;word-break:break-word;position:relative;}
.msg-bubble.them{background:var(--bg3);border:1px solid var(--border);color:var(--text);border-bottom-left-radius:4px;}
.msg-bubble.mine{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-bottom-right-radius:4px;}
.msg-bubble.lecture{background:linear-gradient(135deg,rgba(224,123,123,.15),rgba(251,191,36,.08));border:1px solid rgba(224,123,123,.2);color:var(--text);border-bottom-left-radius:4px;}
.msg-bubble.lecture::before{content:'ðŸ“¢';position:absolute;top:-8px;left:10px;font-size:12px;}
.msg-bubble-time{font-size:9px;font-family:'DM Mono',monospace;margin-top:3px;padding-left:2px;}
.msg-bubble-wrap.mine .msg-bubble-time{text-align:right;color:rgba(255,255,255,.6);}
.msg-bubble-wrap:not(.mine) .msg-bubble-time{color:var(--text3);}
.msg-input-bar{display:flex;align-items:flex-end;gap:10px;padding:14px 20px;border-top:1px solid var(--border);background:var(--bg2);}
.msg-input-wrap{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:10px 14px;transition:border-color .2s;}
.msg-input-wrap:focus-within{border-color:var(--accent);}
.msg-input{width:100%;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:'Instrument Sans',sans-serif;resize:none;max-height:100px;line-height:1.5;}
.msg-send-btn{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:opacity .2s;flex-shrink:0;}
.msg-send-btn:hover{opacity:.85;}
.msg-icon-btn{width:38px;height:38px;border-radius:10px;background:var(--bg3);border:1px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:all .2s;flex-shrink:0;color:var(--text2);}
.msg-icon-btn:hover{border-color:var(--accent);color:var(--accent);}
.msg-icon-btn.rec-active{background:rgba(224,123,123,.15);border-color:#e07b7b;color:#e07b7b;animation:pulse 1s ease-in-out infinite;}
/* File bubble */
.msg-file-bubble{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:12px;cursor:pointer;max-width:270px;transition:opacity .2s;}
.msg-file-bubble:hover{opacity:.82;}
.msg-file-bubble.mine{background:rgba(255,255,255,.15);}
.msg-file-bubble.them{background:var(--bg4,var(--bg3));border:1px solid var(--border);}
.msg-file-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.msg-file-info{flex:1;min-width:0;}
.msg-file-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msg-file-meta{font-size:10px;font-family:'DM Mono',monospace;opacity:.6;margin-top:2px;}
/* Image bubble */
.msg-img-thumb{max-width:220px;border-radius:12px;overflow:hidden;cursor:pointer;display:inline-block;}
.msg-img-thumb img{width:100%;display:block;}
/* Voice bubble */
.msg-voice-bubble{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:14px;min-width:200px;max-width:280px;}
.msg-voice-play{width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;transition:transform .15s;}
.msg-voice-play:hover{transform:scale(1.08);}
.msg-voice-bars{flex:1;display:flex;align-items:center;gap:2px;height:28px;cursor:pointer;}
.msg-voice-bar-item{flex:1;border-radius:2px;transition:opacity .2s;}
.msg-voice-dur{font-size:10px;font-family:'DM Mono',monospace;flex-shrink:0;}
/* Recording bar */
.msg-record-bar{display:none;align-items:center;gap:12px;padding:12px 20px;border-top:1px solid var(--border);background:var(--bg2);}
.msg-record-bar.active{display:flex;}
.msg-rec-timer{font-family:'DM Mono',monospace;font-size:14px;font-weight:700;color:#e07b7b;min-width:48px;}
.msg-rec-wave{flex:1;height:32px;background:var(--bg3);border-radius:8px;overflow:hidden;display:flex;align-items:center;gap:2px;padding:0 8px;}
.msg-rec-wave-bar{flex:1;border-radius:2px;background:#e07b7b;transition:height .12s;}
.msg-rec-cancel{padding:7px 13px;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--text2);font-size:12px;cursor:pointer;font-family:'DM Mono',monospace;transition:all .2s;}
.msg-rec-cancel:hover{border-color:#e07b7b;color:#e07b7b;}
.msg-rec-send{padding:7px 13px;border:none;border-radius:8px;background:#e07b7b;color:#fff;font-size:12px;cursor:pointer;font-family:'DM Mono',monospace;font-weight:700;transition:opacity .2s;}
@keyframes recPulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.5;transform:scale(1.2);}}
.msg-rec-send:hover{opacity:.85;}
.msg-empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text3);}
.msg-empty-icon{font-size:48px;opacity:.4;}
.msg-empty-text{font-size:14px;font-weight:600;color:var(--text2);}
.msg-empty-sub{font-size:12px;font-family:'DM Mono',monospace;}
.new-chat-modal-body{padding:16px;}
.msg-recipient-list{display:flex;flex-direction:column;gap:4px;max-height:calc(50vh - 60px);overflow-y:auto;}
.msg-recipient-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .2s;}
.msg-recipient-item:hover{border-color:var(--accent);background:var(--card-hover);}
.msg-recipient-av{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;overflow:hidden;flex-shrink:0;}
.msg-recipient-av img{width:100%;height:100%;object-fit:cover;}
.msg-typing{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;padding:4px 20px 0;}
.msg-announce-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;background:rgba(224,123,123,.1);border:1px solid rgba(224,123,123,.2);border-radius:6px;font-size:10px;color:#e07b7b;font-family:'DM Mono',monospace;margin-left:8px;}
@media(max-width:640px){.msg-sidebar{width:100%;position:absolute;z-index:10;height:100%;}.msg-sidebar.mobile-hidden{display:none;}.msg-main{width:100%;}.msg-back-btn{display:flex!important;}}
/* â”€â”€ Classmates Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.msg-classmates{width:240px;border-left:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg2);flex-shrink:0;transition:width .3s;}
.msg-classmates-head{padding:14px 14px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.msg-classmates-title{font-size:12px;font-weight:700;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.08em;color:var(--text2);display:flex;align-items:center;gap:6px;}
.msg-classmates-sub{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;}
.msg-classmates-search{padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.msg-classmates-search input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:6px 10px;color:var(--text);font-size:12px;font-family:'Instrument Sans',sans-serif;outline:none;}
.msg-classmates-search input:focus{border-color:var(--accent);}
.msg-classmates-list{flex:1;overflow-y:auto;padding:6px;}
.msg-classmate-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:9px;cursor:pointer;transition:all .15s;border:1px solid transparent;}
.msg-classmate-item:hover{background:var(--bg3);border-color:var(--border-hover);}
.msg-classmate-av{width:30px;height:30px;border-radius:8px;background:rgba(90,173,160,.2);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;overflow:hidden;}
.msg-classmate-av img{width:100%;height:100%;object-fit:cover;}
.msg-classmate-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.msg-classmate-matric{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.msg-classmate-btn{flex-shrink:0;padding:4px 8px;background:var(--accent);border:none;border-radius:6px;color:#fff;font-size:10px;font-weight:600;cursor:pointer;opacity:0;transition:opacity .15s;font-family:'DM Mono',monospace;}
.msg-classmate-item:hover .msg-classmate-btn{opacity:1;}
.msg-other-class-btn{width:100%;margin:8px 0 4px;padding:9px 12px;background:var(--bg3);border:1.5px dashed var(--border-hover);border-radius:9px;color:var(--text2);font-size:12px;font-family:'Instrument Sans',sans-serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .2s;}
.msg-other-class-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(62,142,149,.06);}
.msg-class-section-hd{font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);padding:8px 4px 4px;margin-top:4px;}
/* Hide classmates panel on smaller screens */
@media(max-width:1000px){.msg-classmates{display:none;}}
@media(max-width:640px){.msg-sidebar{width:100%;position:absolute;z-index:10;height:100%;}.msg-sidebar.mobile-hidden{display:none;}.msg-main{width:100%;}.msg-back-btn{display:flex!important;}}

.msg-back-btn{display:none;cursor:pointer;padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--text2);align-items:center;gap:5px;}
.msg-notification-dot{width:8px;height:8px;border-radius:50%;background:var(--accent4);display:inline-block;margin-left:6px;vertical-align:middle;animation:pulse 1.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.role-badge-lg{display:inline-flex;padding:4px 12px;border-radius:6px;font-size:11px;font-family:'DM Mono',monospace;font-weight:700;text-transform:uppercase;letter-spacing:.07em;}
.class-chip{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;transition:all .2s;margin:1px 8px;font-family:'DM Mono',monospace;}
.class-chip:hover{background:var(--bg3);color:var(--text);}
.class-chip.active{color:white;}
.class-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* TOPBAR */
.topbar{display:flex;align-items:center;gap:14px;padding:22px 28px 0;flex-wrap:wrap;}
.topbar-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;}
.search-box{position:relative;flex:1;min-width:200px;max-width:360px;}
.search-box .si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px;}
.search-inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:9px 14px 9px 36px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s;}
.search-inp:focus{border-color:var(--accent);}
.search-inp::placeholder{color:var(--text3);}
.btn-action{display:flex;align-items:center;gap:7px;padding:9px 16px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-action:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(62,142,149,.2);}
.btn-ghost{display:flex;align-items:center;gap:7px;padding:9px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;color:var(--text2);font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-ghost:hover{border-color:var(--border-hover);color:var(--text);}

/* CONTENT */
.content{padding:24px 28px 48px;}
.classes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;}
.class-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px;cursor:pointer;transition:all .25s;animation:fadeUp .4s ease forwards;opacity:0;position:relative;overflow:hidden;}
.class-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--class-color,var(--accent)),transparent);}
.class-card:hover{border-color:var(--border-hover);background:var(--card-hover);transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.3);}
.class-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.class-badge{padding:4px 10px;border-radius:6px;font-family:'DM Mono',monospace;font-size:11px;font-weight:500;}
.class-count{font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;}
.class-name{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:4px;}
.class-fullname{font-size:12px;color:var(--text2);margin-bottom:16px;}
.class-stats{display:flex;gap:16px;}
.class-stat{font-size:12px;color:var(--text2);}
.class-stat strong{color:var(--text);font-family:'Syne',sans-serif;}
.add-class-card{background:transparent;border:1px dashed var(--border);border-radius:16px;padding:22px;cursor:pointer;transition:all .25s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;min-height:140px;color:var(--text3);animation:fadeUp .4s ease forwards;opacity:0;}
.add-class-card:hover{border-color:var(--accent);color:var(--accent);background:rgba(62,142,149,.03);}
.add-class-card .plus{font-size:28px;}
.add-class-card span{font-size:13px;font-family:'DM Mono',monospace;}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);margin-bottom:20px;flex-wrap:wrap;}
.bc-item{cursor:pointer;transition:color .2s;}
.bc-item:hover{color:var(--accent);}
.bc-sep{color:var(--text3);}
.bc-current{color:var(--text2);}
.courses-list{display:flex;flex-direction:column;gap:10px;}
.course-row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .2s;animation:fadeUp .3s ease forwards;opacity:0;}
.course-row:hover{border-color:var(--border-hover);background:var(--card-hover);}
.course-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.course-info{flex:1;min-width:0;}
.course-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:600;margin-bottom:2px;}
.course-code{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.course-meta{font-size:12px;color:var(--text3);text-align:right;white-space:nowrap;}
.course-meta strong{display:block;color:var(--text2);font-family:'Syne',sans-serif;font-size:14px;}
.add-course-btn{background:transparent;border:1px dashed var(--border);border-radius:12px;padding:14px 20px;display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--text3);transition:all .2s;font-size:13px;font-family:'DM Mono',monospace;animation:fadeUp .3s ease forwards;opacity:0;animation-delay:.15s;}
.add-course-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(62,142,149,.03);}
.handouts-list{display:flex;flex-direction:column;gap:10px;}
.handout-row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .2s;animation:fadeUp .3s ease forwards;opacity:0;}
.handout-row:hover{border-color:var(--border-hover);background:var(--card-hover);}
.file-badge{padding:4px 8px;border-radius:5px;font-size:10px;font-family:'DM Mono',monospace;font-weight:500;text-transform:uppercase;flex-shrink:0;}
.fb-pdf{background:rgba(224,123,123,.15);color:var(--accent4);}
.fb-doc{background:rgba(62,142,149,.15);color:var(--accent);}
.fb-ppt{background:rgba(251,191,36,.15);color:#fbbf24;}
.fb-img{background:rgba(90,173,160,.15);color:var(--accent3);}
.handout-info{flex:1;min-width:0;}
.handout-title{font-size:14px;font-weight:500;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.handout-teacher{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.handout-date{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;white-space:nowrap;}
.handout-actions{display:flex;gap:6px;}
.icon-btn{width:30px;height:30px;border-radius:7px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);font-size:13px;transition:all .2s;}
.icon-btn:hover{border-color:var(--accent);color:var(--accent);}
.add-handout-btn{background:transparent;border:1px dashed var(--border);border-radius:12px;padding:12px 20px;display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--text3);transition:all .2s;font-size:13px;font-family:'DM Mono',monospace;animation:fadeUp .3s ease forwards;opacity:0;animation-delay:.1s;}
.add-handout-btn:hover{border-color:var(--accent3);color:var(--accent3);background:rgba(90,173,160,.03);}
.sec-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px;flex-wrap:wrap;}
.sec-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;}
.sec-sub{font-size:12px;color:var(--text2);margin-top:2px;}

/* MODALS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;}
.overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:18px;width:100%;max-width:480px;animation:scaleIn .25s ease;max-height:90vh;overflow-y:auto;}
.modal-wide{max-width:580px;}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:22px 24px 18px;border-bottom:1px solid var(--border);}
.modal-ht{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;}
.modal-x{width:30px;height:30px;border-radius:7px;background:var(--bg3);border:none;color:var(--text2);cursor:pointer;font-size:17px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.modal-x:hover{background:var(--border);color:var(--text);}
.modal-bd{padding:22px 24px 24px;}
.form-g{margin-bottom:15px;}
.form-g .inp-label{margin-bottom:5px;}
.sel{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:11px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s;appearance:none;cursor:pointer;}
.sel:focus{border-color:var(--accent);}
.drop-area{border:2px dashed var(--border);border-radius:12px;padding:32px 20px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:16px;}
.drop-area:hover{border-color:var(--accent);background:rgba(62,142,149,.03);}
.drop-area.has-file{border-color:var(--accent3);background:rgba(90,173,160,.05);}
.drop-ico{font-size:32px;margin-bottom:8px;}
.drop-txt{font-size:13px;color:var(--text2);}
.drop-txt strong{color:var(--accent);}
.drop-fmts{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:4px;}
.btn-submit{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-submit:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(62,142,149,.25);}
.btn-submit-green{width:100%;padding:12px;background:linear-gradient(135deg,var(--accent3),#3E8E95);border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;}
.btn-submit-green:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(90,173,160,.25);}

/* ======= PAST QUESTIONS ======= */
.pq-topbar-sub{font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;margin-top:3px;}
.pq-controls{display:flex;align-items:center;gap:10px;padding:16px 28px 0;flex-wrap:wrap;}
.pq-filter-sel{background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:8px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s;appearance:none;cursor:pointer;}
.pq-filter-sel:focus{border-color:var(--accent2);}
.pq-bank-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;}
.pq-bank-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px;transition:all .25s;animation:fadeUp .4s ease forwards;opacity:0;position:relative;overflow:hidden;}
.pq-bank-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent2),var(--accent));}
.pq-bank-card:hover{border-color:var(--border-hover);background:var(--card-hover);transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,.3);}
.pq-bank-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:10px;}
.pq-bank-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;flex:1;line-height:1.4;}
.pq-bank-badge{padding:3px 9px;border-radius:5px;font-family:'DM Mono',monospace;font-size:10px;font-weight:600;flex-shrink:0;}
.pq-bank-meta{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;margin-bottom:14px;}
.pq-bank-stats{display:flex;gap:14px;margin-bottom:16px;}
.pq-bank-stat{font-size:12px;color:var(--text2);}
.pq-bank-stat strong{color:var(--text);font-family:'Syne',sans-serif;}
.pq-bank-footer{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.pq-best-score{font-size:11px;font-family:'DM Mono',monospace;flex:1;}
.pq-mode-btns{display:flex;gap:6px;}
.pq-mode-btn{display:flex;align-items:center;gap:5px;padding:7px 13px;border:none;border-radius:8px;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;}
.pq-mode-btn.exam{background:linear-gradient(135deg,#e07b7b,#c0392b);color:white;}
.pq-mode-btn.study{background:linear-gradient(135deg,#5aada0,#3E8E95);color:white;}
.pq-mode-btn:hover{transform:translateY(-1px);filter:brightness(1.1);}
.pq-del-btn{width:30px;height:30px;border-radius:7px;background:transparent;border:1px solid var(--border);color:var(--text3);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.pq-del-btn:hover{border-color:var(--accent4);color:var(--accent4);background:rgba(224,123,123,.1);}
.pq-empty{text-align:center;padding:60px 20px;}
.pq-empty-ico{font-size:48px;margin-bottom:12px;}
.pq-empty-t{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:6px;}
.pq-empty-s{font-size:13px;color:var(--text2);}

/* Mode Picker Modal */
.mode-picker-overlay{position:fixed;inset:0;z-index:3500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);}
.mode-picker-overlay.open{display:flex;animation:fadeUp .3s ease;}
.mode-picker-card{background:var(--bg2);border:1px solid var(--border);border-radius:22px;padding:36px 32px;max-width:500px;width:90%;animation:scaleIn .25s ease;}
.mode-picker-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:6px;text-align:center;}
.mode-picker-sub{font-size:13px;color:var(--text2);text-align:center;margin-bottom:28px;font-family:'DM Mono',monospace;}
.mode-cards{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.mode-card{border-radius:14px;padding:22px 18px;cursor:pointer;transition:all .25s;border:2px solid transparent;text-align:center;}
.mode-card.exam-mode{background:rgba(224,123,123,.08);border-color:rgba(224,123,123,.2);}
.mode-card.study-mode{background:rgba(90,173,160,.08);border-color:rgba(90,173,160,.2);}
.mode-card:hover.exam-mode{border-color:#e07b7b;transform:translateY(-3px);box-shadow:0 10px 28px rgba(224,123,123,.2);}
.mode-card:hover.study-mode{border-color:#5aada0;transform:translateY(-3px);box-shadow:0 10px 28px rgba(90,173,160,.2);}
.mode-card-ico{font-size:36px;margin-bottom:10px;}
.mode-card-name{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:6px;}
.mode-card.exam-mode .mode-card-name{color:#e07b7b;}
.mode-card.study-mode .mode-card-name{color:#5aada0;}
.mode-card-desc{font-size:12px;color:var(--text2);line-height:1.6;}
.mode-card-tags{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-top:10px;}
.mode-tag{padding:2px 8px;border-radius:4px;font-family:'DM Mono',monospace;font-size:10px;}
.mode-card.exam-mode .mode-tag{background:rgba(224,123,123,.15);color:#e07b7b;}
.mode-card.study-mode .mode-tag{background:rgba(90,173,160,.15);color:#5aada0;}
.mode-picker-cancel{display:block;width:100%;margin-top:14px;padding:10px;background:transparent;border:1px solid var(--border);border-radius:9px;color:var(--text2);font-family:'DM Mono',monospace;font-size:12px;cursor:pointer;transition:all .2s;}
.mode-picker-cancel:hover{border-color:var(--border-hover);color:var(--text);}

/* Import Modal */
.pq-import-wrap{display:flex;flex-direction:column;gap:0;}
.pq-import-tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:18px;}
.pq-import-tab{padding:9px 6px;text-align:center;border-radius:8px;cursor:pointer;font-size:12px;color:var(--text2);background:var(--bg3);border:1px solid var(--border);font-family:'DM Mono',monospace;transition:all .2s;}
.pq-import-tab.active{background:rgba(90,173,160,.12);border-color:var(--accent2);color:var(--accent2);}
.pq-import-tab:hover{border-color:var(--border-hover);color:var(--text);}
.pq-import-info{background:rgba(90,173,160,.07);border:1px solid rgba(90,173,160,.2);border-radius:10px;padding:11px 14px;font-size:11px;color:var(--accent2);font-family:'DM Mono',monospace;margin-bottom:16px;line-height:1.8;}
.pq-import-info code{background:rgba(90,173,160,.15);padding:1px 5px;border-radius:3px;}
.pq-paste-area{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:9px;padding:12px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;transition:border-color .2s;resize:vertical;min-height:200px;line-height:1.7;}
.pq-paste-area:focus{border-color:var(--accent2);}
.pq-paste-area::placeholder{color:var(--text3);}
.pq-parse-preview{background:var(--bg3);border:1px solid var(--border);border-radius:10px;margin:14px 0;overflow:hidden;max-height:260px;overflow-y:auto;}
.pq-preview-hd{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);position:sticky;top:0;background:var(--bg3);}
.pq-preview-q{padding:10px 14px;border-bottom:1px solid var(--border);font-size:12px;}
.pq-preview-q:last-child{border-bottom:none;}
.pq-preview-qn{font-weight:600;margin-bottom:4px;color:var(--text);font-size:12px;}
.pq-preview-opts{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.pq-preview-opt{padding:2px 8px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;background:var(--bg4);color:var(--text2);}
.pq-preview-opt.correct{background:rgba(90,173,160,.15);color:var(--accent3);}
.pq-ai-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:11px;background:linear-gradient(135deg,rgba(90,173,160,.15),rgba(62,142,149,.1));border:1px solid rgba(90,173,160,.3);border-radius:9px;color:var(--accent2);font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;margin-bottom:10px;}
.pq-ai-btn:hover{background:linear-gradient(135deg,rgba(90,173,160,.25),rgba(62,142,149,.2));transform:translateY(-1px);}
.pq-ai-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.pq-ai-status{font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);padding:8px 12px;background:var(--bg3);border-radius:8px;border:1px solid var(--border);margin-bottom:10px;display:none;line-height:1.6;}
.pq-ai-status.show{display:block;}
.pq-ai-spin{display:inline-block;width:10px;height:10px;border:2px solid var(--border);border-top-color:var(--accent2);border-radius:50%;animation:spin .7s linear infinite;margin-right:6px;vertical-align:middle;}

/* Quiz Overlay */
.quiz-overlay{position:fixed;inset:0;z-index:3000;display:none;flex-direction:column;background:var(--bg);}
.quiz-overlay.open{display:flex;animation:fadeUp .3s ease;}
.quiz-topbar{display:flex;align-items:center;gap:12px;padding:12px 20px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.quiz-mode-pill{padding:4px 12px;border-radius:20px;font-family:'DM Mono',monospace;font-size:10px;font-weight:700;letter-spacing:.04em;flex-shrink:0;}
.quiz-mode-pill.exam{background:rgba(224,123,123,.15);color:#e07b7b;border:1px solid rgba(224,123,123,.3);}
.quiz-mode-pill.study{background:rgba(90,173,160,.15);color:#5aada0;border:1px solid rgba(90,173,160,.3);}
.quiz-title-block{flex:1;min-width:0;}
.quiz-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.quiz-subtitle{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.quiz-progress-bar-wrap{width:160px;flex-shrink:0;}
.quiz-progress-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:4px;display:flex;justify-content:space-between;}
.quiz-progress-bar{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden;}
.quiz-progress-fill{height:100%;border-radius:3px;transition:width .4s ease;}
.quiz-progress-fill.exam{background:linear-gradient(90deg,#e07b7b,#c0392b);}
.quiz-progress-fill.study{background:linear-gradient(90deg,#5aada0,#3E8E95);}
.quiz-timer{display:flex;align-items:center;gap:6px;font-family:'DM Mono',monospace;font-size:13px;color:var(--text2);background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 11px;flex-shrink:0;}
.quiz-timer.warn{color:var(--accent4);border-color:var(--accent4);animation:pulse .8s ease infinite;}
.quiz-body{flex:1;overflow-y:auto;padding:28px 20px;display:flex;flex-direction:column;align-items:center;}
.quiz-card{width:100%;max-width:700px;}
.quiz-qnum{font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.quiz-qnum-badge{padding:2px 9px;border-radius:4px;font-size:10px;}
.quiz-qnum-badge.exam{background:rgba(224,123,123,.15);color:#e07b7b;}
.quiz-qnum-badge.study{background:rgba(90,173,160,.15);color:#5aada0;}
.quiz-question{font-family:'Syne',sans-serif;font-size:19px;font-weight:700;line-height:1.55;margin-bottom:24px;color:var(--text);}
.quiz-options{display:flex;flex-direction:column;gap:10px;}
.quiz-opt{display:flex;align-items:flex-start;gap:12px;padding:14px 18px;background:var(--card);border:2px solid var(--border);border-radius:12px;cursor:pointer;transition:all .22s;animation:fadeUp .3s ease forwards;opacity:0;}
.quiz-opt:hover:not(.disabled){transform:translateX(4px);}
.quiz-opt:hover:not(.disabled).exam-opt{border-color:#e07b7b;background:rgba(224,123,123,.06);}
.quiz-opt:hover:not(.disabled).study-opt{border-color:#5aada0;background:rgba(90,173,160,.06);}
.quiz-opt.selected.exam-opt{border-color:#e07b7b;background:rgba(224,123,123,.1);}
.quiz-opt.selected.study-opt{border-color:var(--accent2);background:rgba(90,173,160,.1);}
.quiz-opt.correct{border-color:var(--accent3)!important;background:rgba(90,173,160,.12)!important;}
.quiz-opt.wrong{border-color:var(--accent4)!important;background:rgba(224,123,123,.1)!important;}
.quiz-opt.disabled{cursor:default;}
.quiz-opt-key{width:28px;height:28px;border-radius:7px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:12px;font-weight:600;flex-shrink:0;transition:all .2s;color:var(--text2);}
.quiz-opt.selected.exam-opt .quiz-opt-key{background:#e07b7b;border-color:#e07b7b;color:white;}
.quiz-opt.selected.study-opt .quiz-opt-key{background:var(--accent2);border-color:var(--accent2);color:white;}
.quiz-opt.correct .quiz-opt-key{background:var(--accent3)!important;border-color:var(--accent3)!important;color:white!important;}
.quiz-opt.wrong .quiz-opt-key{background:var(--accent4)!important;border-color:var(--accent4)!important;color:white!important;}
.quiz-opt-text{font-size:14px;line-height:1.5;padding-top:4px;}
.quiz-feedback{border-radius:10px;padding:13px 16px;margin-top:16px;font-size:13px;line-height:1.6;animation:fadeUp .3s ease;}
.quiz-feedback.correct-fb{background:rgba(90,173,160,.08);border:1px solid rgba(90,173,160,.25);color:var(--accent3);}
.quiz-feedback.wrong-fb{background:rgba(224,123,123,.07);border:1px solid rgba(224,123,123,.2);color:var(--accent4);}
.quiz-feedback.reveal-fb{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.2);color:#fbbf24;}
.quiz-feedback strong{font-family:'Syne',sans-serif;}
/* exam mode â€” no feedback until submit */
.quiz-exam-hint{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;padding:10px 14px;background:rgba(224,123,123,.05);border:1px solid rgba(224,123,123,.12);border-radius:8px;margin-top:12px;}
.quiz-footer{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:var(--bg2);border-top:1px solid var(--border);flex-shrink:0;gap:12px;flex-wrap:wrap;}
.quiz-nav-btn{display:flex;align-items:center;gap:7px;padding:9px 18px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;color:var(--text2);font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.quiz-nav-btn:hover:not(:disabled){border-color:var(--border-hover);color:var(--text);}
.quiz-nav-btn:disabled{opacity:.3;cursor:not-allowed;}
.quiz-submit-btn{display:flex;align-items:center;gap:7px;padding:9px 20px;border:none;border-radius:9px;color:white;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}
.quiz-submit-btn.exam-sub{background:linear-gradient(135deg,#e07b7b,#c0392b);}
.quiz-submit-btn.study-sub{background:linear-gradient(135deg,#5aada0,#3E8E95);}
.quiz-submit-btn:hover{transform:translateY(-1px);}
.quiz-end-exam-btn{display:flex;align-items:center;gap:6px;padding:9px 18px;background:transparent;border:1px solid rgba(224,123,123,.3);border-radius:9px;color:#e07b7b;font-family:'Syne',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;}
.quiz-end-exam-btn:hover{background:rgba(224,123,123,.1);border-color:#e07b7b;}
.quiz-dot-nav{display:flex;gap:5px;flex-wrap:wrap;max-width:300px;}
.quiz-dot{width:10px;height:10px;border-radius:50%;background:var(--bg4);cursor:pointer;transition:all .2s;border:1px solid var(--border);}
.quiz-dot.answered.exam{background:rgba(224,123,123,.6);}
.quiz-dot.answered.study{background:var(--accent2);}
.quiz-dot.current{transform:scale(1.4);}
.quiz-dot.current.exam{background:#e07b7b;}
.quiz-dot.current.study{background:var(--accent);}
.quiz-dot.correct{background:var(--accent3)!important;}
.quiz-dot.wrong{background:var(--accent4)!important;}

/* Results screen */
.quiz-result-overlay{position:fixed;inset:0;z-index:3100;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);backdrop-filter:blur(10px);}
.quiz-result-overlay.open{display:flex;animation:fadeUp .4s ease;}
.quiz-result-card{background:var(--bg2);border:1px solid var(--border);border-radius:22px;padding:36px 30px;max-width:500px;width:92%;text-align:center;animation:scaleIn .3s ease;max-height:90vh;overflow-y:auto;}
.quiz-result-icon{font-size:52px;margin-bottom:10px;}
.quiz-result-mode-badge{display:inline-block;padding:3px 12px;border-radius:20px;font-family:'DM Mono',monospace;font-size:10px;font-weight:700;margin-bottom:12px;}
.quiz-result-mode-badge.exam{background:rgba(224,123,123,.15);color:#e07b7b;}
.quiz-result-mode-badge.study{background:rgba(90,173,160,.15);color:#5aada0;}
.quiz-result-title{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;margin-bottom:6px;}
.quiz-result-sub{font-size:12px;color:var(--text2);margin-bottom:20px;font-family:'DM Mono',monospace;}
.quiz-result-score-ring{width:110px;height:110px;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;flex-direction:column;}
.quiz-result-score-pct{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;}
.quiz-result-score-lbl{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.quiz-result-breakdown{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;}
.quiz-result-stat{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 8px;}
.quiz-result-stat-val{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:2px;}
.quiz-result-stat-lbl{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;}
.quiz-result-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
.quiz-result-btn{padding:9px 18px;border-radius:9px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;border:none;}
.quiz-result-btn.primary-exam{background:linear-gradient(135deg,#e07b7b,#c0392b);color:white;}
.quiz-result-btn.primary-study{background:linear-gradient(135deg,#5aada0,#3E8E95);color:white;}
.quiz-result-btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text2);}
.quiz-result-btn:hover{transform:translateY(-1px);}
.review-banner{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:8px 14px;font-size:11px;color:#fbbf24;font-family:'DM Mono',monospace;margin-bottom:16px;display:flex;align-items:center;gap:8px;}

@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}

/* STATS */
.stats-strip{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;}
.stat-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;}
.stat-lbl{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:6px;}
.stat-val{font-family:'Syne',sans-serif;font-size:24px;font-weight:700;}
.stat-s{font-size:11px;color:var(--text2);margin-top:2px;}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-size:13px;z-index:9999;display:flex;align-items:center;gap:8px;box-shadow:0 8px 32px rgba(0,0,0,.3);animation:slideUp .3s ease;max-width:300px;}
.toast-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--accent3);}

/* PREVIEW â€” FULL SCREEN VIEWER */
.pv-overlay{position:fixed;inset:0;z-index:2000;display:none;flex-direction:column;background:var(--bg);}
.pv-overlay.open{display:flex;animation:fadeUp .25s ease;}

/* Top bar */
.pv-topbar{display:flex;align-items:center;gap:12px;padding:12px 18px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.pv-back{display:flex;align-items:center;gap:7px;padding:7px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;font-family:'DM Mono',monospace;transition:all .2s;white-space:nowrap;}
.pv-back:hover{border-color:var(--border-hover);color:var(--text);}
.pv-title-block{flex:1;min-width:0;}
.pv-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pv-subtitle{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pv-badge{padding:4px 10px;border-radius:6px;font-family:'DM Mono',monospace;font-size:11px;font-weight:600;text-transform:uppercase;flex-shrink:0;}
.pv-dl-btn{display:flex;align-items:center;gap:7px;padding:8px 18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:8px;color:white;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0;}
.pv-dl-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(62,142,149,.3);}
.pv-dl-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none;}

/* Toolbar (zoom, controls) */
.pv-toolbar{display:flex;align-items:center;gap:8px;padding:8px 18px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.pv-tool-btn{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:7px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:15px;transition:all .2s;flex-shrink:0;}
.pv-tool-btn:hover{border-color:var(--border-hover);color:var(--text);}
.pv-tool-btn:disabled{opacity:.3;cursor:not-allowed;}
.pv-zoom-val{font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);min-width:42px;text-align:center;}
.pv-sep{width:1px;height:20px;background:var(--border);margin:0 4px;flex-shrink:0;}
.pv-pg-info{font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);white-space:nowrap;}
.pv-toolbar-label{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;}
.pv-fullscreen-btn{margin-left:auto;display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:7px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:12px;font-family:'DM Mono',monospace;transition:all .2s;white-space:nowrap;}
.pv-fullscreen-btn:hover{border-color:var(--border-hover);color:var(--text);}

/* Viewer body */
.pv-body{flex:1;overflow:auto;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:24px;background:var(--bg);position:relative;}

/* PDF canvas */
.pv-pdf-wrap{display:flex;flex-direction:column;align-items:center;gap:16px;width:100%;}
.pv-canvas-page{background:white;border-radius:4px;box-shadow:0 4px 24px rgba(0,0,0,.4);display:block;max-width:100%;}

/* Image viewer */
.pv-img-wrap{display:flex;align-items:center;justify-content:center;width:100%;min-height:100%;}
.pv-img-display{border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5);transition:transform .2s;cursor:zoom-in;display:block;}
.pv-img-display.zoomed{cursor:zoom-out;}

/* Placeholder for unsupported types */
.pv-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:60px 20px;text-align:center;width:100%;}
.pv-ph-ico{font-size:80px;line-height:1;margin-bottom:4px;}
.pv-ph-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;}
.pv-ph-sub{font-size:14px;color:var(--text2);max-width:400px;line-height:1.6;}
.pv-ph-fname{font-family:'DM Mono',monospace;font-size:12px;color:var(--text3);background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 14px;margin-top:4px;}
.pv-meta-strip{display:flex;gap:24px;flex-wrap:wrap;padding:14px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-top:20px;}
.pv-meta-item{display:flex;flex-direction:column;gap:3px;}
.pv-meta-lbl{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;}
.pv-meta-val{font-size:13px;color:var(--text);}

/* Spinner */
.pv-spinner{display:flex;flex-direction:column;align-items:center;gap:16px;padding:60px;}
.pv-spin-ring{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.pv-spin-txt{font-size:13px;color:var(--text2);font-family:'DM Mono',monospace;}

/* Info panel (right side on desktop) */
.pv-info-panel{position:fixed;right:0;top:0;bottom:0;width:280px;background:var(--bg2);border-left:1px solid var(--border);z-index:2001;transform:translateX(100%);transition:transform .3s;overflow-y:auto;display:flex;flex-direction:column;}
.pv-info-panel.open{transform:translateX(0);}
.pv-info-hd{padding:16px;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-size:14px;font-weight:700;display:flex;align-items:center;justify-content:space-between;}
.pv-info-close{background:none;border:none;color:var(--text2);cursor:pointer;font-size:18px;}
.pv-info-body{padding:16px;display:flex;flex-direction:column;gap:14px;}
.pv-info-field{display:flex;flex-direction:column;gap:4px;}
.pv-info-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;}
.pv-info-value{font-size:13px;color:var(--text);line-height:1.5;}

@media(max-width:600px){
  .pv-topbar{padding:10px 12px;gap:8px;}
  .pv-toolbar{padding:6px 12px;}
  .pv-body{padding:12px;}
  .pv-title{font-size:14px;}
}

/* legacy (keep for modals) */
.btn-row{display:flex;gap:10px;}
.btn-row .btn-ghost,.btn-row .btn-action{flex:1;justify-content:center;}
.preview-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:var(--bg3);border-radius:10px;padding:14px 16px;margin-bottom:16px;}
.pmeta-label{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;}
.pmeta-val{font-size:13px;color:var(--text2);}

/* RESULTS */
.results-table-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:16px;}
.results-table{width:100%;border-collapse:collapse;font-size:13px;}
.results-table th{text-align:left;padding:11px 14px;font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text3);border-bottom:1px solid var(--border);background:var(--bg3);white-space:nowrap;}
.results-table td{padding:11px 14px;border-bottom:1px solid var(--border);vertical-align:middle;}
.results-table tr:last-child td{border-bottom:none;}
.results-table tr:hover td{background:var(--card-hover);}
.score-pill{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-family:'DM Mono',monospace;font-size:12px;font-weight:600;}
.score-a{background:rgba(90,173,160,.15);color:var(--accent3);}
.score-b{background:rgba(62,142,149,.15);color:var(--accent);}
.score-c{background:rgba(251,191,36,.15);color:#fbbf24;}
.score-f{background:rgba(224,123,123,.15);color:var(--accent4);}
.result-type-badge{display:inline-flex;padding:2px 8px;border-radius:5px;font-size:10px;font-family:'DM Mono',monospace;font-weight:600;text-transform:uppercase;}
.rt-test{background:rgba(90,173,160,.15);color:var(--accent2);}
.rt-exam{background:rgba(224,123,123,.15);color:var(--accent4);}
.results-empty{padding:48px 20px;text-align:center;color:var(--text3);}
/* BULK PASTE IMPORT */
.paste-area{width:100%;min-height:130px;background:var(--bg3);border:2px dashed var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;resize:vertical;transition:border-color .2s;line-height:1.7;}
.paste-area:focus{border-color:var(--accent);}
.paste-area::placeholder{color:var(--text3);}
.parse-preview{margin-top:14px;border-radius:10px;overflow:hidden;border:1px solid var(--border);}
.parse-preview-hd{padding:9px 14px;background:var(--bg3);font-size:11px;font-family:'DM Mono',monospace;color:var(--text2);display:flex;justify-content:space-between;align-items:center;}
.parse-row{display:grid;grid-template-columns:22px 100px 1fr 70px 60px 60px 24px;gap:8px;align-items:center;padding:8px 14px;border-bottom:1px solid var(--border);font-size:12px;}
.parse-row:last-child{border-bottom:none;}
.parse-row.parse-err{background:rgba(224,123,123,.06);}
.parse-row.parse-ok{background:rgba(90,173,160,.04);}
.parse-status{font-size:14px;flex-shrink:0;}
.parse-matric{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.parse-name{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.parse-score{font-family:'Syne',sans-serif;font-weight:700;text-align:center;}
.parse-grade{text-align:center;font-weight:700;font-family:'Syne',sans-serif;}
.parse-warn{font-size:10px;color:var(--accent4);font-family:'DM Mono',monospace;}
.parse-del{background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:2px;line-height:1;}
.parse-del:hover{color:var(--accent4);}
.modal-tabs{display:flex;border-bottom:1px solid var(--border);margin:-22px -24px 20px;padding:0 24px;}
.modal-tab{padding:12px 18px;font-size:13px;font-family:'DM Mono',monospace;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;}
.modal-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.modal-tab:hover:not(.active){color:var(--text);}
.results-empty-ico{font-size:40px;margin-bottom:10px;}
.results-empty-t{font-family:'Syne',sans-serif;font-size:15px;color:var(--text2);margin-bottom:4px;}
.results-empty-s{font-size:12px;font-family:'DM Mono',monospace;}
.results-filter-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;align-items:center;}
.results-filter-bar .sel{max-width:180px;}
.my-result-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px 20px;display:flex;align-items:center;gap:16px;animation:fadeUp .3s ease forwards;opacity:0;}
.my-result-card:not(:last-child){margin-bottom:10px;}
.my-result-score{width:56px;height:56px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:16px;font-weight:800;flex-shrink:0;line-height:1.1;}
.my-result-info{flex:1;min-width:0;}
.my-result-title{font-size:14px;font-weight:600;margin-bottom:3px;}
.my-result-meta{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;}
.my-result-grade{font-size:11px;font-family:'DM Mono',monospace;font-weight:700;}

/* MOBILE */
.mob-menu{display:none;position:fixed;top:14px;left:14px;z-index:200;background:var(--bg2);border:1px solid var(--border);border-radius:9px;width:38px;height:38px;align-items:center;justify-content:center;cursor:pointer;font-size:16px;}
.sidebar-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

@media(max-width:860px){
  .main{margin-left:0;}.sidebar{transform:translateX(-100%);}.sidebar.open{transform:translateX(0);}
  .mob-menu{display:flex;}.sidebar-bg.open{display:block;}.topbar{padding-top:60px;}
  .stats-strip{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:520px){
  .classes-grid{grid-template-columns:1fr;}.content{padding:16px 16px 48px;}
  .topbar{padding:60px 16px 0;}.stats-strip{grid-template-columns:1fr 1fr;}
}

.empty{text-align:center;padding:60px 20px;color:var(--text2);}
.empty-ico{font-size:40px;margin-bottom:12px;opacity:.5;}
.empty-t{font-family:'Syne',sans-serif;font-size:16px;color:var(--text);margin-bottom:6px;}
.empty-s{font-size:13px;}
.divider{height:1px;background:var(--border);margin:20px 0;}
.admin-crown{color:#fbbf24;margin-left:4px;}

/* SAVED ACCOUNTS DROPDOWN */
.inp-wrap{position:relative;margin-bottom:14px;}
.inp-wrap .inp{margin-bottom:0;}
.saved-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg2);border:1px solid var(--border-hover);border-radius:10px;z-index:9000;overflow:hidden;box-shadow:0 12px 32px rgba(0,0,0,.4);display:none;}
.saved-dropdown.open{display:block;}
.saved-dropdown-hd{padding:8px 12px 6px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);}
.saved-account-item{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;transition:background .15s;}
.saved-account-item:hover{background:var(--bg3);}
.saved-account-item.active{background:var(--bg3);}
.saved-account-av{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;}
.saved-account-info{flex:1;min-width:0;}
.saved-account-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.saved-account-email{font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.saved-account-role{font-size:10px;font-family:'DM Mono',monospace;padding:2px 6px;border-radius:4px;flex-shrink:0;}
.saved-account-del{width:22px;height:22px;border-radius:5px;background:transparent;border:none;color:var(--text3);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
.saved-account-del:hover{background:rgba(224,123,123,.15);color:var(--accent4);}
.saved-dropdown-empty{padding:14px 12px;font-size:12px;color:var(--text3);text-align:center;font-family:'DM Mono',monospace;}

/* PASSWORD FIELD WRAPPER */
.pass-wrap{position:relative;margin-bottom:14px;}
.pass-wrap .inp{margin-bottom:0;padding-right:42px;}
.pass-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text3);font-size:16px;line-height:1;transition:color .2s;padding:4px;}
.pass-toggle:hover{color:var(--accent);}

/* SAVE PASSWORD MODAL */
/* save-modal removed */
/* ===== FOLDER UPLOAD OVERLAY ===== */
.fu-overlay{position:fixed;inset:0;z-index:3000;display:none;flex-direction:column;background:var(--bg);}
.fu-overlay.open{display:flex;animation:fadeUp .25s ease;}
.fu-topbar{display:flex;align-items:center;gap:14px;padding:14px 20px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.fu-back{display:flex;align-items:center;gap:7px;padding:7px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;color:var(--text2);font-size:13px;font-family:'DM Mono',monospace;transition:all .2s;}
.fu-back:hover{border-color:var(--border-hover);color:var(--text);}
.fu-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;flex:1;}
.fu-body{flex:1;display:flex;overflow:hidden;}
.fu-left{width:340px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg2);flex-shrink:0;}
.fu-right{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:20px;}

/* Drop zone */
.fu-dropzone{margin:20px;border:2px dashed var(--border);border-radius:16px;padding:36px 20px;text-align:center;cursor:pointer;transition:all .25s;flex-shrink:0;}
.fu-dropzone:hover,.fu-dropzone.drag-over{border-color:var(--accent);background:rgba(62,142,149,.04);}
.fu-dropzone.has-files{border-color:var(--accent3);background:rgba(90,173,160,.04);}
.fu-dz-ico{font-size:40px;margin-bottom:10px;}
.fu-dz-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:6px;}
.fu-dz-sub{font-size:12px;color:var(--text2);line-height:1.6;}
.fu-dz-sub strong{color:var(--accent);}
.fu-dz-hint{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:8px;}
.fu-dz-btns{display:flex;gap:8px;justify-content:center;margin-top:14px;flex-wrap:wrap;}
.fu-dz-btn{padding:8px 16px;border-radius:8px;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer;transition:all .2s;border:1px solid var(--border);background:var(--bg3);color:var(--text2);}
.fu-dz-btn:hover{border-color:var(--accent);color:var(--accent);}
.fu-dz-btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;border:none;}

/* File tree */
.fu-tree-hd{padding:12px 16px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.fu-tree-hd span{color:var(--accent);}
.fu-tree{flex:1;overflow-y:auto;padding:0 8px 12px;}
.fu-folder-group{margin-bottom:4px;}
.fu-folder-label{display:flex;align-items:center;gap:7px;padding:6px 8px;border-radius:6px;font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;cursor:pointer;transition:background .15s;user-select:none;}
.fu-folder-label:hover{background:var(--bg3);}
.fu-folder-label .fu-fold-ico{font-size:13px;}
.fu-folder-label .fu-fold-name{flex:1;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fu-folder-label .fu-fold-count{font-size:10px;color:var(--text3);}
.fu-file-item{display:flex;align-items:center;gap:8px;padding:5px 8px 5px 26px;border-radius:6px;font-size:12px;color:var(--text2);cursor:pointer;transition:background .15s;}
.fu-file-item:hover{background:var(--bg3);}
.fu-file-item.selected{background:rgba(62,142,149,.1);color:var(--accent);}
.fu-file-item.excluded{opacity:.35;text-decoration:line-through;}
.fu-file-ico{font-size:13px;flex-shrink:0;}
.fu-file-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fu-file-size{font-size:10px;color:var(--text3);white-space:nowrap;}
.fu-file-cb{width:14px;height:14px;accent-color:var(--accent);cursor:pointer;flex-shrink:0;}

/* Right panel â€” settings & progress */
.fu-section-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);}
.fu-assignment-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.fu-field{display:flex;flex-direction:column;gap:5px;}
.fu-field label{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;}
.fu-sel{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s;appearance:none;cursor:pointer;}
.fu-sel:focus{border-color:var(--accent);}

/* File preview table */
.fu-files-table{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
.fu-files-thead{display:grid;grid-template-columns:auto 1fr 120px 100px 80px;gap:0;padding:10px 14px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;border-bottom:1px solid var(--border);}
.fu-files-row{display:grid;grid-template-columns:auto 1fr 120px 100px 80px;gap:0;padding:10px 14px;border-bottom:1px solid var(--border);align-items:center;transition:background .15s;}
.fu-files-row:last-child{border-bottom:none;}
.fu-files-row:hover{background:var(--card-hover);}
.fu-files-row.excluded-row{opacity:.4;}
.fu-file-cell{font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 6px;}
.fu-file-cell:first-child{padding-left:0;}
.fu-type-tag{padding:3px 7px;border-radius:4px;font-size:10px;font-family:'DM Mono',monospace;font-weight:600;text-transform:uppercase;}
.fu-row-sel{font-size:13px;width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text2);appearance:none;cursor:pointer;outline:none;font-family:'DM Mono',monospace;}
.fu-row-sel:focus{border-color:var(--accent);}

/* Progress */
.fu-progress-wrap{display:flex;flex-direction:column;gap:10px;}
.fu-prog-item{display:flex;flex-direction:column;gap:5px;}
.fu-prog-row{display:flex;align-items:center;justify-content:space-between;font-size:12px;}
.fu-prog-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text2);}
.fu-prog-stat{font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);white-space:nowrap;margin-left:8px;}
.fu-prog-bar{height:4px;border-radius:2px;background:var(--bg3);overflow:hidden;}
.fu-prog-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s;}
.fu-prog-fill.done{background:var(--accent3);}
.fu-prog-fill.error{background:var(--accent4);}

/* Summary bar */
.fu-summary{display:flex;align-items:center;gap:16px;padding:14px 20px;background:var(--bg2);border-top:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.fu-sum-stat{display:flex;flex-direction:column;gap:2px;min-width:60px;}
.fu-sum-val{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;}
.fu-sum-lbl{font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;}
.fu-sum-sep{width:1px;height:28px;background:var(--border);flex-shrink:0;}
.fu-action-btns{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap;}
.fu-btn-cancel{padding:9px 18px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text2);font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
.fu-btn-cancel:hover{border-color:var(--accent4);color:var(--accent4);}
.fu-btn-upload{padding:9px 24px;background:linear-gradient(135deg,var(--accent3),#3E8E95);border:none;border-radius:8px;color:white;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;}
.fu-btn-upload:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(90,173,160,.3);}
.fu-btn-upload:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none;}
.fu-empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:60px 20px;text-align:center;color:var(--text2);}
.fu-empty-ico{font-size:48px;opacity:.4;}
.fu-empty-t{font-family:'Syne',sans-serif;font-size:16px;color:var(--text);}
.fu-empty-s{font-size:13px;color:var(--text2);}

@media(max-width:780px){
  .fu-body{flex-direction:column;}
  .fu-left{width:100%;height:280px;border-right:none;border-bottom:1px solid var(--border);}
  .fu-assignment-grid{grid-template-columns:1fr;}
  .fu-files-thead,.fu-files-row{grid-template-columns:auto 1fr 80px 80px;}
  .fu-files-row .fu-file-cell:nth-child(4){display:none;}
  .fu-files-thead .fu-file-cell:nth-child(4){display:none;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLINICAL TOOLS â€” V3 MODERN DESIGN SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --nv-bg-card:rgba(255,255,255,0.10);--nv-bg-card-2:rgba(255,255,255,0.06);
  --nv-accent:#3E8E95;--nv-accent-2:#BFD2C5;--nv-accent-3:#5aada0;--nv-accent-warm:#fb923c;
  --nv-red:#f87171;--nv-yellow:#fbbf24;
  --nv-text:#FFFFFF;--nv-text-dim:#A7B5B8;--nv-text-mid:#E6ECEE;
  --nv-border:rgba(255,255,255,0.12);--nv-border-accent:rgba(62,142,149,0.5);
  --nv-glow:rgba(62,142,149,0.15);--nv-radius:18px;--nv-radius-sm:12px;
}
body.light {
  --nv-bg-card:#ffffff;--nv-bg-card-2:#f0f5f6;
  --nv-text:#0f172a;--nv-text-dim:#5a787c;--nv-text-mid:#2c5158;
  --nv-border:rgba(30,70,80,0.10);--nv-border-accent:rgba(62,142,149,0.4);
  --nv-glow:rgba(62,142,149,0.08);
}
body.dark {
  --nv-bg-card:rgba(255,255,255,0.04);--nv-bg-card-2:rgba(255,255,255,0.02);
  --nv-accent:#4fb3bc;--nv-accent-2:#a8d5cb;--nv-accent-3:#5aada0;--nv-accent-warm:#fb923c;
  --nv-text:#eef2f6;--nv-text-dim:#6d8394;--nv-text-mid:#c0cdd8;
  --nv-border:rgba(255,255,255,0.06);--nv-border-accent:rgba(79,179,188,0.4);
  --nv-glow:rgba(79,179,188,0.08);
}
.nv-view { font-family: 'Instrument Sans', sans-serif; color:var(--nv-text);}
.nv-tabs{display:flex;gap:3px;background:rgba(0,0,0,.20);border-radius:12px;padding:3px;margin-bottom:16px;border:1px solid var(--nv-border);}
.nv-tab-btn{flex:1;padding:8px 6px;font-size:12px;font-weight:600;border:none;background:transparent;color:var(--nv-text-dim);border-radius:10px;cursor:pointer;font-family:'Instrument Sans',sans-serif;transition:.18s;}
.nv-tab-btn.active{background:var(--nv-bg-card);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.3);}
.nv-tab-panel{display:none;}
.nv-tab-panel.active{display:block;animation:fadeUp .22s ease;}
.nv-card{background:var(--nv-bg-card);border-radius:var(--nv-radius);padding:20px;margin-bottom:14px;border:1px solid var(--nv-border);box-shadow:0 2px 20px rgba(0,0,0,.25);position:relative;overflow:hidden;}
.nv-card-glow::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--nv-glow),transparent 60%);pointer-events:none;}
.nv-card-highlight{border-color:var(--nv-border-accent);}
.nv-btn{display:inline-flex;align-items:center;justify-content:center;padding:11px 20px;border-radius:var(--nv-radius-sm);font-weight:600;border:none;cursor:pointer;transition:.2s;font-family:'Instrument Sans',sans-serif;font-size:14px;gap:6px;}
.nv-btn-primary{background:linear-gradient(135deg,var(--nv-accent),var(--nv-accent-2));color:#ffffff;}
.nv-btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px);}
.nv-btn-secondary{background:rgba(255,255,255,.08);color:var(--nv-text-mid);border:1px solid var(--nv-border);}
.nv-btn-danger{background:rgba(239,68,68,.1);color:var(--nv-red);border:1px solid rgba(239,68,68,.18);}
.nv-btn-success{background:rgba(90,173,160,.1);color:var(--nv-accent-3);border:1px solid rgba(90,173,160,.18);}
.nv-btn-sm{padding:7px 13px;font-size:12px;border-radius:10px;}
.nv-btn-full{width:100%;}
.nv-btn:active{transform:scale(.97)!important;}
.nv-form-group{margin-bottom:12px;}
.nv-form-group label{display:block;font-size:11px;color:var(--nv-text-dim);margin-bottom:5px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;}
.nv-input{width:100%;padding:12px 15px;border-radius:var(--nv-radius-sm);border:1px solid var(--nv-border);background:rgba(0,0,0,.20);color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;transition:border .2s,box-shadow .2s;}
.nv-input:focus{border-color:rgba(62,142,149,.4);box-shadow:0 0 0 3px rgba(62,142,149,.07);}
select.nv-input option{background:var(--bg2);}
textarea.nv-input{resize:vertical;min-height:80px;}
.nv-tag{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600;letter-spacing:.2px;}
.nv-tag-blue{background:rgba(62,142,149,.12);color:var(--nv-accent);}
.nv-tag-purple{background:rgba(90,173,160,.12);color:var(--nv-accent-2);}
.nv-tag-green{background:rgba(90,173,160,.12);color:var(--nv-accent-3);}
.nv-tag-orange{background:rgba(251,146,60,.12);color:var(--nv-accent-warm);}
.nv-tag-red{background:rgba(248,113,113,.12);color:var(--nv-red);}
.nv-chip{padding:6px 13px;border-radius:20px;font-size:12px;font-weight:600;border:1px solid var(--nv-border);background:transparent;color:var(--nv-text-dim);cursor:pointer;transition:.18s;}
.nv-chip.active,.nv-chip:hover{background:rgba(62,142,149,.1);border-color:rgba(62,142,149,.3);color:var(--nv-accent);}
.nv-chips{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px;}
.nv-section-title{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--nv-accent);font-weight:600;margin:16px 0 8px;display:flex;align-items:center;gap:6px;}
.nv-list-item{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:rgba(255,255,255,.08);margin-bottom:9px;border-radius:13px;border:1px solid var(--nv-border);transition:border-color .2s,background .2s;}
.nv-list-item:hover{border-color:var(--nv-border-accent);background:rgba(56,189,248,.025);}
.nv-list-item .title{font-weight:600;font-size:14px;margin-bottom:3px;}
.nv-list-item .meta{font-size:11px;color:var(--nv-text-dim);display:flex;gap:7px;align-items:center;}
.nv-empty{text-align:center;padding:44px 20px;color:var(--nv-text-dim);}
.nv-empty-icon{font-size:38px;margin-bottom:10px;}
.nv-empty-text{font-size:14px;}
.nv-progress-bar{height:4px;background:var(--nv-border);border-radius:2px;overflow:hidden;margin-top:6px;}
.nv-progress-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--nv-accent),var(--nv-accent-2));transition:width .6s ease;}
.nv-divider{height:1px;background:var(--nv-border);margin:14px 0;}
.nv-input-row{display:flex;gap:10px;}
/* Reference Tables */
.ref-table{width:100%;border-collapse:collapse;font-size:13px;}
.ref-table th{text-align:left;padding:8px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--nv-text-dim);border-bottom:1px solid var(--nv-border);font-weight:600;}
.ref-table td{padding:10px;border-bottom:1px solid var(--nv-border);vertical-align:top;}
.ref-table tr:last-child td{border-bottom:none;}
.ref-table tr:hover td{background:rgba(0,0,0,.08);}
.normal-val{color:var(--nv-accent-3);font-weight:600;font-family:'DM Mono',monospace;font-size:12px;}
.critical-val{color:var(--nv-red);font-weight:600;font-family:'DM Mono',monospace;font-size:12px;}
/* Drug cards */
.drug-card{background:var(--nv-bg-card);border-radius:var(--nv-radius);border:1px solid var(--nv-border);margin-bottom:10px;overflow:hidden;cursor:pointer;transition:.2s;}
.drug-card:hover{border-color:var(--nv-border-accent);}
.drug-header{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;}
.drug-name{font-weight:700;font-size:14px;color:#ffffff;}
.drug-generic{font-size:11px;color:var(--nv-text-dim);margin-top:2px;font-style:italic;}
.drug-body{display:none;padding:0 16px 16px;border-top:1px solid var(--nv-border);padding-top:14px;}
.drug-body.open{display:block;animation:fadeUp .2s ease;}
.drug-section{margin-bottom:10px;}
.drug-section-title{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--nv-text-dim);font-weight:600;margin-bottom:4px;}
.drug-section-body{font-size:13px;line-height:1.6;color:var(--nv-text-mid);}
.drug-warning{background:rgba(251,146,60,.07);border:1px solid rgba(251,146,60,.18);border-radius:10px;padding:10px 12px;font-size:12px;color:var(--nv-accent-warm);margin-top:8px;}
/* Flashcards */
.fc-deck{perspective:1200px;margin:20px auto;max-width:480px;}
.fc-card-wrap{position:relative;height:260px;transform-style:preserve-3d;transition:transform .55s cubic-bezier(.22,.68,0,1.2);cursor:pointer;}
.fc-card-wrap.flipped{transform:rotateY(180deg);}
.fc-face{position:absolute;inset:0;backface-visibility:hidden;border-radius:var(--nv-radius);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center;border:1px solid var(--nv-border);}
.fc-front{background:linear-gradient(135deg,var(--nv-bg-card),var(--nv-bg-card-2));border-color:var(--nv-border-accent);}
.fc-back{background:linear-gradient(135deg,rgba(90,173,160,.08),rgba(62,142,149,.05));transform:rotateY(180deg);border-color:rgba(90,173,160,.2);}
.fc-hint{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--nv-text-dim);margin-bottom:12px;font-weight:600;}
.fc-question{font-family:'Syne',sans-serif;font-size:1.25rem;line-height:1.4;color:var(--text);}
.fc-answer{font-size:14px;line-height:1.7;color:var(--nv-text-mid);}
.fc-controls{display:flex;gap:10px;margin-top:16px;justify-content:center;}
.fc-meta{text-align:center;font-size:12px;color:var(--nv-text-dim);margin-top:10px;}
.fc-progress-dots{display:flex;gap:4px;flex-wrap:wrap;justify-content:center;margin:12px 0;}
.fc-dot{width:8px;height:8px;border-radius:50%;background:var(--nv-border);transition:.3s;}
.fc-dot.known{background:var(--nv-accent-3);}
.fc-dot.unknown{background:var(--nv-red);}
.fc-dot.current{background:var(--nv-accent);box-shadow:0 0 6px var(--nv-accent);}
.fc-stat-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;}
.fc-stat{background:var(--nv-bg-card);border-radius:12px;padding:12px;text-align:center;border:1px solid var(--nv-border);}
.fc-stat-val{font-family:'Syne',sans-serif;font-size:1.6rem;line-height:1;}
.fc-stat-label{font-size:10px;color:var(--nv-text-dim);text-transform:uppercase;letter-spacing:.5px;margin-top:3px;}
.fc-cat-btn{padding:14px;border-radius:13px;border:1px solid var(--nv-border);background:var(--nv-bg-card);cursor:pointer;text-align:left;transition:.2s;font-family:'Instrument Sans',sans-serif;width:100%;margin-bottom:8px;}
.fc-cat-btn:hover{border-color:var(--nv-border-accent);}
.fc-cat-btn.selected{border-color:var(--nv-accent);background:rgba(62,142,149,.07);}
.q-opt-nv{display:block;width:100%;text-align:left;padding:11px 15px;margin-bottom:7px;background:rgba(255,255,255,.06);border:1px solid var(--nv-border);border-radius:10px;color:var(--text);font-size:13px;cursor:pointer;font-family:'Instrument Sans',sans-serif;transition:.18s;}
.q-opt-nv:hover{border-color:rgba(62,142,149,.4);}
/* Subject accordion */
.subject-card{background:var(--nv-bg-card);border-radius:var(--nv-radius);border:1px solid var(--nv-border);margin-bottom:10px;overflow:hidden;cursor:pointer;}
.subject-header{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;}
.subject-body{display:none;padding:0 16px 16px;border-top:1px solid var(--nv-border);padding-top:14px;animation:fadeUp .2s ease;}
.subject-body.open{display:block;}
/* Planner */
.planner-day{background:var(--nv-bg-card);border-radius:var(--nv-radius);border:1px solid var(--nv-border);margin-bottom:10px;overflow:hidden;}
.planner-day-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;}
.planner-day-label{font-weight:700;font-size:14px;}
.planner-sessions{padding:0 16px 14px;}
.session-block{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;margin-bottom:6px;background:rgba(255,255,255,.06);border:1px solid var(--nv-border);}
.session-time{font-family:'DM Mono',monospace;font-size:11px;color:var(--nv-accent);min-width:60px;}
.session-subject{font-size:13px;font-weight:600;}
.session-duration{font-size:11px;color:var(--nv-text-dim);}
.session-done{opacity:.5;text-decoration:line-through;}
.session-check{width:18px;height:18px;border-radius:5px;border:1.5px solid var(--nv-border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:.2s;flex-shrink:0;}
.session-check.checked{background:var(--nv-accent-3);border-color:var(--nv-accent-3);}
.exam-countdown-card{background:linear-gradient(135deg,rgba(251,146,60,.1),rgba(248,113,113,.07));border-color:rgba(251,146,60,.2);text-align:center;padding:18px;border-radius:var(--nv-radius);border:1px solid rgba(251,146,60,.2);margin-bottom:12px;}
.exam-countdown-days{font-family:'Syne',sans-serif;font-size:3rem;color:var(--nv-accent-warm);line-height:1;}
/* Skills */
.skill-card{background:rgba(255,255,255,0.10);border-radius:var(--nv-radius);border:1px solid rgba(255,255,255,0.20);margin-bottom:10px;overflow:hidden;cursor:pointer;}
.skill-header{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;}
.skill-name{font-weight:600;font-size:14px;color:#ffffff;}
.skill-progress-label{font-size:12px;color:var(--nv-accent-2);font-weight:700;}
.skill-body{display:none;padding:0 16px 16px;border-top:1px solid rgba(255,255,255,0.15);padding-top:14px;}
.skill-body.open{display:block;animation:fadeUp .2s ease;}
.skill-step{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,0.08);}
.skill-step:last-child{border-bottom:none;}
.skill-checkbox{width:20px;height:20px;border-radius:6px;border:1.5px solid rgba(255,255,255,0.35);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;transition:.2s;flex-shrink:0;margin-top:1px;}
.skill-checkbox.checked{background:var(--nv-accent-3);border-color:var(--nv-accent-3);}
.skill-step-text{font-size:13px;line-height:1.5;color:rgba(255,255,255,0.85);}
.skill-step-text.done{text-decoration:line-through;opacity:.5;}
/* Dashboard */
.nv-dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.nv-dash-tile{background:var(--nv-bg-card);border-radius:var(--nv-radius);padding:16px;border:1px solid var(--nv-border);}
.nv-dash-tile-val{font-family:'Syne',sans-serif;font-size:2rem;line-height:1;margin-bottom:4px;}
.nv-dash-tile-label{font-size:11px;color:var(--nv-text-dim);text-transform:uppercase;letter-spacing:.5px;}
.nv-act-bar{flex:1;border-radius:4px 4px 0 0;background:rgba(62,142,149,.15);min-height:4px;transition:.4s;}
.nv-act-bar.today{background:var(--nv-accent);}
/* GPA */
.nv-gpa-display{background:linear-gradient(135deg,rgba(62,142,149,.12),rgba(90,173,160,.08));border-color:var(--nv-border-accent);text-align:center;padding:24px;}
.nv-gpa-value{font-family:'Syne',sans-serif;font-size:4rem;color:var(--nv-accent);line-height:1;}
.nv-gpa-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--nv-text-dim);margin-top:4px;}
.nv-gpa-class{font-size:15px;font-weight:700;margin-top:8px;}
.nv-course-row{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:rgba(255,255,255,.08);border-radius:12px;border:1px solid var(--nv-border);margin-bottom:7px;animation:fadeUp .25s ease;}
/* Med calc */
.nv-calc-result{background:linear-gradient(135deg,rgba(90,173,160,.08),rgba(62,142,149,.05));border-color:rgba(90,173,160,.18);text-align:center;padding:22px;border-radius:var(--nv-radius);border:1px solid rgba(90,173,160,.18);margin-top:12px;}
.nv-calc-number{font-size:2.8rem;font-family:'Syne',sans-serif;color:var(--nv-accent-3);line-height:1;}
.nv-calc-unit{font-size:13px;color:var(--nv-text-dim);margin-top:3px;}
/* Dictionary */
.nv-dict-result{padding:16px 0;border-bottom:1px solid var(--nv-border);animation:fadeUp .3s ease;}
.nv-dict-term{font-size:1.15rem;font-family:'Syne',sans-serif;color:var(--nv-accent);margin-bottom:7px;}
.nv-dict-body{font-size:14px;line-height:1.75;color:var(--nv-text-mid);white-space:pre-wrap;}
.flex-between{display:flex;justify-content:space-between;align-items:center;}
.nv-text-accent{color:var(--nv-accent);}
.nv-text-dim{color:var(--nv-text-dim);}
.nv-text-mid{color:var(--nv-text-mid);}
.nv-text-xs{font-size:11px;}
.nv-text-sm{font-size:13px;}
.nv-fw-700{font-weight:700;}
.nv-mt-8{margin-top:8px;}
.nv-mt-12{margin-top:12px;}
.nv-mt-16{margin-top:16px;}
.nv-mb-0{margin-bottom:0;}
</style>
</head>
<body>

<!-- ===== AUTH PAGE ===== -->
<div id="authPage">
  <div class="auth-wrap">
    <div class="auth-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0;">
        <div class="auth-brand">
          <div class="auth-brand-icon">ðŸ¥</div>
          <div class="auth-brand-name">NurseVault</div>
        </div>
        <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme"><span style="font-size:15px;">ðŸŒ™</span><span class="theme-btn-label">Dark mode</span></button>
      </div>
      <div class="auth-sub">// nursing school handouts &amp; resources</div>

      <!-- LOGIN -->
      <div id="loginForm">
        <div class="auth-tabs">
          <div class="auth-tab active" onclick="switchAuth('login')">Sign In</div>
          <div class="auth-tab" onclick="switchAuth('signup')">Create Account</div>
        </div>

        <label class="inp-label">Username</label>
        <div class="inp-wrap">
          <input class="inp" id="loginUsername" type="text" placeholder="Enter your username"
            autocomplete="off"
            onfocus="openSavedDropdown()"
            oninput="filterSavedDropdown(this.value)"
            onkeydown="handleUsernameKey(event)">
          <div class="saved-dropdown" id="savedDropdown">
            <div class="saved-dropdown-hd">Saved Accounts</div>
            <div id="savedList"></div>
          </div>
        </div>

        <label class="inp-label">Password</label>
        <div class="pass-wrap">
          <input class="inp" id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            autocomplete="current-password"
            onkeydown="if(event.key==='Enter')doLogin()">
          <button class="pass-toggle" type="button" onclick="togglePassVis('loginPassword',this)" title="Show/hide password">ðŸ‘</button>
        </div>

        <div class="inp-err" id="loginErr">Invalid username or password.</div>
        <button class="btn-primary" onclick="doLogin()">Sign In â†’</button>
        <div class="auth-switch" style="margin-top:10px;"><span onclick="switchAuth('forgot')" style="color:var(--text3);">Forgot password?</span></div>
        <div class="auth-switch">No account? <span onclick="switchAuth('signup')">Register here</span></div>
        <div class="auth-notice" style="margin-top:16px;">âš ï¸ Accounts are stored on this device only. Logging in from a different browser or device requires re-registering.</div>
      </div>


      <!-- FORGOT PASSWORD -->
      <div id="forgotForm" style="display:none">
        <div class="auth-tabs">
          <div class="auth-tab" onclick="switchAuth('login')">Sign In</div>
          <div class="auth-tab" onclick="switchAuth('signup')">Create Account</div>
        </div>
        <div style="text-align:center;margin-bottom:18px;">
          <div style="font-size:28px;margin-bottom:8px;">ðŸ”‘</div>
          <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--text);margin-bottom:4px;">Reset Password</div>
          <div style="font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;">Enter your username and new password</div>
        </div>
        <label class="inp-label">Username</label>
        <input class="inp" id="forgotUsername" type="text" placeholder="Enter your username">
        <label class="inp-label" style="margin-top:12px;">New Password</label>
        <div class="pass-wrap">
          <input class="inp" id="forgotNewPass" type="password" placeholder="Min. 6 characters">
          <button class="pass-toggle" type="button" onclick="togglePassVis('forgotNewPass',this)" title="Show/hide">ðŸ‘</button>
        </div>
        <label class="inp-label" style="margin-top:12px;">Confirm New Password</label>
        <div class="pass-wrap">
          <input class="inp" id="forgotConfPass" type="password" placeholder="Re-enter new password" onkeydown="if(event.key==='Enter')doForgotPassword()">
          <button class="pass-toggle" type="button" onclick="togglePassVis('forgotConfPass',this)" title="Show/hide">ðŸ‘</button>
        </div>
        <div class="inp-err" id="forgotErr" style="display:none;"></div>
        <div id="forgotSuccess" style="display:none;background:rgba(90,173,160,.1);border:1px solid rgba(90,173,160,.3);border-radius:9px;padding:10px 14px;font-size:12px;color:var(--accent3);font-family:'DM Mono',monospace;margin-top:8px;">âœ“ Password changed! You can now sign in.</div>
        <button class="btn-primary" onclick="doForgotPassword()" style="margin-top:14px;">Reset Password â†’</button>
        <div class="auth-switch" style="margin-top:12px;"><span onclick="switchAuth('login')">â† Back to Sign In</span></div>
      </div>
      <!-- SIGNUP -->
      <div id="signupForm" style="display:none">
        <div class="auth-tabs">
          <div class="auth-tab" onclick="switchAuth('login')">Sign In</div>
          <div class="auth-tab active" onclick="switchAuth('signup')">Create Account</div>
        </div>
        <div class="auth-notice">âš ï¸ Student accounts only. Lecturer accounts are created by the Admin â€” contact your administrator.</div>
        <label class="inp-label">Full Name</label>
        <input class="inp" id="signupName" type="text" placeholder="e.g. Amaka Eze">
        <label class="inp-label">Username</label>
        <input class="inp" id="signupUsername" type="text" placeholder="Choose a username (no spaces)" autocomplete="off">
        <label class="inp-label">Matric Number</label>
        <input class="inp" id="signupMatric" type="text" placeholder="e.g. NSG/2023/001" autocomplete="off">
        <label class="inp-label">Your Class</label>
        <select class="sel-inp" id="signupClass">
          <option value="nd1">ND ONE â€” National Diploma Year One</option>
          <option value="nd2">ND TWO â€” National Diploma Year Two</option>
          <option value="hnd1">HND ONE â€” Higher National Diploma Year One</option>
          <option value="hnd2">HND TWO â€” Higher National Diploma Year Two</option>
        </select>
        <label class="inp-label">Password</label>
        <input class="inp" id="signupPassword" type="password" placeholder="Min. 6 characters">
        <label class="inp-label">Confirm Password</label>
        <input class="inp" id="signupConfirm" type="password" placeholder="Re-enter password" onkeydown="if(event.key==='Enter')doSignup()">
        <div class="inp-err" id="signupErr">Please check your details.</div>
        <button class="btn-primary" onclick="doSignup()">Create Account â†’</button>
        <div class="auth-switch">Already registered? <span onclick="switchAuth('login')">Sign in</span></div>
      </div>
    </div>
  </div>
</div>

<!-- save-modal removed: auto-saves silently -->

<!-- ===== APP ===== -->
<div class="app" id="appWrap" style="display:none">
  <button class="mob-menu" onclick="toggleSidebar()">â˜°</button>

  <!-- GLOBAL BACK BUTTON -->
  <button id="globalBackBtn" onclick="nvGoBack()" style="display:none;position:fixed;top:10px;left:72px;z-index:8500;background:var(--bg2);border:2px solid var(--border);border-radius:10px;padding:7px 18px;font-family:'Syne',sans-serif;font-weight:900;font-size:13px;color:var(--text1);cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.18);transition:all .18s;display:flex;align-items:center;gap:7px;letter-spacing:.01em;">
    â† Back
  </button>
  <!-- NOTIFICATION BELL -->
  <button id="nvNotifBell" onclick="toggleNotifPanel()" title="Notifications" style="position:fixed;top:12px;right:16px;z-index:8000;background:var(--bg2);border:1px solid var(--border);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;box-shadow:0 2px 12px rgba(0,0,0,.15);transition:all .2s;display:none;">
    ðŸ””<span id="nvNotifCount" style="display:none;position:absolute;top:2px;right:2px;background:var(--accent4);color:white;border-radius:50%;width:16px;height:16px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;display:flex;align-items:center;justify-content:center;line-height:1;"></span>
  </button>
  <div class="sidebar-bg" id="sidebarBg" onclick="closeSidebar()"></div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ðŸ¥</div>
      <div class="logo-text">NurseVault</div>
    </div>
    <div class="sidebar-section-label">Navigation</div>
    <div class="nav-item active" onclick="navGo('dashboard')"><span class="ni">âŠž</span> Dashboard</div>
    <div class="nav-item" onclick="navGo('timetable')"><span class="ni">ðŸ“…</span> Timetable</div>
    <div class="nav-item" onclick="navGo('allhandouts')"><span class="ni">ðŸ“„</span> All Handouts</div>
    <div class="nav-item" onclick="navGo('results')"><span class="ni">ðŸ“Š</span> Results</div>
    <div class="nav-item" onclick="navGo('pastquestions')"><span class="ni">ðŸ§ </span> Past Questions</div>
    <div class="nav-item" onclick="navGo('messages')" id="navMessages"><span class="ni">ðŸ’¬</span> Messages <span id="msgNavBadge" style="display:none" class="msg-notification-dot"></span></div>
    <div class="nav-item teacher-el" onclick="openModal('uploadModal')"><span class="ni">â¬†</span> Upload Handout</div>
    <div class="nav-item teacher-el" onclick="openFolderUpload()"><span class="ni">ðŸ“‚</span> Upload Folder</div>
    <div class="sidebar-section-label" style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px;">Clinical Tools</div>
    <div class="nav-item" onclick="navGo('labref')"><span class="ni">ðŸ§ª</span> Lab Reference</div>
    <div class="nav-item" onclick="navGo('drugguide')"><span class="ni">ðŸ’Š</span> Drug Guide</div>
    <div class="nav-item" onclick="navGo('flashcards')"><span class="ni">ðŸƒ</span> Flashcards</div>
    <div class="nav-item" onclick="navGo('medcalc')"><span class="ni">ðŸ§®</span> Med Calculator</div>
    <div class="nav-item" onclick="navGo('studyplanner')"><span class="ni">ðŸ“…</span> Study Planner</div>
    <div class="nav-item" onclick="navGo('skillscheck')"><span class="ni">âœ…</span> Skills Checklist</div>
    <div class="nav-item" onclick="navGo('dictionary')"><span class="ni">ðŸ”</span> Dictionary</div>
    <div class="nav-item" onclick="navGo('gpacalc')"><span class="ni">âš–ï¸</span> GPA Calculator</div>
    <div class="nav-item" onclick="navGo('studyprog')"><span class="ni">ðŸ“ˆ</span> Study Progress</div>
    <div class="sidebar-section-label">Classes</div>
    <div id="sidebarClasses"></div>
    <div class="nav-item admin-el" onclick="navGo('users')"><span class="ni">ðŸ‘¥</span> User Management</div>
    <div class="nav-item admin-el" onclick="navGo('activitymonitor')"><span class="ni">ðŸ“¡</span> Activity Monitor</div>
    <div class="sidebar-user">
      <button class="profile-btn" onclick="openMyProfile()">
        <div class="user-av" id="sidebarAv">S</div>
        <div style="flex:1;min-width:0;">
          <div class="user-nm" id="sidebarNm" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Student</div>
          <div class="user-rl" id="sidebarRl">student</div>
        </div>
        <span style="font-size:12px;color:var(--text3);">âœŽ</span>
      </button>
      <button class="theme-btn" onclick="toggleTheme()" style="width:100%;justify-content:center;margin-bottom:6px;border-radius:10px;"><span style="font-size:15px;">ðŸŒ™</span><span class="theme-btn-label">Dark mode</span></button>
      <button class="logout-btn" onclick="doLogout()">â† Sign Out</button>
    </div>
  </div>

  <!-- MAIN VIEWS -->
  <div class="main">

    <!-- DASHBOARD -->
    <div id="viewDashboard" class="view">
      <div class="topbar">
        <div class="topbar-title" id="dashTitle">Dashboard</div>
        <button class="theme-btn" onclick="toggleTheme()" title="Toggle theme"><span style="font-size:15px;">ðŸŒ™</span><span class="theme-btn-label">Dark mode</span></button>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Search handoutsâ€¦" oninput="globalSearch(this.value)"></div>
        <button class="btn-action teacher-el" onclick="openModal('uploadModal')">â¬† Upload</button>
        <button class="btn-ghost teacher-el" onclick="openFolderUpload()" style="gap:7px;">ðŸ“‚ Upload Folder</button>
        <button class="btn-action admin-el" onclick="openModal('addClassModal')">ï¼‹ Add Class</button>
      </div>
      <div class="content">
        <div class="stats-strip" id="statsStrip"></div>
        <div class="sec-header">
          <div><div class="sec-title">Classes</div><div class="sec-sub">Select a class to browse courses and handouts</div></div>
          <button class="btn-ghost admin-el" onclick="openModal('addClassModal')">ï¼‹ Add Class</button>
        </div>
        <div class="classes-grid" id="classesGrid"></div>
      </div>
    </div>

    <!-- CLASS VIEW -->
    <div id="viewClass" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title" id="classViewTitle">Class</div>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Search coursesâ€¦" oninput="searchCourses(this.value)"></div>
        <button class="btn-action teacher-el" onclick="openAddCourseModal()">ï¼‹ Add Course</button>
      </div>
      <div class="content">
        <div class="breadcrumb" id="classBc"></div>
        <div class="sec-header">
          <div><div class="sec-title" id="classCoursesTitle">Courses</div><div class="sec-sub" id="classCourseSub"></div></div>
          <button class="btn-ghost teacher-el" onclick="openAddCourseModal()">ï¼‹ Add Course</button>
        </div>
        <div class="courses-list" id="coursesList"></div>
      </div>
    </div>

    <!-- COURSE VIEW -->
    <!-- COURSE VIEW â€” shows lecturer folders -->
    <div id="viewCourse" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title" id="courseViewTitle">Course</div>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Search foldersâ€¦" oninput="searchCourseFolders(this.value)"></div>
        <button class="btn-action admin-el" onclick="openAddLecturerFolderFromCourse()">ðŸ“ Add Folder</button>
      </div>
      <div class="content">
        <div class="breadcrumb" id="courseBc"></div>
        <div class="sec-header">
          <div>
            <div class="sec-title" id="courseHandoutsTitle">Lecturer Folders</div>
            <div class="sec-sub" id="courseHandoutSub"></div>
          </div>
          <button class="btn-ghost admin-el" onclick="openAddLecturerFolderFromCourse()">ðŸ“ Add Folder</button>
        </div>
        <div id="courseFoldersList"></div>
      </div>
    </div>

    <!-- LECTURER FOLDER VIEW â€” shows documents inside a folder -->
    <div id="viewLecturerFolder" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title" id="lfViewTitle">Folder</div>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Search notesâ€¦" oninput="searchFolderDocs(this.value)"></div>
        <button class="btn-action admin-el" onclick="openAddHandoutModal()">â¬† Upload Note</button>
      </div>
      <div class="content">
        <div class="breadcrumb" id="lfBc"></div>
        <div class="sec-header">
          <div>
            <div class="sec-title" id="lfDocTitle">Documents</div>
            <div class="sec-sub" id="lfDocSub"></div>
          </div>
          <button class="btn-ghost admin-el" onclick="openAddHandoutModal()">â¬† Upload Note</button>
        </div>
        <div class="handouts-list" id="handoutsList"></div>
      </div>
    </div>

    <!-- ALL HANDOUTS -->
    <div id="viewAllHandouts" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">All Handouts</div>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Searchâ€¦" oninput="searchAllHandouts(this.value)"></div>
      </div>
      <div class="content">
        <div class="handouts-list" id="allHandoutsList"></div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="viewResults" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">Results</div>
        <button class="btn-action admin-el" onclick="openSpreadsheetImport()" style="gap:7px;">ðŸ“Š Upload Spreadsheet</button>
        <button class="btn-ghost admin-el" onclick="openPasteImport()" style="gap:7px;">ðŸ“‹ Paste Import</button>
        <button class="btn-ghost admin-el" onclick="openModal_addResult()">ï¼‹ Add Result</button>
      </div>
      <div class="content">

        <!-- ADMIN VIEW â€” sees ALL results -->
        <div id="resultsTeacherPanel" style="display:none">
          <div class="results-filter-bar">
            <select class="sel" id="resultFilterClass" onchange="filterResultsByClass()" style="max-width:160px;">
              <option value="">All Classes</option>
            </select>
            <select class="sel" id="resultFilterType" onchange="renderResultsTable()" style="max-width:130px;">
              <option value="">All Types</option>
              <option value="test">Tests</option>
              <option value="exam">Exams</option>
            </select>
            <select class="sel" id="resultFilterCourse" onchange="renderResultsTable()" style="max-width:210px;">
              <option value="">All Courses</option>
            </select>
            <input class="search-inp" id="resultFilterSearch" placeholder="Search name / matricâ€¦" oninput="renderResultsTable()" style="max-width:190px;padding:8px 12px;">
            <div style="flex:1"></div>
            <button class="btn-ghost" onclick="exportResultsCSV()" style="font-size:12px;">â¬‡ Export CSV</button>
            <button class="btn-ghost" onclick="showCGPASummary()" style="font-size:12px;color:var(--accent2);border-color:var(--accent2);">ðŸ“ˆ CGPA Summary</button>
          </div>
          <div class="results-table-wrap">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Matric No.</th>
                  <th>Student</th>
                  <th>Type</th>
                  <th>Title</th>
                  <th>Course</th>
                  <th>Class</th>
                  <th>Score</th>
                  <th>Grade</th>
                  <th>GP</th>
                  <th>CGPA</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="resultsTableBody"></tbody>
            </table>
          </div>
          <div id="resultsTableEmpty" class="results-empty" style="display:none">
            <div class="results-empty-ico">ðŸ“Š</div>
            <div class="results-empty-t">No results uploaded yet</div>
            <div class="results-empty-s">Upload a spreadsheet or use Paste Import to add student results</div>
          </div>
        </div>

        <!-- STUDENT VIEW â€” own results only, matched by matric number -->
        <div id="resultsStudentPanel" style="display:none">
          <div style="margin-bottom:18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <select class="sel" id="studentResultFilterType" onchange="renderStudentResults()" style="max-width:160px;">
              <option value="">All Types</option>
              <option value="test">Tests</option>
              <option value="exam">Exams</option>
            </select>
            <select class="sel" id="studentResultFilterCourse" onchange="renderStudentResults()" style="max-width:220px;">
              <option value="">All Courses</option>
            </select>
          </div>
          <div id="studentResultsSummary" style="display:none;margin-bottom:20px;"></div>
          <div id="studentResultsList"></div>
        </div>

      </div>
    </div>

    <!-- PAST QUESTIONS -->
    <div id="viewPastQuestions" class="view" style="display:none">
      <div class="topbar">
        <div>
          <div class="topbar-title">Past Questions</div>
          <div class="pq-topbar-sub">// practice mode â€” multiple choice</div>
        </div>
        <button class="btn-action admin-el" onclick="openPQImport()" style="background:linear-gradient(135deg,var(--accent2),var(--accent));">â¬† Import Questions</button>
      </div>
      <div class="pq-controls">
        <select class="pq-filter-sel" id="pqFilterCourse" onchange="renderPQBanks()">
          <option value="">All Courses</option>
        </select>
        <select class="pq-filter-sel" id="pqFilterYear" onchange="renderPQBanks()">
          <option value="">All Years</option>
        </select>
        <div style="flex:1"></div>
        <span id="pqBankCount" style="font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;"></span>
      </div>
      <div class="content" style="padding-top:16px;">
        <div class="pq-bank-grid" id="pqBankGrid"></div>
        <div class="pq-empty" id="pqEmpty" style="display:none">
          <div class="pq-empty-ico">ðŸ§ </div>
          <div class="pq-empty-t">No Question Banks Yet</div>
          <div class="pq-empty-s admin-el">Import past questions to let students practise</div>
          <div class="pq-empty-s" id="pqEmptyStudentMsg" style="display:none">No question banks available yet â€” check back later</div>
          <button class="btn-action admin-el" onclick="openPQImport()" style="margin-top:18px;background:linear-gradient(135deg,var(--accent2),var(--accent));">â¬† Import Questions</button>
        </div>
      </div>
    </div>

    <!-- USERS (admin only) -->
    <div id="viewUsers" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">User Management <span id="userCountBadge" style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);font-weight:400;margin-left:8px;"></span></div>
        <input class="search-inp" id="userSearch" placeholder="Search name, username, matricâ€¦" oninput="renderUsers()" style="max-width:180px;padding:8px 12px;">
        <select class="sel" id="userRoleFilter" onchange="renderUsers()" style="max-width:130px;font-size:12px;padding:6px 10px;">
          <option value="">All Roles</option>
          <option value="student">Students</option>
          <option value="teacher">Lecturers</option>
          <option value="admin">Admin</option>
        </select>
        <select class="sel" id="userClassFilter" onchange="renderUsers()" style="max-width:140px;font-size:12px;padding:6px 10px;">
          <option value="">All Classes</option>
        </select>
        <button class="btn-action" onclick="openModal('addLecturerModal')">ï¼‹ Add Lecturer</button>
        <button class="btn-action" onclick="openNominalRollImport()" style="background:rgba(90,173,160,.15);color:var(--accent2);border:1px solid var(--accent2);">ðŸ“¥ Import Nominal Roll</button>
        <button class="btn-action" onclick="removeAllStudents()" style="background:rgba(224,123,123,.12);color:var(--accent4);border:1px solid rgba(224,123,123,.35);">ðŸ—‘ Remove All Students</button>
        <button class="btn-action" id="revealAllPwdBtn" onclick="toggleAllPasswords()" style="background:rgba(62,142,149,.10);color:var(--accent);border:1px solid rgba(62,142,149,.3);">ðŸ‘ Reveal All Passwords</button>
        <button class="btn-action" onclick="resetAllStudentPasswords()" style="background:rgba(90,173,160,.12);color:var(--accent3);border:1px solid rgba(90,173,160,.35);">&#128273; Reset Student Passwords</button>

      </div>
      <div class="content" style="padding-top:16px;">
        <div id="usersGrid" class="users-grid"></div>
      </div>
    </div>

    <!-- ACTIVITY MONITOR VIEW (Admin only) -->
    <div id="viewActivityMonitor" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">ðŸ“¡ Activity Monitor</div>
        <select class="sel" id="actFilterRole" onchange="renderActivityMonitor()" style="max-width:130px;font-size:12px;padding:6px 10px;">
          <option value="">All Roles</option>
          <option value="student">Students</option>
          <option value="teacher">Lecturers</option>
          <option value="admin">Admin</option>
        </select>
        <select class="sel" id="actFilterClass" onchange="renderActivityMonitor()" style="max-width:140px;font-size:12px;padding:6px 10px;">
          <option value="">All Classes</option>
        </select>
        <input class="search-inp" id="actSearch" placeholder="Search name, actionâ€¦" oninput="renderActivityMonitor()" style="max-width:200px;padding:8px 12px;">
        <button class="btn-action" onclick="if(confirm('Clear all activity logs?')){db.activityLogs=[];saveDB();renderActivityMonitor();}" style="background:rgba(224,123,123,.12);color:var(--accent4);border:1px solid rgba(224,123,123,.35);">ðŸ—‘ Clear Logs</button>
      </div>
      <div class="content" style="padding-top:16px;">
        <div id="activityStatsStrip" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px;"></div>
        <div id="activityLogList"></div>
      </div>
    </div>

    <!-- TIMETABLE VIEW -->
    <div id="viewTimetable" class="view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">ðŸ“… Timetable</div>
        <select class="sel" id="ttFilterClass" onchange="renderTimetable()" style="max-width:180px;font-size:12px;padding:6px 10px;">
          <option value="">All Classes</option>
        </select>
        <button class="btn-action admin-el" onclick="openTimetableUpload()">â¬† Upload Timetable</button>
        <button class="btn-ghost admin-el" onclick="openAddTimetableRow()">ï¼‹ Add Entry</button>
      </div>
      <div class="content" style="padding-top:16px;">
        <!-- Timetable grid -->
        <div id="ttGrid"></div>
        <!-- Upcoming today strip -->
        <div id="ttTodayStrip" style="margin-bottom:20px;"></div>
      </div>
    </div>

    <!-- TIMETABLE UPLOAD MODAL -->
    <div class="overlay" id="ttUploadModal">
      <div class="modal" style="max-width:520px;">
        <div class="modal-hd"><div class="modal-ht">â¬† Upload Timetable</div><button class="modal-x" onclick="closeModal('ttUploadModal')">âœ•</button></div>
        <div class="modal-bd">
          <div style="background:rgba(62,142,149,.08);border:1px solid rgba(62,142,149,.2);border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;line-height:1.7;">
            <strong>Accepted formats:</strong> Excel (.xlsx/.xls) or CSV<br>
            <strong>Required columns:</strong> <code>Class, Course, Day, Start Time, End Time, Venue</code><br>
            <strong>Days:</strong> Monday, Tuesday, Wednesday, Thursday, Friday, Saturday<br>
            <strong>Time format:</strong> 8:00 AM or 08:00
          </div>
          <div class="drop-area" id="ttDropArea" onclick="document.getElementById('ttFileInput').click()" style="margin-bottom:14px;">
            <div class="drop-ico" id="ttDropIco">ðŸ“Š</div>
            <div class="drop-txt" id="ttDropTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
            <div class="drop-fmts">XLSX Â· XLS Â· CSV</div>
          </div>
          <input type="file" id="ttFileInput" style="display:none" accept=".xlsx,.xls,.csv" onchange="ttFileChosen(this)">
          <div id="ttParsePreview" style="display:none;margin-bottom:14px;max-height:220px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;"></div>
          <div id="ttParseStatus" style="font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:10px;"></div>
          <div style="display:flex;gap:10px;">
            <button class="btn-submit-green" id="ttImportBtn" onclick="importParsedTimetable()" style="display:none;">âœ“ Import Timetable</button>
            <button class="btn-ghost" onclick="closeModal('ttUploadModal')" style="flex:1;">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ADD/EDIT TIMETABLE ENTRY MODAL -->
    <div class="overlay" id="ttEntryModal">
      <div class="modal" style="max-width:460px;">
        <div class="modal-hd"><div class="modal-ht" id="ttEntryModalTitle">Add Timetable Entry</div><button class="modal-x" onclick="closeModal('ttEntryModal')">âœ•</button></div>
        <div class="modal-bd">
          <input type="hidden" id="ttEditId">
          <div class="form-g"><label class="inp-label">Class</label>
            <select class="sel" id="ttEntryClass" onchange="ttPopulateCourseSel()"></select>
          </div>
          <div class="form-g"><label class="inp-label">Course</label>
            <select class="sel" id="ttEntryCourse"></select>
          </div>
          <div class="form-g"><label class="inp-label">Day</label>
            <select class="sel" id="ttEntryDay">
              <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
              <option>Thursday</option><option>Friday</option><option>Saturday</option>
            </select>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="form-g"><label class="inp-label">Start Time</label><input class="inp" id="ttEntryStart" placeholder="e.g. 8:00 AM" type="time"></div>
            <div class="form-g"><label class="inp-label">End Time</label><input class="inp" id="ttEntryEnd" placeholder="e.g. 10:00 AM" type="time"></div>
          </div>
          <div class="form-g"><label class="inp-label">Venue / Room</label><input class="inp" id="ttEntryVenue" placeholder="e.g. Lecture Hall A"></div>
          <button class="btn-submit-green" onclick="saveTimetableEntry()">Save Entry â†’</button>
        </div>
      </div>
    </div>

    <!-- IN-APP NOTIFICATION BELL PANEL -->
    <div id="nvNotifPanel" style="display:none;position:fixed;top:58px;right:16px;width:360px;max-height:80vh;overflow-y:auto;background:var(--bg2);border:1px solid var(--border);border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,.35);z-index:9000;padding:6px 0;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 18px 8px;border-bottom:1px solid var(--border);">
        <span style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;">ðŸ”” Notifications</span>
        <button onclick="clearAllNotifs()" style="font-size:11px;color:var(--text3);background:none;border:none;cursor:pointer;font-family:'DM Mono',monospace;">Clear all</button>
      </div>
      <div id="nvNotifList"></div>
    </div>

    <!-- NOTIFICATION BELL IN TOPBAR (injected via JS) -->
    <div id="viewMessages" class="view" style="display:none">
      <div class="msg-layout">
        <!-- Sidebar: channel list -->
        <div class="msg-sidebar" id="msgSidebarPane">
          <div class="msg-sidebar-head">
            <span class="msg-sidebar-title">ðŸ’¬ Messages</span>
            <button class="msg-new-btn" onclick="openNewChat()" title="New message">ï¼‹</button>
          </div>
          <div class="msg-search">
            <input id="msgSearchInp" placeholder="Search chatsâ€¦" oninput="filterMsgChannels(this.value)">
          </div>
          <div class="msg-channels" id="msgChannelList"></div>
        </div>
        <!-- Main chat area -->
        <div class="msg-main" id="msgMainPane">
          <div class="msg-empty-state" id="msgEmptyState">
            <div class="msg-empty-icon">ðŸ’¬</div>
            <div class="msg-empty-text">No conversation selected</div>
            <div class="msg-empty-sub">Choose a chat or start a new one</div>
          </div>
          <div id="msgActiveChat" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
            <div class="msg-main-head">
              <button class="msg-back-btn" id="msgBackBtn" onclick="msgGoBack()">â† Back</button>
              <div class="msg-main-av" id="msgChatAv">ðŸ’¬</div>
              <div>
                <div class="msg-main-name" id="msgChatName">Chat</div>
                <div class="msg-main-sub" id="msgChatSub">â€”</div>
              </div>
              <span id="msgAnnounceBadge" class="msg-announce-badge" style="display:none">ðŸ“¢ Class Broadcast</span>
            </div>
            <div class="msg-body" id="msgBody"></div>
            <div class="msg-typing" id="msgTypingIndicator" style="display:none"></div>
            <div id="msgReadonlyNotice" style="display:none;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-top:1px solid var(--border);background:var(--bg2);font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;">
              ðŸ”’ You cannot send messages in this channel.
            </div>
            <!-- Voice recording bar â€” STATE 1: recording -->
            <div class="msg-record-bar" id="msgRecordBar">
              <span style="font-size:18px;animation:recPulse 1s ease-in-out infinite;">ðŸŽ™</span>
              <div class="msg-rec-timer" id="msgRecTimer">0:00</div>
              <div class="msg-rec-wave" id="msgRecWave" style="flex:1;"></div>
              <button class="msg-rec-cancel" onclick="cancelVoiceRecord()">âœ• Cancel</button>
              <button class="msg-rec-send" onclick="stopRecordingForPreview()" style="background:#e07b7b;">Stop â– </button>
            </div>

            <!-- Voice preview bar â€” STATE 2: pre-listen before sending -->
            <div id="msgVoicePreviewBar" style="display:none;align-items:center;gap:10px;padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2);">
              <button id="voicePreviewPlayBtn" onclick="toggleVoicePreview()" style="width:36px;height:36px;border-radius:50%;border:none;background:#e07b7b;color:#fff;font-size:16px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;">â–¶</button>
              <div style="flex:1;position:relative;height:32px;background:var(--bg3);border-radius:8px;overflow:hidden;cursor:pointer;" id="voicePreviewProgress" onclick="seekVoicePreview(event)">
                <div id="voicePreviewBar" style="height:100%;background:rgba(224,123,123,.25);width:0%;transition:width .1s linear;pointer-events:none;"></div>
                <div id="voicePreviewWaveStatic" style="position:absolute;inset:0;display:flex;align-items:center;gap:2px;padding:0 8px;pointer-events:none;"></div>
              </div>
              <div id="voicePreviewTimer" style="font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);min-width:38px;text-align:right;flex-shrink:0;">0:00</div>
              <button onclick="cancelVoicePreview()" style="padding:6px 11px;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--text2);font-size:12px;cursor:pointer;font-family:'DM Mono',monospace;transition:all .2s;flex-shrink:0;">Re-record</button>
              <button onclick="sendVoicePreview()" style="padding:6px 13px;border:none;border-radius:8px;background:#e07b7b;color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Mono',monospace;flex-shrink:0;">Send â–²</button>
            </div>
            <!-- Normal input bar -->
            <div class="msg-input-bar" id="msgInputBar">
              <input type="file" id="msgFileInput" multiple accept="*/*" style="display:none" onchange="handleMsgFileAttach(this)">
              <button class="msg-icon-btn" onclick="document.getElementById('msgFileInput').click()" title="Attach file">ðŸ“Ž</button>
              <div class="msg-input-wrap" style="flex:1;">
                <textarea class="msg-input" id="msgTextInp" placeholder="Type a messageâ€¦" rows="1" onkeydown="msgKeydown(event)" oninput="msgAutoResize(this)"></textarea>
              </div>
              <button class="msg-icon-btn" id="msgVoiceBtn" onclick="startVoiceRecord()" title="Voice message">ðŸŽ™</button>
              <button class="msg-send-btn" onclick="sendMessage()" title="Send">âž¤</button>
            </div>
          </div>
        </div>
      </div>

        <!-- Classmates Panel (right column, students only) -->
        <div class="msg-classmates" id="msgClassmatesPanel" style="display:none;">
          <div class="msg-classmates-head">
            <div class="msg-classmates-title">ðŸŽ“ <span id="msgClassmatesTitle">My Class</span></div>
            <div class="msg-classmates-sub" id="msgClassmatesSub">Your classmates</div>
          </div>
          <div class="msg-classmates-search">
            <input id="msgClassmatesSearch" placeholder="Search classmatesâ€¦" oninput="filterClassmates(this.value)">
          </div>
          <div class="msg-classmates-list" id="msgClassmatesList"></div>
          <div style="padding:8px 10px;border-top:1px solid var(--border);flex-shrink:0;">
            <button class="msg-other-class-btn" onclick="openOtherClassPanel()">
              ðŸ” Message another class
            </button>
          </div>
        </div>
      </div>
    
<div id="viewLabref" class="view nv-view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">ðŸ§ª Lab Reference</div>
        <button class="btn-action admin-el" onclick="openAddLabModal()" style="white-space:nowrap;">ï¼‹ Add Values</button>
      </div>
      <div class="content">
        <div class="nv-tabs" style="margin-top:4px;">
          <button class="nv-tab-btn active" onclick="nvSwitchTab('labref','labs')">Lab Values</button>
          <button class="nv-tab-btn" onclick="nvSwitchTab('labref','vitals')">Vital Signs</button>
          <button class="nv-tab-btn" onclick="nvSwitchTab('labref','scales')">Scales</button>
          <button class="nv-tab-btn" onclick="nvSwitchTab('labref','abg')">ABGs</button>
        </div>
        <div id="labreftab-labs" class="nv-tab-panel active">
          <div class="nv-card nv-mb-0">
            <div class="nv-section-title">ðŸ©¸ Complete Blood Count (CBC)</div>
            <table class="ref-table">
              <tr><th>Test</th><th>Normal Range</th><th>Critical Low / High</th></tr>
              <tr><td>Hemoglobin (Male)</td><td class="normal-val">13.5â€“17.5 g/dL</td><td class="critical-val">&lt;7 / &gt;20</td></tr>
              <tr><td>Hemoglobin (Female)</td><td class="normal-val">12.0â€“15.5 g/dL</td><td class="critical-val">&lt;7 / &gt;20</td></tr>
              <tr><td>Hematocrit (Male)</td><td class="normal-val">41â€“53%</td><td class="critical-val">&lt;20% / &gt;60%</td></tr>
              <tr><td>Hematocrit (Female)</td><td class="normal-val">36â€“46%</td><td class="critical-val">&lt;20% / &gt;60%</td></tr>
              <tr><td>WBC</td><td class="normal-val">4,500â€“11,000 /ÂµL</td><td class="critical-val">&lt;2,000 / &gt;30,000</td></tr>
              <tr><td>Platelets</td><td class="normal-val">150,000â€“400,000 /ÂµL</td><td class="critical-val">&lt;50,000 / &gt;1,000,000</td></tr>
              <tr><td>RBC (Male)</td><td class="normal-val">4.7â€“6.1 million/ÂµL</td><td class="critical-val">â€”</td></tr>
              <tr><td>MCV</td><td class="normal-val">80â€“100 fL</td><td class="critical-val">â€”</td></tr>
            </table>
            <div class="nv-section-title">ðŸ§¬ Basic Metabolic Panel (BMP)</div>
            <table class="ref-table">
              <tr><th>Electrolyte</th><th>Normal Range</th><th>Critical</th></tr>
              <tr><td>Sodium (Naâº)</td><td class="normal-val">136â€“145 mEq/L</td><td class="critical-val">&lt;120 / &gt;160</td></tr>
              <tr><td>Potassium (Kâº)</td><td class="normal-val">3.5â€“5.0 mEq/L</td><td class="critical-val">&lt;2.5 / &gt;6.5</td></tr>
              <tr><td>Chloride (Clâ»)</td><td class="normal-val">98â€“106 mEq/L</td><td class="critical-val">&lt;80 / &gt;115</td></tr>
              <tr><td>Bicarbonate (HCOâ‚ƒâ»)</td><td class="normal-val">22â€“29 mEq/L</td><td class="critical-val">&lt;10 / &gt;40</td></tr>
              <tr><td>BUN</td><td class="normal-val">7â€“20 mg/dL</td><td class="critical-val">&gt;100</td></tr>
              <tr><td>Creatinine</td><td class="normal-val">0.6â€“1.2 mg/dL</td><td class="critical-val">&gt;10</td></tr>
              <tr><td>Glucose (fasting)</td><td class="normal-val">70â€“100 mg/dL</td><td class="critical-val">&lt;40 / &gt;500</td></tr>
              <tr><td>Calcium</td><td class="normal-val">8.5â€“10.5 mg/dL</td><td class="critical-val">&lt;6.5 / &gt;13</td></tr>
              <tr><td>Magnesium</td><td class="normal-val">1.5â€“2.5 mEq/L</td><td class="critical-val">&lt;1.0 / &gt;5.0</td></tr>
              <tr><td>Phosphorus</td><td class="normal-val">2.5â€“4.5 mg/dL</td><td class="critical-val">â€”</td></tr>
            </table>
            <div class="nv-section-title">ðŸ«€ Cardiac Markers & Coagulation</div>
            <table class="ref-table">
              <tr><th>Marker</th><th>Normal</th><th>Note</th></tr>
              <tr><td>Troponin I</td><td class="normal-val">&lt;0.04 ng/mL</td><td class="nv-text-xs nv-text-dim">Rises 3â€“6h post-MI</td></tr>
              <tr><td>Troponin T</td><td class="normal-val">&lt;0.01 ng/mL</td><td class="nv-text-xs nv-text-dim">Peaks 12â€“24h</td></tr>
              <tr><td>CK-MB</td><td class="normal-val">&lt;5% total CK</td><td class="nv-text-xs nv-text-dim">Rises 4â€“8h post-MI</td></tr>
              <tr><td>BNP</td><td class="normal-val">&lt;100 pg/mL</td><td class="nv-text-xs nv-text-dim">Heart failure marker</td></tr>
              <tr><td>PT/INR</td><td class="normal-val">11â€“13.5s / 0.8â€“1.1</td><td class="nv-text-xs nv-text-dim">Therapeutic 2â€“3 on warfarin</td></tr>
              <tr><td>aPTT</td><td class="normal-val">25â€“35 seconds</td><td class="nv-text-xs nv-text-dim">Therapeutic 60â€“100s (heparin)</td></tr>
              <tr><td>D-Dimer</td><td class="normal-val">&lt;0.5 mg/L</td><td class="nv-text-xs nv-text-dim">Elevated in DVT/PE</td></tr>
            </table>
            <div class="nv-section-title">ðŸ§« Liver Function Tests (LFTs)</div>
            <table class="ref-table">
              <tr><th>Test</th><th>Normal Range</th><th>Note</th></tr>
              <tr><td>ALT (SGPT)</td><td class="normal-val">7â€“56 U/L</td><td class="nv-text-xs nv-text-dim">Liver damage marker</td></tr>
              <tr><td>AST (SGOT)</td><td class="normal-val">10â€“40 U/L</td><td class="nv-text-xs nv-text-dim">Liver &amp; heart muscle</td></tr>
              <tr><td>ALP</td><td class="normal-val">44â€“147 U/L</td><td class="nv-text-xs nv-text-dim">Bone/liver disease</td></tr>
              <tr><td>Total Bilirubin</td><td class="normal-val">0.1â€“1.2 mg/dL</td><td class="nv-text-xs nv-text-dim">&gt;2.5 visible jaundice</td></tr>
              <tr><td>Albumin</td><td class="normal-val">3.5â€“5.0 g/dL</td><td class="nv-text-xs nv-text-dim">Nutritional/hepatic status</td></tr>
              <tr><td>Total Protein</td><td class="normal-val">6.0â€“8.3 g/dL</td><td class="nv-text-xs nv-text-dim">â€”</td></tr>
            </table>
            <div class="nv-section-title">ðŸ«˜ Renal Panel</div>
            <table class="ref-table">
              <tr><th>Test</th><th>Normal Range</th><th>Critical</th></tr>
              <tr><td>eGFR</td><td class="normal-val">&gt;60 mL/min/1.73mÂ²</td><td class="critical-val">&lt;15 = Kidney failure</td></tr>
              <tr><td>BUN:Creatinine Ratio</td><td class="normal-val">10:1 â€“ 20:1</td><td class="nv-text-xs nv-text-dim">Pre-renal if &gt;20:1</td></tr>
              <tr><td>Uric Acid (Male)</td><td class="normal-val">3.4â€“7.0 mg/dL</td><td class="nv-text-xs nv-text-dim">Gout risk if elevated</td></tr>
              <tr><td>Urinalysis pH</td><td class="normal-val">4.5â€“8.0</td><td class="nv-text-xs nv-text-dim">Normally slightly acidic</td></tr>
              <tr><td>Specific Gravity</td><td class="normal-val">1.005â€“1.030</td><td class="nv-text-xs nv-text-dim">Hydration indicator</td></tr>
            </table>
            <div class="nv-section-title">ðŸ©º Thyroid Panel</div>
            <table class="ref-table">
              <tr><th>Test</th><th>Normal Range</th><th>Note</th></tr>
              <tr><td>TSH</td><td class="normal-val">0.4â€“4.0 mU/L</td><td class="nv-text-xs nv-text-dim">Best initial thyroid test</td></tr>
              <tr><td>Free T4</td><td class="normal-val">0.9â€“2.4 ng/dL</td><td class="nv-text-xs nv-text-dim">Active thyroid hormone</td></tr>
              <tr><td>Free T3</td><td class="normal-val">2.3â€“4.1 pg/mL</td><td class="nv-text-xs nv-text-dim">Most metabolically active</td></tr>
            </table>
            <div class="nv-section-title">ðŸ©¸ Iron Studies</div>
            <table class="ref-table">
              <tr><th>Test</th><th>Normal Range</th><th>Note</th></tr>
              <tr><td>Serum Iron</td><td class="normal-val">60â€“170 mcg/dL</td><td class="nv-text-xs nv-text-dim">Low in iron-deficiency anaemia</td></tr>
              <tr><td>TIBC</td><td class="normal-val">240â€“450 mcg/dL</td><td class="nv-text-xs nv-text-dim">â†‘ when iron is deficient</td></tr>
              <tr><td>Ferritin</td><td class="normal-val">12â€“300 ng/mL</td><td class="nv-text-xs nv-text-dim">&lt;10 = deficiency</td></tr>
              <tr><td>Transferrin Sat.</td><td class="normal-val">20â€“50%</td><td class="nv-text-xs nv-text-dim">&lt;15% = deficiency</td></tr>
            </table>
            <div class="nv-section-title">ðŸ§¬ Lipid Panel</div>
            <table class="ref-table">
              <tr><th>Test</th><th>Optimal</th><th>High Risk</th></tr>
              <tr><td>Total Cholesterol</td><td class="normal-val">&lt;200 mg/dL</td><td class="critical-val">â‰¥240 mg/dL</td></tr>
              <tr><td>LDL</td><td class="normal-val">&lt;100 mg/dL</td><td class="critical-val">â‰¥160 mg/dL</td></tr>
              <tr><td>HDL (Male)</td><td class="normal-val">â‰¥40 mg/dL</td><td class="critical-val">&lt;40 mg/dL</td></tr>
              <tr><td>HDL (Female)</td><td class="normal-val">â‰¥50 mg/dL</td><td class="critical-val">&lt;50 mg/dL</td></tr>
              <tr><td>Triglycerides</td><td class="normal-val">&lt;150 mg/dL</td><td class="critical-val">â‰¥500 mg/dL</td></tr>
            </table>
            <div class="nv-section-title">ðŸ©º Haemoglobin A1c & Glucose</div>
            <table class="ref-table">
              <tr><th>Test</th><th>Normal</th><th>Diabetic Range</th></tr>
              <tr><td>HbA1c</td><td class="normal-val">&lt;5.7%</td><td class="critical-val">â‰¥6.5% = Diabetes</td></tr>
              <tr><td>Fasting Glucose</td><td class="normal-val">70â€“100 mg/dL</td><td class="critical-val">â‰¥126 mg/dL = Diabetes</td></tr>
              <tr><td>2-hr Postprandial</td><td class="normal-val">&lt;140 mg/dL</td><td class="critical-val">â‰¥200 mg/dL = Diabetes</td></tr>
              <tr><td>Random Glucose</td><td class="normal-val">â€”</td><td class="critical-val">â‰¥200 mg/dL + symptoms</td></tr>
            </table>
            <div class="nv-section-title">ðŸ« Arterial Blood Gases (Quick Ref)</div>
            <table class="ref-table">
              <tr><th>Test</th><th>Normal</th><th>Critical</th></tr>
              <tr><td>pH</td><td class="normal-val">7.35â€“7.45</td><td class="critical-val">&lt;7.2 / &gt;7.6</td></tr>
              <tr><td>PaOâ‚‚</td><td class="normal-val">80â€“100 mmHg</td><td class="critical-val">&lt;40 mmHg</td></tr>
              <tr><td>PaCOâ‚‚</td><td class="normal-val">35â€“45 mmHg</td><td class="critical-val">&lt;20 / &gt;70</td></tr>
              <tr><td>HCOâ‚ƒâ»</td><td class="normal-val">22â€“26 mEq/L</td><td class="critical-val">&lt;10 / &gt;40</td></tr>
            </table>
            <!-- Admin-added lab values appear here -->
            <div id="adminLabSection-labs"></div>
          </div>
        <div id="labreftab-vitals" class="nv-tab-panel">
          <div class="nv-card nv-mb-0">
            <div class="nv-section-title">â¤ï¸ Vital Signs by Age Group</div>
            <table class="ref-table">
              <tr><th>Age</th><th>HR (bpm)</th><th>RR (/min)</th><th>BP (mmHg)</th></tr>
              <tr><td>Newborn</td><td class="normal-val">100â€“160</td><td class="normal-val">30â€“60</td><td class="normal-val">60â€“90/30â€“60</td></tr>
              <tr><td>Infant (1â€“12 mo)</td><td class="normal-val">80â€“140</td><td class="normal-val">20â€“40</td><td class="normal-val">70â€“100/50â€“65</td></tr>
              <tr><td>Toddler (1â€“3 yr)</td><td class="normal-val">80â€“130</td><td class="normal-val">20â€“30</td><td class="normal-val">80â€“110/50â€“80</td></tr>
              <tr><td>Preschool (3â€“6)</td><td class="normal-val">80â€“120</td><td class="normal-val">20â€“25</td><td class="normal-val">80â€“115/55â€“80</td></tr>
              <tr><td>School age (6â€“12)</td><td class="normal-val">70â€“110</td><td class="normal-val">14â€“22</td><td class="normal-val">85â€“120/55â€“80</td></tr>
              <tr><td>Adolescent</td><td class="normal-val">55â€“105</td><td class="normal-val">12â€“20</td><td class="normal-val">95â€“140/60â€“90</td></tr>
              <tr><td><strong>Adult</strong></td><td class="normal-val"><strong>60â€“100</strong></td><td class="normal-val"><strong>12â€“20</strong></td><td class="normal-val"><strong>&lt;120/&lt;80</strong></td></tr>
              <tr><td>Elderly (&gt;65)</td><td class="normal-val">60â€“100</td><td class="normal-val">12â€“20</td><td class="normal-val">May vary â†‘</td></tr>
            </table>
            <div class="nv-section-title">ðŸŒ¡ï¸ Temperature Equivalents</div>
            <table class="ref-table">
              <tr><th>State</th><th>Â°C</th><th>Â°F</th></tr>
              <tr><td>Hypothermia</td><td class="critical-val">&lt;35.0Â°C</td><td class="critical-val">&lt;95.0Â°F</td></tr>
              <tr><td>Normal range</td><td class="normal-val">36.1â€“37.2Â°C</td><td class="normal-val">97.0â€“99.0Â°F</td></tr>
              <tr><td>Fever</td><td style="color:var(--nv-accent-warm);font-weight:600;">37.3â€“38.9Â°C</td><td style="color:var(--nv-accent-warm);font-weight:600;">99.1â€“102.0Â°F</td></tr>
              <tr><td>High fever</td><td class="critical-val">&gt;39.0Â°C</td><td class="critical-val">&gt;102.2Â°F</td></tr>
              <tr><td>Hyperpyrexia</td><td class="critical-val">&gt;41.5Â°C</td><td class="critical-val">&gt;106.7Â°F</td></tr>
            </table>
            <div class="nv-section-title">ðŸ’§ Urine Output</div>
            <table class="ref-table">
              <tr><th>Status</th><th>Output</th></tr>
              <tr><td>Normal Adult</td><td class="normal-val">0.5â€“1.0 mL/kg/hr (30â€“60 mL/hr)</td></tr>
              <tr><td>Oliguria</td><td class="critical-val">&lt;0.5 mL/kg/hr (&lt;400 mL/day)</td></tr>
              <tr><td>Anuria</td><td class="critical-val">&lt;100 mL/day</td></tr>
              <tr><td>Polyuria</td><td style="color:var(--nv-accent-warm);font-weight:600;">&gt;2,500 mL/day</td></tr>
            </table>
            <div class="nv-section-title">ðŸ«€ Oâ‚‚ Saturation Interpretation</div>
            <table class="ref-table">
              <tr><th>SpOâ‚‚</th><th>Status</th><th>Action</th></tr>
              <tr><td class="normal-val">95â€“100%</td><td>Normal</td><td class="nv-text-xs nv-text-dim">Routine monitoring</td></tr>
              <tr><td style="color:var(--nv-accent-warm);font-weight:600;font-family:'DM Mono',monospace;font-size:12px;">90â€“94%</td><td>Mild hypoxemia</td><td class="nv-text-xs nv-text-dim">Supplemental Oâ‚‚, assess patient</td></tr>
              <tr><td class="critical-val">&lt;90%</td><td>Hypoxemia</td><td class="critical-val">Immediate intervention</td></tr>
              <tr><td class="critical-val">&lt;85%</td><td>Severe hypoxemia</td><td class="critical-val">Emergency â€” call rapid response</td></tr>
            </table>
            <div class="nv-section-title">ðŸ’Š Pain Assessment (PQRST)</div>
            <table class="ref-table">
              <tr><th>Letter</th><th>Meaning</th><th>Ask the Patient</th></tr>
              <tr><td class="normal-val"><strong>P</strong></td><td>Provocation/Palliation</td><td class="nv-text-xs nv-text-dim">What makes it better or worse?</td></tr>
              <tr><td class="normal-val"><strong>Q</strong></td><td>Quality</td><td class="nv-text-xs nv-text-dim">Describe the pain (sharp, dull, burningâ€¦)</td></tr>
              <tr><td class="normal-val"><strong>R</strong></td><td>Radiation</td><td class="nv-text-xs nv-text-dim">Does it spread anywhere?</td></tr>
              <tr><td class="normal-val"><strong>S</strong></td><td>Severity</td><td class="nv-text-xs nv-text-dim">Rate pain 0â€“10</td></tr>
              <tr><td class="normal-val"><strong>T</strong></td><td>Timing</td><td class="nv-text-xs nv-text-dim">Onset, duration, pattern</td></tr>
            </table>
            <div class="nv-section-title">ðŸ«€ Haemodynamic Parameters</div>
            <table class="ref-table">
              <tr><th>Parameter</th><th>Normal Range</th><th>Critical</th></tr>
              <tr><td>MAP (Mean Arterial Pressure)</td><td class="normal-val">70â€“100 mmHg</td><td class="critical-val">&lt;60 = Organ hypoperfusion</td></tr>
              <tr><td>CVP (Central Venous)</td><td class="normal-val">2â€“8 mmHg</td><td class="nv-text-xs nv-text-dim">â†“ = Hypovolemia, â†‘ = Fluid overload</td></tr>
              <tr><td>Pulse Pressure</td><td class="normal-val">30â€“50 mmHg</td><td class="nv-text-xs nv-text-dim">Narrow = shock; Wide = aortic regurg</td></tr>
              <tr><td>Cardiac Output</td><td class="normal-val">4â€“8 L/min</td><td class="critical-val">&lt;2.5 = Cardiogenic shock</td></tr>
            </table>
            <!-- Admin-added vitals appear here -->
            <div id="adminLabSection-vitals"></div>
          </div>
        </div>
        <div id="labreftab-scales" class="nv-tab-panel">
          <div class="nv-card">
            <div class="nv-section-title">ðŸ§  Glasgow Coma Scale (GCS)</div>
            <table class="ref-table">
              <tr><th>Component</th><th>Response</th><th>Score</th></tr>
              <tr><td rowspan="4"><strong>Eyes (E)</strong></td><td>Spontaneous</td><td class="normal-val">4</td></tr>
              <tr><td>To voice</td><td class="normal-val">3</td></tr>
              <tr><td>To pain</td><td style="color:var(--nv-accent-warm);">2</td></tr>
              <tr><td>None</td><td class="critical-val">1</td></tr>
              <tr><td rowspan="5"><strong>Verbal (V)</strong></td><td>Oriented</td><td class="normal-val">5</td></tr>
              <tr><td>Confused</td><td class="normal-val">4</td></tr>
              <tr><td>Inappropriate</td><td style="color:var(--nv-accent-warm);">3</td></tr>
              <tr><td>Incomprehensible</td><td style="color:var(--nv-accent-warm);">2</td></tr>
              <tr><td>None</td><td class="critical-val">1</td></tr>
              <tr><td rowspan="6"><strong>Motor (M)</strong></td><td>Obeys commands</td><td class="normal-val">6</td></tr>
              <tr><td>Localizes pain</td><td class="normal-val">5</td></tr>
              <tr><td>Withdraws</td><td class="normal-val">4</td></tr>
              <tr><td>Abnormal flexion</td><td style="color:var(--nv-accent-warm);">3</td></tr>
              <tr><td>Extension</td><td style="color:var(--nv-accent-warm);">2</td></tr>
              <tr><td>None</td><td class="critical-val">1</td></tr>
            </table>
            <div style="margin-top:12px;padding:10px;background:rgba(62,142,149,.06);border-radius:10px;font-size:12px;">
              <strong>Interpretation:</strong> 15 = Normal Â· 13â€“14 = Minor injury Â· 9â€“12 = Moderate Â· 3â€“8 = Severe Â· â‰¤8 = Consider intubation
            </div>
          </div>
          <div class="nv-card">
            <div class="nv-section-title">ðŸ˜£ Braden Scale (Pressure Injury Risk)</div>
            <table class="ref-table">
              <tr><th>Score</th><th>Risk Level</th><th>Action</th></tr>
              <tr><td class="critical-val">â‰¤9</td><td>Very High Risk</td><td class="nv-text-xs nv-text-dim">Reposition q1h, specialty mattress</td></tr>
              <tr><td style="color:var(--nv-accent-warm);font-weight:600;">10â€“12</td><td>High Risk</td><td class="nv-text-xs nv-text-dim">Reposition q2h, skin protocol</td></tr>
              <tr><td style="color:var(--nv-yellow);font-weight:600;">13â€“14</td><td>Moderate Risk</td><td class="nv-text-xs nv-text-dim">Reposition q2h, moisture barriers</td></tr>
              <tr><td class="normal-val">15â€“18</td><td>Mild Risk</td><td class="nv-text-xs nv-text-dim">Standard care + monitoring</td></tr>
              <tr><td class="normal-val">19â€“23</td><td>No Risk</td><td class="nv-text-xs nv-text-dim">Routine assessment</td></tr>
            </table>
          </div>
          <div class="nv-card">
            <div class="nv-section-title">ðŸ½ï¸ Apgar Score (Newborn)</div>
            <table class="ref-table">
              <tr><th>Sign</th><th>0</th><th>1</th><th>2</th></tr>
              <tr><td>Appearance</td><td>Blue/pale</td><td>Blue extremities</td><td class="normal-val">Pink all over</td></tr>
              <tr><td>Pulse</td><td>Absent</td><td>&lt;100 bpm</td><td class="normal-val">â‰¥100 bpm</td></tr>
              <tr><td>Grimace</td><td>No response</td><td>Grimace</td><td class="normal-val">Cry/cough</td></tr>
              <tr><td>Activity</td><td>Limp</td><td>Some flexion</td><td class="normal-val">Active motion</td></tr>
              <tr><td>Respiration</td><td>Absent</td><td>Weak/irregular</td><td class="normal-val">Strong cry</td></tr>
            </table>
            <div style="margin-top:10px;font-size:12px;color:var(--nv-text-dim);">7â€“10 = Normal Â· 4â€“6 = Moderate concern Â· 0â€“3 = Immediate resuscitation</div>
          </div>
          <div class="nv-card nv-mb-0">
            <div class="nv-section-title">ðŸ˜£ Wong-Baker FACES Pain Scale</div>
            <table class="ref-table">
              <tr><th>Score</th><th>Face</th><th>Description</th></tr>
              <tr><td class="normal-val">0</td><td>ðŸ˜Š</td><td>No hurt</td></tr>
              <tr><td class="normal-val">2</td><td>ðŸ™‚</td><td>Hurts little bit</td></tr>
              <tr><td style="color:var(--nv-yellow);font-weight:600;font-family:'DM Mono',monospace;font-size:12px;">4</td><td>ðŸ˜</td><td>Hurts little more</td></tr>
              <tr><td style="color:var(--nv-accent-warm);font-weight:600;font-family:'DM Mono',monospace;font-size:12px;">6</td><td>ðŸ˜•</td><td>Hurts even more</td></tr>
              <tr><td style="color:var(--nv-accent-warm);font-weight:600;font-family:'DM Mono',monospace;font-size:12px;">8</td><td>ðŸ˜¢</td><td>Hurts whole lot</td></tr>
              <tr><td class="critical-val">10</td><td>ðŸ˜­</td><td>Hurts worst possible</td></tr>
            </table>
          </div>
          <div class="nv-card">
            <div class="nv-section-title">ðŸ¥ SBAR Communication Tool</div>
            <table class="ref-table">
              <tr><th>Letter</th><th>Element</th><th>What to Include</th></tr>
              <tr><td class="normal-val"><strong>S</strong></td><td>Situation</td><td class="nv-text-xs nv-text-dim">Patient name, problem, what's happening now</td></tr>
              <tr><td class="normal-val"><strong>B</strong></td><td>Background</td><td class="nv-text-xs nv-text-dim">Diagnosis, history, admitting diagnosis, allergies</td></tr>
              <tr><td class="normal-val"><strong>A</strong></td><td>Assessment</td><td class="nv-text-xs nv-text-dim">Your clinical assessment and suspected problem</td></tr>
              <tr><td class="normal-val"><strong>R</strong></td><td>Recommendation</td><td class="nv-text-xs nv-text-dim">What you need / suggest (order, action, clarification)</td></tr>
            </table>
          </div>
          <div class="nv-card">
            <div class="nv-section-title">ðŸ©¹ Wound Staging (NPUAP)</div>
            <table class="ref-table">
              <tr><th>Stage</th><th>Description</th><th>Nursing Action</th></tr>
              <tr><td class="normal-val">Stage 1</td><td>Non-blanchable redness on intact skin</td><td class="nv-text-xs nv-text-dim">Relieve pressure, moisturise</td></tr>
              <tr><td style="color:var(--nv-accent-warm);font-weight:600;">Stage 2</td><td>Partial thickness â€” shallow open ulcer</td><td class="nv-text-xs nv-text-dim">Moist wound dressing, no debridement</td></tr>
              <tr><td style="color:var(--nv-accent-warm);font-weight:600;">Stage 3</td><td>Full thickness tissue loss</td><td class="nv-text-xs nv-text-dim">Wet-to-dry dressing, wound care consult</td></tr>
              <tr><td class="critical-val">Stage 4</td><td>Full thickness â€” bone/tendon/muscle exposed</td><td class="critical-val">Surgical consult, aggressive wound care</td></tr>
              <tr><td class="critical-val">Unstageable</td><td>Base obscured by slough/eschar</td><td class="nv-text-xs nv-text-dim">Debridement needed before staging</td></tr>
            </table>
          </div>
          <div class="nv-card nv-mb-0">
            <div class="nv-section-title">ðŸ«€ NYHA Heart Failure Classification</div>
            <table class="ref-table">
              <tr><th>Class</th><th>Description</th><th>Symptoms</th></tr>
              <tr><td class="normal-val">I</td><td>No limitation</td><td class="nv-text-xs nv-text-dim">No symptoms with ordinary activity</td></tr>
              <tr><td style="color:var(--nv-yellow);font-weight:600;">II</td><td>Slight limitation</td><td class="nv-text-xs nv-text-dim">Comfortable at rest; dyspnoea with moderate exertion</td></tr>
              <tr><td style="color:var(--nv-accent-warm);font-weight:600;">III</td><td>Marked limitation</td><td class="nv-text-xs nv-text-dim">Dyspnoea with minimal exertion; comfortable at rest</td></tr>
              <tr><td class="critical-val">IV</td><td>Symptoms at rest</td><td class="critical-val">Unable to carry on any activity; dyspnoea at rest</td></tr>
            </table>
            <!-- Admin-added scales appear here -->
            <div id="adminLabSection-scales"></div>
          </div>
        </div>
        <div id="labreftab-abg" class="nv-tab-panel">
          <div class="nv-card">
            <div class="nv-section-title">ðŸ« ABG Normal Values</div>
            <table class="ref-table">
              <tr><th>Parameter</th><th>Normal Range</th><th>Acidosis / Alkalosis</th></tr>
              <tr><td>pH</td><td class="normal-val">7.35â€“7.45</td><td class="nv-text-xs nv-text-dim">&lt;7.35 Acid / &gt;7.45 Alk</td></tr>
              <tr><td>PaCOâ‚‚</td><td class="normal-val">35â€“45 mmHg</td><td class="nv-text-xs nv-text-dim">&gt;45 Acid / &lt;35 Alk</td></tr>
              <tr><td>PaOâ‚‚</td><td class="normal-val">80â€“100 mmHg</td><td class="nv-text-xs nv-text-dim">&lt;60 = Hypoxemia</td></tr>
              <tr><td>HCOâ‚ƒâ»</td><td class="normal-val">22â€“26 mEq/L</td><td class="nv-text-xs nv-text-dim">&lt;22 Acid / &gt;26 Alk</td></tr>
              <tr><td>SaOâ‚‚</td><td class="normal-val">95â€“100%</td><td class="nv-text-xs nv-text-dim">&lt;90% = critical</td></tr>
              <tr><td>Base Excess</td><td class="normal-val">-2 to +2</td><td class="nv-text-xs nv-text-dim">Metabolic indicator</td></tr>
            </table>
          </div>
          <div class="nv-card">
            <div class="nv-section-title">ðŸ” ABG Interpretation Steps</div>
            <div style="font-size:13px;line-height:1.9;color:var(--nv-text-mid);">
              <p style="margin:0 0 8px;"><strong style="color:var(--nv-accent);">Step 1 â€“ pH:</strong> &lt;7.35 = Acidosis Â· &gt;7.45 = Alkalosis</p>
              <p style="margin:0 0 8px;"><strong style="color:var(--nv-accent);">Step 2 â€“ PaCOâ‚‚ (Respiratory):</strong> â†‘COâ‚‚ = Resp. Acidosis Â· â†“COâ‚‚ = Resp. Alkalosis</p>
              <p style="margin:0 0 8px;"><strong style="color:var(--nv-accent);">Step 3 â€“ HCOâ‚ƒâ» (Metabolic):</strong> â†“HCOâ‚ƒ = Met. Acidosis Â· â†‘HCOâ‚ƒ = Met. Alkalosis</p>
              <p style="margin:0 0 8px;"><strong style="color:var(--nv-accent);">Step 4 â€“ Match COâ‚‚ or HCOâ‚ƒ to pH:</strong> The one that matches = primary problem</p>
              <p style="margin:0;"><strong style="color:var(--nv-accent);">Step 5 â€“ Compensation:</strong> Is the other value moving to normalize pH?</p>
            </div>
            <div class="nv-divider"></div>
            <div style="display:grid;gap:8px;font-size:12px;">
              <div style="padding:8px 10px;background:rgba(248,113,113,.06);border-radius:8px;"><strong style="color:var(--nv-red);">Respiratory Acidosis:</strong> â†“pH Â· â†‘COâ‚‚ Â· HCOâ‚ƒ normal/â†‘<br><span class="nv-text-dim">Causes: COPD, hypoventilation, CNS depression</span></div>
              <div style="padding:8px 10px;background:rgba(62,142,149,.06);border-radius:8px;"><strong style="color:var(--nv-accent);">Respiratory Alkalosis:</strong> â†‘pH Â· â†“COâ‚‚ Â· HCOâ‚ƒ normal/â†“<br><span class="nv-text-dim">Causes: Hyperventilation, anxiety, PE, mechanical vent</span></div>
              <div style="padding:8px 10px;background:rgba(248,113,113,.06);border-radius:8px;"><strong style="color:var(--nv-red);">Metabolic Acidosis:</strong> â†“pH Â· COâ‚‚ normal/â†“ Â· â†“HCOâ‚ƒ<br><span class="nv-text-dim">Causes: DKA, renal failure, diarrhea, lactic acidosis</span></div>
              <div style="padding:8px 10px;background:rgba(62,142,149,.06);border-radius:8px;"><strong style="color:var(--nv-accent);">Metabolic Alkalosis:</strong> â†‘pH Â· COâ‚‚ normal/â†‘ Â· â†‘HCOâ‚ƒ<br><span class="nv-text-dim">Causes: Vomiting, NG suction, diuretics, antacids</span></div>
            </div>
          </div>
          <!-- Admin-added ABG content appears here -->
          <div id="adminLabSection-abg"></div>
        </div>
      </div>
    </div>
</div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         DRUG GUIDE VIEW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="viewDrugguide" class="view nv-view" style="display:none">
      <div class="topbar"><div class="topbar-title">ðŸ’Š Drug Guide</div></div>
      <div class="content">
        <div style="position:relative;margin-bottom:14px;margin-top:4px;">
          <input class="nv-input" type="search" id="nvDrugSearch" placeholder="Search drug nameâ€¦" oninput="nvFilterDrugs(this.value)" style="padding-left:38px;">
          <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--nv-text-dim);">ðŸ”</span>
        </div>
        <div class="nv-chips" id="nvDrugClassFilter">
          <span class="nv-chip active" onclick="nvFilterDrugClass('all',this)">All</span>
          <span class="nv-chip" onclick="nvFilterDrugClass('cardiac',this)">Cardiac</span>
          <span class="nv-chip" onclick="nvFilterDrugClass('antibiotic',this)">Antibiotic</span>
          <span class="nv-chip" onclick="nvFilterDrugClass('analgesic',this)">Analgesic</span>
          <span class="nv-chip" onclick="nvFilterDrugClass('anticoag',this)">Anticoag</span>
          <span class="nv-chip" onclick="nvFilterDrugClass('psych',this)">Psych</span>
          <span class="nv-chip" onclick="nvFilterDrugClass('respiratory',this)">Respiratory</span>
          <span class="nv-chip" onclick="nvFilterDrugClass('endocrine',this)">Endocrine</span>
        </div>
        <div id="nvDrugList"></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         FLASHCARDS VIEW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="viewFlashcards" class="view nv-view" style="display:none">
      <div class="topbar"><div class="topbar-title">ðŸƒ Flashcards</div></div>
      <div class="content">
        <div id="nvFcHome">
          <div class="fc-stat-row">
            <div class="fc-stat"><div class="fc-stat-val nv-text-accent" id="nvFcTotal">0</div><div class="fc-stat-label">Total</div></div>
            <div class="fc-stat"><div class="fc-stat-val" style="color:var(--nv-accent-3);" id="nvFcKnown">0</div><div class="fc-stat-label">Mastered</div></div>
            <div class="fc-stat"><div class="fc-stat-val" style="color:var(--nv-red);" id="nvFcUnknown">0</div><div class="fc-stat-label">To Review</div></div>
          </div>
          <div class="nv-card">
            <h3 style="margin-bottom:14px;font-size:1.1rem;font-family:'Syne',sans-serif;">Choose a Category</h3>
            <div id="nvFcCatSelector"></div>
            <button class="nv-btn nv-btn-primary nv-btn-full" onclick="nvStartFlashcards()">Start Session â†’</button>
          </div>
          <div class="nv-card">
            <div class="flex-between" style="margin-bottom:12px;">
              <h3 style="font-size:1rem;font-family:'Syne',sans-serif;">Create Custom Card</h3>
            </div>
            <div class="nv-form-group"><label>Question / Front</label><textarea class="nv-input" id="nvFcNewQ" placeholder="Enter your question or termâ€¦"></textarea></div>
            <div class="nv-form-group"><label>Answer / Back</label><textarea class="nv-input" id="nvFcNewA" placeholder="Enter the answer or definitionâ€¦"></textarea></div>
            <div class="nv-form-group">
              <label>Category</label>
              <select class="nv-input" id="nvFcNewCat">
                <option value="custom">My Cards</option>
                <option value="pharmacology">Pharmacology</option>
                <option value="anatomy">Anatomy &amp; Physiology</option>
                <option value="medsurg">Medical-Surgical</option>
                <option value="mental">Mental Health</option>
              </select>
            </div>
            <button class="nv-btn nv-btn-primary nv-btn-full" onclick="nvAddCustomCard()">Add Card</button>
          </div>
        </div>
        <div id="nvFcSession" style="display:none;">
          <div class="flex-between" style="margin-bottom:10px;">
            <div class="nv-text-xs nv-text-dim" id="nvFcSessionLabel">Card 1 of 10</div>
            <button class="nv-btn nv-btn-secondary nv-btn-sm" onclick="nvEndFcSession()">End Session</button>
          </div>
          <div class="fc-progress-dots" id="nvFcProgressDots"></div>
          <div class="fc-deck">
            <div class="fc-card-wrap" id="nvFcCard" onclick="nvFlipCard()">
              <div class="fc-face fc-front">
                <div class="fc-hint">TAP TO FLIP</div>
                <div class="fc-question" id="nvFcQText">â€”</div>
              </div>
              <div class="fc-face fc-back">
                <div class="fc-hint">ANSWER</div>
                <div class="fc-answer" id="nvFcAText">â€”</div>
              </div>
            </div>
          </div>
          <div class="fc-meta" id="nvFcFlipHint">Tap the card to reveal the answer</div>
          <div class="fc-controls" id="nvFcRatingBtns" style="display:none;">
            <button class="nv-btn nv-btn-danger" onclick="nvRateCard(false)">âœ— Still Learning</button>
            <button class="nv-btn nv-btn-success" onclick="nvRateCard(true)">âœ“ Got It!</button>
          </div>
        </div>
        <div id="nvFcComplete" style="display:none;text-align:center;padding:20px 0;">
          <div style="font-size:52px;margin-bottom:14px;">ðŸŽ‰</div>
          <h2 style="font-family:'Syne',sans-serif;">Session Complete!</h2>
          <div class="fc-stat-row" style="margin-top:16px;">
            <div class="fc-stat"><div class="fc-stat-val" style="color:var(--nv-accent-3);" id="nvFcResultKnown">0</div><div class="fc-stat-label">Mastered</div></div>
            <div class="fc-stat"><div class="fc-stat-val" style="color:var(--nv-red);" id="nvFcResultUnknown">0</div><div class="fc-stat-label">Review</div></div>
            <div class="fc-stat"><div class="fc-stat-val nv-text-accent" id="nvFcResultPct">0%</div><div class="fc-stat-label">Score</div></div>
          </div>
          <button class="nv-btn nv-btn-primary nv-btn-full nv-mt-16" onclick="nvFcBackHome()">â† Back to Flashcards</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MED CALCULATOR VIEW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="viewMedcalc" class="view nv-view" style="display:none">
      <div class="topbar"><div class="topbar-title">âš—ï¸ Med Calculator</div></div>
      <div class="content">
        <div class="nv-tabs" style="margin-top:4px;">
          <button class="nv-tab-btn active" onclick="nvSwitchTab('medcalc','dosage')">Dosage</button>
          <button class="nv-tab-btn" onclick="nvSwitchTab('medcalc','drip')">Drip Rate</button>
          <button class="nv-tab-btn" onclick="nvSwitchTab('medcalc','fluid')">Fluid Balance</button>
          <button class="nv-tab-btn" onclick="nvSwitchTab('medcalc','bmi')">BMI</button>
        </div>
        <div id="medcalctab-dosage" class="nv-tab-panel active">
          <div class="nv-card">
            <h3 style="font-size:1rem;margin-bottom:4px;font-family:'Syne',sans-serif;">Dosage Calculation</h3>
            <p class="nv-text-xs nv-text-dim" style="margin-bottom:14px;">Formula: (Desired Ã· Have) Ã— Volume</p>
            <div class="nv-form-group"><label>Desired Dose (ordered)</label><div style="display:flex;gap:8px;align-items:center;"><input type="number" class="nv-input" id="nvMcDesired" placeholder="e.g. 500" style="margin-bottom:0;flex:1;"><span class="nv-text-xs nv-text-dim">mg</span></div></div>
            <div class="nv-form-group"><label>Have on Hand</label><div style="display:flex;gap:8px;align-items:center;"><input type="number" class="nv-input" id="nvMcHave" placeholder="e.g. 250" style="margin-bottom:0;flex:1;"><span class="nv-text-xs nv-text-dim">mg</span></div></div>
            <div class="nv-form-group"><label>Volume on Hand</label><div style="display:flex;gap:8px;align-items:center;"><input type="number" class="nv-input" id="nvMcVol" placeholder="e.g. 5" style="margin-bottom:0;flex:1;"><span class="nv-text-xs nv-text-dim">mL</span></div></div>
            <button class="nv-btn nv-btn-primary nv-btn-full" onclick="nvCalcDosage()">Calculate</button>
            <div id="nvMcDosageResult" class="nv-calc-result" style="display:none;text-align:center;padding:16px;margin-top:12px;background:rgba(62,142,149,.12);border-radius:12px;"><div class="nv-text-xs nv-text-dim">Administer</div><div style="font-size:2.2rem;font-weight:800;color:var(--nv-accent);" id="nvMcDoseVal">â€”</div><div class="nv-text-xs nv-text-dim">mL</div></div>
          </div>
        </div>
        <div id="medcalctab-drip" class="nv-tab-panel">
          <div class="nv-card">
            <h3 style="font-size:1rem;margin-bottom:4px;font-family:'Syne',sans-serif;">IV Drip Rate</h3>
            <p class="nv-text-xs nv-text-dim" style="margin-bottom:14px;">Formula: (Volume Ã— Drop Factor) Ã· (Time Ã— 60)</p>
            <div class="nv-form-group"><label>Volume (mL)</label><input type="number" class="nv-input" id="nvDripVol" placeholder="e.g. 1000"></div>
            <div class="nv-form-group"><label>Drop Factor (gtts/mL)</label><select class="nv-input" id="nvDripFactor"><option value="20">20 gtts/mL (standard)</option><option value="15">15 gtts/mL</option><option value="60">60 gtts/mL (micro)</option></select></div>
            <div class="nv-form-group"><label>Time (hours)</label><input type="number" class="nv-input" id="nvDripTime" placeholder="e.g. 8"></div>
            <button class="nv-btn nv-btn-primary nv-btn-full" onclick="nvCalcDrip()">Calculate</button>
            <div id="nvMcDripResult" class="nv-calc-result" style="display:none;text-align:center;padding:16px;margin-top:12px;background:rgba(62,142,149,.12);border-radius:12px;"><div class="nv-text-xs nv-text-dim">Drip Rate</div><div style="font-size:2.2rem;font-weight:800;color:var(--nv-accent);" id="nvDripVal">â€”</div><div class="nv-text-xs nv-text-dim">gtts / min</div></div>
          </div>
        </div>
        <div id="medcalctab-fluid" class="nv-tab-panel">
          <div class="nv-card">
            <h3 style="font-size:1rem;margin-bottom:14px;font-family:'Syne',sans-serif;">Fluid Balance</h3>
            <div style="font-size:11px;font-weight:700;color:var(--nv-text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Intake</div>
            <div class="nv-form-group"><label>IV Fluids (mL)</label><input type="number" class="nv-input" id="nvFbIv" placeholder="0"></div>
            <div class="nv-form-group"><label>Oral Intake (mL)</label><input type="number" class="nv-input" id="nvFbOral" placeholder="0"></div>
            <div class="nv-form-group"><label>Other Intake (mL)</label><input type="number" class="nv-input" id="nvFbOtherIn" placeholder="0"></div>
            <div style="font-size:11px;font-weight:700;color:var(--nv-text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;margin-top:4px;">Output</div>
            <div class="nv-form-group"><label>Urine Output (mL)</label><input type="number" class="nv-input" id="nvFbUrine" placeholder="0"></div>
            <div class="nv-form-group"><label>Other Output (mL)</label><input type="number" class="nv-input" id="nvFbOtherOut" placeholder="0"></div>
            <button class="nv-btn nv-btn-primary nv-btn-full" onclick="nvCalcFluid()">Calculate Balance</button>
            <div id="nvFbResult" class="nv-calc-result" style="display:none;margin-top:12px;background:rgba(62,142,149,.12);border-radius:12px;padding:16px;"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;text-align:center;"><div><div class="nv-text-xs nv-text-dim">Intake</div><div style="font-size:1.6rem;font-weight:800;color:var(--nv-accent-3);" id="nvFbTotalIn">â€”</div><div class="nv-text-xs nv-text-dim">mL</div></div><div><div class="nv-text-xs nv-text-dim">Output</div><div style="font-size:1.6rem;font-weight:800;color:var(--nv-red);" id="nvFbTotalOut">â€”</div><div class="nv-text-xs nv-text-dim">mL</div></div><div><div class="nv-text-xs nv-text-dim">Balance</div><div style="font-size:1.6rem;font-weight:800;color:var(--nv-accent);" id="nvFbBalance">â€”</div><div class="nv-text-xs nv-text-dim">mL</div></div></div></div>
          </div>
        </div>
        <div id="medcalctab-bmi" class="nv-tab-panel">
          <div class="nv-card">
            <h3 style="font-size:1rem;margin-bottom:4px;font-family:'Syne',sans-serif;">BMI Calculator</h3>
            <p class="nv-text-xs nv-text-dim" style="margin-bottom:14px;">Formula: Weight Ã· HeightÂ²</p>
            <div class="nv-form-group"><label>Weight (kg)</label><input type="number" class="nv-input" id="nvBmiWeight" placeholder="e.g. 70"></div>
            <div class="nv-form-group"><label>Height (cm)</label><input type="number" class="nv-input" id="nvBmiHeight" placeholder="e.g. 175"></div>
            <button class="nv-btn nv-btn-primary nv-btn-full" onclick="nvCalcBmi()">Calculate BMI</button>
            <div id="nvBmiResult" class="nv-calc-result" style="display:none;text-align:center;padding:16px;margin-top:12px;background:rgba(62,142,149,.12);border-radius:12px;"><div class="nv-text-xs nv-text-dim">BMI</div><div style="font-size:2.2rem;font-weight:800;color:var(--nv-accent);" id="nvBmiVal">â€”</div><div class="nv-text-xs nv-text-dim" id="nvBmiClass" style="margin-top:4px;font-size:13px;font-weight:600;">â€”</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         STUDY PLANNER VIEW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="viewStudyplanner" class="view nv-view" style="display:none">
      <div class="topbar"><div class="topbar-title">ðŸ“… Study Planner</div></div>
      
<div class="content">
        <div class="nv-tabs" style="margin-top:4px;">
          <button class="nv-tab-btn active" onclick="nvSwitchTab('studyplanner','week')">This Week</button>
          <button class="nv-tab-btn" onclick="nvSwitchTab('studyplanner','exams')">Exam Dates</button>
          <button class="nv-tab-btn" onclick="nvSwitchTab('studyplanner','add')">Add Session</button>
        </div>
        <div id="studyplannertab-week" class="nv-tab-panel active">
          <div id="nvPlannerWeekView"></div>
        </div>
        <div id="studyplannertab-exams" class="nv-tab-panel">
          <div id="nvExamCountdownList"></div>
          <div class="nv-card">
            <h3 style="font-size:1rem;margin-bottom:14px;font-family:'Syne',sans-serif;">Add Exam</h3>
            <div class="nv-form-group"><label>Subject</label><input type="text" class="nv-input" id="nvExamSubj" placeholder="e.g. Pharmacology II"></div>
            <div class="nv-form-group"><label>Exam Date</label><input type="date" class="nv-input" id="nvExamDate"></div>
            <button class="nv-btn nv-btn-primary nv-btn-full" onclick="nvAddExam()">Add Exam</button>
          </div>
        </div>
        <div id="studyplannertab-add" class="nv-tab-panel">
          <div class="nv-card">
            <h3 style="font-size:1rem;margin-bottom:14px;font-family:'Syne',sans-serif;">Schedule Study Session</h3>
            <div class="nv-form-group"><label>Subject</label>
              <select class="nv-input" id="nvSessSubj">
                <option>Pharmacology</option><option>Anatomy &amp; Physiology</option><option>Medical-Surgical</option>
                <option>Mental Health</option><option>Pediatric Nursing</option><option>Community Nursing</option><option>Pathophysiology</option>
              </select>
            </div>
            <div class="nv-input-row">
              <div class="nv-form-group" style="flex:1;margin-bottom:0;"><label>Day</label>
                <select class="nv-input" id="nvSessDay"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option></select>
              </div>
              <div class="nv-form-group" style="flex:1;margin-bottom:0;"><label>Time</label><input type="time" class="nv-input" id="nvSessTime" value="08:00"></div>
            </div>
            <div class="nv-form-group nv-mt-12"><label>Duration</label>
              <select class="nv-input" id="nvSessDur"><option value="30">30 min</option><option value="60" selected>1 hour</option><option value="90">1.5 hours</option><option value="120">2 hours</option></select>
            </div>
            <button class="nv-btn nv-btn-primary nv-btn-full" onclick="nvAddSession()">Add to Schedule</button>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SKILLS CHECKLIST VIEW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="viewSkillscheck" class="view nv-view" style="display:none">
      <div class="topbar">
        <div class="topbar-title">âœ… Clinical Skills</div>
        <div class="search-box"><span class="si">ðŸ”</span><input class="search-inp" placeholder="Search skillsâ€¦" oninput="nvFilterSkills(this.value)"></div>
        <button class="btn-action admin-el" onclick="openAddSkillModal()" style="white-space:nowrap;">ï¼‹ Add Skill</button>
      </div>
      <div class="content">
        <p class="nv-text-sm nv-text-dim" style="margin-bottom:14px;margin-top:4px;">Tap a skill to expand. Check each step as you complete it.</p>
        <div id="nvSkillsList"></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         DICTIONARY VIEW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="viewDictionary" class="view nv-view" style="display:none">
      <div class="topbar"><div class="topbar-title">ðŸ” Med Dictionary</div></div>
      
<div class="content">
        <div class="nv-card" style="margin-top:4px;">
          <div style="display:flex;gap:10px;margin-bottom:0;">
            <input type="text" class="nv-input" id="nvDictSearch" placeholder="Search term (e.g. Tachycardia)â€¦" onkeydown="if(event.key==='Enter')nvSearchDict()" style="margin-bottom:0;">
            <button class="nv-btn nv-btn-primary" style="white-space:nowrap;flex-shrink:0;" onclick="nvSearchDict()">Search</button>
          </div>
        </div>
        <div id="nvDictResults"><div class="nv-empty"><div class="nv-empty-icon">ðŸŒ</div><div class="nv-empty-text">Enter a medical term to get an AI-powered clinical definition.</div></div></div>
        <div class="nv-card nv-mt-16">
          <div class="nv-text-xs nv-text-dim nv-fw-700" style="text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Quick Terms</div>
          <div class="nv-chips">
            <span class="nv-chip" onclick="nvQuickSearch('Tachycardia')">Tachycardia</span>
            <span class="nv-chip" onclick="nvQuickSearch('Bradycardia')">Bradycardia</span>
            <span class="nv-chip" onclick="nvQuickSearch('Hypoxia')">Hypoxia</span>
            <span class="nv-chip" onclick="nvQuickSearch('Sepsis')">Sepsis</span>
            <span class="nv-chip" onclick="nvQuickSearch('Hypertension')">Hypertension</span>
            <span class="nv-chip" onclick="nvQuickSearch('Dyspnea')">Dyspnea</span>
            <span class="nv-chip" onclick="nvQuickSearch('Edema')">Edema</span>
            <span class="nv-chip" onclick="nvQuickSearch('Anemia')">Anemia</span>
            <span class="nv-chip" onclick="nvQuickSearch('Arrhythmia')">Arrhythmia</span>
            <span class="nv-chip" onclick="nvQuickSearch('DKA')">DKA</span>
            <span class="nv-chip" onclick="nvQuickSearch('Pneumonia')">Pneumonia</span>
            <span class="nv-chip" onclick="nvQuickSearch('Pulmonary Embolism')">Pulmonary Embolism</span>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         GPA CALCULATOR VIEW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="viewGpacalc" class="view nv-view" style="display:none">
      <div class="topbar"><div class="topbar-title">âš–ï¸ GPA Calculator</div></div>
      <div class="content">
        <div id="nvGpaDisplayCard" class="nv-card" style="display:none;margin-bottom:14px;margin-top:4px;text-align:center;padding:20px;">
          <div class="nv-text-xs nv-text-dim nv-fw-700" style="text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Cumulative GPA</div>
          <div style="font-size:3rem;font-weight:800;color:var(--nv-accent);" id="nvGpaVal">0.00</div>
          <div style="font-size:14px;font-weight:600;margin-top:4px;" id="nvGpaClass">â€”</div>
          <div class="nv-progress-bar" style="margin-top:12px;height:6px;"><div class="nv-progress-fill" id="nvGpaBar" style="width:0%;"></div></div>
        </div>
        <div id="nvGpaActions" style="display:none;margin-bottom:12px;">
          <button class="nv-btn nv-btn-secondary nv-btn-sm" onclick="nvClearCourses()">ðŸ—‘ Clear All</button>
        </div>
        <div id="nvCourseList"></div>
        <div id="nvGpaEmpty" class="nv-empty"><div class="nv-empty-icon">âš–ï¸</div><div class="nv-empty-text">Add courses below to calculate your GPA.</div></div>
        <div class="nv-card nv-mt-16">
          <h3 style="font-size:1rem;margin-bottom:14px;font-family:'Syne',sans-serif;">Add Course</h3>
          <div class="nv-form-group"><label>Course Name</label><input type="text" class="nv-input" id="nvGpaCourse" placeholder="e.g. Pharmacology II"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="nv-form-group" style="margin-bottom:0;"><label>Credit Units</label><input type="number" class="nv-input" id="nvGpaUnits" placeholder="e.g. 3" min="1"></div>
            <div class="nv-form-group" style="margin-bottom:0;"><label>Score (%)</label><input type="number" class="nv-input" id="nvGpaScore" placeholder="e.g. 75" min="0" max="100"></div>
          </div>
          <button class="nv-btn nv-btn-primary nv-btn-full nv-mt-12" onclick="nvAddCourse()">Add Course</button>
        </div>
        <div class="nv-card nv-mt-12" style="font-size:11px;color:var(--nv-text-dim);line-height:1.7;">
          <strong style="color:var(--nv-text);">Grading Scale:</strong> A (70â€“100%) = 5.0 Â· B (60â€“69%) = 4.0 Â· C (50â€“59%) = 3.0 Â· D (45â€“49%) = 2.0 Â· E (40â€“44%) = 1.0 Â· F (&lt;40%) = 0.0
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         STUDY DASHBOARD VIEW
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="viewStudydash" class="view nv-view" style="display:none">
      <div class="topbar"><div class="topbar-title">ðŸ“Š Study Progress</div></div>
      
<div class="content">
        <div class="nv-card nv-card-glow" style="text-align:center;padding:22px;margin-top:4px;">
          <div style="font-size:40px;" id="nvDashStreakIcon">ðŸ”¥</div>
          <div class="nv-fw-700" style="font-size:2.5rem;color:var(--nv-accent-warm);font-family:'Syne',sans-serif;" id="nvDashStreak">0</div>
          <div class="nv-text-xs nv-text-dim" style="text-transform:uppercase;letter-spacing:1px;">Day Study Streak</div>
        </div>
        <div class="nv-dash-grid">
          <div class="nv-dash-tile"><div class="nv-dash-tile-val nv-text-accent" id="nvDashCardsReviewed">0</div><div class="nv-dash-tile-label">Cards Reviewed</div></div>
          <div class="nv-dash-tile"><div class="nv-dash-tile-val" style="color:var(--nv-accent-3);" id="nvDashQuizAvg">â€”</div><div class="nv-dash-tile-label">Quiz Avg</div></div>
          <div class="nv-dash-tile"><div class="nv-dash-tile-val" style="color:var(--nv-accent-2);" id="nvDashNotesCount">0</div><div class="nv-dash-tile-label">Notes</div></div>
          <div class="nv-dash-tile"><div class="nv-dash-tile-val" style="color:var(--nv-accent-warm);" id="nvDashSessions">0</div><div class="nv-dash-tile-label">Sessions Done</div></div>
        </div>
        <div class="nv-card">
          <div class="nv-text-xs nv-text-dim nv-fw-700" style="text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Study Activity (Past 7 Days)</div>
          <div style="display:flex;align-items:flex-end;gap:4px;height:60px;margin:14px 0 6px;" id="nvDashActivityBars"></div>
          <div style="display:flex;gap:4px;" id="nvDashDayLabels"></div>
        </div>
        <div class="nv-card nv-mb-0">
          <div class="nv-text-xs nv-text-dim nv-fw-700" style="text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;">Recent Quiz Scores</div>
          <div id="nvDashQuizHistory"></div>
          <div id="nvDashQuizEmpty" class="nv-empty" style="padding:20px 0;"><div class="nv-empty-text">Complete quizzes in Past Questions to see your history here.</div></div>
        </div>
      </div>
    </div>
    </div>

  </div><!-- /.main -->
</div><!-- /.app -->


<!-- â”€â”€ ADD SKILL MODAL (Admin) â€” Smart Paste Parser â”€â”€ -->
<div class="overlay" id="addSkillModal">
  <div class="modal" style="max-width:620px;max-height:94vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">âœ… Paste Skill Checklist</div>
      <button class="modal-x" onclick="closeModal('addSkillModal')">âœ•</button>
    </div>
    <div class="modal-bd">

      <!-- Info banner -->
      <div style="background:rgba(62,142,149,.1);border:1px solid rgba(62,142,149,.25);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:12px;color:var(--text2);line-height:1.7;">
        <strong style="color:var(--accent);">ðŸ¤– Smart Auto-Parse</strong> â€” paste any format. The system will detect skill names and steps automatically. You can paste <strong>multiple skills at once</strong>.
      </div>

      <!-- Format examples toggle -->
      <details style="margin-bottom:14px;">
        <summary style="font-size:11px;font-family:'DM Mono',monospace;color:var(--text3);cursor:pointer;user-select:none;letter-spacing:.05em;">ðŸ“– Accepted formats (click to expand)</summary>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-top:8px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;line-height:1.9;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div><strong style="color:var(--text2);">Numbered heading + steps</strong><br>
            21. Subcutaneous Injection<br>
            1. Verify medication order<br>
            2. Perform hand hygiene<br>
            3. Select injection site
          </div>
          <div><strong style="color:var(--text2);">Bold/ALL-CAPS title + bullets</strong><br>
            IV CANNULATION<br>
            â€¢ Gather equipment<br>
            â€¢ Perform hand hygiene<br>
            â€¢ Apply tourniquet
          </div>
          <div><strong style="color:var(--text2);">Multiple skills (blank line gap)</strong><br>
            Nasogastric Tube Insertion<br>
            1. Explain to patient<br>
            2. Measure tube length<br><br>
            Urinary Catheterisation<br>
            1. Prepare sterile field<br>
            2. Clean meatus
          </div>
          <div><strong style="color:var(--text2);">Colon-separated or plain list</strong><br>
            Blood Glucose Monitoring:<br>
            - Check patient ID<br>
            - Clean fingertip<br>
            - Prick finger
          </div>
        </div>
      </details>

      <!-- Paste area -->
      <div class="form-g">
        <label class="inp-label" style="display:flex;align-items:center;justify-content:space-between;">
          <span>Paste Checklist Text</span>
          <span id="nvSkillCharCount" style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">0 chars</span>
        </label>
        <textarea class="inp" id="addSkillPaste" rows="14"
          placeholder="Paste your skill checklist here â€” any format worksâ€¦"
          oninput="nvSmartSkillPreview()"
          style="font-family:'DM Mono',monospace;font-size:12px;resize:vertical;line-height:1.7;"></textarea>
      </div>

      <!-- Parse status bar -->
      <div id="nvSkillParseStatus" style="display:none;margin-bottom:12px;padding:8px 12px;border-radius:8px;font-size:12px;font-family:'DM Mono',monospace;"></div>

      <!-- Live preview of parsed skills -->
      <div id="nvSkillParsePreview" style="display:none;">
        <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px;">
          ðŸ“‹ Parsed Preview â€” <span id="nvSkillParsedCount">0</span> skill(s) Â· <span id="nvSkillParsedSteps">0</span> total steps
        </div>
        <div id="nvSkillPreviewCards" style="display:flex;flex-direction:column;gap:10px;max-height:300px;overflow-y:auto;padding-right:4px;"></div>
      </div>

      <!-- Actions -->
      <div style="display:flex;gap:10px;margin-top:18px;">
        <button class="btn-cancel" onclick="closeModal('addSkillModal')" style="flex:1;">Cancel</button>
        <button class="btn-submit" id="nvSkillSaveBtn" onclick="nvSaveSmartSkills()" style="flex:2;opacity:.5;pointer-events:none;">ï¼‹ Add Parsed Skills</button>
      </div>
    </div>
  </div>
</div>


<!-- â”€â”€ ADD LAB REFERENCE MODAL (Admin) â”€â”€ -->
<div class="overlay" id="addLabModal">
  <div class="modal" style="max-width:560px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ§ª Add Lab Reference Values</div>
      <button class="modal-x" onclick="closeModal('addLabModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <p style="font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.6;">Add a custom lab section. Each row should have the test name and its normal range separated by a pipe <code style="background:var(--bg3);padding:1px 5px;border-radius:4px;">|</code></p>
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;line-height:1.8;">
        <strong style="color:var(--text2);">Format:</strong><br>
        Thyroid Function Tests<br>
        TSH | 0.4 â€“ 4.0 mIU/L<br>
        Free T4 | 9 â€“ 24 pmol/L<br>
        Free T3 | 3.5 â€“ 7.8 pmol/L
      </div>
      <div class="form-g">
        <label class="inp-label">Add to Tab</label>
        <select class="inp" id="addLabTab">
          <option value="labs">Lab Values</option>
          <option value="vitals">Vital Signs</option>
          <option value="scales">Scales</option>
          <option value="abg">ABGs</option>
        </select>
      </div>
      <div class="form-g">
        <label class="inp-label">Section Title</label>
        <input class="inp" id="addLabTitle" placeholder="e.g. Thyroid Function Tests" style="margin-bottom:10px;">
      </div>
      <div class="form-g">
        <label class="inp-label">Lab Rows (Test | Normal Range)</label>
        <textarea class="inp" id="addLabPaste" rows="10" placeholder="TSH | 0.4 â€“ 4.0 mIU/L&#10;Free T4 | 9 â€“ 24 pmol/L&#10;Free T3 | 3.5 â€“ 7.8 pmol/L" oninput="previewLabParse()" style="font-family:'DM Mono',monospace;font-size:12px;resize:vertical;"></textarea>
      </div>
      <div id="labParsePreview" style="display:none;margin-top:10px;">
        <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px;">ðŸ”¬ Preview (<span id="labRowCount">0</span> rows)</div>
        <div id="labParsePreviewContent" style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:12px;line-height:1.8;max-height:200px;overflow-y:auto;"></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button class="btn-cancel" onclick="closeModal('addLabModal')" style="flex:1;">Cancel</button>
        <button class="btn-submit" onclick="saveNewLab()" style="flex:2;">ï¼‹ Add Lab Values</button>
      </div>
    </div>
  </div>
</div>



  </div>
</div>

<!-- OTHER CLASS PANEL MODAL -->
<div class="overlay" id="otherClassModal">
  <div class="modal" style="max-width:440px;max-height:86vh;display:flex;flex-direction:column;overflow:hidden;">
    <div class="modal-hd" style="flex-shrink:0;">
      <div class="modal-ht">ðŸ“¨ Message Another Class</div>
      <button class="modal-x" onclick="closeModal('otherClassModal')">âœ•</button>
    </div>
    <div style="flex:1;overflow-y:auto;padding:16px;">
      <!-- Class selector tabs -->
      <div style="margin-bottom:12px;">
        <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;font-weight:600;margin-bottom:8px;">Select a Class</div>
        <div id="otherClassTabs" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>
      <!-- Search within selected class -->
      <div style="margin-bottom:10px;">
        <input class="inp" id="otherClassSearch" placeholder="Search by name or matricâ€¦" oninput="filterOtherClassList(this.value)" style="margin:0;">
      </div>
      <div id="otherClassResultCount" style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:6px;padding:0 2px;"></div>
      <div id="otherClassStudentList" class="msg-recipient-list"></div>
    </div>
  </div>
</div>

<!-- NEW CHAT MODAL -->
<div class="overlay" id="newChatModal">
  <div class="modal" style="max-width:440px;max-height:86vh;display:flex;flex-direction:column;overflow:hidden;">
    <div class="modal-hd" style="flex-shrink:0;">
      <div class="modal-ht">ðŸ’¬ New Message</div>
      <button class="modal-x" onclick="closeModal('newChatModal')">âœ•</button>
    </div>
    <div class="new-chat-modal-body" style="flex:1;overflow-y:auto;padding:16px;">

      <!-- Channels section (admin/teacher only) -->
      <div id="newChatGroupSection" style="display:none">
        <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:8px;text-transform:uppercase;letter-spacing:.1em;font-weight:600;">ðŸ“£ Broadcast Channels</div>
        <div id="newChatGroupList" class="msg-recipient-list" style="margin-bottom:14px;"></div>
        <div style="border-top:1px solid var(--border);padding-top:14px;margin-bottom:10px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;font-weight:600;">ðŸ‘¤ Direct Message</div>
      </div>

      <!-- Class filter â€” always visible when sending DMs -->
      <div id="newChatClassFilterWrap" style="margin-bottom:12px;">
        <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;font-weight:600;margin-bottom:8px;">ðŸŽ“ Select Class</div>
        <div style="position:relative;">
          <select id="newChatClassFilter" onchange="applyNewChatFilters()" style="width:100%;background:var(--bg3);border:1.5px solid var(--accent);border-radius:10px;padding:11px 40px 11px 14px;color:var(--text);font-family:'Instrument Sans',sans-serif;font-size:14px;outline:none;cursor:pointer;appearance:none;-webkit-appearance:none;transition:border-color .2s;">
            <option value="">â€” All Classes â€”</option>
          </select>
          <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--accent);font-size:18px;line-height:1;">â–¾</div>
        </div>
      </div>

      <!-- Search -->
      <div style="margin-bottom:10px;">
        <input class="inp" id="newChatSearch" placeholder="Search by name or matric numberâ€¦" oninput="applyNewChatFilters()" style="margin:0;">
      </div>

      <!-- Results count -->
      <div id="newChatResultCount" style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:6px;padding:0 2px;"></div>

      <!-- Recipient list -->
      <div id="newChatDmList" class="msg-recipient-list"></div>
    </div>
  </div>
</div>

<!-- ===== MODALS ===== -->

<!-- ===== MY PROFILE MODAL ===== -->
<div class="overlay" id="myProfileModal">
  <div class="modal" style="max-width:460px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ‘¤ My Profile</div>
      <button class="modal-x" onclick="closeModal('myProfileModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <!-- Avatar -->
      <div class="profile-modal-av-wrap" onclick="document.getElementById('myAvatarFile').click()" title="Click to change photo">
        <div class="profile-modal-av" id="myProfileAv">A</div>
        <div class="profile-av-edit-badge">ðŸ“·</div>
      </div>
      <input type="file" id="myAvatarFile" accept="image/*" style="display:none" onchange="handleAvatarUpload(this,'me')">
      <div style="text-align:center;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:16px;">Click photo to change</div>

      <div class="profile-section-title">Personal Information</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;grid-column:1/-1;">
          <label class="inp-label">Full Name</label>
          <input class="inp" id="myProfileName" placeholder="Your full name" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Phone Number</label>
          <input class="inp" id="myProfilePhone" placeholder="e.g. 08012345678" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;" id="myMatricWrap">
          <label class="inp-label">Matric Number</label>
          <input class="inp" id="myProfileMatric" placeholder="e.g. NSG/23/001" style="margin:0;">
        </div>
      </div>

      <div class="profile-section-title">Account</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Username</label>
          <input class="inp" id="myProfileUsername" style="margin:0;opacity:.6;" readonly>
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Role</label>
          <div style="padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;" id="myProfileRoleBadge"></div>
        </div>
      </div>

      <div class="profile-section-title">Change Password</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;">
          <label class="inp-label">New Password</label>
          <input class="inp" id="myProfileNewPass" type="password" placeholder="Leave blank to keep current" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Confirm Password</label>
          <input class="inp" id="myProfileConfPass" type="password" placeholder="Repeat new password" style="margin:0;">
        </div>
      </div>

      <!-- PROFESSIONAL IDs -->
      <div class="profile-section-title" id="myProfIdSection">ðŸ¥ Professional Numbers</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;" id="myProfIdFields">
        <div class="form-g" style="margin:0;grid-column:1/-1;">
          <label class="inp-label">BIA Number <span style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">(Biomedical Institution Accreditation)</span></label>
          <input class="inp" id="myProfileBIA" placeholder="e.g. BIA/2024/001" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RN Indexing Number</label>
          <input class="inp" id="myProfileRNIndex" placeholder="e.g. NRN/IDX/001" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RM Indexing Number</label>
          <input class="inp" id="myProfileRMIndex" placeholder="e.g. NRM/IDX/001" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RN Exam Number</label>
          <input class="inp" id="myProfileRNExam" placeholder="e.g. RN/EXAM/2024/001" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RM Exam Number</label>
          <input class="inp" id="myProfileRMExam" placeholder="e.g. RM/EXAM/2024/001" style="margin:0;">
        </div>
      </div>

      <!-- DOCUMENT VAULT -->
      <div class="profile-section-title" id="myDocVaultSection">ðŸ“ My Document Vault</div>
      <div id="myDocVaultList" class="doc-vault-list"></div>
      <div class="doc-upload-zone" id="myDocUploadZone" onclick="document.getElementById('myDocFileInp').click()" ondragover="docDragOver(event,'myDocUploadZone')" ondragleave="docDragLeave(event,'myDocUploadZone')" ondrop="docDrop(event,'me')">
        <div class="doc-upload-zone-icon">ðŸ“¤</div>
        <div class="doc-upload-zone-text">Click or drag files to upload</div>
        <div class="doc-upload-zone-sub">PDF, DOCX, images, spreadsheets â€” up to 10 MB each</div>
      </div>
      <input type="file" id="myDocFileInp" multiple style="display:none" onchange="handleDocUpload(this,'me')">

      <button class="btn-submit" onclick="saveMyProfile()" style="margin-top:20px;background:linear-gradient(135deg,var(--accent2),var(--accent));">ðŸ’¾ Save Profile â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€ NOMINAL ROLL IMPORT MODAL â”€â”€ -->
<div class="overlay" id="nominalRollModal">
  <div class="modal" style="max-width:560px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“‹ Import Nominal Roll</div>
      <button class="modal-x" onclick="closeModal('nominalRollModal')">âœ•</button>
    </div>
    <div class="modal-bd">

      <!-- Upload zone -->
      <div id="nominalDropZone" style="border:2px dashed var(--border);border-radius:12px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg2);"
           onclick="document.getElementById('nominalFileInp').click()"
           ondragover="event.preventDefault();this.style.borderColor='var(--accent2)';this.style.background='rgba(90,173,160,.08)'"
           ondragleave="this.style.borderColor='var(--border)';this.style.background='var(--bg2)'"
           ondrop="nominalHandleDrop(event)">
        <div style="font-size:40px;margin-bottom:10px;">ðŸ“Š</div>
        <div style="font-size:14px;font-weight:600;color:var(--text);">Drop any spreadsheet here or click to browse</div>
        <div style="font-size:11px;color:var(--text3);margin-top:6px;font-family:'DM Mono',monospace;">.xlsx Â· .xls Â· .csv Â· .doc Â· .docx â€” any column layout, auto-detected</div>
      </div>
      <input type="file" id="nominalFileInp" accept=".xlsx,.xls,.csv,.doc,.docx" style="display:none" onchange="nominalHandleFile(this.files[0])">

      <!-- Column mapping feedback -->
      <div id="nominalMappingInfo" style="display:none;margin-top:14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;">
        <div style="font-size:11px;font-weight:700;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px;">ðŸ” Detected Columns</div>
        <div id="nominalMappingTags" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
      </div>

      <!-- Preview table -->
      <div id="nominalPreview" style="display:none;margin-top:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
          <div id="nominalPreviewTitle" style="font-size:13px;font-weight:600;color:var(--text);">Preview</div>
          <select class="sel" id="nominalClassSelect" style="font-size:12px;padding:6px 10px;max-width:200px;">
            <option value="">â€” Override Class (optional) â€”</option>
          </select>
        </div>
        <div style="overflow-x:auto;max-height:280px;overflow-y:auto;border-radius:10px;border:1px solid var(--border);">
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead id="nominalPreviewHead" style="position:sticky;top:0;background:var(--bg3);z-index:1;"></thead>
            <tbody id="nominalPreviewBody"></tbody>
          </table>
        </div>
        <div style="margin-top:6px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">
          Surname column used for username &amp; password (e.g. IBRAHIM â†’ username: ibrahim123, password: ibrahim123123)
        </div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn-submit" onclick="nominalImportConfirm()" style="background:linear-gradient(135deg,var(--accent3),#3E8E95);flex:1;min-width:160px;">âœ… Import & Create Accounts</button>
          <button class="btn-ghost" onclick="nominalReset()" style="flex:1;min-width:120px;">ðŸ”„ Upload Different File</button>
        </div>
      </div>

      <div id="nominalImportResult" style="display:none;margin-top:16px;padding:14px;border-radius:10px;"></div>
    </div>
  </div>
</div>

<!-- Document Preview Modal -->
<div class="doc-preview-modal" id="docPreviewModal">
  <div class="doc-preview-inner">
    <div class="doc-preview-header">
      <span id="docPreviewTitle" class="doc-preview-title">Document</span>
      <div class="doc-preview-actions">
        <button class="doc-vault-btn" onclick="printDocPreview()" style="color:var(--accent3);border-color:rgba(90,173,160,.3);">ðŸ–¨ Print</button>
        <button class="doc-vault-btn" onclick="downloadDocPreview()">â¬‡ Download</button>
        <button class="doc-vault-btn danger" onclick="closeDocPreview()">âœ• Close</button>
      </div>
    </div>
    <div class="doc-preview-body" id="docPreviewBody"></div>
  </div>
</div>

<!-- ===== EDIT USER MODAL (admin only) ===== -->
<div class="overlay" id="editUserModal">
  <div class="modal" style="max-width:480px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">âœï¸ Edit User Profile</div>
      <button class="modal-x" onclick="closeModal('editUserModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <input type="hidden" id="editUserId">

      <!-- Avatar -->
      <div class="profile-modal-av-wrap" onclick="document.getElementById('editAvatarFile').click()" title="Click to change photo">
        <div class="profile-modal-av" id="editUserAv">A</div>
        <div class="profile-av-edit-badge">ðŸ“·</div>
      </div>
      <input type="file" id="editAvatarFile" accept="image/*" style="display:none" onchange="handleAvatarUpload(this,'edit')">
      <div style="text-align:center;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:16px;">Click photo to change</div>

      <div class="profile-section-title">Personal Information</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;grid-column:1/-1;">
          <label class="inp-label">Full Name</label>
          <input class="inp" id="editUserName" placeholder="Full name" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Phone Number</label>
          <input class="inp" id="editUserPhone" placeholder="e.g. 08012345678" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Date of Birth</label>
          <input class="inp" id="editUserDob" placeholder="e.g. 01/01/2000" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Sex</label>
          <select class="sel" id="editUserSex" style="margin:0;">
            <option value="">â€” Select â€”</option>
            <option value="Female">Female</option>
            <option value="Male">Male</option>
          </select>
        </div>
        <div class="form-g" style="margin:0;" id="editMatricWrap">
          <label class="inp-label">Matric Number</label>
          <input class="inp" id="editUserMatric" placeholder="e.g. NACON/ND/HND/SET50/001" style="margin:0;">
        </div>
      </div>

      <div class="profile-section-title">Military / College Records</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;">
          <label class="inp-label">SVC Number</label>
          <input class="inp" id="editUserSvc" placeholder="e.g. 19NA/78/0526F" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Rank</label>
          <input class="inp" id="editUserRank" placeholder="e.g. LCPL, SN, PTE" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">BIA Number</label>
          <input class="inp" id="editUserBia" placeholder="e.g. BIA130820251739" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RRR Number</label>
          <input class="inp" id="editUserRrr" placeholder="e.g. 351303118414" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RN Index</label>
          <input class="inp" id="editUserRnIndex" placeholder="RN Index No." style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">RM Index</label>
          <input class="inp" id="editUserRmIndex" placeholder="RM Index No." style="margin:0;">
        </div>
      </div>

      <div class="profile-section-title">Account</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Username</label>
          <input class="inp" id="editUserUsername" style="margin:0;">
        </div>
        <div class="form-g" style="margin:0;">
          <label class="inp-label">Class</label>
          <select class="sel" id="editUserClass" style="margin:0;"></select>
        </div>
      </div>

      <div class="profile-section-title">Reset Password (optional)</div>
      <div class="form-g" style="margin:0;">
        <label class="inp-label">New Password</label>
        <input class="inp" id="editUserPass" type="password" placeholder="Leave blank to keep current" style="margin:0;">
      </div>

      <div style="display:flex;gap:10px;margin-top:20px;">
        <button class="btn-submit" onclick="saveEditUser()" style="flex:1;background:linear-gradient(135deg,var(--accent2),var(--accent));">ðŸ’¾ Save Changes â†’</button>
        <button class="btn-ghost" onclick="confirmDeleteUser()" style="color:var(--accent4);border-color:rgba(224,123,123,.3);">ðŸ—‘ Remove</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Class -->
<div class="overlay" id="addClassModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Add New Class</div><button class="modal-x" onclick="closeModal('addClassModal')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-g"><label class="inp-label">Class Name</label><input class="inp" id="newClassName" placeholder="e.g. ND THREE"></div>
      <div class="form-g"><label class="inp-label">Full Name</label><input class="inp" id="newClassFull" placeholder="e.g. National Diploma Year Three"></div>
      <div class="form-g"><label class="inp-label">Color</label>
        <select class="sel" id="newClassColor">
          <option value="blue">Blue</option><option value="purple">Purple</option>
          <option value="green">Green</option><option value="red">Red</option>
          <option value="yellow">Yellow</option><option value="pink">Pink</option>
          <option value="orange">Orange</option><option value="teal">Teal</option>
        </select>
      </div>
      <button class="btn-submit" onclick="addClass()">Create Class â†’</button>
    </div>
  </div>
</div>

<!-- Add Course -->
<div class="overlay" id="addCourseModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Add Course</div><button class="modal-x" onclick="closeModal('addCourseModal')">âœ•</button></div>
    <div class="modal-bd">
      <div class="form-g"><label class="inp-label">Course Title</label><input class="inp" id="newCourseTitle" placeholder="e.g. Anatomy and Physiology I"></div>
      <div class="form-g"><label class="inp-label">Course Code</label><input class="inp" id="newCourseCode" placeholder="e.g. NSG 101"></div>
      <div class="form-g"><label class="inp-label">Lecturer</label><input class="inp" id="newCourseLecturer" placeholder="e.g. Dr. Adaora Obi"></div>
      <div class="form-g"><label class="inp-label">Class</label><select class="sel" id="newCourseClass"></select></div>
      <button class="btn-submit" onclick="addCourse()">Add Course â†’</button>
    </div>
  </div>
</div>

<!-- Add Handout -->
<div class="overlay" id="addHandoutModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht" id="addHandoutModalTitle">Add Note / File</div><button class="modal-x" onclick="closeModal('addHandoutModal')">âœ•</button></div>
    <div class="modal-bd">
      <div id="addHandoutFolderBanner" style="display:none;background:rgba(90,173,160,.1);border:1px solid rgba(90,173,160,.25);border-radius:9px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:var(--accent2);font-family:'DM Mono',monospace;display:flex;align-items:center;gap:8px;">
        <span style="font-size:16px;">ðŸ“</span>
        <span id="addHandoutFolderBannerText">Uploading to folder</span>
      </div>
      <div class="drop-area" id="handoutDrop" onclick="document.getElementById('handoutFile').click()">
        <div class="drop-ico" id="dropIco">ðŸ“</div>
        <div class="drop-txt" id="dropTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
        <div class="drop-fmts">PDF Â· DOC Â· DOCX Â· PPT Â· PPTX Â· PNG Â· JPG</div>
      </div>
      <input type="file" id="handoutFile" style="display:none" accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp" onchange="handoutFileChosen(this)">
      <div class="form-g"><label class="inp-label">Title</label><input class="inp" id="newHandoutTitle" placeholder="e.g. Week 3 Lecture Notes"></div>
      <div class="form-g" id="addHandoutCourseRow"><label class="inp-label">Course</label><select class="sel" id="newHandoutCourse"></select></div>
      <div class="form-g"><label class="inp-label">File Type</label>
        <select class="sel" id="newHandoutType">
          <option value="pdf">PDF</option><option value="doc">DOC/DOCX</option>
          <option value="ppt">PPT/PPTX</option><option value="img">Image</option>
        </select>
      </div>
      <button class="btn-submit-green" onclick="addHandout()">Upload â†’</button>
    </div>
  </div>
</div>

<!-- Upload Modal (sidebar) -->
<div class="overlay" id="uploadModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Upload Handout</div><button class="modal-x" onclick="closeModal('uploadModal')">âœ•</button></div>
    <div class="modal-bd">
      <div class="drop-area" onclick="document.getElementById('uploadFile').click()">
        <div class="drop-ico" id="uploadDropIco">ðŸ“</div>
        <div class="drop-txt" id="uploadDropTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
        <div class="drop-fmts">PDF Â· DOC Â· DOCX Â· PPT Â· PPTX Â· PNG Â· JPG</div>
      </div>
      <input type="file" id="uploadFile" style="display:none" accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp" onchange="uploadFileChosen(this)">
      <div class="form-g"><label class="inp-label">Title</label><input class="inp" id="uploadTitle" placeholder="e.g. Pharmacology Week 5 Notes"></div>
      <div class="form-g"><label class="inp-label">Class</label><select class="sel" id="uploadClass" onchange="filterUploadCourses()"></select></div>
      <div class="form-g"><label class="inp-label">Course</label><select class="sel" id="uploadCourse"></select></div>
      <div class="form-g"><label class="inp-label">File Type</label>
        <select class="sel" id="uploadType">
          <option value="pdf">PDF</option><option value="doc">DOC/DOCX</option>
          <option value="ppt">PPT/PPTX</option><option value="img">Image</option>
        </select>
      </div>
      <button class="btn-submit" onclick="submitUpload()">Upload â†’</button>
    </div>
  </div>
</div>

<!-- ===== SPREADSHEET IMPORT MODAL (admin only) ===== -->
<div class="overlay" id="ssImportModal">
  <div class="modal" style="max-width:760px;max-height:93vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“Š Upload Results Spreadsheet</div>
      <button class="modal-x" onclick="closeModal('ssImportModal')">âœ•</button>
    </div>
    <div class="modal-bd">

      <!-- Info banner -->
      <div style="background:rgba(62,142,149,.07);border:1px solid rgba(62,142,149,.2);border-radius:10px;padding:12px 16px;font-size:11.5px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:18px;line-height:2;">
        ðŸ“Œ Upload an <strong>.xlsx</strong> or <strong>.csv</strong> file with student results.<br>
        Required column: <code>Score</code> â€” Recommended: <code>Matric No.</code> &nbsp;Â·&nbsp; <code>Name</code> &nbsp;Â·&nbsp; <code>Total</code> &nbsp;Â·&nbsp; <code>Remarks</code><br>
        The system will <strong>auto-match each row to a student</strong> using their matric number. Unmatched rows are saved as unlinked and can still be seen by the student once their matric is updated.
      </div>

      <!-- Meta fields -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:18px;">
        <div class="form-g" style="margin:0">
          <label class="inp-label">Result Type</label>
          <select class="sel" id="ssType">
            <option value="test">Test / CA</option>
            <option value="exam">Exam</option>
          </select>
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Title / Description</label>
          <input class="inp" id="ssTitle" placeholder="e.g. Mid-Term Test 1 â€” 2024" style="margin:0">
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Class</label>
          <select class="sel" id="ssClass" onchange="ssFilterCourses()"></select>
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Course</label>
          <select class="sel" id="ssCourse"></select>
        </div>
      </div>

      <!-- Drop zone -->
      <div id="ssDropZone" onclick="document.getElementById('ssFileInput').click()"
           ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
           ondragleave="this.style.borderColor=''"
           ondrop="event.preventDefault();this.style.borderColor='';document.getElementById('ssFileInput').files=event.dataTransfer.files;ssFileChosen(document.getElementById('ssFileInput'))"
           style="border:2px dashed var(--border);border-radius:14px;padding:28px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;margin-bottom:14px;">
        <div style="font-size:32px;margin-bottom:8px;" id="ssDropIco">ðŸ“Š</div>
        <div style="font-size:14px;font-weight:600;color:var(--text);" id="ssDropTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px;font-family:'DM Mono',monospace;">.xlsx &nbsp;Â·&nbsp; .xls &nbsp;Â·&nbsp; .csv</div>
      </div>
      <input type="file" id="ssFileInput" style="display:none" accept=".xlsx,.xls,.csv" onchange="ssFileChosen(this)">

      <!-- Status line -->
      <div id="ssStatus" style="display:none;font-size:12px;font-family:'DM Mono',monospace;padding:8px 12px;border-radius:8px;background:var(--bg3);margin-bottom:14px;"></div>

      <!-- Preview -->
      <div id="ssPreviewWrap" style="display:none;">
        <div class="parse-preview">
          <div class="parse-preview-hd">
            <span id="ssPreviewCount"></span>
            <span id="ssPreviewErrors" style="color:var(--accent4);"></span>
          </div>
          <!-- Column headers -->
          <div class="parse-row" style="background:var(--bg3);padding:6px 14px;grid-template-columns:22px 110px 1fr 70px 60px 80px 24px;">
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">âœ“</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">MATRIC NO.</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">STUDENT NAME</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">SCORE</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">GRADE</span>
            <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">MATCH</span>
            <span></span>
          </div>
          <div id="ssPreviewBody"></div>
        </div>

        <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;">
            <span style="color:var(--accent3);">âœ“ matched</span> = student found by matric &nbsp;Â·&nbsp;
            <span style="color:#fbbf24;">âš  unlinked</span> = matric not in system yet
          </div>
          <button class="btn-submit" id="ssImportBtn" onclick="ssImportAll()" style="width:auto;padding:11px 28px;background:linear-gradient(135deg,var(--accent2),var(--accent));" disabled>
            âœ“ Import <span id="ssImportBtnCount">0</span> Results â†’
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Paste Import Modal (Admin only) -->
<div class="overlay" id="pasteImportModal">
  <div class="modal" style="max-width:720px;max-height:92vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“‹ Paste Import Results</div>
      <button class="modal-x" onclick="closeModal('pasteImportModal')">âœ•</button>
    </div>
    <div class="modal-bd">

      <!-- Step 1: Settings -->
      <div id="pasteStep1">
        <div style="background:rgba(62,142,149,.07);border:1px solid rgba(62,142,149,.2);border-radius:10px;padding:11px 14px;font-size:11px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:16px;line-height:1.8;">
          â„¹ï¸ Paste a list of results copied from Excel, Google Sheets, or any table.<br>
          Each row = one student. Columns auto-detected from: <strong>Matric No Â· Name Â· Score Â· Total</strong><br>
          Accepted formats: <code>tab-separated</code>, <code>comma-separated</code>, or <code>space-separated</code>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">
          <div class="form-g" style="margin:0">
            <label class="inp-label">Result Type</label>
            <select class="sel" id="piType"><option value="test">Test</option><option value="exam">Exam</option></select>
          </div>
          <div class="form-g" style="margin:0">
            <label class="inp-label">Title / Description</label>
            <input class="inp" id="piTitle" placeholder="e.g. Mid-Term Test 1" style="margin:0">
          </div>
          <div class="form-g" style="margin:0">
            <label class="inp-label">Class</label>
            <select class="sel" id="piClass" onchange="piFilterCourses()"></select>
          </div>
          <div class="form-g" style="margin:0">
            <label class="inp-label">Course</label>
            <select class="sel" id="piCourse"></select>
          </div>
        </div>

        <div class="form-g">
          <label class="inp-label">Paste Data Here</label>
          <textarea class="paste-area" id="piPasteBox" placeholder="Paste your data hereâ€¦&#10;&#10;Example (tab or comma separated):&#10;NSG/23/001&#9;Amaka Eze&#9;78&#9;100&#10;NSG/23/002&#9;Chidi Obi&#9;65&#9;100&#10;NSG/23/003&#9;Funke Bello&#9;54&#9;100&#10;&#10;Or just name + score:&#10;Amaka Eze&#9;78&#10;Chidi Obi&#9;65" oninput="piParseAndPreview()"></textarea>
        </div>

        <div id="piPreviewWrap" style="display:none">
          <div class="parse-preview">
            <div class="parse-preview-hd">
              <span id="piPreviewCount">0 rows parsed</span>
              <span id="piPreviewErrors" style="color:var(--accent4)"></span>
            </div>
            <!-- Column headers -->
            <div class="parse-row" style="background:var(--bg3);padding:6px 14px;">
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">âœ“</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">MATRIC NO.</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">STUDENT NAME</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">SCORE</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">GRADE</span>
              <span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">STATUS</span>
              <span></span>
            </div>
            <div id="piPreviewBody"></div>
          </div>

          <div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="font-size:12px;color:var(--text2);font-family:'DM Mono',monospace;" id="piSummary"></div>
            <button class="btn-submit" onclick="piImportAll()" id="piImportBtn" style="width:auto;padding:11px 28px;">
              âœ“ Import All Valid Rows
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Add Result (Teacher/Admin only) -->
<div class="overlay" id="addResultModal">
  <div class="modal modal-wide">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“Š Upload Result</div>
      <button class="modal-x" onclick="closeModal('addResultModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-g">
          <label class="inp-label">Result Type</label>
          <select class="sel" id="newResultType">
            <option value="test">Test</option>
            <option value="exam">Exam</option>
          </select>
        </div>
        <div class="form-g">
          <label class="inp-label">Title / Description</label>
          <input class="inp" id="newResultTitle" placeholder="e.g. Mid-Term Test, Final Exam">
        </div>
        <div class="form-g">
          <label class="inp-label">Class</label>
          <select class="sel" id="newResultClass" onchange="filterResultModalCourses();filterResultModalStudents()"></select>
        </div>
        <div class="form-g">
          <label class="inp-label">Course</label>
          <select class="sel" id="newResultCourse"></select>
        </div>
        <div class="form-g">
          <label class="inp-label">Student</label>
          <select class="sel" id="newResultStudent"></select>
        </div>
        <div class="form-g">
          <label class="inp-label">Score (%)</label>
          <input class="inp" id="newResultScore" type="number" min="0" max="100" placeholder="e.g. 78">
        </div>
        <div class="form-g">
          <label class="inp-label">Total Marks</label>
          <input class="inp" id="newResultTotal" type="number" min="1" placeholder="e.g. 100">
        </div>
        <div class="form-g">
          <label class="inp-label">Remarks (optional)</label>
          <input class="inp" id="newResultRemarks" placeholder="e.g. Excellent performance">
        </div>
      </div>
      <button class="btn-submit" onclick="submitResult()">Save Result â†’</button>
    </div>
  </div>
</div>

<!-- Add Lecturer (Admin only) -->
<div class="overlay" id="addLecturerModal">
  <div class="modal">
    <div class="modal-hd"><div class="modal-ht">Create Lecturer Account</div><button class="modal-x" onclick="closeModal('addLecturerModal')">âœ•</button></div>
    <div class="modal-bd">
      <div style="background:rgba(62,142,149,.07);border:1px solid rgba(62,142,149,.2);border-radius:10px;padding:12px 14px;font-size:11px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:18px;line-height:1.7;">
        â„¹ï¸ Only you (Admin) can create lecturer accounts. Share the credentials with the lecturer so they can sign in.
      </div>
      <div class="form-g"><label class="inp-label">Lecturer Full Name</label><input class="inp" id="lecturerName" placeholder="e.g. Dr. Adaora Obi"></div>
      <div class="form-g"><label class="inp-label">Username</label><input class="inp" id="lecturerUsername" type="text" placeholder="e.g. dr.adaora"></div>
      <div class="form-g"><label class="inp-label">Temporary Password</label><input class="inp" id="lecturerPassword" placeholder="Set a temporary password for them"></div>
      <button class="btn-submit" onclick="addLecturerAccount()">Create Lecturer Account â†’</button>
    </div>
  </div>
</div>

<!-- ===== FOLDER UPLOAD FULL-SCREEN ===== -->
<div class="fu-overlay" id="fuOverlay">

  <!-- Top bar -->
  <div class="fu-topbar">
    <button class="fu-back" onclick="closeFolderUpload()">â† Back</button>
    <div class="fu-title">ðŸ“‚ Folder Upload</div>
    <div style="font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;" id="fuTopStats"></div>
  </div>

  <!-- Body: left tree + right config -->
  <div class="fu-body">

    <!-- LEFT: Drop zone + file tree -->
    <div class="fu-left">

      <!-- Drop zone -->
      <div class="fu-dropzone" id="fuDropzone"
        ondragover="fuDragOver(event)"
        ondragleave="fuDragLeave(event)"
        ondrop="fuDrop(event)"
        onclick="document.getElementById('fuFolderInput').click()">
        <div class="fu-dz-ico" id="fuDzIco">ðŸ“‚</div>
        <div class="fu-dz-title" id="fuDzTitle">Drop a folder here</div>
        <div class="fu-dz-sub" id="fuDzSub">
          Drag &amp; drop a folder from your computer,<br>
          Google Drive, USB drive, or any storage
        </div>
        <div class="fu-dz-hint">Supports: PDF, DOC, DOCX, PPT, PPTX, PNG, JPG, GIF, WEBP</div>
        <div class="fu-dz-btns">
          <button class="fu-dz-btn primary" onclick="event.stopPropagation();document.getElementById('fuFolderInput').click()">ðŸ“ Choose Folder</button>
          <button class="fu-dz-btn" onclick="event.stopPropagation();document.getElementById('fuFilesInput').click()">ðŸ“„ Choose Files</button>
        </div>
      </div>

      <!-- Hidden folder/file inputs -->
      <input type="file" id="fuFolderInput" style="display:none" webkitdirectory multiple onchange="fuFolderChosen(this)">
      <input type="file" id="fuFilesInput" style="display:none" multiple
        accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg,.gif,.webp"
        onchange="fuFilesChosen(this)">

      <!-- File tree -->
      <div class="fu-tree-hd">
        <span>Files <span id="fuTreeCount">0</span></span>
        <div style="display:flex;gap:8px;">
          <span style="cursor:pointer;color:var(--accent2);" onclick="fuSelectAll(true)">All</span>
          <span style="cursor:pointer;color:var(--accent4);" onclick="fuSelectAll(false)">None</span>
        </div>
      </div>
      <div class="fu-tree" id="fuTree">
        <div class="fu-empty-state" style="padding:30px 20px;">
          <div class="fu-empty-ico">ðŸ“‚</div>
          <div class="fu-empty-t" style="font-size:13px;">No folder selected</div>
          <div class="fu-empty-s" style="font-size:11px;">Drop a folder or click above</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Assignment + file list + progress -->
    <div class="fu-right" id="fuRight">

      <!-- Empty state -->
      <div class="fu-empty-state" id="fuEmptyState">
        <div class="fu-empty-ico">â¬†ï¸</div>
        <div class="fu-empty-t">No files loaded yet</div>
        <div class="fu-empty-s">Drop a folder from your computer, Google Drive,<br>USB drive, or any external storage on the left</div>
      </div>

      <!-- Assignment panel (shown when files loaded) -->
      <div id="fuAssignPanel" style="display:none;">
        <div class="fu-section-title">ðŸ“Œ Assign to Class &amp; Course</div>
        <div style="background:rgba(62,142,149,.06);border:1px solid rgba(62,142,149,.15);border-radius:10px;padding:11px 14px;font-size:12px;color:var(--accent);font-family:'DM Mono',monospace;margin-bottom:16px;line-height:1.6;">
          â„¹ï¸ Set a default class &amp; course for all files. You can override individual files in the table below.
        </div>
        <div class="fu-assignment-grid">
          <div class="fu-field">
            <label>Default Class</label>
            <select class="fu-sel" id="fuDefaultClass" onchange="fuClassChanged()">
              <option value="">â€” Select class â€”</option>
            </select>
          </div>
          <div class="fu-field">
            <label>Default Course</label>
            <select class="fu-sel" id="fuDefaultCourse">
              <option value="">â€” Select course â€”</option>
            </select>
          </div>
        </div>

        <div class="fu-section-title" style="margin-top:8px;">ðŸ“‹ Files to Upload (<span id="fuSelectedCount">0</span> selected)</div>
        <div class="fu-files-table">
          <div class="fu-files-thead">
            <div class="fu-file-cell" style="width:20px;padding:0;"></div>
            <div class="fu-file-cell">File Name</div>
            <div class="fu-file-cell">Folder Path</div>
            <div class="fu-file-cell">Type</div>
            <div class="fu-file-cell">Size</div>
          </div>
          <div id="fuFileRows"></div>
        </div>
      </div>

      <!-- Progress panel -->
      <div id="fuProgressPanel" style="display:none;">
        <div class="fu-section-title">â¬†ï¸ Uploading Filesâ€¦</div>
        <div class="fu-progress-wrap" id="fuProgressWrap"></div>
      </div>

      <!-- Done panel -->
      <div id="fuDonePanel" style="display:none;text-align:center;padding:60px 20px;">
        <div style="font-size:64px;margin-bottom:16px;">âœ…</div>
        <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:700;margin-bottom:8px;" id="fuDoneTitle">Upload Complete!</div>
        <div style="font-size:14px;color:var(--text2);margin-bottom:28px;" id="fuDoneSub"></div>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
          <button class="fu-btn-cancel" onclick="fuReset()">Upload Another Folder</button>
          <button class="fu-btn-upload" onclick="closeFolderUpload()">Go to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom summary bar -->
  <div class="fu-summary" id="fuSummaryBar" style="display:none;">
    <div class="fu-sum-stat"><div class="fu-sum-val" id="fuSumFiles" style="color:var(--accent)">0</div><div class="fu-sum-lbl">Files</div></div>
    <div class="fu-sum-sep"></div>
    <div class="fu-sum-stat"><div class="fu-sum-val" id="fuSumSelected" style="color:var(--accent3)">0</div><div class="fu-sum-lbl">Selected</div></div>
    <div class="fu-sum-sep"></div>
    <div class="fu-sum-stat"><div class="fu-sum-val" id="fuSumSize" style="color:var(--accent2)">0 KB</div><div class="fu-sum-lbl">Total Size</div></div>
    <div class="fu-sum-sep"></div>
    <div class="fu-sum-stat"><div class="fu-sum-val" id="fuSumFolders" style="color:var(--accent4)">0</div><div class="fu-sum-lbl">Folders</div></div>
    <div class="fu-action-btns">
      <button class="fu-btn-cancel" onclick="closeFolderUpload()">Cancel</button>
      <button class="fu-btn-upload" id="fuUploadBtn" onclick="fuStartUpload()" disabled>â¬† Upload Selected Files</button>
    </div>
  </div>

</div>

<!-- ===== FULL SCREEN PREVIEW VIEWER ===== -->
<div class="pv-overlay" id="pvOverlay">

  <!-- Top bar -->
  <div class="pv-topbar">
    <button class="pv-back" onclick="closePreview()">â† Back</button>
    <div class="pv-title-block">
      <div class="pv-title" id="pvTitle">Handout Preview</div>
      <div class="pv-subtitle" id="pvSubtitle"></div>
    </div>
    <span class="pv-badge fb-pdf" id="pvBadge" style="display:none"></span>
    <button class="pv-dl-btn" id="pvDlBtn" onclick="doDownload()">â¬‡ Download</button>
    <button class="pv-tool-btn" onclick="toggleInfoPanel()" title="Details" style="width:auto;padding:0 12px;gap:6px;font-size:12px;font-family:'DM Mono',monospace;">â„¹ Info</button>
  </div>

  <!-- Toolbar (zoom + page nav) -->
  <div class="pv-toolbar" id="pvToolbar">
    <!-- page nav (PDF only) -->
    <span class="pv-toolbar-label" id="pvPageLabel" style="display:none">Page:</span>
    <button class="pv-tool-btn" id="pvPrevPage" onclick="pvChangePage(-1)" style="display:none" title="Previous page">â€¹</button>
    <span class="pv-pg-info" id="pvPageInfo" style="display:none">1 / 1</span>
    <button class="pv-tool-btn" id="pvNextPage" onclick="pvChangePage(1)" style="display:none" title="Next page">â€º</button>
    <div class="pv-sep" id="pvPageSep" style="display:none"></div>
    <!-- zoom -->
    <span class="pv-toolbar-label">Zoom:</span>
    <button class="pv-tool-btn" id="pvZoomOut" onclick="pvZoom(-0.15)" title="Zoom out">âˆ’</button>
    <span class="pv-zoom-val" id="pvZoomVal">100%</span>
    <button class="pv-tool-btn" id="pvZoomIn" onclick="pvZoom(0.15)" title="Zoom in">+</button>
    <button class="pv-tool-btn" onclick="pvResetZoom()" title="Reset zoom" style="font-size:11px;font-family:'DM Mono',monospace;width:auto;padding:0 8px;">1:1</button>
    <div class="pv-sep"></div>
    <button class="pv-tool-btn" onclick="pvFitWidth()" title="Fit to width" style="font-size:11px;font-family:'DM Mono',monospace;width:auto;padding:0 8px;">Fit</button>
    <button class="pv-fullscreen-btn" onclick="pvToggleFullscreen()">â›¶ Fullscreen</button>
  </div>

  <!-- Viewer body -->
  <div class="pv-body" id="pvBody">
    <div class="pv-spinner" id="pvSpinner">
      <div class="pv-spin-ring"></div>
      <div class="pv-spin-txt">Loading previewâ€¦</div>
    </div>
  </div>

  <!-- Info panel (slides in from right) -->
  <div class="pv-info-panel" id="pvInfoPanel">
    <div class="pv-info-hd">
      <span>File Details</span>
      <button class="pv-info-close" onclick="toggleInfoPanel()">âœ•</button>
    </div>
    <div class="pv-info-body">
      <div class="pv-info-field"><div class="pv-info-label">Title</div><div class="pv-info-value" id="pvInfoTitle">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">File Type</div><div class="pv-info-value" id="pvInfoType">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">Uploaded By</div><div class="pv-info-value" id="pvInfoLecturer">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">Date</div><div class="pv-info-value" id="pvInfoDate">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">Course</div><div class="pv-info-value" id="pvInfoCourse">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">Class</div><div class="pv-info-value" id="pvInfoClass">â€”</div></div>
      <div class="pv-info-field"><div class="pv-info-label">File Size</div><div class="pv-info-value" id="pvInfoSize">â€”</div></div>
      <div style="margin-top:8px;">
        <button class="pv-dl-btn" style="width:100%;justify-content:center;" onclick="doDownload()">â¬‡ Download File</button>
      </div>
    </div>
  </div>

</div>

<script>
// ============================================================
// CONSTANTS
// ============================================================
const ADMIN_USERNAME = 'admin';
const ADMIN_PASSWORD = 'elite123';
const ADMIN_NAME     = 'Admin';

const colorMap = {
  blue:  {color:'var(--nd1)', bg:'rgba(62,142,149,.12)'},
  purple:{color:'var(--nd2)', bg:'rgba(90,173,160,.12)'},
  green: {color:'var(--hnd1)',bg:'rgba(90,173,160,.12)'},
  red:   {color:'var(--hnd2)',bg:'rgba(224,123,123,.12)'},
  yellow:{color:'#fbbf24',    bg:'rgba(251,191,36,.12)'},
  pink:  {color:'#f472b6',    bg:'rgba(244,114,182,.12)'},
  orange:{color:'#fb923c',    bg:'rgba(251,146,60,.12)'},
  teal:  {color:'#2dd4bf',    bg:'rgba(45,212,191,.12)'},
};
const fileIco={pdf:'ðŸ“„',doc:'ðŸ“',ppt:'ðŸ“Š',img:'ðŸ–¼ï¸'};
const fileBg ={pdf:'rgba(224,123,123,.1)',doc:'rgba(62,142,149,.1)',ppt:'rgba(251,191,36,.1)',img:'rgba(90,173,160,.1)'};

// ============================================================
// DATABASE â€” localStorage
// ============================================================
function seedDB(){
  return {
    classes:[
      {id:'nd1',  name:'ND ONE',    full:'National Diploma Year One',              color:'blue'},
      {id:'nd2',  name:'ND TWO',    full:'National Diploma Year Two',              color:'purple'},
      {id:'hnd1', name:'HND ONE',   full:'Higher National Diploma Year One',       color:'green'},
      {id:'hnd2', name:'HND TWO',   full:'Higher National Diploma Year Two',       color:'red'},
      {id:'cn1',  name:'CN YEAR 1', full:'Community Nursing Year One',             color:'yellow'},
      {id:'cn2',  name:'CN YEAR 2', full:'Community Nursing Year Two',             color:'pink'},
      {id:'bnsc1',name:'BNSc 1',    full:'Bachelor of Nursing Science Year One',   color:'blue'},
      {id:'bnsc2',name:'BNSc 2',    full:'Bachelor of Nursing Science Year Two',   color:'purple'},
      {id:'bnsc3',name:'BNSc 3',    full:'Bachelor of Nursing Science Year Three', color:'green'},
      {id:'bnsc4',name:'BNSc 4',    full:'Bachelor of Nursing Science Year Four',  color:'red'},
      {id:'bnsc5',name:'BNSc FINAL',full:'Bachelor of Nursing Science Final Year', color:'yellow'},
    ],
    courses:[
      // ND ONE
      {id:'c1', classId:'nd1', title:'Anatomy and Physiology I',             code:'NSG 101',lecturer:'Dr. Adaora Obi',       creditUnits:3},
      {id:'c2', classId:'nd1', title:'Fundamentals of Nursing Practice',     code:'NSG 102',lecturer:'Mrs. Ngozi Eze',       creditUnits:4},
      {id:'c3', classId:'nd1', title:'Medical Microbiology',                 code:'NSG 103',lecturer:'Dr. Emeka Okafor',    creditUnits:3},
      {id:'c4', classId:'nd1', title:'Nutrition and Dietetics',              code:'NSG 104',lecturer:'Mrs. Amaka Dike',      creditUnits:2},
      // ND TWO
      {id:'c5', classId:'nd2', title:'Anatomy and Physiology II',            code:'NSG 201',lecturer:'Dr. Adaora Obi',       creditUnits:3},
      {id:'c6', classId:'nd2', title:'Medical and Surgical Nursing',         code:'NSG 202',lecturer:'Mrs. Ngozi Eze',       creditUnits:4},
      {id:'c7', classId:'nd2', title:'Pharmacology I',                       code:'NSG 203',lecturer:'Dr. Chukwu Nwosu',    creditUnits:3},
      {id:'c8', classId:'nd2', title:'Community Health Nursing',             code:'NSG 204',lecturer:'Mrs. Funke Bello',     creditUnits:3},
      // HND ONE
      {id:'c9', classId:'hnd1',title:'Advanced Medical-Surgical Nursing',    code:'NSG 301',lecturer:'Dr. Emeka Okafor',    creditUnits:4},
      {id:'c10',classId:'hnd1',title:'Maternal and Child Health Nursing',    code:'NSG 302',lecturer:'Mrs. Yetunde Adeyemi', creditUnits:3},
      {id:'c11',classId:'hnd1',title:'Pharmacology II',                      code:'NSG 303',lecturer:'Dr. Chukwu Nwosu',    creditUnits:3},
      {id:'c12',classId:'hnd1',title:'Psychiatric and Mental Health Nursing',code:'NSG 304',lecturer:'Dr. Sola Adesanya',   creditUnits:3},
      // HND TWO
      {id:'c13',classId:'hnd2',title:'Nursing Research Methods',             code:'NSG 401',lecturer:'Prof. Bisi Adewale',  creditUnits:3},
      {id:'c14',classId:'hnd2',title:'Nursing Management & Leadership',      code:'NSG 402',lecturer:'Mrs. Amaka Dike',      creditUnits:3},
      {id:'c15',classId:'hnd2',title:'Critical Care Nursing',                code:'NSG 403',lecturer:'Dr. Adaora Obi',       creditUnits:4},
      {id:'c16',classId:'hnd2',title:'Clinical Practicum & Supervision',     code:'NSG 404',lecturer:'Mrs. Ngozi Eze',       creditUnits:4},
      // COMMUNITY NURSING YEAR ONE
      {id:'cn1c1',classId:'cn1',title:'Introduction to Community Health',    code:'CHN 101',lecturer:'Mrs. Funke Bello',     creditUnits:3},
      {id:'cn1c2',classId:'cn1',title:'Epidemiology and Biostatistics',      code:'CHN 102',lecturer:'Dr. Sola Adesanya',   creditUnits:3},
      {id:'cn1c3',classId:'cn1',title:'Environmental Health',                code:'CHN 103',lecturer:'Dr. Emeka Okafor',    creditUnits:3},
      {id:'cn1c4',classId:'cn1',title:'Primary Health Care',                 code:'CHN 104',lecturer:'Mrs. Ngozi Eze',       creditUnits:3},
      {id:'cn1c5',classId:'cn1',title:'Health Education & Promotion',        code:'CHN 105',lecturer:'Mrs. Amaka Dike',      creditUnits:2},
      // COMMUNITY NURSING YEAR TWO
      {id:'cn2c1',classId:'cn2',title:'Community Mental Health Nursing',     code:'CHN 201',lecturer:'Dr. Sola Adesanya',   creditUnits:3},
      {id:'cn2c2',classId:'cn2',title:'Maternal & Child Health in Community',code:'CHN 202',lecturer:'Mrs. Yetunde Adeyemi', creditUnits:4},
      {id:'cn2c3',classId:'cn2',title:'School Health Nursing',               code:'CHN 203',lecturer:'Mrs. Funke Bello',     creditUnits:2},
      {id:'cn2c4',classId:'cn2',title:'Occupational Health Nursing',         code:'CHN 204',lecturer:'Dr. Emeka Okafor',    creditUnits:3},
      {id:'cn2c5',classId:'cn2',title:'Community Nursing Research',          code:'CHN 205',lecturer:'Prof. Bisi Adewale',  creditUnits:3},
      // BNSc YEAR ONE
      {id:'b1c1',classId:'bnsc1',title:'Human Anatomy & Physiology I',      code:'BNS 101',lecturer:'Dr. Adaora Obi',       creditUnits:3},
      {id:'b1c2',classId:'bnsc1',title:'Biochemistry for Nursing',           code:'BNS 102',lecturer:'Dr. Emeka Okafor',    creditUnits:3},
      {id:'b1c3',classId:'bnsc1',title:'Nursing Foundations & Ethics',       code:'BNS 103',lecturer:'Mrs. Ngozi Eze',       creditUnits:4},
      {id:'b1c4',classId:'bnsc1',title:'Medical Microbiology & Parasitology',code:'BNS 104',lecturer:'Dr. Chukwu Nwosu',    creditUnits:3},
      {id:'b1c5',classId:'bnsc1',title:'General & Inorganic Chemistry',      code:'BNS 105',lecturer:'Mrs. Amaka Dike',      creditUnits:2},
      // BNSc YEAR TWO
      {id:'b2c1',classId:'bnsc2',title:'Human Anatomy & Physiology II',     code:'BNS 201',lecturer:'Dr. Adaora Obi',       creditUnits:3},
      {id:'b2c2',classId:'bnsc2',title:'Pharmacology I',                    code:'BNS 202',lecturer:'Dr. Chukwu Nwosu',    creditUnits:3},
      {id:'b2c3',classId:'bnsc2',title:'Medical-Surgical Nursing I',        code:'BNS 203',lecturer:'Mrs. Ngozi Eze',       creditUnits:4},
      {id:'b2c4',classId:'bnsc2',title:'Maternal & Child Health Nursing I', code:'BNS 204',lecturer:'Mrs. Yetunde Adeyemi', creditUnits:3},
      {id:'b2c5',classId:'bnsc2',title:'Pathophysiology',                   code:'BNS 205',lecturer:'Dr. Emeka Okafor',    creditUnits:3},
      // BNSc YEAR THREE
      {id:'b3c1',classId:'bnsc3',title:'Pharmacology II',                   code:'BNS 301',lecturer:'Dr. Chukwu Nwosu',    creditUnits:3},
      {id:'b3c2',classId:'bnsc3',title:'Medical-Surgical Nursing II',       code:'BNS 302',lecturer:'Mrs. Ngozi Eze',       creditUnits:4},
      {id:'b3c3',classId:'bnsc3',title:'Psychiatric & Mental Health Nursing',code:'BNS 303',lecturer:'Dr. Sola Adesanya',  creditUnits:3},
      {id:'b3c4',classId:'bnsc3',title:'Maternal & Child Health Nursing II',code:'BNS 304',lecturer:'Mrs. Yetunde Adeyemi', creditUnits:3},
      {id:'b3c5',classId:'bnsc3',title:'Community Health Nursing I',        code:'BNS 305',lecturer:'Mrs. Funke Bello',     creditUnits:3},
      // BNSc YEAR FOUR
      {id:'b4c1',classId:'bnsc4',title:'Nursing Research Methods',          code:'BNS 401',lecturer:'Prof. Bisi Adewale',  creditUnits:3},
      {id:'b4c2',classId:'bnsc4',title:'Critical Care Nursing',             code:'BNS 402',lecturer:'Dr. Adaora Obi',       creditUnits:4},
      {id:'b4c3',classId:'bnsc4',title:'Community Health Nursing II',       code:'BNS 403',lecturer:'Mrs. Funke Bello',     creditUnits:3},
      {id:'b4c4',classId:'bnsc4',title:'Nursing Informatics & Tech',        code:'BNS 404',lecturer:'Dr. Emeka Okafor',    creditUnits:2},
      {id:'b4c5',classId:'bnsc4',title:'Nursing Leadership & Management',   code:'BNS 405',lecturer:'Mrs. Amaka Dike',      creditUnits:3},
      // BNSc FINAL YEAR
      {id:'b5c1',classId:'bnsc5',title:'Advanced Nursing Practice',         code:'BNS 501',lecturer:'Prof. Bisi Adewale',  creditUnits:4},
      {id:'b5c2',classId:'bnsc5',title:'Nursing Administration & Education',code:'BNS 502',lecturer:'Mrs. Ngozi Eze',       creditUnits:3},
      {id:'b5c3',classId:'bnsc5',title:'Perioperative Nursing',             code:'BNS 503',lecturer:'Dr. Adaora Obi',       creditUnits:3},
      {id:'b5c4',classId:'bnsc5',title:'Final Year Research Project',       code:'BNS 504',lecturer:'Prof. Bisi Adewale',  creditUnits:6},
      {id:'b5c5',classId:'bnsc5',title:'Clinical Rotation & Supervision',   code:'BNS 505',lecturer:'Mrs. Yetunde Adeyemi', creditUnits:4},
    ],
    handouts:[],
    users:[],
    results:[],   // { id, type, title, courseId, classId, studentId, studentName, score, total, grade, date, uploadedBy, remarks }
    pastQuestions:[], // { id, title, year, type, courseId, questions:[], createdBy, createdAt }
    messages:[],      // all chat messages
    dmThreads:[],     // opened DM thread IDs (for both-side visibility)
    activityLogs:[],  // { userId, userName, role, action, detail, timestamp }
    lecturerFolders:[], // { id, courseId, lecturerName, createdBy, createdAt }
    timetable:[],     // { id, classId, courseId, day, startTime, endTime, venue, createdBy }
    _version: 10,
  };
}

// â”€â”€ Restore users from backup key if main DB lost them â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _restoreUsersFromBackup(dbObj){
  try {
    if(!dbObj.users||dbObj.users.length===0){
      const raw=localStorage.getItem('nv_users_backup');
      if(raw){
        const backed=JSON.parse(raw);
        if(backed&&backed.length>0){ dbObj.users=backed; }
      }
    }
  } catch(e){}
  return dbObj;
}

function loadDB(){
  try{
    const raw = localStorage.getItem('nv_db');
    if(!raw) {
      // Try restoring from user backup before returning seed
      const bkp = _restoreUsersFromBackup(seedDB());
      return bkp;
    }
    const parsed = JSON.parse(raw);
    // If version is old, migrate important data into a fresh DB
    if(!parsed._version || parsed._version < 10){
      console.log('DB version upgrade â€” migrating to v10');
      const fresh = seedDB();
      fresh.messages      = parsed.messages      || [];
      fresh.results       = parsed.results       || [];
      fresh.handouts      = parsed.handouts      || [];
      fresh.pastQuestions = parsed.pastQuestions || [];
      fresh.dmThreads     = parsed.dmThreads     || [];
      fresh.activityLogs  = parsed.activityLogs  || [];
      fresh.lecturerFolders= parsed.lecturerFolders|| [];
      fresh.timetable     = parsed.timetable     || [];
      fresh.adminPhone    = parsed.adminPhone    || '';
      fresh.adminAvatar   = parsed.adminAvatar   || '';
      fresh.users = (parsed.users||[]).slice();
      if(parsed.classes && parsed.classes.length > 0){
        const existingIds = parsed.classes.map(c=>c.id);
        const newSeedClasses = fresh.classes.filter(c=>!existingIds.includes(c.id));
        fresh.classes = [...parsed.classes, ...newSeedClasses];
      }
      if(parsed.courses && parsed.courses.length > 0){
        const existingCourseIds = parsed.courses.map(c=>c.id);
        const newSeedCourses = fresh.courses.filter(c=>!existingCourseIds.includes(c.id));
        fresh.courses = [...parsed.courses, ...newSeedCourses];
      }
      fresh._version = 10;
      localStorage.setItem('nv_db', JSON.stringify(fresh));
      return fresh;
    }
    // Patch missing arrays
    if(!parsed.pastQuestions) parsed.pastQuestions=[];
    if(!parsed.messages)      parsed.messages=[];
    if(!parsed.users)         parsed.users=[];
    if(!parsed.classes)       parsed.classes=[];
    if(!parsed.courses)       parsed.courses=[];
    if(!parsed.handouts)      parsed.handouts=[];
    if(!parsed.results)       parsed.results=[];
    if(!parsed.dmThreads)     parsed.dmThreads=[];
    if(!parsed.activityLogs)  parsed.activityLogs=[];
    if(!parsed.lecturerFolders) parsed.lecturerFolders=[];
    if(!parsed.timetable)    parsed.timetable=[];
    // If users array is empty but backup exists, restore it
    if(!parsed.users||parsed.users.length===0) _restoreUsersFromBackup(parsed);
    return parsed;
  } catch(e){
    return seedDB();
  }
}
// â”€â”€ Cross-tab / cross-window sync via BroadcastChannel + storage event â”€â”€
let _nvChannel = null;
try { _nvChannel = new BroadcastChannel('nv_sync'); } catch(e){}

function saveMsgFileData(msgId, fileData){
  // Store file/voice data for a message in its own localStorage key
  try{
    localStorage.setItem('nv_msgfile_'+msgId, fileData);
    return true;
  } catch(e){
    // Quota exceeded â€” try clearing old message file entries to make room
    try{
      const keys=[];
      for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k&&k.startsWith('nv_msgfile_')) keys.push(k); }
      // Remove oldest half
      keys.slice(0, Math.ceil(keys.length/2)).forEach(k=>{ try{localStorage.removeItem(k);}catch(e2){} });
      localStorage.setItem('nv_msgfile_'+msgId, fileData);
      return true;
    } catch(e2){
      return false;
    }
  }
}
function loadMsgFileData(msgId){ try{ return localStorage.getItem('nv_msgfile_'+msgId)||null; }catch(e){ return null; } }

function saveDB(){
  try{
    // Ensure all arrays exist before saving
    if(!db.messages) db.messages=[];
    if(!db.users) db.users=[];
    if(!db.classes) db.classes=[];
    if(!db.courses) db.courses=[];
    if(!db.handouts) db.handouts=[];
    if(!db.results) db.results=[];
    if(!db.pastQuestions) db.pastQuestions=[];
    if(!db.dmThreads) db.dmThreads=[];
    if(!db.activityLogs) db.activityLogs=[];
    if(!db.lecturerFolders) db.lecturerFolders=[];
    if(!db.timetable) db.timetable=[];
    // Always stamp current version so migration never re-runs
    db._version = 10;

    // Strip large fileData from messages before saving to main DB
    // (file data is stored separately via saveMsgFileData)
    const msgsToSave = db.messages.map(m=>{
      if(!m.fileData) return m;
      const {fileData, ...rest} = m;
      return rest;
    });
    const dbToSave = {...db, messages: msgsToSave};

    try{
      localStorage.setItem('nv_db', JSON.stringify(dbToSave));
    } catch(e){
      // Quota exceeded for main DB â€” try removing old message file data and retry
      for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k&&k.startsWith('nv_msgfile_')){ try{localStorage.removeItem(k);}catch(e2){} } }
      try{ localStorage.setItem('nv_db', JSON.stringify(dbToSave)); }catch(e2){ console.warn('saveDB failed even after cleanup:', e2); }
    }
    // Notify other tabs
    if(_nvChannel){ try{ _nvChannel.postMessage({type:'db_updated',ts:Date.now()}); }catch(e){} }
    // Keep user backup in sync
    try{ localStorage.setItem('nv_users_backup', JSON.stringify(db.users||[])); }catch(e){}
  } catch(e){ console.warn('saveDB failed:', e); }
}

function _onExternalDBUpdate(){
  _reloadDbFromStorage();
  // Refresh message UI if open
  if(typeof renderMsgChannels === 'function'){
    try{
      const inp = document.getElementById('msgSearchInp');
      renderMsgChannels(inp ? inp.value : '');
    }catch(e){}
  }
  if(typeof renderMsgBody === 'function' && typeof activeThreadId !== 'undefined' && activeThreadId){
    try{ renderMsgBody(activeThreadId); }catch(e){}
  }
}

// BroadcastChannel listener (same origin, different tab)
if(_nvChannel){
  _nvChannel.onmessage = function(e){
    if(e.data && e.data.type === 'db_updated') _onExternalDBUpdate();
  };
}
// storage event (different window / different browser profile on same origin)
window.addEventListener('storage', function(e){
  if(e.key === 'nv_db') _onExternalDBUpdate();
});

let db = loadDB();

// In-memory file store (not persisted)
const fileStore = {};

let currentRole = 'student';
let currentUser = {};
let currentClassId = null;
let currentCourseId = null;
let previewId = null;

// ============================================================
// ACTIVITY LOGGING â€” Track all user actions for admin
// ============================================================
function logActivity(action, detail=''){
  if(!db.activityLogs) db.activityLogs=[];
  const entry={
    id:'al_'+Date.now(),
    userId: currentUser.id||'unknown',
    userName: currentUser.name||currentUser.username||'Unknown',
    role: currentRole,
    classId: currentUser.classId||'',
    action,
    detail,
    timestamp: Date.now()
  };
  db.activityLogs.unshift(entry);
  // Keep only last 2000 entries
  if(db.activityLogs.length>2000) db.activityLogs=db.activityLogs.slice(0,2000);
  saveDB();
}

// ============================================================
// SAVED ACCOUNTS â€” quick login dropdown
// ============================================================
const SA_KEY = 'nv_saved_accs_v5'; // new key â€” avoids old corrupt data

function getSavedAccounts(){
  try{ return JSON.parse(localStorage.getItem(SA_KEY)) || []; } catch(e){ return []; }
}
function saveAccount(username, password, name, role){
  try{
    let arr = getSavedAccounts().filter(a => a.u !== username);
    arr.unshift({ u: username, p: password, n: name, r: role });
    localStorage.setItem(SA_KEY, JSON.stringify(arr.slice(0, 8)));
  } catch(e){}
}
function removeSavedAccount(username){
  try{
    const arr = getSavedAccounts().filter(a => a.u !== username);
    localStorage.setItem(SA_KEY, JSON.stringify(arr));
    renderSavedDropdown();
  } catch(e){}
}

function renderSavedDropdown(filter){
  const list = document.getElementById('savedList');
  if(!list) return;
  const all = getSavedAccounts();
  const q = (filter||'').toLowerCase();
  const shown = q ? all.filter(a => a.u.includes(q) || (a.n||'').toLowerCase().includes(q)) : all;
  if(!shown.length){ list.innerHTML = '<div class="saved-dropdown-empty">No saved accounts</div>'; return; }
  const rc = r => r==='admin'?'rgba(251,191,36,.15)':r==='teacher'?'rgba(62,142,149,.15)':'rgba(90,173,160,.15)';
  const rt = r => r==='admin'?'#fbbf24':r==='teacher'?'var(--accent)':'var(--accent3)';
  list.innerHTML = shown.map(a=>`
    <div class="saved-account-item" onclick="fillSaved('${a.u}','${encodeURIComponent(a.p)}')">
      <div class="saved-account-av">${(a.n||a.u)[0].toUpperCase()}</div>
      <div class="saved-account-info">
        <div class="saved-account-name">${a.n||a.u}</div>
        <div class="saved-account-email">${a.u}</div>
      </div>
      <span class="saved-account-role" style="background:${rc(a.r)};color:${rt(a.r)}">${a.r}</span>
      <button class="saved-account-del" onclick="event.stopPropagation();removeSavedAccount('${a.u}')" title="Remove">âœ•</button>
    </div>`).join('');
}

function openSavedDropdown(){
  const dd = document.getElementById('savedDropdown');
  const list = getSavedAccounts();
  if(!dd||!list.length) return;
  renderSavedDropdown(document.getElementById('loginUsername').value);
  dd.classList.add('open');
}
function closeSavedDropdown(){
  const dd = document.getElementById('savedDropdown');
  if(dd) dd.classList.remove('open');
}
function filterSavedDropdown(val){
  const dd = document.getElementById('savedDropdown');
  const list = getSavedAccounts();
  if(!dd||!list.length){ if(dd) dd.classList.remove('open'); return; }
  renderSavedDropdown(val);
  dd.classList.add('open');
}
function handleUsernameKey(e){
  const dd = document.getElementById('savedDropdown');
  if(!dd||!dd.classList.contains('open')) return;
  const items = dd.querySelectorAll('.saved-account-item');
  let active = dd.querySelector('.saved-account-item.active');
  const idx = active ? Array.from(items).indexOf(active) : -1;
  if(e.key === 'ArrowDown'){
    e.preventDefault();
    if(active) active.classList.remove('active');
    const next = items[idx + 1] || items[0];
    if(next) next.classList.add('active');
  } else if(e.key === 'ArrowUp'){
    e.preventDefault();
    if(active) active.classList.remove('active');
    const prev = items[idx - 1] || items[items.length - 1];
    if(prev) prev.classList.add('active');
  } else if(e.key === 'Enter'){
    if(active){ e.preventDefault(); active.click(); }
  } else if(e.key === 'Escape'){
    closeSavedDropdown();
  }
}
function fillSaved(u, ep){
  document.getElementById('loginUsername').value = u;
  document.getElementById('loginPassword').value = decodeURIComponent(ep);
  closeSavedDropdown();
}
document.addEventListener('click', function(e){
  if(!e.target.closest('#savedDropdown') && !e.target.closest('#loginUsername')) closeSavedDropdown();
});

// ============================================================
// PASSWORD VISIBILITY
// ============================================================
function togglePassVis(inputId, btn){
  const inp = document.getElementById(inputId);
  if(!inp) return;
  if(inp.type==='password'){ inp.type='text'; btn.textContent='ðŸ™ˆ'; }
  else { inp.type='password'; btn.textContent='ðŸ‘'; }
}

// ============================================================
// THEME TOGGLE  â€” 3-way cycle: teal (default) â†’ dark â†’ light
// ============================================================
function _nvSetTheme(theme){
  document.body.classList.remove('light','dark');
  if(theme==='light') document.body.classList.add('light');
  if(theme==='dark')  document.body.classList.add('dark');
  localStorage.setItem('nv_theme', theme);
  // Update all theme buttons
  const icons = {teal:'ðŸŒ™', dark:'â˜€ï¸', light:'ðŸŒ¿'};
  const labels = {teal:'Dark mode', dark:'Light mode', light:'Teal mode'};
  document.querySelectorAll('.theme-btn').forEach(b=>{
    b.innerHTML = `<span style="font-size:15px;">${icons[theme]}</span><span class="theme-btn-label">${labels[theme]}</span>`;
    b.title = labels[theme];
  });
}
function toggleTheme(){
  const cur = localStorage.getItem('nv_theme')||'teal';
  const next = cur==='teal'?'dark': cur==='dark'?'light':'teal';
  _nvSetTheme(next);
}
(function applyTheme(){
  const saved = localStorage.getItem('nv_theme')||'teal';
  _nvSetTheme(saved);
})();

// ============================================================
// AUTH â€” switch between login / signup tabs
// ============================================================
function switchAuth(mode){
  const lf = document.getElementById('loginForm');
  const sf = document.getElementById('signupForm');
  const ff = document.getElementById('forgotForm');
  if(!lf||!sf) return;
  lf.style.display = mode==='login'  ? '' : 'none';
  sf.style.display = mode==='signup' ? '' : 'none';
  if(ff) ff.style.display = mode==='forgot' ? '' : 'none';
  ['loginErr','signupErr'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.remove('show');
  });
  closeSavedDropdown();
  if(mode==='signup'){
    const sel = document.getElementById('signupClass');
    if(sel) sel.innerHTML = db.classes.map(c=>`<option value="${c.id}">${c.name} â€” ${c.full}</option>`).join('');
  }
}

function doForgotPassword(){
  const username = (document.getElementById('forgotUsername').value||'').trim().toLowerCase();
  const newPass  = document.getElementById('forgotNewPass').value;
  const confPass = document.getElementById('forgotConfPass').value;
  const errEl    = document.getElementById('forgotErr');
  const okEl     = document.getElementById('forgotSuccess');
  errEl.style.display='none'; okEl.style.display='none';
  function fail(msg){ errEl.textContent=msg; errEl.style.display='block'; errEl.classList.add('show'); }
  if(!username)      return fail('Please enter your username.');
  if(!newPass)       return fail('Please enter a new password.');
  if(newPass.length<6) return fail('Password must be at least 6 characters.');
  if(newPass!==confPass) return fail('Passwords do not match.');
  const user = (db.users||[]).find(u=>(u.username||'').toLowerCase()===username);
  if(!user) return fail('Username not found. Check spelling and try again.');
  user.password = newPass;
  saveDB();
  okEl.style.display='block';
  document.getElementById('forgotNewPass').value='';
  document.getElementById('forgotConfPass').value='';
  setTimeout(function(){ switchAuth('login'); document.getElementById('loginUsername').value=username; }, 2000);
}

// ============================================================
// LOGIN
// ============================================================
function doLogin(){
  closeSavedDropdown();
  const username = (document.getElementById('loginUsername').value||'').trim().toLowerCase();
  const pass     = (document.getElementById('loginPassword').value||'');
  const errEl    = document.getElementById('loginErr');

  errEl.classList.remove('show');

  if(!username || !pass){
    errEl.textContent = 'Please enter username and password.';
    errEl.classList.add('show');
    return;
  }

  // Admin check
  if(username === ADMIN_USERNAME && pass === ADMIN_PASSWORD){
    currentRole = 'admin';
    currentUser = { id: 'admin', name: ADMIN_NAME, username: ADMIN_USERNAME, role: 'admin', cls: 'All', phone: db.adminPhone||'', avatar: db.adminAvatar||'' };
    saveAccount(username, pass, ADMIN_NAME, 'admin');
    launchApp();
    return;
  }

  // Student / teacher check
  const user = db.users.find(u => (u.username||'').toLowerCase() === username && u.password === pass);
  if(!user){
    errEl.textContent = 'Incorrect username or password.';
    errEl.classList.add('show');
    return;
  }

  currentRole = user.role || 'student';
  currentUser = user;
  saveAccount(username, pass, user.name, user.role);
  launchApp();
}

// ============================================================
// SIGNUP
// ============================================================
function doSignup(){
  const name     = (document.getElementById('signupName').value||'').trim();
  const username = (document.getElementById('signupUsername').value||'').trim().toLowerCase().replace(/\s+/g,'');
  const matric   = (document.getElementById('signupMatric')&&document.getElementById('signupMatric').value||'').trim().toUpperCase();
  const cls      = (document.getElementById('signupClass').value||'nd1');
  const pass     = (document.getElementById('signupPassword').value||'');
  const confirm  = (document.getElementById('signupConfirm').value||'');
  const errEl    = document.getElementById('signupErr');

  errEl.classList.remove('show');

  function fail(msg){ errEl.textContent = msg; errEl.classList.add('show'); }

  if(!name)            return fail('Please enter your full name.');
  if(!username)        return fail('Please choose a username.');
  if(username.length < 3) return fail('Username must be at least 3 characters.');
  if(!/^[a-z0-9_.-]+$/.test(username)) return fail('Username: only letters, numbers, _ . - allowed.');
  if(!pass)            return fail('Please enter a password.');
  if(pass.length < 6)  return fail('Password must be at least 6 characters.');
  if(pass !== confirm) return fail('Passwords do not match.');
  if(username === ADMIN_USERNAME) return fail('That username is not available.');
  if(db.users.find(u => (u.username||'').toLowerCase() === username)) return fail('Username already taken.');

  const clsObj = db.classes.find(c => c.id === cls);
  const newUser = {
    id: 'u_' + Date.now(),
    name, username, matric, password: pass,
    role: 'student',
    cls: clsObj ? clsObj.name : 'ND ONE',
    classId: cls
  };
  db.users.push(newUser);
  saveDB();

  currentRole = 'student';
  currentUser = newUser;
  saveAccount(username, pass, name, 'student');
  toast('Welcome, ' + name + '! ðŸŽ‰');
  launchApp();
}

// ============================================================
// LAUNCH APP
// ============================================================
function launchApp(){
  document.getElementById('authPage').style.display = 'none';
  document.getElementById('appWrap').style.display  = 'flex';
  setupRoleUI();
  renderSidebar();
  renderDashboard();
  // Log login activity
  setTimeout(()=>{
    logActivity('login', `${currentRole} logged in from ${navigator.userAgent.slice(0,40)}`);
  }, 200);
  // Start notification system
  initNotifSystem();
}

// Initialise signup class dropdown on page load
document.getElementById('signupClass').innerHTML =
  db.classes.map(c=>`<option value="${c.id}">${c.name} â€” ${c.full}</option>`).join('');

// ============================================================
// LOGOUT
// ============================================================
function doLogout(){
  currentUser={}; currentRole='student';
  currentClassId=null; currentCourseId=null; previewId=null;
  if(_ttCheckInterval){ clearInterval(_ttCheckInterval); _ttCheckInterval=null; }
  _nvNotifs=[];
  _navHistory=[];
  _navCurrentView='viewDashboard';
  document.getElementById('appWrap').style.display  = 'none';
  document.getElementById('authPage').style.display = 'flex';
  switchAuth('login');
  document.getElementById('loginUsername').value = '';
  const pwEl = document.getElementById('loginPassword');
  pwEl.value = ''; pwEl.type = 'password';
  const tog = document.querySelector('.pass-toggle');
  if(tog) tog.textContent = 'ðŸ‘';
}

// ============================================================
// FILE STORAGE (localStorage, chunked)
// ============================================================
function saveFileData(hid, data){ try{ localStorage.setItem('nv_file_'+hid, JSON.stringify(data)); }catch(e){ toast('Storage full â€” file preview unavailable.'); } }
function loadFileData(hid){ try{ const s=localStorage.getItem('nv_file_'+hid); return s?JSON.parse(s):null; }catch(e){ return null; } }

// ============================================================
// ROLE UI
// ============================================================
function setupRoleUI(){
  const displayName = currentUser.name || currentUser.username || 'User';
  document.getElementById('sidebarNm').textContent=displayName;
  document.getElementById('sidebarRl').textContent=currentRole;
  document.getElementById('sidebarAv').textContent=displayName[0].toUpperCase();
  const isT=currentRole==='teacher'||currentRole==='admin';
  const isA=currentRole==='admin';
  document.querySelectorAll('.teacher-el').forEach(el=>el.style.display=isT?'':'none');
  document.querySelectorAll('.admin-el').forEach(el=>el.style.display=isA?'':'none');
  updateSidebarAvatar();
}

// ============================================================
// SIDEBAR
// ============================================================
function renderSidebar(){
  document.getElementById('sidebarClasses').innerHTML=db.classes.map(cl=>{
    const c=colorMap[cl.color];
    return `<div class="class-chip" id="chip-${cl.id}" onclick="goToClass('${cl.id}')">
      <div class="class-dot" style="background:${c.color}"></div>${cl.name}
    </div>`;
  }).join('');
}

// ============================================================
// NAV
// ============================================================
// â”€â”€ Navigation History Stack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _navHistory=[];
let _navCurrentView='viewDashboard';
let _navIsGoingBack=false;

function nvPushHistory(viewId, label){
  if(_navIsGoingBack) return;
  if(_navCurrentView && _navCurrentView!==viewId){
    _navHistory.push(_navCurrentView);
    if(_navHistory.length>20) _navHistory.shift();
  }
  _navCurrentView=viewId;
  nvUpdateBackBtn(label);
}

function nvGoBack(){
  if(!_navHistory.length) return;
  _navIsGoingBack=true;
  const prev=_navHistory.pop();
  _navCurrentView=prev;
  nvUpdateBackBtn();
  // Route to correct restore function
  if(prev==='viewDashboard'){ showView('viewDashboard');renderDashboard(); }
  else if(prev==='viewClass'&&currentClassId){ showView('viewClass');renderCourses(currentClassId); }
  else if(prev==='viewCourse'&&currentCourseId){ showView('viewCourse');renderCourseFolders(currentCourseId); }
  else if(prev==='viewLecturerFolder'&&currentFolderId){ showView('viewLecturerFolder');renderHandouts(currentFolderId); }
  else { document.querySelectorAll('.view').forEach(v=>v.style.display='none'); const el=document.getElementById(prev); if(el) el.style.display=''; }
  _navIsGoingBack=false;
  nvUpdateBackBtn();
}

function nvUpdateBackBtn(){
  const btn=document.getElementById('globalBackBtn');
  if(!btn) return;
  if(_navHistory.length>0){
    btn.style.display='flex';
    // Label based on previous view
    const prev=_navHistory[_navHistory.length-1];
    const labels={viewDashboard:'Dashboard',viewClass:'Year / Class',viewCourse:'Course',viewLecturerFolder:'Folder',viewAllHandouts:'All Handouts',viewResults:'Results',viewPastQuestions:'Past Questions',viewMessages:'Messages',viewUsers:'Users',viewActivityMonitor:'Activity',viewTimetable:'Timetable',viewLabref:'Lab Reference',viewDrugguide:'Drug Guide',viewFlashcards:'Flashcards',viewMedcalc:'Med Calculator',viewStudyplanner:'Study Planner',viewSkillscheck:'Skills Checklist',viewDictionary:'Dictionary',viewGpacalc:'GPA Calculator',viewStudydash:'Study Progress'};
    btn.innerHTML=`â† ${labels[prev]||'Back'}`;
  } else {
    btn.style.display='none';
  }
}

function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  document.getElementById(id).style.display='';
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.class-chip').forEach(c=>c.classList.remove('active'));
  if(id!=='viewMessages' && typeof stopMsgPoll==='function') stopMsgPoll();
  closeSidebar();
  nvPushHistory(id);
}
function navGo(name){
  currentFolderId=null;
  if(name==='dashboard'){_navHistory=[];_navCurrentView='viewDashboard';nvUpdateBackBtn();showView('viewDashboard');renderDashboard();document.querySelector('.nav-item').classList.add('active');}
  else if(name==='timetable'){showView('viewTimetable');renderTimetable();}
  else if(name==='allhandouts'){showView('viewAllHandouts');renderAllHandouts(db.handouts);}
  else if(name==='results'){showView('viewResults');renderResultsView();}
  else if(name==='pastquestions'){showView('viewPastQuestions');renderPQBanks();}
  else if(name==='users'){showView('viewUsers');renderUsers();}
  else if(name==='activitymonitor'){showView('viewActivityMonitor');renderActivityMonitor();}
  else if(name==='messages'){showView('viewMessages');renderMessaging();}
  else if(name==='labref'){showView('viewLabref');renderCustomLabs();}
  else if(name==='drugguide'){showView('viewDrugguide');nvRenderDrugs();}
  else if(name==='flashcards'){showView('viewFlashcards');nvRenderFcHome();}
  else if(name==='medcalc'){showView('viewMedcalc');}
  else if(name==='studyplanner'){showView('viewStudyplanner');if(typeof nvRenderStudyWeek==='function')nvRenderStudyWeek();}
  else if(name==='skillscheck'){showView('viewSkillscheck');nvRenderSkills();}
  else if(name==='dictionary'){showView('viewDictionary');}
  else if(name==='gpacalc'){showView('viewGpacalc');if(typeof nvRenderGpa==='function')nvRenderGpa();}
  else if(name==='studyprog'){showView('viewStudydash');if(typeof nvRenderStudyDash==='function')nvRenderStudyDash();}
  
  
  
  
  
  
  
  
  closeSidebar();
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(){
  if(!db.results) db.results=[];
  const totalH=db.handouts.length, totalC=db.courses.length, totalCls=db.classes.length, totalU=db.users.length+1;
  const totalR=db.results.length;
  document.getElementById('statsStrip').innerHTML=`
    <div class="stat-box"><div class="stat-lbl">Classes</div><div class="stat-val" style="color:var(--accent)">${totalCls}</div><div class="stat-s">Active programs</div></div>
    <div class="stat-box"><div class="stat-lbl">Courses</div><div class="stat-val" style="color:var(--accent2)">${totalC}</div><div class="stat-s">Across all classes</div></div>
    <div class="stat-box"><div class="stat-lbl">Handouts</div><div class="stat-val" style="color:var(--accent3)">${totalH}</div><div class="stat-s">Total uploaded</div></div>
    <div class="stat-box"><div class="stat-lbl">Results</div><div class="stat-val" style="color:#fbbf24">${totalR}</div><div class="stat-s">Test &amp; exam scores</div></div>
    <div class="stat-box"><div class="stat-lbl">Users</div><div class="stat-val" style="color:var(--accent4)">${totalU}</div><div class="stat-s">Registered accounts</div></div>
  `;
  const grid=document.getElementById('classesGrid');
  grid.innerHTML=db.classes.map((cl,i)=>{
    const c=colorMap[cl.color]||colorMap.blue;
    const courses=db.courses.filter(co=>co.classId===cl.id);
    const handouts=db.handouts.filter(h=>courses.some(co=>co.id===h.courseId));
    return `<div class="class-card" style="--class-color:${c.color};animation-delay:${i*.07}s" onclick="goToClass('${cl.id}')">
      <div class="class-card-top">
        <span class="class-badge" style="background:${c.bg};color:${c.color}">${cl.name}</span>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="class-count">${courses.length} courses</span>
          ${currentRole==='admin'?`<button class="icon-btn" title="Delete class" onclick="event.stopPropagation();confirmDeleteClass('${cl.id}')" style="font-size:11px;color:var(--accent4);padding:2px 5px;">ðŸ—‘</button>`:''}
        </div>
      </div>
      <div class="class-name">${cl.name}</div>
      <div class="class-fullname">${cl.full}</div>
      <div class="class-stats">
        <div class="class-stat"><strong>${courses.length}</strong> Courses</div>
        <div class="class-stat"><strong>${handouts.length}</strong> Notes</div>
      </div>
    </div>`;
  }).join('')+(currentRole==='admin'?`
    <div class="add-class-card" style="animation-delay:${db.classes.length*.07}s" onclick="openModal('addClassModal')">
      <div class="plus">ï¼‹</div><span>Add New Class</span>
    </div>`:'');

  const h=new Date().getHours();
  const greet=h<12?'Good morning':h<18?'Good afternoon':'Good evening';
  const firstName = (currentUser.name||currentUser.username||'there').split(' ')[0];
  document.getElementById('dashTitle').textContent=`${greet}, ${firstName} ðŸ‘‹`;
}

// ============================================================
// CLASS VIEW
// ============================================================
function goToClass(classId){
  currentClassId=classId;
  currentFolderId=null;
  const cl=db.classes.find(c=>c.id===classId);
  const c=colorMap[cl.color];
  showView('viewClass');
  document.querySelectorAll('.class-chip').forEach(ch=>ch.classList.remove('active'));
  const chip=document.getElementById('chip-'+classId);
  if(chip){chip.classList.add('active');chip.style.color=c.color;chip.style.background=c.bg;}
  document.getElementById('classViewTitle').textContent=cl.name;
  document.getElementById('classBc').innerHTML=`
    <span class="bc-item" onclick="navGo('dashboard')">Dashboard</span>
    <span class="bc-sep">â€º</span><span class="bc-current">${cl.name}</span>`;
  document.getElementById('classCoursesTitle').textContent=`${cl.name} â€” Courses`;
  document.getElementById('classCourseSub').textContent=cl.full;
  renderCourses(classId);
}

function renderCourses(classId,filter=''){
  const courses=db.courses.filter(c=>c.classId===classId&&(!filter||c.title.toLowerCase().includes(filter)||c.code.toLowerCase().includes(filter)));
  const cl=db.classes.find(c=>c.id===classId);
  const color=colorMap[cl?.color]?.color||'var(--accent)', bg=colorMap[cl?.color]?.bg||'rgba(62,142,149,.12)';
  const list=document.getElementById('coursesList');
  let html=courses.map((co,i)=>{
    const hCount=db.handouts.filter(h=>h.courseId===co.id).length;
    const fCount=(db.lecturerFolders||[]).filter(f=>f.courseId===co.id).length;
    return `<div class="course-row" style="animation-delay:${i*.05}s" onclick="goToCourse('${co.id}')">
      <div class="course-icon" style="background:${bg};color:${color}">ðŸ“š</div>
      <div class="course-info">
        <div class="course-title">${co.title}</div>
        <div class="course-code">${co.code} Â· ${co.lecturer}${fCount?` Â· ðŸ“ ${fCount} folder${fCount!==1?'s':''}`:''}</div>
      </div>
      <div class="course-meta"><strong>${hCount}</strong> file${hCount!==1?'s':''}</div>
      ${currentRole==='admin'?`<div style="display:flex;gap:6px;flex-shrink:0;" onclick="event.stopPropagation()">
        <button class="icon-btn" title="Edit course" onclick="openEditCourse('${co.id}')" style="font-size:12px;">âœï¸</button>
        <button class="icon-btn" title="Delete course" onclick="confirmDeleteCourse('${co.id}')" style="font-size:12px;color:var(--accent4);">ðŸ—‘</button>
      </div>`:''}
    </div>`;
  }).join('');
  if(!courses.length) html=`<div class="empty"><div class="empty-ico">ðŸ“­</div><div class="empty-t">No courses yet</div><div class="empty-s">Add the first course for this class</div></div>`;
  if(currentRole==='admin') html+=`<div class="add-course-btn" onclick="openAddCourseModal()"><span>ï¼‹</span> Add New Course</div>`;
  list.innerHTML=html;
}

// ============================================================
// COURSE VIEW
// ============================================================
// â”€â”€ Track current folder â”€â”€
let currentFolderId=null;

// â”€â”€ COURSE VIEW: show lecturer folder cards â”€â”€
function goToCourse(courseId){
  currentCourseId=courseId;
  currentFolderId=null;
  const co=db.courses.find(c=>c.id===courseId);
  const cl=db.classes.find(c=>c.id===co.classId);
  showView('viewCourse');
  document.getElementById('courseViewTitle').textContent=co.code;
  document.getElementById('courseBc').innerHTML=`
    <span class="bc-item" onclick="navGo('dashboard')">Dashboard</span>
    <span class="bc-sep">â€º</span>
    <span class="bc-item" onclick="goToClass('${cl.id}')">${cl.name}</span>
    <span class="bc-sep">â€º</span>
    <span class="bc-current">${co.title}</span>`;
  document.getElementById('courseHandoutsTitle').textContent=co.title;
  document.getElementById('courseHandoutSub').textContent=`${co.code} Â· ${co.lecturer} â€” Select a lecturer folder to view notes`;
  renderCourseFolders(courseId);
}

function renderCourseFolders(courseId, filter=''){
  if(!db.lecturerFolders) db.lecturerFolders=[];
  const co=db.courses.find(c=>c.id===courseId);
  const cl=db.classes.find(c=>c.id===co.classId);
  const colorC=colorMap[cl?.color]||colorMap.blue;
  const folders=db.lecturerFolders.filter(f=>f.courseId===courseId&&(!filter||f.lecturerName.toLowerCase().includes(filter.toLowerCase())));
  const list=document.getElementById('courseFoldersList');
  let html='';

  if(folders.length){
    html=`<div class="lf-folder-grid">`;
    folders.forEach((f,i)=>{
      const fCount=db.handouts.filter(h=>h.courseId===courseId&&h.folderId===f.id).length;
      html+=`
        <div class="lf-folder-card" style="animation-delay:${i*.05}s" onclick="goToLecturerFolder('${f.id}')">
          <div class="lf-folder-card-ico" style="background:${colorC.bg};color:${colorC.color}">ðŸ“</div>
          <div class="lf-folder-card-body">
            <div class="lf-folder-card-name">${f.lecturerName}</div>
            <div class="lf-folder-card-meta">${fCount} document${fCount!==1?'s':''} Â· Added ${f.createdAt}</div>
          </div>
          ${currentRole==='admin'?`
          <div class="lf-folder-card-actions" onclick="event.stopPropagation()">
            <button class="icon-btn" title="Rename" onclick="renameLecturerFolder('${f.id}')" style="font-size:13px;">âœï¸</button>
            <button class="icon-btn" title="Delete" onclick="deleteLecturerFolder('${f.id}')" style="font-size:13px;color:var(--accent4);">ðŸ—‘</button>
          </div>`:''}
        </div>`;
    });
    html+=`</div>`;
  } else {
    html=`<div class="empty">
      <div class="empty-ico">ðŸ“‚</div>
      <div class="empty-t">No lecturer folders yet</div>
      <div class="empty-s">${currentRole==='admin'?'Click "Add Folder" to create a folder for each lecturer':'Your admin has not created any folders for this course yet'}</div>
    </div>`;
  }

  if(currentRole==='admin'){
    html+=`<div class="add-handout-btn" style="margin-top:18px;color:var(--accent2);border-color:rgba(90,173,160,.3);background:rgba(90,173,160,.07);" onclick="openAddLecturerFolderFromCourse()"><span>ðŸ“</span> Add Lecturer Folder</div>`;
  }
  list.innerHTML=html;
}

function openAddLecturerFolderFromCourse(){
  openAddLecturerFolder(currentCourseId);
}

function searchCourseFolders(q){
  if(currentCourseId) renderCourseFolders(currentCourseId, q);
}

// â”€â”€ LECTURER FOLDER VIEW: show documents inside folder â”€â”€
function goToLecturerFolder(folderId){
  currentFolderId=folderId;
  if(!db.lecturerFolders) db.lecturerFolders=[];
  const f=db.lecturerFolders.find(x=>x.id===folderId);
  if(!f) return;
  const co=db.courses.find(c=>c.id===f.courseId);
  const cl=db.classes.find(c=>c.id===co.classId);
  currentCourseId=co.id;
  // Pre-set folder context for uploads
  window._addHandoutFolderId=folderId;
  window._addHandoutFolderLecturer=f.lecturerName;
  showView('viewLecturerFolder');
  document.getElementById('lfViewTitle').textContent=f.lecturerName;
  document.getElementById('lfBc').innerHTML=`
    <span class="bc-item" onclick="navGo('dashboard')">Dashboard</span>
    <span class="bc-sep">â€º</span>
    <span class="bc-item" onclick="goToClass('${cl.id}')">${cl.name}</span>
    <span class="bc-sep">â€º</span>
    <span class="bc-item" onclick="goToCourse('${co.id}')">${co.title}</span>
    <span class="bc-sep">â€º</span>
    <span class="bc-current">ðŸ“ ${f.lecturerName}</span>`;
  document.getElementById('lfDocTitle').textContent=`ðŸ“ ${f.lecturerName}`;
  document.getElementById('lfDocSub').textContent=`${co.code} Â· ${co.title}`;
  renderHandouts(folderId, '');
}

function searchFolderDocs(q){
  if(currentFolderId) renderHandouts(currentFolderId, q.toLowerCase());
}

// â”€â”€ HANDOUTS: render documents for a specific folder â”€â”€
function renderHandouts(folderId, filter=''){
  const f=(db.lecturerFolders||[]).find(x=>x.id===folderId);
  const courseId=f?f.courseId:currentCourseId;
  const handouts=db.handouts.filter(h=>h.courseId===courseId&&h.folderId===folderId&&(!filter||h.title.toLowerCase().includes(filter)));
  const list=document.getElementById('handoutsList');
  let html='';

  if(handouts.length){
    html=handouts.map((h,i)=>`
      <div class="handout-row" style="animation-delay:${i*.05}s" onclick="openPreview('${h.id}')">
        <div class="file-badge fb-${h.type}">${h.type.toUpperCase()}</div>
        <div style="width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;background:${fileBg[h.type]};flex-shrink:0">${fileIco[h.type]}</div>
        <div class="handout-info">
          <div class="handout-title">${h.title}</div>
          <div class="handout-teacher">${h.lecturer||f?.lecturerName||''}</div>
        </div>
        <div class="handout-date">${h.date}</div>
        <div class="handout-actions">
          <div class="icon-btn" title="Preview" onclick="event.stopPropagation();openPreview('${h.id}')">ðŸ‘</div>
          ${currentRole==='admin'?`<div class="icon-btn" title="Delete" onclick="event.stopPropagation();deleteHandout('${h.id}')">ðŸ—‘</div>`:''}
        </div>
      </div>`).join('');
  } else {
    html=`<div class="empty">
      <div class="empty-ico">ðŸ“„</div>
      <div class="empty-t">No documents yet</div>
      <div class="empty-s">${currentRole==='admin'?'Upload notes and files for this lecturer':'No documents have been uploaded for this folder yet'}</div>
    </div>`;
  }

  if(currentRole==='admin'){
    html+=`<div class="add-handout-btn" style="margin-top:18px;" onclick="openAddHandoutModal()"><span>ðŸ“Ž</span> Upload Document</div>`;
  }
  list.innerHTML=html;
}

// â”€â”€ Lecturer folder toggle â”€â”€
function toggleLecturerFolder(fid){
  const body=document.getElementById('lffbody_'+fid);
  const chev=document.getElementById('lffchev_'+fid);
  if(!body) return;
  const isOpen=body.style.display!=='none';
  body.style.display=isOpen?'none':'';
  if(chev) chev.style.transform=isOpen?'':'rotate(90deg)';
}

// â”€â”€ Add Lecturer Folder â”€â”€
function openAddLecturerFolder(courseId){
  const name=prompt('Enter lecturer name for this folder:\n(You can rename it later if the lecturer changes)');
  if(!name||!name.trim()) return;
  if(!db.lecturerFolders) db.lecturerFolders=[];
  db.lecturerFolders.push({
    id:'lf_'+Date.now(),
    courseId,
    lecturerName:name.trim(),
    createdBy:currentUser.name||'Admin',
    createdAt:new Date().toLocaleDateString()
  });
  saveDB();
  // Refresh the course folders view if we're on it
  if(document.getElementById('courseFoldersList')) renderCourseFolders(courseId);
  logActivity('add_folder', `Folder "${name.trim()}" created for course ${courseId}`);
  toast(`Folder "${name.trim()}" created âœ“`);
}

// â”€â”€ Rename Lecturer Folder â”€â”€
function renameLecturerFolder(fid){
  const f=db.lecturerFolders.find(x=>x.id===fid);
  if(!f) return;
  const newName=prompt(`Rename folder â€” enter new lecturer name:\n(Current: ${f.lecturerName})`,f.lecturerName);
  if(!newName||!newName.trim()) return;
  const old=f.lecturerName;
  f.lecturerName=newName.trim();
  // Also update all handouts in this folder to reflect new lecturer name
  db.handouts.filter(h=>h.folderId===fid).forEach(h=>h.lecturer=newName.trim());
  saveDB();
  // Refresh whichever view is active
  if(currentFolderId===fid){
    document.getElementById('lfViewTitle').textContent=newName.trim();
    document.getElementById('lfDocTitle').textContent=`ðŸ“ ${newName.trim()}`;
    renderHandouts(fid);
  } else {
    renderCourseFolders(f.courseId);
  }
  logActivity('rename_folder', `Folder renamed from "${old}" to "${newName.trim()}"`);
  toast(`Folder renamed to "${newName.trim()}" âœ“`);
}

// â”€â”€ Delete Lecturer Folder â”€â”€
function deleteLecturerFolder(fid){
  const f=db.lecturerFolders.find(x=>x.id===fid);
  if(!f) return;
  const hCount=db.handouts.filter(h=>h.folderId===fid).length;
  const msg=hCount>0
    ?`Delete folder "${f.lecturerName}"? The ${hCount} file(s) inside will also be deleted.`
    :`Delete empty folder "${f.lecturerName}"?`;
  if(!confirm(msg)) return;
  const cid=f.courseId;
  // Remove handouts inside this folder
  db.handouts=db.handouts.filter(h=>h.folderId!==fid);
  db.lecturerFolders=db.lecturerFolders.filter(x=>x.id!==fid);
  saveDB();
  logActivity('delete_folder', `Folder "${f.lecturerName}" deleted`);
  toast('Folder deleted');
  // Navigate back to course view
  goToCourse(cid);
}

// â”€â”€ Add Handout to specific folder â”€â”€
function openAddHandoutToFolder(folderId){
  const f=db.lecturerFolders.find(x=>x.id===folderId);
  if(!f) return;
  // Reuse existing add handout modal, but tag folder
  window._addHandoutFolderId=folderId;
  window._addHandoutFolderLecturer=f.lecturerName;
  openAddHandoutModal();
}

// ============================================================
// ALL HANDOUTS
// ============================================================
function renderAllHandouts(handouts){
  const list=document.getElementById('allHandoutsList');
  let html=handouts.map((h,i)=>{
    const co=db.courses.find(c=>c.id===h.courseId)||{title:'Unknown',classId:''};
    const cl=db.classes.find(c=>c.id===co.classId)||{name:'',color:'blue'};
    const cc=colorMap[cl.color]||colorMap.blue;
    return `<div class="handout-row" style="animation-delay:${i*.03}s" onclick="openPreview('${h.id}')">
      <div class="file-badge fb-${h.type}">${h.type.toUpperCase()}</div>
      <div style="width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;background:${fileBg[h.type]};flex-shrink:0">${fileIco[h.type]}</div>
      <div class="handout-info">
        <div class="handout-title">${h.title}</div>
        <div class="handout-teacher">${co.title} Â· <span style="color:${cc.color}">${cl.name}</span></div>
      </div>
      <div class="handout-date">${h.date}</div>
      <div class="handout-actions"><div class="icon-btn" onclick="event.stopPropagation();openPreview('${h.id}')">ðŸ‘</div></div>
    </div>`;
  }).join('');
  if(!handouts.length) html=`<div class="empty"><div class="empty-ico">ðŸ“­</div><div class="empty-t">No handouts found</div><div class="empty-s">Handouts will appear here once uploaded</div></div>`;
  list.innerHTML=html;
}

// ============================================================
// USERS (admin)
// ============================================================
// â”€â”€ Avatar helpers â”€â”€
function avatarHtml(user, size=56){
  if(!user) return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:${Math.round(size*.4)}px;font-weight:700;color:white;">?</div>`;
  if(user.avatar){
    return `<img src="${user.avatar}" style="width:${size}px;height:${size}px;border-radius:50%;object-fit:cover;border:2px solid var(--border);" onerror="this.style.display='none'">`;
  }
  const initials = (user.name||user.username||'?')[0].toUpperCase();
  const roleGrad = user.role==='admin'?'#fbbf24,#f59e0b':user.role==='teacher'?'var(--accent),var(--accent2)':'var(--accent3),#3E8E95';
  return `<div style="width:${size}px;height:${size}px;border-radius:50%;background:linear-gradient(135deg,${roleGrad});display:flex;align-items:center;justify-content:center;font-size:${Math.round(size*.38)}px;font-weight:700;color:white;flex-shrink:0;">${initials}</div>`;
}

function updateSidebarAvatar(){
  const av = document.getElementById('sidebarAv');
  if(!av) return;
  if(currentUser.avatar){
    av.innerHTML=`<img src="${currentUser.avatar}" class="user-av-img" onerror="this.parentElement.textContent='${(currentUser.name||'?')[0].toUpperCase()}'">`;
  } else {
    av.innerHTML=(currentUser.name||currentUser.username||'?')[0].toUpperCase();
  }
}

function renderUsers(){
  const search=(document.getElementById('userSearch')?.value||'').toLowerCase();
  const roleFilter=(document.getElementById('userRoleFilter')?.value||'');
  const classFilter=(document.getElementById('userClassFilter')?.value||'');

  // Populate class filter dropdown (once)
  const clSel=document.getElementById('userClassFilter');
  if(clSel && clSel.options.length<=1){
    (db.classes||[]).forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c.id; opt.textContent=c.name;
      clSel.appendChild(opt);
    });
    if(classFilter) clSel.value=classFilter;
  }

  const adminUser={id:'admin',name:ADMIN_NAME,username:ADMIN_USERNAME,role:'admin',cls:'All',isAdmin:true,
    avatar: db.adminAvatar||null, phone: db.adminPhone||'', matric:''};
  let all=[adminUser,...(db.users||[])];

  // Apply filters
  if(roleFilter) all=all.filter(u=>u.role===roleFilter);
  if(classFilter) all=all.filter(u=>u.classId===classFilter||u.id==='admin');
  if(search) all=all.filter(u=>
    (u.name||'').toLowerCase().includes(search)||
    (u.username||'').toLowerCase().includes(search)||
    (u.matric||'').toLowerCase().includes(search)||
    (u.role||'').toLowerCase().includes(search)
  );

  // Update count badge
  const badge=document.getElementById('userCountBadge');
  if(badge) badge.textContent=`(${all.length} shown Â· ${(db.users||[]).length+1} total)`;

  const roleColor={admin:'#fbbf24',teacher:'var(--accent)',student:'var(--accent3)'};
  const roleBg={admin:'rgba(251,191,36,.12)',teacher:'rgba(62,142,149,.12)',student:'rgba(90,173,160,.12)'};

  const grid = document.getElementById('usersGrid');
  if(!grid) return;
  if(!all.length){
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text3);font-family:'DM Mono',monospace;font-size:13px;">No users match your filters.</div>`;
    return;
  }
  grid.innerHTML = all.map((u,i)=>{
    const cl = (db.classes||[]).find(c=>c.id===u.classId);
    return `<div class="user-card role-${u.role}" style="animation-delay:${Math.min(i,20)*.03}s">
      <div class="user-card-head">
        <div class="user-card-avatar">${avatarHtml(u,56)}</div>
        <div class="user-card-info">
          <div class="user-card-name">${escHtml(u.name||u.username)}${u.isAdmin?'<span class="admin-crown">ðŸ‘‘</span>':''}</div>
          <div class="user-card-role" style="color:${roleColor[u.role]||'var(--text2)'}">
            <span style="background:${roleBg[u.role]};padding:2px 8px;border-radius:5px;">${u.role}</span>
          </div>
        </div>
      </div>
      <div class="user-card-meta">
        <div class="user-card-field">
          <div class="user-card-field-lbl">Username</div>
          <div class="user-card-field-val">${escHtml(u.username||'â€”')}</div>
        </div>
        <div class="user-card-field">
          <div class="user-card-field-lbl">Class</div>
          <div class="user-card-field-val">${cl?escHtml(cl.name):u.cls||'â€”'}</div>
        </div>
        <div class="user-card-field">
          <div class="user-card-field-lbl">Matric No.</div>
          <div class="user-card-field-val" style="font-size:10px;">${escHtml(u.matric||'â€”')}</div>
        </div>
        <div class="user-card-field">
          <div class="user-card-field-lbl">Password</div>
          <div class="user-card-field-val" style="letter-spacing:.05em;display:flex;align-items:center;gap:6px;">
            ${u.isAdmin
              ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'
              : `<span class="pwd-mask" id="pwd-${u.id}">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                 <button type="button" title="Show/hide password"
                   style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:13px;padding:0;line-height:1;flex-shrink:0;"
                   onclick="(function(btn){
                     var s=document.getElementById('pwd-${u.id}');
                     if(s.dataset.vis==='1'){s.textContent='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';s.dataset.vis='0';btn.textContent='ðŸ‘';}
                     else{s.textContent='${escHtml(u.password||'')}';s.dataset.vis='1';btn.textContent='ðŸ™ˆ';}
                   })(this)">ðŸ‘</button>`
            }
          </div>
        </div>
        ${u.role==='student'&&(u.svc||u.bia||u.rrr)?`
        <div class="user-card-field" style="grid-column:1/-1;border-top:1px solid var(--border);padding-top:8px;margin-top:4px;">
          <div class="user-card-field-lbl">SVC / BIA / RRR</div>
          <div class="user-card-field-val" style="font-size:10px;font-family:'DM Mono',monospace;">${[u.svc,u.bia,u.rrr].filter(Boolean).join(' Â· ')}</div>
        </div>`:''}
      </div>
      <div class="user-card-actions">
        <button class="btn-action" onclick="openEditUser('${u.id}')" style="flex:1;padding:8px;font-size:11px;">âœï¸ Edit</button>
        ${!u.isAdmin?`<button class="icon-btn" title="Remove" onclick="confirmDeleteUser('${u.id}')" style="color:var(--accent4);">ðŸ—‘</button>`:''}
      </div>
    </div>`;
  }).join('');
}

function toggleAllPasswords(){
  const btn=document.getElementById('revealAllPwdBtn');
  const spans=document.querySelectorAll('.pwd-mask');
  const allRevealed=[...spans].every(s=>s.dataset.vis==='1');
  spans.forEach(s=>{
    const uid=s.id.replace('pwd-','');
    const u=db.users.find(x=>x.id===uid);
    if(!u) return;
    if(allRevealed){s.textContent='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';s.dataset.vis='0';}
    else{s.textContent=u.password||'';s.dataset.vis='1';}
  });
  // update individual eye buttons
  document.querySelectorAll('.pwd-mask').forEach(s=>{
    const sib=s.nextElementSibling;
    if(sib) sib.textContent=s.dataset.vis==='1'?'ðŸ™ˆ':'ðŸ‘';
  });
  btn.textContent=allRevealed?'ðŸ‘ Reveal All Passwords':'ðŸ™ˆ Hide All Passwords';
}

function confirmDeleteUser(id){
  if(!id) return;
  if(!confirm('Remove this user account? This cannot be undone.')) return;
  db.users=db.users.filter(u=>u.id!==id);
  saveDB(); renderUsers(); closeModal('editUserModal'); toast('User removed');
}

// â”€â”€ OPEN EDIT USER (admin) â”€â”€
function openEditUser(uid){
  let u;
  if(uid==='admin'){
    u={id:'admin',name:ADMIN_NAME,username:ADMIN_USERNAME,role:'admin',cls:'All',isAdmin:true,
       avatar:db.adminAvatar||null,phone:db.adminPhone||'',matric:''};
  } else {
    u=db.users.find(x=>x.id===uid);
  }
  if(!u){toast('User not found');return;}
  document.getElementById('editUserId').value=uid;
  document.getElementById('editUserName').value=u.name||'';
  document.getElementById('editUserPhone').value=u.phone||'';
  document.getElementById('editUserMatric').value=u.matric||'';
  document.getElementById('editUserUsername').value=u.username||'';
  document.getElementById('editUserPass').value='';
  // New fields
  document.getElementById('editUserDob').value=u.dob||'';
  document.getElementById('editUserSex').value=u.sex||'';
  document.getElementById('editUserSvc').value=u.svc||'';
  document.getElementById('editUserRank').value=u.rank||'';
  document.getElementById('editUserBia').value=u.bia||'';
  document.getElementById('editUserRrr').value=u.rrr||'';
  document.getElementById('editUserRnIndex').value=u.rnIndex||'';
  document.getElementById('editUserRmIndex').value=u.rmIndex||'';
  // Class select
  const clSel=document.getElementById('editUserClass');
  clSel.innerHTML='<option value="">â€” None â€”</option>'+db.classes.map(c=>`<option value="${c.id}"${c.id===u.classId?' selected':''}>${c.name}</option>`).join('');
  // Show/hide matric field
  document.getElementById('editMatricWrap').style.display=u.role==='student'?'':'none';
  // Avatar
  const av=document.getElementById('editUserAv');
  if(u.avatar) av.innerHTML=`<img src="${u.avatar}" class="user-av-img">`;
  else av.innerHTML=(u.name||u.username||'?')[0].toUpperCase();
  av.dataset.avatar=u.avatar||'';
  openModal('editUserModal');
}

function saveEditUser(){
  const uid=document.getElementById('editUserId').value;
  const name=document.getElementById('editUserName').value.trim();
  const phone=document.getElementById('editUserPhone').value.trim();
  const matric=document.getElementById('editUserMatric').value.trim().toUpperCase();
  const username=document.getElementById('editUserUsername').value.trim().toLowerCase();
  const pass=document.getElementById('editUserPass').value.trim();
  const classId=document.getElementById('editUserClass').value;
  const avatar=document.getElementById('editUserAv').dataset.avatar||'';

  if(!name) return toast('Name is required');

  if(uid==='admin'){
    // Update admin info in db
    db.adminPhone=phone;
    db.adminAvatar=avatar;
    // Update currentUser if this is the admin
    if(currentRole==='admin'){
      currentUser.phone=phone;
      currentUser.avatar=avatar;
      currentUser.name=name;
      document.getElementById('sidebarNm').textContent=name;
      updateSidebarAvatar();
    }
  } else {
    const u=db.users.find(x=>x.id===uid);
    if(!u){toast('User not found');return;}
    // Check username uniqueness
    if(username!==u.username&&db.users.find(x=>x.id!==uid&&(x.username||'').toLowerCase()===username)){
      return toast('Username already taken by another user');
    }
    u.name=name;
    u.phone=phone;
    u.matric=matric;
    u.username=username||u.username;
    if(pass) u.password=pass;
    u.classId=classId||u.classId;
    u.avatar=avatar;
    // Save new fields
    u.dob     = document.getElementById('editUserDob').value.trim();
    u.sex     = document.getElementById('editUserSex').value;
    u.svc     = document.getElementById('editUserSvc').value.trim().toUpperCase();
    u.rank    = document.getElementById('editUserRank').value.trim().toUpperCase();
    u.bia     = document.getElementById('editUserBia').value.trim().toUpperCase();
    u.rrr     = document.getElementById('editUserRrr').value.trim();
    u.rnIndex = document.getElementById('editUserRnIndex').value.trim();
    u.rmIndex = document.getElementById('editUserRmIndex').value.trim();
    const cl=db.classes.find(c=>c.id===u.classId);
    u.cls=cl?cl.name:'â€”';
    // If editing self
    if(uid===currentUser.id){
      currentUser.name=name;currentUser.phone=phone;
      currentUser.matric=matric;currentUser.avatar=avatar;
      document.getElementById('sidebarNm').textContent=name;
      updateSidebarAvatar();
    }
  }
  saveDB();
  renderUsers();
  closeModal('editUserModal');
  toast('Profile updated âœ“');
}

// â”€â”€ AVATAR UPLOAD â”€â”€
function handleAvatarUpload(inp, target){
  const file=inp.files[0];
  if(!file) return;
  if(file.size>2*1024*1024){toast('Image must be under 2MB');return;}
  const reader=new FileReader();
  reader.onload=e=>{
    const dataUrl=e.target.result;
    if(target==='me'){
      document.getElementById('myProfileAv').innerHTML=`<img src="${dataUrl}" class="user-av-img">`;
      document.getElementById('myProfileAv').dataset.avatar=dataUrl;
    } else {
      document.getElementById('editUserAv').innerHTML=`<img src="${dataUrl}" class="user-av-img">`;
      document.getElementById('editUserAv').dataset.avatar=dataUrl;
    }
  };
  reader.readAsDataURL(file);
}

// â”€â”€ MY PROFILE â”€â”€
function openMyProfile(){
  const u=currentUser;
  // Avatar
  const av=document.getElementById('myProfileAv');
  if(u.avatar) av.innerHTML=`<img src="${u.avatar}" class="user-av-img">`;
  else av.innerHTML=(u.name||u.username||'?')[0].toUpperCase();
  av.dataset.avatar=u.avatar||'';
  // Fields
  document.getElementById('myProfileName').value=u.name||'';
  document.getElementById('myProfilePhone').value=u.phone||'';
  document.getElementById('myProfileMatric').value=u.matric||'';
  document.getElementById('myProfileUsername').value=u.username||'';
  document.getElementById('myProfileNewPass').value='';
  document.getElementById('myProfileConfPass').value='';
  // Role badge
  const roleColor={admin:'#fbbf24',teacher:'var(--accent)',student:'var(--accent3)'};
  document.getElementById('myProfileRoleBadge').innerHTML=`<span class="role-badge-lg" style="background:${currentRole==='admin'?'rgba(251,191,36,.15)':currentRole==='teacher'?'rgba(62,142,149,.15)':'rgba(90,173,160,.15)'};color:${roleColor[currentRole]||'var(--text2)'}">${currentRole}</span>`;
  // Show matric only for students
  document.getElementById('myMatricWrap').style.display=currentRole==='student'?'':'none';
  // Professional IDs (show for students only)
  const showProfIds = currentRole==='student';
  document.getElementById('myProfIdSection').style.display=showProfIds?'':'none';
  document.getElementById('myProfIdFields').style.display=showProfIds?'':'none';
  document.getElementById('myDocVaultSection').style.display='';
  if(showProfIds){
    document.getElementById('myProfileBIA').value=u.bia||'';
    document.getElementById('myProfileRNIndex').value=u.rnIndex||'';
    document.getElementById('myProfileRMIndex').value=u.rmIndex||'';
    document.getElementById('myProfileRNExam').value=u.rnExam||'';
    document.getElementById('myProfileRMExam').value=u.rmExam||'';
  }
  // Document vault
  renderMyDocVault();
  openModal('myProfileModal');
}

function saveMyProfile(){
  const name=document.getElementById('myProfileName').value.trim();
  const phone=document.getElementById('myProfilePhone').value.trim();
  const matric=document.getElementById('myProfileMatric').value.trim().toUpperCase();
  const newPass=document.getElementById('myProfileNewPass').value;
  const confPass=document.getElementById('myProfileConfPass').value;
  const avatar=document.getElementById('myProfileAv').dataset.avatar||'';

  if(!name) return toast('Name cannot be empty');
  if(newPass&&newPass!==confPass) return toast('Passwords do not match');
  if(newPass&&newPass.length<4) return toast('Password must be at least 4 characters');

  if(currentRole==='admin'){
    db.adminPhone=phone;
    db.adminAvatar=avatar;
    currentUser.phone=phone;
    currentUser.avatar=avatar;
    currentUser.name=name;
  } else {
    const u=db.users.find(x=>x.id===currentUser.id);
    if(u){
      u.name=name; u.phone=phone; u.matric=matric; u.avatar=avatar;
      if(newPass) u.password=newPass;
      // Professional IDs (students)
      if(currentRole==='student'){
        u.bia=document.getElementById('myProfileBIA').value.trim().toUpperCase();
        u.rnIndex=document.getElementById('myProfileRNIndex').value.trim().toUpperCase();
        u.rmIndex=document.getElementById('myProfileRMIndex').value.trim().toUpperCase();
        u.rnExam=document.getElementById('myProfileRNExam').value.trim().toUpperCase();
        u.rmExam=document.getElementById('myProfileRMExam').value.trim().toUpperCase();
        currentUser.bia=u.bia; currentUser.rnIndex=u.rnIndex;
        currentUser.rmIndex=u.rmIndex; currentUser.rnExam=u.rnExam; currentUser.rmExam=u.rmExam;
      }
      currentUser.name=name; currentUser.phone=phone;
      currentUser.matric=matric; currentUser.avatar=avatar;
    }
  }
  saveDB();
  document.getElementById('sidebarNm').textContent=name;
  updateSidebarAvatar();
  closeModal('myProfileModal');
  toast('Profile saved âœ“');
}

function removeUser(id){
  confirmDeleteUser(id);
}



// ============================================================
// ACTIVITY MONITOR (admin only)
// ============================================================
function renderActivityMonitor(){
  if(!db.activityLogs) db.activityLogs=[];
  // Populate class filter
  const clSel=document.getElementById('actFilterClass');
  if(clSel && clSel.options.length<=1){
    db.classes.forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c.id; opt.textContent=c.name;
      clSel.appendChild(opt);
    });
  }

  const roleFilter=(document.getElementById('actFilterRole')?.value||'');
  const classFilter=(document.getElementById('actFilterClass')?.value||'');
  const search=(document.getElementById('actSearch')?.value||'').toLowerCase();

  // Stats
  const today=new Date().toDateString();
  const todayLogs=db.activityLogs.filter(l=>new Date(l.timestamp).toDateString()===today);
  const uniqueUsersToday=new Set(todayLogs.map(l=>l.userId)).size;
  const loginsTodayCount=todayLogs.filter(l=>l.action==='login').length;
  const uploadsTotal=db.activityLogs.filter(l=>l.action==='upload_note').length;
  const activeStudents=(db.users||[]).filter(u=>u.role==='student').length;

  const statsEl=document.getElementById('activityStatsStrip');
  if(statsEl) statsEl.innerHTML=`
    <div class="stat-box"><div class="stat-lbl">Logins Today</div><div class="stat-val" style="color:var(--accent)">${loginsTodayCount}</div><div class="stat-s">User sessions</div></div>
    <div class="stat-box"><div class="stat-lbl">Active Today</div><div class="stat-val" style="color:var(--accent3)">${uniqueUsersToday}</div><div class="stat-s">Unique users</div></div>
    <div class="stat-box"><div class="stat-lbl">Total Uploads</div><div class="stat-val" style="color:var(--accent2)">${uploadsTotal}</div><div class="stat-s">Notes/files uploaded</div></div>
    <div class="stat-box"><div class="stat-lbl">Total Students</div><div class="stat-val" style="color:#fbbf24">${activeStudents}</div><div class="stat-s">Registered</div></div>
    <div class="stat-box"><div class="stat-lbl">Log Entries</div><div class="stat-val" style="color:var(--accent4)">${db.activityLogs.length}</div><div class="stat-s">All time</div></div>
  `;

  let logs=db.activityLogs;
  if(roleFilter) logs=logs.filter(l=>l.role===roleFilter);
  if(classFilter) logs=logs.filter(l=>l.classId===classFilter);
  if(search) logs=logs.filter(l=>(l.userName||'').toLowerCase().includes(search)||(l.action||'').toLowerCase().includes(search)||(l.detail||'').toLowerCase().includes(search));

  const actionColors={
    login:'rgba(90,173,160,.12)',
    upload_note:'rgba(62,142,149,.12)',
    add_folder:'rgba(90,173,160,.12)',
    rename_folder:'rgba(251,191,36,.12)',
    delete_folder:'rgba(224,123,123,.12)',
    add_class:'rgba(90,173,160,.12)',
    add_course:'rgba(62,142,149,.12)',
  };
  const actionIcons={
    login:'ðŸ”‘',upload_note:'ðŸ“Ž',add_folder:'ðŸ“',rename_folder:'âœï¸',
    delete_folder:'ðŸ—‘',add_class:'ðŸ«',add_course:'ðŸ“š',
  };
  const roleColor={admin:'#fbbf24',teacher:'var(--accent)',student:'var(--accent3)'};

  const listEl=document.getElementById('activityLogList');
  if(!listEl) return;
  if(!logs.length){
    listEl.innerHTML=`<div class="empty"><div class="empty-ico">ðŸ“¡</div><div class="empty-t">No activity logs</div><div class="empty-s">User actions will appear here as they happen</div></div>`;
    return;
  }

  listEl.innerHTML=logs.slice(0,500).map((l,i)=>{
    const d=new Date(l.timestamp);
    const timeStr=d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
    const dateStr=d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
    const initials=(l.userName||'?')[0].toUpperCase();
    const cl=db.classes.find(c=>c.id===l.classId);
    const ic=actionIcons[l.action]||'â—';
    const bg=actionColors[l.action]||'rgba(100,180,255,.06)';
    return `<div style="display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);animation:fadeUp .3s ease ${i*.02}s both;">
      <div style="width:36px;height:36px;border-radius:50%;background:${roleColor[l.role]||'var(--accent)'}22;color:${roleColor[l.role]||'var(--accent)'};display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;">${initials}</div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span style="font-size:13px;font-weight:600;">${l.userName||'Unknown'}</span>
          <span style="font-size:10px;font-family:'DM Mono',monospace;padding:1px 7px;border-radius:10px;background:${roleColor[l.role]||'var(--accent)'}22;color:${roleColor[l.role]||'var(--accent)'}">${l.role}</span>
          ${cl?`<span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3)">${cl.name}</span>`:''}
        </div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
          <span style="font-size:15px;">${ic}</span>
          <span style="font-size:12px;font-family:'DM Mono',monospace;padding:2px 8px;border-radius:6px;background:${bg};color:var(--text2);">${(l.action||'unknown').replace(/_/g,' ')}</span>
          ${l.detail?`<span style="font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:300px;">${l.detail}</span>`:''}
        </div>
      </div>
      <div style="flex-shrink:0;text-align:right;">
        <div style="font-size:11px;font-family:'DM Mono',monospace;color:var(--text3);">${timeStr}</div>
        <div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);">${dateStr}</div>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// TIMETABLE SYSTEM
// ============================================================
const DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const DAY_SHORT=['Mon','Tue','Wed','Thu','Fri','Sat'];
const COLORS_CYCLE=['#3E8E95','#BFD2C5','#5aada0','#fb923c','#e07b7b','#a78bfa','#fbbf24','#2dd4bf'];

function ttTimeToMinutes(t){
  if(!t) return 0;
  // Handle HH:MM (24hr from <input type="time">)
  if(/^\d{1,2}:\d{2}$/.test(t)){
    const [h,m]=t.split(':').map(Number);
    return h*60+m;
  }
  // Handle "8:00 AM" / "10:30 PM"
  const m=t.match(/(\d+):(\d+)\s*(AM|PM)/i);
  if(m){
    let h=parseInt(m[1]), min=parseInt(m[2]);
    if(m[3].toUpperCase()==='PM'&&h!==12) h+=12;
    if(m[3].toUpperCase()==='AM'&&h===12) h=0;
    return h*60+min;
  }
  return 0;
}

function ttFormatTime(t){
  if(!t) return '';
  if(/^\d{1,2}:\d{2}$/.test(t)){
    const [h,m]=t.split(':').map(Number);
    const ampm=h>=12?'PM':'AM';
    const h12=h%12||12;
    return `${h12}:${m.toString().padStart(2,'0')} ${ampm}`;
  }
  return t;
}

function renderTimetable(){
  if(!db.timetable) db.timetable=[];
  // Populate class filter
  const clSel=document.getElementById('ttFilterClass');
  if(clSel){
    const cur=clSel.value;
    clSel.innerHTML='<option value="">All Classes</option>';
    db.classes.forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c.id; opt.textContent=c.name;
      clSel.appendChild(opt);
    });
    clSel.value=cur;
  }

  const filterClass=clSel?.value||'';
  let entries=db.timetable;
  if(filterClass) entries=entries.filter(e=>e.classId===filterClass);
  // Students see only their class
  if(currentRole==='student'&&currentUser.classId){
    entries=entries.filter(e=>e.classId===currentUser.classId);
  }

  const grid=document.getElementById('ttGrid');
  if(!grid) return;

  if(!entries.length){
    grid.innerHTML=`<div class="empty"><div class="empty-ico">ðŸ“…</div><div class="empty-t">No timetable entries yet</div><div class="empty-s">${currentRole==='admin'?'Upload a timetable file or add entries manually':'The admin has not uploaded a timetable yet'}</div></div>`;
    return;
  }

  // Build weekly grid grouped by day
  let html=`<div style="overflow-x:auto;"><table class="tt-table"><thead><tr>
    <th style="min-width:90px;">Time</th>
    <th style="min-width:80px;">Course</th>
    <th style="min-width:80px;">Class</th>
    <th style="min-width:80px;">Lecturer</th>
    <th style="min-width:80px;">Venue</th>
    <th style="min-width:80px;">Day</th>
    ${currentRole==='admin'?'<th style="min-width:80px;">Actions</th>':''}
  </tr></thead><tbody>`;

  // Sort by day then start time
  const dayOrder={Monday:0,Tuesday:1,Wednesday:2,Thursday:3,Friday:4,Saturday:5};
  const sorted=[...entries].sort((a,b)=>{
    const dd=(dayOrder[a.day]||0)-(dayOrder[b.day]||0);
    if(dd!==0) return dd;
    return ttTimeToMinutes(a.startTime)-ttTimeToMinutes(b.startTime);
  });

  let lastDay='';
  sorted.forEach((e,i)=>{
    const co=db.courses.find(c=>c.id===e.courseId)||{title:e.courseTitle||'â€”',code:e.courseCode||'â€”',lecturer:e.lecturer||'â€”'};
    const cl=db.classes.find(c=>c.id===e.classId)||{name:e.className||'â€”',color:'blue'};
    const cc=colorMap[cl.color]||colorMap.blue;
    const rowColor=COLORS_CYCLE[i%COLORS_CYCLE.length];
    const dayRow=lastDay!==e.day;
    lastDay=e.day;
    if(dayRow){
      html+=`<tr><td colspan="${currentRole==='admin'?7:6}" style="background:var(--bg3);padding:8px 16px;font-family:'Syne',sans-serif;font-weight:700;font-size:12px;color:var(--text3);letter-spacing:.06em;text-transform:uppercase;">${e.day}</td></tr>`;
    }
    html+=`<tr style="animation:fadeUp .3s ease ${i*.03}s both;">
      <td><span style="font-family:'DM Mono',monospace;font-size:12px;color:var(--text2);">${ttFormatTime(e.startTime)} â€“ ${ttFormatTime(e.endTime)}</span></td>
      <td><div style="font-weight:700;font-size:13px;">${co.title}</div><div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">${co.code}</div></td>
      <td><span style="padding:2px 10px;border-radius:20px;font-size:11px;font-weight:700;background:${cc.bg};color:${cc.color};font-family:'DM Mono',monospace;">${cl.name}</span></td>
      <td style="font-size:12px;color:var(--text2);">${co.lecturer}</td>
      <td style="font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;">${e.venue||'â€”'}</td>
      <td style="font-size:12px;color:var(--text3);">${e.day}</td>
      ${currentRole==='admin'?`<td><div style="display:flex;gap:6px;">
        <button class="icon-btn" onclick="openEditTimetableRow('${e.id}')" title="Edit">âœï¸</button>
        <button class="icon-btn" onclick="deleteTimetableRow('${e.id}')" title="Delete" style="color:var(--accent4);">ðŸ—‘</button>
      </div></td>`:''}
    </tr>`;
  });

  html+=`</tbody></table></div>`;
  grid.innerHTML=html;

  // Show today's upcoming classes strip
  renderTodayStrip(entries);
}

function renderTodayStrip(entries){
  const strip=document.getElementById('ttTodayStrip');
  if(!strip) return;
  const now=new Date();
  const todayName=DAYS[now.getDay()===0?6:now.getDay()-1]||'';
  const nowMin=now.getHours()*60+now.getMinutes();
  const todayEntries=entries.filter(e=>e.day===todayName&&ttTimeToMinutes(e.startTime)>nowMin).sort((a,b)=>ttTimeToMinutes(a.startTime)-ttTimeToMinutes(b.startTime)).slice(0,5);
  if(!todayEntries.length){ strip.innerHTML=''; return; }
  strip.innerHTML=`
    <div style="margin-bottom:12px;font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--text1);">ðŸ“† Coming Up Today</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      ${todayEntries.map((e,i)=>{
        const co=db.courses.find(c=>c.id===e.courseId)||{title:e.courseTitle||'â€”',code:e.courseCode||'â€”'};
        const cl=db.classes.find(c=>c.id===e.classId)||{name:e.className||'â€”',color:'blue'};
        const cc=colorMap[cl.color]||colorMap.blue;
        return `<div style="background:var(--bg2);border:1px solid var(--border);border-left:4px solid ${cc.color};border-radius:12px;padding:14px 18px;min-width:200px;flex:1;max-width:300px;animation:fadeUp .35s ease ${i*.07}s both;">
          <div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);margin-bottom:4px;">${ttFormatTime(e.startTime)} â€“ ${ttFormatTime(e.endTime)}</div>
          <div style="font-weight:700;font-size:13px;color:var(--text1);">${co.title}</div>
          <div style="font-size:11px;color:${cc.color};margin-top:3px;">${cl.name}</div>
          <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:2px;">${e.venue||''}</div>
        </div>`;
      }).join('')}
    </div>`;
}

// â”€â”€ Add / Edit timetable entry â”€â”€
function openAddTimetableRow(){
  document.getElementById('ttEditId').value='';
  document.getElementById('ttEntryModalTitle').textContent='Add Timetable Entry';
  // Populate class select
  const sel=document.getElementById('ttEntryClass');
  sel.innerHTML=db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  ttPopulateCourseSel();
  document.getElementById('ttEntryDay').value='Monday';
  document.getElementById('ttEntryStart').value='08:00';
  document.getElementById('ttEntryEnd').value='10:00';
  document.getElementById('ttEntryVenue').value='';
  openModal('ttEntryModal');
}

function ttPopulateCourseSel(){
  const classId=document.getElementById('ttEntryClass').value;
  const courses=db.courses.filter(c=>c.classId===classId);
  document.getElementById('ttEntryCourse').innerHTML=courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function openEditTimetableRow(id){
  const e=db.timetable.find(x=>x.id===id);
  if(!e) return;
  document.getElementById('ttEditId').value=id;
  document.getElementById('ttEntryModalTitle').textContent='Edit Timetable Entry';
  const sel=document.getElementById('ttEntryClass');
  sel.innerHTML=db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  sel.value=e.classId;
  ttPopulateCourseSel();
  document.getElementById('ttEntryCourse').value=e.courseId;
  document.getElementById('ttEntryDay').value=e.day;
  document.getElementById('ttEntryStart').value=e.startTime;
  document.getElementById('ttEntryEnd').value=e.endTime;
  document.getElementById('ttEntryVenue').value=e.venue||'';
  openModal('ttEntryModal');
}

function saveTimetableEntry(){
  const classId=document.getElementById('ttEntryClass').value;
  const courseId=document.getElementById('ttEntryCourse').value;
  const day=document.getElementById('ttEntryDay').value;
  const startTime=document.getElementById('ttEntryStart').value;
  const endTime=document.getElementById('ttEntryEnd').value;
  const venue=document.getElementById('ttEntryVenue').value.trim();
  if(!classId||!courseId||!day||!startTime){toast('Please fill in all required fields');return;}
  if(!db.timetable) db.timetable=[];
  const editId=document.getElementById('ttEditId').value;
  if(editId){
    const e=db.timetable.find(x=>x.id===editId);
    if(e){ Object.assign(e,{classId,courseId,day,startTime,endTime,venue}); }
  } else {
    db.timetable.push({id:'tt_'+Date.now(),classId,courseId,day,startTime,endTime,venue,createdBy:currentUser.name});
  }
  saveDB();
  closeModal('ttEntryModal');
  renderTimetable();
  toast(editId?'Entry updated âœ“':'Entry added âœ“');
}

function deleteTimetableRow(id){
  if(!confirm('Delete this timetable entry?')) return;
  db.timetable=db.timetable.filter(e=>e.id!==id);
  saveDB();
  renderTimetable();
  toast('Entry deleted');
}

// â”€â”€ Timetable file upload (Excel/CSV) â”€â”€
let _ttParsedRows=[];

function openTimetableUpload(){
  _ttParsedRows=[];
  document.getElementById('ttDropIco').textContent='ðŸ“Š';
  document.getElementById('ttDropTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
  document.getElementById('ttDropArea').classList.remove('has-file');
  document.getElementById('ttFileInput').value='';
  document.getElementById('ttParsePreview').style.display='none';
  document.getElementById('ttParseStatus').textContent='';
  document.getElementById('ttImportBtn').style.display='none';
  openModal('ttUploadModal');
}

function ttFileChosen(inp){
  const file=inp.files[0];
  if(!file) return;
  document.getElementById('ttDropIco').textContent='â³';
  document.getElementById('ttDropTxt').textContent='Parsing fileâ€¦';
  document.getElementById('ttDropArea').classList.add('has-file');

  const ext=file.name.split('.').pop().toLowerCase();
  if(ext==='csv'){
    const reader=new FileReader();
    reader.onload=e=>{ ttParseCSV(e.target.result); };
    reader.readAsText(file);
  } else if(ext==='xlsx'||ext==='xls'){
    // Load SheetJS from CDN
    if(!window.XLSX){
      const script=document.createElement('script');
      script.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      script.onload=()=>{
        const reader=new FileReader();
        reader.onload=e=>{ ttParseExcel(e.target.result); };
        reader.readAsArrayBuffer(file);
      };
      document.head.appendChild(script);
    } else {
      const reader=new FileReader();
      reader.onload=e=>{ ttParseExcel(e.target.result); };
      reader.readAsArrayBuffer(file);
    }
  } else {
    toast('Please upload an Excel (.xlsx/.xls) or CSV file');
    document.getElementById('ttDropIco').textContent='ðŸ“Š';
    document.getElementById('ttDropTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
  }
}

function ttParseCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/\s+/g,'_'));
  const rows=lines.slice(1).map(l=>{
    const vals=l.split(',').map(v=>v.trim().replace(/^"|"$/g,''));
    const obj={};
    headers.forEach((h,i)=>{ obj[h]=vals[i]||''; });
    return obj;
  });
  ttProcessRows(rows);
}

function ttParseExcel(ab){
  try{
    const wb=XLSX.read(ab,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const data=XLSX.utils.sheet_to_json(ws,{defval:''});
    // Normalize keys
    const rows=data.map(r=>{
      const norm={};
      Object.keys(r).forEach(k=>{ norm[k.toLowerCase().replace(/\s+/g,'_')]=String(r[k]).trim(); });
      return norm;
    });
    ttProcessRows(rows);
  }catch(e){
    document.getElementById('ttParseStatus').textContent='âŒ Could not parse file: '+e.message;
    toast('Error parsing file');
  }
}

function ttProcessRows(rows){
  // Map columns flexibly
  const colMap={
    classId:['class','class_name','year'],
    courseId:['course','course_name','subject'],
    courseCode:['code','course_code'],
    day:['day','day_of_week'],
    startTime:['start_time','start','time_start','from'],
    endTime:['end_time','end','time_end','to'],
    venue:['venue','room','location','hall'],
    lecturer:['lecturer','teacher','instructor']
  };

  function getCol(row, keys){
    for(const k of keys){ if(row[k]!==undefined&&row[k]!=='') return row[k]; }
    return '';
  }

  _ttParsedRows=[];
  const errors=[];

  rows.forEach((r,i)=>{
    const className=getCol(r,colMap.classId);
    const courseName=getCol(r,colMap.courseId)||getCol(r,colMap.courseCode);
    const courseCode=getCol(r,colMap.courseCode);
    const day=getCol(r,colMap.day);
    const startTime=getCol(r,colMap.startTime);
    const endTime=getCol(r,colMap.endTime);
    const venue=getCol(r,colMap.venue);
    const lecturerName=getCol(r,colMap.lecturer);

    if(!className&&!courseName&&!day){ return; } // skip empty rows

    // Match class
    let cl=db.classes.find(c=>c.name.toLowerCase().includes((className||'').toLowerCase())||(className||'').toLowerCase().includes(c.name.toLowerCase()));
    // Match course
    let co=null;
    if(cl){
      co=db.courses.find(c=>c.classId===cl.id&&(
        c.title.toLowerCase().includes((courseName||'').toLowerCase())||
        c.code.toLowerCase()===((courseCode||courseName||'').toLowerCase())
      ));
    }
    if(!co&&courseName){
      co=db.courses.find(c=>c.title.toLowerCase().includes(courseName.toLowerCase())||c.code.toLowerCase()===(courseCode||'').toLowerCase());
    }

    // Validate day
    const dayMatch=DAYS.find(d=>d.toLowerCase().startsWith((day||'').toLowerCase().slice(0,3)));

    if(!cl){ errors.push(`Row ${i+2}: class "${className}" not found`); }
    if(!co){ errors.push(`Row ${i+2}: course "${courseName}" not found`); }

    _ttParsedRows.push({
      classId:cl?.id||'',
      className:cl?.name||className,
      courseId:co?.id||'',
      courseTitle:co?.title||courseName,
      courseCode:co?.code||courseCode,
      day:dayMatch||day,
      startTime:startTime,
      endTime:endTime,
      venue:venue,
      lecturer:lecturerName||co?.lecturer||'',
      _matched:!!(cl&&co&&dayMatch),
      _error:(!cl||!co||!dayMatch)?`${!cl?'class ':''} ${!co?'course ':''} ${!dayMatch?'day':''}`.trim():null
    });
  });

  // Show preview
  const matched=_ttParsedRows.filter(r=>r._matched).length;
  const unmatched=_ttParsedRows.filter(r=>!r._matched).length;

  document.getElementById('ttParseStatus').innerHTML=
    `âœ… <strong>${matched}</strong> entries ready to import` +
    (unmatched?` Â· âš ï¸ <strong>${unmatched}</strong> could not be fully matched`:'') +
    (errors.length?`<br><span style="color:var(--accent4);">${errors.slice(0,5).join('<br>')}</span>`:'');

  const previewEl=document.getElementById('ttParsePreview');
  previewEl.style.display='';
  previewEl.innerHTML=`<table style="width:100%;font-size:11px;font-family:'DM Mono',monospace;">
    <thead><tr style="background:var(--bg3);">
      <th style="padding:6px 10px;text-align:left;">Class</th>
      <th style="padding:6px 10px;text-align:left;">Course</th>
      <th style="padding:6px 10px;text-align:left;">Day</th>
      <th style="padding:6px 10px;text-align:left;">Time</th>
      <th style="padding:6px 10px;text-align:left;">Venue</th>
      <th style="padding:6px 10px;text-align:left;">Status</th>
    </tr></thead>
    <tbody>
      ${_ttParsedRows.map(r=>`<tr style="border-bottom:1px solid var(--border);">
        <td style="padding:5px 10px;">${r.className}</td>
        <td style="padding:5px 10px;">${r.courseTitle}</td>
        <td style="padding:5px 10px;">${r.day}</td>
        <td style="padding:5px 10px;">${r.startTime}â€“${r.endTime}</td>
        <td style="padding:5px 10px;">${r.venue}</td>
        <td style="padding:5px 10px;">${r._matched?'<span style="color:var(--accent3);">âœ“ OK</span>':'<span style="color:var(--accent4);">âš  '+r._error+'</span>'}</td>
      </tr>`).join('')}
    </tbody></table>`;

  document.getElementById('ttDropIco').textContent='âœ…';
  document.getElementById('ttDropTxt').textContent=`${_ttParsedRows.length} rows parsed`;
  if(matched>0) document.getElementById('ttImportBtn').style.display='';
}

function importParsedTimetable(){
  if(!db.timetable) db.timetable=[];
  const toImport=_ttParsedRows.filter(r=>r._matched);
  const now=Date.now();
  toImport.forEach((r,i)=>{
    db.timetable.push({
      id:'tt_'+(now+i),
      classId:r.classId,
      courseId:r.courseId,
      courseTitle:r.courseTitle,
      courseCode:r.courseCode,
      day:r.day,
      startTime:r.startTime,
      endTime:r.endTime,
      venue:r.venue,
      lecturer:r.lecturer,
      createdBy:currentUser.name
    });
  });
  saveDB();
  closeModal('ttUploadModal');
  renderTimetable();
  toast(`${toImport.length} timetable entries imported âœ“`);
  logActivity('upload_timetable',`${toImport.length} entries imported`);
}

// ============================================================
// NOTIFICATION SYSTEM
// ============================================================
let _nvNotifs=[]; // {id, type, title, body, time, read, data:{entry,classId,courseId}}
let _ttCheckInterval=null;
let _lastNotifCheck=0;

function initNotifSystem(){
  // Show bell
  const bell=document.getElementById('nvNotifBell');
  if(bell) bell.style.display='flex';
  // Check every minute
  _ttCheckInterval=setInterval(checkTimetableNotifs, 60000);
  checkTimetableNotifs(); // also check immediately on login
}

function checkTimetableNotifs(){
  if(!db.timetable||!db.timetable.length) return;
  const now=new Date();
  const todayName=DAYS[now.getDay()===0?6:now.getDay()-1]||'';
  const nowMin=now.getHours()*60+now.getMinutes();

  db.timetable.forEach(e=>{
    if(e.day!==todayName) return;
    const startMin=ttTimeToMinutes(e.startTime);
    const diffMin=startMin-nowMin;
    // Notify 10 minutes before class starts
    if(diffMin>=0&&diffMin<=10){
      const notifId=`tt_notif_${e.id}_${now.toDateString()}`;
      if(_nvNotifs.find(n=>n.id===notifId)) return; // already fired today
      const co=db.courses.find(c=>c.id===e.courseId)||{title:e.courseTitle||'',code:e.courseCode||'',lecturer:e.lecturer||''};
      const cl=db.classes.find(c=>c.id===e.classId)||{name:e.className||''};

      // Only show to relevant users:
      // - Admin: always
      // - Lecturer: if this course is assigned to them
      // - Student: if they're in this class
      let relevant=false;
      if(currentRole==='admin') relevant=true;
      else if(currentRole==='teacher'&&co.lecturer&&currentUser.name&&co.lecturer.toLowerCase().includes(currentUser.name.toLowerCase().split(' ')[0])) relevant=true;
      else if(currentRole==='student'&&currentUser.classId===e.classId) relevant=true;

      if(!relevant) return;

      const notif={
        id:notifId,
        type:'class_reminder',
        title:`ðŸ“š Class in ${diffMin<=0?'now!':diffMin+' mins'}`,
        body:`${co.title} â€” ${cl.name}`,
        sub:`${ttFormatTime(e.startTime)} â€“ ${ttFormatTime(e.endTime)} Â· ${e.venue||''}`,
        time:Date.now(),
        read:false,
        data:{entry:e, classId:e.classId, courseId:e.courseId, co, cl}
      };
      _nvNotifs.unshift(notif);
      updateNotifBell();
      showNotifToast(notif);
    }
  });
}

function updateNotifBell(){
  const unread=_nvNotifs.filter(n=>!n.read).length;
  const cnt=document.getElementById('nvNotifCount');
  if(cnt){
    cnt.textContent=unread>9?'9+':unread;
    cnt.style.display=unread>0?'flex':'none';
  }
}

function showNotifToast(notif){
  // Big prominent toast with action buttons for lecturers
  const toast=document.createElement('div');
  toast.id='nvToast_'+notif.id;
  toast.style.cssText=`position:fixed;bottom:24px;right:20px;z-index:9999;background:var(--bg2);border:1px solid var(--border);border-left:4px solid var(--accent);border-radius:16px;padding:16px 20px;max-width:360px;box-shadow:0 16px 48px rgba(0,0,0,.35);animation:slideInRight .4s ease;`;

  let actions='';
  if(currentRole==='teacher'||currentRole==='admin'){
    const {entry, classId, co}=notif.data;
    const threadId='classgroup:'+classId;
    actions=`<div style="display:flex;gap:8px;margin-top:12px;">
      <button onclick="sendLecturerStatus('coming','${classId}','${notif.data.co.title}','${notif.id}')" style="flex:1;padding:8px;border:none;border-radius:8px;background:var(--accent3);color:white;font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Mono',monospace;">âœ… I'm Coming</button>
      <button onclick="sendLecturerStatus('unavailable','${classId}','${notif.data.co.title}','${notif.id}')" style="flex:1;padding:8px;border:none;border-radius:8px;background:var(--accent4);color:white;font-size:12px;font-weight:700;cursor:pointer;font-family:'DM Mono',monospace;">âŒ Not Available</button>
      <button onclick="this.closest('[id^=nvToast_]').remove()" style="padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--text3);font-size:12px;cursor:pointer;font-family:'DM Mono',monospace;">âœ•</button>
    </div>`;
  } else {
    actions=`<button onclick="this.closest('[id^=nvToast_]').remove()" style="margin-top:10px;padding:7px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--text2);font-size:12px;cursor:pointer;font-family:'DM Mono',monospace;width:100%;">Dismiss</button>`;
  }

  toast.innerHTML=`
    <div style="display:flex;align-items:flex-start;gap:10px;">
      <span style="font-size:22px;flex-shrink:0;">ðŸ””</span>
      <div style="flex:1;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--text1);">${notif.title}</div>
        <div style="font-size:13px;color:var(--text1);margin-top:3px;font-weight:600;">${notif.body}</div>
        <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;">${notif.sub}</div>
        ${actions}
      </div>
    </div>`;
  document.body.appendChild(toast);
  // Auto-dismiss after 45s if no action (lecturers get more time)
  setTimeout(()=>{ if(document.contains(toast)) toast.style.animation='slideOutRight .4s ease forwards'; setTimeout(()=>toast.remove(),400); }, 45000);
}

function sendLecturerStatus(status, classId, courseName, notifId){
  // Remove toast
  const t=document.getElementById('nvToast_'+notifId);
  if(t) t.remove();

  // Mark notif read
  const notif=_nvNotifs.find(n=>n.id===notifId);
  if(notif) notif.read=true;
  updateNotifBell();

  // Build message
  const msg=status==='coming'
    ? `âœ… ${currentUser.name} will be coming for the ${courseName} class. Please be ready.`
    : `âŒ ${currentUser.name} is not available for the ${courseName} class today. Class may be rescheduled.`;

  // Send to class group thread
  const threadId='classgroup:'+classId;
  if(!db.messages) db.messages=[];
  db.messages.push({
    id:'m_'+Date.now(),
    threadId,
    senderId:currentUser.id||currentUser.username,
    senderName:currentUser.name,
    senderRole:currentRole,
    text:msg,
    type:'text',
    timestamp:Date.now(),
    isLecturerStatus:true,
    statusType:status
  });
  // Ensure thread is visible to everyone in the class
  if(!db.dmThreads) db.dmThreads=[];
  if(!db.dmThreads.includes(threadId)) db.dmThreads.push(threadId);
  saveDB();

  toast(status==='coming'?`Message sent to class: "I'm coming" âœ“`:`Message sent to class: "Not available" âœ“`);

  // If currently in messages view, refresh
  if(document.getElementById('viewMessages').style.display!=='none'){
    renderMessaging();
  }
}

function toggleNotifPanel(){
  const panel=document.getElementById('nvNotifPanel');
  if(!panel) return;
  const isOpen=panel.style.display!=='none';
  panel.style.display=isOpen?'none':'';
  if(!isOpen){
    // Mark all read
    _nvNotifs.forEach(n=>n.read=true);
    updateNotifBell();
    renderNotifPanel();
  }
}

function renderNotifPanel(){
  const list=document.getElementById('nvNotifList');
  if(!list) return;
  if(!_nvNotifs.length){
    list.innerHTML=`<div style="padding:24px;text-align:center;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">No notifications yet</div>`;
    return;
  }
  list.innerHTML=_nvNotifs.slice(0,20).map((n,i)=>`
    <div style="padding:14px 18px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:flex-start;animation:fadeUp .25s ease ${i*.04}s both;${n.read?'opacity:.7':''}">
      <span style="font-size:20px;flex-shrink:0;">ðŸ””</span>
      <div style="flex:1;">
        <div style="font-size:13px;font-weight:700;color:var(--text1);">${n.title}</div>
        <div style="font-size:12px;color:var(--text2);">${n.body}</div>
        <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;">${n.sub}</div>
        ${(currentRole==='teacher'||currentRole==='admin')&&n.type==='class_reminder'?`
        <div style="display:flex;gap:6px;margin-top:8px;">
          <button onclick="sendLecturerStatus('coming','${n.data.classId}','${n.data.co.title}','${n.id}');document.getElementById('nvNotifPanel').style.display='none';" style="padding:5px 12px;border:none;border-radius:7px;background:var(--accent3);color:white;font-size:11px;font-weight:700;cursor:pointer;font-family:'DM Mono',monospace;">âœ… I'm Coming</button>
          <button onclick="sendLecturerStatus('unavailable','${n.data.classId}','${n.data.co.title}','${n.id}');document.getElementById('nvNotifPanel').style.display='none';" style="padding:5px 12px;border:none;border-radius:7px;background:var(--accent4);color:white;font-size:11px;font-weight:700;cursor:pointer;font-family:'DM Mono',monospace;">âŒ Not Available</button>
        </div>`:''}
      </div>
      <div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;flex-shrink:0;">${new Date(n.time).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}</div>
    </div>`).join('');
}

function clearAllNotifs(){
  _nvNotifs=[];
  updateNotifBell();
  renderNotifPanel();
}

// Close notif panel when clicking outside
document.addEventListener('click',function(e){
  const panel=document.getElementById('nvNotifPanel');
  const bell=document.getElementById('nvNotifBell');
  if(panel&&bell&&!panel.contains(e.target)&&!bell.contains(e.target)){
    panel.style.display='none';
  }
});

function calcGrade(score){
  if(score>=70) return 'A';
  if(score>=60) return 'B';
  if(score>=50) return 'C';
  if(score>=45) return 'D';
  return 'F';
}
function gradeClass(g){
  if(g==='A') return 'score-a';
  if(g==='B') return 'score-b';
  if(g==='C'||g==='D') return 'score-c';
  return 'score-f';
}
function gradeColor(g){
  if(g==='A') return 'var(--accent3)';
  if(g==='B') return 'var(--accent)';
  if(g==='C'||g==='D') return '#fbbf24';
  return 'var(--accent4)';
}
function gradeBg(g){
  if(g==='A') return 'rgba(90,173,160,.15)';
  if(g==='B') return 'rgba(62,142,149,.15)';
  if(g==='C'||g==='D') return 'rgba(251,191,36,.15)';
  return 'rgba(224,123,123,.15)';
}

// â”€â”€ GPA / CGPA engine (Nigerian polytechnic 5-point scale) â”€â”€
// A=5, B=4, C=3, D=2, F=0
function gradeToPoint(g){
  if(g==='A') return 5;
  if(g==='B') return 4;
  if(g==='C') return 3;
  if(g==='D') return 2;
  return 0; // F
}

// Get the effective credit units for a course (fallback to 3 if not set)
function getCourseUnits(courseId){
  const co = (db.courses||[]).find(c=>c.id===courseId);
  return (co && co.creditUnits) ? co.creditUnits : 3;
}

// For a given list of result records, compute:
// { totalCreditUnits, totalQualityPoints, gpa }
// Only "exam" type results are used for GPA (one per course â€” highest if duplicates)
function computeGPA(results){
  if(!results || !results.length) return {totalCreditUnits:0, totalQualityPoints:0, gpa:0};

  // Prefer exam > test. If multiple exams per course, take highest score.
  const courseMap = {};
  results.forEach(r=>{
    const cid = r.courseId || '__none__';
    const g   = r.grade || calcGrade(r.score);
    const pts = gradeToPoint(g);
    const cu  = getCourseUnits(cid);
    if(!courseMap[cid]){
      courseMap[cid] = {grade:g, pts, cu, score:r.score, type:r.type};
    } else {
      // prefer exam over test; then higher score wins
      const prev = courseMap[cid];
      const currIsExam = r.type==='exam';
      const prevIsExam = prev.type==='exam';
      if((currIsExam && !prevIsExam) || (currIsExam===prevIsExam && r.score > prev.score)){
        courseMap[cid] = {grade:g, pts, cu, score:r.score, type:r.type};
      }
    }
  });

  let totalCU = 0, totalQP = 0;
  Object.values(courseMap).forEach(({pts,cu})=>{ totalCU+=cu; totalQP+=(pts*cu); });
  const gpa = totalCU > 0 ? totalQP/totalCU : 0;
  return {totalCreditUnits:totalCU, totalQualityPoints:totalQP, gpa};
}

// Compute GPA for a specific class/semester
function computeSemesterGPA(results, classId){
  return computeGPA(results.filter(r=>r.classId===classId));
}

// Compute CGPA across all classes
function computeCGPA(results){
  return computeGPA(results);
}

// Get all results for a specific student (by matric or studentId)
function getResultsForStudent(matric, studentId){
  if(!db.results) return [];
  return db.results.filter(r=>{
    if(studentId && r.studentId===studentId) return true;
    if(matric && r.matric && r.matric.trim().toUpperCase()===matric.trim().toUpperCase()) return true;
    return false;
  });
}

// Grade class for GPA display
function cgpaClass(cgpa){
  if(cgpa>=4.5) return 'Distinction';
  if(cgpa>=3.5) return 'Upper Credit';
  if(cgpa>=2.5) return 'Lower Credit';
  if(cgpa>=1.5) return 'Pass';
  return 'Fail';
}
function cgpaColor(cgpa){
  if(cgpa>=4.5) return 'var(--accent3)';
  if(cgpa>=3.5) return 'var(--accent)';
  if(cgpa>=2.5) return '#fbbf24';
  if(cgpa>=1.5) return 'var(--text2)';
  return 'var(--accent4)';
}

function renderResultsView(){
  if(!db.results) db.results = [];
  const isAdmin = currentRole==='admin';
  const isTeacher = currentRole==='teacher';
  // Only admin sees the full table; teachers and students see the student panel
  // (teachers in this system don't have their own results view â€” kept simple)
  document.getElementById('resultsTeacherPanel').style.display = isAdmin ? '' : 'none';
  document.getElementById('resultsStudentPanel').style.display = isAdmin ? 'none' : '';

  if(isAdmin){
    const cf = document.getElementById('resultFilterClass');
    cf.innerHTML = '<option value="">All Classes</option>' +
      db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    document.getElementById('resultFilterCourse').innerHTML = '<option value="">All Courses</option>' +
      db.courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
    document.getElementById('resultFilterType').value = '';
    const si = document.getElementById('resultFilterSearch');
    if(si) si.value = '';
    renderResultsTable();
  } else {
    // Populate course filter for student
    const myResults = getMyResults();
    const myCourseIds = [...new Set(myResults.map(r=>r.courseId).filter(Boolean))];
    const csel = document.getElementById('studentResultFilterCourse');
    csel.innerHTML = '<option value="">All Courses</option>' +
      myCourseIds.map(cid=>{
        const co = db.courses.find(c=>c.id===cid);
        return co ? `<option value="${cid}">${co.code} â€” ${co.title}</option>` : '';
      }).join('');
    renderStudentResults();
  }
}

function filterResultsByClass(){
  const classId = document.getElementById('resultFilterClass').value;
  const courses = classId ? db.courses.filter(c=>c.classId===classId) : db.courses;
  document.getElementById('resultFilterCourse').innerHTML =
    '<option value="">All Courses</option>' +
    courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
  renderResultsTable();
}

function renderResultsTable(){
  if(!db.results) db.results=[];
  const classId  = document.getElementById('resultFilterClass').value;
  const type     = document.getElementById('resultFilterType').value;
  const courseId = document.getElementById('resultFilterCourse').value;
  const search   = (document.getElementById('resultFilterSearch')?.value||'').toLowerCase().trim();

  let results = db.results.slice();
  if(classId)  results = results.filter(r=>r.classId===classId);
  if(type)     results = results.filter(r=>r.type===type);
  if(courseId) results = results.filter(r=>r.courseId===courseId);
  if(search)   results = results.filter(r=>
    (r.studentName||'').toLowerCase().includes(search) ||
    (r.matric||'').toLowerCase().includes(search) ||
    (r.title||'').toLowerCase().includes(search)
  );

  const tbody  = document.getElementById('resultsTableBody');
  const empty  = document.getElementById('resultsTableEmpty');

  if(!results.length){
    tbody.innerHTML='';
    empty.style.display='';
    return;
  }
  empty.style.display='none';

  tbody.innerHTML = results.map(r=>{
    const co = db.courses.find(c=>c.id===r.courseId)||{title:'â€”',code:'â€”'};
    const cl = db.classes.find(c=>c.id===r.classId)||{name:'â€”'};
    const g  = r.grade || calcGrade(r.score);
    const gp = gradeToPoint(g);
    const cu = co.creditUnits || 3;
    // Compute this student's CGPA across all their results
    const studentRes = (db.results||[]).filter(sr=>{
      if(r.studentId && sr.studentId===r.studentId) return true;
      if(r.matric && sr.matric && sr.matric.trim().toUpperCase()===r.matric.trim().toUpperCase()) return true;
      return false;
    });
    const cgpaData = computeCGPA(studentRes);
    const linkedBadge = r.studentId
      ? `<span style="color:var(--accent3);font-size:10px;font-family:'DM Mono',monospace;">âœ“ linked</span>`
      : `<span style="color:var(--accent4);font-size:10px;font-family:'DM Mono',monospace;">unlinked</span>`;
    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:11px;">
        <div>${r.matric||'â€”'}</div>
        <div style="margin-top:2px;">${linkedBadge}</div>
      </td>
      <td style="font-weight:500">${r.studentName}</td>
      <td><span class="result-type-badge rt-${r.type}">${r.type}</span></td>
      <td style="font-size:12px;">${r.title}</td>
      <td style="color:var(--text2);font-size:12px">${co.code}<br><span style="color:var(--text3);font-size:10px;">${co.title}</span></td>
      <td style="color:var(--text2);font-size:12px">${cl.name}</td>
      <td><span class="score-pill ${gradeClass(g)}">${r.score}${r.total&&r.total!==100?'/'+r.total:''}</span></td>
      <td><strong style="color:${gradeColor(g)};font-family:'Syne',sans-serif;font-size:16px;">${g}</strong></td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:${gradeColor(g)};white-space:nowrap;">
        ${gp}<span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;"> Ã—${cu}CU</span>
      </td>
      <td style="white-space:nowrap;">
        <strong style="color:${cgpaColor(cgpaData.gpa)};font-family:'Syne',sans-serif;font-size:14px;">${cgpaData.gpa.toFixed(2)}</strong>
        <div style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">${cgpaClass(cgpaData.gpa)}</div>
      </td>
      <td style="color:var(--text3);font-size:11px;font-family:'DM Mono',monospace">${r.date}</td>
      <td><button class="icon-btn" title="Delete" onclick="deleteResult('${r.id}')">ðŸ—‘</button></td>
    </tr>`;
  }).join('');
}

// â”€â”€ Helper: get results belonging to current student (by studentId OR matric) â”€â”€
function getMyResults(){
  if(!db.results) return [];
  return db.results.filter(r=>{
    // Primary match: linked studentId
    if(r.studentId && r.studentId === currentUser.id) return true;
    // Secondary match: matric number (case-insensitive)
    if(r.matric && currentUser.matric &&
       r.matric.trim().toUpperCase() === currentUser.matric.trim().toUpperCase()) return true;
    return false;
  });
}

function renderStudentResults(){
  if(!db.results) db.results=[];
  const typeFilter   = document.getElementById('studentResultFilterType').value;
  const courseFilter = document.getElementById('studentResultFilterCourse')?.value||'';

  const allMine = getMyResults();
  const myResults = allMine.filter(r=>
    (!typeFilter   || r.type===typeFilter) &&
    (!courseFilter || r.courseId===courseFilter)
  );

  // Summary strip â€” with CGP and CGPA
  const summaryEl = document.getElementById('studentResultsSummary');
  if(allMine.length>0 && summaryEl){
    const avg  = allMine.reduce((s,r)=>s+r.score,0)/allMine.length;
    const best = Math.max(...allMine.map(r=>r.score));
    const cgpaData = computeCGPA(allMine);
    const cgpa     = cgpaData.gpa;
    const cgp      = cgpaData.totalQualityPoints;
    const totalCU  = cgpaData.totalCreditUnits;
    const classify = cgpaClass(cgpa);
    const cColor   = cgpaColor(cgpa);

    // Per-semester GPA breakdown
    const classes = [...new Set(allMine.map(r=>r.classId).filter(Boolean))];
    const semRows = classes.map(cid=>{
      const cl    = (db.classes||[]).find(c=>c.id===cid)||{name:cid};
      const sData = computeSemesterGPA(allMine, cid);
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg3);border-radius:7px;font-size:12px;">
        <span style="color:var(--text2);font-family:'DM Mono',monospace;">${cl.name}</span>
        <span style="font-weight:700;color:${cgpaColor(sData.gpa)};font-family:'Syne',sans-serif;">${sData.gpa.toFixed(2)} <span style="font-size:10px;color:var(--text3);">GPA</span></span>
      </div>`;
    }).join('');

    summaryEl.style.display='';
    summaryEl.innerHTML=`
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:14px;">
        <div class="stat-box">
          <div class="stat-lbl">CGPA</div>
          <div class="stat-val" style="color:${cColor};font-size:26px;font-family:'Syne',sans-serif;font-weight:800;">${cgpa.toFixed(2)}</div>
          <div style="font-size:10px;font-family:'DM Mono',monospace;color:${cColor};margin-top:2px;">${classify}</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Total CGP</div>
          <div class="stat-val" style="color:var(--accent2);font-size:22px;">${cgp.toFixed(1)}</div>
          <div style="font-size:10px;font-family:'DM Mono',monospace;color:var(--text3);margin-top:2px;">${totalCU} credit units</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Avg Score</div>
          <div class="stat-val" style="color:${gradeColor(calcGrade(avg))};font-size:20px;">${avg.toFixed(1)}%</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Best Score</div>
          <div class="stat-val" style="color:var(--accent3);font-size:20px;">${best}%</div>
        </div>
        <div class="stat-box">
          <div class="stat-lbl">Matric No.</div>
          <div class="stat-val" style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text2);">${currentUser.matric||'â€”'}</div>
        </div>
      </div>
      ${semRows ? `<div style="margin-bottom:4px;font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px;">Semester GPA Breakdown</div>
      <div style="display:flex;flex-direction:column;gap:6px;">${semRows}</div>` : ''}`;
  } else if(summaryEl){
    summaryEl.style.display='none';
  }

  const list = document.getElementById('studentResultsList');
  if(!myResults.length){
    list.innerHTML = `<div class="results-empty">
      <div class="results-empty-ico">ðŸ“‹</div>
      <div class="results-empty-t">${allMine.length?'No results for this filter':'No results yet'}</div>
      <div class="results-empty-s">${allMine.length?'Try changing the filter above':'Your results will appear here once uploaded. Make sure your matric number is set in your profile.'}</div>
      ${!currentUser.matric?`<div style="margin-top:12px;padding:10px 14px;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:8px;font-size:12px;color:#fbbf24;font-family:'DM Mono',monospace;">âš  You have no matric number saved. Ask admin to update your profile.</div>`:''}
    </div>`;
    return;
  }

  list.innerHTML = myResults.map((r,i)=>{
    const co  = db.courses.find(c=>c.id===r.courseId)||{title:'â€”',code:'â€”',creditUnits:3};
    const cl  = db.classes.find(c=>c.id===r.classId)||{name:''};
    const g   = r.grade || calcGrade(r.score);
    const pct = r.score;
    const cu  = co.creditUnits || 3;
    const gp  = gradeToPoint(g);
    const qp  = (gp * cu).toFixed(0);
    return `<div class="my-result-card" style="animation-delay:${i*.05}s">
      <div class="my-result-score" style="background:${gradeBg(g)};color:${gradeColor(g)};border:2px solid ${gradeColor(g)};">
        <div style="font-size:18px;font-weight:800;">${pct}%</div>
        <div style="font-size:12px;font-weight:700;">${g}</div>
      </div>
      <div class="my-result-info" style="flex:1;">
        <div class="my-result-title">${r.title}</div>
        <div class="my-result-meta">${co.code} â€” ${co.title}</div>
        <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:2px;">${cl.name?cl.name+' Â· ':''}${r.date}</div>
        ${r.remarks?`<div style="font-size:11px;color:var(--text2);margin-top:4px;font-style:italic;padding:4px 8px;background:var(--bg3);border-radius:5px;">"${r.remarks}"</div>`:''}
      </div>
      <div style="text-align:right;flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:5px;">
        <span class="result-type-badge rt-${r.type}">${r.type}</span>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:4px 9px;text-align:center;">
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:13px;color:${gradeColor(g)};">${gp} pts</div>
          <div style="font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;">${cu} CU Â· QP: ${qp}</div>
        </div>
        ${r.total&&r.total!==100?`<div style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace;">${r.score}/${r.total} marks</div>`:''}
      </div>
    </div>`;
  }).join('');
}

function openModal_addResult(){
  if(!db.results) db.results=[];
  // Populate class dropdown
  const clSel = document.getElementById('newResultClass');
  clSel.innerHTML = db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  filterResultModalCourses();
  filterResultModalStudents();
  // Reset inputs
  document.getElementById('newResultType').value='test';
  document.getElementById('newResultTitle').value='';
  document.getElementById('newResultScore').value='';
  document.getElementById('newResultTotal').value='100';
  document.getElementById('newResultRemarks').value='';
  openModal('addResultModal');
}

function filterResultModalCourses(){
  const classId = document.getElementById('newResultClass').value;
  document.getElementById('newResultCourse').innerHTML =
    db.courses.filter(c=>c.classId===classId)
      .map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function filterResultModalStudents(){
  const classId = document.getElementById('newResultClass').value;
  const students = db.users.filter(u=>u.role==='student' && u.classId===classId);
  const sel = document.getElementById('newResultStudent');
  if(!students.length){
    sel.innerHTML='<option value="">â€” No students in this class â€”</option>';
  } else {
    sel.innerHTML = students.map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
  }
}

function submitResult(){
  if(!db.results) db.results=[];
  const type       = document.getElementById('newResultType').value;
  const title      = document.getElementById('newResultTitle').value.trim();
  const classId    = document.getElementById('newResultClass').value;
  const courseId   = document.getElementById('newResultCourse').value;
  const studentId  = document.getElementById('newResultStudent').value;
  const scoreRaw   = document.getElementById('newResultScore').value;
  const totalRaw   = document.getElementById('newResultTotal').value;
  const remarks    = document.getElementById('newResultRemarks').value.trim();

  if(!title)         return toast('Please enter a title.');
  if(!courseId)      return toast('Please select a course.');
  if(!studentId)     return toast('Please select a student.');
  if(scoreRaw==='')  return toast('Please enter a score.');

  const score = parseFloat(scoreRaw);
  const total = totalRaw ? parseFloat(totalRaw) : 100;
  if(isNaN(score)||score<0||score>100) return toast('Score must be between 0 and 100.');

  const student = db.users.find(u=>u.id===studentId);
  if(!student) return toast('Student not found.');

  const now = new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date = months[now.getMonth()]+' '+now.getDate()+', '+now.getFullYear();

  const result = {
    id: 'r_'+Date.now(),
    type, title, classId, courseId,
    studentId, studentName: student.name,
    matric: student.matric||'',
    score, total, grade: calcGrade(score),
    date, uploadedBy: currentUser.name,
    remarks: remarks||''
  };

  db.results.push(result);
  saveDB();
  closeModal('addResultModal');
  renderResultsTable();
  toast(`Result saved for ${student.name} âœ“`);
}

function showCGPASummary(){
  if(!db.results || !db.results.length){
    alert('No results uploaded yet.'); return;
  }

  // Group all results by student (keyed by matric OR studentId)
  const studentMap = {};
  db.results.forEach(r=>{
    const key = r.matric ? r.matric.trim().toUpperCase() : (r.studentId || r.studentName);
    if(!studentMap[key]){
      studentMap[key] = {
        name: r.studentName,
        matric: r.matric || 'â€”',
        studentId: r.studentId,
        results: []
      };
    }
    studentMap[key].results.push(r);
  });

  const rows = Object.values(studentMap).map(st=>{
    const cgpaData = computeCGPA(st.results);
    const cgpa     = cgpaData.gpa;
    const cgp      = cgpaData.totalQualityPoints;
    const totalCU  = cgpaData.totalCreditUnits;
    const classify = cgpaClass(cgpa);
    const cColor   = cgpaColor(cgpa);

    // Per-semester GPAs
    const classesTaken = [...new Set(st.results.map(r=>r.classId).filter(Boolean))];
    const semCells = classesTaken.map(cid=>{
      const cl = (db.classes||[]).find(c=>c.id===cid)||{name:cid};
      const sd = computeSemesterGPA(st.results, cid);
      return `<div style="font-size:10px;color:var(--text2);font-family:'DM Mono',monospace;white-space:nowrap;">${cl.name}: <strong style="color:${cgpaColor(sd.gpa)};">${sd.gpa.toFixed(2)}</strong></div>`;
    }).join('');

    const linkedBadge = st.studentId
      ? `<span style="background:rgba(90,173,160,.15);color:var(--accent3);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;">linked</span>`
      : `<span style="background:rgba(224,123,123,.1);color:var(--accent4);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;">unlinked</span>`;

    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:11px;">${st.matric}<br>${linkedBadge}</td>
      <td style="font-weight:600;">${st.name}</td>
      <td style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:${cColor};">${cgpa.toFixed(2)}</td>
      <td style="font-size:11px;color:${cColor};font-family:'DM Mono',monospace;">${classify}</td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--accent2);">${cgp.toFixed(1)}</td>
      <td style="font-size:11px;color:var(--text2);font-family:'DM Mono',monospace;">${totalCU} CU</td>
      <td>${semCells}</td>
    </tr>`;
  });

  // Sort by CGPA descending
  const studentArr = Object.values(studentMap).map(st=>({
    ...st, cgpaData: computeCGPA(st.results)
  })).sort((a,b)=>b.cgpaData.gpa - a.cgpaData.gpa);

  const sortedRows = studentArr.map((st,idx)=>{
    const cgpa     = st.cgpaData.gpa;
    const cgp      = st.cgpaData.totalQualityPoints;
    const totalCU  = st.cgpaData.totalCreditUnits;
    const classify = cgpaClass(cgpa);
    const cColor   = cgpaColor(cgpa);
    const classesTaken = [...new Set(st.results.map(r=>r.classId).filter(Boolean))];
    const semCells = classesTaken.map(cid=>{
      const cl = (db.classes||[]).find(c=>c.id===cid)||{name:cid};
      const sd = computeSemesterGPA(st.results, cid);
      return `<div style="font-size:10px;color:var(--text2);font-family:'DM Mono',monospace;">${cl.name}: <strong style="color:${cgpaColor(sd.gpa)};">${sd.gpa.toFixed(2)}</strong></div>`;
    }).join('');
    const linkedBadge = st.studentId
      ? `<span style="background:rgba(90,173,160,.15);color:var(--accent3);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;">linked</span>`
      : `<span style="background:rgba(224,123,123,.1);color:var(--accent4);padding:1px 6px;border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;">unlinked</span>`;
    const rankEmoji = idx===0?'ðŸ¥‡':idx===1?'ðŸ¥ˆ':idx===2?'ðŸ¥‰':'';
    return `<tr>
      <td style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:var(--text3);">${rankEmoji} #${idx+1}</td>
      <td style="font-family:'DM Mono',monospace;font-size:11px;">${st.matric}<br>${linkedBadge}</td>
      <td style="font-weight:600;">${st.name}</td>
      <td style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:${cColor};">${cgpa.toFixed(2)}</td>
      <td style="font-size:11px;color:${cColor};font-family:'DM Mono',monospace;font-weight:700;">${classify}</td>
      <td style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--accent2);">${cgp.toFixed(1)}</td>
      <td style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">${totalCU} CU</td>
      <td>${semCells}</td>
    </tr>`;
  }).join('');

  document.getElementById('cgpaSummaryContent').innerHTML = `
    <div style="background:var(--bg3);border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:12px;color:var(--accent);font-family:'DM Mono',monospace;border:1px solid rgba(62,142,149,.15);">
      â„¹ï¸ CGPA uses the 5-point Nigerian polytechnic scale: A=5, B=4, C=3, D=2, F=0. Exam results take priority over tests per course. Sorted by highest CGPA.
    </div>
    <div class="results-table-wrap">
      <table class="results-table" style="font-size:13px;">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Matric</th>
            <th>Student Name</th>
            <th>CGPA</th>
            <th>Classification</th>
            <th>Total CGP</th>
            <th>Credit Units</th>
            <th>Sem. GPAs</th>
          </tr>
        </thead>
        <tbody>${sortedRows}</tbody>
      </table>
    </div>
  `;
  openModal('cgpaSummaryModal');
}

function deleteResult(id){
  if(!confirm('Delete this result?')) return;
  db.results = db.results.filter(r=>r.id!==id);
  saveDB();
  renderResultsTable();
  toast('Result deleted');
}

// ============================================================
// SPREADSHEET IMPORT â€” admin uploads .xlsx / .csv
// ============================================================
let _ssRows = []; // parsed & matched rows ready for import

function openSpreadsheetImport(){
  if(!db.results) db.results=[];
  // Populate dropdowns
  const clSel = document.getElementById('ssClass');
  clSel.innerHTML = db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  ssFilterCourses();
  document.getElementById('ssType').value='test';
  document.getElementById('ssTitle').value='';
  document.getElementById('ssFileInput').value='';
  document.getElementById('ssDropZone').classList.remove('has-file');
  document.getElementById('ssDropIco').textContent='ðŸ“Š';
  document.getElementById('ssDropTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
  document.getElementById('ssPreviewWrap').style.display='none';
  document.getElementById('ssStatus').style.display='none';
  _ssRows=[];
  openModal('ssImportModal');
}

function ssFilterCourses(){
  const classId = document.getElementById('ssClass').value;
  document.getElementById('ssCourse').innerHTML =
    db.courses.filter(c=>c.classId===classId)
      .map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function ssFileChosen(inp){
  const file = inp.files[0];
  if(!file) return;
  document.getElementById('ssDropIco').textContent='â³';
  document.getElementById('ssDropTxt').innerHTML=`Reading <strong>${file.name}</strong>â€¦`;
  document.getElementById('ssStatus').style.display='none';
  const ext = file.name.split('.').pop().toLowerCase();
  const reader = new FileReader();
  if(ext==='csv'){
    reader.onload = e => ssParseCSV(e.target.result, file.name);
    reader.readAsText(file);
  } else if(ext==='xlsx'||ext==='xls'){
    reader.onload = e => ssParseXLSX(e.target.result, file.name);
    reader.readAsArrayBuffer(file);
  } else {
    ssShowStatus('âš  Unsupported file. Use .xlsx, .xls, or .csv','error');
    document.getElementById('ssDropIco').textContent='âŒ';
    document.getElementById('ssDropTxt').innerHTML='Unsupported file type';
  }
}

function ssParseCSV(text, fname){
  // Parse CSV â€” handle quoted fields
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2){ ssShowStatus('âš  CSV has no data rows','error'); return; }
  const parse = line => {
    const cols=[]; let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){ inQ=!inQ; }
      else if(c===','&&!inQ){ cols.push(cur.trim()); cur=''; }
      else cur+=c;
    }
    cols.push(cur.trim());
    return cols;
  };
  const headers = parse(lines[0]).map(h=>h.toLowerCase().replace(/[^a-z0-9]/g,''));
  const rows = lines.slice(1).map(l=>{ const c=parse(l); return headers.reduce((o,h,i)=>{o[h]=c[i]||'';return o;},{}); });
  ssProcessRows(rows, fname);
}

function ssParseXLSX(buf, fname){
  try{
    // Use SheetJS if available
    if(typeof XLSX !== 'undefined'){
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const raw = XLSX.utils.sheet_to_json(ws, {defval:''});
      // normalise header keys
      const norm = raw.map(row=>{
        const o={};
        Object.entries(row).forEach(([k,v])=>{ o[k.toLowerCase().replace(/[^a-z0-9]/g,'')]=String(v).trim(); });
        return o;
      });
      ssProcessRows(norm, fname);
    } else {
      // Fallback: try to load SheetJS dynamically
      ssShowStatus('â³ Loading spreadsheet libraryâ€¦','info');
      const s=document.createElement('script');
      s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      s.onload=()=>ssParseXLSX(buf, fname);
      s.onerror=()=>ssShowStatus('âš  Could not load spreadsheet library. Try a .csv file instead.','error');
      document.head.appendChild(s);
    }
  } catch(e){
    ssShowStatus('âš  Error reading spreadsheet: '+e.message,'error');
  }
}

function ssProcessRows(rows, fname){
  if(!rows.length){ ssShowStatus('âš  No data rows found in file','error'); return; }

  // Detect columns â€” look for matric, name, score, total, remarks
  // Common column name variants
  const findCol = (row, variants) => {
    const keys = Object.keys(row);
    for(const v of variants){
      const k = keys.find(k=>k.includes(v));
      if(k) return k;
    }
    return null;
  };
  const sample = rows[0];
  const colMatric  = findCol(sample,['matric','reg','registration','student_id','studentid','id']);
  const colName    = findCol(sample,['name','student','fullname','studentname']);
  const colScore   = findCol(sample,['score','mark','marks','result','obtained','scored']);
  const colTotal   = findCol(sample,['total','outof','max','maximum','fullmark','fullmarks']);
  const colRemarks = findCol(sample,['remark','remarks','comment','note']);

  if(!colScore){ ssShowStatus('âš  Cannot find a score/marks column. Make sure your spreadsheet has a "Score" or "Marks" column.','error'); return; }

  _ssRows = rows.map((row,i)=>{
    const matric  = (colMatric  ? row[colMatric]  : '').trim().toUpperCase();
    const name    = (colName    ? row[colName]    : '').trim();
    const scoreRaw= colScore ? row[colScore] : '';
    const totalRaw= colTotal ? row[colTotal] : '';
    const remarks = colRemarks ? row[colRemarks] : '';

    if(!scoreRaw && scoreRaw!==0){ return {status:'skip', reason:'No score', matric, name, raw:row}; }
    const score = parseFloat(String(scoreRaw).replace(/[^0-9.]/g,''));
    const total = totalRaw ? parseFloat(String(totalRaw).replace(/[^0-9.]/g,'')) : 100;
    if(isNaN(score)){ return {status:'skip', reason:'Invalid score: '+scoreRaw, matric, name, raw:row}; }

    // Normalise to percentage
    let pct = score;
    if(total && total>0 && total!==100) pct = Math.round((score/total)*1000)/10;
    if(pct<0||pct>100){ return {status:'skip', reason:`Score ${pct}% out of range`, matric, name, raw:row}; }

    // Match student by matric, then by name
    const students = db.users.filter(u=>u.role==='student');
    let matched = null;
    if(matric) matched = students.find(u=>(u.matric||'').trim().toUpperCase()===matric);
    if(!matched && name){
      const nl=name.toLowerCase();
      matched = students.find(u=>u.name.toLowerCase()===nl)
             || students.find(u=>u.name.toLowerCase().includes(nl)||nl.includes(u.name.toLowerCase()));
    }

    const grade = calcGrade(pct);
    return {
      status: 'ok',
      matric: matched?(matched.matric||matric):matric,
      name:   matched?matched.name:name,
      score:  pct,
      rawScore: score,
      total:  total||100,
      grade,
      remarks: remarks||'',
      studentId: matched?matched.id:null,
      matched: !!matched,
      removed: false,
    };
  }).filter(r=>r!==null);

  const ok  = _ssRows.filter(r=>r.status==='ok').length;
  const skip= _ssRows.filter(r=>r.status==='skip').length;
  const linked = _ssRows.filter(r=>r.status==='ok'&&r.matched).length;

  document.getElementById('ssDropIco').textContent='âœ…';
  document.getElementById('ssDropTxt').innerHTML=`<strong>${fname}</strong> â€” ${rows.length} rows read`;
  document.getElementById('ssDropZone').classList.add('has-file');
  ssShowStatus(`âœ“ ${ok} valid rows Â· ${linked} matched to registered students Â· ${skip} skipped`,'ok');
  ssRenderPreview();
}

function ssRenderPreview(){
  const wrap = document.getElementById('ssPreviewWrap');
  const body = document.getElementById('ssPreviewBody');
  const count= document.getElementById('ssPreviewCount');
  const errs = document.getElementById('ssPreviewErrors');

  wrap.style.display='';
  const visible = _ssRows.filter(r=>!r.removed);
  const ok   = visible.filter(r=>r.status==='ok');
  const skip = visible.filter(r=>r.status==='skip');
  count.textContent=`${ok.length} valid Â· ${skip.length} skipped`;
  errs.textContent = skip.length?`${skip.length} row${skip.length>1?'s':''} skipped`:'';

  document.getElementById('ssImportBtn').disabled = ok.length===0;
  document.getElementById('ssImportBtnCount').textContent=ok.length;

  body.innerHTML = _ssRows.map((r,i)=>{
    if(r.removed) return '';
    const isOk = r.status==='ok';
    const gc = isOk?gradeColor(r.grade):'var(--accent4)';
    const matchBadge = isOk?(r.matched
      ?`<span style="color:var(--accent3);font-size:10px;">âœ“ matched</span>`
      :`<span style="color:#fbbf24;font-size:10px;">âš  unlinked</span>`)
      :`<span style="color:var(--accent4);font-size:10px;">${r.reason||'skip'}</span>`;
    return `<div class="parse-row ${isOk?'parse-ok':'parse-err'}" style="grid-template-columns:22px 110px 1fr 70px 60px 80px 24px;">
      <span class="parse-status">${isOk?'âœ…':'âŒ'}</span>
      <span class="parse-matric">${r.matric||'â€”'}</span>
      <span class="parse-name">${r.name||'â€”'}</span>
      <span class="parse-score" style="color:${gc}">${isOk?r.score+'%':'â€”'}</span>
      <span class="parse-grade" style="color:${gc};font-weight:700;">${isOk?r.grade:'â€”'}</span>
      <span>${matchBadge}</span>
      <button class="parse-del" onclick="ssRemoveRow(${i})" title="Remove">âœ•</button>
    </div>`;
  }).join('');
}

function ssRemoveRow(i){
  _ssRows[i].removed=true;
  ssRenderPreview();
}

function ssShowStatus(msg, type){
  const el=document.getElementById('ssStatus');
  el.style.display='block';
  el.style.color=type==='error'?'var(--accent4)':type==='ok'?'var(--accent3)':'var(--accent2)';
  el.textContent=msg;
}

function ssImportAll(){
  const type    = document.getElementById('ssType').value;
  const title   = document.getElementById('ssTitle').value.trim();
  const classId = document.getElementById('ssClass').value;
  const courseId= document.getElementById('ssCourse').value;

  if(!title)    return toast('Please enter a result title (e.g. "Mid-Term Test 2024")');
  if(!courseId) return toast('Please select a course.');

  const valid = _ssRows.filter(r=>!r.removed&&r.status==='ok');
  if(!valid.length) return toast('No valid rows to import.');

  const now=new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date=months[now.getMonth()]+' '+now.getDate()+', '+now.getFullYear();

  let imported=0;
  valid.forEach(r=>{
    db.results.push({
      id:          'r_'+Date.now()+'_'+imported,
      type, title, classId, courseId,
      studentId:   r.studentId||null,
      studentName: r.name||'Unknown',
      matric:      r.matric||'',
      score:       r.score,
      total:       r.total||100,
      grade:       r.grade,
      date,
      uploadedBy:  currentUser.name,
      remarks:     r.remarks||''
    });
    imported++;
  });

  saveDB();
  closeModal('ssImportModal');
  renderResultsView();
  toast(`âœ“ ${imported} result${imported!==1?'s':''} imported from spreadsheet`);
}

function exportResultsCSV(){
  if(!db.results||!db.results.length){ toast('No results to export'); return; }
  const classId  = document.getElementById('resultFilterClass').value;
  const type     = document.getElementById('resultFilterType').value;
  const courseId = document.getElementById('resultFilterCourse').value;
  let results = db.results.slice();
  if(classId)  results=results.filter(r=>r.classId===classId);
  if(type)     results=results.filter(r=>r.type===type);
  if(courseId) results=results.filter(r=>r.courseId===courseId);
  if(!results.length){ toast('No results match the current filter'); return; }

  const header = ['Matric No.','Student','Type','Title','Course','Class','Score (%)','Total','Grade','Date','Uploaded By','Remarks'];
  const rows = results.map(r=>{
    const co=db.courses.find(c=>c.id===r.courseId)||{title:'â€”',code:'â€”'};
    const cl=db.classes.find(c=>c.id===r.classId)||{name:'â€”'};
    return [r.matric||'â€”',r.studentName,r.type,r.title,`${co.code} â€” ${co.title}`,cl.name,r.score,r.total,r.grade,r.date,r.uploadedBy||'â€”',r.remarks||'â€”'];
  });
  const csv = [header,...rows].map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href=url; a.download='results_export.csv'; a.click();
  URL.revokeObjectURL(url);
  toast('CSV exported âœ“');
}

// ============================================================
// PASTE IMPORT â€” bulk result upload from pasted text
// ============================================================
let _piRows = [];  // parsed rows: {matric, name, score, total, grade, status, warn, removed}

function openPasteImport(){
  if(!db.results) db.results=[];
  // Populate dropdowns
  const clSel = document.getElementById('piClass');
  clSel.innerHTML = db.classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  piFilterCourses();
  // Reset
  document.getElementById('piType').value = 'test';
  document.getElementById('piTitle').value = '';
  document.getElementById('piPasteBox').value = '';
  document.getElementById('piPreviewWrap').style.display = 'none';
  _piRows = [];
  openModal('pasteImportModal');
}

function piFilterCourses(){
  const classId = document.getElementById('piClass').value;
  document.getElementById('piCourse').innerHTML =
    db.courses.filter(c=>c.classId===classId)
      .map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function piParseAndPreview(){
  const raw = document.getElementById('piPasteBox').value;
  if(!raw.trim()){ document.getElementById('piPreviewWrap').style.display='none'; _piRows=[]; return; }

  const lines = raw.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
  _piRows = lines.map((line, idx) => piParseLine(line, idx));

  piRenderPreview();
}

function piParseLine(line, idx){
  // Detect separator: tab > comma > multiple spaces
  let parts;
  if(line.includes('\t'))       parts = line.split('\t').map(s=>s.trim());
  else if(line.includes(','))   parts = line.split(',').map(s=>s.trim());
  else                          parts = line.split(/\s{2,}/).map(s=>s.trim());

  // Remove empty parts
  parts = parts.filter(p=>p.length>0);

  if(parts.length < 2){
    return {matric:'', name:line, score:null, total:100, grade:'', status:'err', warn:'Cannot parse â€” need at least name and score', raw:line, removed:false};
  }

  // Heuristic: detect matric number (contains / or - or digits only or starts with letter+digits pattern)
  let matric = '', name = '', score = null, total = 100;

  // Check if first column looks like a matric number
  const looksLikeMatric = p => /[\/\-]/.test(p) || /^[A-Z]{0,5}\d{2,}/.test(p) || /^\d{4,}/.test(p);
  // Check if something is a number (score)
  const isNum = p => /^\d+(\.\d+)?$/.test(p);

  let remaining = [...parts];

  // Extract matric if present
  if(looksLikeMatric(remaining[0])){
    matric = remaining.shift();
  }

  // Extract numbers from the end (score, optional total)
  const nums = [];
  while(remaining.length > 0 && isNum(remaining[remaining.length-1])){
    nums.unshift(remaining.pop());
  }

  // Everything left is the name
  name = remaining.join(' ');

  if(nums.length >= 2){ score = parseFloat(nums[0]); total = parseFloat(nums[1]); }
  else if(nums.length === 1){ score = parseFloat(nums[0]); total = 100; }

  if(!name) name = '(unknown)';

  if(score === null){
    return {matric, name, score:null, total, grade:'', status:'err', warn:'No score found', raw:line, removed:false};
  }

  // Normalise score to percentage
  let pct = score;
  if(total && total !== 100) pct = Math.round((score / total) * 100 * 10) / 10;
  if(pct < 0 || pct > 100){
    return {matric, name, score:pct, total, grade:'', status:'err', warn:`Score ${pct}% out of range`, raw:line, removed:false};
  }

  // Try to match to a registered student
  const classId = document.getElementById('piClass').value;
  const students = db.users.filter(u=>u.role==='student');
  let matched = null;

  // Match by matric first
  if(matric) matched = students.find(u=>(u.matric||'').toUpperCase()===matric.toUpperCase());
  // Then by name (case-insensitive, partial)
  if(!matched && name){
    const nl = name.toLowerCase();
    matched = students.find(u=>u.name.toLowerCase()===nl)
           || students.find(u=>u.name.toLowerCase().includes(nl)||nl.includes(u.name.toLowerCase()));
  }

  const grade = calcGrade(pct);
  const warn  = !matched ? 'Student not in system â€” will save as unlinked' : '';
  const status = 'ok';

  return {
    matric: matched ? (matched.matric||matric) : matric,
    name:   matched ? matched.name : name,
    score:  pct,
    total,
    grade,
    status,
    warn,
    raw:    line,
    removed: false,
    studentId: matched ? matched.id : null,
  };
}

function piRenderPreview(){
  const visible = _piRows.filter(r=>!r.removed);
  const okCount  = visible.filter(r=>r.status==='ok').length;
  const errCount = visible.filter(r=>r.status==='err').length;

  document.getElementById('piPreviewWrap').style.display = '';
  document.getElementById('piPreviewCount').textContent = `${visible.length} row${visible.length!==1?'s':''} parsed`;
  document.getElementById('piPreviewErrors').textContent = errCount ? `${errCount} error${errCount!==1?'s':''}` : '';

  document.getElementById('piSummary').textContent =
    `${okCount} valid Â· ${errCount} skipped`;
  document.getElementById('piImportBtn').disabled = okCount===0;

  document.getElementById('piPreviewBody').innerHTML = _piRows.map((r,i)=>{
    if(r.removed) return '';
    const isOk  = r.status==='ok';
    const gc    = isOk ? gradeColor(r.grade) : 'var(--accent4)';
    return `<div class="parse-row ${isOk?'parse-ok':'parse-err'}">
      <span class="parse-status">${isOk?'âœ…':'âŒ'}</span>
      <span class="parse-matric" title="${r.matric||'â€”'}">${r.matric||'â€”'}</span>
      <span class="parse-name">${r.name}</span>
      <span class="parse-score" style="color:${gc}">${r.score!==null?r.score+'%':'â€”'}</span>
      <span class="parse-grade" style="color:${gc}">${r.grade||'â€”'}</span>
      <span class="parse-warn">${r.warn||'<span style="color:var(--accent3);font-size:10px">matched</span>'}</span>
      <button class="parse-del" onclick="piRemoveRow(${i})" title="Remove row">âœ•</button>
    </div>`;
  }).join('');
}

function piRemoveRow(idx){
  _piRows[idx].removed = true;
  piRenderPreview();
}

function piImportAll(){
  const type    = document.getElementById('piType').value;
  const title   = document.getElementById('piTitle').value.trim();
  const classId = document.getElementById('piClass').value;
  const courseId= document.getElementById('piCourse').value;

  if(!title)   return toast('Please enter a title before importing.');
  if(!courseId) return toast('Please select a course.');

  const now = new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date = months[now.getMonth()]+' '+now.getDate()+', '+now.getFullYear();

  const valid = _piRows.filter(r=>!r.removed && r.status==='ok');
  if(!valid.length) return toast('No valid rows to import.');

  let imported = 0;
  valid.forEach(r=>{
    db.results.push({
      id:          'r_'+Date.now()+'_'+imported,
      type, title, classId, courseId,
      studentId:   r.studentId||null,
      studentName: r.name,
      matric:      r.matric||'',
      score:       r.score,
      total:       r.total||100,
      grade:       r.grade,
      date,
      uploadedBy:  currentUser.name,
      remarks:     ''
    });
    imported++;
  });

  saveDB();
  closeModal('pasteImportModal');
  renderResultsTable();
  toast(`âœ“ ${imported} result${imported!==1?'s':''} imported successfully`);
}

// ============================================================
// ADD LECTURER (admin only)
// ============================================================
function addLecturerAccount(){
  const name    =document.getElementById('lecturerName').value.trim();
  const username=document.getElementById('lecturerUsername').value.trim().toLowerCase().replace(/\s+/g,'');
  const pass    =document.getElementById('lecturerPassword').value.trim();
  if(!name||!username||!pass){toast('Please fill in all fields');return;}
  if(username.length<3){toast('Username must be at least 3 characters');return;}
  if(pass.length<4){toast('Password must be at least 4 characters');return;}
  if(username===ADMIN_USERNAME){toast('That username is reserved');return;}
  if(db.users.find(u=>(u.username||'').toLowerCase()===username)){toast('An account with that username already exists');return;}
  const u={id:'u_'+Date.now(),name,username,password:pass,role:'teacher',cls:'All',classId:null};
  db.users.push(u); saveDB();
  closeModal('addLecturerModal');
  document.getElementById('lecturerName').value='';
  document.getElementById('lecturerUsername').value='';
  document.getElementById('lecturerPassword').value='';
  renderUsers();
  toast(`Lecturer account for "${name}" created âœ“`);
}

// â”€â”€ Edit Course â”€â”€
function openEditCourse(cid){
  const co=db.courses.find(c=>c.id===cid);
  if(!co) return;
  const newTitle=prompt('Course title:',co.title);
  if(newTitle===null) return;
  const newCode=prompt('Course code:',co.code);
  if(newCode===null) return;
  const newLecturer=prompt('Lecturer name:', co.lecturer);
  if(newLecturer===null) return;
  co.title=newTitle.trim()||co.title;
  co.code=newCode.trim()||co.code;
  co.lecturer=newLecturer.trim()||co.lecturer;
  saveDB();
  renderCourses(co.classId);
  logActivity('edit_course', `Course "${co.title}" updated`);
  toast('Course updated âœ“');
}

// â”€â”€ Delete Course â”€â”€
function confirmDeleteCourse(cid){
  const co=db.courses.find(c=>c.id===cid);
  if(!co) return;
  const hCount=db.handouts.filter(h=>h.courseId===cid).length;
  const fCount=(db.lecturerFolders||[]).filter(f=>f.courseId===cid).length;
  const msg=`Delete course "${co.title}" (${co.code})?${hCount>0?`\n\nThis will also delete ${hCount} note(s).`:''}${fCount>0?`\nAnd ${fCount} lecturer folder(s).`:''}`;
  if(!confirm(msg)) return;
  const classId=co.classId;
  // Remove all handouts
  const hIds=db.handouts.filter(h=>h.courseId===cid).map(h=>h.id);
  hIds.forEach(id=>{ deleteFileData(id); });
  db.handouts=db.handouts.filter(h=>h.courseId!==cid);
  // Remove lecturer folders
  if(db.lecturerFolders) db.lecturerFolders=db.lecturerFolders.filter(f=>f.courseId!==cid);
  // Remove course
  db.courses=db.courses.filter(c=>c.id!==cid);
  saveDB();
  renderCourses(classId);
  renderDashboard();
  logActivity('delete_course', `Course "${co.title}" deleted`);
  toast('Course deleted');
}

// â”€â”€ Delete Class â”€â”€
function confirmDeleteClass(cid){
  const cl=db.classes.find(c=>c.id===cid);
  if(!cl) return;
  const cCount=db.courses.filter(c=>c.classId===cid).length;
  if(!confirm(`Delete class "${cl.name}"?\n\nThis will also delete ${cCount} course(s) and all their notes.`)) return;
  const courseIds=db.courses.filter(c=>c.classId===cid).map(c=>c.id);
  courseIds.forEach(cid2=>{
    db.handouts.filter(h=>h.courseId===cid2).forEach(h=>deleteFileData(h.id));
    db.handouts=db.handouts.filter(h=>h.courseId!==cid2);
    if(db.lecturerFolders) db.lecturerFolders=db.lecturerFolders.filter(f=>f.courseId!==cid2);
  });
  db.courses=db.courses.filter(c=>c.classId!==cid);
  db.classes=db.classes.filter(c=>c.id!==cid);
  // Remove students from this class
  db.users.filter(u=>u.classId===cid).forEach(u=>{u.classId=''; u.cls='';});
  saveDB();
  renderDashboard();
  renderSidebar();
  logActivity('delete_class', `Class "${cl.name}" deleted`);
  toast(`Class "${cl.name}" deleted`);
}
function addClass(){
  const name=document.getElementById('newClassName').value.trim();
  const full=document.getElementById('newClassFull').value.trim();
  const color=document.getElementById('newClassColor').value;
  if(!name||!full){toast('Please fill in all fields');return;}
  db.classes.push({id:'cls_'+Date.now(),name,full,color});
  saveDB(); closeModal('addClassModal');
  document.getElementById('newClassName').value='';
  document.getElementById('newClassFull').value='';
  renderDashboard(); renderSidebar();
  logActivity('add_class', `Class "${name}" (${full}) created`);
  toast(`Class "${name}" created âœ“`);
}

// ============================================================
// ADD COURSE
// ============================================================
function openAddCourseModal(){
  const sel=document.getElementById('newCourseClass');
  sel.innerHTML=db.classes.map(cl=>`<option value="${cl.id}">${cl.name}</option>`).join('');
  if(currentClassId) sel.value=currentClassId;
  openModal('addCourseModal');
}
function addCourse(){
  const title=document.getElementById('newCourseTitle').value.trim();
  const code=document.getElementById('newCourseCode').value.trim();
  const lecturer=document.getElementById('newCourseLecturer').value.trim();
  const classId=document.getElementById('newCourseClass').value;
  if(!title||!code){toast('Please fill in title and code');return;}
  const creditUnits = parseInt(document.getElementById('newCourseCreditUnits')?.value)||3;
  db.courses.push({id:'co_'+Date.now(),classId,title,code,lecturer:lecturer||currentUser.name,creditUnits});
  saveDB(); closeModal('addCourseModal');
  document.getElementById('newCourseTitle').value='';
  document.getElementById('newCourseCode').value='';
  document.getElementById('newCourseLecturer').value='';
  if(currentClassId===classId) renderCourses(classId);
  renderDashboard();
  logActivity('add_course', `Course "${title}" (${code}) added to class ${classId}`);
  toast(`Course "${title}" added âœ“`);
}

// ============================================================
// ADD HANDOUT
// ============================================================
function openAddHandoutModal(){
  const sel=document.getElementById('newHandoutCourse');
  const courses=currentClassId?db.courses.filter(c=>c.classId===currentClassId):db.courses;
  sel.innerHTML=courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
  if(currentCourseId) sel.value=currentCourseId;
  document.getElementById('handoutDrop').classList.remove('has-file');
  document.getElementById('dropIco').textContent='ðŸ“';
  document.getElementById('dropTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
  document.getElementById('handoutFile').value='';
  document.getElementById('newHandoutTitle').value='';
  // Show folder context if uploading into a specific folder
  const banner=document.getElementById('addHandoutFolderBanner');
  const folderId=window._addHandoutFolderId||currentFolderId||null;
  if(folderId){
    if(!window._addHandoutFolderId){ window._addHandoutFolderId=folderId; }
    const f=(db.lecturerFolders||[]).find(x=>x.id===folderId);
    if(f){
      if(!window._addHandoutFolderLecturer) window._addHandoutFolderLecturer=f.lecturerName;
      banner.style.display='flex';
      document.getElementById('addHandoutFolderBannerText').textContent=`Uploading to: ${f.lecturerName}`;
      document.getElementById('addHandoutModalTitle').textContent='Upload to Folder';
      document.getElementById('addHandoutCourseRow').style.display='none';
    }
  } else {
    banner.style.display='none';
    document.getElementById('addHandoutModalTitle').textContent='Add Note / File';
    document.getElementById('addHandoutCourseRow').style.display='';
  }
  openModal('addHandoutModal');
}

function addHandout(){
  const title=document.getElementById('newHandoutTitle').value.trim();
  const courseId=document.getElementById('newHandoutCourse').value;
  const type=document.getElementById('newHandoutType').value;
  const fileInp=document.getElementById('handoutFile');
  if(!title){toast('Please enter a title');return;}
  const id='h_'+Date.now();
  const now=new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date=months[now.getMonth()]+' '+now.getDate();

  // Check if adding to a specific folder
  const folderId=window._addHandoutFolderId||null;
  const folderLecturer=window._addHandoutFolderLecturer||null;
  const handout={id,courseId,title,type,date,lecturer:folderLecturer||currentUser.name};
  if(folderId) handout.folderId=folderId;

  const doFinish=()=>{
    db.handouts.push(handout); saveDB();
    closeModal('addHandoutModal');
    // If we're in the folder view, refresh it; otherwise refresh course folders
    if(folderId && currentFolderId===folderId){
      renderHandouts(folderId);
    } else if(folderId){
      goToLecturerFolder(folderId);
    } else if(currentCourseId===courseId){
      renderCourseFolders(courseId);
    }
    renderDashboard();
    logActivity('upload_note', `"${title}" uploaded to course ${courseId}${folderId?' in folder '+folderId:''}`);
    toast(`"${title}" uploaded âœ“`);
    window._addHandoutFolderId=null;
    window._addHandoutFolderLecturer=null;
  };

  if(fileInp.files[0]){
    const file=fileInp.files[0];
    const reader=new FileReader();
    reader.onload=e=>{saveFileData(id,{name:file.name,dataUrl:e.target.result,mime:file.type});doFinish();};
    reader.readAsDataURL(file);
  } else { doFinish(); }
}

function deleteHandout(id){
  if(!confirm('Delete this document?')) return;
  db.handouts=db.handouts.filter(h=>h.id!==id);
  deleteFileData(id);
  saveDB();
  if(currentFolderId) renderHandouts(currentFolderId);
  else if(currentCourseId) renderCourseFolders(currentCourseId);
  renderDashboard();
  toast('Document deleted');
}

// ============================================================
// UPLOAD MODAL
// ============================================================
function filterUploadCourses(){
  const classId=document.getElementById('uploadClass').value;
  document.getElementById('uploadCourse').innerHTML=db.courses.filter(c=>c.classId===classId).map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}
function openModal(id){
  if(id==='uploadModal'){
    document.getElementById('uploadClass').innerHTML=db.classes.map(cl=>`<option value="${cl.id}">${cl.name}</option>`).join('');
    filterUploadCourses();
    document.getElementById('uploadDropIco').textContent='ðŸ“';
    document.getElementById('uploadDropTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
    document.getElementById('uploadFile').value='';
    document.getElementById('uploadTitle').value='';
  }
  document.getElementById(id).classList.add('open');
}
function submitUpload(){
  const title=document.getElementById('uploadTitle').value.trim();
  const courseId=document.getElementById('uploadCourse').value;
  const type=document.getElementById('uploadType').value;
  const fileInp=document.getElementById('uploadFile');
  if(!title||!courseId){toast('Please fill in all fields');return;}
  const id='h_'+Date.now();
  const now=new Date();
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const date=months[now.getMonth()]+' '+now.getDate();
  const handout={id,courseId,title,type,date,lecturer:currentUser.name};
  const doFinish=()=>{
    db.handouts.push(handout); saveDB();
    closeModal('uploadModal');
    renderDashboard();
    toast(`"${title}" uploaded âœ“`);
  };
  if(fileInp.files[0]){
    const file=fileInp.files[0];
    const reader=new FileReader();
    reader.onload=e=>{saveFileData(id,{name:file.name,dataUrl:e.target.result,mime:file.type});doFinish();};
    reader.readAsDataURL(file);
  } else { doFinish(); }
}

function autoDetectType(fname,selId){
  const sel=document.getElementById(selId);
  if(fname.endsWith('.pdf')) sel.value='pdf';
  else if(/\.(doc|docx)$/.test(fname)) sel.value='doc';
  else if(/\.(ppt|pptx)$/.test(fname)) sel.value='ppt';
  else if(/\.(png|jpg|jpeg|gif|webp)$/.test(fname)) sel.value='img';
}
function handoutFileChosen(inp){
  if(!inp.files[0]) return;
  document.getElementById('handoutDrop').classList.add('has-file');
  document.getElementById('dropIco').textContent='âœ…';
  document.getElementById('dropTxt').innerHTML=`<strong>${inp.files[0].name}</strong>`;
  autoDetectType(inp.files[0].name.toLowerCase(),'newHandoutType');
}
function uploadFileChosen(inp){
  if(!inp.files[0]) return;
  document.getElementById('uploadDropIco').textContent='âœ…';
  document.getElementById('uploadDropTxt').innerHTML=`<strong>${inp.files[0].name}</strong>`;
  autoDetectType(inp.files[0].name.toLowerCase(),'uploadType');
}

// ============================================================
// FILE STORE â€” persisted to localStorage (base64)
// Key: nv_file_{handoutId}  Value: JSON {name,dataUrl,mime}
// ============================================================
function saveFileData(handoutId, fileData){
  try{
    localStorage.setItem('nv_file_'+handoutId, JSON.stringify(fileData));
    fileStore[handoutId]=fileData;
  }catch(e){
    // localStorage quota exceeded â€” keep in memory only
    fileStore[handoutId]=fileData;
    console.warn('File too large to persist, kept in memory only');
  }
}
function loadFileData(handoutId){
  if(fileStore[handoutId]) return fileStore[handoutId];
  try{
    const s=localStorage.getItem('nv_file_'+handoutId);
    if(s){ const d=JSON.parse(s); fileStore[handoutId]=d; return d; }
  }catch(e){}
  return null;
}
function deleteFileData(handoutId){
  delete fileStore[handoutId];
  try{ localStorage.removeItem('nv_file_'+handoutId); }catch(e){}
}

// ============================================================
// PREVIEW â€” FULL SCREEN VIEWER
// ============================================================
let pvState = {
  handoutId: null,
  zoom: 1,
  page: 1,
  totalPages: 1,
  pdfDoc: null,
  isImg: false,
  imgZoomed: false,
};

// Load PDF.js lazily
let pdfJsLoaded = false;
function loadPdfJs(cb){
  if(pdfJsLoaded){ cb(); return; }
  const s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  s.onload=()=>{
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    pdfJsLoaded=true; cb();
  };
  document.head.appendChild(s);
}

function openPreview(id){
  const h=db.handouts.find(x=>x.id===id);
  if(!h) return;
  pvState.handoutId=id;
  pvState.zoom=1;
  pvState.page=1;
  pvState.totalPages=1;
  pvState.pdfDoc=null;
  pvState.isImg=false;
  pvState.imgZoomed=false;

  const co=db.courses.find(c=>c.id===h.courseId)||{title:'Unknown',code:'',classId:''};
  const cl=db.classes.find(c=>c.id===co.classId)||{name:'Unknown',color:'blue'};

  // Populate top bar
  document.getElementById('pvTitle').textContent=h.title;
  document.getElementById('pvSubtitle').textContent=`${co.code} â€” ${co.title} Â· ${h.lecturer}`;

  const badge=document.getElementById('pvBadge');
  badge.textContent=h.type.toUpperCase();
  badge.className='pv-badge fb-'+h.type;
  badge.style.display='';

  // Populate info panel
  document.getElementById('pvInfoTitle').textContent=h.title;
  document.getElementById('pvInfoType').textContent=h.type.toUpperCase();
  document.getElementById('pvInfoLecturer').textContent=h.lecturer;
  document.getElementById('pvInfoDate').textContent=h.date;
  document.getElementById('pvInfoCourse').textContent=`${co.code} â€” ${co.title}`;
  document.getElementById('pvInfoClass').textContent=cl.name;

  // Show overlay
  document.getElementById('pvOverlay').classList.add('open');
  document.body.style.overflow='hidden';

  // Show spinner
  pvShowSpinner();

  const fd = loadFileData(id);

  if(!fd){
    // No file stored
    pvShowNoFile(h);
    document.getElementById('pvInfoSize').textContent='No file stored';
    document.getElementById('pvDlBtn').disabled=true;
    return;
  }

  // File size display
  const sizeBytes = Math.round((fd.dataUrl.length * 3)/4);
  document.getElementById('pvInfoSize').textContent = formatBytes(sizeBytes);
  document.getElementById('pvDlBtn').disabled=false;

  const isImage = h.type==='img' || (fd.mime && fd.mime.startsWith('image/'));
  const isPdf   = h.type==='pdf' || fd.mime==='application/pdf';

  if(isImage){
    pvState.isImg=true;
    pvShowImage(fd, h);
    pvHidePdfNav();
  } else if(isPdf){
    pvState.isImg=false;
    pvHidePdfNav();
    loadPdfJs(()=> pvLoadPdf(fd.dataUrl));
  } else {
    // DOC / PPT â€” show rich placeholder with external viewer option
    pvState.isImg=false;
    pvHidePdfNav();
    pvShowDocPlaceholder(h, fd, co, cl);
  }
}

function formatBytes(b){
  if(b<1024) return b+' B';
  if(b<1048576) return (b/1024).toFixed(1)+' KB';
  return (b/1048576).toFixed(1)+' MB';
}

function pvShowSpinner(){
  document.getElementById('pvBody').innerHTML=`
    <div class="pv-spinner">
      <div class="pv-spin-ring"></div>
      <div class="pv-spin-txt">Loading previewâ€¦</div>
    </div>`;
}

function pvShowNoFile(h){
  const icons={pdf:'ðŸ“„',doc:'ðŸ“',ppt:'ðŸ“Š',img:'ðŸ–¼ï¸'};
  document.getElementById('pvBody').innerHTML=`
    <div class="pv-placeholder">
      <div class="pv-ph-ico">${icons[h.type]||'ðŸ“Ž'}</div>
      <div class="pv-ph-title">No File Attached</div>
      <div class="pv-ph-sub">This handout was added as a title-only entry. The lecturer has not uploaded a file yet.</div>
      <div class="pv-ph-fname">${h.title.toLowerCase().replace(/\s+/g,'-')}.${h.type}</div>
      <div class="pv-meta-strip">
        <div class="pv-meta-item"><div class="pv-meta-lbl">Type</div><div class="pv-meta-val">${h.type.toUpperCase()}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Lecturer</div><div class="pv-meta-val">${h.lecturer}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Date</div><div class="pv-meta-val">${h.date}</div></div>
      </div>
    </div>`;
  pvHidePdfNav();
}

function pvShowImage(fd, h){
  const body=document.getElementById('pvBody');
  body.innerHTML=`<div class="pv-img-wrap" id="pvImgWrap">
    <img class="pv-img-display" id="pvImgEl" src="${fd.dataUrl}" alt="${h.title}"
      onclick="pvToggleImgZoom(this)"
      style="max-width:100%;transform-origin:center center;">
  </div>`;
  const img=document.getElementById('pvImgEl');
  img.onload=()=>{ pvApplyImgZoom(); };
}

function pvApplyImgZoom(){
  const img=document.getElementById('pvImgEl');
  if(!img) return;
  img.style.transform=`scale(${pvState.zoom})`;
  document.getElementById('pvZoomVal').textContent=Math.round(pvState.zoom*100)+'%';
}

function pvToggleImgZoom(img){
  pvState.imgZoomed=!pvState.imgZoomed;
  pvState.zoom=pvState.imgZoomed?2:1;
  img.classList.toggle('zoomed', pvState.imgZoomed);
  pvApplyImgZoom();
}

// PDF rendering with PDF.js
async function pvLoadPdf(dataUrl){
  try{
    const raw=atob(dataUrl.split(',')[1]);
    const arr=new Uint8Array(raw.length);
    for(let i=0;i<raw.length;i++) arr[i]=raw.charCodeAt(i);
    const loadingTask=pdfjsLib.getDocument({data:arr});
    pvState.pdfDoc=await loadingTask.promise;
    pvState.totalPages=pvState.pdfDoc.numPages;
    pvShowPdfNav();
    await pvRenderPdfPage(pvState.page);
  }catch(err){
    document.getElementById('pvBody').innerHTML=`
      <div class="pv-placeholder">
        <div class="pv-ph-ico">âš ï¸</div>
        <div class="pv-ph-title">PDF could not be rendered</div>
        <div class="pv-ph-sub">${err.message}</div>
      </div>`;
  }
}

async function pvRenderPdfPage(pageNum){
  if(!pvState.pdfDoc) return;
  pvShowSpinner();
  const page=await pvState.pdfDoc.getPage(pageNum);
  const body=document.getElementById('pvBody');

  // Build a scrollable wrap with all pages or single page
  body.innerHTML=`<div class="pv-pdf-wrap" id="pvPdfWrap"></div>`;
  const wrap=document.getElementById('pvPdfWrap');

  const viewport=page.getViewport({scale:pvState.zoom*1.5});
  const canvas=document.createElement('canvas');
  canvas.className='pv-canvas-page';
  canvas.width=viewport.width;
  canvas.height=viewport.height;
  canvas.style.width='min('+Math.round(viewport.width)+'px, 100%)';
  wrap.appendChild(canvas);

  const ctx=canvas.getContext('2d');
  await page.render({canvasContext:ctx,viewport}).promise;

  // Update page info
  document.getElementById('pvPageInfo').textContent=`${pageNum} / ${pvState.totalPages}`;
  document.getElementById('pvPrevPage').disabled=pageNum<=1;
  document.getElementById('pvNextPage').disabled=pageNum>=pvState.totalPages;
}

function pvShowPdfNav(){
  ['pvPageLabel','pvPrevPage','pvPageInfo','pvNextPage','pvPageSep'].forEach(id=>{
    document.getElementById(id).style.display='';
  });
  document.getElementById('pvPageInfo').textContent=`${pvState.page} / ${pvState.totalPages}`;
}
function pvHidePdfNav(){
  ['pvPageLabel','pvPrevPage','pvPageInfo','pvNextPage','pvPageSep'].forEach(id=>{
    document.getElementById(id).style.display='none';
  });
}

async function pvChangePage(delta){
  const next=pvState.page+delta;
  if(next<1||next>pvState.totalPages) return;
  pvState.page=next;
  await pvRenderPdfPage(pvState.page);
}

function pvShowDocPlaceholder(h, fd, co, cl){
  const icons={doc:'ðŸ“',ppt:'ðŸ“Š'};
  const colors={doc:'var(--accent)',ppt:'#fbbf24'};
  const labels={doc:'Word Document',ppt:'PowerPoint Presentation'};
  document.getElementById('pvBody').innerHTML=`
    <div class="pv-placeholder">
      <div class="pv-ph-ico" style="font-size:90px">${icons[h.type]||'ðŸ“Ž'}</div>
      <div class="pv-ph-title" style="color:${colors[h.type]||'var(--text)'}">${labels[h.type]||'Document'}</div>
      <div class="pv-ph-fname">${fd.name||h.title}</div>
      <div class="pv-ph-sub" style="margin-top:4px">
        This file type cannot be rendered directly in the browser.<br>
        Download the file to open it in Microsoft Office, LibreOffice, or Google Drive.
      </div>
      <div class="pv-meta-strip">
        <div class="pv-meta-item"><div class="pv-meta-lbl">File</div><div class="pv-meta-val" style="color:${colors[h.type]||'var(--accent)'}">${(fd.name||h.title)}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Size</div><div class="pv-meta-val">${formatBytes(Math.round((fd.dataUrl.length*3)/4))}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Lecturer</div><div class="pv-meta-val">${h.lecturer}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Course</div><div class="pv-meta-val">${co.code} â€” ${co.title}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Class</div><div class="pv-meta-val">${cl.name}</div></div>
        <div class="pv-meta-item"><div class="pv-meta-lbl">Date</div><div class="pv-meta-val">${h.date}</div></div>
      </div>
      <button class="pv-dl-btn" style="margin-top:8px;font-size:15px;padding:12px 32px;" onclick="doDownload()">â¬‡ Download to View</button>
    </div>`;
}

// ---- Zoom controls ----
function pvZoom(delta){
  if(pvState.isImg){
    pvState.zoom=Math.max(0.2,Math.min(5,pvState.zoom+delta));
    pvApplyImgZoom();
  } else if(pvState.pdfDoc){
    pvState.zoom=Math.max(0.3,Math.min(4,pvState.zoom+delta));
    document.getElementById('pvZoomVal').textContent=Math.round(pvState.zoom*100)+'%';
    pvRenderPdfPage(pvState.page);
  }
}
function pvResetZoom(){
  pvState.zoom=1;
  pvState.imgZoomed=false;
  if(pvState.isImg){ pvApplyImgZoom(); }
  else if(pvState.pdfDoc){ document.getElementById('pvZoomVal').textContent='100%'; pvRenderPdfPage(pvState.page); }
}
function pvFitWidth(){
  pvState.zoom=1;
  pvState.imgZoomed=false;
  if(pvState.isImg){ pvApplyImgZoom(); }
  else if(pvState.pdfDoc){ document.getElementById('pvZoomVal').textContent='100%'; pvRenderPdfPage(pvState.page); }
}

// ---- Fullscreen ----
function pvToggleFullscreen(){
  const el=document.getElementById('pvOverlay');
  if(!document.fullscreenElement){ el.requestFullscreen&&el.requestFullscreen(); }
  else { document.exitFullscreen&&document.exitFullscreen(); }
}

// ---- Info panel ----
function toggleInfoPanel(){
  document.getElementById('pvInfoPanel').classList.toggle('open');
}

// ---- Close ----
function closePreview(){
  document.getElementById('pvOverlay').classList.remove('open');
  document.getElementById('pvInfoPanel').classList.remove('open');
  document.body.style.overflow='';
  pvState.pdfDoc=null;
}

// Keyboard shortcuts in viewer
document.addEventListener('keydown', e=>{
  if(!document.getElementById('pvOverlay').classList.contains('open')) return;
  if(e.key==='Escape') closePreview();
  if(e.key==='ArrowRight'||e.key==='ArrowDown') pvChangePage(1);
  if(e.key==='ArrowLeft'||e.key==='ArrowUp') pvChangePage(-1);
  if(e.key==='+'||e.key==='=') pvZoom(0.15);
  if(e.key==='-') pvZoom(-0.15);
});

function doDownload(){
  if(!pvState.handoutId){ toast('No file selected'); return; }
  const h=db.handouts.find(x=>x.id===pvState.handoutId);
  const fd=loadFileData(pvState.handoutId);
  if(!fd){ toast('No file attached to this handout'); return; }
  const a=document.createElement('a');
  a.href=fd.dataUrl;
  a.download=fd.name||`${h.title.toLowerCase().replace(/\s+/g,'-')}.${h.type}`;
  a.click();
  toast('Download started â¬‡');
}

// ============================================================
// SEARCH
// ============================================================
function globalSearch(q){
  if(!q){renderDashboard();return;}
  const filtered=db.handouts.filter(h=>h.title.toLowerCase().includes(q.toLowerCase()));
  const grid=document.getElementById('classesGrid');
  if(!filtered.length){grid.innerHTML=`<div class="empty" style="grid-column:1/-1"><div class="empty-ico">ðŸ”</div><div class="empty-t">No results for "${q}"</div></div>`;return;}
  grid.innerHTML=`<div style="grid-column:1/-1;font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:.07em">${filtered.length} result${filtered.length!==1?'s':''} for "${q}"</div>`
    +filtered.map((h,i)=>{
      const co=db.courses.find(c=>c.id===h.courseId)||{title:'',code:'',classId:''};
      const cl=db.classes.find(c=>c.id===co.classId)||{name:'',color:'blue'};
      return `<div class="handout-row" style="animation-delay:${i*.04}s" onclick="openPreview('${h.id}')">
        <div class="file-badge fb-${h.type}">${h.type}</div>
        <div style="width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;background:${fileBg[h.type]};flex-shrink:0">${fileIco[h.type]}</div>
        <div class="handout-info"><div class="handout-title">${h.title}</div><div class="handout-teacher">${co.title} Â· <span style="color:${colorMap[cl.color]?.color||'var(--accent)'}">${cl.name}</span></div></div>
        <div class="handout-date">${h.date}</div>
      </div>`;
    }).join('');
}
function searchCourses(q){if(currentClassId)renderCourses(currentClassId,q.toLowerCase());}
function searchHandouts(q){
  if(currentFolderId) renderHandouts(currentFolderId,q.toLowerCase());
  else if(currentCourseId) renderCourseFolders(currentCourseId,q.toLowerCase());
}
function searchAllHandouts(q){renderAllHandouts(db.handouts.filter(h=>h.title.toLowerCase().includes(q.toLowerCase())));}

// ============================================================
// MODALS & UTILS
// ============================================================
function closeModal(id){
  document.getElementById(id).classList.remove('open');
  if(id==='addHandoutModal'){
    window._addHandoutFolderId=null;
    window._addHandoutFolderLecturer=null;
  }
}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

function toast(msg){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const el=document.createElement('div');
  el.className='toast';
  el.innerHTML=`<div class="toast-dot"></div><span>${msg}</span>`;
  document.body.appendChild(el);
  setTimeout(()=>el.style.opacity='0',2800);
  setTimeout(()=>el.remove(),3200);
}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarBg').classList.toggle('open');
}
function closeSidebar(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarBg').classList.remove('open');
}

// ============================================================
// FOLDER UPLOAD SYSTEM
// ============================================================

// Supported file types
const SUPPORTED_TYPES = {
  'application/pdf': 'pdf',
  'application/msword': 'doc',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'doc',
  'application/vnd.ms-powerpoint': 'ppt',
  'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'ppt',
  'image/png': 'img', 'image/jpeg': 'img', 'image/jpg': 'img',
  'image/gif': 'img', 'image/webp': 'img',
};
const EXT_MAP = {
  pdf:'pdf', doc:'doc', docx:'doc', ppt:'ppt', pptx:'ppt',
  png:'img', jpg:'img', jpeg:'img', gif:'img', webp:'img',
};

// State
let fuFiles = []; // array of {id, file, name, path, folder, size, type, checked, courseId, progress}

function openFolderUpload() {
  closeSidebar();
  // Populate class dropdowns
  const cls = document.getElementById('fuDefaultClass');
  cls.innerHTML = '<option value="">â€” Select class â€”</option>' +
    db.classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('fuDefaultCourse').innerHTML = '<option value="">â€” Select course â€”</option>';
  fuReset();
  document.getElementById('fuOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeFolderUpload() {
  document.getElementById('fuOverlay').classList.remove('open');
  document.body.style.overflow = '';
  renderDashboard();
}

function fuReset() {
  fuFiles = [];
  document.getElementById('fuFolderInput').value = '';
  document.getElementById('fuFilesInput').value = '';
  document.getElementById('fuTree').innerHTML = `
    <div class="fu-empty-state" style="padding:30px 20px;">
      <div class="fu-empty-ico">ðŸ“‚</div>
      <div class="fu-empty-t" style="font-size:13px;">No folder selected</div>
      <div class="fu-empty-s" style="font-size:11px;">Drop a folder or click above</div>
    </div>`;
  document.getElementById('fuTreeCount').textContent = '0';
  document.getElementById('fuEmptyState').style.display = '';
  document.getElementById('fuAssignPanel').style.display = 'none';
  document.getElementById('fuProgressPanel').style.display = 'none';
  document.getElementById('fuDonePanel').style.display = 'none';
  document.getElementById('fuSummaryBar').style.display = 'none';
  document.getElementById('fuUploadBtn').disabled = true;
  document.getElementById('fuDzIco').textContent = 'ðŸ“‚';
  document.getElementById('fuDzTitle').textContent = 'Drop a folder here';
  document.getElementById('fuDzSub').innerHTML = 'Drag &amp; drop a folder from your computer,<br>Google Drive, USB drive, or any storage';
  document.getElementById('fuDropzone').classList.remove('has-files', 'drag-over');
  document.getElementById('fuTopStats').textContent = '';
}

// ---- Drag & Drop ----
function fuDragOver(e) {
  e.preventDefault(); e.stopPropagation();
  document.getElementById('fuDropzone').classList.add('drag-over');
}
function fuDragLeave(e) {
  e.preventDefault();
  document.getElementById('fuDropzone').classList.remove('drag-over');
}
async function fuDrop(e) {
  e.preventDefault(); e.stopPropagation();
  document.getElementById('fuDropzone').classList.remove('drag-over');
  const items = e.dataTransfer.items;
  if (!items || items.length === 0) return;

  const allFiles = [];
  const promises = [];
  for (let i = 0; i < items.length; i++) {
    const item = items[i];
    if (item.kind !== 'file') continue;
    if (item.webkitGetAsEntry) {
      const entry = item.webkitGetAsEntry();
      if (entry) promises.push(fuReadEntry(entry, '', allFiles));
    } else {
      const file = item.getAsFile();
      if (file) allFiles.push({ file, path: file.name, folder: '' });
    }
  }
  await Promise.all(promises);
  fuProcessFiles(allFiles);
}

function fuReadEntry(entry, basePath, results) {
  return new Promise(resolve => {
    if (entry.isFile) {
      entry.getFile(file => {
        results.push({ file, path: basePath ? basePath + '/' + file.name : file.name, folder: basePath });
        resolve();
      }, () => resolve());
    } else if (entry.isDirectory) {
      const reader = entry.createReader();
      const readAll = () => {
        reader.readEntries(async entries => {
          if (!entries.length) { resolve(); return; }
          const subPath = basePath ? basePath + '/' + entry.name : entry.name;
          await Promise.all(entries.map(e => fuReadEntry(e, subPath, results)));
          readAll();
        }, () => resolve());
      };
      readAll();
    } else resolve();
  });
}

// ---- Input: folder picker ----
function fuFolderChosen(inp) {
  const files = Array.from(inp.files);
  const allFiles = files.map(f => {
    const path = f.webkitRelativePath || f.name;
    const parts = path.split('/');
    const folder = parts.length > 1 ? parts.slice(0, -1).join('/') : '';
    return { file: f, path, folder };
  });
  fuProcessFiles(allFiles);
}

// ---- Input: multi-file picker (no folder) ----
function fuFilesChosen(inp) {
  const files = Array.from(inp.files);
  const allFiles = files.map(f => ({ file: f, path: f.name, folder: '' }));
  fuProcessFiles(allFiles);
}

// ---- Core processing ----
function fuProcessFiles(rawList) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const today = new Date();
  const dateStr = months[today.getMonth()] + ' ' + today.getDate();

  // Filter to supported types only
  const valid = rawList.filter(({ file }) => {
    const ext = file.name.split('.').pop().toLowerCase();
    const mime = file.type;
    return EXT_MAP[ext] || SUPPORTED_TYPES[mime];
  });

  if (!valid.length) {
    toast('No supported files found in this folder.');
    return;
  }

  fuFiles = valid.map((item, i) => {
    const ext = item.file.name.split('.').pop().toLowerCase();
    const type = EXT_MAP[ext] || SUPPORTED_TYPES[item.file.type] || 'doc';
    return {
      id: 'fu_' + Date.now() + '_' + i,
      file: item.file,
      name: item.file.name,
      path: item.path,
      folder: item.folder || 'Root',
      size: item.file.size,
      type,
      checked: true,
      courseId: '',
      date: dateStr,
      progress: 0,
      status: 'pending',
    };
  });

  fuRenderTree();
  fuRenderFileRows();
  fuUpdateSummary();

  document.getElementById('fuEmptyState').style.display = 'none';
  document.getElementById('fuAssignPanel').style.display = '';
  document.getElementById('fuProgressPanel').style.display = 'none';
  document.getElementById('fuDonePanel').style.display = 'none';
  document.getElementById('fuSummaryBar').style.display = '';
  document.getElementById('fuUploadBtn').disabled = false;

  const dz = document.getElementById('fuDropzone');
  dz.classList.add('has-files');
  document.getElementById('fuDzIco').textContent = 'âœ…';
  document.getElementById('fuDzTitle').textContent = `${fuFiles.length} file${fuFiles.length !== 1 ? 's' : ''} loaded`;
  document.getElementById('fuDzSub').innerHTML = `<strong style="color:var(--accent3)">${fuFiles.length} supported files</strong> from ${[...new Set(fuFiles.map(f => f.folder))].length} folder(s).<br>Click to replace.`;

  toast(`${fuFiles.length} file${fuFiles.length !== 1 ? 's' : ''} loaded âœ“`);
}

// ---- Tree renderer ----
function fuRenderTree() {
  const tree = document.getElementById('fuTree');
  document.getElementById('fuTreeCount').textContent = fuFiles.length;

  // Group by folder
  const groups = {};
  fuFiles.forEach(f => {
    if (!groups[f.folder]) groups[f.folder] = [];
    groups[f.folder].push(f);
  });

  const typeIco = { pdf: 'ðŸ“„', doc: 'ðŸ“', ppt: 'ðŸ“Š', img: 'ðŸ–¼ï¸' };

  tree.innerHTML = Object.entries(groups).map(([folder, files]) => `
    <div class="fu-folder-group">
      <div class="fu-folder-label">
        <span class="fu-fold-ico">ðŸ“</span>
        <span class="fu-fold-name">${folder}</span>
        <span class="fu-fold-count">${files.length}</span>
      </div>
      ${files.map(f => `
        <div class="fu-file-item ${f.checked ? 'selected' : ''}" onclick="fuToggleFile('${f.id}')">
          <input class="fu-file-cb" type="checkbox" ${f.checked ? 'checked' : ''} onclick="event.stopPropagation();fuToggleFile('${f.id}')">
          <span class="fu-file-ico">${typeIco[f.type] || 'ðŸ“Ž'}</span>
          <span class="fu-file-name">${f.name}</span>
          <span class="fu-file-size">${formatFuBytes(f.size)}</span>
        </div>`).join('')}
    </div>`).join('');
}

// ---- File rows table ----
function fuRenderFileRows() {
  const tbody = document.getElementById('fuFileRows');
  const typeClr = { pdf: 'var(--accent4)', doc: 'var(--accent)', ppt: '#fbbf24', img: 'var(--accent3)' };
  const typeBg  = { pdf: 'rgba(224,123,123,.12)', doc: 'rgba(62,142,149,.12)', ppt: 'rgba(251,191,36,.12)', img: 'rgba(90,173,160,.12)' };

  const courseOptions = (selId, fileId) => {
    const defaultClass = document.getElementById('fuDefaultClass').value;
    const courses = defaultClass ? db.courses.filter(c => c.classId === defaultClass) : db.courses;
    return `<select class="fu-row-sel" id="${selId}" onchange="fuFileCoursePick('${fileId}',this.value)">
      <option value="">â€” Default â€”</option>
      ${courses.map(c => `<option value="${c.id}">${c.code}</option>`).join('')}
    </select>`;
  };

  tbody.innerHTML = fuFiles.map((f, i) => `
    <div class="fu-files-row ${!f.checked ? 'excluded-row' : ''}" id="fuRow_${f.id}">
      <div class="fu-file-cell" style="padding:0 6px;">
        <input class="fu-file-cb" type="checkbox" ${f.checked ? 'checked' : ''} onchange="fuToggleFile('${f.id}')">
      </div>
      <div class="fu-file-cell" style="font-weight:500;" title="${f.name}">${f.name}</div>
      <div class="fu-file-cell" style="color:var(--text3);" title="${f.folder}">${f.folder || 'Root'}</div>
      <div class="fu-file-cell">
        <span class="fu-type-tag" style="background:${typeBg[f.type]};color:${typeClr[f.type]}">${f.type.toUpperCase()}</span>
      </div>
      <div class="fu-file-cell" style="color:var(--text3);">${formatFuBytes(f.size)}</div>
    </div>`).join('');

  document.getElementById('fuSelectedCount').textContent = fuFiles.filter(f => f.checked).length;
}

function fuToggleFile(id) {
  const f = fuFiles.find(x => x.id === id);
  if (!f) return;
  f.checked = !f.checked;
  fuRenderTree();
  fuRenderFileRows();
  fuUpdateSummary();
}

function fuSelectAll(checked) {
  fuFiles.forEach(f => f.checked = checked);
  fuRenderTree();
  fuRenderFileRows();
  fuUpdateSummary();
}

function fuClassChanged() {
  const classId = document.getElementById('fuDefaultClass').value;
  const courses = classId ? db.courses.filter(c => c.classId === classId) : db.courses;
  document.getElementById('fuDefaultCourse').innerHTML =
    '<option value="">â€” Select course â€”</option>' +
    courses.map(c => `<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
}

function fuFileCoursePick(fileId, courseId) {
  const f = fuFiles.find(x => x.id === fileId);
  if (f) f.courseId = courseId;
}

function fuUpdateSummary() {
  const selected = fuFiles.filter(f => f.checked);
  const totalSize = fuFiles.reduce((a, f) => a + f.size, 0);
  const folders = new Set(fuFiles.map(f => f.folder)).size;
  document.getElementById('fuSumFiles').textContent = fuFiles.length;
  document.getElementById('fuSumSelected').textContent = selected.length;
  document.getElementById('fuSumSize').textContent = formatFuBytes(totalSize);
  document.getElementById('fuSumFolders').textContent = folders;
  document.getElementById('fuUploadBtn').disabled = selected.length === 0;
  document.getElementById('fuTopStats').textContent =
    `${selected.length} of ${fuFiles.length} files selected Â· ${formatFuBytes(totalSize)}`;
}

function formatFuBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

// ---- Upload ----
async function fuStartUpload() {
  const selected = fuFiles.filter(f => f.checked);
  if (!selected.length) { toast('No files selected'); return; }

  const defaultCourseId = document.getElementById('fuDefaultCourse').value;
  const defaultClassId  = document.getElementById('fuDefaultClass').value;

  // Validate: every selected file must have a course (either its own override or the default)
  const unassigned = selected.filter(f => !f.courseId && !defaultCourseId);
  if (unassigned.length) {
    toast(`Please select a default course for all files (${unassigned.length} unassigned)`);
    document.getElementById('fuDefaultCourse').style.borderColor = 'var(--accent4)';
    setTimeout(() => document.getElementById('fuDefaultCourse').style.borderColor = '', 2000);
    return;
  }

  // Switch UI to progress view
  document.getElementById('fuAssignPanel').style.display = 'none';
  document.getElementById('fuEmptyState').style.display = 'none';
  document.getElementById('fuProgressPanel').style.display = '';
  document.getElementById('fuUploadBtn').disabled = true;
  document.getElementById('fuUploadBtn').textContent = 'Uploadingâ€¦';

  // Build progress items
  const wrap = document.getElementById('fuProgressWrap');
  wrap.innerHTML = selected.map(f => `
    <div class="fu-prog-item" id="fuProg_${f.id}">
      <div class="fu-prog-row">
        <span class="fu-prog-name">${f.name}</span>
        <span class="fu-prog-stat" id="fuProgStat_${f.id}">Waitingâ€¦</span>
      </div>
      <div class="fu-prog-bar"><div class="fu-prog-fill" id="fuProgFill_${f.id}" style="width:0%"></div></div>
    </div>`).join('');

  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const today = new Date();
  const dateStr = months[today.getMonth()] + ' ' + today.getDate();

  let successCount = 0, errorCount = 0;

  for (const f of selected) {
    const courseId = f.courseId || defaultCourseId;
    const stat = document.getElementById('fuProgStat_' + f.id);
    const fill = document.getElementById('fuProgFill_' + f.id);

    stat.textContent = 'Readingâ€¦';
    fill.style.width = '20%';

    try {
      // Read file as dataURL
      const dataUrl = await new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = e => res(e.target.result);
        reader.onerror = () => rej(new Error('Read failed'));
        reader.readAsDataURL(f.file);
      });

      fill.style.width = '60%';
      stat.textContent = 'Savingâ€¦';

      // Create handout record
      const hid = 'h_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6);
      const handout = {
        id: hid, courseId,
        title: f.name.replace(/\.[^.]+$/, ''), // strip extension
        type: f.type, date: dateStr,
        lecturer: currentUser.name,
        fromFolder: true,
        folderPath: f.folder,
      };

      // Save file data persistently
      saveFileData(hid, { name: f.name, dataUrl, mime: f.file.type });

      // Save handout to DB
      db.handouts.push(handout);
      saveDB();

      fill.style.width = '100%';
      fill.classList.add('done');
      stat.textContent = 'âœ“ Done';
      stat.style.color = 'var(--accent3)';
      successCount++;

    } catch (err) {
      fill.style.width = '100%';
      fill.classList.add('error');
      stat.textContent = 'âœ— Error';
      stat.style.color = 'var(--accent4)';
      errorCount++;
    }

    // Small delay between files for UX smoothness
    await new Promise(r => setTimeout(r, 120));
  }

  // Show done panel
  document.getElementById('fuProgressPanel').style.display = 'none';
  document.getElementById('fuDonePanel').style.display = '';
  document.getElementById('fuDoneTitle').textContent =
    errorCount === 0 ? 'Upload Complete! ðŸŽ‰' : `Upload Finished with ${errorCount} error${errorCount > 1 ? 's' : ''}`;
  document.getElementById('fuDoneSub').textContent =
    `${successCount} file${successCount !== 1 ? 's' : ''} uploaded successfully` +
    (errorCount ? ` Â· ${errorCount} failed` : '') +
    ` Â· They are now available in handouts.`;

  document.getElementById('fuTopStats').textContent = `âœ“ ${successCount} uploaded`;

  toast(`${successCount} file${successCount !== 1 ? 's' : ''} uploaded successfully âœ“`);
}

// ============================================================
// PAST QUESTIONS â€” DB helpers
// ============================================================
function getPQBanks(){ if(!db.pastQuestions) db.pastQuestions=[]; return db.pastQuestions; }
function getPQAttempts(){ try{ return JSON.parse(localStorage.getItem('nv_pq_attempts')||'{}'); }catch(e){ return {}; } }
function savePQAttempts(obj){ try{ localStorage.setItem('nv_pq_attempts', JSON.stringify(obj)); }catch(e){} }
function getBestScore(bankId){ const a=getPQAttempts()[bankId]; return a||null; }
function recordAttempt(bankId, correct, total, pct){
  const all=getPQAttempts();
  const prev=all[bankId];
  if(!prev||pct>prev.pct){ all[bankId]={correct,total,pct,date:new Date().toLocaleDateString()}; savePQAttempts(all); }
}

// ============================================================
// PAST QUESTIONS â€” RENDER BANKS
// ============================================================
function renderPQBanks(){
  if(!db.pastQuestions) db.pastQuestions=[];
  const banks=db.pastQuestions;
  const grid=document.getElementById('pqBankGrid');
  const empty=document.getElementById('pqEmpty');
  const courseFilter=document.getElementById('pqFilterCourse').value;
  const yearFilter=document.getElementById('pqFilterYear').value;

  const coursesSel=document.getElementById('pqFilterCourse');
  const yearsSel=document.getElementById('pqFilterYear');
  const allYears=[...new Set(banks.map(b=>b.year).filter(Boolean))].sort().reverse();
  const curYear=yearsSel.value;
  yearsSel.innerHTML='<option value="">All Years</option>'+allYears.map(y=>`<option value="${y}"${y===curYear?' selected':''}>${y}</option>`).join('');
  const allCourseIds=[...new Set(banks.map(b=>b.courseId).filter(Boolean))];
  const curCourse=coursesSel.value;
  coursesSel.innerHTML='<option value="">All Courses</option>'+allCourseIds.map(cid=>{
    const co=db.courses.find(c=>c.id===cid);
    return co?`<option value="${cid}"${cid===curCourse?' selected':''}>${co.code} â€” ${co.title}</option>`:'';
  }).join('');

  let filtered=banks;
  if(courseFilter) filtered=filtered.filter(b=>b.courseId===courseFilter);
  if(yearFilter) filtered=filtered.filter(b=>b.year===yearFilter);

  document.getElementById('pqBankCount').textContent=`${filtered.length} bank${filtered.length!==1?'s':''}`;

  if(!filtered.length){ 
    grid.innerHTML=''; 
    empty.style.display=''; 
    // Show student message if not admin
    const studentMsg=document.getElementById('pqEmptyStudentMsg');
    if(studentMsg) studentMsg.style.display=(currentRole==='admin')?'none':'';
    return; 
  }
  empty.style.display='none';

  const typeLabel={exam:'Final Exam',test:'Test / Quiz',mock:'Mock Exam'};
  const typeColor={exam:'rgba(224,123,123,.15)',test:'rgba(62,142,149,.15)',mock:'rgba(251,191,36,.15)'};
  const typeTxt={exam:'var(--accent4)',test:'var(--accent)',mock:'#fbbf24'};

  grid.innerHTML=filtered.map((bank,i)=>{
    const co=db.courses.find(c=>c.id===bank.courseId);
    const best=getBestScore(bank.id);
    const examBest=getBestScore(bank.id+'_exam');
    const studyBest=getBestScore(bank.id+'_study');
    let scoreHtml='';
    if(examBest||studyBest){
      scoreHtml=`<div style="display:flex;gap:8px;flex-wrap:wrap;">`;
      if(examBest) scoreHtml+=`<span class="pq-best-score" style="color:${examBest.pct>=60?'#e07b7b':'var(--text3)'}">ðŸŽ¯ Exam: ${examBest.pct}%</span>`;
      if(studyBest) scoreHtml+=`<span class="pq-best-score" style="color:${studyBest.pct>=60?'var(--accent3)':'var(--text3)'}">ðŸ“– Study: ${studyBest.pct}%</span>`;
      scoreHtml+=`</div>`;
    } else {
      scoreHtml=`<span class="pq-best-score" style="color:var(--text3)">Not attempted</span>`;
    }
    return `<div class="pq-bank-card" style="animation-delay:${i*.06}s">
      <div class="pq-bank-header">
        <div class="pq-bank-title">${escHtml(bank.title)}</div>
        <div class="pq-bank-badge" style="background:${typeColor[bank.type]||'rgba(90,173,160,.15)'};color:${typeTxt[bank.type]||'var(--accent2)'}">
          ${typeLabel[bank.type]||bank.type}
        </div>
      </div>
      <div class="pq-bank-meta">${co?co.code+' â€” '+co.title:'Unknown Course'}${bank.year?' Â· '+bank.year:''}</div>
      <div class="pq-bank-stats">
        <div class="pq-bank-stat"><strong>${bank.questions.length}</strong> Questions</div>
        <div class="pq-bank-stat"><strong>${bank.year||'â€”'}</strong> Year</div>
        <div class="pq-bank-stat"><strong>${bank.questions.filter(q=>q.answer!==null&&q.answer!==undefined).length}</strong> w/ Answers</div>
      </div>
      <div class="pq-bank-footer">
        ${scoreHtml}
        <div style="display:flex;gap:6px;align-items:center;margin-left:auto;">
          ${currentRole==='admin'?`<button class="pq-del-btn" onclick="deletePQBank('${bank.id}',event)" title="Delete bank">ðŸ—‘</button>`:''}
          ${currentRole==='admin'?`<button class="pq-del-btn" onclick="openPQAnswerImport('${bank.id}',event)" title="Import Answers" style="width:auto;padding:0 10px;font-size:10px;font-family:'DM Mono',monospace;color:var(--accent2);border-color:rgba(90,173,160,.3);">ðŸ— Answers</button>`:''}
          <button class="pq-mode-btn study" onclick="startQuiz('${bank.id}','study')" title="Study Mode â€” instant feedback">ðŸ“– Study</button>
          <button class="pq-mode-btn exam" onclick="startQuiz('${bank.id}','exam')" title="Exam Mode â€” submit to see results">ðŸŽ¯ Exam</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function deletePQBank(id,e){
  e.stopPropagation();
  if(!confirm('Delete this question bank? This cannot be undone.')) return;
  db.pastQuestions=db.pastQuestions.filter(b=>b.id!==id);
  saveDB();
  renderPQBanks();
  toast('Question bank deleted.');
}

// ============================================================
// PAST QUESTIONS â€” ANSWER IMPORT (admin only)
// ============================================================
let _ansImportBankId=null;

function openPQAnswerImport(bankId,e){
  if(e) e.stopPropagation();
  _ansImportBankId=bankId;
  const bank=db.pastQuestions.find(b=>b.id===bankId);
  if(!bank){toast('Bank not found.');return;}
  document.getElementById('pqAnsImportTitle').textContent=`Import Answers: ${bank.title}`;
  document.getElementById('pqAnsImportCount').textContent=`${bank.questions.length} questions`;
  document.getElementById('pqAnsImportBox').value='';
  document.getElementById('pqAnsImportPreview').style.display='none';
  document.getElementById('pqAnsImportPreviewBody').innerHTML='';
  document.getElementById('pqAnsImportModal').classList.add('open');
}

function pqAnsPreview(){
  const raw=document.getElementById('pqAnsImportBox').value.trim();
  const bank=db.pastQuestions.find(b=>b.id===_ansImportBankId);
  if(!bank||!raw){document.getElementById('pqAnsImportPreview').style.display='none';return;}

  // Parse answers: accept formats like:
  // "1. C" | "1) C" | "1 C" | "C" (one per line) | "A B C D â€¦" (space separated) | "A,B,C,D" (comma)
  const lines=raw.split('\n').map(l=>l.trim()).filter(Boolean);
  let answers=[];

  // Detect if it's one-per-line with numbers, or just letters, or space/comma separated
  if(lines.length===1){
    // Single line â€” try comma or space separated letters
    const parts=lines[0].split(/[,\s]+/).map(s=>s.trim()).filter(Boolean);
    answers=parts.map(p=>{
      const m=p.match(/^[A-Ea-e]$/);
      return m?p.toUpperCase():null;
    });
  } else {
    answers=lines.map(line=>{
      // "1. C" or "1) C" or "Q1: C" or just "C"
      const m=line.match(/^(?:(?:Q?\d+[\.\)\:]\s*))?([A-Ea-e])[\.\)]?\s*$/i)||
               line.match(/^(?:Q?\d+[\.\)\:]?\s+)?([A-Ea-e])\b/i);
      return m?m[1].toUpperCase():null;
    });
  }

  const body=document.getElementById('pqAnsImportPreviewBody');
  const rows=bank.questions.slice(0,answers.length);
  let matched=0,total=rows.length;
  body.innerHTML=rows.map((q,i)=>{
    const ans=answers[i];
    const ansIdx=ans?ans.charCodeAt(0)-65:null;
    const prev=q.answer!==null&&q.answer!==undefined?String.fromCharCode(65+q.answer):null;
    const valid=ansIdx!==null&&ansIdx>=0&&ansIdx<q.options.length;
    if(valid) matched++;
    const opts=['A','B','C','D','E'];
    return `<div class="pq-preview-q" style="${valid?'':'opacity:.45'}">
      <div class="pq-preview-qn" style="display:flex;align-items:center;justify-content:space-between;gap:6px;">
        <span>${i+1}. ${escHtml(q.question.slice(0,80))}${q.question.length>80?'â€¦':''}</span>
        <span style="flex-shrink:0;font-family:'DM Mono',monospace;font-size:11px;">
          ${prev?`<span style="color:var(--text3);">was ${prev} â†’</span> `:''}
          ${valid?`<span style="color:var(--accent3);font-weight:700;">${ans}</span>`:`<span style="color:var(--accent4);">?</span>`}
        </span>
      </div>
    </div>`;
  }).join('');

  // Store parsed answers for apply
  document.getElementById('pqAnsImportPreview').style.display='';
  document.getElementById('pqAnsMatchCount').textContent=`${matched} of ${total} answers matched`;
  document.getElementById('pqAnsApplyBtn').disabled=matched===0;
  // Store parsed answers in a data attribute for apply step
  document.getElementById('pqAnsImportBox').dataset.parsed=JSON.stringify(answers);
}

function applyPQAnswers(){
  const bank=db.pastQuestions.find(b=>b.id===_ansImportBankId);
  if(!bank){toast('Bank not found.');return;}
  const raw=document.getElementById('pqAnsImportBox').dataset.parsed;
  if(!raw){toast('No answers to apply.');return;}
  const answers=JSON.parse(raw);
  let applied=0;
  answers.forEach((ans,i)=>{
    if(i>=bank.questions.length) return;
    if(ans===null) return;
    const ansIdx=ans.charCodeAt(0)-65;
    if(ansIdx>=0&&ansIdx<bank.questions[i].options.length){
      bank.questions[i].answer=ansIdx;
      applied++;
    }
  });
  saveDB();
  document.getElementById('pqAnsImportModal').classList.remove('open');
  renderPQBanks();
  toast(`âœ“ ${applied} answer${applied!==1?'s':''} imported into "${bank.title}"`);}



function escHtml(s){ const d=document.createElement('div');d.textContent=s||'';return d.innerHTML; }

// ============================================================
// PAST QUESTIONS â€” IMPORT
// ============================================================
function openPQImport(){
  const sel=document.getElementById('pqBankCourse');
  sel.innerHTML=db.courses.map(c=>`<option value="${c.id}">${c.code} â€” ${c.title}</option>`).join('');
  document.getElementById('pqPasteBox').value='';
  document.getElementById('pqPreviewSection').style.display='none';
  document.getElementById('pqAIAnswerSection').style.display='none';
  document.getElementById('pqBankTitle').value='';
  document.getElementById('pqBankYear').value=new Date().getFullYear();
  document.getElementById('pqAIStatus').className='pq-ai-status';
  document.getElementById('pqAIAnswerStatus').className='pq-ai-status';
  document.getElementById('pqDocStatus').style.display='none';
  document.getElementById('pqDocIco').textContent='ðŸ“';
  document.getElementById('pqDocTxt').innerHTML='<strong>Click to browse</strong> or drag &amp; drop';
  switchPQTab('paste');
  _parsedQuestions=[];
  openModal('pqImportModal');
}

let _parsedQuestions=[];

function parsePQText(raw){
  if(!raw||!raw.trim()) return [];
  const questions=[];

  // â”€â”€ Strategy 1: Split by numbered question starters (most common format)
  // Matches: "1.", "1)", "Q1.", "Q1)", "Question 1.", etc. at start of line
  const qStartRx=/^(?:Q(?:uestion)?\s*)?(\d+)[\.\)]\s+/im;
  if(qStartRx.test(raw)){
    // Split on lines that start a new question number
    const parts=raw.split(/(?=^(?:Q(?:uestion)?\s*)?\d+[\.\)]\s)/im).map(s=>s.trim()).filter(Boolean);
    for(const part of parts){
      const q=_parseSingleBlock(part);
      if(q) questions.push(q);
    }
    if(questions.length) return questions;
  }

  // â”€â”€ Strategy 2: Split by blank lines
  const blocks=raw.split(/\n{2,}/).map(b=>b.trim()).filter(Boolean);
  for(const block of blocks){
    const q=_parseSingleBlock(block);
    if(q) questions.push(q);
  }
  if(questions.length) return questions;

  // â”€â”€ Strategy 3: Try the whole text as a continuous stream line by line
  const streamQ=_parseStream(raw);
  return streamQ;
}

function _parseSingleBlock(block){
  const lines=block.split('\n').map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return null;

  let questionLines=[];
  let options=[];
  let answer=null;
  let explanation='';
  let i=0;

  // First line: strip leading question number/label
  const firstLine=lines[0]
    .replace(/^(?:Q(?:uestion)?\s*)?\d+[\.\)]\s*/i,'')
    .replace(/^Q\s*:\s*/i,'')
    .trim();
  if(firstLine) questionLines.push(firstLine);
  i=1;

  while(i<lines.length){
    const line=lines[i];

    // Answer key line: "Answer: C", "Ans: B", "Correct Answer: A", "Key: D", "ANS: C"
    const ansMatch=line.match(/^(?:answer|ans(?:wer)?|correct\s*answer|key|ans\.?)[\s:\-]+([A-Ea-e])\b/i);
    if(ansMatch){
      answer=ansMatch[1].toUpperCase().charCodeAt(0)-65;
      i++; continue;
    }

    // Explanation line
    const expMatch=line.match(/^(?:explanation|explanations?|note|reason|rationale|solution)[\s:\-]+(.+)/i);
    if(expMatch){ explanation=expMatch[1]; i++; continue; }

    // Option pattern: A. / A) / (A) / *A. / *A) / a. / a) â€” with optional asterisk for correct
    const optMatch=line.match(/^(\*?)\(?([A-Ea-e])\)?[\.\)]\s*(.+)/);
    if(optMatch){
      const isCorrect=optMatch[1]==='*';
      options.push(optMatch[3]);
      if(isCorrect) answer=options.length-1;
      i++; continue;
    }

    // Option numbered variant: "1." "2." as options (rare)
    // If options already started, append to last option
    if(options.length>0 && !line.match(/^(?:Q(?:uestion)?\s*)?\d+[\.\)]\s/i)){
      options[options.length-1]+=' '+line; i++; continue;
    }

    // Otherwise it's a continuation of the question text
    if(!options.length) questionLines.push(line);
    i++;
  }

  const question=questionLines.join(' ').trim();
  if(!question) return null;
  // Accept even questions with 1 option (some formats list only choices)
  if(options.length<2) return null;

  return {
    id:'q_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
    question, options, answer, explanation
  };
}

function _parseStream(raw){
  // Line-by-line state machine for when there's no blank line separation
  const lines=raw.split('\n').map(l=>l.trim()).filter(Boolean);
  const questions=[];
  let cur=null;

  const flush=()=>{
    if(cur && cur.question && cur.options.length>=2){
      questions.push({
        id:'q_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
        question:cur.question, options:cur.options, answer:cur.answer, explanation:cur.explanation||''
      });
    }
    cur=null;
  };

  for(const line of lines){
    // New question starts
    const qMatch=line.match(/^(?:Q(?:uestion)?\s*)?(\d+)[\.\)]\s+(.+)/i);
    if(qMatch){ flush(); cur={question:qMatch[2].trim(),options:[],answer:null,explanation:''}; continue; }

    if(!cur) continue;

    const ansMatch=line.match(/^(?:answer|ans(?:wer)?|correct\s*answer|key)[\s:\-]+([A-Ea-e])\b/i);
    if(ansMatch){ cur.answer=ansMatch[1].toUpperCase().charCodeAt(0)-65; continue; }

    const expMatch=line.match(/^(?:explanation|note|reason|rationale)[\s:\-]+(.+)/i);
    if(expMatch){ cur.explanation=expMatch[1]; continue; }

    const optMatch=line.match(/^(\*?)\(?([A-Ea-e])\)?[\.\)]\s*(.+)/);
    if(optMatch){
      const isCorrect=optMatch[1]==='*';
      cur.options.push(optMatch[3]);
      if(isCorrect) cur.answer=cur.options.length-1;
      continue;
    }

    // Continuation of question if no options yet
    if(!cur.options.length) cur.question+=' '+line;
    else cur.options[cur.options.length-1]+=' '+line;
  }
  flush();
  return questions;
}

function savePQBank(){
  const title=(document.getElementById('pqBankTitle').value||'').trim();
  const year=(document.getElementById('pqBankYear').value||'').trim();
  const courseId=document.getElementById('pqBankCourse').value;
  const type=document.getElementById('pqBankType').value;

  if(!title){ toast('Please enter a bank title.'); document.getElementById('pqBankTitle').focus(); return; }
  if(!_parsedQuestions.length){ toast('No questions found. Check your format.'); return; }

  const bank={
    id:'pqb_'+Date.now(),
    title, year, courseId, type,
    questions:_parsedQuestions,
    createdBy:currentUser.name||currentUser.username||'Unknown',
    createdAt:new Date().toLocaleDateString()
  };
  if(!db.pastQuestions) db.pastQuestions=[];
  db.pastQuestions.unshift(bank);
  saveDB();
  closeModal('pqImportModal');
  renderPQBanks();
  toast(`${_parsedQuestions.length} questions imported into "${title}" âœ“`);
  _parsedQuestions=[];
}

// ============================================================
// QUIZ ENGINE â€” DUAL MODE
// ============================================================
let qz={bank:null,mode:'exam',questions:[],current:0,answers:{},reviewed:false,startTime:null,timerInterval:null};

function startQuiz(bankId,mode){
  const bank=db.pastQuestions.find(b=>b.id===bankId);
  if(!bank){ toast('Bank not found.'); return; }
  qz.bank=bank; qz.mode=mode;
  qz.questions=[...bank.questions];
  qz.current=0; qz.answers={}; qz.reviewed=false;
  qz.startTime=Date.now();

  // Set mode pill + progress fill class
  const modePill=document.getElementById('quizModePill');
  modePill.textContent=mode==='exam'?'ðŸŽ¯ EXAM MODE':'ðŸ“– STUDY MODE';
  modePill.className='quiz-mode-pill '+(mode==='exam'?'exam':'study');
  document.getElementById('quizProgFill').className='quiz-progress-fill '+(mode==='exam'?'exam':'study');

  document.getElementById('quizTitle').textContent=bank.title;
  const co=db.courses.find(c=>c.id===bank.courseId);
  document.getElementById('quizSubtitle').textContent=(co?co.code+' Â· ':'')+(bank.year||'');

  // Footer end-exam btn only in exam mode
  const endBtn=document.getElementById('quizEndExamBtn');
  if(endBtn) endBtn.style.display=mode==='exam'?'':'none';

  document.getElementById('quizOverlay').classList.add('open');
  startTimer();
  renderQuizQuestion();
}

function startTimer(){
  clearInterval(qz.timerInterval);
  qz.timerInterval=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-qz.startTime)/1000);
    const m=String(Math.floor(elapsed/60)).padStart(2,'0');
    const s=String(elapsed%60).padStart(2,'0');
    const el=document.getElementById('quizTimer');
    el.textContent=`â± ${m}:${s}`;
  },1000);
}

function exitQuiz(){
  const hasWork=Object.keys(qz.answers).length>0;
  if(hasWork && !qz.reviewed){
    if(!confirm('Exit? Your progress will be lost.')) return;
  }
  clearInterval(qz.timerInterval);
  document.getElementById('quizOverlay').classList.remove('open');
  document.getElementById('quizResultOverlay').classList.remove('open');
  renderPQBanks();
}

function renderQuizQuestion(){
  const q=qz.questions[qz.current];
  const total=qz.questions.length;
  const idx=qz.current;
  const pct=Math.round(((idx+1)/total)*100);
  const mode=qz.mode;

  // Progress
  document.getElementById('quizProgLabel').textContent=`Q${idx+1} / ${total}`;
  document.getElementById('quizProgPct').textContent=pct+'%';
  document.getElementById('quizProgFill').style.width=pct+'%';

  // Buttons
  document.getElementById('quizPrevBtn').disabled=idx===0;
  const isLast=idx===total-1;
  document.getElementById('quizNextBtn').style.display=isLast?'none':'';
  const subBtn=document.getElementById('quizSubmitBtn');
  subBtn.style.display=isLast?'':'none';
  subBtn.className='quiz-submit-btn '+(mode==='exam'?'exam-sub':'study-sub');
  subBtn.textContent=mode==='exam'?'Submit Exam âœ“':'Finish âœ“';

  // Dot nav
  const dots=document.getElementById('quizDotNav');
  dots.innerHTML=qz.questions.map((_,i)=>{
    let cls='quiz-dot';
    if(i===idx) cls+=` current ${mode}`;
    else if(qz.reviewed){
      const a=qz.answers[i];
      if(a===undefined) cls='quiz-dot';
      else if(a===qz.questions[i].answer) cls+=' correct';
      else cls+=' wrong';
    } else if(qz.answers[i]!==undefined) cls+=` answered ${mode}`;
    return `<div class="${cls}" onclick="quizJump(${i})" title="Q${i+1}"></div>`;
  }).join('');

  // Card content
  const userAns=qz.answers[idx];
  const isAnswered=userAns!==undefined;
  const isReview=qz.reviewed;
  const showAnswer=(mode==='study' && isAnswered) || isReview; // study: show immediately; exam: only after review

  const optKeys=['A','B','C','D','E'];

  let bannerHtml='';
  if(isReview){
    bannerHtml=`<div class="review-banner">ðŸ“– Review Mode â€” correct answers are now revealed</div>`;
  } else if(mode==='exam' && !isReview){
    bannerHtml=`<div class="quiz-exam-hint">ðŸ”’ Exam Mode â€” answers hidden until you submit. You can change your selection anytime.</div>`;
  }

  const optHtml=q.options.map((opt,oi)=>{
    let optCls=`quiz-opt ${mode}-opt`;
    const hasAnswerKey = q.answer!==null && q.answer!==undefined;

    if(showAnswer){
      // Both modes after reveal: green=correct, red=wrong
      optCls+=' disabled';
      if(hasAnswerKey && oi===q.answer) optCls+=' correct';
      else if(oi===userAns && userAns!==q.answer) optCls+=' wrong';
      else if(oi===userAns && !hasAnswerKey) optCls+=' selected '+mode+'-opt';
    } else if(mode==='exam'){
      // Exam mode before submit: just show selection, no green/red
      if(oi===userAns) optCls+=' selected exam-opt';
    } else if(mode==='study' && isAnswered){
      // Study mode after answering: lock + green/red immediately
      optCls+=' disabled';
      if(hasAnswerKey && oi===q.answer) optCls+=' correct';
      else if(oi===userAns && oi!==q.answer) optCls+=' wrong';
      else if(oi===userAns && !hasAnswerKey) optCls+=' selected study-opt';
    } else if(oi===userAns){
      optCls+=' selected';
    }
    // Exam mode: allow changing before submit; Study mode: lock after first pick
    const canClick = !isReview && (mode==='exam' || !isAnswered);
    const clickHandler = canClick ? `onclick="selectOption(${oi})"` : '';
    return `<div class="${optCls}" style="animation-delay:${oi*.07}s;opacity:0" ${clickHandler}>
      <div class="quiz-opt-key">${optKeys[oi]}</div>
      <div class="quiz-opt-text">${escHtml(opt)}</div>
    </div>`;
  }).join('');

  let feedbackHtml='';
  if(showAnswer && userAns!==undefined){
    const isCorrect=userAns===q.answer;
    if(isCorrect){
      feedbackHtml=`<div class="quiz-feedback correct-fb">âœ… <strong>Correct!</strong>${q.explanation?' â€” '+escHtml(q.explanation):''}</div>`;
    } else {
      const correctTxt=q.answer!==null&&q.answer!==undefined?` Correct answer: <strong>${optKeys[q.answer]}. ${escHtml(q.options[q.answer]||'')}</strong>`:'';
      feedbackHtml=`<div class="quiz-feedback wrong-fb">âŒ <strong>Wrong.</strong>${correctTxt}${q.explanation?'<br>ðŸ’¡ '+escHtml(q.explanation):''}</div>`;
    }
  } else if(showAnswer && userAns===undefined && q.answer!==null&&q.answer!==undefined){
    feedbackHtml=`<div class="quiz-feedback reveal-fb">â­ Skipped. Correct answer: <strong>${optKeys[q.answer]}. ${escHtml(q.options[q.answer]||'')}</strong></div>`;
  }

  // In study mode if answered, auto-generate answer via AI if answer is null
  document.getElementById('quizCard').innerHTML=`
    ${bannerHtml}
    <div class="quiz-qnum">
      <span class="quiz-qnum-badge ${mode}">Q${idx+1}</span>
      ${idx+1} of ${total}
    </div>
    <div class="quiz-question">${escHtml(q.question)}</div>
    <div class="quiz-options">${optHtml}</div>
    ${feedbackHtml}
  `;
  document.getElementById('quizBody').scrollTop=0;
}

function selectOption(oi){
  if(qz.reviewed) return;
  // Study mode: lock after first answer; Exam mode: allow changing
  if(qz.mode==='study' && qz.answers[qz.current]!==undefined) return;
  qz.answers[qz.current]=oi;
  renderQuizQuestion();
  // Study mode: auto-advance after 1.4s if not last
  if(qz.mode==='study' && qz.current<qz.questions.length-1){
    setTimeout(()=>{
      if(!qz.reviewed && qz.answers[qz.current]!==undefined && qz.current<qz.questions.length-1) quizNav(1);
    },1400);
  }
}

function quizNav(dir){
  qz.current=Math.max(0,Math.min(qz.questions.length-1,qz.current+dir));
  renderQuizQuestion();
}
function quizJump(i){ qz.current=i; renderQuizQuestion(); }

function quizSubmit(){
  const total=qz.questions.length;
  const answered=Object.keys(qz.answers).length;
  const unanswered=total-answered;
  if(unanswered>0){
    if(!confirm(`You have ${unanswered} unanswered question${unanswered>1?'s':''}. Submit anyway?`)) return;
  }
  clearInterval(qz.timerInterval);
  qz.reviewed=true; // Mark reviewed so green/red shows during result review
  showQuizResult();
}

function endExamEarly(){
  if(!confirm('End exam early and see your results?')) return;
  clearInterval(qz.timerInterval);
  qz.reviewed=true;
  showQuizResult();
}

function showQuizResult(){
  const total=qz.questions.length;
  let correct=0, wrong=0, skipped=0;
  qz.questions.forEach((q,i)=>{
    const a=qz.answers[i];
    if(a===undefined) skipped++;
    else if(q.answer===null||q.answer===undefined) skipped++; // no answer key
    else if(a===q.answer) correct++;
    else wrong++;
  });
  const graded=total-qz.questions.filter((_,i)=>{
    const q=qz.questions[i];
    return qz.answers[i]!==undefined && (q.answer===null||q.answer===undefined);
  }).length;
  const pct=graded>0?Math.round((correct/graded)*100):0;
  recordAttempt(qz.bank.id+'_'+qz.mode, correct, graded, pct);

  const mode=qz.mode;
  const icon=pct>=80?'ðŸ†':pct>=60?'ðŸŽ‰':pct>=40?'ðŸ’ª':'ðŸ“š';
  const title=pct>=80?'Excellent!':pct>=60?'Good Job!':pct>=40?'Keep Practising!':'Study More!';

  document.getElementById('qrIcon').textContent=icon;
  document.getElementById('qrTitle').textContent=title;
  document.getElementById('qrModeBadge').textContent=mode==='exam'?'ðŸŽ¯ Exam Mode':'ðŸ“– Study Mode';
  document.getElementById('qrModeBadge').className='quiz-result-mode-badge '+(mode==='exam'?'exam':'study');
  document.getElementById('qrSub').textContent=`${qz.bank.title} Â· ${new Date().toLocaleDateString()}`;
  document.getElementById('qrPct').textContent=pct+'%';
  document.getElementById('qrCorrect').textContent=correct;
  document.getElementById('qrWrong').textContent=wrong;
  document.getElementById('qrSkipped').textContent=skipped;

  const ring=document.getElementById('qrRing');
  const ringColor=pct>=80?'rgba(90,173,160,.2)':pct>=60?'rgba(62,142,149,.2)':pct>=40?'rgba(251,191,36,.2)':'rgba(224,123,123,.15)';
  const ringBorder=pct>=80?'3px solid var(--accent3)':pct>=60?'3px solid var(--accent)':pct>=40?'3px solid #fbbf24':'3px solid var(--accent4)';
  ring.style.background=ringColor; ring.style.border=ringBorder;
  document.getElementById('qrPct').style.color=pct>=80?'var(--accent3)':pct>=60?'var(--accent)':pct>=40?'#fbbf24':'var(--accent4)';

  // Review button - always available after result
  document.getElementById('qrReviewBtn').className='quiz-result-btn '+(mode==='exam'?'primary-exam':'primary-study');
  document.getElementById('qrRetryExamBtn').style.display=mode==='exam'?'':'none';
  document.getElementById('qrRetryStudyBtn').style.display=mode==='study'?'':'none';

  document.getElementById('quizResultOverlay').classList.add('open');
}

function reviewQuiz(){
  // reviewed is already true from submit; close result panel and show questions with green/red
  document.getElementById('quizResultOverlay').classList.remove('open');
  qz.current=0;
  renderQuizQuestion();
}

function retryQuiz(mode){
  document.getElementById('quizResultOverlay').classList.remove('open');
  const bankId=qz.bank.id;
  const m=mode||qz.mode;
  qz.answers={}; qz.current=0; qz.reviewed=false; qz.mode=m;
  qz.startTime=Date.now();
  // Update pill
  const modePill=document.getElementById('quizModePill');
  modePill.textContent=m==='exam'?'ðŸŽ¯ EXAM MODE':'ðŸ“– STUDY MODE';
  modePill.className='quiz-mode-pill '+(m==='exam'?'exam':'study');
  document.getElementById('quizProgFill').className='quiz-progress-fill '+(m==='exam'?'exam':'study');
  const endBtn=document.getElementById('quizEndExamBtn');
  if(endBtn) endBtn.style.display=m==='exam'?'':'none';
  startTimer();
  renderQuizQuestion();
}

function closeQuizResult(){
  clearInterval(qz.timerInterval);
  document.getElementById('quizResultOverlay').classList.remove('open');
  document.getElementById('quizOverlay').classList.remove('open');
  renderPQBanks();
}

// ============================================================
// IMPORT â€” TAB SWITCHING
// ============================================================
function switchPQTab(tab){
  document.getElementById('pqPasteTab').style.display=tab==='paste'?'':'none';
  document.getElementById('pqDocTab').style.display=tab==='doc'?'':'none';
  document.getElementById('pqAITab').style.display=tab==='ai'?'':'none';
  document.getElementById('pqTabPaste').classList.toggle('active',tab==='paste');
  document.getElementById('pqTabDoc').classList.toggle('active',tab==='doc');
  document.getElementById('pqTabAI').classList.toggle('active',tab==='ai');
  if(tab!=='ai'&&tab!=='paste'){
    document.getElementById('pqPreviewSection').style.display='none';
    document.getElementById('pqAIAnswerSection').style.display='none';
  }
}

// ============================================================
// IMPORT â€” DOCUMENT UPLOAD (txt/pdf text extraction)
// ============================================================
function handlePQDocUpload(input){
  const file=input.files[0];
  if(!file) return;
  const status=document.getElementById('pqDocStatus');
  const drop=document.getElementById('pqDocIco');
  const txt=document.getElementById('pqDocTxt');
  status.style.display='block';
  status.textContent='Reading fileâ€¦';

  const ext=file.name.split('.').pop().toLowerCase();

  if(ext==='txt'){
    const reader=new FileReader();
    reader.onload=e=>{
      const raw=e.target.result;
      processDocText(raw, file.name);
      status.textContent=`âœ“ Loaded: ${file.name}`;
      drop.textContent='âœ…'; txt.innerHTML=`<strong>${file.name}</strong> loaded`;
    };
    reader.readAsText(file);
  } else if(ext==='pdf'){
    // Use PDF.js from CDN if available, else read as text
    status.textContent='Extracting text from PDFâ€¦';
    const reader=new FileReader();
    reader.onload=async e=>{
      try{
        // Try PDF.js
        const pdfjsLibRef=window.pdfjsLib||window['pdfjs-dist/build/pdf'];
        if(pdfjsLibRef){
          const pdf=await pdfjsLibRef.getDocument({data:e.target.result}).promise;
          let fullText='';
          for(let i=1;i<=pdf.numPages;i++){
            const page=await pdf.getPage(i);
            const content=await page.getTextContent();
            fullText+=content.items.map(it=>it.str).join(' ')+'\n';
          }
          processDocText(fullText, file.name);
          status.textContent=`âœ“ Extracted ${pdf.numPages} pages from ${file.name}`;
          drop.textContent='âœ…'; txt.innerHTML=`<strong>${file.name}</strong> â€” ${pdf.numPages} pages`;
        } else {
          status.textContent='âš  PDF.js not loaded. Use TXT or paste text directly.';
        }
      }catch(err){
        status.textContent='âš  Could not extract PDF text. Try a text-based PDF or use paste.';
      }
    };
    reader.readAsArrayBuffer(file);
  } else if(ext==='docx'||ext==='doc'){
    status.textContent='Extracting text from documentâ€¦';
    const reader=new FileReader();
    reader.onload=async e=>{
      try{
        if(window.mammoth){
          const result=await mammoth.extractRawText({arrayBuffer:e.target.result});
          processDocText(result.value, file.name);
          status.textContent=`âœ“ Extracted text from ${file.name}`;
          drop.textContent='âœ…'; txt.innerHTML=`<strong>${file.name}</strong> loaded`;
        } else {
          // Fallback: treat as text
          const text=new TextDecoder().decode(e.target.result).replace(/[^\x20-\x7E\n]/g,' ');
          processDocText(text, file.name);
          status.textContent=`âœ“ Loaded ${file.name} (basic extraction)`;
          drop.textContent='âœ…'; txt.innerHTML=`<strong>${file.name}</strong> loaded`;
        }
      }catch(err){
        status.textContent='âš  Could not extract document. Try a .txt file.';
      }
    };
    reader.readAsArrayBuffer(file);
  } else {
    status.textContent='âš  Unsupported file type. Use TXT, PDF, or DOCX.';
  }
}

function processDocText(text, filename){
  // Auto-fill title from filename
  const titleEl=document.getElementById('pqBankTitle');
  if(!titleEl.value) titleEl.value=filename.replace(/\.[^.]+$/,'');
  // Put text into paste box and parse
  document.getElementById('pqPasteBox').value=text;
  switchPQTab('paste');
  pqParseAndPreview();
}

// ============================================================
// IMPORT â€” PASTE PREVIEW
// ============================================================
function pqParseAndPreview(){
  const raw=document.getElementById('pqPasteBox').value;
  _parsedQuestions=parsePQText(raw);
  const section=document.getElementById('pqPreviewSection');
  const list=document.getElementById('pqPreviewList');
  const count=document.getElementById('pqPreviewCount');
  const err=document.getElementById('pqPreviewErr');
  const aiAns=document.getElementById('pqAIAnswerSection');

  if(!_parsedQuestions.length){ section.style.display='none'; aiAns.style.display='none'; return; }
  section.style.display='';
  count.textContent=`${_parsedQuestions.length} question${_parsedQuestions.length!==1?'s':''} parsed`;
  const noAns=_parsedQuestions.filter(q=>q.answer===null||q.answer===undefined).length;
  err.textContent=noAns?`âš  ${noAns} missing answers`:'âœ“ All answers present';
  err.style.color=noAns?'var(--accent4)':'var(--accent3)';

  // Show AI answer button only if some questions lack answers
  aiAns.style.display=noAns>0?'':'none';
  const aiAnswerTxtEl=document.getElementById('pqAIAnswerTxt');
  if(aiAnswerTxtEl) aiAnswerTxtEl.textContent=`âœ¨ Auto-Generate Answers Online (${noAns} missing)`;

  list.innerHTML=_parsedQuestions.slice(0,6).map((q,i)=>{
    const opts=q.options.map((o,oi)=>`<span class="pq-preview-opt${oi===q.answer?' correct':''}">${String.fromCharCode(65+oi)}. ${escHtml(o)}</span>`).join('');
    const ansLabel=q.answer!==null&&q.answer!==undefined
      ?`<span style="color:var(--accent3);font-size:10px;margin-left:4px;">âœ“ Ans:${String.fromCharCode(65+(q.answer||0))}</span>`
      :`<span style="color:var(--accent4);font-size:10px;margin-left:4px;">âš  No answer</span>`;
    return `<div class="pq-preview-q">
      <div class="pq-preview-qn">${i+1}. ${escHtml(q.question)}${ansLabel}</div>
      <div class="pq-preview-opts">${opts}</div>
    </div>`;
  }).join('') + (_parsedQuestions.length>6?`<div style="padding:10px 14px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">â€¦ and ${_parsedQuestions.length-6} more questions</div>`:'');
}

// ============================================================
// AI â€” GENERATE QUESTIONS FOR A COURSE
// ============================================================
async function aiGenerateQuestions(){
  const courseId=document.getElementById('pqBankCourse').value;
  const course=db.courses.find(c=>c.id===courseId);
  const topic=(document.getElementById('pqAITopic').value||'').trim();
  const type=document.getElementById('pqBankType').value;
  const typeLabel={exam:'final exam',test:'class test',mock:'mock exam'};
  const btn=document.getElementById('pqAIGenBtn');
  const statusEl=document.getElementById('pqAIStatus');

  btn.disabled=true;
  document.getElementById('pqAIBtnTxt').innerHTML=`<span class="pq-ai-spin"></span> Generating with AIâ€¦`;
  statusEl.className='pq-ai-status show';
  statusEl.innerHTML='ðŸ” Searching for relevant questions and generatingâ€¦';

  const courseName=course?course.title:'Nursing';
  const courseCode=course?course.code:'';
  const numQ=topic.match(/(\d+)\s*question/i)?parseInt(topic.match(/(\d+)\s*question/i)[1]):15;

  const prompt=`You are an expert nursing educator. Generate exactly ${numQ} multiple-choice past questions for a ${typeLabel[type]||'exam'} in ${courseName} (${courseCode}).
${topic?'Additional instructions: '+topic:''}

Requirements:
- Each question must be realistic nursing/medical examination style
- Provide exactly 4 options (A, B, C, D)  
- Mark the correct answer clearly
- Include a brief explanation

Output in this EXACT format (no other text, no markdown, no preamble):

1. [Question text]
A. [Option]
B. [Option]
*C. [Correct Option]
D. [Option]
Explanation: [Brief explanation]

[blank line between questions]

Generate all ${numQ} questions now:`;

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-sonnet-4-5-20251001',
        max_tokens:4000,
        messages:[{role:'user',content:prompt}]
      })
    });
    const data=await resp.json();
    const text=data.content.filter(c=>c.type==='text').map(c=>c.text).join('\n');

    if(!text.trim()){
      statusEl.innerHTML='âš  No response from AI. Check your network.';
      btn.disabled=false;
      document.getElementById('pqAIBtnTxt').textContent='âœ¨ Generate Questions with AI';
      return;
    }

    // Parse and populate
    _parsedQuestions=parsePQText(text);
    if(!_parsedQuestions.length){
      statusEl.innerHTML='âš  Could not parse AI output. Try again or use paste mode.';
    } else {
      // Auto-fill title
      const yr=document.getElementById('pqBankYear').value||new Date().getFullYear();
      if(!document.getElementById('pqBankTitle').value){
        document.getElementById('pqBankTitle').value=`${courseName} ${typeLabel[type]||'Questions'} ${yr}`;
      }
      // Show preview
      document.getElementById('pqPreviewSection').style.display='';
      const noAns=_parsedQuestions.filter(q=>q.answer===null||q.answer===undefined).length;
      document.getElementById('pqPreviewCount').textContent=`${_parsedQuestions.length} questions generated`;
      document.getElementById('pqPreviewErr').textContent=noAns?`âš  ${noAns} missing answers`:'âœ“ All answers included';
      document.getElementById('pqPreviewErr').style.color=noAns?'var(--accent4)':'var(--accent3)';
      document.getElementById('pqPreviewList').innerHTML=_parsedQuestions.slice(0,5).map((q,i)=>{
        const opts=q.options.map((o,oi)=>`<span class="pq-preview-opt${oi===q.answer?' correct':''}">${String.fromCharCode(65+oi)}. ${escHtml(o)}</span>`).join('');
        return `<div class="pq-preview-q"><div class="pq-preview-qn">${i+1}. ${escHtml(q.question)}</div><div class="pq-preview-opts">${opts}</div></div>`;
      }).join('') + (_parsedQuestions.length>5?`<div style="padding:10px 14px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">â€¦and ${_parsedQuestions.length-5} more</div>`:'');
      statusEl.innerHTML=`âœ… ${_parsedQuestions.length} questions generated successfully! Review above then click Save.`;
    }
  }catch(err){
    statusEl.innerHTML='âš  Network error. Check your internet connection.';
  }
  btn.disabled=false;
  document.getElementById('pqAIBtnTxt').textContent='âœ¨ Generate Questions with AI';
}

// ============================================================
// AI â€” GENERATE ANSWERS FOR QUESTIONS WITHOUT ANSWERS
// ============================================================
async function aiGenerateAnswers(){
  const missingAns=_parsedQuestions.filter(q=>q.answer===null||q.answer===undefined);
  if(!missingAns.length){ toast('All questions already have answers.'); return; }

  const btn=document.getElementById('pqAIAnswerBtn');
  const statusEl=document.getElementById('pqAIAnswerStatus');
  btn.disabled=true;
  document.getElementById('pqAIAnswerTxt').innerHTML=`<span class="pq-ai-spin"></span> Looking up answers onlineâ€¦`;
  statusEl.className='pq-ai-status show';
  statusEl.innerHTML=`Searching for correct answers to ${missingAns.length} questionsâ€¦`;

  const courseId=document.getElementById('pqBankCourse').value;
  const course=db.courses.find(c=>c.id===courseId);
  const courseName=course?course.title:'Nursing';

  const qBlock=missingAns.map((q,i)=>{
    const opts=q.options.map((o,oi)=>`${String.fromCharCode(65+oi)}. ${o}`).join('\n');
    return `Q${i+1}: ${q.question}\n${opts}`;
  }).join('\n\n');

  const prompt=`You are an expert in ${courseName}. For each question below, identify the correct answer and provide a brief explanation. Use web search if needed.

${qBlock}

For EACH question, respond ONLY in this exact format (one per line, no extra text):
Q1: [LETTER] | [Brief explanation]
Q2: [LETTER] | [Brief explanation]
...

Example:
Q1: C | The pancreas produces insulin through beta cells in the islets of Langerhans.
Q2: B | Normal adult resting heart rate is 60-100 beats per minute.`;

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-sonnet-4-5-20251001',
        max_tokens:2000,
        messages:[{role:'user',content:prompt}]
      })
    });
    const data=await resp.json();
    const text=data.content.filter(c=>c.type==='text').map(c=>c.text).join('\n');

    // Parse Q1: C | explanation format
    let filled=0;
    const lines=text.split('\n').filter(l=>l.trim());
    lines.forEach(line=>{
      const m=line.match(/Q(\d+):\s*([A-Ea-e])\s*\|\s*(.+)/i);
      if(m){
        const qIdx=parseInt(m[1])-1;
        const ansLetter=m[2].toUpperCase();
        const explanation=m[3].trim();
        if(qIdx>=0 && qIdx<missingAns.length){
          const ansIdx=ansLetter.charCodeAt(0)-65;
          missingAns[qIdx].answer=ansIdx;
          missingAns[qIdx].explanation=explanation;
          filled++;
        }
      }
    });

    if(filled>0){
      statusEl.innerHTML=`âœ… Filled ${filled} of ${missingAns.length} answers. Refreshing previewâ€¦`;
      pqParsePreviewFromParsed();
    } else {
      statusEl.innerHTML='âš  Could not parse AI answer format. Try again.';
    }
  }catch(err){
    statusEl.innerHTML='âš  Network error. Could not reach AI.';
  }
  btn.disabled=false;
  document.getElementById('pqAIAnswerTxt').textContent=`âœ¨ Auto-Generate Answers Online`;
}

function pqParsePreviewFromParsed(){
  const section=document.getElementById('pqPreviewSection');
  const list=document.getElementById('pqPreviewList');
  const count=document.getElementById('pqPreviewCount');
  const err=document.getElementById('pqPreviewErr');
  section.style.display='';
  const noAns=_parsedQuestions.filter(q=>q.answer===null||q.answer===undefined).length;
  count.textContent=`${_parsedQuestions.length} questions`;
  err.textContent=noAns?`âš  ${noAns} still missing answers`:'âœ“ All answers present';
  err.style.color=noAns?'var(--accent4)':'var(--accent3)';
  list.innerHTML=_parsedQuestions.slice(0,6).map((q,i)=>{
    const opts=q.options.map((o,oi)=>`<span class="pq-preview-opt${oi===q.answer?' correct':''}">${String.fromCharCode(65+oi)}. ${escHtml(o)}</span>`).join('');
    const ansLabel=q.answer!==null&&q.answer!==undefined
      ?`<span style="color:var(--accent3);font-size:10px;margin-left:4px;">âœ“ ${String.fromCharCode(65+(q.answer||0))}</span>`
      :`<span style="color:var(--accent4);font-size:10px;margin-left:4px;">âš  No answer</span>`;
    return `<div class="pq-preview-q"><div class="pq-preview-qn">${i+1}. ${escHtml(q.question)}${ansLabel}</div><div class="pq-preview-opts">${opts}</div></div>`;
  }).join('') + (_parsedQuestions.length>6?`<div style="padding:10px 14px;font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">â€¦and ${_parsedQuestions.length-6} more</div>`:'');
  if(noAns===0) document.getElementById('pqAIAnswerSection').style.display='none';
}
// On load: remove any previously auto-seeded ND2 student accounts
(function removeSeededStudents(){
  if(!db || !db.users) return;
  const seededIds = /^u_nd2_ca50_/;
  const before = db.users.length;
  db.users = db.users.filter(function(u){ return !seededIds.test(u.id); });
  if(db.users.length < before){ saveDB(); console.log('Removed ' + (before - db.users.length) + ' seeded ND2 accounts'); }
})();

</script>
<!-- ===== PAST QUESTIONS IMPORT MODAL ===== -->
<div class="overlay" id="pqImportModal">
  <div class="modal" style="max-width:700px;max-height:94vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ§  Import Past Questions</div>
      <button class="modal-x" onclick="closeModal('pqImportModal')">âœ•</button>
    </div>
    <div class="modal-bd pq-import-wrap">

      <!-- Import method tabs -->
      <div class="pq-import-tabs" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <div class="pq-import-tab active" id="pqTabPaste" onclick="switchPQTab('paste')">ðŸ“‹ Paste Text</div>
        <div class="pq-import-tab" id="pqTabDoc" onclick="switchPQTab('doc')">ðŸ“„ Document</div>
        <div class="pq-import-tab" id="pqTabAI" onclick="switchPQTab('ai')">âœ¨ AI Generate</div>
      </div>

      <!-- Bank metadata (always visible) -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
        <div class="form-g" style="margin:0">
          <label class="inp-label">Bank Title</label>
          <input class="inp" id="pqBankTitle" placeholder="e.g. Anatomy Final 2023" style="margin:0">
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Year</label>
          <input class="inp" id="pqBankYear" placeholder="e.g. 2023" style="margin:0">
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Course</label>
          <select class="sel" id="pqBankCourse"></select>
        </div>
        <div class="form-g" style="margin:0">
          <label class="inp-label">Exam Type</label>
          <select class="sel" id="pqBankType">
            <option value="exam">Final Exam</option>
            <option value="test">Test / Quiz</option>
            <option value="mock">Mock Exam</option>
          </select>
        </div>
      </div>

      <!-- TAB: PASTE -->
      <div id="pqPasteTab">
        <div class="pq-import-info">
          â„¹ï¸ Paste questions one per blank-line block. Options: <code>A.</code> <code>B.</code> <code>C.</code> <code>D.</code><br>
          Mark correct answer with <code>*</code> prefix (e.g. <code>*C. Pancreas</code>) or on a new line: <code>Answer: C</code><br>
          Optional: <code>Explanation: â€¦</code> â€” or leave blank and use <strong>âœ¨ AI Generate Answers</strong> after import.
        </div>
        <div class="form-g">
          <label class="inp-label">Paste Questions</label>
          <textarea class="pq-paste-area" id="pqPasteBox" placeholder="1. Which organ produces insulin?
A. Liver
B. Kidney
*C. Pancreas
D. Stomach
Explanation: The pancreas beta cells produce insulin.

2. Normal adult heart rate range:
A. 40-60 bpm
*B. 60-100 bpm
C. 100-120 bpm
D. 120-140 bpm" oninput="pqParseAndPreview()"></textarea>
        </div>
      </div>

      <!-- TAB: DOCUMENT UPLOAD -->
      <div id="pqDocTab" style="display:none">
        <div class="pq-import-info">
          ðŸ“„ Upload a <code>.txt</code>, <code>.pdf</code>, or <code>.docx</code> file containing past questions. The system will extract text and auto-parse them into the same format as paste.
          For best results, ensure questions are numbered and options are on separate lines.
        </div>
        <div class="drop-area" id="pqDocDrop" onclick="document.getElementById('pqDocFile').click()" style="margin-bottom:12px;">
          <div class="drop-ico" id="pqDocIco">ðŸ“</div>
          <div class="drop-txt" id="pqDocTxt"><strong>Click to browse</strong> or drag &amp; drop</div>
          <div class="drop-fmts">TXT Â· PDF (text-based) Â· DOCX</div>
        </div>
        <input type="file" id="pqDocFile" style="display:none" accept=".txt,.pdf,.docx,.doc" onchange="handlePQDocUpload(this)">
        <div id="pqDocStatus" style="display:none;font-size:12px;font-family:'DM Mono',monospace;color:var(--text2);padding:8px 12px;background:var(--bg3);border-radius:8px;margin-bottom:10px;"></div>
      </div>

      <!-- TAB: AI GENERATE -->
      <div id="pqAITab" style="display:none">
        <div class="pq-import-info">
          âœ¨ AI will search the internet and generate past-style exam questions for your selected course. Questions will include multiple-choice options and correct answers with explanations.
        </div>
        <div class="form-g">
          <label class="inp-label">Additional Topic / Instructions (optional)</label>
          <input class="inp" id="pqAITopic" placeholder="e.g. focus on cardiac anatomy, 2022 syllabus, 20 questions" style="margin-bottom:0;">
        </div>
        <button class="pq-ai-btn" id="pqAIGenBtn" onclick="aiGenerateQuestions()">
          <span id="pqAIBtnTxt">âœ¨ Generate Questions with AI</span>
        </button>
        <div class="pq-ai-status" id="pqAIStatus"></div>
      </div>

      <!-- Shared preview -->
      <div id="pqPreviewSection" style="display:none">
        <div class="pq-parse-preview">
          <div class="pq-preview-hd">
            <span id="pqPreviewCount">0 questions parsed</span>
            <span id="pqPreviewErr" style="color:var(--accent4)"></span>
          </div>
          <div id="pqPreviewList"></div>
        </div>
      </div>

      <!-- AI Answer generation for paste/doc questions without answers -->
      <div id="pqAIAnswerSection" style="display:none;margin-top:4px;">
        <button class="pq-ai-btn" id="pqAIAnswerBtn" onclick="aiGenerateAnswers()">
          <span id="pqAIAnswerTxt">âœ¨ Auto-Generate Answers Online (for missing answers)</span>
        </button>
        <div class="pq-ai-status" id="pqAIAnswerStatus"></div>
      </div>

      <button class="btn-submit" onclick="savePQBank()" style="background:linear-gradient(135deg,var(--accent2),var(--accent));margin-top:10px;">ðŸ’¾ Save Question Bank â†’</button>
    </div>
  </div>
</div>

<!-- ===== ANSWER IMPORT MODAL (admin only) ===== -->
<div class="overlay" id="pqAnsImportModal">
  <div class="modal" style="max-width:580px;max-height:88vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht" id="pqAnsImportTitle">ðŸ— Import Answers</div>
      <button class="modal-x" onclick="document.getElementById('pqAnsImportModal').classList.remove('open')">âœ•</button>
    </div>
    <div class="modal-bd">
      <div style="background:rgba(90,173,160,.07);border:1px solid rgba(90,173,160,.2);border-radius:10px;padding:11px 14px;font-size:11px;color:var(--accent2);font-family:'DM Mono',monospace;margin-bottom:16px;line-height:1.9;">
        ðŸ— Paste only the answer key â€” one answer per line (A / B / C / D / E).<br>
        Each line maps to the corresponding question number.<br>
        Accepted formats: &nbsp;<code>1. C</code> &nbsp;|&nbsp; <code>C</code> &nbsp;|&nbsp; <code>A,B,C,D,B,â€¦</code> &nbsp;|&nbsp; <code>A B C D B â€¦</code>
      </div>
      <div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);margin-bottom:8px;" id="pqAnsImportCount"></div>
      <div class="form-g">
        <label class="inp-label">Paste Answer Key</label>
        <textarea class="pq-paste-area" id="pqAnsImportBox" placeholder="1. C&#10;2. A&#10;3. B&#10;4. D&#10;5. C&#10;â€¦&#10;&#10;Or space/comma separated:&#10;C A B D C A D B C A" oninput="pqAnsPreview()" style="min-height:160px;"></textarea>
      </div>
      <div id="pqAnsImportPreview" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
          <span style="font-size:12px;font-family:'DM Mono',monospace;color:var(--accent2);" id="pqAnsMatchCount"></span>
          <button class="btn-submit" id="pqAnsApplyBtn" onclick="applyPQAnswers()" style="width:auto;padding:9px 24px;background:linear-gradient(135deg,var(--accent2),var(--accent));" disabled>âœ“ Apply Answers</button>
        </div>
        <div class="pq-parse-preview" style="max-height:320px;overflow-y:auto;">
          <div class="pq-preview-hd" style="position:sticky;top:0;">
            <span>Preview â€” answers mapped to questions</span>
          </div>
          <div id="pqAnsImportPreviewBody"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== QUIZ OVERLAY ===== -->
<div class="quiz-overlay" id="quizOverlay">
  <div class="quiz-topbar">
    <button class="pv-back" onclick="exitQuiz()">â† Exit</button>
    <div class="quiz-mode-pill exam" id="quizModePill">ðŸŽ¯ EXAM MODE</div>
    <div class="quiz-title-block">
      <div class="quiz-title" id="quizTitle">Question Bank</div>
      <div class="quiz-subtitle" id="quizSubtitle"></div>
    </div>
    <div class="quiz-progress-bar-wrap">
      <div class="quiz-progress-label">
        <span id="quizProgLabel">Q1 / 10</span>
        <span id="quizProgPct">0%</span>
      </div>
      <div class="quiz-progress-bar"><div class="quiz-progress-fill exam" id="quizProgFill" style="width:0%"></div></div>
    </div>
    <div class="quiz-timer" id="quizTimer">â± 00:00</div>
  </div>
  <div class="quiz-body" id="quizBody">
    <div class="quiz-card" id="quizCard"></div>
  </div>
  <div class="quiz-footer">
    <button class="quiz-nav-btn" id="quizPrevBtn" onclick="quizNav(-1)" disabled>â† Prev</button>
    <div class="quiz-dot-nav" id="quizDotNav"></div>
    <button class="quiz-nav-btn" id="quizNextBtn" onclick="quizNav(1)">Next â†’</button>
    <button class="quiz-end-exam-btn" id="quizEndExamBtn" onclick="endExamEarly()">â›³ End Exam</button>
    <button class="quiz-submit-btn exam-sub" id="quizSubmitBtn" onclick="quizSubmit()" style="display:none">Submit Exam âœ“</button>
  </div>
</div>

<!-- ===== QUIZ RESULT OVERLAY ===== -->
<div class="quiz-result-overlay" id="quizResultOverlay">
  <div class="quiz-result-card">
    <div class="quiz-result-icon" id="qrIcon">ðŸŽ‰</div>
    <div class="quiz-result-mode-badge exam" id="qrModeBadge">ðŸŽ¯ Exam Mode</div>
    <div class="quiz-result-title" id="qrTitle">Quiz Complete!</div>
    <div class="quiz-result-sub" id="qrSub"></div>
    <div class="quiz-result-score-ring" id="qrRing">
      <div class="quiz-result-score-pct" id="qrPct">0%</div>
      <div class="quiz-result-score-lbl">Score</div>
    </div>
    <div class="quiz-result-breakdown">
      <div class="quiz-result-stat">
        <div class="quiz-result-stat-val" id="qrCorrect" style="color:var(--accent3)">0</div>
        <div class="quiz-result-stat-lbl">Correct</div>
      </div>
      <div class="quiz-result-stat">
        <div class="quiz-result-stat-val" id="qrWrong" style="color:var(--accent4)">0</div>
        <div class="quiz-result-stat-lbl">Wrong</div>
      </div>
      <div class="quiz-result-stat">
        <div class="quiz-result-stat-val" id="qrSkipped" style="color:var(--text2)">0</div>
        <div class="quiz-result-stat-lbl">Skipped</div>
      </div>
    </div>
    <div class="quiz-result-actions">
      <button class="quiz-result-btn ghost" onclick="closeQuizResult()">âœ• Close</button>
      <button class="quiz-result-btn primary-study" id="qrRetryStudyBtn" onclick="retryQuiz('study')">ðŸ“– Study Mode</button>
      <button class="quiz-result-btn primary-exam" id="qrRetryExamBtn" onclick="retryQuiz('exam')">â†º Retry Exam</button>
      <button class="quiz-result-btn ghost" id="qrReviewBtn" onclick="reviewQuiz()">ðŸ“‹ Review Answers</button>
    </div>
  </div>
</div>


<!-- CGPA SUMMARY MODAL -->
<div class="overlay" id="cgpaSummaryModal">
  <div class="modal" style="max-width:720px;max-height:90vh;overflow-y:auto;">
    <div class="modal-hd">
      <div class="modal-ht">ðŸ“ˆ Student CGPA Summary</div>
      <button class="modal-x" onclick="closeModal('cgpaSummaryModal')">âœ•</button>
    </div>
    <div class="modal-bd">
      <div id="cgpaSummaryContent"></div>
    </div>
  </div>
</div>
<!-- ===== DOCUMENT VAULT LOGIC ===== -->
<script>
// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFileIcon(name){
  const ext=(name||'').split('.').pop().toLowerCase();
  const m={pdf:'ðŸ“„',docx:'ðŸ“',doc:'ðŸ“',xlsx:'ðŸ“Š',xls:'ðŸ“Š',csv:'ðŸ“Š',pptx:'ðŸ“‘',ppt:'ðŸ“‘',png:'ðŸ–¼',jpg:'ðŸ–¼',jpeg:'ðŸ–¼',gif:'ðŸ–¼',webp:'ðŸ–¼',txt:'ðŸ“ƒ',mp4:'ðŸŽ¬',mp3:'ðŸŽµ'};
  return m[ext]||'ðŸ“Ž';
}
function fmtFileSize(bytes){
  if(bytes<1024) return bytes+'B';
  if(bytes<1024*1024) return (bytes/1024).toFixed(1)+'KB';
  return (bytes/(1024*1024)).toFixed(1)+'MB';
}
function docIconBg(name){
  const ext=(name||'').split('.').pop().toLowerCase();
  if(['pdf'].includes(ext)) return 'rgba(224,123,123,.15)';
  if(['docx','doc','txt'].includes(ext)) return 'rgba(62,142,149,.15)';
  if(['xlsx','xls','csv'].includes(ext)) return 'rgba(90,173,160,.15)';
  if(['png','jpg','jpeg','gif','webp'].includes(ext)) return 'rgba(251,191,36,.15)';
  return 'rgba(90,173,160,.15)';
}

// â”€â”€â”€ Render document list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMyDocVault(){
  const u=currentUser;
  const docs=u.documents||[];
  const list=document.getElementById('myDocVaultList');
  if(!docs.length){
    list.innerHTML=`<div class="doc-empty">ðŸ“­ No documents saved yet.<br>Upload your first document below.</div>`;
    return;
  }
  list.innerHTML=docs.map((d,i)=>`
    <div class="doc-vault-item" id="dvitem_${i}">
      <div class="doc-vault-icon" style="background:${docIconBg(d.name)}">${getFileIcon(d.name)}</div>
      <div style="flex:1;min-width:0;">
        <div class="doc-vault-name">${d.name}</div>
        <div class="doc-vault-meta">${fmtFileSize(d.size)} &nbsp;Â·&nbsp; ${d.date}</div>
      </div>
      <div class="doc-vault-actions">
        <button class="doc-vault-btn" onclick="previewDoc(${i})" title="View / Print">ðŸ‘ View</button>
        <button class="doc-vault-btn" onclick="downloadDoc(${i})" title="Download">â¬‡</button>
        <button class="doc-vault-btn danger" onclick="deleteDoc(${i})" title="Delete">ðŸ—‘</button>
      </div>
    </div>`).join('');
}

// â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleDocUpload(inp, target){
  const files=[...inp.files];
  if(!files.length) return;
  const maxSz=10*1024*1024;
  let ok=0;
  files.forEach(file=>{
    if(file.size>maxSz){toast(`${file.name} exceeds 10MB limit`);return;}
    const reader=new FileReader();
    reader.onload=e=>{
      const doc={
        name:file.name,
        type:file.type||'application/octet-stream',
        size:file.size,
        date:new Date().toLocaleDateString(),
        data:e.target.result
      };
      const u=db.users.find(x=>x.id===currentUser.id);
      if(!u.documents) u.documents=[];
      u.documents.push(doc);
      if(!currentUser.documents) currentUser.documents=[];
      currentUser.documents.push(doc);
      saveDB();
      renderMyDocVault();
      ok++;
      if(ok===files.filter(f=>f.size<=maxSz).length) toast(`${ok} document${ok>1?'s':''} uploaded âœ“`);
    };
    reader.readAsDataURL(file);
  });
  inp.value='';
}

// â”€â”€â”€ Drag-drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function docDragOver(e,zoneId){e.preventDefault();document.getElementById(zoneId).classList.add('drag-over');}
function docDragLeave(e,zoneId){document.getElementById(zoneId).classList.remove('drag-over');}
function docDrop(e,target){
  e.preventDefault();
  const zoneId=target==='me'?'myDocUploadZone':'myDocUploadZone';
  document.getElementById(zoneId).classList.remove('drag-over');
  const dt=e.dataTransfer;
  if(dt.files.length){
    const fakeInp=document.createElement('input');
    fakeInp.files=dt.files;
    handleDocUpload(fakeInp,'me');
  }
}

// â”€â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function deleteDoc(idx){
  if(!confirm('Delete this document? This cannot be undone.')) return;
  const u=db.users.find(x=>x.id===currentUser.id);
  if(!u.documents) return;
  u.documents.splice(idx,1);
  currentUser.documents=[...u.documents];
  saveDB();
  renderMyDocVault();
  toast('Document deleted');
}

// â”€â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadDoc(idx){
  const docs=currentUser.documents||[];
  const d=docs[idx];
  if(!d) return;
  const a=document.createElement('a');
  a.href=d.data;
  a.download=d.name;
  a.click();
}

// â”€â”€â”€ Preview & Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _previewDoc=null;
function previewDoc(idx){
  const docs=currentUser.documents||[];
  const d=docs[idx];
  if(!d) return;
  _previewDoc=d;
  document.getElementById('docPreviewTitle').textContent=d.name;
  const body=document.getElementById('docPreviewBody');
  body.innerHTML='<div style="text-align:center;padding:40px;color:var(--text3);font-family:\'DM Mono\',monospace;">Loadingâ€¦</div>';
  document.getElementById('docPreviewModal').classList.add('open');

  const ext=(d.name||'').split('.').pop().toLowerCase();
  if(['png','jpg','jpeg','gif','webp'].includes(ext)){
    body.innerHTML=`<img src="${d.data}" style="max-width:100%;border-radius:8px;display:block;margin:auto;">`;
  } else if(ext==='pdf'){
    body.innerHTML=`<embed src="${d.data}" type="application/pdf" style="width:100%;height:70vh;border-radius:8px;">`;
  } else if(['docx','doc'].includes(ext)){
    // Use mammoth to render docx in browser
    const base64=d.data.split(',')[1];
    const bytes=Uint8Array.from(atob(base64),c=>c.charCodeAt(0));
    mammoth.convertToHtml({arrayBuffer:bytes.buffer}).then(r=>{
      body.innerHTML=`<div style="font-family:'Instrument Sans',sans-serif;line-height:1.7;padding:10px 20px;color:var(--text);max-width:700px;margin:auto;">${r.value}</div>`;
    }).catch(()=>{
      body.innerHTML=`<div class="doc-empty">âš  Cannot preview this file type.<br>Please download it to view.</div>`;
    });
  } else if(['txt'].includes(ext)){
    const base64=d.data.split(',')[1];
    const text=decodeURIComponent(escape(atob(base64)));
    body.innerHTML=`<pre style="font-family:'DM Mono',monospace;font-size:13px;line-height:1.6;color:var(--text);white-space:pre-wrap;padding:10px 20px;">${text.replace(/</g,'&lt;')}</pre>`;
  } else {
    body.innerHTML=`<div class="doc-empty" style="padding:60px;">${getFileIcon(d.name)}<br><br>Preview not available for this file type.<br><br><button class="doc-vault-btn" onclick="downloadDoc(${idx})" style="margin-top:10px;">â¬‡ Download to view</button></div>`;
  }
}

function closeDocPreview(){
  document.getElementById('docPreviewModal').classList.remove('open');
  _previewDoc=null;
}

function downloadDocPreview(){
  if(!_previewDoc) return;
  const a=document.createElement('a');
  a.href=_previewDoc.data;
  a.download=_previewDoc.name;
  a.click();
}

function printDocPreview(){
  if(!_previewDoc) return;
  const ext=(_previewDoc.name||'').split('.').pop().toLowerCase();
  const win=window.open('','_blank');
  if(!win) return toast('Pop-up blocked â€“ allow pop-ups to print');
  
  if(['png','jpg','jpeg','gif','webp'].includes(ext)){
    win.document.write(`<!DOCTYPE html><html><head><title>${_previewDoc.name}</title>
    <style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;}img{max-width:100%;}</style>
    </head><body><img src="${_previewDoc.data}" onload="window.print();window.close();">
</body></html>`);
  } else if(ext==='pdf'){
    win.document.write(`<!DOCTYPE html><html><head><title>${_previewDoc.name}</title>
    <style>body{margin:0;}embed{width:100vw;height:100vh;}</style>
    </head><body><embed src="${_previewDoc.data}" type="application/pdf"></body></html>`);
    setTimeout(()=>{try{win.print();}catch(e){}},1000);
  } else {
    const body=document.getElementById('docPreviewBody').innerHTML;
    win.document.write(`<!DOCTYPE html><html><head><title>${_previewDoc.name}</title>
    <style>body{font-family:sans-serif;max-width:800px;margin:30px auto;line-height:1.7;}@media print{body{margin:0;}}</style>
    </head><body>${body}<script>window.onload=()=>{window.print();window.close();}<\/script></body></html>`);
  }
  win.document.close();
}

// â”€â”€â”€ Close preview on backdrop click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('docPreviewModal').addEventListener('click',function(e){
  if(e.target===this) closeDocPreview();
});

// ============================================================
// MESSAGING SYSTEM
// ============================================================
/*
  THREAD TYPES:
  - "announce:<classId>"   â†’ Announcement â€” lecturers/admin post; ALL can REPLY
  - "classgroup:<classId>" â†’ Class group â€” all students + lecturers + admin can post
  - "dm:<idA>:<idB>"       â†’ Direct message

  PERMISSIONS:
  - Students:  reply in announce, send in classgroup, DM any student/lecturer (NOT admin)
  - Lecturers: post in announce/classgroup, DM anyone (students, lecturers, admin), send files
  - Admin:     post in announce/classgroup, DM lecturers freely, send files
  - Files:     any user who can send text can send any file type
  - Voice:     any user who can send text can record and send voice messages
*/

let activeThreadId = null;
let msgPollInterval = null;
let _mediaRecorder = null;
let _audioChunks = [];
let _recTimerInterval = null;
let _recSeconds = 0;
let _currentAudio = null;
let _currentPlayBtnId = null;

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dmThreadId(a, b){ return 'dm:'+[a,b].sort().join(':'); }
function myId(){ return currentUser.id||'admin'; }
function escHtml(t){ return (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s){ return (s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function fmtSize(b){ if(!b) return ''; if(b<1024) return b+'B'; if(b<1048576) return (b/1024).toFixed(1)+'KB'; return (b/1048576).toFixed(1)+'MB'; }
function fmtDur(s){ if(!s) return '0:00'; const m=Math.floor(s/60); return m+':'+(s%60<10?'0':'')+Math.floor(s%60); }
function fileIcon(name){
  const e=(name||'').split('.').pop().toLowerCase();
  const m={pdf:'ðŸ“„',doc:'ðŸ“',docx:'ðŸ“',xls:'ðŸ“Š',xlsx:'ðŸ“Š',csv:'ðŸ“Š',ppt:'ðŸ“‘',pptx:'ðŸ“‘',
    txt:'ðŸ“ƒ',zip:'ðŸ—œ',rar:'ðŸ—œ',mp4:'ðŸŽ¬',mp3:'ðŸŽµ',wav:'ðŸŽµ',mov:'ðŸŽ¬',avi:'ðŸŽ¬'};
  return m[e]||'ðŸ“Ž';
}
function fmtMsgTime(ts){
  const now=Date.now(),d=new Date(ts),diff=now-ts;
  if(diff<60000) return 'just now';
  if(diff<3600000) return Math.floor(diff/60000)+'m ago';
  if(diff<86400000) return d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
  return d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
}

// â”€â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAllUsers(){
  const admin={id:'admin',name:(typeof ADMIN_NAME!=='undefined'?ADMIN_NAME:'Administrator'),
    username:'admin',role:'admin',cls:'All',avatar:db.adminAvatar||'',matric:''};
  return [admin,...(db.users||[])];
}

// â”€â”€â”€ Permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function canSendIn(threadId){
  if(!threadId) return false;
  // All logged-in users can send in any channel/DM they are part of
  if(threadId.startsWith('announce:')||threadId.startsWith('classgroup:')){
    return true; // everyone can post in all class channels
  }
  if(threadId.startsWith('dm:')){
    // Only the two participants of a DM thread can send in it
    const parts=threadId.split(':').slice(1);
    return parts.includes(myId());
  }
  return false;
}

function canSeeThread(threadId){
  // All users can see all class channels and their own DMs
  if(threadId.startsWith('announce:')||threadId.startsWith('classgroup:')){
    return true;
  }
  if(threadId.startsWith('dm:')){
    return threadId.split(':').slice(1).includes(myId());
  }
  return false;
}

// â”€â”€â”€ Thread list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMyThreads(){
  if(!db.messages) db.messages=[];
  const role=currentRole, myClassId=currentUser.classId||'';
  const threads={};
  db.messages.forEach(m=>{
    const tid=m.threadId;
    if(!canSeeThread(tid)) return;
    if(!threads[tid]) threads[tid]={threadId:tid,messages:[],lastMsg:null};
    threads[tid].messages.push(m);
    if(!threads[tid].lastMsg||m.timestamp>threads[tid].lastMsg.timestamp)
      threads[tid].lastMsg=m;
  });
  // Ensure structural channels always show (even empty)
  const classes=db.classes||[];
  if(role==='teacher'||role==='admin'){
    classes.forEach(cl=>{
      ['announce:'+cl.id,'classgroup:'+cl.id].forEach(tid=>{
        if(!threads[tid]) threads[tid]={threadId:tid,messages:[],lastMsg:null};
      });
    });
  } else {
    // Students see ALL class channels (not just their own)
    classes.forEach(cl=>{
      ['announce:'+cl.id,'classgroup:'+cl.id].forEach(tid=>{
        if(!threads[tid]) threads[tid]={threadId:tid,messages:[],lastMsg:null};
      });
    });
  }
  // Also include any explicitly opened DM threads (even if no messages yet)
  const openedDMs = db.dmThreads || [];
  openedDMs.forEach(tid=>{
    if(canSeeThread(tid) && !threads[tid]){
      threads[tid]={threadId:tid,messages:[],lastMsg:null};
    }
  });
  const seen=new Set();
  return Object.values(threads).filter(t=>{
    if(seen.has(t.threadId)) return false; seen.add(t.threadId); return true;
  });
}

// â”€â”€â”€ Thread metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function threadMeta(thread){
  const tid=thread.threadId||thread;
  const allU=getAllUsers();
  if(tid.startsWith('announce:')){
    const cl=(db.classes||[]).find(c=>c.id===tid.split(':')[1]);
    return {name:`ðŸ“¢ ${cl?cl.name:'Class'} â€” Announcements`,
      sub:cl?`Lecturer announcements Â· ${cl.full}`:'Announcements',
      icon:'ðŸ“¢',bg:'rgba(224,123,123,.12)',isGroup:true,isAnnounce:true};
  }
  if(tid.startsWith('classgroup:')){
    const cl=(db.classes||[]).find(c=>c.id===tid.split(':')[1]);
    return {name:`ðŸ‘¥ ${cl?cl.name:'Class'} â€” Group Chat`,
      sub:cl?`Class group Â· ${cl.full}`:'Class group',
      icon:'ðŸ‘¥',bg:'rgba(90,173,160,.12)',isGroup:true,isAnnounce:false};
  }
  if(tid.startsWith('dm:')){
    const otherId=tid.split(':').slice(1).find(p=>p!==myId());
    let other=allU.find(u=>u.id===otherId);
    if(!other){
      // Fallback: try to get name from last message sent by the other person
      const lastMsgByOther=(db.messages||[]).filter(m=>m.threadId===tid&&m.senderId===otherId).slice(-1)[0];
      const fallbackName=lastMsgByOther?lastMsgByOther.senderName:otherId||'Unknown';
      other={name:fallbackName,avatar:'',role:'student',matric:''};
    }
    const dn=other.name||other.username||'User';
    const clsName=other.role==='student'&&other.classId
      ?((db.classes||[]).find(c=>c.id===other.classId)||{}).name||'':'';
    const roleLabel=other.role==='teacher'?'Lecturer':other.role==='admin'?'Administrator'
      :`Student${clsName?' Â· '+clsName:''}${other.matric?' Â· '+other.matric:''}`;
    const label=other.role==='student'&&other.matric?`${dn} (${other.matric})`:dn;
    return {name:label,sub:roleLabel,icon:dn[0]?.toUpperCase()||'?',avatar:other.avatar||'',
      bg:other.role==='teacher'?'rgba(62,142,149,.15)':other.role==='admin'?'rgba(251,191,36,.15)':'rgba(90,173,160,.15)',
      isGroup:false,isAnnounce:false,otherId};
  }
  return {name:'Chat',sub:'',icon:'ðŸ’¬',bg:'var(--bg3)',isGroup:false,isAnnounce:false};
}

function countUnread(thread){
  return (thread.messages||[]).filter(m=>m.senderId!==myId()&&!(m.readBy||[]).includes(myId())).length;
}

// â”€â”€â”€ Sidebar render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMessaging(){
  if(!db.messages) db.messages=[];
  renderMsgChannels();
  renderClassmatesPanel();
  startMsgPoll();
}

function renderMsgChannels(filter=''){
  const threads=getMyThreads();
  const container=document.getElementById('msgChannelList');
  if(!container) return;
  threads.sort((a,b)=>{
    const ao=a.threadId.startsWith('announce:'),bo=b.threadId.startsWith('announce:');
    const ag=a.threadId.startsWith('classgroup:'),bg2=b.threadId.startsWith('classgroup:');
    if(ao&&!bo)return -1; if(!ao&&bo)return 1;
    if(ag&&!bg2)return -1; if(!ag&&bg2)return 1;
    return (b.lastMsg?b.lastMsg.timestamp:0)-(a.lastMsg?a.lastMsg.timestamp:0);
  });
  const f=(filter||'').toLowerCase();
  let annH='',grpH='',dmH='';
  threads.forEach(t=>{
    const meta=threadMeta(t);
    const lm=t.lastMsg;
    let preview='No messages yet';
    if(lm){
      const fn=(lm.senderName||lm.senderId||'User').split(' ')[0];
      if(lm.msgType==='file') preview=`${fn}: ðŸ“Ž ${lm.fileName||'File'}`;
      else if(lm.msgType==='voice') preview=`${fn}: ðŸŽ™ Voice message`;
      else if(lm.msgType==='image') preview=`${fn}: ðŸ–¼ Image`;
      else preview=`${fn}: ${(lm.text||'').slice(0,36)}${(lm.text||'').length>36?'â€¦':''}`;
    }
    if(f&&!meta.name.toLowerCase().includes(f)&&!preview.toLowerCase().includes(f)) return;
    const unread=countUnread(t);
    const av=meta.avatar?`<img src="${meta.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`:`<span>${meta.icon}</span>`;
    const ac=t.threadId===activeThreadId?'active':'';
    const item=`<div class="msg-channel-item ${ac}" onclick="openThread('${t.threadId}')">
      <div class="msg-channel-av" style="background:${meta.bg}">${av}</div>
      <div class="msg-channel-info">
        <div class="msg-channel-name">${meta.name}</div>
        <div class="msg-channel-preview">${escHtml(preview)}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;">
        <div class="msg-channel-time">${lm?fmtMsgTime(lm.timestamp):''}</div>
        ${unread?`<div class="msg-unread">${unread>9?'9+':unread}</div>`:''}
      </div>
    </div>`;
    if(t.threadId.startsWith('announce:')) annH+=item;
    else if(t.threadId.startsWith('classgroup:')) grpH+=item;
    else dmH+=item;
  });
  let html='';
  if(annH) html+=`<div class="msg-channel-group-label">ðŸ“¢ Announcements</div>${annH}`;
  if(grpH) html+=`<div class="msg-channel-group-label">ðŸ‘¥ Class Groups</div>${grpH}`;
  if(dmH) html+=`<div class="msg-channel-group-label">ðŸ’¬ Direct Messages</div>${dmH}`;
  if(!html) html=`<div style="text-align:center;padding:30px 20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">No conversations yet.<br>Tap ï¼‹ to start!</div>`;
  container.innerHTML=html;
  const total=threads.reduce((s,t)=>s+countUnread(t),0);
  const badge=document.getElementById('msgNavBadge');
  if(badge) badge.style.display=total?'inline-block':'none';
}

function filterMsgChannels(v){ renderMsgChannels(v); }

// â”€â”€â”€ Open thread â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openThread(threadId){
  activeThreadId=threadId;
  // Persist DM thread so it shows up on both sides even before first message
  if(threadId.startsWith('dm:')){
    if(!db.dmThreads) db.dmThreads=[];
    if(!db.dmThreads.includes(threadId)){
      db.dmThreads.push(threadId);
      saveDB();
    }
  }
  const meta=threadMeta({threadId});
  const avEl=document.getElementById('msgChatAv');
  avEl.style.background=meta.bg;
  avEl.innerHTML=meta.avatar?`<img src="${meta.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">`:`<span>${meta.icon}</span>`;
  document.getElementById('msgChatName').textContent=meta.name;
  document.getElementById('msgChatSub').textContent=meta.sub;
  const badge=document.getElementById('msgAnnounceBadge');
  badge.style.display=meta.isAnnounce?'inline-flex':'none';
  if(meta.isAnnounce) badge.textContent='ðŸ“¢ Announcement Channel';

  const canSend=canSendIn(threadId);
  const inputBar=document.getElementById('msgInputBar');
  const roNotice=document.getElementById('msgReadonlyNotice');
  // Students in announce channel: they can reply so always show input
  // The old "readonly" notice is only shown if canSend is false
  if(inputBar) inputBar.style.display=canSend?'flex':'none';
  if(roNotice) roNotice.style.display=canSend?'none':'flex';

  // Update placeholder
  const inp=document.getElementById('msgTextInp');
  if(inp){
    if(threadId.startsWith('announce:')&&currentRole==='student') inp.placeholder='Reply to announcementâ€¦';
    else if(threadId.startsWith('announce:')) inp.placeholder='Write an announcementâ€¦';
    else if(threadId.startsWith('classgroup:')) inp.placeholder='Message the groupâ€¦';
    else inp.placeholder='Type a messageâ€¦';
  }

  document.getElementById('msgEmptyState').style.display='none';
  document.getElementById('msgActiveChat').style.cssText='display:flex;flex-direction:column;height:100%;overflow:hidden;';
  renderMsgChannels(document.getElementById('msgSearchInp')?document.getElementById('msgSearchInp').value:'');
  markThreadRead(threadId);
  renderMsgBody(threadId);
  if(window.innerWidth<=640){
    document.getElementById('msgSidebarPane').classList.add('mobile-hidden');
    document.getElementById('msgBackBtn').style.display='flex';
  }
}

function msgGoBack(){
  document.getElementById('msgSidebarPane').classList.remove('mobile-hidden');
  document.getElementById('msgBackBtn').style.display='none';
  activeThreadId=null;
  document.getElementById('msgEmptyState').style.display='flex';
  document.getElementById('msgActiveChat').style.cssText='display:none;';
}

// â”€â”€â”€ Render messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMsgBody(threadId){
  if(!db.messages) db.messages=[];
  const msgs=db.messages.filter(m=>m.threadId===threadId).sort((a,b)=>a.timestamp-b.timestamp);
  // Restore fileData from separate storage for file/image/voice messages
  msgs.forEach(m=>{
    if(!m.fileData && (m.msgType==='file'||m.msgType==='image'||m.msgType==='voice')){
      const fd=loadMsgFileData(m.id);
      if(fd) m.fileData=fd;
    }
  });
  const body=document.getElementById('msgBody');
  if(!body) return;
  let html='', lastDate='';
  msgs.forEach(m=>{
    const d=new Date(m.timestamp);
    const ds=d.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'});
    if(ds!==lastDate){ html+=`<div class="msg-date-divider"><span>${ds}</span></div>`; lastDate=ds; }
    const isMine=m.senderId===myId();
    const isAnn=(m.senderRole==='teacher'||m.senderRole==='admin')&&threadId.startsWith('announce:')&&!isMine;
    const bubCls=isMine?'mine':isAnn?'lecture':'them';
    const avBg=m.senderRole==='admin'?'rgba(251,191,36,.2)':m.senderRole==='teacher'?'rgba(62,142,149,.2)':'rgba(90,173,160,.2)';
    const avC=m.senderAvatar?`<img src="${m.senderAvatar}">`:(m.senderName||'?')[0].toUpperCase();
    const ts=d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
    const roleTag=m.senderRole==='teacher'?` <span style="font-size:9px;opacity:.5;">(Lecturer)</span>`:m.senderRole==='admin'?` <span style="font-size:9px;opacity:.5;">(Admin)</span>`:'';
    const bubContent=buildBubble(m,bubCls,isMine);
    html+=`<div class="msg-bubble-wrap ${isMine?'mine':''}">
      <div class="msg-av-sm" style="background:${avBg}">${avC}</div>
      <div class="msg-bubble-col">
        ${!isMine?`<div class="msg-sender-name">${escHtml(m.senderName)}${roleTag}</div>`:''}
        ${bubContent}
        <div class="msg-bubble-time">${ts}</div>
      </div>
    </div>`;
  });
  if(!msgs.length) html=`<div class="msg-empty-state" style="flex:1;"><div style="font-size:36px;opacity:.3;">ðŸ’¬</div><div style="font-size:12px;font-family:'DM Mono',monospace;color:var(--text3);">No messages yet.</div></div>`;
  body.innerHTML=html; body.scrollTop=body.scrollHeight;
}

function buildBubble(m, bubCls, isMine){
  if(m.msgType==='image'){
    if(!m.fileData) return `<div class="msg-bubble ${bubCls}" style="opacity:.5;">ðŸ–¼ Image unavailable</div>`;
    return `<div class="msg-img-thumb" onclick="previewImg('${escAttr(m.fileData)}','${escAttr(m.fileName||'Image')}')">
      <img src="${m.fileData}" alt="${escHtml(m.fileName||'Image')}" style="max-width:220px;border-radius:12px;display:block;">
    </div>`;
  }
  if(m.msgType==='file'){
    if(!m.fileData) return `<div class="msg-bubble ${bubCls}" style="opacity:.5;">ðŸ“Ž ${escHtml(m.fileName||'File')} â€” unavailable</div>`;
    const ic=fileIcon(m.fileName);
    const bg=isMine?'rgba(255,255,255,.15)':'rgba(62,142,149,.1)';
    return `<div class="msg-file-bubble ${isMine?'mine':'them'}" onclick="downloadFile('${escAttr(m.fileData)}','${escAttr(m.fileName||'file')}')">
      <div class="msg-file-icon" style="background:${bg}">${ic}</div>
      <div class="msg-file-info">
        <div class="msg-file-name" style="${isMine?'color:#fff':''}">${escHtml(m.fileName||'File')}</div>
        <div class="msg-file-meta">${fmtSize(m.fileSize)} Â· tap to download</div>
      </div>
    </div>`;
  }
  if(m.msgType==='voice'){
    if(!m.fileData) return `<div class="msg-bubble ${bubCls}" style="opacity:.5;">ðŸŽ™ Voice message unavailable</div>`;
    const dur=fmtDur(m.voiceDuration);
    const pid='vp_'+m.id;
    const bars=Array.from({length:22},()=>`<div class="msg-voice-bar-item" style="height:${4+Math.floor(Math.random()*20)}px;background:${isMine?'rgba(255,255,255,.5)':'var(--accent)'};border-radius:2px;"></div>`).join('');
    const bubBg=isMine?`linear-gradient(135deg,var(--accent),var(--accent2))`:`var(--bg3)`;
    const bubBorder=isMine?'none':`1px solid var(--border)`;
    const playBg=isMine?'rgba(255,255,255,.25)':'var(--accent)';
    return `<div class="msg-voice-bubble" style="background:${bubBg};border:${bubBorder};">
      <button class="msg-voice-play" id="${pid}" style="background:${playBg};color:#fff;" onclick="toggleVoice('${escAttr(m.fileData)}','${pid}')">â–¶</button>
      <div class="msg-voice-bars">${bars}</div>
      <div class="msg-voice-dur" style="${isMine?'color:rgba(255,255,255,.6)':''}">${dur}</div>
    </div>`;
  }
  // Plain text
  return `<div class="msg-bubble ${bubCls}">${escHtml(m.text||'').replace(/\n/g,'<br>')}</div>`;
}

// â”€â”€â”€ Image preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function previewImg(src, name){
  const ov=document.createElement('div');
  ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:3000;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;cursor:zoom-out;';
  ov.onclick=()=>document.body.removeChild(ov);
  ov.innerHTML=`<div style="font-size:12px;color:rgba(255,255,255,.6);font-family:'DM Mono',monospace;">${escHtml(name)}</div>
    <img src="${src}" style="max-width:90vw;max-height:80vh;border-radius:10px;object-fit:contain;" onclick="event.stopPropagation()">
    <button onclick="event.stopPropagation();downloadFile('${escAttr(src)}','${escAttr(name)}')" style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:13px;font-family:'Instrument Sans',sans-serif;">â¬‡ Download</button>`;
  document.body.appendChild(ov);
}
function downloadFile(data, name){
  const a=document.createElement('a'); a.href=data; a.download=name||'file'; a.click();
}

// â”€â”€â”€ Voice playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleVoice(src, btnId){
  const btn=document.getElementById(btnId);
  if(_currentAudio&&!_currentAudio.paused){
    _currentAudio.pause();
    const old=document.getElementById(_currentPlayBtnId||'');
    if(old) old.textContent='â–¶';
    if(btnId===_currentPlayBtnId){ _currentAudio=null; _currentPlayBtnId=null; return; }
  }
  _currentAudio=new Audio(src);
  _currentPlayBtnId=btnId;
  if(btn) btn.textContent='â¸';
  _currentAudio.play().catch(()=>{ if(btn) btn.textContent='â–¶'; });
  _currentAudio.onended=()=>{ if(btn) btn.textContent='â–¶'; _currentAudio=null; _currentPlayBtnId=null; };
}

// â”€â”€â”€ Send text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMessage(){
  if(!activeThreadId) return;
  const inp=document.getElementById('msgTextInp');
  const text=(inp.value||'').trim();
  if(!text) return;
  if(!canSendIn(activeThreadId)){ toast('You cannot send messages here.'); return; }
  pushMsg({threadId:activeThreadId,msgType:'text',text});
  inp.value=''; inp.style.height='auto';
}

// â”€â”€â”€ File attach â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMsgFileAttach(inp){
  if(!inp.files||!inp.files.length) return;
  if(!activeThreadId){ toast('Open a conversation first.'); inp.value=''; return; }
  if(!canSendIn(activeThreadId)){ toast('You cannot send files here.'); inp.value=''; return; }
  const MAX=20*1024*1024;
  Array.from(inp.files).forEach(file=>{
    if(file.size>MAX){ toast(`${file.name} is over 20 MB.`); return; }
    const rd=new FileReader();
    rd.onload=e=>{
      const isImg=/^image\//i.test(file.type);
      pushMsg({threadId:activeThreadId,msgType:isImg?'image':'file',
        fileData:e.target.result,fileName:file.name,fileSize:file.size,text:''});
    };
    rd.readAsDataURL(file);
  });
  inp.value='';
}

// â”€â”€â”€ Voice record â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€ Voice Recording â€” 2-state: Record â†’ Preview â†’ Send â”€â”€â”€â”€â”€â”€
let _voiceBlob     = null;   // recorded audio blob
let _voiceDataURL  = null;   // base64 data url
let _voiceDuration = 0;      // seconds recorded
let _previewAudio  = null;   // Audio object for preview playback
let _previewRAF    = null;   // requestAnimationFrame handle
let _recordStream  = null;   // mic stream (so we can stop tracks)
let _voiceStaticWave = [];   // snapshot of waveform bars for preview

function startVoiceRecord(){
  if(!activeThreadId){ toast('Open a conversation first.'); return; }
  if(!canSendIn(activeThreadId)){ toast('You cannot send messages here.'); return; }
  if(!navigator.mediaDevices){ toast('Voice messages not supported in this browser.'); return; }

  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    _recordStream = stream;
    _audioChunks  = [];
    _recSeconds   = 0;
    _voiceBlob    = null;
    _voiceDataURL = null;
    _voiceStaticWave = [];

    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
               : MediaRecorder.isTypeSupported('audio/webm')             ? 'audio/webm'
               : 'audio/ogg';

    _mediaRecorder = new MediaRecorder(stream, {mimeType: mime});
    _mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) _audioChunks.push(e.data); };

    _mediaRecorder.onstop = () => {
      // Stop mic tracks
      if(_recordStream){ _recordStream.getTracks().forEach(t=>t.stop()); _recordStream=null; }
      if(_audioChunks.length === 0){ _hideRecBar(); return; }

      _voiceBlob = new Blob(_audioChunks, {type: mime});
      _voiceDuration = _recSeconds;

      // Convert to data URL so we can play and later send
      const rd = new FileReader();
      rd.onload = ev => {
        _voiceDataURL = ev.target.result;
        _hideRecBar();
        _showPreviewBar();
      };
      rd.onerror = () => { toast('Failed to process audio.'); _hideRecBar(); };
      rd.readAsDataURL(_voiceBlob);
    };

    _mediaRecorder.start(100);
    _showRecBar();

    _recTimerInterval = setInterval(()=>{
      _recSeconds++;
      const el = document.getElementById('msgRecTimer');
      if(el) el.textContent = fmtDur(_recSeconds);
      _animateRecWave();
      if(_recSeconds >= 180) stopRecordingForPreview(); // 3-min max
    }, 1000);

  }).catch(err => {
    let msg = 'Microphone access denied.';
    if(err.name==='NotAllowedError'||err.name==='PermissionDeniedError')
      msg = 'Microphone permission denied. Click the ðŸ”’ lock icon in your address bar â†’ allow Microphone â†’ reload.';
    else if(err.name==='NotFoundError')
      msg = 'No microphone found. Please connect a microphone and try again.';
    else if(err.name==='NotReadableError')
      msg = 'Microphone in use by another app. Close other apps and try again.';
    toast(msg);
  });
}

// Called by "Stop â– " button â€” stops recording, shows preview
function stopRecordingForPreview(){
  if(_mediaRecorder && _mediaRecorder.state !== 'inactive'){
    // Snapshot the current wave for the static preview display
    const bars = document.getElementById('msgRecWave');
    if(bars) _voiceStaticWave = Array.from(bars.children).map(b=>b.style.height);
    _mediaRecorder.stop();  // triggers _mediaRecorder.onstop â†’ _showPreviewBar
  }
}

// Cancel during recording
function cancelVoiceRecord(){
  if(_mediaRecorder && _mediaRecorder.state !== 'inactive'){
    _mediaRecorder.onstop = ()=>{};  // suppress preview
    _mediaRecorder.stop();
  }
  if(_recordStream){ _recordStream.getTracks().forEach(t=>t.stop()); _recordStream=null; }
  _hideRecBar();
}

function _showRecBar(){
  const rb = document.getElementById('msgRecordBar');
  const ib = document.getElementById('msgInputBar');
  const pv = document.getElementById('msgVoicePreviewBar');
  if(rb) rb.classList.add('active');
  if(ib) ib.style.display = 'none';
  if(pv) pv.style.display = 'none';
  const vb = document.getElementById('msgVoiceBtn');
  if(vb) vb.classList.add('rec-active');
}

function _hideRecBar(){
  const rb = document.getElementById('msgRecordBar');
  if(rb) rb.classList.remove('active');
  const vb = document.getElementById('msgVoiceBtn');
  if(vb) vb.classList.remove('rec-active');
  if(_recTimerInterval){ clearInterval(_recTimerInterval); _recTimerInterval=null; }
  const te = document.getElementById('msgRecTimer'); if(te) te.textContent='0:00';
  const we = document.getElementById('msgRecWave');  if(we) we.innerHTML='';
}

function _animateRecWave(){
  const wave = document.getElementById('msgRecWave');
  if(!wave || !_mediaRecorder || _mediaRecorder.state==='inactive') return;
  wave.innerHTML = Array.from({length:18}, ()=>
    `<div class="msg-rec-wave-bar" style="height:${4+Math.floor(Math.random()*24)}px;"></div>`
  ).join('');
}

// â”€â”€ Preview bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _showPreviewBar(){
  const pv = document.getElementById('msgVoicePreviewBar');
  const ib = document.getElementById('msgInputBar');
  if(!pv) return;
  pv.style.display = 'flex';
  if(ib) ib.style.display = 'none';

  // Draw static waveform snapshot in preview
  const waveEl = document.getElementById('voicePreviewWaveStatic');
  if(waveEl){
    if(_voiceStaticWave.length){
      waveEl.innerHTML = _voiceStaticWave.map(h=>
        `<div style="flex:1;border-radius:2px;background:#e07b7b;opacity:.5;height:${h};"></div>`
      ).join('');
    } else {
      // Generate placeholder bars if we didn't catch any
      waveEl.innerHTML = Array.from({length:20},()=>
        `<div style="flex:1;border-radius:2px;background:#e07b7b;opacity:.5;height:${4+Math.floor(Math.random()*22)}px;"></div>`
      ).join('');
    }
  }

  // Reset progress and timer
  const bar   = document.getElementById('voicePreviewBar');
  const timer = document.getElementById('voicePreviewTimer');
  if(bar)   bar.style.width='0%';
  if(timer) timer.textContent = fmtDur(_voiceDuration);

  // Reset play button
  const btn = document.getElementById('voicePreviewPlayBtn');
  if(btn) btn.textContent = 'â–¶';

  // Stop any previous preview audio
  _stopPreviewPlayback();
}

function _hidePreviewBar(){
  const pv = document.getElementById('msgVoicePreviewBar');
  if(pv) pv.style.display='none';
  _stopPreviewPlayback();
  // Restore input bar
  if(canSendIn(activeThreadId||'')){
    const ib = document.getElementById('msgInputBar');
    if(ib) ib.style.display='flex';
  }
  _voiceBlob    = null;
  _voiceDataURL = null;
  _voiceDuration= 0;
  _voiceStaticWave = [];
}

function _stopPreviewPlayback(){
  if(_previewAudio){
    _previewAudio.pause();
    _previewAudio = null;
  }
  if(_previewRAF){ cancelAnimationFrame(_previewRAF); _previewRAF=null; }
  const btn = document.getElementById('voicePreviewPlayBtn');
  if(btn) btn.textContent='â–¶';
}

// Play / Pause the preview
function toggleVoicePreview(){
  if(!_voiceDataURL){ toast('No audio to play.'); return; }

  if(_previewAudio && !_previewAudio.paused){
    // Pause
    _previewAudio.pause();
    const btn = document.getElementById('voicePreviewPlayBtn');
    if(btn) btn.textContent='â–¶';
    if(_previewRAF){ cancelAnimationFrame(_previewRAF); _previewRAF=null; }
    return;
  }

  if(!_previewAudio){
    _previewAudio = new Audio(_voiceDataURL);
    _previewAudio.onended = ()=>{
      const btn = document.getElementById('voicePreviewPlayBtn');
      if(btn) btn.textContent='â–¶';
      const bar = document.getElementById('voicePreviewBar');
      if(bar) bar.style.width='100%';
      if(_previewRAF){ cancelAnimationFrame(_previewRAF); _previewRAF=null; }
      _previewAudio = null;
    };
    _previewAudio.onerror = ()=>{ toast('Could not play audio. Try re-recording.'); _stopPreviewPlayback(); };
  }

  _previewAudio.play().then(()=>{
    const btn = document.getElementById('voicePreviewPlayBtn');
    if(btn) btn.textContent='â¸';
    _tickPreviewProgress();
  }).catch(()=>{ toast('Playback failed. Try re-recording.'); });
}

function _tickPreviewProgress(){
  if(!_previewAudio || _previewAudio.paused){ _previewRAF=null; return; }
  const dur  = _previewAudio.duration||_voiceDuration||1;
  const pct  = Math.min((_previewAudio.currentTime/dur)*100, 100);
  const bar  = document.getElementById('voicePreviewBar');
  const timer= document.getElementById('voicePreviewTimer');
  if(bar)   bar.style.width = pct+'%';
  if(timer) timer.textContent = fmtDur(Math.floor(_previewAudio.currentTime));
  _previewRAF = requestAnimationFrame(_tickPreviewProgress);
}

// Seek by clicking the progress bar
function seekVoicePreview(event){
  if(!_previewAudio && !_voiceDataURL) return;
  const el  = document.getElementById('voicePreviewProgress');
  if(!el)   return;
  const pct = event.offsetX / el.offsetWidth;

  if(!_previewAudio){
    _previewAudio = new Audio(_voiceDataURL);
    _previewAudio.onended = ()=>{
      const btn=document.getElementById('voicePreviewPlayBtn');
      if(btn) btn.textContent='â–¶';
      _previewAudio=null;
    };
  }
  _previewAudio.currentTime = pct * (_previewAudio.duration||_voiceDuration||0);
  const bar   = document.getElementById('voicePreviewBar');
  const timer = document.getElementById('voicePreviewTimer');
  if(bar)   bar.style.width = (pct*100)+'%';
  if(timer) timer.textContent = fmtDur(Math.floor(_previewAudio.currentTime));
}

// Re-record: hide preview, restart recording
function cancelVoicePreview(){
  _stopPreviewPlayback();
  _hidePreviewBar();
  // Small delay so UI settles before asking for mic again
  setTimeout(()=>startVoiceRecord(), 120);
}

// Send the previewed voice note
function sendVoicePreview(){
  if(!_voiceDataURL){ toast('No audio recorded.'); return; }
  if(!activeThreadId){ toast('No conversation selected.'); return; }
  if(!canSendIn(activeThreadId)){ toast('You cannot send messages here.'); return; }

  // Stop playback first
  _stopPreviewPlayback();

  // Capture these before hiding (which clears them)
  const dataURL  = _voiceDataURL;
  const duration = _voiceDuration;
  const threadId = activeThreadId;

  _hidePreviewBar();

  pushMsg({
    threadId : threadId,
    msgType  : 'voice',
    fileData : dataURL,
    voiceDuration: duration,
    text     : ''
  });
}

// Legacy alias (kept in case anything calls it)
function stopAndSendVoice(){ stopRecordingForPreview(); }

// â”€â”€â”€ Push message to db â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pushMsg(data){
  if(!db.messages) db.messages=[];
  const senderId = myId();
  const msgId='msg_'+Date.now()+'_'+Math.random().toString(36).slice(2);
  // Store file/voice data separately to avoid bloating main DB
  let fileDataRef = null;
  if(data.fileData){
    const ok = saveMsgFileData(msgId, data.fileData);
    if(!ok){ toast('Storage full \u2014 could not send. Try deleting old messages.'); return; }
    fileDataRef = data.fileData;
  }
  const msg = {
    id:msgId,
    threadId:data.threadId,
    senderId:senderId,
    senderName:currentUser.name||currentUser.username||'User',
    senderRole:currentRole,
    senderAvatar:currentUser.avatar||'',
    msgType:data.msgType||'text',
    text:data.text||'',
    fileData:fileDataRef,
    fileName:data.fileName||null,
    fileSize:data.fileSize||null,
    voiceDuration:data.voiceDuration||null,
    timestamp:Date.now(),
    readBy:[senderId]
  };
  db.messages.push(msg);
  saveDB();
  renderMsgBody(data.threadId);
  renderMsgChannels();
}

// â”€â”€â”€ Mark read â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function markThreadRead(threadId){
  if(!db.messages) return;
  let changed=false;
  db.messages.filter(m=>m.threadId===threadId&&!(m.readBy||[]).includes(myId())).forEach(m=>{
    if(!m.readBy) m.readBy=[];
    m.readBy.push(myId());
    changed=true;
  });
  if(changed) saveDB();
}

// â”€â”€â”€ New chat modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewChat(){
  const myUid=myId(), allU=getAllUsers();

  // â”€â”€ Channels section (teacher / admin only) â”€â”€
  const chanSection=document.getElementById('newChatGroupSection');
  const chanList=document.getElementById('newChatGroupList');
  if(currentRole==='teacher'||currentRole==='admin'){
    chanSection.style.display='block';
    const chans=[];
    (db.classes||[]).forEach(cl=>{
      chans.push({tid:'announce:'+cl.id,  icon:'ðŸ“¢', name:cl.name+' â€” Announcements', sub:'Broadcast to '+cl.full, bg:'rgba(224,123,123,.12)'});
      chans.push({tid:'classgroup:'+cl.id,icon:'ðŸ‘¥', name:cl.name+' â€” Group Chat',    sub:'Class group Â· '+cl.full, bg:'rgba(90,173,160,.12)'});
    });
    chanList.innerHTML=chans.map(g=>
      `<div class="msg-recipient-item" onclick="startChatWith('${g.tid}',true)">
        <div class="msg-recipient-av" style="background:${g.bg};font-size:16px;">${g.icon}</div>
        <div>
          <div style="font-size:13px;font-weight:600;">${g.name}</div>
          <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">${g.sub}</div>
        </div>
      </div>`
    ).join('');
  } else {
    chanSection.style.display='none';
  }

  // â”€â”€ Build full DM target list â”€â”€
  let targets=[];
  if(currentRole==='admin'){
    targets=allU.filter(u=>u.role==='teacher');
  } else if(currentRole==='teacher'){
    targets=allU.filter(u=>u.id!==myUid);
  } else {
    // Students can DM any student (any class) or any lecturer â€” NOT admin
    targets=allU.filter(u=>u.id!==myUid && u.role!=='admin');
  }

  const allTargets=targets.map(u=>({
    id:u.id, name:u.name||u.username||'', role:u.role,
    avatar:u.avatar||'', matric:u.matric||'', classId:u.classId||''
  }));

  // Store full list for filtering
  document.getElementById('newChatDmList').dataset.all=JSON.stringify(allTargets);

  // â”€â”€ Populate class dropdown â”€â”€
  const filterSel=document.getElementById('newChatClassFilter');
  const studentTargets=allTargets.filter(u=>u.role==='student');
  const classIds=[...new Set(studentTargets.map(u=>u.classId).filter(Boolean))];
  // Always show all available classes from db
  const classOptions=(db.classes||[]).map(c=>
    `<option value="${c.id}">${c.name} â€” ${c.full}</option>`
  ).join('');
  filterSel.innerHTML='<option value="">â€” All Classes â€”</option>'+classOptions;
  filterSel.value='';

  // â”€â”€ Reset search and render â”€â”€
  document.getElementById('newChatSearch').value='';
  applyNewChatFilters();
  openModal('newChatModal');
}

// â”€â”€ Apply both class-filter + search together â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyNewChatFilters(){
  const raw=document.getElementById('newChatDmList').dataset.all;
  if(!raw) return;
  let targets=JSON.parse(raw);

  // 1. Class filter
  const classSel=document.getElementById('newChatClassFilter');
  const classFilter=classSel ? classSel.value : '';
  if(classFilter){
    targets=targets.filter(u=> u.role!=='student' || u.classId===classFilter);
  }

  // 2. Text search
  const q=(document.getElementById('newChatSearch').value||'').trim().toLowerCase();
  if(q){
    const classMap=(db.classes||[]).reduce((m,c)=>{
      m[c.id]=(c.name+' '+c.full).toLowerCase(); return m;
    },{});
    targets=targets.filter(u=>
      (u.name||'').toLowerCase().includes(q) ||
      (u.matric||'').toLowerCase().includes(q) ||
      (classMap[u.classId]||'').includes(q)
    );
  }

  // 3. Show result count
  const countEl=document.getElementById('newChatResultCount');
  if(countEl){
    const total=targets.length;
    const classLabel=classFilter ? ((db.classes||[]).find(c=>c.id===classFilter)||{}).name||classFilter : 'all classes';
    countEl.textContent=total===0 ? 'No users found' : `${total} user${total!==1?'s':''} Â· ${classLabel}`;
  }

  renderNewChatDmList(targets);
}

// Keep old name as alias for any legacy calls
function filterNewChatList(q){ applyNewChatFilters(); }

function renderNewChatDmList(targets){
  const list=document.getElementById('newChatDmList');
  if(!list) return;
  if(!targets||!targets.length){
    list.innerHTML=`<div style="text-align:center;padding:24px 20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">No users found.<br>Try a different class or search term.</div>`;
    return;
  }

  const classSel=document.getElementById('newChatClassFilter');
  const filterVal=classSel ? classSel.value : '';

  const admins   =targets.filter(u=>u.role==='admin');
  const lecturers=targets.filter(u=>u.role==='teacher');
  const students =targets.filter(u=>u.role==='student');
  students.sort((a,b)=>(a.classId||'').localeCompare(b.classId||'')||(a.name||'').localeCompare(b.name||''));

  let html='';
  const hdr=(label)=>`<div style="font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);padding:10px 4px 4px;border-top:1px solid var(--border);margin-top:4px;">${label}</div>`;

  if(admins.length)    html+=hdr('ðŸ”‘ Admin')    +admins.map(dmItem).join('');
  if(lecturers.length) html+=hdr('ðŸ« Lecturers')+lecturers.map(dmItem).join('');

  if(students.length){
    // If a specific class is chosen or only 1 class â€” flat list under "Students"
    const classIds=[...new Set(students.map(u=>u.classId).filter(Boolean))];
    if(filterVal || classIds.length<=1){
      const cls=(db.classes||[]).find(c=>c.id===(filterVal||classIds[0]));
      const label=cls ? `ðŸŽ“ ${cls.name} â€” ${cls.full}` : 'ðŸŽ“ Students';
      html+=hdr(label)+students.map(dmItem).join('');
    } else {
      // Multiple classes â€” group by class
      classIds.forEach(cid=>{
        const cls=(db.classes||[]).find(c=>c.id===cid);
        const label=cls ? `ðŸŽ“ ${cls.name} â€” ${cls.full}` : 'ðŸŽ“ '+cid;
        const group=students.filter(u=>u.classId===cid);
        if(group.length) html+=hdr(label)+group.map(dmItem).join('');
      });
      const noClass=students.filter(u=>!u.classId);
      if(noClass.length) html+=hdr('ðŸŽ“ Students (no class)')+noClass.map(dmItem).join('');
    }
  }

  list.innerHTML=html;
}

function dmItem(u){
  const cls=(db.classes||[]).find(c=>c.id===u.classId);
  const clsName=cls?cls.name:u.classId||'';
  const sub=u.role==='teacher'?'Lecturer':u.role==='admin'?'Administrator'
    :`Student${clsName?' Â· '+clsName:''}${u.matric?' Â· '+u.matric:''}`;
  const avBg=u.role==='teacher'?'rgba(62,142,149,.2)':u.role==='admin'?'rgba(251,191,36,.2)':'rgba(90,173,160,.2)';
  const avC=u.avatar
    ?`<img src="${u.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`
    :(u.name||'?')[0].toUpperCase();
  const nm=u.matric
    ?`${escHtml(u.name)} <span style="font-size:10px;opacity:.5;">(${escHtml(u.matric)})</span>`
    :escHtml(u.name||u.id);
  return `<div class="msg-recipient-item" onclick="startChatWith('${u.id}',false)" style="cursor:pointer;">
    <div class="msg-recipient-av" style="background:${avBg}">${avC}</div>
    <div style="flex:1;min-width:0;">
      <div style="font-size:13px;font-weight:600;">${nm}</div>
      <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">${escHtml(sub)}</div>
    </div>
  </div>`;
}

function startChatWith(targetId, isChannel){
  closeModal('newChatModal');
  const tid=isChannel?targetId:dmThreadId(myId(),targetId);
  navGo('messages');
  setTimeout(()=>openThread(tid),100);
}

// â”€â”€â”€ Input helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function msgKeydown(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }
function msgAutoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,100)+'px'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLASSMATES PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _classmatesAll = []; // full list for filtering
let _otherClassId  = null; // selected class in "other class" modal
let _otherClassAll = []; // full list for other class modal

function renderClassmatesPanel(){
  const panel = document.getElementById('msgClassmatesPanel');
  if(!panel) return;

  // Only show for students who belong to a class
  if(currentRole !== 'student' || !currentUser.classId){
    panel.style.display = 'none';
    return;
  }

  const cls = (db.classes||[]).find(c => c.id === currentUser.classId);
  if(!cls){ panel.style.display='none'; return; }

  panel.style.display = 'flex';

  // Set header
  const titleEl = document.getElementById('msgClassmatesTitle');
  const subEl   = document.getElementById('msgClassmatesSub');
  if(titleEl) titleEl.textContent = cls.name;
  if(subEl){
    const count = (db.users||[]).filter(u=>u.role==='student'&&u.classId===cls.id).length;
    subEl.textContent = count + ' classmate' + (count!==1?'s':'');
  }

  // Build classmate list (all students in same class, excluding self)
  _classmatesAll = (db.users||[])
    .filter(u => u.role==='student' && u.classId===currentUser.classId && u.id!==myId())
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  renderClassmatesList(_classmatesAll);
}

function renderClassmatesList(list){
  const container = document.getElementById('msgClassmatesList');
  if(!container) return;

  if(!list.length){
    container.innerHTML = `<div style="text-align:center;padding:20px 10px;color:var(--text3);font-size:11px;font-family:'DM Mono',monospace;">No classmates found</div>`;
    return;
  }

  container.innerHTML = list.map(u => {
    const av = u.avatar
      ? `<img src="${u.avatar}">`
      : (u.name||'?')[0].toUpperCase();
    return `<div class="msg-classmate-item" onclick="startDMWith('${u.id}')">
      <div class="msg-classmate-av">${av}</div>
      <div style="flex:1;min-width:0;">
        <div class="msg-classmate-name">${escHtml(u.name||u.username)}</div>
        ${u.matric?`<div class="msg-classmate-matric">${escHtml(u.matric)}</div>`:''}
      </div>
      <button class="msg-classmate-btn" onclick="event.stopPropagation();startDMWith('${u.id}')">DM</button>
    </div>`;
  }).join('');
}

function filterClassmates(q){
  if(!q){ renderClassmatesList(_classmatesAll); return; }
  const ql = q.toLowerCase();
  const filtered = _classmatesAll.filter(u =>
    (u.name||'').toLowerCase().includes(ql) ||
    (u.matric||'').toLowerCase().includes(ql) ||
    (u.username||'').toLowerCase().includes(ql)
  );
  renderClassmatesList(filtered);
}

// Quick-start DM from classmates panel
function startDMWith(targetId){
  const tid = dmThreadId(myId(), targetId);
  openThread(tid);
  // On mobile, hide classmates panel
  if(window.innerWidth <= 1000){
    const panel = document.getElementById('msgClassmatesPanel');
    if(panel) panel.style.display='none';
  }
}

// â”€â”€â”€ Other Class Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openOtherClassPanel(){
  _otherClassId = null;
  _otherClassAll = [];

  // Build class tabs (all classes except own)
  const myClassId = currentUser.classId||'';
  const classes = (db.classes||[]);

  const tabsEl = document.getElementById('otherClassTabs');
  if(tabsEl){
    tabsEl.innerHTML = classes.map(c => {
      const studentCount = (db.users||[]).filter(u=>u.role==='student'&&u.classId===c.id).length;
      const isOwn = c.id === myClassId;
      return `<button
        id="otherClassTab_${c.id}"
        onclick="selectOtherClass('${c.id}')"
        style="padding:7px 14px;border-radius:8px;border:1.5px solid ${isOwn?'var(--border)':'var(--border-hover)'};
               background:${isOwn?'var(--bg3)':'var(--bg3)'};color:${isOwn?'var(--text3)':'var(--text)'};
               font-size:12px;font-family:'Instrument Sans',sans-serif;cursor:${isOwn?'default':'pointer'};
               font-weight:600;transition:all .2s;opacity:${isOwn?'.4':'1'};"
        ${isOwn?'disabled title="Your own class"':''}>
        ${escHtml(c.name)}
        <span style="font-size:10px;font-weight:400;opacity:.6;margin-left:3px;">(${studentCount})</span>
      </button>`;
    }).join('');
  }

  // Clear list
  const listEl = document.getElementById('otherClassStudentList');
  const countEl = document.getElementById('otherClassResultCount');
  const searchEl = document.getElementById('otherClassSearch');
  if(listEl) listEl.innerHTML = `<div style="text-align:center;padding:24px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">ðŸ‘† Select a class above to see students</div>`;
  if(countEl) countEl.textContent = '';
  if(searchEl) searchEl.value = '';

  openModal('otherClassModal');
}

function selectOtherClass(classId){
  _otherClassId = classId;
  const cls = (db.classes||[]).find(c=>c.id===classId);

  // Update tab styles
  (db.classes||[]).forEach(c=>{
    const tab = document.getElementById('otherClassTab_'+c.id);
    if(!tab) return;
    if(c.id===classId){
      tab.style.borderColor='var(--accent)';
      tab.style.background='rgba(62,142,149,.1)';
      tab.style.color='var(--accent)';
    } else if(c.id===currentUser.classId){
      tab.style.borderColor='var(--border)';
      tab.style.background='var(--bg3)';
      tab.style.color='var(--text3)';
    } else {
      tab.style.borderColor='var(--border-hover)';
      tab.style.background='var(--bg3)';
      tab.style.color='var(--text)';
    }
  });

  // Load students from this class
  _otherClassAll = (db.users||[])
    .filter(u=>u.role==='student'&&u.classId===classId)
    .sort((a,b)=>(a.name||'').localeCompare(b.name||''));

  const searchEl = document.getElementById('otherClassSearch');
  if(searchEl) searchEl.value='';
  renderOtherClassList(_otherClassAll);
}

function filterOtherClassList(q){
  if(!_otherClassId){ return; }
  if(!q){ renderOtherClassList(_otherClassAll); return; }
  const ql=q.toLowerCase();
  renderOtherClassList(_otherClassAll.filter(u=>
    (u.name||'').toLowerCase().includes(ql)||(u.matric||'').toLowerCase().includes(ql)
  ));
}

function renderOtherClassList(list){
  const listEl  = document.getElementById('otherClassStudentList');
  const countEl = document.getElementById('otherClassResultCount');
  if(!listEl) return;

  const cls = (db.classes||[]).find(c=>c.id===_otherClassId);
  if(countEl){
    countEl.textContent = list.length===0
      ? 'No students found'
      : `${list.length} student${list.length!==1?'s':''} Â· ${cls?cls.name:_otherClassId}`;
  }

  if(!list.length){
    listEl.innerHTML=`<div style="text-align:center;padding:24px 20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;">No students found in this class.</div>`;
    return;
  }

  listEl.innerHTML = list.map(u=>{
    const av = u.avatar
      ? `<img src="${u.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`
      : (u.name||'?')[0].toUpperCase();
    return `<div class="msg-recipient-item" onclick="startDMFromOtherClass('${u.id}')" style="cursor:pointer;">
      <div class="msg-recipient-av" style="background:rgba(90,173,160,.2)">${av}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:13px;font-weight:600;">${escHtml(u.name||u.username)}</div>
        <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;">
          ${u.matric?escHtml(u.matric)+' Â· ':''}${cls?escHtml(cls.name):''}
        </div>
      </div>
      <button style="flex-shrink:0;padding:5px 10px;background:var(--accent);border:none;border-radius:7px;color:#fff;font-size:11px;font-weight:600;cursor:pointer;font-family:'DM Mono',monospace;"
        onclick="event.stopPropagation();startDMFromOtherClass('${u.id}')">DM</button>
    </div>`;
  }).join('');
}

function startDMFromOtherClass(targetId){
  closeModal('otherClassModal');
  navGo('messages');
  setTimeout(()=>openThread(dmThreadId(myId(),targetId)),100);
}

// â”€â”€â”€ Poll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _reloadDbFromStorage(){
  try{
    const raw = localStorage.getItem('nv_db');
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(!parsed) return;
    // If version is old, trigger a full reload to get the migrated DB
    if(!parsed._version || parsed._version < 9) return;
    // Always patch missing arrays before assigning
    if(!parsed.messages) parsed.messages = [];
    if(!parsed.users) parsed.users = [];
    if(!parsed.classes) parsed.classes = [];
    if(!parsed.courses) parsed.courses = [];
    if(!parsed.results) parsed.results = [];
    if(!parsed.handouts) parsed.handouts = [];
    if(!parsed.pastQuestions) parsed.pastQuestions = [];
    if(!parsed.dmThreads) parsed.dmThreads = [];
    if(!parsed.activityLogs) parsed.activityLogs = [];
    if(!parsed.lecturerFolders) parsed.lecturerFolders = [];
    // Restore fileData for messages that had files (stored separately)
    parsed.messages.forEach(m=>{
      if(!m.fileData && (m.msgType==='file'||m.msgType==='image'||m.msgType==='voice')){
        const fd = loadMsgFileData(m.id);
        if(fd) m.fileData = fd;
      }
    });
    // Assign unconditionally â€” always reflect the latest stored state
    db = parsed;
  } catch(e){}
}

function startMsgPoll(){
  stopMsgPoll();
  msgPollInterval=setInterval(()=>{
    if(document.getElementById('viewMessages').style.display==='none') return;
    _reloadDbFromStorage();
    renderMsgChannels(document.getElementById('msgSearchInp')?document.getElementById('msgSearchInp').value:'');
    if(activeThreadId) renderMsgBody(activeThreadId);
    // Refresh classmates count in header (in case new students register)
    const subEl=document.getElementById('msgClassmatesSub');
    if(subEl&&currentUser.classId){
      const count=(db.users||[]).filter(u=>u.role==='student'&&u.classId===currentUser.classId&&u.id!==myId()).length;
      subEl.textContent=count+' classmate'+(count!==1?'s':'');
    }
  },1000);
}
function stopMsgPoll(){ if(msgPollInterval){clearInterval(msgPollInterval);msgPollInterval=null;} }

// ============================================================
// REMOVE ALL STUDENTS (admin only)
// ============================================================
function removeAllStudents(){
  const count = (db.users||[]).filter(u=>u.role==='student').length;
  if(count === 0){ toast('No student accounts to remove'); return; }
  if(!confirm('Remove all ' + count + ' student account' + (count!==1?'s':'') + '? This cannot be undone.')) return;
  db.users = (db.users||[]).filter(u=>u.role!=='student');
  saveDB();
  renderUsers();
  toast('\u2713 ' + count + ' student account' + (count!==1?'s':'')+' removed');
}

function resetAllStudentPasswords(){
  const students = (db.users||[]).filter(u=>u.role==='student');
  if(students.length === 0){ toast('No student accounts found'); return; }
  if(!confirm('Reset passwords for all ' + students.length + ' students to their surname + 123?')) return;
  let count = 0;
  students.forEach(function(u){
    // Derive surname: use stored surname field, or first word of name
    let surname = u.surname || (u.name ? u.name.trim().split(/\s+/)[0] : '');
    surname = surname.toLowerCase().replace(/[^a-z0-9]/g,'');
    if(!surname) surname = 'student';
    u.password = surname + '123';
    count++;
  });
  saveDB();
  renderUsers();
  toast('\u2713 Passwords reset for ' + count + ' students (surname + 123)');
}

// ============================================================
// NOMINAL ROLL IMPORT (admin only) â€” Smart Auto-Parse Engine
// ============================================================

let _nominalParsedRows = [];
let _nominalColMap = {};   // field â†’ column index
let _nominalRawHeaders = []; // original header strings

function openNominalRollImport(){
  const sel = document.getElementById('nominalClassSelect');
  sel.innerHTML = '<option value="">â€” Override Class (optional) â€”</option>' +
    (db.classes||[]).map(c=>`<option value="${c.id}">${c.name}${c.full?' â€” '+c.full:''}</option>`).join('');
  nominalReset();
  openModal('nominalRollModal');
}

function nominalReset(){
  document.getElementById('nominalPreview').style.display='none';
  document.getElementById('nominalMappingInfo').style.display='none';
  document.getElementById('nominalImportResult').style.display='none';
  document.getElementById('nominalFileInp').value='';
  _nominalParsedRows=[];
  _nominalColMap={};
  _nominalRawHeaders=[];
  // Reset drop zone
  const dz=document.getElementById('nominalDropZone');
  dz.style.display='';
  dz.style.borderColor='var(--border)';
  dz.style.background='var(--bg2)';
}

function nominalHandleDrop(e){
  e.preventDefault();
  const dz=document.getElementById('nominalDropZone');
  dz.style.borderColor='var(--border)';
  dz.style.background='var(--bg2)';
  const file=e.dataTransfer.files[0];
  if(file) nominalHandleFile(file);
}

function nominalHandleFile(file){
  if(!file) return;
  const ext=file.name.split('.').pop().toLowerCase();
  if(!['xlsx','xls','csv','doc','docx'].includes(ext)){toast('Please upload an .xlsx, .xls, .csv, .doc, or .docx file');return;}

  // Show loading state
  const dz=document.getElementById('nominalDropZone');
  const dzOrig=dz.innerHTML;
  dz.innerHTML='<div style="font-size:30px;margin-bottom:8px;">&#9203;</div><div style="font-size:13px;color:var(--text2);">Reading spreadsheet\u2026</div>';

  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      let rows=[];
      if(ext==='csv'){
        rows=nominalParseCSV(ev.target.result);
        dz.innerHTML=dzOrig;
        if(!rows||rows.length<2){toast('Spreadsheet appears empty or unreadable');return;}
        nominalAutoDetect(rows);
      } else if(ext==='doc'||ext==='docx'){
        mammoth.extractRawText({arrayBuffer:ev.target.result}).then(function(result){
          dz.innerHTML=dzOrig;
          const lines=result.value.split(/\r?\n/).filter(l=>l.trim()!=='');
          if(!lines||lines.length<2){toast('Word document appears empty or has no tabular data');return;}
          const delim=lines[0].includes('\t')?'\t':',';
          rows=lines.map(l=>l.split(delim).map(c=>c.trim()));
          if(!rows||rows.length<2){toast('Could not find tabular data in the Word document');return;}
          nominalAutoDetect(rows);
        }).catch(function(err){
          dz.innerHTML=dzOrig;
          toast('Could not read Word file: '+err.message);
        });
        return;
      } else {
        const wb=XLSX.read(ev.target.result,{type:'array',cellDates:true,dateNF:'yyyy-mm-dd'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:false,dateNF:'yyyy-mm-dd'});
        dz.innerHTML=dzOrig;
        if(!rows||rows.length<2){toast('Spreadsheet appears empty or unreadable');return;}
        nominalAutoDetect(rows);
      }
    }catch(err){
      dz.innerHTML=dzOrig;
      toast('Could not read file: '+err.message);
    }
  };
  if(ext==='csv') reader.readAsText(file);
  else reader.readAsArrayBuffer(file);
}

function nominalParseCSV(text){
  return text.split(/\r?\n/).map(row=>{
    const cells=[]; let cur='', inQ=false;
    for(let i=0;i<row.length;i++){
      const ch=row[i];
      if(ch==='"'){ inQ=!inQ; }
      else if(ch===','&&!inQ){ cells.push(cur.trim()); cur=''; }
      else cur+=ch;
    }
    cells.push(cur.trim());
    return cells;
  }).filter(r=>r.some(c=>String(c).trim()!==''));
}

// Normalize a header string for matching
function nominalNorm(h){
  return String(h).toLowerCase()
    .replace(/[^a-z0-9]/g,'')
    .replace(/\s+/g,'');
}

// Smart header row detection â€” finds the row most likely to be the header
function nominalFindHeaderRow(rows){
  // Score each of the first 10 rows: more text-like cells = more likely header
  let bestRow=0, bestScore=-1;
  const limit=Math.min(10,rows.length);
  for(let i=0;i<limit;i++){
    const r=rows[i];
    let score=0;
    r.forEach(c=>{
      const v=String(c).trim();
      if(!v) return;
      // Headers are usually short text (not numbers, not long sentences)
      if(v.length>0 && v.length<40 && isNaN(v)) score+=2;
      if(/name|matric|matricno|matric\s*no|phone|class|sex|gender|dob|date|birth|reg|no\b|number|rrr|index|level|dept|programme|set|batch|rank|svc|bia|state|address/i.test(v)) score+=5;
    });
    if(score>bestScore){ bestScore=score; bestRow=i; }
  }
  return bestRow;
}

// Map a normalized header to a known field
function nominalMapHeader(norm){
  const maps={
    surname:      ['surname','lastname','familyname','last','lname'],
    firstName:    ['firstname','fname','givenname','forename','first'],
    otherName:    ['othername','othernames','middlename','middle','initials'],
    name:         ['name','fullname','studentname','studentnames','student','candidatename','sn','s/n'],
    matric:       ['matric','matricno','matricnumber','matriculationno','registrationnumber','regnum','regno','admno','admissionnumber','admissionno','matno','matnumber','matriculationno','matric123','matriculation'],
    cls:          ['class','classname','level','programme','dept','department','set','batch','intake','course','group'],
    phone:        ['phone','phoneno','phonenumber','mobile','mobileno','tel','telephone','contact','gsm'],
    dob:          ['dob','dateofbirth','birthdate','datebirth','birth'],
    sex:          ['sex','gender','m/f'],
    rrr:          ['rrr','remitanumber','remita','remitatransaction','rrrno'],
    bia:          ['bia','bianumber','biaid','accreditation'],
    rnIndex:      ['rnindex','rnindexno','rnindexnumber','regnurse'],
    rmIndex:      ['rmindex','rmindexno','rmindexnumber','regmidwife'],
    rnExam:       ['rnexam','rnexamno','rnexamnumber','nurseexam'],
    rmExam:       ['rmexam','rmexamno','rmexamnumber','midwifeexam'],
    state:        ['state','stateoforigin','origin','lga','localgovt'],
    address:      ['address','homeaddress','residentialaddress'],
    rank:         ['rank','militaryrank','armyrank'],
    svc:          ['svc','servicenumber','armynumber','servicenum'],
    email:        ['email','emailaddress','mail'],
  };
  for(const [field,aliases] of Object.entries(maps)){
    if(aliases.includes(norm)) return field;
    // Partial match â€” norm contains alias or alias contains norm
    for(const a of aliases){
      if(norm.includes(a)||a.includes(norm)) return field;
    }
  }
  return null;
}

// Heuristic: detect if a column looks like names (based on first few data rows)
function nominalColLooksLikeName(rows, headerRow, colIdx){
  let nameCount=0;
  for(let i=headerRow+1;i<Math.min(headerRow+8,rows.length);i++){
    const v=String(rows[i][colIdx]||'').trim();
    if(!v) continue;
    // Multi-word name (e.g. "John Doe") or single-word surname (3+ alpha chars)
    if(v.length>=3 && v.length<=50 && /^[a-zA-Z\s\-'\.]+$/.test(v)) nameCount++;
  }
  return nameCount>=2;
}

function nominalAutoDetect(rows){
  const headerRow=nominalFindHeaderRow(rows);
  _nominalRawHeaders=rows[headerRow];
  const normHeaders=_nominalRawHeaders.map(nominalNorm);

  // Build column map
  _nominalColMap={};
  normHeaders.forEach((norm,idx)=>{
    if(!norm) return;
    const field=nominalMapHeader(norm);
    if(field && !(_nominalColMap[field]>=0)){
      _nominalColMap[field]=idx;
    }
  });

  // If no name/surname column found, try heuristic on all unmapped text columns
  const hasNameCol = (_nominalColMap.name>=0) || (_nominalColMap.surname>=0);
  if(!hasNameCol){
    for(let i=0;i<normHeaders.length;i++){
      if(nominalColLooksLikeName(rows,headerRow,i)){
        _nominalColMap.name=i; break;
      }
    }
  }

  // If matric still not detected, try raw header string match for "MATRIC NO" variants
  if(!(_nominalColMap.matric>=0)){
    for(let i=0;i<_nominalRawHeaders.length;i++){
      const raw=String(_nominalRawHeaders[i]).toLowerCase().trim();
      if(/matric|mat\.?\s*no|mat\s*no|matr/i.test(raw)){
        _nominalColMap.matric=i; break;
      }
    }
  }

  const dataRows=rows.slice(headerRow+1).filter(r=>r.some(c=>String(c).trim()!==''));

  const hasAnyNameCol = (_nominalColMap.name>=0) || (_nominalColMap.surname>=0);
  if(!hasAnyNameCol){
    toast('Could not detect a Name or Surname column. Make sure the spreadsheet has a header row.');
    return;
  }

  // Show detected columns as tags
  const tagContainer=document.getElementById('nominalMappingTags');
  const fieldLabels={
    surname:'Surname', firstName:'First Name', otherName:'Other Name',
    name:'Full Name', matric:'Matric', cls:'Class', phone:'Phone', dob:'DOB',
    sex:'Sex', rrr:'RRR', bia:'BIA', rnIndex:'RN Index', rmIndex:'RM Index',
    rnExam:'RN Exam', rmExam:'RM Exam', state:'State', address:'Address',
    rank:'Rank', svc:'SVC', email:'Email'};
  const colors={
    surname:'var(--accent)', firstName:'var(--accent)', otherName:'var(--accent)',
    name:'var(--accent)', matric:'var(--accent2)', cls:'var(--accent3)',
    phone:'#fb923c', dob:'#a78bfa', sex:'#f472b6', rrr:'#5aada0', bia:'#60a5fa',
    rnIndex:'#fbbf24', rmIndex:'#f87171', rnExam:'#c084fc', rmExam:'#4ade80',
    state:'#3E8E95', address:'#e879f9', rank:'#facc15', svc:'#86efac', email:'#67e8f9'};

  tagContainer.innerHTML=Object.entries(_nominalColMap).map(([field,idx])=>{
    const header=_nominalRawHeaders[idx]||field;
    const col=colors[field]||'var(--text2)';
    const spanStyle='display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:10px;font-family:monospace;background:'+col+'1a;border:1px solid '+col+'55;color:'+col+';';
    return '<span style="'+spanStyle+'"><b>'+(fieldLabels[field]||field)+'</b> <span style="opacity:.6;">\u2190 &quot;'+escHtml(String(header))+'&quot;</span></span>';
  }).join('');
  document.getElementById('nominalMappingInfo').style.display='';

  nominalBuildPreview(dataRows);
}

function nominalGetCell(row, field){
  const idx=_nominalColMap[field];
  if(idx===undefined||idx<0) return '';
  return String(row[idx]||'').trim();
}

function nominalBuildPreview(dataRows){
  const usedUsernames={};
  // Check if spreadsheet has separate surname / firstname columns
  const hasSurnameCol  = _nominalColMap.surname  >= 0;
  const hasFirstNameCol= _nominalColMap.firstName >= 0;
  const hasOtherNameCol= _nominalColMap.otherName >= 0;

  _nominalParsedRows=dataRows.map(row=>{
    let surname='', firstName='', otherName='', fullName='';

    if(hasSurnameCol){
      // Separate columns â€” compose full name as "Surname Firstname Othername"
      surname    = nominalGetCell(row,'surname').trim();
      firstName  = hasFirstNameCol ? nominalGetCell(row,'firstName').trim() : '';
      otherName  = hasOtherNameCol ? nominalGetCell(row,'otherName').trim() : '';
      fullName   = [surname, firstName, otherName].filter(Boolean).join(' ');
    } else {
      // Single name column â€” parse it
      const raw = nominalGetCell(row,'name').trim();
      if(!raw) return null;
      fullName = raw;
      // Handle "SURNAME, Firstname Othername" format
      if(raw.includes(',')){
        const parts = raw.split(',');
        surname   = parts[0].trim();
        const rest= parts[1].trim().split(/\s+/);
        firstName = rest[0]||'';
        otherName = rest.slice(1).join(' ');
      } else {
        // "Surname Firstname Othername" â€” first word is surname
        const parts = raw.split(/\s+/);
        surname   = parts[0]||'';
        firstName = parts[1]||'';
        otherName = parts.slice(2).join(' ');
      }
    }

    if(!fullName && !surname) return null;

    // Derive clean surname for username/password
    const surnameClean = surname.toLowerCase().replace(/[^a-z0-9]/g,'') || 'student';

    // Assign unique username: surname + 123 (e.g. smith123)
    let uname = surnameClean + '123';
    if(usedUsernames[uname]){
      usedUsernames[uname]++;
      uname = surnameClean + usedUsernames[uname] + '123';
    } else {
      usedUsernames[uname] = 1;
    }
    // Avoid clash with existing db users
    let finalUname = uname, counter = 2;
    while(db.users.find(u=>(u.username||'').toLowerCase()===finalUname)){
      finalUname = surnameClean+counter+'123'; counter++;
    }

    return {
      name:        fullName || surname,
      surname:     surname,
      firstName:   firstName,
      otherName:   otherName,
      username:    finalUname,
      password:    finalUname+'123',
      matric:      nominalGetCell(row,'matric').toUpperCase(),
      cls:         nominalGetCell(row,'cls'),
      phone:       nominalGetCell(row,'phone'),
      dob:         nominalGetCell(row,'dob'),
      sex:         nominalGetCell(row,'sex'),
      rrr:         nominalGetCell(row,'rrr'),
      bia:         nominalGetCell(row,'bia').toUpperCase(),
      rnIndex:     nominalGetCell(row,'rnIndex'),
      rmIndex:     nominalGetCell(row,'rmIndex'),
      rnExam:      nominalGetCell(row,'rnExam'),
      rmExam:      nominalGetCell(row,'rmExam'),
      state:       nominalGetCell(row,'state'),
      address:     nominalGetCell(row,'address'),
      rank:        nominalGetCell(row,'rank').toUpperCase(),
      svc:         nominalGetCell(row,'svc').toUpperCase(),
      email:       nominalGetCell(row,'email'),
      _surname:    surnameClean,
    };
  }).filter(Boolean);

  // Build dynamic preview columns
  const detectedFields = Object.keys(_nominalColMap);
  // Always show name breakdown columns if detected separately
  let nameFields = [];
  if(hasSurnameCol)  nameFields.push('surname');
  if(hasFirstNameCol)nameFields.push('firstName');
  if(hasOtherNameCol)nameFields.push('otherName');
  if(!hasSurnameCol) nameFields.push('name'); // fallback to combined name

  const extraFields = detectedFields.filter(f=>!['name','surname','firstName','otherName'].includes(f));
  const previewFields = [...nameFields,'username','password',...extraFields];

  const fieldLabels={
    name:'Full Name', surname:'Surname', firstName:'First Name', otherName:'Other Name',
    username:'Username', password:'Password', matric:'Matric',
    cls:'Class', phone:'Phone', dob:'DOB', sex:'Sex', rrr:'RRR', bia:'BIA',
    rnIndex:'RN Index', rmIndex:'RM Index', rnExam:'RN Exam', rmExam:'RM Exam',
    state:'State', address:'Address', rank:'Rank', svc:'SVC', email:'Email'};

  const thead=document.getElementById('nominalPreviewHead');
  const tbody=document.getElementById('nominalPreviewBody');

  thead.innerHTML='<tr>'+previewFields.map(f=>'<th style="padding:8px 12px;text-align:left;font-size:10px;font-family:monospace;color:var(--text3);white-space:nowrap;border-bottom:1px solid var(--border);text-transform:uppercase;letter-spacing:.05em;">'+( fieldLabels[f]||f)+'</th>').join('')+'</tr>';

  const monoFont='monospace';
  const accentField={username:'var(--accent2)',password:'var(--accent)',surname:'var(--accent)',firstName:'var(--accent)',otherName:'var(--accent)',name:''};

  tbody.innerHTML=_nominalParsedRows.slice(0,100).map(r=>`<tr style="border-bottom:1px solid var(--border);">
    ${previewFields.map(f=>{
      const val=r[f]||'';
      const col=accentField[f]?'color:'+accentField[f]+';font-family:'+monoFont+';':'color:var(--text2);';
      return `<td style="padding:6px 12px;font-size:12px;white-space:nowrap;${col}">${escHtml(String(val))}</td>`;
    }).join('')}
  </tr>`).join('');

  document.getElementById('nominalPreviewTitle').textContent=
    `${_nominalParsedRows.length} student${_nominalParsedRows.length!==1?'s':''} detected`+
    (_nominalParsedRows.length>100?' (showing first 100)':'');
  document.getElementById('nominalImportResult').style.display='none';
  document.getElementById('nominalPreview').style.display='';
}


function nominalImportConfirm(){
  if(!_nominalParsedRows.length){toast('No data to import');return;}
  const classId=document.getElementById('nominalClassSelect').value;
  const cls=classId?db.classes.find(c=>c.id===classId):null;
  let added=0, updated=0;

  _nominalParsedRows.forEach(r=>{
    let assignedClassId=classId||'';
    let assignedCls=cls?cls.name:'';
    if(!assignedClassId && r.cls){
      const match=db.classes.find(c=>
        c.name.toLowerCase()===r.cls.toLowerCase()||
        (c.full&&c.full.toLowerCase()===r.cls.toLowerCase())||
        r.cls.toLowerCase().includes(c.name.toLowerCase())
      );
      if(match){assignedClassId=match.id;assignedCls=match.name;}
    }

    const existing=db.users.find(u=>
      (r.matric&&u.matric&&u.matric===r.matric)||
      (u.username&&u.username.toLowerCase()===r.username.toLowerCase())
    );

    if(existing){
      const defaultPass=r._surname?r._surname.toUpperCase()+'123':r.username.toUpperCase()+'123';
      const keepPass=existing.password&&existing.password!==defaultPass&&existing.password!=='student123';
      existing.name=r.name;
      if(r.surname)   existing.surname=r.surname;
      if(r.firstName) existing.firstName=r.firstName;
      if(r.otherName) existing.otherName=r.otherName;
      if(r.matric)    existing.matric=r.matric;
      if(r.phone)     existing.phone=r.phone;
      if(r.dob)       existing.dob=r.dob;
      if(r.sex)       existing.sex=r.sex;
      if(r.rrr)       existing.rrr=r.rrr;
      if(r.bia)       existing.bia=r.bia;
      if(r.rnIndex)   existing.rnIndex=r.rnIndex;
      if(r.rmIndex)   existing.rmIndex=r.rmIndex;
      if(r.rnExam)    existing.rnExam=r.rnExam;
      if(r.rmExam)    existing.rmExam=r.rmExam;
      if(r.state)     existing.state=r.state;
      if(r.address)   existing.address=r.address;
      if(r.rank)      existing.rank=r.rank;
      if(r.svc)       existing.svc=r.svc;
      if(r.email)     existing.email=r.email;
      if(assignedClassId){existing.classId=assignedClassId;existing.cls=assignedCls;}
      if(!keepPass)   existing.password=r.password;
      updated++;
    } else {
      db.users.push({
        id:        'u_nr_'+Date.now()+'_'+Math.random().toString(36).slice(2,7),
        name:      r.name,
        surname:   r.surname||'',
        firstName: r.firstName||'',
        otherName: r.otherName||'',
        username:  r.username,
        password:  r.password,
        role:      'student',
        classId:   assignedClassId||'',
        cls:       assignedCls||r.cls||'',
        matric:    r.matric||'',
        phone:     r.phone||'',
        avatar:    '',
        dob:       r.dob||'',
        sex:       r.sex||'',
        rrr:       r.rrr||'',
        bia:       r.bia||'',
        rnIndex:   r.rnIndex||'',
        rmIndex:   r.rmIndex||'',
        rnExam:    r.rnExam||'',
        rmExam:    r.rmExam||'',
        state:     r.state||'',
        address:   r.address||'',
        rank:      r.rank||'',
        svc:       r.svc||'',
        email:     r.email||'',
        documents: [],
      });
      added++;
    }
  });

  saveDB();
  renderUsers();

  // Store IDs of all just-imported/updated users for the save button
  window._nominalLastImportedIds = _nominalParsedRows.map(r=>r.username);

  const detectedCount=Object.keys(_nominalColMap).length;
  const res=document.getElementById('nominalImportResult');
  res.style.display='';
  res.style.background=added||updated?'rgba(90,173,160,.1)':'rgba(251,191,36,.1)';
  res.style.border='1px solid '+(added||updated?'var(--accent3)':'#fbbf24');
  res.style.borderRadius='10px';
  res.style.padding='14px';
  res.innerHTML='<div style="font-weight:700;font-size:14px;color:'+(added||updated?'var(--accent3)':'#fbbf24')+';margin-bottom:6px;">'
    +(added||updated?'\u2705 Import Complete':'\u2139\ufe0f No Changes')+'</div>'
    +'<div style="font-size:12px;color:var(--text2);font-family:monospace;line-height:1.9;">'
    +'<div>\ud83c\udd95 New accounts created: <b>'+added+'</b></div>'
    +'<div>\ud83d\udd04 Existing accounts updated: <b>'+updated+'</b></div>'
    +'<div style="margin-top:8px;font-size:11px;color:var(--text3);">'+detectedCount+' fields auto-detected. Login: username = surname123, password = surname123123.</div>'
    +'</div>'
    +(added||updated
      ? '<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">'
        +'<button class="btn-submit" onclick="nominalSaveImported()" style="background:linear-gradient(135deg,#3E8E95,#BFD2C5);flex:1;min-width:160px;font-size:13px;">ðŸ’¾ Save Profile List</button>'
        +'<button class="btn-ghost" onclick="nominalReset()" style="flex:1;min-width:120px;font-size:13px;">ðŸ“‚ Import Another</button>'
        +'</div>'
      : '');
  _nominalParsedRows=[];
  document.getElementById('nominalPreview').style.display='none';
  document.getElementById('nominalMappingInfo').style.display='none';
  toast('\u2713 '+added+' created, '+updated+' updated');
}

function nominalSaveImported(){
  // â”€â”€ Step 1: Force-save the entire DB to localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let appSaveOk = false;
  try {
    saveDB();
    // Verify the save actually worked by reading back and checking user count
    const raw = localStorage.getItem('nv_db');
    if(raw){
      const parsed = JSON.parse(raw);
      if(parsed.users && parsed.users.length === db.users.length) appSaveOk = true;
    }
  } catch(e){ appSaveOk = false; }

  // â”€â”€ Step 2: Write a dedicated user-backup key as extra insurance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  try {
    const userBackup = db.users.map(u=>({
      id:u.id,name:u.name,surname:u.surname||'',firstName:u.firstName||'',
      otherName:u.otherName||'',username:u.username,password:u.password,
      role:u.role,classId:u.classId||'',cls:u.cls||'',matric:u.matric||'',
      phone:u.phone||'',dob:u.dob||'',sex:u.sex||'',rrr:u.rrr||'',
      bia:u.bia||'',rnIndex:u.rnIndex||'',rmIndex:u.rmIndex||'',
      rnExam:u.rnExam||'',rmExam:u.rmExam||'',state:u.state||'',
      address:u.address||'',rank:u.rank||'',svc:u.svc||'',email:u.email||'',
      documents:u.documents||[],avatar:u.avatar||''
    }));
    localStorage.setItem('nv_users_backup', JSON.stringify(userBackup));
  } catch(e){ /* backup failed â€” main save may still be fine */ }

  // â”€â”€ Step 3: Show result feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const usernames = window._nominalLastImportedIds || [];
  const importedCount = db.users.filter(u=>u.role==='student' && usernames.includes(u.username)).length;
  const totalStudents = db.users.filter(u=>u.role==='student').length;

  const res = document.getElementById('nominalImportResult');
  if(appSaveOk){
    res.innerHTML = res.innerHTML.replace(
      /<button[^>]*onclick="nominalSaveImported\(\)"[^>]*>.*?<\/button>/,
      '<button class="btn-submit" disabled style="background:linear-gradient(135deg,#5aada0,#3E8E95);flex:1;min-width:160px;font-size:13px;opacity:.85;">âœ… Saved to App</button>'
    );
    toast('âœ… All '+totalStudents+' student profiles saved â€” they will persist after logout');

    // Show a confirmation banner inside the result box
    const banner = document.createElement('div');
    banner.style.cssText='margin-top:10px;padding:10px 12px;background:rgba(90,173,160,.12);border:1px solid var(--accent3);border-radius:8px;font-size:12px;color:var(--accent3);font-family:monospace;';
    banner.innerHTML='ðŸ”’ <b>'+totalStudents+' student profiles are now saved in the app.</b><br>'
      +'<span style="color:var(--text2);">Profiles will remain intact after logout, refresh, or closing the browser tab.</span>';
    res.appendChild(banner);

    // Also offer an Excel download as a portable backup
    const dlBtn = document.createElement('button');
    dlBtn.className='btn-ghost';
    dlBtn.style.cssText='margin-top:8px;width:100%;font-size:12px;';
    dlBtn.textContent='â¬‡ï¸ Also download as Excel backup';
    dlBtn.onclick = nominalExportExcel;
    res.appendChild(dlBtn);

  } else {
    // App save failed (likely storage quota) â€” auto-fallback to Excel download
    toast('âš ï¸ Browser storage full â€” downloading Excel backup instead');
    nominalExportExcel();

    const banner = document.createElement('div');
    banner.style.cssText='margin-top:10px;padding:10px 12px;background:rgba(224,123,123,.12);border:1px solid var(--accent4);border-radius:8px;font-size:12px;color:var(--accent4);font-family:monospace;';
    banner.innerHTML='âš ï¸ <b>Storage limit reached.</b><br>'
      +'<span style="color:var(--text2);">Profiles were imported this session but could not be saved in the browser. '
      +'An Excel file has been downloaded as a backup â€” re-import it next time to restore profiles.</span>';
    res.appendChild(banner);
  }
}

// â”€â”€ Export imported students to Excel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nominalExportExcel(){
  const usernames = window._nominalLastImportedIds || [];
  const students = db.users.filter(u=>u.role==='student'&&(usernames.length?usernames.includes(u.username):true));
  if(!students.length){ toast('No student profiles to export'); return; }

  const header = ['Surname','First Name','Other Name','Full Name','Username','Password','Matric No.','Class','Phone','DOB','Sex','RRR','BIA','RN Index','RM Index','RN Exam','RM Exam','State','Address','Rank','Service','Email'];
  const rows = students.map(u=>[
    u.surname||'',u.firstName||'',u.otherName||'',u.name||'',
    u.username||'',u.password||'',u.matric||'',u.cls||'',
    u.phone||'',u.dob||'',u.sex||'',u.rrr||'',u.bia||'',
    u.rnIndex||'',u.rmIndex||'',u.rnExam||'',u.rmExam||'',
    u.state||'',u.address||'',u.rank||'',u.svc||'',u.email||''
  ]);

  try {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([header,...rows]);
    ws['!cols'] = header.map((_,i)=>{
      const max=Math.max(header[i].length,...rows.map(r=>String(r[i]||'').length));
      return {wch:Math.min(Math.max(max+2,10),40)};
    });
    XLSX.utils.book_append_sheet(wb,ws,'Imported Students');
    const now=new Date();
    const stamp=now.getFullYear()+''+(now.getMonth()+1).toString().padStart(2,'0')+now.getDate().toString().padStart(2,'0');
    XLSX.writeFile(wb,'nominal_roll_'+stamp+'.xlsx');
    toast('ðŸ“¥ Excel backup downloaded');
  } catch(e){
    const csv=[header,...rows].map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='nominal_roll.csv'; a.click();
    URL.revokeObjectURL(url);
    toast('ðŸ“¥ CSV backup downloaded');
  }
}



</script>


<script>
// â”€â”€ Service Worker disabled in embedded/iframe context â”€â”€â”€â”€â”€â”€
// (blob: URL SW registration is not supported in this environment)

// â”€â”€ PWA Install Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _deferredInstallPrompt = null;
window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault();
  _deferredInstallPrompt = e;
  // Show install banner after 3s if not dismissed
  setTimeout(showInstallBanner, 3000);
});

function showInstallBanner(){
  if(!_deferredInstallPrompt) return;
  if(document.getElementById('nvInstallBanner')) return;
  const banner = document.createElement('div');
  banner.id = 'nvInstallBanner';
  banner.innerHTML = `
    <div style="
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:linear-gradient(135deg,#1B3F44,#163439);
      border:1px solid rgba(62,142,149,0.4);border-radius:14px;
      padding:14px 20px;display:flex;align-items:center;gap:14px;
      box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:99999;
      font-family:'Syne',sans-serif;min-width:280px;max-width:340px;
      animation:slideUp .3s ease;">
      <img src="./icon-192.png" style="width:42px;height:42px;border-radius:10px;">
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:700;color:#e2eaf4;">Install NurseVault</div>
        <div style="font-size:11px;color:#7a92aa;margin-top:2px;">Add to home screen for offline access</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <button onclick="doInstallPWA()" style="
          background:linear-gradient(135deg,#3E8E95,#BFD2C5);border:none;
          border-radius:8px;padding:7px 14px;color:white;font-size:12px;
          font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;">Install</button>
        <button onclick="dismissInstallBanner()" style="
          background:none;border:none;color:#7a92aa;font-size:11px;
          cursor:pointer;font-family:'DM Mono',monospace;">Not now</button>
      </div>
    </div>
  `;
  document.body.appendChild(banner);
}

function doInstallPWA(){
  if(!_deferredInstallPrompt) return;
  _deferredInstallPrompt.prompt();
  _deferredInstallPrompt.userChoice.then(result => {
    if(result.outcome === 'accepted') toast('\u2713 NurseVault installed!');
    _deferredInstallPrompt = null;
    dismissInstallBanner();
  });
}

function dismissInstallBanner(){
  const b = document.getElementById('nvInstallBanner');
  if(b) b.remove();
  _deferredInstallPrompt = null;
}

window.addEventListener('appinstalled', function(){
  toast('\u2713 NurseVault added to home screen!');
  dismissInstallBanner();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLINICAL TOOLS â€” NEW FEATURES FROM V3
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Shared localStorage helpers
function nvLs(k,d=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}}
function nvLsSet(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}

// NV State
let nvCourses=nvLs('nv-courses',[]);
let nvPlannerSessions=nvLs('nv-sessions',[]);
let nvExams=nvLs('nv-exams',[]);
let nvSkillsState=nvLs('nv-skills',{});
let nvFcState=nvLs('nv-fc-state',{known:[],unknown:[]});
let nvQuizHistory=nvLs('nv-quiz-history',[]);
let nvStreak=nvLs('nv-streak',{count:0,lastDate:null});
let nvActivityLog=nvLs('nv-activity',[]);
let nvCustomCards=nvLs('nv-custom-cards',[]);
let nvBmiUnit='metric';
let nvFcDeck=[],nvFcIdx=0,nvFcKnown=0,nvFcUnknown=0,nvFcFlipped=false,nvFcSelectedCat='all';
let nvCurrentDrugSearch='',nvCurrentDrugClass='all';

// Log study activity
function nvLogActivity(){
  const today=new Date().toDateString();
  if(nvStreak.lastDate===today)return;
  const yesterday=new Date(Date.now()-86400000).toDateString();
  nvStreak.count=(nvStreak.lastDate===yesterday)?nvStreak.count+1:1;
  nvStreak.lastDate=today;
  nvLsSet('nv-streak',nvStreak);
  nvActivityLog.unshift({date:today,ts:Date.now()});
  if(nvActivityLog.length>30)nvActivityLog=nvActivityLog.slice(0,30);
  nvLsSet('nv-activity',nvActivityLog);
}
nvLogActivity();

// â”€â”€â”€ NV TAB SWITCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvSwitchTab(viewId,tabId){
  const viewEl=document.getElementById('view'+viewId.charAt(0).toUpperCase()+viewId.slice(1));
  if(!viewEl){
    // fallback: search by prefix
    document.querySelectorAll(`[id^="${viewId}tab-"]`).forEach(p=>p.classList.remove('active'));
    const panel=document.getElementById(`${viewId}tab-${tabId}`);
    if(panel)panel.classList.add('active');
    if(event&&event.target){
      const parentTabs=event.target.closest('.nv-tabs');
      if(parentTabs)parentTabs.querySelectorAll('.nv-tab-btn').forEach(b=>b.classList.remove('active'));
      event.target.classList.add('active');
    }
    return;
  }
  viewEl.querySelectorAll('.nv-tab-panel').forEach(p=>p.classList.remove('active'));
  viewEl.querySelectorAll('.nv-tab-btn').forEach(b=>b.classList.remove('active'));
  const panel=document.getElementById(`${viewId}tab-${tabId}`);
  if(panel)panel.classList.add('active');
  if(event&&event.target)event.target.classList.add('active');
}

// â”€â”€â”€ DRUG GUIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NV_DRUG_BANK=[
  {name:'Digoxin',generic:'Cardiac glycoside',class:'cardiac',moa:'Inhibits Na/K-ATPase pump â†’ â†‘ intracellular calcium â†’ â†‘ cardiac contractility; slows SA/AV node',uses:'Heart failure, atrial fibrillation/flutter',side:'Nausea, vomiting, visual changes (yellow-green halos), bradycardia, arrhythmias',nursing:'Apical pulse before admin (hold if <60 bpm); monitor K+ (hypokalemia â†‘ toxicity); monitor drug levels (therapeutic 0.5â€“2 ng/mL)',antidote:'Digibind (digoxin immune Fab) for toxicity',warning:'âš ï¸ Narrow therapeutic index â€” toxicity is life-threatening. Hold and call provider immediately if signs of toxicity appear.'},
  {name:'Warfarin (Coumadin)',generic:'Oral anticoagulant',class:'anticoag',moa:'Inhibits vitamin K-dependent clotting factors (II, VII, IX, X); does not lyse existing clots',uses:'DVT, PE, atrial fibrillation, mechanical heart valves',side:'Bleeding (gum, GI, intracranial), bruising, hair loss',nursing:'Monitor INR (therapeutic 2.0â€“3.0 for most; 2.5â€“3.5 for mechanical valves); consistent vitamin K intake; no ASA/NSAIDs; many drug interactions',antidote:'Vitamin K (phytonadione); FFP/PCC for urgent reversal'},
  {name:'Heparin (Unfractionated)',generic:'Anticoagulant',class:'anticoag',moa:'Binds antithrombin III â†’ inactivates thrombin and factor Xa',uses:'DVT treatment and prophylaxis, PE, ACS, surgical prophylaxis',side:'Bleeding, HIT (heparin-induced thrombocytopenia), osteoporosis',nursing:'Monitor aPTT (therapeutic 60â€“100s); baseline and daily platelet count; watch for HIT (â†“ platelets + new thrombosis); subcutaneous â€” do not rub injection site',antidote:'Protamine sulfate (1 mg per 100 units heparin given in last 4 hours)',warning:'âš ï¸ HIT risk â€” if platelets drop >50% or new clots form, stop heparin immediately and notify provider.'},
  {name:'Metoprolol (Lopressor)',generic:'Beta-1 selective blocker',class:'cardiac',moa:'Selective blockade of beta-1 adrenergic receptors â†’ â†“ HR, â†“ BP, â†“ cardiac workload',uses:'Hypertension, angina, MI, heart failure, arrhythmias',side:'Bradycardia, hypotension, fatigue, bronchospasm, dizziness, depression',nursing:'Apical pulse before admin (hold if <60 bpm); BP check; do not stop abruptly; caution in asthma/COPD; mask hypoglycemia symptoms in diabetics',antidote:'Atropine for bradycardia; glucagon for overdose'},
  {name:'Furosemide (Lasix)',generic:'Loop diuretic',class:'cardiac',moa:'Inhibits Na-K-2Cl transporter in loop of Henle â†’ â†‘ urine output',uses:'Edema (CHF, liver, renal), hypertension, hypercalcemia',side:'Hypokalemia, hyponatremia, hypomagnesemia, ototoxicity, dehydration, hypotension',nursing:'Monitor K+, Na+, BUN, Creatinine; I&O; daily weights; give in morning to avoid nocturia; sulfa allergy cross-reactivity possible',antidote:'No specific antidote; replace electrolytes as needed'},
  {name:'Amiodarone (Cordarone)',generic:'Antiarrhythmic (Class III)',class:'cardiac',moa:'Blocks K+ channels â†’ prolongs action potential and refractory period; also blocks Na+ and CaÂ²+ channels and beta receptors',uses:'Ventricular tachycardia, ventricular fibrillation, atrial fibrillation',side:'Pulmonary toxicity, thyroid dysfunction, corneal microdeposits, photosensitivity, hepatotoxicity, bradycardia, QT prolongation',nursing:'Baseline and periodic PFTs, TFTs, LFTs, ophthalmology exam; monitor QT interval; use IV filter for IV doses; sunscreen education',antidote:'No specific antidote; supportive care'},
  {name:'Morphine Sulfate',generic:'Opioid analgesic',class:'analgesic',moa:'Binds mu-opioid receptors in CNS â†’ alters pain perception; causes respiratory depression, sedation, euphoria',uses:'Severe pain, acute MI, pulmonary edema, cancer pain',side:'Respiratory depression, constipation, nausea, sedation, urinary retention, pruritis, hypotension',nursing:'Respiratory rate before admin (hold if <12/min); have naloxone available; bowel regimen; fall precautions; assess pain 15â€“30 min post-dose',antidote:'Naloxone (Narcan)'},
  {name:'Naloxone (Narcan)',generic:'Opioid antagonist',class:'analgesic',moa:'Competitive antagonist at mu, kappa, delta opioid receptors â†’ reverses opioid effects within 2â€“5 minutes',uses:'Opioid overdose, respiratory depression from opioids',side:'Acute withdrawal syndrome (agitation, pain, tachycardia, N/V), re-narcotization (short half-life)',nursing:'Shorter duration than most opioids â€” may need repeat doses; monitor continuously; have crash cart available; note re-narcotization risk',antidote:'N/A â€” it IS the antidote'},
  {name:'Acetaminophen (Paracetamol)',generic:'Non-opioid analgesic/antipyretic',class:'analgesic',moa:'Inhibits prostaglandin synthesis in CNS; does not inhibit peripheral COX (no anti-inflammatory effect)',uses:'Mild to moderate pain, fever',side:'Hepatotoxicity in overdose; usually well-tolerated at therapeutic doses',nursing:'Max dose 4g/day (2g in liver disease); check for hidden acetaminophen in combo products; educate patient on avoiding alcohol',antidote:'N-Acetylcysteine (NAC/Mucomyst) â€” within 8â€“10h for best results'},
  {name:'Lisinopril',generic:'ACE inhibitor',class:'cardiac',moa:'Inhibits ACE â†’ prevents Angiotensin Iâ†’II conversion â†’ vasodilation, â†“ aldosterone â†’ â†“ BP, â†“ preload/afterload',uses:'Hypertension, heart failure, post-MI, diabetic nephropathy',side:'Dry cough (ACE-kinin effect), hyperkalemia, angioedema, hypotension (first dose)',nursing:'Monitor K+, Cr, BUN; watch for angioedema (stop immediately); hold in pregnancy (teratogenic); first-dose hypotension risk',antidote:'No specific antidote; angioedema: stop drug, epinephrine if severe',warning:'âš ï¸ Contraindicated in pregnancy (Category D). Angioedema is a medical emergency â€” discontinue immediately.'},
  {name:'Amlodipine (Norvasc)',generic:'Calcium channel blocker (DHP)',class:'cardiac',moa:'Blocks L-type calcium channels in vascular smooth muscle and cardiac muscle â†’ vasodilation, â†“ peripheral resistance',uses:'Hypertension, chronic stable angina, vasospastic angina',side:'Peripheral edema (ankles), flushing, headache, palpitations, dizziness',nursing:'Monitor BP and HR; assess for edema; grapefruit juice interaction (â†‘ drug levels); do not stop abruptly',antidote:'Calcium gluconate/chloride for overdose; vasopressors if hypotensive'},
  {name:'Metformin (Glucophage)',generic:'Biguanide antidiabetic',class:'endocrine',moa:'Decreases hepatic glucose production (gluconeogenesis); improves insulin sensitivity; does not cause hypoglycemia alone',uses:'Type 2 diabetes (first-line), polycystic ovary syndrome (off-label)',side:'GI upset (N/V, diarrhea), metallic taste, vitamin B12 deficiency, rare lactic acidosis',nursing:'Take with food; hold 48h before/after IV contrast; check renal function (contraindicated if eGFR <30); monitor B12 annually',antidote:'No specific antidote; dialysis for lactic acidosis'},
  {name:'Insulin (Regular)',generic:'Short-acting insulin',class:'endocrine',moa:'Binds insulin receptors â†’ facilitates glucose uptake into cells; promotes glycogen synthesis, inhibits gluconeogenesis',uses:'Type 1 DM, Type 2 DM, diabetic ketoacidosis, hyperkalemia',side:'Hypoglycemia (most common), weight gain, lipodystrophy at injection sites, hypokalemia',nursing:'Check blood glucose before admin; rotate injection sites; onset 30â€“60 min (give 30 min before meals); monitor for hypoglycemia symptoms; have glucose source available',antidote:'Dextrose (D50) IV or glucagon IM for severe hypoglycemia',warning:'âš ï¸ HIGH ALERT MEDICATION. Double-check dose with another nurse. Never shake vial.'},
  {name:'Amoxicillin',generic:'Penicillin antibiotic',class:'antibiotic',moa:'Inhibits bacterial cell wall synthesis by binding penicillin-binding proteins â†’ bactericidal',uses:'Ear, respiratory, urinary, skin infections; H. pylori (with clarithromycin/PPI)',side:'Diarrhea, nausea, rash, allergic reactions (anaphylaxis risk), C. difficile colitis',nursing:'Ask about penicillin allergy; cross-reactivity with cephalosporins (~2â€“5%); complete full course; monitor for rash (may indicate allergy)',antidote:'Epinephrine for anaphylaxis; supportive care'},
  {name:'Ciprofloxacin (Cipro)',generic:'Fluoroquinolone antibiotic',class:'antibiotic',moa:'Inhibits DNA gyrase and topoisomerase IV â†’ prevents DNA replication â†’ bactericidal',uses:'UTI, respiratory infections, GI infections, skin infections, anthrax prophylaxis',side:'GI upset, tendinopathy/tendon rupture, QT prolongation, photosensitivity, CNS effects, C. difficile',nursing:'Avoid in children <18, pregnancy, tendon disorders; avoid antacids within 2h; sun protection; monitor for tendon pain',antidote:'Supportive care; discontinue if tendon pain occurs',warning:'âš ï¸ Black box warning: tendon rupture risk, especially with corticosteroids. Avoid in patients with tendon problems.'},
  {name:'Vancomycin',generic:'Glycopeptide antibiotic',class:'antibiotic',moa:'Inhibits cell wall synthesis by binding D-Ala-D-Ala peptidoglycan precursors â€” effective against MRSA',uses:'MRSA infections, C. difficile (oral), severe gram-positive infections',side:'Red man syndrome (rapid infusion), nephrotoxicity, ototoxicity, thrombophlebitis',nursing:'Infuse over â‰¥60 min to prevent Red man syndrome; monitor trough levels (target 10â€“20 mcg/mL); monitor renal function and hearing; IV site assessment',antidote:'Slow infusion/diphenhydramine for Red man syndrome; dose adjustment for nephrotoxicity'},
  {name:'Haloperidol (Haldol)',generic:'Typical antipsychotic (butyrophenone)',class:'psych',moa:'Blocks dopamine D2 receptors in mesolimbic pathway â†’ antipsychotic effect; also blocks alpha-1, muscarinic receptors',uses:'Schizophrenia, acute agitation, Tourette syndrome, delirium',side:'EPS (dystonia, akathisia, parkinsonism, tardive dyskinesia), NMS, QT prolongation, sedation, anticholinergic effects',nursing:'Monitor for EPS; assess for NMS (fever, rigidity, altered consciousness); ECG monitoring with IV use; do not stop abruptly',antidote:'Benztropine (Cogentin) or diphenhydramine for EPS; bromocriptine/dantrolene for NMS'},
  {name:'Sertraline (Zoloft)',generic:'SSRI antidepressant',class:'psych',moa:'Selectively inhibits serotonin reuptake in presynaptic neurons â†’ increased synaptic serotonin',uses:'Major depressive disorder, OCD, PTSD, panic disorder, social anxiety disorder',side:'Nausea, diarrhea, insomnia, sexual dysfunction, weight changes, SIADH, serotonin syndrome',nursing:'Take 4â€“6 weeks for full effect; do not stop abruptly (taper); monitor for suicidal ideation (especially in young adults); avoid MAOIs within 14 days',antidote:'Cyproheptadine for serotonin syndrome; supportive care'},
  {name:'Salbutamol/Albuterol (Ventolin)',generic:'Short-acting beta-2 agonist (SABA)',class:'respiratory',moa:'Stimulates beta-2 adrenergic receptors in bronchial smooth muscle â†’ bronchodilation',uses:'Acute bronchospasm (asthma, COPD), exercise-induced bronchospasm, hyperkalemia',side:'Tachycardia, tremor, palpitations, hypokalemia, paradoxical bronchospasm',nursing:'Rescue inhaler â€” not for long-term control; assess breath sounds before/after; correct inhaler technique; note frequency of use (>2 puffs/day = poor control)',antidote:'Supportive care; beta-blocker if severe tachycardia from overdose'},
  {name:'Ipratropium (Atrovent)',generic:'Anticholinergic bronchodilator',class:'respiratory',moa:'Blocks muscarinic receptors in bronchial smooth muscle â†’ bronchodilation; â†“ mucus secretion',uses:'COPD (maintenance), asthma (adjunct), rhinorrhea',side:'Dry mouth, urinary retention, constipation, blurred vision, tachycardia',nursing:'Rinse mouth after inhalation; caution in BPH, glaucoma; combine with albuterol for synergistic effect (DuoNeb); assess lung sounds',antidote:'Supportive care'},
  {name:'Prednisolone/Prednisone',generic:'Corticosteroid',class:'respiratory',moa:'Binds glucocorticoid receptors â†’ broad anti-inflammatory and immunosuppressive effects; reduces airway inflammation',uses:'Asthma exacerbation, COPD exacerbation, autoimmune diseases, transplant rejection',side:'Hyperglycemia, hypertension, weight gain, osteoporosis, immunosuppression, peptic ulcer, mood changes, adrenal suppression',nursing:'Do not stop abruptly (taper for >2 weeks use); monitor blood glucose; take with food; oral care; calcium/vitamin D supplement; watch for infection signs',antidote:'No specific antidote; taper dose rather than abrupt discontinuation'},
];

const nvDrugClassColors={cardiac:'nv-tag-blue',antibiotic:'nv-tag-green',analgesic:'nv-tag-orange',anticoag:'nv-tag-red',psych:'nv-tag-purple',respiratory:'nv-tag-blue',endocrine:'nv-tag-green'};

function nvRenderDrugs(){
  let filtered=NV_DRUG_BANK;
  if(nvCurrentDrugClass!=='all') filtered=filtered.filter(d=>d.class===nvCurrentDrugClass);
  if(nvCurrentDrugSearch) filtered=filtered.filter(d=>d.name.toLowerCase().includes(nvCurrentDrugSearch)||d.generic.toLowerCase().includes(nvCurrentDrugSearch));
  const el=document.getElementById('nvDrugList');
  if(!el)return;
  el.innerHTML=filtered.length===0?`<div class="nv-empty"><div class="nv-empty-icon">ðŸ’Š</div><div class="nv-empty-text">No drugs match your search.</div></div>`:
  filtered.map(d=>`
    <div class="drug-card" onclick="nvToggleDrug(this)">
      <div class="drug-header">
        <div>
          <div class="drug-name">${d.name} <span class="nv-tag ${nvDrugClassColors[d.class]||'nv-tag-blue'}" style="font-size:9px;">${d.class}</span></div>
          <div class="drug-generic">${d.generic}</div>
        </div>
        <div style="color:var(--nv-text-dim);font-size:18px;" class="nvDrugChev">â€º</div>
      </div>
      <div class="drug-body">
        <div class="drug-section"><div class="drug-section-title">Mechanism of Action</div><div class="drug-section-body">${d.moa}</div></div>
        <div class="drug-section"><div class="drug-section-title">Uses</div><div class="drug-section-body">${d.uses}</div></div>
        <div class="drug-section"><div class="drug-section-title">Side Effects</div><div class="drug-section-body">${d.side}</div></div>
        <div class="drug-section"><div class="drug-section-title">Nursing Considerations</div><div class="drug-section-body">${d.nursing}</div></div>
        <div class="drug-section"><div class="drug-section-title">Antidote</div><div class="drug-section-body">${d.antidote}</div></div>
        ${d.warning?`<div class="drug-warning">${d.warning}</div>`:''}
      </div>
    </div>`).join('');
}
function nvToggleDrug(card){
  const body=card.querySelector('.drug-body'),chev=card.querySelector('.nvDrugChev');
  const isOpen=body.classList.contains('open');
  document.querySelectorAll('#nvDrugList .drug-body').forEach(b=>b.classList.remove('open'));
  document.querySelectorAll('#nvDrugList .nvDrugChev').forEach(c=>c.style.transform='');
  if(!isOpen){body.classList.add('open');chev.style.transform='rotate(90deg)';}
}
function nvFilterDrugs(val){nvCurrentDrugSearch=val.toLowerCase();nvRenderDrugs();}
function nvFilterDrugClass(cls,el){
  nvCurrentDrugClass=cls;
  document.querySelectorAll('#nvDrugClassFilter .nv-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');nvRenderDrugs();
}

// â”€â”€â”€ FLASHCARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NV_FC_BANK={
  pharmacology:[
    {q:'Antidote for Heparin overdose?',a:'Protamine Sulfate'},
    {q:'Antidote for Warfarin (Coumadin)?',a:'Vitamin K (Phytonadione); FFP for urgent reversal'},
    {q:'Antidote for Morphine/Opioid overdose?',a:'Naloxone (Narcan)'},
    {q:'Antidote for Acetaminophen overdose?',a:'N-Acetylcysteine (NAC/Mucomyst)'},
    {q:'Antidote for Digoxin toxicity?',a:'Digibind (Digoxin Immune Fab)'},
    {q:'When do you hold Digoxin?',a:'Apical pulse <60 bpm or signs of toxicity (nausea, visual changes, arrhythmia)'},
    {q:'Primary mechanism of ACE inhibitors?',a:'Block angiotensin-converting enzyme â†’ prevents Ang Iâ†’II â†’ vasodilation â†’ â†“BP'},
    {q:'Electrolyte imbalance that increases Digoxin toxicity?',a:'Hypokalemia (low K+)'},
    {q:'Class of Furosemide (Lasix)?',a:'Loop diuretic â€” inhibits Na-K-2Cl transporter in loop of Henle'},
    {q:'Main nursing consideration for beta-blockers?',a:'Assess apical pulse (hold if <60 bpm); do not stop abruptly; monitor BP'},
    {q:'Side effect unique to ACE inhibitors vs ARBs?',a:'Dry cough (due to bradykinin accumulation) â€” use ARB as alternative'},
    {q:'Therapeutic INR for warfarin in atrial fibrillation?',a:'2.0â€“3.0 (2.5â€“3.5 for mechanical heart valves)'},
  ],
  anatomy:[
    {q:'Normal adult resting heart rate?',a:'60â€“100 beats per minute'},
    {q:'Normal adult blood pressure?',a:'<120/<80 mmHg (Systolic/Diastolic)'},
    {q:'Normal adult respiratory rate?',a:'12â€“20 breaths per minute'},
    {q:'Normal adult temperature?',a:'36.1â€“37.2Â°C (97.0â€“99.0Â°F)'},
    {q:'Normal SpOâ‚‚ range?',a:'95â€“100% (below 90% requires immediate intervention)'},
    {q:'Normal adult urine output?',a:'0.5â€“1.0 mL/kg/hr (30â€“60 mL/hr minimum)'},
    {q:'Layers of the heart wall (inside â†’ outside)?',a:'Endocardium â†’ Myocardium â†’ Epicardium â†’ Pericardium'},
    {q:'Function of the SA node?',a:'Primary pacemaker of the heart â€” initiates electrical impulse 60â€“100 times/min'},
    {q:'What do erythrocytes (RBCs) do?',a:'Transport oxygen via hemoglobin and carry COâ‚‚ back to lungs for exhalation'},
    {q:'Role of the nephron?',a:'Functional unit of the kidney â€” filters blood, regulates fluid, electrolytes, and waste'},
  ],
  medsurg:[
    {q:"Priority nursing intervention for MI (chest pain â†’ left arm)?",a:'Oâ‚‚, 12-lead ECG, notify physician, prepare MONA: Morphine, Oxygen, Nitrates, Aspirin'},
    {q:'Signs of left-sided heart failure?',a:'Dyspnea, orthopnea, PND, crackles, S3 gallop, frothy pink sputum, fatigue, â†“urine output'},
    {q:"Signs of right-sided heart failure?",a:'JVD, peripheral edema, hepatomegaly, ascites, weight gain'},
    {q:"Cushing's Triad (late sign of â†‘ICP)?",a:'Hypertension + Bradycardia + Irregular respirations'},
    {q:'Priority position for respiratory distress?',a:"High Fowler's position (90Â°) to maximize lung expansion"},
    {q:'3 Cs of compartment syndrome?',a:'Crepitus, Cramps/Pain, Circulatory compromise â†’ 6 Ps: Pain, Pressure, Paresthesia, Paralysis, Pallor, Pulselessness'},
    {q:'Signs of hypovolemic shock?',a:'â†“BP, â†‘HR, â†‘RR, cold/clammy skin, â†“urine output (<30 mL/hr), altered consciousness'},
    {q:'RICE mnemonic for musculoskeletal injury?',a:'Rest, Ice, Compression, Elevation'},
  ],
  mental:[
    {q:'Therapeutic communication principle #1?',a:'Listen actively and reflect feelings â€” avoid giving advice, false reassurance, or changing the subject'},
    {q:"Priority nursing concern in major depression?",a:'Safety assessment â€” risk of suicide/self-harm; establish therapeutic alliance; never leave alone if at risk'},
    {q:'Signs of serotonin syndrome?',a:'Agitation, confusion, tachycardia, hyperthermia, diaphoresis, tremor, hyperreflexia â€” medical emergency'},
    {q:'CAGE screening for alcohol use disorder?',a:'Cut down, Annoyed, Guilty, Eye-opener â€” 2+ positive responses = significant concern'},
    {q:'Side effects of lithium toxicity?',a:'Tremor, confusion, slurred speech, ataxia, GI symptoms â€” check levels (therapeutic 0.6â€“1.2 mEq/L)'},
    {q:'Neuroleptic malignant syndrome (NMS) signs?',a:'Fever, rigidity, altered consciousness, autonomic instability â€” STOP antipsychotic immediately'},
  ],
  custom:[]
};

// Load custom cards
NV_FC_BANK.custom=nvCustomCards;

const nvFcCatLabels={pharmacology:{icon:'ðŸ’Š',name:'Pharmacology'},anatomy:{icon:'ðŸ«€',name:'Anatomy & Physiology'},medsurg:{icon:'ðŸ¥',name:'Medical-Surgical'},mental:{icon:'ðŸ§ ',name:'Mental Health'},custom:{icon:'â­',name:'My Cards'}};

function nvRenderFcHome(){
  const cats=Object.keys(nvFcCatLabels);
  const sel=document.getElementById('nvFcCatSelector');
  if(!sel)return;
  sel.innerHTML=cats.map(k=>`
    <button class="fc-cat-btn${nvFcSelectedCat===k?' selected':''}" onclick="nvSelectFcCat('${k}',this)">
      <div style="font-size:20px;margin-bottom:6px;">${nvFcCatLabels[k].icon}</div>
      <div style="font-size:13px;font-weight:600;color:var(--text);">${nvFcCatLabels[k].name}</div>
      <div style="font-size:10px;color:var(--nv-text-dim);">${(NV_FC_BANK[k]||[]).length} cards</div>
    </button>`).join('');
  const allCards=cats.flatMap(k=>NV_FC_BANK[k]||[]);
  const known=nvFcState.known.length,unknown=nvFcState.unknown.length;
  document.getElementById('nvFcTotal').textContent=allCards.length;
  document.getElementById('nvFcKnown').textContent=known;
  document.getElementById('nvFcUnknown').textContent=unknown;
}

function nvSelectFcCat(cat,el){
  nvFcSelectedCat=cat;
  document.querySelectorAll('.fc-cat-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
}

function nvStartFlashcards(){
  const cards=nvFcSelectedCat==='all'?Object.keys(NV_FC_BANK).flatMap(k=>NV_FC_BANK[k]):[...NV_FC_BANK[nvFcSelectedCat]||[]];
  if(!cards.length){toast('No cards in this category!');return;}
  nvFcDeck=[...cards].sort(()=>Math.random()-.5);
  nvFcIdx=0;nvFcKnown=0;nvFcUnknown=0;nvFcFlipped=false;
  document.getElementById('nvFcHome').style.display='none';
  document.getElementById('nvFcSession').style.display='';
  document.getElementById('nvFcComplete').style.display='none';
  nvShowFcCard();
}

function nvShowFcCard(){
  if(nvFcIdx>=nvFcDeck.length){nvEndFcSession();return;}
  const card=nvFcDeck[nvFcIdx];
  document.getElementById('nvFcSessionLabel').textContent=`Card ${nvFcIdx+1} of ${nvFcDeck.length}`;
  document.getElementById('nvFcQText').textContent=card.q;
  document.getElementById('nvFcAText').textContent=card.a;
  const fc=document.getElementById('nvFcCard');
  fc.classList.remove('flipped');
  nvFcFlipped=false;
  document.getElementById('nvFcFlipHint').style.display='';
  document.getElementById('nvFcRatingBtns').style.display='none';
  // progress dots
  const dots=document.getElementById('nvFcProgressDots');
  dots.innerHTML=nvFcDeck.map((c,i)=>{
    let cls='fc-dot';
    if(i<nvFcIdx){cls+=' '+(nvFcState.known.includes(c.q)?'known':'unknown');}
    else if(i===nvFcIdx)cls+=' current';
    return `<div class="${cls}"></div>`;
  }).join('');
}

function nvFlipCard(){
  if(nvFcFlipped)return;
  nvFcFlipped=true;
  document.getElementById('nvFcCard').classList.add('flipped');
  document.getElementById('nvFcFlipHint').style.display='none';
  document.getElementById('nvFcRatingBtns').style.display='';
}

function nvRateCard(known){
  const card=nvFcDeck[nvFcIdx];
  if(known){nvFcKnown++;if(!nvFcState.known.includes(card.q))nvFcState.known.push(card.q);}
  else{nvFcUnknown++;if(!nvFcState.unknown.includes(card.q))nvFcState.unknown.push(card.q);}
  nvLsSet('nv-fc-state',nvFcState);
  nvFcIdx++;
  setTimeout(nvShowFcCard,300);
}

function nvEndFcSession(){
  const total=nvFcDeck.length,pct=total>0?Math.round((nvFcKnown/total)*100):0;
  document.getElementById('nvFcSession').style.display='none';
  document.getElementById('nvFcComplete').style.display='';
  document.getElementById('nvFcResultKnown').textContent=nvFcKnown;
  document.getElementById('nvFcResultUnknown').textContent=nvFcUnknown;
  document.getElementById('nvFcResultPct').textContent=pct+'%';
  nvLsSet('nv-cards-reviewed',(nvLs('nv-cards-reviewed',0))+total);
}

function nvFcBackHome(){
  document.getElementById('nvFcSession').style.display='none';
  document.getElementById('nvFcComplete').style.display='none';
  document.getElementById('nvFcHome').style.display='';
  nvRenderFcHome();
}

function nvAddCustomCard(){
  const q=document.getElementById('nvFcNewQ').value.trim(),a=document.getElementById('nvFcNewA').value.trim();
  if(!q||!a){toast('Fill in both question and answer');return;}
  nvCustomCards.unshift({q,a});
  nvLsSet('nv-custom-cards',nvCustomCards);
  NV_FC_BANK.custom=nvCustomCards;
  document.getElementById('nvFcNewQ').value='';document.getElementById('nvFcNewA').value='';
  toast('âœ“ Card added!');nvRenderFcHome();
}

// â”€â”€â”€ MED CALCULATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvCalcDosage(){
  const d=parseFloat(document.getElementById('nvMcDesired').value),h=parseFloat(document.getElementById('nvMcHave').value),v=parseFloat(document.getElementById('nvMcVol').value);
  if(!d||!h||!v){toast('Fill all fields');return;}
  document.getElementById('nvMcDoseVal').textContent=((d/h)*v).toFixed(2);
  document.getElementById('nvMcDosageResult').style.display='';
}
function nvCalcDrip(){
  const vol=parseFloat(document.getElementById('nvDripVol').value),df=parseFloat(document.getElementById('nvDripFactor').value),hrs=parseFloat(document.getElementById('nvDripTime').value);
  if(!vol||!hrs){toast('Fill all fields');return;}
  document.getElementById('nvDripVal').textContent=Math.round((vol*df)/(hrs*60));
  document.getElementById('nvMcDripResult').style.display='';
}
function nvSwitchBmiUnit(u){
  nvBmiUnit=u;
  document.getElementById('nvBmiMetricF').style.display=u==='metric'?'':'none';
  document.getElementById('nvBmiImperialF').style.display=u==='imperial'?'':'none';
  document.getElementById('nvBmiMBtn').classList.toggle('active',u==='metric');
  document.getElementById('nvBmiIBtn').classList.toggle('active',u==='imperial');
  document.getElementById('nvBmiResult').style.display='none';
}
function nvCalcBMI(){
  let bmi;
  if(nvBmiUnit==='metric'){const kg=parseFloat(document.getElementById('nvBmiKg').value),cm=parseFloat(document.getElementById('nvBmiCm').value);if(!kg||!cm){toast('Fill all fields');return;}bmi=kg/((cm/100)**2);}
  else{const lbs=parseFloat(document.getElementById('nvBmiLbs').value),ins=parseFloat(document.getElementById('nvBmiIn').value);if(!lbs||!ins){toast('Fill all fields');return;}bmi=(703*lbs)/(ins**2);}
  const cat=bmi<18.5?'Underweight':bmi<25?'Normal Weight':bmi<30?'Overweight':'Obese';
  document.getElementById('nvBmiVal').textContent=bmi.toFixed(1);
  document.getElementById('nvBmiCat').textContent=cat;
  document.getElementById('nvBmiBar').style.width=Math.min((bmi/40)*100,100)+'%';
  document.getElementById('nvBmiResult').style.display='';
}
function nvCalcPeds(){
  const dpk=parseFloat(document.getElementById('nvPedsDoseKg').value),wt=parseFloat(document.getElementById('nvPedsWeight').value),freq=parseInt(document.getElementById('nvPedsFreq').value);
  if(!dpk||!wt){toast('Fill all fields');return;}
  const single=dpk*wt,daily=single*freq;
  document.getElementById('nvPedsSingle').textContent=single.toFixed(1);
  document.getElementById('nvPedsDaily').textContent=daily.toFixed(1)+' mg';
  document.getElementById('nvPedsResult').style.display='';
}

// â”€â”€â”€ STUDY PLANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NV_DAYS=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
function nvRenderPlanner(){
  const week=document.getElementById('nvPlannerWeekView');
  if(!week)return;
  week.innerHTML=NV_DAYS.map(day=>{
    const sessions=nvPlannerSessions.filter(s=>s.day===day).sort((a,b)=>a.time.localeCompare(b.time));
    return `<div class="planner-day">
      <div class="planner-day-header">
        <div class="planner-day-label">${day}</div>
        <div class="nv-text-xs nv-text-dim">${sessions.length} session${sessions.length!==1?'s':''}</div>
      </div>
      ${sessions.length>0?`<div class="planner-sessions">${sessions.map(s=>`
        <div class="session-block${s.done?' session-done':''}">
          <div class="session-check${s.done?' checked':''}" onclick="nvToggleSession('${s.id}')">${s.done?'âœ“':''}</div>
          <div style="flex:1;">
            <div class="session-subject">${s.subject}</div>
            <div class="session-time">${s.time} Â· ${s.duration} min</div>
          </div>
          <button class="nv-btn nv-btn-danger nv-btn-sm" style="padding:4px 8px;" onclick="nvRemoveSession('${s.id}')">âœ•</button>
        </div>`).join('')}</div>`:''}
    </div>`;
  }).join('');

  const examList=document.getElementById('nvExamCountdownList');
  if(!examList)return;
  if(nvExams.length===0){examList.innerHTML='<div class="nv-empty"><div class="nv-empty-icon">ðŸ“…</div><div class="nv-empty-text">No exams added yet.</div></div>';return;}
  const today=new Date();today.setHours(0,0,0,0);
  examList.innerHTML=nvExams.map((ex,i)=>{
    const d=new Date(ex.date);d.setHours(0,0,0,0);
    const diff=Math.ceil((d-today)/86400000);
    const color=diff<=3?'var(--nv-red)':diff<=7?'var(--nv-accent-warm)':'var(--nv-accent)';
    return `<div class="exam-countdown-card" style="border-color:${color}22;background:${color}0d;">
      <div class="exam-countdown-days" style="color:${color};">${diff<=0?'Today!':diff}</div>
      <div style="font-size:12px;color:var(--nv-text-dim);margin-top:4px;">${diff<=0?'EXAM DAY':'days until'}</div>
      <div class="nv-fw-700 nv-mt-8">${ex.subject}</div>
      <div class="nv-text-xs nv-text-dim">${d.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'long'})}</div>
      <button class="nv-btn nv-btn-danger nv-btn-sm" style="margin-top:10px;" onclick="nvRemoveExam(${i})">Remove</button>
    </div>`;
  }).join('');
}

function nvAddSession(){
  const subj=document.getElementById('nvSessSubj').value,day=document.getElementById('nvSessDay').value,time=document.getElementById('nvSessTime').value,dur=document.getElementById('nvSessDur').value;
  const s={id:Date.now().toString(),subject:subj,day,time,duration:dur,done:false};
  nvPlannerSessions.push(s);nvLsSet('nv-sessions',nvPlannerSessions);
  nvRenderPlanner();toast(`âœ“ ${subj} session added`);
  // switch to week tab
  document.querySelectorAll('#viewStudyplanner .nv-tab-btn').forEach((b,i)=>{b.classList.toggle('active',i===0);});
  document.querySelectorAll('#viewStudyplanner .nv-tab-panel').forEach((p,i)=>{p.classList.toggle('active',i===0);});
}
function nvToggleSession(id){
  const s=nvPlannerSessions.find(x=>x.id===id);
  if(s){s.done=!s.done;nvLsSet('nv-sessions',nvPlannerSessions);nvLsSet('nv-sessions-done',(nvLs('nv-sessions-done',0))+(s.done?1:0));}
  nvRenderPlanner();
}
function nvRemoveSession(id){nvPlannerSessions=nvPlannerSessions.filter(s=>s.id!==id);nvLsSet('nv-sessions',nvPlannerSessions);nvRenderPlanner();}
function nvAddExam(){
  const subj=document.getElementById('nvExamSubj').value.trim(),date=document.getElementById('nvExamDate').value;
  if(!subj||!date){toast('Fill in subject and date');return;}
  nvExams.push({subject:subj,date});nvLsSet('nv-exams',nvExams);
  document.getElementById('nvExamSubj').value='';document.getElementById('nvExamDate').value='';
  nvRenderPlanner();toast('âœ“ Exam added');
}
function nvRemoveExam(i){nvExams.splice(i,1);nvLsSet('nv-exams',nvExams);nvRenderPlanner();}

// â”€â”€â”€ SKILLS CHECKLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NV_SKILLS_DATA=[
  {id:'hand_hygiene',name:'1. Hand Hygiene',steps:['Inspect hands for cuts, wounds, or skin conditions before starting','Remove all jewellery â€” rings, bracelets, watches â€” from hands and wrists','Turn on tap to comfortably warm water; avoid touching tap with clean hands','Wet hands thoroughly under running water','Apply 3â€“5mL of liquid soap or antimicrobial solution to palm','Palm to palm: rub hands together vigorously in circular motion (5 strokes)','Right palm over left dorsum with interlaced fingers; repeat for left hand (5 strokes each)','Palm to palm with fingers interlaced; rub between all fingers (5 strokes)','Backs of fingers to opposing palms with fingers interlocked (5 strokes)','Rotational rubbing of right thumb clasped in left palm; repeat for left thumb (5 strokes each)','Rotational rubbing with clasped fingers of right hand in left palm; repeat (5 strokes each)','Rinse hands thoroughly under running water â€” fingertips pointing downward','Dry hands completely with single-use paper towel or sterile hand towel','Use paper towel to turn off tap â€” do not re-contaminate clean hands','Apply alcohol-based hand rub if required as a follow-up','Total hand hygiene time: minimum 40â€“60 seconds','Document hand hygiene compliance as per ward policy','Perform hand hygiene: before and after patient contact, before aseptic procedures, after body fluid exposure, after touching patient surroundings']},

  {id:'vitals',name:'2. Vital Signs Assessment',steps:['Gather all equipment: thermometer, sphygmomanometer (correct cuff size), stethoscope, pulse oximeter, watch with second hand, pen and observation chart','Introduce yourself; confirm patient identity using 2 identifiers (name + ID/date of birth)','Explain the procedure to the patient; ensure comfort and privacy','Ensure patient has rested for at least 5 minutes before measurements','TEMPERATURE â€” Select appropriate route (oral, axillary, tympanic, or rectal per indication)','Place thermometer correctly; wait for signal or required duration','Read and record temperature; note route used','Normal range: 36.1â€“37.2Â°C oral; report >38.0Â°C (fever) or <36.0Â°C (hypothermia)','PULSE â€” Place index and middle fingers on radial artery (thumb side of wrist)','Count pulse for a full 60 seconds; note rate, rhythm (regular/irregular), and volume (strong/weak/thready)','Normal adult: 60â€“100 bpm; document findings','RESPIRATIONS â€” Count chest rises for 60 seconds while appearing to continue pulse assessment (to avoid patient altering breathing)','Note respiratory rate, depth, and pattern (regular, irregular, laboured, shallow)','Normal adult: 12â€“20 breaths/min; report <10 or >30 immediately','BLOOD PRESSURE â€” Position patient seated or supine; expose upper arm','Apply cuff 2â€“3cm above antecubital fossa; align arrow with brachial artery','Palpate radial pulse; inflate to 30mmHg above point where pulse disappears','Deflate at 2â€“3mmHg/sec; auscultate with stethoscope over brachial artery','Record systolic (Phase I Korotkoff) and diastolic (Phase V) values, arm used, and position','OXYGEN SATURATION â€” Apply pulse oximeter to clean, warm fingertip (remove nail polish if present)','Wait for steady reading; record SpOâ‚‚ and note waveform quality','Normal: 95â€“100%; below 94% requires prompt assessment and intervention','PAIN ASSESSMENT â€” Ask patient to rate pain 0â€“10 (or use FACES scale for children/cognitive impairment)','Document all vital signs on observation chart with date, time, and your signature','Compare all values to previous readings and established normal ranges','Report any abnormal values to the nurse-in-charge or physician immediately','Document any actions taken in response to abnormal findings']},

  {id:'med_admin',name:'3. Medication Administration',steps:['Check the medication administration record (MAR) or prescription chart for the correct order','Verify the 10 Rights: Right Patient, Right Drug, Right Dose, Right Route, Right Time, Right Documentation, Right Reason, Right Response, Right Education, Right to Refuse','Perform hand hygiene','Gather medications from trolley or medication room â€” never leave medications unattended','Check medication label against MAR â€” read label THREE times: when taking from shelf, when preparing, and before administration','Calculate dose accurately; double-check calculations with a second nurse for high-alert medications (insulin, anticoagulants, opioids, electrolytes)','Check expiry date on all medications','Prepare medications in a clean, well-lit, distraction-free environment','Do NOT prepare medications drawn up by another nurse â€” if you did not draw it up, do not give it','Go to patient; confirm identity using 2 identifiers (name + armband/date of birth)','Explain the medication: name, purpose, and expected effect','Assess for contraindications: ask about allergies, check renal/liver function if relevant','Administer medication using the correct technique for the route (oral, topical, inhaled, injection)','Stay with patient until oral medication is swallowed â€” do not leave medications at bedside unless specifically ordered','Observe patient for immediate adverse reactions after administration','Document administration IMMEDIATELY after giving â€” never pre-chart','Record dose given, time, route, site (if injection), and your signature','If patient refuses medication: document refusal, reasons stated, and notify prescribing physician','Report any medication errors immediately using the incident reporting system','Monitor patient for therapeutic effects and adverse reactions per drug pharmacology']},

  {id:'im_inj',name:'4. Intramuscular (IM) Injection',steps:['Verify medication order using 10 Rights of medication administration','Gather supplies: correct medication, correct syringe and needle size, alcohol swabs, gloves, sharps container','Perform hand hygiene; apply clean gloves','Check medication: name, dose, expiry, appearance (clarity, colour, precipitation)','Draw up correct dose using aseptic technique; expel air bubbles','Change needle after drawing up from vial (use a fresh needle for injection)','Identify patient using 2 identifiers; explain procedure; ensure privacy','Select injection site â€” preferred sites: ventrogluteal (safest, least risk of nerve/vessel injury), vastus lateralis (thigh), or deltoid (arm)','Ventrogluteal landmark: place heel of hand on greater trochanter, index finger on ASIS, middle finger toward iliac crest â€” inject in the V-shaped space','Vastus lateralis: middle third of outer thigh','Deltoid: 3 finger-widths below acromion process â€” use only for small volumes â‰¤1mL','Clean site with alcohol swab using circular motion from centre outward; allow to air dry 30 seconds','Stretch skin taut (Z-track technique recommended â€” pull skin 2â€“3cm laterally before injecting)','Insert needle at 90Â° angle with smooth, swift motion','Aspiration: check local policy â€” not routinely required for most IM sites or vaccines','Inject medication slowly and steadily (1mL per 10 seconds)','Withdraw needle at same angle; release Z-track skin immediately on withdrawal','Apply gentle pressure with dry swab â€” do NOT rub (prevents tissue trauma and medication tracking)','Discard needle and syringe directly into sharps container â€” DO NOT recap','Remove gloves; perform hand hygiene','Observe patient for 15â€“30 minutes for adverse reactions (especially for first doses and vaccines)','Document: drug name, dose, route, injection site, time, patient response, and your signature']},

  {id:'iv_cannula',name:'5. Intravenous Cannulation',steps:['Verify physician order for IV access; confirm reason and type of access needed','Gather supplies: IV cannula (appropriate gauge â€” 18G general, 14â€“16G for rapid infusion, 22â€“24G for paediatrics/elderly), tourniquet, alcohol/chlorhexidine swab, transparent dressing, IV extension set, 10mL normal saline flush, tape, gloves, sharps bin','Perform hand hygiene; apply non-sterile gloves','Identify patient using 2 identifiers; explain procedure and obtain consent','Assess veins: inspect both arms â€” prefer forearm veins (cephalic, basilic, median cubital); avoid hands and antecubital fossa if possible (restrict joint movement)','Position patient comfortably; keep limb at or below heart level to promote venous filling','Apply tourniquet 10â€“15cm proximal to intended site; ask patient to pump fist gently','Palpate selected vein â€” feel for bouncy, compressible vessel; avoid valves (hard knots) and bifurcations','Cleanse site with chlorhexidine or 70% alcohol swab using back-and-forth friction for 30 seconds; allow to air dry fully â€” do not fan or blow','Stabilise vein by applying traction distal to insertion site with non-dominant thumb','Hold cannula bevel-up at 15â€“30Â° angle to skin; warn patient of a sharp scratch','Insert cannula through skin and into vein; watch for blood flashback in flashback chamber','Lower cannula angle to near parallel to skin on flashback; advance 2â€“3mm further to ensure catheter is in vessel','Hold needle still; advance plastic cannula fully off needle into vein','Release tourniquet; apply gentle pressure over vein tip with finger to prevent blood spill','Withdraw needle completely; immediately activate safety shield and dispose in sharps bin','Attach primed extension set or bung; flush with 10mL normal saline using push-pause technique â€” observe for swelling or pain (indicates extravasation)','Apply transparent semi-permeable dressing; secure tubing with tape','Label cannula site with date, time, gauge size, and your initials','Dispose of all sharps safely; remove gloves; perform hand hygiene','Document: site, gauge, number of attempts, patient tolerance, flush patency','Educate patient: report immediately if site becomes painful, swollen, or red','Check cannula site every shift and re-site every 72â€“96 hours or per hospital policy']},

  {id:'iv_infusion',name:'6. IV Infusion Setup',steps:['Verify physician order: fluid type, volume, and infusion rate (mL/hr or drop rate)','Gather supplies: prescribed IV fluid bag, administration set (standard or blood giving set), IV stand/pump, alcohol swab, gloves','Perform hand hygiene','Check IV fluid bag: drug name, concentration, volume, expiry date, clarity (no cloudiness, particles, or discolouration), and integrity of bag (no leaks)','Check compatibility: confirm fluid is appropriate for patient condition and not contraindicated with concurrent medications','Identify patient using 2 identifiers; explain procedure','Open administration set packaging; close roller clamp fully before use','Remove protective cap from fluid bag port without contaminating spike','Insert spike of administration set firmly into bag port with a twisting motion â€” do not contaminate spike','Hang bag on IV stand at appropriate height (60â€“100cm above insertion site)','Squeeze drip chamber to fill halfway â€” never run dry','Open roller clamp slowly to prime the entire administration set; remove all air bubbles','Close clamp once primed; attach sterile cap to distal end if not connecting immediately','Don gloves; cleanse cannula port with alcohol swab and allow to dry','Connect primed IV administration set to cannula port or IV bung','Open clamp; count drops per minute to verify correct flow rate, OR set infusion pump to prescribed mL/hr rate','Formula for drop rate: Volume (mL) Ã· Time (hrs) Ã· 60 Ã— Drop factor (typically 20 drops/mL) = drops per minute','Secure tubing so it does not pull on cannula site','Label administration set with date and time â€” change every 72 hours (or 24 hours for blood products and lipids)','Monitor infusion site every 30â€“60 minutes for signs of infiltration (swelling, coolness, pain) or phlebitis (redness, warmth, induration along vein)','Observe patient for adverse reactions to the fluid','Document: fluid type, volume, rate, start time, cannula site assessment, and your signature','Report any signs of fluid overload: dyspnoea, peripheral oedema, raised JVP, crackles on auscultation']},

  {id:'wound_dressing',name:'7. Wound Dressing Change',steps:['Review physician order, wound care plan, and previous wound assessment documentation','Gather supplies: sterile dressing pack, appropriate dressing material (per wound type), normal saline or wound irrigation solution, sterile gloves, clean gloves, apron, waste bag, tape','Perform hand hygiene; apply apron and clean gloves','Prepare a clean work surface; open sterile dressing pack using corners only to maintain sterility','Identify patient using 2 identifiers; explain procedure; ensure privacy and adequate lighting','Position patient comfortably to expose wound; protect bed with waterproof pad','Remove old dressing: gently loosen tape edges toward wound; remove dressing in direction of hair growth to reduce pain','Observe old dressing: note amount, colour, consistency, and odour of exudate','Remove gloves; perform hand hygiene; apply sterile gloves','Assess wound: measure dimensions (length Ã— width Ã— depth in cm), note wound bed colour (pink/red = granulating, yellow = sloughy, black = necrotic), edges, surrounding skin condition','Irrigate wound with normal saline using 10â€“20mL syringe and 19G angiocat â€” irrigate at low pressure to remove debris without damaging tissue','Gently dry wound edges and periwound skin with sterile gauze','Signs of infection to report: increased pain, warmth, erythema >2cm from wound edges, purulent exudate, malodour, fever, delayed healing','Apply appropriate primary dressing directly to wound bed (e.g., non-adherent contact layer, hydrocolloid, foam, alginate â€” per wound assessment)','Apply secondary dressing if needed to manage exudate and protect the primary layer','Secure dressing with tape or bandage â€” avoid excessive pressure; ensure no tension on surrounding skin','Label dressing with date, time, and your initials','Remove gloves; dispose of all waste in clinical waste bag; perform hand hygiene','Document: wound description (size, depth, bed, edges, exudate, periwound), dressing type used, patient tolerance, and any referrals made','Evaluate wound healing progress at each dressing change; escalate concerns to tissue viability nurse or physician']},

  {id:'urinary_cath',name:'8. Urinary Catheterization',steps:['Verify physician order; confirm indication (urinary retention, output monitoring, surgery, bladder irrigation)','Gather supplies: sterile catheterisation pack, appropriate catheter (Foley â€” size 12â€“16Fr for female, 14â€“18Fr for male), sterile gloves, sterile drapes, antiseptic solution (chlorhexidine or normal saline), lubricating gel (lignocaine gel for male), drainage bag, sterile water for balloon inflation (check catheter balloon size â€” typically 10mL)','Perform hand hygiene','Identify patient using 2 identifiers; explain procedure sensitively; ensure privacy; obtain consent','Female position: supine with knees flexed and hips abducted (dorsal recumbent); Male position: supine with legs slightly apart','Apply clean gloves; wash perineal area with soap and water; remove clean gloves; perform hand hygiene','Open sterile catheterisation pack using aseptic non-touch technique (ANTT); arrange contents without contaminating sterile field','Apply sterile gloves','Drape patient with sterile fenestrated drape exposing only the genitalia','FEMALE: Separate labia minora with non-dominant hand (this hand is now contaminated â€” do not use for catheter insertion); cleanse urethral meatus and labia with antiseptic swabs using single downward strokes from front to back â€” use fresh swab for each stroke','MALE: Retract foreskin with non-dominant hand (this hand is now contaminated); cleanse glans in circular motion from meatus outward using antiseptic swabs; instil 10mL lignocaine gel into urethra and wait 3â€“5 minutes','Pick up catheter with dominant sterile hand; hold 5â€“7cm from tip','FEMALE: Insert catheter 5â€“7cm until urine flows; advance a further 2â€“3cm before inflating balloon','MALE: Insert catheter the full length (up to 20cm) until urine flows; advance a further 5cm before inflating balloon â€” never inflate if resistance is felt or patient complains of sudden pain','Inflate balloon slowly with the correct amount of sterile water (per label); if patient reports pain, deflate immediately â€” catheter may not be in bladder','Gently withdraw catheter until slight resistance is felt (balloon now seated at bladder neck)','Replace foreskin in male patients to prevent paraphimosis','Connect catheter to drainage bag; secure catheter to inner thigh with catheter holder â€” allow enough length to prevent traction','Position drainage bag below bladder level at all times â€” never on the floor','Note colour, clarity, and initial volume of urine drained','Remove gloves; perform hand hygiene','Document: indication, catheter size, balloon volume, drainage bag connection, initial urine output, colour, and patient tolerance','Educate patient: importance of keeping bag below bladder, reporting pain/no drainage/bypassing']},

  {id:'ng_tube',name:'9. Nasogastric (NG) Tube Insertion',steps:['Verify physician order: confirm indication (feeding, drainage, medication administration, gastric decompression)','Gather supplies: NG tube (appropriate size â€” 10â€“14Fr for feeding, 16â€“18Fr for drainage), lubricating gel, 50mL syringe, pH indicator strips or litmus paper, tape, gloves, tissues, vomit bowl, stethoscope, glass of water with straw (if patient able to swallow)','Perform hand hygiene; apply gloves','Identify patient using 2 identifiers; explain procedure; ensure privacy','Assess nostrils: ask patient to breathe through each nostril separately â€” select more patent nostril; avoid if nasal injury, basal skull fracture, or recent nasal surgery','Measure tube length (NEX measurement): tip of Nose to Earlobe to Xiphisternum â€” mark this point on tube with tape or note the centimetre marking','Position patient upright at 45â€“90Â° with neck slightly flexed (chin toward chest)','Lubricate distal 10â€“15cm of tube with water-soluble lubricant','Gently insert tube through selected nostril, directing downward and backward (not upward) along nasal floor','Advance tube to nasopharynx; ask conscious patient to swallow repeatedly or sip water through straw as tube is advanced â€” swallowing propels tube into oesophagus','Advance tube to the pre-measured NEX mark while patient continues swallowing â€” STOP immediately if patient coughs violently, becomes cyanosed, or cannot speak (tube may be in trachea)','Temporarily secure tube to nose with tape','Verify placement â€” gold standard is CHEST X-RAY confirming tube tip below diaphragm in gastric shadow','If X-ray not immediately available, aspirate stomach contents and test pH with indicator strip: pH â‰¤5.5 confirms gastric placement (blue litmus paper turns red)','NEVER use auscultation (air insufflation) alone to confirm placement â€” this is unreliable and not a safe method','Once placement confirmed: secure tube firmly to nose and cheek with tape; document external length at nostril','Connect to suction, drainage, or feeding as ordered','Document: nostril used, NEX measurement, tube size, external length at nostril, confirmation method and result, patient tolerance','Check placement before EVERY use (feeding, medication, drainage)']},

  {id:'o2_therapy',name:'10. Oxygen Therapy Administration',steps:['Verify physician order: prescribed flow rate, delivery device, and target SpOâ‚‚ range','Perform hand hygiene','Gather equipment: prescribed Oâ‚‚ delivery device, Oâ‚‚ flowmeter and tubing, pulse oximeter, emergency cylinder if appropriate','Check Oâ‚‚ source: wall outlet (confirm it is oxygen â€” green/white labelling) or cylinder (check gauge â€” minimum 500psi/34 bar for use)','Identify patient using 2 identifiers; explain procedure','Obtain baseline SpOâ‚‚, respiratory rate, and level of consciousness before starting Oâ‚‚','Select appropriate delivery device based on prescribed FiOâ‚‚:','â€” Nasal Cannula: 1â€“6 L/min â†’ FiOâ‚‚ 24â€“44% (low flow, comfortable for long-term use)','â€” Simple Face Mask: 5â€“10 L/min â†’ FiOâ‚‚ 35â€“55% (minimum 5L/min to prevent COâ‚‚ rebreathing)','â€” Non-Rebreather Mask (NRB): 10â€“15 L/min â†’ FiOâ‚‚ up to 80â€“90% (for hypoxic emergency)','â€” Venturi Mask: fixed FiOâ‚‚ (24%, 28%, 31%, 35%, 40%, 60%) â€” preferred for COPD patients with hypoxic drive','Attach appropriate tubing to flowmeter; set flow to prescribed rate BEFORE applying to patient','Apply device to patient â€” Nasal cannula: prongs curve downward into nares; Face mask: mould metal clip over nose bridge, ensure airtight fit over nose and mouth','Check for pressure areas: behind ears, over cheekbones â€” use padding/ear protectors if needed for long-term Oâ‚‚','Reassess SpOâ‚‚ within 5 minutes of starting Oâ‚‚; target range per order (typically 94â€“98% adults; 88â€“92% for COPD/type II respiratory failure)','Monitor patient response every 30 minutes: SpOâ‚‚, respiratory rate, depth, work of breathing, level of consciousness, colour','Use humidification for flow rates >4L/min via mask or if patient has dry/irritated airways','COPD caution: target SpOâ‚‚ 88â€“92% â€” high-flow Oâ‚‚ can suppress hypoxic drive in type II respiratory failure','NEVER abruptly discontinue Oâ‚‚ in hypoxic patient â€” wean gradually under medical supervision','Document: device used, flow rate, SpOâ‚‚ before and after, patient response, and time','Report: SpOâ‚‚ below target range, increased work of breathing, altered consciousness, or cyanosis immediately']},

  {id:'blood_transfusion',name:'11. Blood Transfusion',steps:['Verify physician order: blood product type (packed red cells, FFP, platelets, cryoprecipitate), volume, and rate','Confirm informed consent has been obtained and documented by the prescribing physician','Perform hand hygiene','Obtain baseline observations: temperature, pulse, blood pressure, respiratory rate, SpOâ‚‚ â€” document before transfusion begins','Gain IV access: confirm patent cannula (18G or larger recommended for packed red cells); check site for signs of phlebitis or infiltration','Request blood product from blood bank â€” note: blood must be collected and used within 30 minutes of release (packed red cells) or as per product guidelines','TWO-NURSE VERIFICATION at bedside â€” both nurses independently check:','â€” Patient full name and date of birth against blood band and blood product label','â€” Hospital/blood bank ID number on blood band, product label, and compatibility report','â€” ABO and Rh blood group â€” must match on all three documents','â€” Expiry date and time of blood product','â€” Product unit number â€” must be identical on bag and compatibility form','Inspect blood bag: check for clots, unusual discolouration, turbidity, leaks, or damage â€” do not use if any abnormality found','Prime blood administration set (use ONLY a blood-specific giving set with integral 170â€“200 micron filter) with 0.9% Normal Saline â€” no other IV fluid','Connect primed set to cannula; start infusion SLOWLY for first 15 minutes at 25â€“50mL/hr','Remain with patient for the entire first 15 minutes â€” the majority of acute transfusion reactions occur in this window','Reassess observations at 15 minutes; if no reaction, increase to prescribed rate','Continue monitoring observations every 30 minutes during transfusion and on completion','Signs of acute transfusion reaction â€” STOP TRANSFUSION IMMEDIATELY if any develop:','â€” Fever (rise >1Â°C), rigors, chills','â€” Urticaria, rash, pruritus','â€” Dyspnoea, wheeze, stridor','â€” Hypotension, tachycardia','â€” Flank/back pain, haemoglobinuria (red/dark urine) â€” suspect haemolytic reaction','â€” Facial flushing, anxiety, sensation of impending doom','If reaction: keep IV open with normal saline, call physician, return blood bag to blood bank with fresh blood samples for investigation, complete incident form','Complete each unit within 4 hours of removal from blood bank refrigeration','On completion: flush cannula with normal saline; document transfusion completion and post-transfusion observations','Document: unit number, product type, volume, start and finish time, observations throughout, any adverse events']},

  {id:'bed_bath',name:'12. Bed Bath',steps:['Explain procedure to patient; obtain consent; assess ability to participate in self-care','Gather supplies: wash basin, warm water (test temperature 41â€“43Â°C / comfortably warm on inner wrist), soap, 2â€“3 washcloths, bath towels, clean linen, clean patient gown/pyjamas, toiletries (deodorant, lotion, comb), gloves, apron','Perform hand hygiene; apply gloves and apron','Ensure privacy: close curtains, doors; keep patient covered with bath blanket throughout â€” expose only the body part being washed','Adjust bed to comfortable working height to prevent back injury; lower side rail on working side','Offer patient a bedpan or urinal before starting â€” hygiene care stimulates the urge to void','Remove patient clothing; keep bath blanket in place for warmth and dignity','Start with face â€” use a clean face cloth; wash eyes first (inner to outer canthus using clean part of cloth for each eye) to prevent cross-contamination; wash face, neck, and ears; pat dry','Change water and washcloth; wash neck, chest, and abdomen using long, firm strokes; rinse thoroughly; pat dry; apply deodorant to axillae','Wash each arm from distal to proximal (hand to shoulder); pay attention to axillae; support limb throughout; dry well','Wash hands: soak in basin if possible; clean between fingers and under nails','Change water before washing lower body','Wash legs from ankle to thigh; avoid circular motions on varicose veins; dry thoroughly, especially between toes; inspect feet and nails','Change water again before perineal care â€” keep patient covered; perform perineal care (see Skill 18: Perineal Care)','Assist patient to lateral position; wash back from nape of neck to buttocks using long strokes; inspect skin for pressure areas (redness, blanching, breakdown)','Apply prescribed barrier cream or moisturiser to heels, sacrum, and other at-risk pressure areas','Assist patient into clean gown; change bed linen using occupied bed-making technique â€” roll dirty linen away from patient; never shake linen','Reposition patient comfortably; restore call bell within reach','Empty and clean basin; dispose of used linen in soiled linen bag; remove gloves; perform hand hygiene','Document: skin assessment findings (any redness, breakdown, oedema), patient tolerance, and pressure injury prevention measures taken']},

  {id:'oral_care',name:'13. Oral Care',steps:['Assess patient: level of consciousness, ability to cooperate, swallowing reflex, presence of dentures, oral condition (dryness, ulcers, bleeding, thrush, odour)','Gather supplies: toothbrush (small-headed, soft-bristled), toothpaste, dental floss, mouthwash (if ordered), disposable cup, water, receiver/kidney dish, suction (if patient unable to expectorate), gloves, apron, Yankauer suction catheter for unconscious patients','Perform hand hygiene; apply gloves and apron','Assist patient to semi-Fowler position (30â€“45Â°) or lateral position for unconscious patients â€” NEVER flat for unconscious patients (risk of aspiration)','Place towel under chin to protect clothing and linen','For conscious cooperative patients: apply toothpaste to brush; hand to patient or assist them to brush all surfaces of teeth (outer, inner, chewing surfaces) for 2 minutes; brush tongue gently from back to front','Offer water to rinse; provide kidney dish to expectorate; offer mouthwash if prescribed (do not swallow)','For patients with dentures: remove upper plate first, then lower; place in labelled denture pot with cool water or denture-cleaning solution â€” never hot water (causes warping); clean with denture brush and paste; rinse; reinsert or store as per patient preference','For unconscious or ventilated patients (ETT/trach care): use Yankauer suction to remove secretions before, during, and after oral care; use small toothbrush or foam swab with CHX (0.12% chlorhexidine gluconate) to clean all oral surfaces; suction regularly; apply lip moisturiser to prevent cracking','Inspect oral cavity throughout: note any changes â€” white plaques (candida), ulcers, bleeding gums, tooth fractures, mucosal breakdown â€” report and document','For dry mouth/xerostomia: apply water-based mouth moisturiser to mucosa; offer small sips of water if safe to swallow; avoid glycerine swabs (desiccate mucosa further)','Reposition patient; remove towel; ensure comfort','Rinse and clean equipment; dispose of single-use items; store denture pot labelled; remove gloves; perform hand hygiene','Document: oral assessment findings, care given, denture management, any abnormalities reported, patient tolerance']},

  {id:'feeding_dependent',name:'14. Feeding a Dependent Patient',steps:['Confirm patient is permitted oral intake: check medical/dietary orders for diet type (regular, soft, pureed, thickened fluids â€” IDDSI Level), texture modifications, and allergies','Obtain speech and language therapy (SALT) assessment if swallowing competency is unclear or patient has history of aspiration','Perform hand hygiene','Assemble meal tray: check patient name against tray label; confirm diet type is correct; check temperature of food (comfortably warm, not scalding)','Gather supplies: napkin/bib, cup with appropriate spout or straw, adaptive cutlery if needed, suction on standby if high aspiration risk','Assist patient to sit upright at 90Â° (fully upright if possible) â€” or at minimum 45Â° if unable to sit; ensure neck is slightly flexed (chin tuck position if prescribed)','Provide oral hygiene before feeding if not recently done','Position yourself at eye level to patient â€” sit down; do not rush; this is a social interaction as well as a clinical task','Show patient the food and describe contents; offer choice of what to eat first','Offer small bites using teaspoon-sized amounts (approximately 5mL); do not use a heaped spoon','Place food on the stronger side of mouth if patient has one-sided weakness (hemiplegia)','Allow patient adequate time to chew and swallow completely before offering the next spoonful','Watch for signs of dysphagia during feeding: coughing or choking, wet/gurgly voice after swallowing, food or fluid coming from nose, repeated throat clearing, food pocketing in cheeks, facial grimacing, drooling','STOP feeding if any signs of aspiration â€” position patient upright, allow coughing to clear, assess; if distressed, call for assistance','Alternate between solid food and fluid; offer fluids in appropriate viscosity (per SALT recommendation)','Encourage patient to participate as much as possible â€” support independence; do not rush','After meal: offer oral hygiene (rinse, brush if possible)','Keep patient upright for minimum 30 minutes post-meal to reduce aspiration risk','Document: food and fluid intake (amount consumed as percentage or mL), any signs of dysphagia, patient tolerance, and SALT recommendations followed']},

  {id:'enema',name:'15. Enema Administration',steps:['Verify physician order: type of enema (cleansing â€” e.g., soap and water; retention â€” e.g., arachis oil; medicated â€” e.g., phosphate; or small-volume micro-enema), volume, and temperature','Explain procedure to patient; obtain consent; ensure privacy â€” this is an intimate procedure requiring sensitivity','Assess: when patient last had a bowel motion, current medications (especially anticoagulants), bowel sounds, abdominal tenderness, contraindications (recent bowel surgery, bowel obstruction, colorectal cancer, inflammatory bowel disease â€” confirm with physician)','Gather supplies: prescribed enema solution (check temperature: 37â€“40Â°C for cleansing enema â€” test on inner wrist), enema tubing or pre-packaged micro-enema, lubricant, disposable gloves, apron, protective pad, commode or bedpan within easy reach, tissues','Perform hand hygiene; apply gloves and apron','Position patient in left lateral (Sims) position with right knee flexed toward chest â€” this follows the anatomical direction of the sigmoid colon for easier instillation','Place protective pad under patient to protect bed linen','Expose only the gluteal area; maintain patient dignity throughout','Prime tubing to remove air (air can cause discomfort and cramping)','Lubricate tip of rectal tube generously (3â€“4cm) with water-soluble lubricant','Ask patient to take a slow, deep breath and relax the anal sphincter; gently insert tip 7â€“10cm into rectum in direction of umbilicus â€” do not force; if resistance felt, stop and reassess','Open clamp or squeeze micro-enema container slowly; instil solution gradually (over 5â€“10 minutes for large volume enemas) â€” slow administration reduces cramping','Encourage patient to retain solution: retention enema 15â€“30 minutes; cleansing enema 5â€“10 minutes if possible','If patient cannot retain: clamp tube, apply gentle gluteal pressure, reassure patient','Withdraw tubing slowly on completion; apply gentle pressure over anus with tissue to help retention','Assist patient to commode, toilet, or bedpan â€” stay within call distance','Assess result: note faecal output (amount, colour, consistency, any blood or unusual content)','Clean perineal area; assist patient back to comfortable position','Dispose of equipment in clinical waste; remove gloves; perform hand hygiene','Document: type and volume of enema administered, patient tolerance, result (output description), time, and any adverse effects']},

  {id:'trach_care',name:'16. Tracheostomy Care',steps:['Gather supplies: tracheostomy care kit (sterile saline or sterile water, sterile gauze, sterile cotton-tipped applicators), inner cannula (spare of same type/size if applicable), sterile gloves, clean gloves, apron, tracheostomy ties or velcro trach holder, suction equipment (suction unit, sterile suction catheters, sterile gloves, sterile saline for flushing), spare tracheostomy tube of same type and size at bedside at all times, pulse oximeter','Perform hand hygiene; apply apron and clean gloves','Explain procedure to patient; provide reassurance; establish non-verbal communication system if patient cannot speak','SUCTION FIRST (before inner cannula removal): pre-oxygenate if SpOâ‚‚ <95% or per protocol; apply sterile gloves for suction; insert suction catheter without suction to appropriate depth; apply suction on withdrawal using rotating technique; each pass â‰¤10â€“15 seconds; allow recovery breaths between passes; limit to 3 passes','Remove soiled tracheostomy dressing and observe stoma: note redness, swelling, excoriation, granulation tissue, discharge (colour, amount, odour)','If disposable inner cannula: remove, discard, replace with new one; if non-disposable: remove, clean with sterile saline using pipe cleaners/brushes, rinse thoroughly, replace; ensure inner cannula locks in place','Clean stoma site with sterile saline-soaked gauze using gentle outward circular motions from stoma edge; remove encrusted secretions from skin folds and flange â€” use cotton-tipped applicators for creases','Apply prescribed stoma barrier cream or moisture-barrier film if excoriation present','Change tracheostomy dressing: apply sterile pre-cut trach split-gauze (NEVER cut gauze â€” loose fibres can be inhaled causing aspiration)','Change tracheostomy ties/velcro holder: ONE NURSE HOLDS THE TUBE at all times while ties are changed; new ties in place before removing old ones; tension check â€” one finger only should fit under ties; DO NOT leave tube unsecured at any point','Assess tube position: tube should be sitting centrally; mark external length on tube to detect migration','Post-care: reassess SpOâ‚‚, breathing pattern, and patient comfort','Restock bedside emergency equipment: spare tracheostomy tube (same size and one size smaller), spare inner cannula, 10mL syringe, scissors, tracheal dilators','Document: stoma assessment, inner cannula status, tie change, suction details (secretion colour/amount/consistency), SpOâ‚‚, and patient tolerance']},

  {id:'airway_suction',name:'17. Airway Suctioning',steps:['Assess need for suctioning: visible secretions in airway, audible gurgling or rattling sounds, SpOâ‚‚ decline without other cause, increased work of breathing, patient inability to clear secretions by coughing, after nebulisation or chest physiotherapy','Do NOT suction routinely on a schedule â€” suction only when clinically indicated','Verify suction unit function: set pressure to 80â€“120 mmHg for adults (60â€“80 mmHg for children; 40â€“60 mmHg for neonates)','Gather supplies: sterile suction catheter (correct size â€” catheter should be no wider than half the internal diameter of airway), sterile gloves, sterile saline for flushing, protective goggles, apron','Perform hand hygiene; apply apron and goggles','Explain procedure to patient; position patient: semi-recumbent for oropharyngeal; supine with neck extended for nasopharyngeal','Pre-oxygenate: if SpOâ‚‚ <95% or high-risk, administer 100% Oâ‚‚ for 30â€“60 seconds before each pass (via NRB mask or hyperoxygenate via ventilator)','Apply sterile gloves â€” maintain dominant hand as sterile throughout; non-dominant hand is non-sterile','Pick up suction catheter with sterile dominant hand; connect to suction tubing with non-sterile hand','OROPHARYNGEAL SUCTIONING: insert catheter into mouth along side; advance to pharynx; apply suction intermittently on withdrawal with gentle rotation; do not insert beyond tongue base blindly','NASOPHARYNGEAL SUCTIONING: lubricate catheter; insert through patent nostril directing posteriorly and inferiorly (not upward) to nasopharynx; apply suction on withdrawal only','TRACHEAL SUCTIONING (via tracheostomy/ETT): insert catheter WITHOUT suction to carina or slight resistance; withdraw 1cm; apply suction with thumb over port; rotate and withdraw over 10â€“15 seconds maximum','Each suctioning pass must NOT exceed 10â€“15 seconds â€” prolonged suctioning causes hypoxia and mucosal trauma','Allow patient to recover with Oâ‚‚ and 3â€“5 normal breaths between passes; reassess SpOâ‚‚','Limit to 3 passes per suctioning episode; flush catheter with sterile saline between passes','Post-suctioning: reassess SpOâ‚‚, breath sounds, breathing pattern, and patient comfort; administer supplemental Oâ‚‚ if SpOâ‚‚ remains low','Dispose of catheter after single use â€” NEVER reinsert used catheter','Remove gloves; perform hand hygiene','Document: indication for suction, number of passes, secretion characteristics (colour â€” clear/white/yellow/green/brown/blood-stained; consistency â€” thin/thick/tenacious; amount â€” scant/moderate/large), SpOâ‚‚ before and after, patient tolerance, any adverse effects']},

  {id:'perineal_care',name:'18. Perineal Care',steps:['Explain procedure clearly and sensitively; obtain consent; acknowledge that this is an intimate procedure and reassure patient about dignity and privacy','Perform hand hygiene; apply gloves and apron','Close curtains/door; expose only the perineal area â€” keep all other areas covered with bath blanket','Gather supplies: warm water, soap or prescribed perineal wash solution, washcloths (use separate cloth for each wipe), clean towel, protective pad, gloves, clean incontinence pad or underwear if applicable','Assess skin condition before starting: note any redness, excoriation, rash, discharge, odours, wounds, or signs of moisture-associated skin damage (MASD)','FEMALE PERINEAL CARE: with non-dominant hand, separate labia; using dominant hand, cleanse labia majora from anterior to posterior (pubic symphysis toward anus) using single firm strokes â€” ALWAYS front to back; use a fresh part of the cloth or a new cloth for each stroke; never wipe back-to-front (prevents faecal contamination of urethra and vagina); cleanse labia minora in same direction; rinse thoroughly; dry gently by patting (do not rub â€” rub friction damages fragile skin)','MALE PERINEAL CARE: retract foreskin (if present) before cleansing; cleanse glans and urethral meatus in circular motion from centre outward; cleanse shaft of penis using downward strokes; retract scrotum and cleanse scrotal folds; rinse thoroughly; REPLACE FORESKIN after cleaning â€” failure to do so causes paraphimosis (entrapment causing ischaemia)','BOTH GENDERS â€” Anal area: assist patient to lateral position; separate buttocks; cleanse perianal area from perineum toward coccyx using single anterior-to-posterior strokes; rinse; pat dry thoroughly','Inspect skin: report and document any new redness, excoriation, lesions, discharge, unusual odour, or pressure injury to skin around sacrum/coccyx','Apply prescribed barrier cream or moisture-barrier film if skin redness, excoriation, or incontinence-associated dermatitis (IAD) is present','Apply clean incontinence pad, catheter bag securely attached, or clean underwear as appropriate','If urinary catheter present: perineal care should be performed twice daily and after any episode of incontinence; cleanse around catheter at meatus with plain water â€” antiseptic solutions and vigorous cleaning can introduce bacteria','Reposition patient comfortably; restore call bell','Remove gloves; dispose of all waste in clinical waste; perform hand hygiene','Document: perineal skin condition, any abnormalities found, care provided, and products applied']},

  {id:'bsl',name:'19. Blood Glucose Monitoring',steps:['Verify physician order: frequency of blood glucose monitoring and target range','Gather supplies: calibrated glucometer (check QC log), test strips (check expiry â€” do not use expired strips), lancet device with new lancet, gloves, alcohol swab, cotton ball or gauze','Perform hand hygiene; apply gloves','Identify patient using 2 identifiers; explain procedure','Turn on glucometer; insert a test strip â€” confirm code matches strip vial if required by device','Warm patient finger: ask patient to lower hand below heart level and gently massage finger toward tip to improve perfusion â€” cold, poorly perfused fingers give falsely low readings','Select an alternate site â€” use sides of fingers, not the fingertip centre (less painful); rotate sites systematically; avoid thumb and index finger','Clean selected site with alcohol swab; ALLOW TO DRY COMPLETELY â€” alcohol residue can falsely alter glucose readings','Load lancet device with new lancet; set depth appropriate for patient (deeper for callused fingers, shallower for paediatrics)','Perform the finger prick: press lancet firmly to side of fingertip and activate','Gently squeeze finger from base to tip to encourage blood drop â€” DO NOT milk aggressively (haemolyses sample, giving falsely low reading); wipe away first drop with clean gauze (first drop is diluted with interstitial fluid)','Touch test strip to second blood drop â€” strip will draw sample by capillary action; do not smear','Read result within the time window specified by the device; note: most strips become invalid after 15â€“60 seconds','Apply light pressure to puncture site with cotton ball','Record result in patient chart, medication administration record, and on the glucometer log','Normal blood glucose ranges: Fasting: 3.9â€“5.5 mmol/L; Post-prandial (2hr): <7.8 mmol/L; In-hospital target varies (typically 6â€“10 mmol/L for most inpatients)','HYPOGLYCAEMIA: <3.9 mmol/L â€” if conscious give 15â€“20g fast-acting carbohydrate (orange juice, glucose tablets, Dextrose gel); recheck in 15 minutes; notify physician; document','HYPERGLYCAEMIA: >11.1 mmol/L (or as per patient target) â€” notify physician; administer insulin per sliding scale or as ordered; monitor for ketones in type 1 diabetes; document','Dispose of lancet immediately in sharps container; remove gloves; perform hand hygiene','Document: blood glucose result, time, patient symptoms, interventions taken, and physician notification if abnormal']},

  {id:'cpr',name:'20. Cardiopulmonary Resuscitation (CPR)',steps:['ENSURE SCENE SAFETY: check surroundings for hazards (electricity, water, traffic) before approaching victim; protect yourself first','CHECK RESPONSIVENESS: approach safely; tap both shoulders firmly and shout loudly â€” "Can you hear me? Are you okay?"','CALL FOR HELP: if no response, shout for help; send a specific person to call emergency response (999/112 or activate hospital crash call) and bring AED; do not leave patient alone if solo rescuer â€” use phone on speaker','CHECK BREATHING AND PULSE simultaneously for NO MORE THAN 10 SECONDS: look for chest rise, feel for carotid pulse (2 fingers in groove between trachea and sternocleidomastoid muscle)','If PULSE PRESENT but NOT BREATHING: give rescue breaths only (1 breath every 5â€“6 seconds = 10â€“12 breaths/min); recheck pulse every 2 minutes','If NO PULSE (or uncertain): begin CHEST COMPRESSIONS immediately â€” do not delay','CHEST COMPRESSION TECHNIQUE: place patient on firm flat surface; kneel at patient side; interlock hands, heel of dominant hand on LOWER HALF of sternum (not over xiphoid â€” risk of liver laceration); keep arms straight; compress STRAIGHT DOWN at least 5â€“6cm (adults) at 100â€“120 per minute; allow full chest RECOIL after each compression (do not lean)','COUNT compressions aloud to maintain rate; use a metronome app if available','30 COMPRESSIONS : 2 BREATHS cycle (30:2 ratio for 1â€“2 rescuer adult CPR)','RESCUE BREATHS: tilt head, lift chin; pinch nose closed; create airtight seal over mouth; give breath over 1 second watching for chest rise; 2 breaths maximum â€” do not interrupt compressions for more than 10 seconds','If breaths do not go in: reposition head and retry once; if still unsuccessful, continue compressions without breaths (compression-only CPR acceptable)','APPLY AED AS SOON AS AVAILABLE: power on; attach pads as illustrated (right subclavicular and left lateral chest); follow voice prompts','CLEAR before analysis and shock: shout "STAND CLEAR" and visually confirm no one is touching patient before delivering shock','IMMEDIATELY RESUME COMPRESSIONS after shock â€” do not pause to check pulse; resume 30:2','SWITCH compressors every 2 minutes if possible to prevent fatigue â€” maintain minimal interruption in compressions','Continue CPR until: return of spontaneous circulation (ROSC â€” patient moves, coughs, or begins breathing normally), advanced life support team takes over, patient is confirmed deceased by a physician, or you are physically unable to continue','ROSC management: place in recovery position if breathing spontaneously; maintain airway; administer Oâ‚‚; monitor vitals continuously; document time of ROSC','Document: time of cardiac arrest discovered, time CPR started, number of rescuers, AED use (number of shocks delivered), time of ROSC or time of discontinuation, and handover to receiving team']}
];
// Admin-added skills (loaded from localStorage)
let _nvCustomSkills=[];
function nvAllSkills(){ return [...NV_SKILLS_DATA,..._nvCustomSkills]; }
function nvLoadCustomSkills(){
  try{ _nvCustomSkills=JSON.parse(localStorage.getItem('nv_custom_skills')||'[]'); }catch(e){ _nvCustomSkills=[]; }
}
function nvSaveCustomSkills(){ try{ localStorage.setItem('nv_custom_skills',JSON.stringify(_nvCustomSkills)); }catch(e){} }
nvLoadCustomSkills();

function nvRenderSkills(filter=''){
  const el=document.getElementById('nvSkillsList');
  if(!el)return;
  const all=nvAllSkills();
  const skills=filter?all.filter(s=>s.name.toLowerCase().includes(filter.toLowerCase())):all;
  if(!skills.length){
    el.innerHTML=`<div class="empty"><div class="empty-ico">ðŸ”</div><div class="empty-t">No skills found</div><div class="empty-s">Try a different search term</div></div>`;
    return;
  }
  el.innerHTML=skills.map(skill=>{
    const state=nvSkillsState[skill.id]||{};
    const done=Object.values(state).filter(Boolean).length,total=skill.steps.length,pct=Math.round((done/total)*100);
    const isCustom=_nvCustomSkills.find(s=>s.id===skill.id);
    return `<div class="skill-card" onclick="nvToggleSkill(this)">
      <div class="skill-header">
        <div style="flex:1;">
          <div class="skill-name">${skill.name}${isCustom?` <span style="font-size:9px;padding:1px 6px;background:rgba(90,173,160,.15);color:var(--accent2);border-radius:10px;font-family:'DM Mono',monospace;vertical-align:middle;">custom</span>`:''}</div>
          <div class="nv-text-xs nv-text-dim nv-mt-8">${done}/${total} steps complete</div>
          <div class="nv-progress-bar" style="margin-top:6px;"><div class="nv-progress-fill" style="width:${pct}%;"></div></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="skill-progress-label">${pct}%</div>
          ${isCustom&&currentRole==='admin'?`<button class="icon-btn" title="Delete" onclick="event.stopPropagation();nvDeleteCustomSkill('${skill.id}')" style="font-size:11px;color:var(--accent4);">ðŸ—‘</button>`:''}
        </div>
      </div>
      <div class="skill-body">
        ${skill.steps.map((step,i)=>{const checked=state[i]||false;return `<div class="skill-step">
          <div class="skill-checkbox${checked?' checked':''}" onclick="nvToggleSkillStep('${skill.id}',${i},this,event)">${checked?'âœ“':''}</div>
          <div class="skill-step-text${checked?' done':''}">${i+1}. ${step}</div>
        </div>`;}).join('')}
        <button class="nv-btn nv-btn-danger nv-btn-sm" style="margin-top:10px;" onclick="nvResetSkill('${skill.id}',event)">Reset Checklist</button>
      </div>
    </div>`;
  }).join('');
}
function nvFilterSkills(q){ nvRenderSkills(q); }
function nvDeleteCustomSkill(id){
  if(!confirm('Delete this custom skill?')) return;
  _nvCustomSkills=_nvCustomSkills.filter(s=>s.id!==id);
  nvSaveCustomSkills();
  nvRenderSkills();
  toast('Skill deleted');
}
function nvToggleSkill(card){card.querySelector('.skill-body').classList.toggle('open');}
function nvToggleSkillStep(skillId,stepIdx,el,e){
  e.stopPropagation();
  if(!nvSkillsState[skillId])nvSkillsState[skillId]={};
  nvSkillsState[skillId][stepIdx]=!nvSkillsState[skillId][stepIdx];
  nvLsSet('nv-skills',nvSkillsState);
  el.classList.toggle('checked',nvSkillsState[skillId][stepIdx]);
  el.textContent=nvSkillsState[skillId][stepIdx]?'âœ“':'';
  el.nextElementSibling.classList.toggle('done',nvSkillsState[skillId][stepIdx]);
  // update progress inline
  const card=el.closest('.skill-card'),skill=nvAllSkills().find(s=>s.id===skillId),state=nvSkillsState[skillId]||{};
  const done=Object.values(state).filter(Boolean).length,pct=Math.round((done/skill.steps.length)*100);
  card.querySelector('.skill-progress-label').textContent=pct+'%';
  card.querySelector('.skill-step-text').closest('.skill-body').previousElementSibling.querySelector('.nv-progress-fill').style.width=pct+'%';
}
function nvResetSkill(skillId,e){e.stopPropagation();nvSkillsState[skillId]={};nvLsSet('nv-skills',nvSkillsState);nvRenderSkills();toast('Checklist reset');}

// â”€â”€â”€ ADMIN: ADD SKILL (Smart Paste Parser) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddSkillModal(){
  const ta = document.getElementById('addSkillPaste');
  if(ta) ta.value = '';
  const preview = document.getElementById('nvSkillParsePreview');
  const status  = document.getElementById('nvSkillParseStatus');
  const saveBtn = document.getElementById('nvSkillSaveBtn');
  if(preview) preview.style.display = 'none';
  if(status)  status.style.display  = 'none';
  if(saveBtn){ saveBtn.style.opacity='.5'; saveBtn.style.pointerEvents='none'; }
  openModal('addSkillModal');
}

// â”€â”€â”€ SMART PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Heuristics to decide if a line is a SKILL TITLE vs a STEP
function _nvIsTitle(line, idx, allLines){
  // Already stripped of leading bullets/numbers elsewhere â€” this checks raw line
  const stripped = line.trim();
  if(!stripped) return false;
  // If ALL_CAPS and reasonably short â†’ title
  if(stripped === stripped.toUpperCase() && stripped.length >= 4 && stripped.length <= 80 && /[A-Z]/.test(stripped)) return true;
  // Ends with colon â†’ title
  if(stripped.endsWith(':')) return true;
  // Has no leading number/bullet but the NEXT line does â†’ likely a title
  const isStep = /^[\d]+[\.\)]\s|^[-â€¢*â†’âœ“âœ”]\s/.test(stripped);
  if(!isStep){
    const next = allLines[idx+1]||'';
    if(/^[\d]+[\.\)]\s|^[-â€¢*â†’âœ“âœ”]\s/.test(next.trim())) return true;
  }
  return false;
}

function nvParseSkillBlob(raw){
  // Split into blocks separated by blank lines
  const blocks = raw.trim().split(/\n{2,}/).map(b=>b.trim()).filter(Boolean);
  const skills = [];

  for(const block of blocks){
    const lines = block.split('\n').map(l=>l.trim()).filter(Boolean);
    if(!lines.length) continue;

    // Try to identify title line(s) vs step lines
    let titleLines = [];
    let stepLines  = [];
    let detectedTitle = false;

    for(let i=0; i<lines.length; i++){
      const raw_l = lines[i];
      const isStepPattern = /^[\d]+[\.\)]\s|^[-â€¢*â†’âœ“âœ”]\s/.test(raw_l);

      if(!detectedTitle){
        // Check if this is a title-like line
        const noNumLine = raw_l.replace(/^\d+[\.\)]\s*/,'').trim();
        const nextLine  = lines[i+1]||'';
        const nextIsStep = /^[\d]+[\.\)]\s|^[-â€¢*â†’âœ“âœ”]\s/.test(nextLine);

        // Is this a stand-alone title? Could be numbered like "21. Hand Hygiene"
        // A numbered title looks like: number dot SPACE text â€” with no further sub-numbering and next is step
        const numberedTitle = /^\d+[\.\)]\s+/.test(raw_l) && nextIsStep;
        const colonTitle    = raw_l.endsWith(':');
        const capsTitle     = noNumLine === noNumLine.toUpperCase() && noNumLine.length >= 4;
        const nextLineIsStep = nextIsStep;

        if(numberedTitle || colonTitle || capsTitle || (!isStepPattern && nextLineIsStep)){
          titleLines.push(noNumLine.replace(/:$/, '').trim());
          detectedTitle = true;
        } else {
          // No clear title â€” treat first non-step line as title or derive from steps
          titleLines.push(noNumLine.replace(/:$/, '').trim());
          detectedTitle = true;
          if(isStepPattern) { stepLines.push(raw_l); } // it was also a step, re-add
        }
      } else {
        stepLines.push(raw_l);
      }
    }

    // Clean title
    const titleRaw = titleLines.join(' ').replace(/^[\d]+[\.\)]\s*/,'').replace(/:$/,'').trim();
    if(!titleRaw) continue;

    // Clean steps: strip leading bullets/numbers, collapse blanks
    const steps = stepLines
      .map(l => l.replace(/^[\d]+[\.\)]\s*/,'').replace(/^[-â€¢*â†’âœ“âœ”]\s*/,'').trim())
      .filter(s => s.length > 2);

    if(steps.length === 0) continue; // no steps detected â€” skip

    skills.push({ name: titleRaw, steps });
  }

  // Fallback: if no blocks separated by blank lines, try to auto-detect
  // title by checking which non-step lines appear before step runs
  if(skills.length === 0){
    const lines = raw.trim().split('\n').map(l=>l.trim()).filter(Boolean);
    let currentSkill = null;
    for(let i=0; i<lines.length; i++){
      const l = lines[i];
      const isStep = /^[\d]+[\.\)]\s|^[-â€¢*â†’âœ“âœ”]\s/.test(l);
      if(isStep){
        if(!currentSkill){ currentSkill = { name:'Untitled Skill', steps:[] }; }
        currentSkill.steps.push(l.replace(/^[\d]+[\.\)]\s*/,'').replace(/^[-â€¢*â†’âœ“âœ”]\s*/,'').trim());
      } else {
        // Non-step line â€” title of new skill
        if(currentSkill && currentSkill.steps.length) skills.push(currentSkill);
        currentSkill = { name: l.replace(/^[\d]+[\.\)]\s*/,'').replace(/:$/,'').trim(), steps:[] };
      }
    }
    if(currentSkill && currentSkill.steps.length) skills.push(currentSkill);
  }

  return skills;
}

// â”€â”€â”€ LIVE PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvSmartSkillPreview(){
  const ta      = document.getElementById('addSkillPaste');
  const raw     = ta ? ta.value : '';
  const charEl  = document.getElementById('nvSkillCharCount');
  const status  = document.getElementById('nvSkillParseStatus');
  const preview = document.getElementById('nvSkillParsePreview');
  const cards   = document.getElementById('nvSkillPreviewCards');
  const cntEl   = document.getElementById('nvSkillParsedCount');
  const stpEl   = document.getElementById('nvSkillParsedSteps');
  const saveBtn = document.getElementById('nvSkillSaveBtn');

  if(charEl) charEl.textContent = raw.length + ' chars';

  if(!raw.trim()){
    if(status)  status.style.display = 'none';
    if(preview) preview.style.display = 'none';
    if(saveBtn){ saveBtn.style.opacity='.5'; saveBtn.style.pointerEvents='none'; }
    return;
  }

  const parsed = nvParseSkillBlob(raw);
  const totalSteps = parsed.reduce((a,s)=>a+s.steps.length,0);

  if(!parsed.length || totalSteps === 0){
    if(status){
      status.style.display = '';
      status.style.background = 'rgba(224,123,123,.1)';
      status.style.border = '1px solid rgba(224,123,123,.3)';
      status.style.color = '#e07b7b';
      status.textContent = 'âš ï¸ Could not detect any steps. Try separating the skill name from steps with a blank line, or add numbered/bulleted steps.';
    }
    if(preview) preview.style.display = 'none';
    if(saveBtn){ saveBtn.style.opacity='.5'; saveBtn.style.pointerEvents='none'; }
    return;
  }

  // Check for duplicates
  const dupes = parsed.filter(p => nvAllSkills().find(s=>s.name.toLowerCase()===p.name.toLowerCase()));

  if(status){
    status.style.display = '';
    if(dupes.length){
      status.style.background = 'rgba(251,191,36,.08)';
      status.style.border = '1px solid rgba(251,191,36,.25)';
      status.style.color = '#fbbf24';
      status.textContent = `âš ï¸ ${dupes.length} skill(s) already exist and will be skipped: ${dupes.map(d=>'"'+d.name+'"').join(', ')}`;
    } else {
      status.style.background = 'rgba(90,173,160,.1)';
      status.style.border = '1px solid rgba(90,173,160,.3)';
      status.style.color = 'var(--accent3)';
      status.textContent = `âœ“ Ready to import ${parsed.length} skill(s) with ${totalSteps} total steps.`;
    }
  }

  if(cntEl) cntEl.textContent = parsed.length;
  if(stpEl) stpEl.textContent = totalSteps;

  // Render preview cards
  if(cards){
    cards.innerHTML = parsed.map((sk,idx) => {
      const isDupe = nvAllSkills().find(s=>s.name.toLowerCase()===sk.name.toLowerCase());
      return `<div style="background:var(--bg3);border:1px solid ${isDupe?'rgba(224,123,123,.35)':' var(--border)'};border-radius:10px;padding:12px 14px;${isDupe?'opacity:.55':''}">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <span style="font-weight:700;font-size:13px;color:var(--text);">${_nvEsc(sk.name)}</span>
          <span style="font-size:10px;font-family:'DM Mono',monospace;color:${isDupe?'#e07b7b':'var(--text3)'};">${isDupe?'âš ï¸ duplicate':sk.steps.length+' steps'}</span>
        </div>
        <ol style="margin:0 0 0 16px;padding:0;font-size:11px;color:var(--text2);line-height:1.9;font-family:'DM Mono',monospace;">
          ${sk.steps.slice(0,5).map(s=>`<li>${_nvEsc(s)}</li>`).join('')}
          ${sk.steps.length>5?`<li style="color:var(--text3);">â€¦and ${sk.steps.length-5} more steps</li>`:''}
        </ol>
      </div>`;
    }).join('');
  }

  if(preview) preview.style.display = '';

  const newSkills = parsed.filter(p => !nvAllSkills().find(s=>s.name.toLowerCase()===p.name.toLowerCase()));
  if(saveBtn){
    if(newSkills.length > 0){
      saveBtn.style.opacity  = '1';
      saveBtn.style.pointerEvents = '';
      saveBtn.textContent = `ï¼‹ Add ${newSkills.length} Skill${newSkills.length>1?'s':''}`;
    } else {
      saveBtn.style.opacity = '.5';
      saveBtn.style.pointerEvents = 'none';
      saveBtn.textContent = 'ï¼‹ Add Parsed Skills';
    }
  }
}

function _nvEsc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â”€â”€â”€ SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvSaveSmartSkills(){
  const raw = (document.getElementById('addSkillPaste')||{}).value||'';
  if(!raw.trim()){ toast('Nothing to save'); return; }
  const parsed = nvParseSkillBlob(raw);
  const newSkills = parsed.filter(p => !nvAllSkills().find(s=>s.name.toLowerCase()===p.name.toLowerCase()));
  if(!newSkills.length){ toast('All skills already exist'); return; }
  newSkills.forEach(sk => {
    _nvCustomSkills.push({ id:'csk_'+Date.now()+'_'+Math.random().toString(36).slice(2,7), name:sk.name, steps:sk.steps });
  });
  nvSaveCustomSkills();
  closeModal('addSkillModal');
  nvRenderSkills();
  toast(`${newSkills.length} skill${newSkills.length>1?'s':''} added âœ“`);
}

// â”€â”€â”€ LEGACY COMPAT stubs (called from old modal wiring) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function previewSkillParse(){ nvSmartSkillPreview && nvSmartSkillPreview(); }
function previewParsedSkill(){ nvSmartSkillPreview && nvSmartSkillPreview(); }
function saveNewSkill(){ nvSaveSmartSkills && nvSaveSmartSkills(); }
function parseSkillText(raw){
  const skills = nvParseSkillBlob(raw);
  return skills.length ? skills[0] : null;
}


// â”€â”€â”€ ADMIN: LAB PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function previewLabParse(){
  const title=(document.getElementById('addLabTitle')||{}).value||'';
  const raw=document.getElementById('addLabPaste').value.trim();
  const preview=document.getElementById('labParsePreview');
  const content=document.getElementById('labParsePreviewContent');
  const countEl=document.getElementById('labRowCount');
  if(!raw){preview.style.display='none';return;}
  const rows=[];
  raw.split('\n').map(l=>l.trim()).filter(Boolean).forEach(l=>{
    const parts=l.split('|').map(p=>p.trim());
    if(parts.length>=2) rows.push({test:parts[0],normal:parts[1]||'â€”'});
    else { const c=l.indexOf(':'); if(c>0) rows.push({test:l.slice(0,c).trim(),normal:l.slice(c+1).trim()}); }
  });
  if(countEl) countEl.textContent=rows.length;
  content.innerHTML=`<strong style="color:var(--text);">${title||'(Title not set)'}</strong><table style="width:100%;margin-top:8px;border-collapse:collapse;font-size:11px;">${rows.map(r=>`<tr><td style="padding:3px 0;border-bottom:1px solid rgba(255,255,255,.06);color:var(--text2);">${r.test}</td><td style="padding:3px 0 3px 12px;border-bottom:1px solid rgba(255,255,255,.06);color:var(--nv-accent-2);font-family:'DM Mono',monospace;">${r.normal}</td></tr>`).join('')}</table>`;
  preview.style.display='';
}

// â”€â”€â”€ MED CALC: FLUID BALANCE & BMI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvCalcFluid(){
  const iv=parseFloat(document.getElementById('nvFbIv').value)||0;
  const oral=parseFloat(document.getElementById('nvFbOral').value)||0;
  const otherIn=parseFloat(document.getElementById('nvFbOtherIn').value)||0;
  const urine=parseFloat(document.getElementById('nvFbUrine').value)||0;
  const otherOut=parseFloat(document.getElementById('nvFbOtherOut').value)||0;
  const totalIn=iv+oral+otherIn, totalOut=urine+otherOut, balance=totalIn-totalOut;
  document.getElementById('nvFbTotalIn').textContent=totalIn.toFixed(0);
  document.getElementById('nvFbTotalOut').textContent=totalOut.toFixed(0);
  document.getElementById('nvFbBalance').textContent=(balance>=0?'+':'')+balance.toFixed(0);
  document.getElementById('nvFbBalance').style.color=balance>=0?'var(--nv-accent-3)':'var(--nv-red)';
  document.getElementById('nvFbResult').style.display='';
}
function nvCalcBmi(){
  const w=parseFloat(document.getElementById('nvBmiWeight').value);
  const h=parseFloat(document.getElementById('nvBmiHeight').value)/100;
  if(!w||!h){toast('Fill weight and height');return;}
  const bmi=w/(h*h);
  let cls='';
  if(bmi<18.5) cls='Underweight';
  else if(bmi<25) cls='Normal weight';
  else if(bmi<30) cls='Overweight';
  else cls='Obese';
  document.getElementById('nvBmiVal').textContent=bmi.toFixed(1);
  document.getElementById('nvBmiClass').textContent=cls;
  document.getElementById('nvBmiResult').style.display='';
}

// â”€â”€â”€ ADMIN: ADD LAB VALUES (paste parser) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Storage for admin-added lab values
let _nvCustomLabs=[];
function nvLoadCustomLabs(){
  try{ _nvCustomLabs=JSON.parse(localStorage.getItem('nv_custom_labs')||'[]'); }catch(e){ _nvCustomLabs=[]; }
}
function nvSaveCustomLabs(){ try{ localStorage.setItem('nv_custom_labs',JSON.stringify(_nvCustomLabs)); }catch(e){} }
nvLoadCustomLabs();

function openAddLabModal(){
  document.getElementById('addLabPaste').value='';
  document.getElementById('labParsePreview').style.display='none';
  openModal('addLabModal');
}

function previewParsedLab(){
  const raw=document.getElementById('addLabPaste').value.trim();
  const preview=document.getElementById('labParsePreview');
  const content=document.getElementById('labParsePreviewContent');
  if(!raw){ preview.style.display='none'; return; }
  const parsed=parseLabText(raw);
  if(!parsed){ preview.style.display='none'; return; }
  preview.style.display='';
  content.innerHTML=`
    <div style="font-weight:700;font-size:13px;color:var(--text1);margin-bottom:8px;">ðŸ“Š ${parsed.title}</div>
    <table style="width:100%;font-size:11px;font-family:'DM Mono',monospace;border-collapse:collapse;">
      <tr style="background:var(--bg2);"><th style="padding:4px 8px;text-align:left;">Test</th><th style="padding:4px 8px;text-align:left;">Normal</th><th style="padding:4px 8px;text-align:left;">Critical</th><th style="padding:4px 8px;text-align:left;">Note</th></tr>
      ${parsed.rows.map(r=>`<tr style="border-bottom:1px solid var(--border);"><td style="padding:4px 8px;">${r.test}</td><td style="padding:4px 8px;color:var(--accent3);">${r.normal}</td><td style="padding:4px 8px;color:var(--accent4);">${r.critical}</td><td style="padding:4px 8px;color:var(--text3);">${r.note}</td></tr>`).join('')}
    </table>`;
}

function parseLabText(raw){
  const lines=raw.split('\n').map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return null;
  // First line = section title
  const title=lines[0].replace(/^[#\-\*]+\s*/,'').trim();
  const rows=[];
  lines.slice(1).forEach(l=>{
    // Support pipe-delimited: Test | Normal | Critical | Note
    const parts=l.split('|').map(p=>p.trim());
    if(parts.length>=2){
      rows.push({
        test: parts[0]||'',
        normal: parts[1]||'â€”',
        critical: parts[2]||'â€”',
        note: parts[3]||''
      });
    } else {
      // Try colon-delimited: Test: Normal Range
      const colon=l.indexOf(':');
      if(colon>0){
        rows.push({test:l.slice(0,colon).trim(), normal:l.slice(colon+1).trim(), critical:'â€”', note:''});
      }
    }
  });
  if(!rows.length) return null;
  return {title, rows};
}

function saveNewLab(){
  const title=document.getElementById('addLabTitle').value.trim();
  const raw=document.getElementById('addLabPaste').value.trim();
  const tab=document.getElementById('addLabTab').value;
  if(!title){ toast('Please enter a section title'); return; }
  if(!raw){ toast('Please enter at least one lab row'); return; }
  const rows=[];
  raw.split('\n').map(l=>l.trim()).filter(Boolean).forEach(l=>{
    const parts=l.split('|').map(p=>p.trim());
    if(parts.length>=2){
      rows.push({test:parts[0],normal:parts[1]||'â€”',critical:parts[2]||'â€”',note:parts[3]||''});
    } else {
      const colon=l.indexOf(':');
      if(colon>0) rows.push({test:l.slice(0,colon).trim(),normal:l.slice(colon+1).trim(),critical:'â€”',note:''});
    }
  });
  if(!rows.length){ toast('Could not parse rows â€” use: Test Name | Normal Range'); return; }
  const entry={id:'clab_'+Date.now(), tab, title, rows};
  _nvCustomLabs.push(entry);
  nvSaveCustomLabs();
  document.getElementById('addLabTitle').value='';
  document.getElementById('addLabPaste').value='';
  document.getElementById('labParsePreview').style.display='none';
  closeModal('addLabModal');
  renderCustomLabs();
  toast(`"${title}" added to ${tab} tab âœ“`);
}

function renderCustomLabs(){
  // Render all custom lab sections into their respective tab containers
  ['labs','vitals','scales','abg'].forEach(tab=>{
    const container=document.getElementById('adminLabSection-'+tab);
    if(!container) return;
    const sections=_nvCustomLabs.filter(l=>l.tab===tab);
    if(!sections.length){ container.innerHTML=''; return; }
    container.innerHTML=sections.map((s,si)=>`
      <div style="margin-top:4px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
          <div class="nv-section-title" style="margin:0;">${s.title}</div>
          ${currentRole==='admin'?`<button class="icon-btn" onclick="nvDeleteCustomLab('${s.id}')" title="Delete section" style="font-size:11px;color:var(--accent4);">ðŸ—‘</button>`:''}
        </div>
        <table class="ref-table">
          <tr><th>Test</th><th>Normal Range</th><th>Critical</th><th>Note</th></tr>
          ${s.rows.map(r=>`<tr>
            <td>${r.test}</td>
            <td class="normal-val">${r.normal}</td>
            <td class="${r.critical&&r.critical!=='â€”'?'critical-val':'nv-text-xs nv-text-dim'}">${r.critical}</td>
            <td class="nv-text-xs nv-text-dim">${r.note}</td>
          </tr>`).join('')}
        </table>
      </div>`).join('');
  });
}

function nvDeleteCustomLab(id){
  if(!confirm('Delete this lab section?')) return;
  _nvCustomLabs=_nvCustomLabs.filter(l=>l.id!==id);
  nvSaveCustomLabs();
  renderCustomLabs();
  toast('Lab section deleted');
}

// â”€â”€â”€ DICTIONARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvQuickSearch(term){document.getElementById('nvDictSearch').value=term;nvSearchDict();}
async function nvSearchDict(){
  const q=document.getElementById('nvDictSearch').value.trim();
  if(!q){toast('Enter a term');return;}
  const box=document.getElementById('nvDictResults');
  box.innerHTML=`<div style="text-align:center;padding:36px 20px;"><div style="width:30px;height:30px;border-radius:50%;border:3px solid rgba(62,142,149,.12);border-top-color:var(--nv-accent);animation:spin .8s linear infinite;margin:0 auto 10px;"></div><div style="font-size:12px;color:var(--nv-text-dim);">Fetching clinical dataâ€¦</div></div>`;
  const GEMINI_API_KEY=nvLs('nv-gemini-key','');
  if(!GEMINI_API_KEY){
    setTimeout(()=>{
      box.innerHTML=`<div class="nv-dict-result"><div class="nv-dict-term">${q.toUpperCase()}</div><div class="nv-dict-body">âš ï¸ No API key configured. To enable AI definitions:\n\n1. Go to aistudio.google.com\n2. Get a free Gemini API key\n3. Store it via the browser console: localStorage.setItem('nv-gemini-key', 'YOUR_KEY')\n\nIn the meantime, here is a brief overview:\n\n${q} is a clinical term used in nursing practice. It is important to assess patients for associated signs and symptoms, monitor relevant laboratory and vital sign values, and report any abnormal findings to the healthcare team promptly.</div></div>`;
    },600);return;
  }
  try{
    const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`Clinical definition and 3 nursing considerations for: ${q}`}]}],systemInstruction:{parts:[{text:'You are a professional medical dictionary for nursing students. Provide a clear one-sentence clinical definition, then list exactly 3 nursing considerations as bullet points. Keep it concise and practical. No markdown.'}]}})});
    const data=await r.json();
    const text=data.candidates?.[0]?.content?.parts?.[0]?.text||'Term not found.';
    box.innerHTML=`<div class="nv-dict-result"><div class="nv-dict-term">${q.toUpperCase()}</div><div class="nv-dict-body">${text}</div></div>`;
  }catch{box.innerHTML=`<div class="nv-empty"><div class="nv-empty-icon">âš ï¸</div><div class="nv-empty-text">Network error. Check your connection and try again.</div></div>`;}
}

// â”€â”€â”€ GPA CALCULATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvAddCourse(){
  const name=document.getElementById('nvCourseName').value.trim()||'Course';
  const units=parseFloat(document.getElementById('nvCourseUnits').value);
  const grade=parseFloat(document.getElementById('nvCourseGrade').value);
  const gt=document.getElementById('nvCourseGrade').selectedOptions[0].text.split('â€”')[0].trim();
  if(!units||units<1){toast('Enter valid credit units');return;}
  nvCourses.push({name,units,grade,gt});
  nvLsSet('nv-courses',nvCourses);
  document.getElementById('nvCourseName').value='';document.getElementById('nvCourseUnits').value='';
  nvRenderCourses();toast(`âœ“ ${name} added`);
}
function nvRenderCourses(){
  const list=document.getElementById('nvCourseList'),empty=document.getElementById('nvGpaEmpty'),actions=document.getElementById('nvGpaActions'),display=document.getElementById('nvGpaDisplayCard');
  if(!list)return;
  if(nvCourses.length===0){list.innerHTML='';empty.style.display='';display.style.display='none';actions.style.display='none';return;}
  empty.style.display='none';display.style.display='';actions.style.display='';
  let tp=0,tu=0;nvCourses.forEach(c=>{tp+=c.units*c.grade;tu+=c.units;});
  const gpa=tp/tu;
  document.getElementById('nvGpaVal').textContent=gpa.toFixed(2);
  document.getElementById('nvGpaBar').style.width=Math.min((gpa/5)*100,100)+'%';
  let cls,col;
  if(gpa>=4.5){cls='First Class';col='#3E8E95';}else if(gpa>=3.5){cls='Second Class Upper';col='#5aada0';}else if(gpa>=2.5){cls='Second Class Lower';col='#fb923c';}else if(gpa>=1.5){cls='Third Class';col='#f87171';}else{cls='Fail';col='#ef4444';}
  document.getElementById('nvGpaClass').textContent=cls;document.getElementById('nvGpaClass').style.color=col;
  list.innerHTML=nvCourses.map((c,i)=>{
    const col2=c.grade>=4?'#5aada0':c.grade>=3?'#3E8E95':c.grade>=2?'#fb923c':'#f87171';
    const bg=c.grade>=4?'rgba(90,173,160,.1)':c.grade>=3?'rgba(62,142,149,.1)':c.grade>=2?'rgba(251,146,60,.1)':'rgba(248,113,113,.1)';
    return `<div class="nv-course-row"><div style="flex:1;"><div style="font-weight:700;font-size:13px;font-family:'DM Mono',monospace;">${c.name}</div><div style="font-size:11px;color:var(--nv-text-dim);margin-top:1px;">${c.units} unit${c.units>1?'s':''} Â· ${c.gt}</div></div><div style="display:flex;gap:7px;align-items:center;"><div style="width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;font-family:'Syne',sans-serif;color:${col2};background:${bg};">${c.gt.split(' ')[0]}</div><button class="nv-btn nv-btn-danger" style="padding:9px;border-radius:10px;" onclick="nvRemoveCourse(${i})">âœ•</button></div></div>`;
  }).join('');
}
function nvRemoveCourse(i){nvCourses.splice(i,1);nvLsSet('nv-courses',nvCourses);nvRenderCourses();toast('Course removed');}
function nvClearCourses(){if(!confirm('Clear all courses?'))return;nvCourses=[];nvLsSet('nv-courses',nvCourses);nvRenderCourses();toast('Cleared');}

// â”€â”€â”€ STUDY PROGRESS DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nvRenderStudyDash(){
  document.getElementById('nvDashStreak').textContent=nvStreak.count;
  document.getElementById('nvDashStreakIcon').textContent=nvStreak.count>=7?'ðŸ”¥':nvStreak.count>=3?'ðŸŒŸ':'ðŸ“š';
  document.getElementById('nvDashCardsReviewed').textContent=nvLs('nv-cards-reviewed',0);
  document.getElementById('nvDashSessions').textContent=nvLs('nv-sessions-done',0);
  const qh=nvQuizHistory;
  if(qh.length>0){const avg=Math.round(qh.reduce((s,q)=>s+q.pct,0)/qh.length);document.getElementById('nvDashQuizAvg').textContent=avg+'%';}
  else document.getElementById('nvDashQuizAvg').textContent='â€”';

  // Activity bars
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const bars=document.getElementById('nvDashActivityBars'),labels=document.getElementById('nvDashDayLabels');
  if(!bars)return;
  bars.innerHTML='';labels.innerHTML='';
  for(let i=6;i>=0;i--){
    const d=new Date(Date.now()-i*86400000),ds=d.toDateString();
    const active=nvActivityLog.some(a=>a.date===ds),isToday=i===0;
    const dayName=days[(d.getDay()+6)%7];
    const h=active?Math.random()*40+20:Math.random()*15+4;
    bars.innerHTML+=`<div class="nv-act-bar${isToday?' today':''}" style="height:${h}px;${active&&!isToday?'background:rgba(56,189,248,0.4);':''}"></div>`;
    labels.innerHTML+=`<div style="flex:1;text-align:center;font-size:9px;color:var(--nv-text-dim);">${dayName}</div>`;
  }

  // Quiz history
  const qhEl=document.getElementById('nvDashQuizHistory'),qhEmpty=document.getElementById('nvDashQuizEmpty');
  if(qh.length===0){qhEl.innerHTML='';qhEmpty.style.display='';return;}
  qhEmpty.style.display='none';
  qhEl.innerHTML=qh.slice(-5).reverse().map(q=>`
    <div class="flex-between" style="padding:10px 0;border-bottom:1px solid var(--nv-border);">
      <div><div class="nv-text-sm nv-fw-700">${q.score}/${q.total} correct</div><div class="nv-text-xs nv-text-dim">${new Date(q.date).toLocaleDateString()}</div></div>
      <div class="nv-fw-700" style="font-size:1.3rem;font-family:'Syne',sans-serif;color:${q.pct>=70?'var(--nv-accent-3)':q.pct>=50?'var(--nv-accent-warm)':'var(--nv-red)'};">${q.pct}%</div>
    </div>`).join('');
}

</script>
<style>
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

/* â”€â”€ Lecturer Folder Styles â”€â”€ */
.lf-folder{border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:10px;background:var(--bg2);}
.lf-folder-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;transition:background .2s;}
.lf-folder-header:hover{background:var(--bg3);}
.lf-folder-left{display:flex;align-items:center;gap:12px;}
.lf-folder-ico{font-size:22px;}
.lf-folder-name{font-weight:700;font-size:14px;font-family:'Syne',sans-serif;}
.lf-folder-meta{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;}
.lf-folder-chevron{font-size:18px;color:var(--text3);transition:transform .25s;font-weight:700;}
.lf-folder-body{padding:0 8px 8px;}
.lf-folder-empty{text-align:center;padding:20px;color:var(--text3);font-size:12px;font-family:'DM Mono',monospace;}
.lf-section-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin:16px 0 8px;padding-left:4px;}

/* Lecturer Folder CARD GRID (course view) */
.lf-folder-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-bottom:6px;}
.lf-folder-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px 20px;cursor:pointer;transition:transform .18s,box-shadow .18s,border-color .18s;display:flex;align-items:center;gap:16px;position:relative;animation:fadeUp .35s both;}
.lf-folder-card:hover{transform:translateY(-3px);box-shadow:0 8px 28px rgba(0,0,0,.18);border-color:var(--accent);}
.lf-folder-card-ico{width:52px;height:52px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;}
.lf-folder-card-body{flex:1;min-width:0;}
.lf-folder-card-name{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;color:var(--text1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lf-folder-card-meta{font-family:'DM Mono',monospace;font-size:11px;color:var(--text3);margin-top:3px;}
.lf-folder-card-actions{display:flex;gap:4px;flex-shrink:0;opacity:0;transition:opacity .2s;}
.lf-folder-card:hover .lf-folder-card-actions{opacity:1;}

/* Back Button */
#globalBackBtn{display:none;position:fixed;top:10px;left:72px;z-index:8500;background:var(--bg2);border:2px solid var(--border);border-radius:10px;padding:7px 18px;font-family:'Syne',sans-serif;font-weight:900;font-size:13px;color:var(--text1);cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.18);transition:all .18s;align-items:center;gap:7px;letter-spacing:.01em;white-space:nowrap;}
#globalBackBtn:hover{background:var(--bg3);border-color:var(--accent);color:var(--accent);transform:translateX(-2px);}
@media(max-width:600px){#globalBackBtn{top:8px;left:52px;font-size:12px;padding:6px 12px;}}

/* Timetable table */
.tt-table{width:100%;border-collapse:collapse;background:var(--bg2);border-radius:14px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.08);}
.tt-table thead{background:var(--bg3);}
.tt-table th{padding:10px 16px;text-align:left;font-size:11px;font-family:'DM Mono',monospace;color:var(--text3);text-transform:uppercase;letter-spacing:.06em;font-weight:600;border-bottom:1px solid var(--border);}
.tt-table td{padding:12px 16px;border-bottom:1px solid var(--border);vertical-align:middle;}
.tt-table tr:last-child td{border-bottom:none;}
.tt-table tbody tr:hover{background:var(--bg3);}

/* Slide animations for toast notifications */
@keyframes slideInRight{from{transform:translateX(120%);opacity:0;}to{transform:translateX(0);opacity:1;}}
@keyframes slideOutRight{from{transform:translateX(0);opacity:1;}to{transform:translateX(120%);opacity:0;}}
</style>
</body>
</html>
