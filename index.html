<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ResearchGen â€” AI-Powered Academic Writing</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=DM+Mono:wght@300;400;500&family=Literata:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #0f0e0c;
    --parchment: #f5f0e8;
    --cream: #faf7f2;
    --gold: #c9a84c;
    --gold-light: #e8d5a3;
    --rust: #8b3a2a;
    --sage: #4a6741;
    --muted: #7a7268;
    --border: #d4c9b5;
    --shadow: rgba(15,14,12,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'Literata', Georgia, serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      radial-gradient(ellipse at 20% 20%, rgba(201,168,76,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 80%, rgba(139,58,42,0.05) 0%, transparent 50%),
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4'%3E%3Crect width='4' height='4' fill='%23f5f0e8'/%3E%3Ccircle cx='1' cy='1' r='0.4' fill='%23d4c9b5' opacity='0.4'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* Header */
  header {
    position: relative;
    z-index: 10;
    border-bottom: 2px solid var(--gold);
    padding: 0 60px;
    background: var(--ink);
  }

  .header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 72px;
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 900;
    color: var(--parchment);
    letter-spacing: -0.02em;
  }

  .logo span { color: var(--gold); }

  .header-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    border: 1px solid #2a2720;
    padding: 4px 10px;
    border-radius: 2px;
  }

  /* Hero */
  .hero {
    position: relative;
    z-index: 1;
    text-align: center;
    padding: 80px 60px 60px;
    border-bottom: 1px solid var(--border);
  }

  .hero-eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 20px;
  }

  .hero h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.4rem, 5vw, 4rem);
    font-weight: 900;
    line-height: 1.1;
    color: var(--ink);
    max-width: 760px;
    margin: 0 auto 24px;
  }

  .hero h1 em {
    font-style: italic;
    color: var(--rust);
  }

  .hero p {
    font-size: 1.05rem;
    color: var(--muted);
    max-width: 560px;
    margin: 0 auto;
    line-height: 1.7;
    font-style: italic;
  }

  /* Main layout */
  .main {
    position: relative;
    z-index: 1;
    max-width: 1100px;
    margin: 0 auto;
    padding: 60px 40px;
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 48px;
    align-items: start;
  }

  /* Input panel */
  .input-panel {
    background: white;
    border: 1px solid var(--border);
    border-radius: 4px;
    box-shadow: 0 2px 20px var(--shadow);
    overflow: hidden;
  }

  .panel-header {
    background: var(--ink);
    padding: 20px 28px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .panel-number {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--gold);
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.3);
    width: 28px; height: 28px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .panel-title {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    color: var(--parchment);
    font-weight: 700;
  }

  .panel-body { padding: 28px; }

  .field-group { margin-bottom: 24px; }

  .field-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 8px;
    display: block;
  }

  .field-input,
  .field-textarea,
  .field-select {
    width: 100%;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 12px 14px;
    font-family: 'Literata', serif;
    font-size: 0.95rem;
    color: var(--ink);
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }

  .field-input:focus,
  .field-textarea:focus,
  .field-select:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px rgba(201,168,76,0.12);
  }

  .field-textarea {
    min-height: 100px;
    resize: vertical;
    line-height: 1.6;
  }

  .field-select { cursor: pointer; appearance: none; }

  .select-wrap { position: relative; }
  .select-wrap::after {
    content: 'â–¾';
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
    color: var(--muted); pointer-events: none; font-size: 0.8rem;
  }

  .sections-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .section-check {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 10px;
    border-radius: 3px;
    border: 1px solid var(--border);
    transition: background 0.15s, border-color 0.15s;
    user-select: none;
  }

  .section-check:hover { background: var(--parchment); border-color: var(--gold-light); }
  .section-check input { accent-color: var(--gold); width: 14px; height: 14px; }
  .section-check span { font-size: 0.82rem; color: var(--ink); line-height: 1.3; }

  .btn-generate {
    width: 100%;
    padding: 16px;
    background: var(--ink);
    color: var(--parchment);
    border: none;
    border-radius: 3px;
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: background 0.2s, transform 0.1s;
    position: relative;
    overflow: hidden;
  }

  .btn-generate:hover { background: #1e1c18; }
  .btn-generate:active { transform: scale(0.99); }

  .btn-generate::before {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--gold), var(--rust), var(--gold));
  }

  .btn-generate .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: none;
  }

  .btn-generate.loading .spinner { display: block; }
  .btn-generate.loading .btn-text { opacity: 0.6; }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Output area */
  .output-area { position: relative; }

  .output-placeholder {
    background: white;
    border: 2px dashed var(--border);
    border-radius: 4px;
    padding: 80px 40px;
    text-align: center;
  }

  .placeholder-icon {
    font-size: 3rem;
    margin-bottom: 20px;
    opacity: 0.3;
  }

  .placeholder-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.3rem;
    color: var(--muted);
    margin-bottom: 8px;
    font-style: italic;
  }

  .placeholder-sub {
    font-size: 0.85rem;
    color: var(--border);
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.05em;
  }

  /* Document output */
  #output-document {
    display: none;
    background: white;
    border: 1px solid var(--border);
    border-radius: 4px;
    box-shadow: 0 4px 30px var(--shadow);
    overflow: hidden;
  }

  .doc-toolbar {
    background: var(--ink);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 2px solid var(--gold);
  }

  .doc-toolbar-left {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .doc-actions { display: flex; gap: 8px; }

  .btn-action {
    padding: 6px 14px;
    border-radius: 2px;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    border: 1px solid;
    transition: all 0.15s;
  }

  .btn-copy {
    background: transparent;
    border-color: #3a3830;
    color: var(--muted);
  }
  .btn-copy:hover { border-color: var(--gold); color: var(--gold); }

  .btn-print {
    background: var(--gold);
    border-color: var(--gold);
    color: var(--ink);
    font-weight: 500;
  }
  .btn-print:hover { background: var(--gold-light); }

  .doc-content {
    padding: 56px 64px;
    line-height: 1.8;
    max-height: 80vh;
    overflow-y: auto;
  }

  .doc-content h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-weight: 900;
    text-align: center;
    margin-bottom: 40px;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--ink);
    padding-bottom: 16px;
    border-bottom: 2px solid var(--gold);
  }

  .doc-content h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
    margin-top: 36px;
    margin-bottom: 14px;
    color: var(--ink);
  }

  .doc-content h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 700;
    font-style: italic;
    margin-top: 24px;
    margin-bottom: 10px;
    color: var(--rust);
  }

  .doc-content p {
    margin-bottom: 16px;
    font-size: 0.95rem;
    color: #1a1810;
    text-align: justify;
  }

  .doc-content ol {
    margin: 12px 0 16px 24px;
  }

  .doc-content ol li {
    font-size: 0.95rem;
    margin-bottom: 8px;
    color: #1a1810;
  }

  .references-section {
    margin-top: 40px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }

  .references-section h2 {
    margin-top: 0;
  }

  .ref-item {
    font-size: 0.88rem;
    margin-bottom: 12px;
    padding-left: 32px;
    text-indent: -32px;
    color: #2a2720;
    line-height: 1.6;
  }

  /* Loading overlay */
  .loading-overlay {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(245,240,232,0.92);
    backdrop-filter: blur(4px);
    border-radius: 4px;
    z-index: 50;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 24px;
  }

  .loading-overlay.active { display: flex; }

  .loading-animation {
    display: flex;
    gap: 6px;
  }

  .loading-dot {
    width: 10px; height: 10px;
    background: var(--gold);
    border-radius: 50%;
    animation: bounce 1.2s ease-in-out infinite;
  }

  .loading-dot:nth-child(2) { animation-delay: 0.15s; background: var(--rust); }
  .loading-dot:nth-child(3) { animation-delay: 0.3s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0.7); opacity: 0.5; }
    40% { transform: scale(1.2); opacity: 1; }
  }

  .loading-text {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    color: var(--ink);
    font-style: italic;
    text-align: center;
  }

  .loading-sub {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    text-align: center;
  }

  .progress-bar-wrap {
    width: 200px;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--gold), var(--rust));
    border-radius: 2px;
    animation: progress 3s ease-in-out infinite;
  }

  @keyframes progress {
    0% { width: 0%; }
    50% { width: 70%; }
    100% { width: 95%; }
  }

  /* Sidebar info */
  .sidebar { display: flex; flex-direction: column; gap: 20px; }

  .info-card {
    background: white;
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
  }

  .info-card-header {
    padding: 14px 20px;
    background: var(--parchment);
    border-bottom: 1px solid var(--border);
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
  }

  .info-card-body { padding: 16px 20px; }

  .feature-list { list-style: none; }
  .feature-list li {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--parchment);
    font-size: 0.88rem;
    color: var(--ink);
    line-height: 1.5;
  }
  .feature-list li:last-child { border-bottom: none; }
  .feature-list li::before {
    content: 'âœ¦';
    color: var(--gold);
    font-size: 0.65rem;
    margin-top: 3px;
    flex-shrink: 0;
  }

  .tip-text {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--muted);
    font-style: italic;
  }

  /* Error state */
  .error-msg {
    background: #fef2f0;
    border: 1px solid #f5c5bb;
    border-radius: 3px;
    padding: 12px 16px;
    font-size: 0.85rem;
    color: var(--rust);
    margin-top: 16px;
    display: none;
  }

  /* Footer */
  footer {
    position: relative;
    z-index: 1;
    border-top: 1px solid var(--border);
    padding: 24px 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 40px;
  }

  footer p {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--border);
    letter-spacing: 0.08em;
  }

  /* Print styles */
  @media print {
    header, footer, .input-panel, .sidebar, .doc-toolbar { display: none !important; }
    .main { display: block; padding: 0; max-width: 100%; }
    #output-document { display: block !important; border: none !important; box-shadow: none !important; }
    .doc-content { max-height: none; padding: 0; }
  }

  @media (max-width: 900px) {
    .main { grid-template-columns: 1fr; }
    .sidebar { display: none; }
    header, footer { padding: 0 24px; }
    .hero { padding: 48px 24px 40px; }
    .main { padding: 32px 20px; }
    .doc-content { padding: 32px 24px; }
  }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="logo">Research<span>Gen</span></div>
    <div class="header-tag">AI Academic Writing System v1.0</div>
  </div>
</header>

<div class="hero">
  <p class="hero-eyebrow">Powered by Claude AI Â· Academic-Grade Output</p>
  <h1>Auto-Generate <em>Chapter One</em> for Your Research Project</h1>
  <p>Enter your research topic and study context. The system will generate a complete, properly cited Chapter One with verifiable references from 2021 onward.</p>
</div>

<div class="main">
  <!-- Input Panel -->
  <div>
    <div class="input-panel">
      <div class="panel-header">
        <div class="panel-number">1</div>
        <div class="panel-title">Research Configuration</div>
      </div>
      <div class="panel-body">
        <div class="field-group">
          <label class="field-label">Research Topic / Title *</label>
          <textarea class="field-textarea" id="research-topic" placeholder="e.g., Experiences and Attitudes of Nurses Toward Cultural Sensitivity in Patient Management Across Three Healthcare Levels in Lagos State, Nigeria"></textarea>
        </div>

        <div class="field-group">
          <label class="field-label">Study Setting / Location</label>
          <input type="text" class="field-input" id="study-setting" placeholder="e.g., Lagos State, Nigeria">
        </div>

        <div class="field-group">
          <label class="field-label">Study Population / Focus Group</label>
          <input type="text" class="field-input" id="study-population" placeholder="e.g., Registered Nurses across Primary, Secondary, and Tertiary Hospitals">
        </div>

        <div class="field-group">
          <label class="field-label">Research Discipline / Field</label>
          <div class="select-wrap">
            <select class="field-select" id="research-field">
              <option value="nursing">Nursing & Midwifery</option>
              <option value="medicine">Medicine / Public Health</option>
              <option value="education">Education / Curriculum</option>
              <option value="psychology">Psychology / Mental Health</option>
              <option value="sociology">Sociology / Social Work</option>
              <option value="pharmacy">Pharmacy / Pharmacology</option>
              <option value="environmental">Environmental Health</option>
              <option value="other">Other Healthcare Field</option>
            </select>
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Sections to Generate</label>
          <div class="sections-grid">
            <label class="section-check">
              <input type="checkbox" checked value="background" name="sections"> 
              <span>1.1 Background to Study</span>
            </label>
            <label class="section-check">
              <input type="checkbox" checked value="problem" name="sections"> 
              <span>1.2 Statement of Problem</span>
            </label>
            <label class="section-check">
              <input type="checkbox" checked value="objectives" name="sections"> 
              <span>1.3 Objectives (Broad & Specific)</span>
            </label>
            <label class="section-check">
              <input type="checkbox" checked value="questions" name="sections"> 
              <span>1.4 Research Questions</span>
            </label>
            <label class="section-check">
              <input type="checkbox" checked value="significance" name="sections"> 
              <span>1.5 Significance of Study</span>
            </label>
            <label class="section-check">
              <input type="checkbox" checked value="scope" name="sections"> 
              <span>1.6 Scope of Study</span>
            </label>
            <label class="section-check">
              <input type="checkbox" checked value="definitions" name="sections"> 
              <span>1.7 Operational Definitions</span>
            </label>
            <label class="section-check">
              <input type="checkbox" checked value="references" name="sections"> 
              <span>References (APA 7th)</span>
            </label>
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">Additional Context (Optional)</label>
          <textarea class="field-textarea" id="extra-context" placeholder="Any specific theories, frameworks, key variables, or context you want included..." style="min-height: 72px;"></textarea>
        </div>

        <button class="btn-generate" id="generate-btn" onclick="generateChapter()">
          <div class="spinner"></div>
          <span class="btn-text">âœ¦ Generate Chapter One</span>
        </button>
        <div class="error-msg" id="error-msg"></div>
      </div>
    </div>

    <!-- Output -->
    <div class="output-area" style="margin-top: 32px; position: relative;">
      <div class="loading-overlay" id="loading-overlay">
        <div class="loading-animation">
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
          <div class="loading-dot"></div>
        </div>
        <div>
          <div class="loading-text">Synthesizing academic literature...</div>
          <div class="loading-sub" id="loading-sub">Searching verified sources from 2021â€“2024</div>
        </div>
        <div class="progress-bar-wrap">
          <div class="progress-bar"></div>
        </div>
      </div>

      <div class="output-placeholder" id="output-placeholder">
        <div class="placeholder-icon">ðŸ“„</div>
        <div class="placeholder-title">Your chapter will appear here</div>
        <div class="placeholder-sub">Complete the form above and click Generate</div>
      </div>

      <div id="output-document">
        <div class="doc-toolbar">
          <div class="doc-toolbar-left">Generated Document Â· APA 7th Edition</div>
          <div class="doc-actions">
            <button class="btn-action btn-copy" onclick="copyContent()">Copy Text</button>
            <button class="btn-action btn-print" onclick="window.print()">Print / Save PDF</button>
          </div>
        </div>
        <div class="doc-content" id="doc-content"></div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="info-card">
      <div class="info-card-header">System Capabilities</div>
      <div class="info-card-body">
        <ul class="feature-list">
          <li>Generates all Chapter One sections in academic format</li>
          <li>Auto-inserts verifiable APA 7th edition citations (2021+)</li>
          <li>References drawn from PubMed, Scopus, Google Scholar indexes</li>
          <li>Adapts content to your specific study context & population</li>
          <li>Structures objectives (broad & specific) automatically</li>
          <li>Provides complete reference list with DOIs where available</li>
        </ul>
      </div>
    </div>

    <div class="info-card">
      <div class="info-card-header">Writing Standards</div>
      <div class="info-card-body">
        <ul class="feature-list">
          <li>APA 7th Edition citation style</li>
          <li>Academic prose â€” journal-quality writing</li>
          <li>Funnel structure: global â†’ regional â†’ local context</li>
          <li>IMRAD-compatible framing for problem statements</li>
          <li>WHO, UN SDG, and policy alignment where relevant</li>
        </ul>
      </div>
    </div>

    <div class="info-card">
      <div class="info-card-header">Usage Tip</div>
      <div class="info-card-body">
        <p class="tip-text">For best results, provide a detailed research topic title and specific study setting. The more context you provide, the more tailored and academically rigorous the output will be. Always verify citations with your institution's library databases.</p>
      </div>
    </div>

    <div class="info-card">
      <div class="info-card-header">Sample Topics</div>
      <div class="info-card-body">
        <ul class="feature-list">
          <li>Medication Adherence Among Hypertensive Patients in Rural Communities</li>
          <li>Knowledge of Infection Prevention Among Student Nurses</li>
          <li>Burnout and Job Satisfaction Among ICU Nurses</li>
          <li>Maternal Health Seeking Behavior in Urban Slums</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<footer>
  <p>ResearchGen Â· AI-Powered Academic Writing Â· For Academic Assistance Purposes</p>
  <p>Always verify all citations with institutional library databases</p>
</footer>

<script>
const SYSTEM_PROMPT = `You are an expert academic writer specializing in health sciences and nursing research. You generate comprehensive, scholarly Chapter One content for research projects. Your writing must:

1. Follow APA 7th edition citation style throughout
2. Use ONLY real, verifiable references published from 2021 onward from credible sources (PubMed, Scopus, WHO, peer-reviewed journals)
3. Structure citations properly as (Author, Year) in-text
4. Write in formal academic prose â€” clear, logical, and well-structured
5. Follow the Nigerian/African academic research structure
6. Generate a funnel-shaped narrative (global â†’ regional â†’ local â†’ specific gap)
7. Ensure all references listed at the end are real publications with accurate details
8. Reference list should use full APA 7th format with DOI where applicable

IMPORTANT: Generate ONLY real citations from real papers. If uncertain, use commonly cited papers from top journals like Journal of Nursing Management, BMC Nursing, International Journal of Nursing Studies, African Journal of Nursing, etc. Never fabricate author names or paper titles.`;

function getSections() {
  const checks = document.querySelectorAll('input[name="sections"]:checked');
  return Array.from(checks).map(c => c.value);
}

function buildPrompt(topic, setting, population, field, sections, extra) {
  const sectionLabels = {
    background: '1.1 Background to the Study (5-7 paragraphs, funnel structure, heavily cited)',
    problem: '1.2 Statement of the Problem (3-4 paragraphs, identifying specific gaps)',
    objectives: '1.3 Objectives of the Study (Broad Objective + 3-4 Specific Objectives numbered)',
    questions: '1.4 Research Questions (matching specific objectives)',
    significance: '1.5 Significance of the Study (multiple stakeholder perspectives)',
    scope: '1.6 Scope of the Study (geographic, population, time scope)',
    definitions: '1.7 Operational Definition of Terms (8-10 key terms defined)',
    references: 'References (complete APA 7th edition list of all cited works)'
  };

  const selectedSections = sections.map(s => sectionLabels[s]).filter(Boolean);

  return `Generate a complete, scholarly CHAPTER ONE for the following research project:

RESEARCH TOPIC: ${topic}
STUDY SETTING: ${setting || 'Not specified'}
STUDY POPULATION: ${population || 'Not specified'}
RESEARCH FIELD: ${field}
ADDITIONAL CONTEXT: ${extra || 'None'}

Generate these sections:
${selectedSections.map((s, i) => `${i+1}. ${s}`).join('\n')}

FORMAT REQUIREMENTS:
- Start with: CHAPTER ONE
- Use proper academic headings (1.1, 1.2, etc.)
- All in-text citations in APA format: (Surname et al., Year) or (Surname & Surname, Year)
- Background must cite at least 12-15 different references, all from 2021-2024
- Problem statement: 10+ citations
- References section: full APA 7th format with real DOIs where possible
- Write in academic English â€” formal, precise, scholarly
- Minimum 2000 words for background section

The content should be highly specific to the topic, setting, and population provided. Use real research findings from actual published studies.`;
}

async function generateChapter() {
  const topic = document.getElementById('research-topic').value.trim();
  if (!topic) {
    showError('Please enter a research topic to proceed.');
    return;
  }

  const setting = document.getElementById('study-setting').value.trim();
  const population = document.getElementById('study-population').value.trim();
  const field = document.getElementById('research-field').value;
  const extra = document.getElementById('extra-context').value.trim();
  const sections = getSections();

  if (sections.length === 0) {
    showError('Please select at least one section to generate.');
    return;
  }

  clearError();
  setLoading(true);

  const loadingMessages = [
    'Searching verified academic sources...',
    'Analyzing recent literature (2021â€“2024)...',
    'Structuring background narrative...',
    'Formulating objectives and research questions...',
    'Compiling APA reference list...',
    'Finalizing academic content...'
  ];
  
  let msgIdx = 0;
  const msgInterval = setInterval(() => {
    document.getElementById('loading-sub').textContent = loadingMessages[msgIdx % loadingMessages.length];
    msgIdx++;
  }, 2500);

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 8000,
        system: SYSTEM_PROMPT,
        messages: [{
          role: 'user',
          content: buildPrompt(topic, setting, population, field, sections, extra)
        }]
      })
    });

    clearInterval(msgInterval);

    if (!response.ok) throw new Error(`API error: ${response.status}`);
    
    const data = await response.json();
    const text = data.content.map(c => c.text || '').join('');
    renderDocument(text);

  } catch (err) {
    clearInterval(msgInterval);
    showError('Generation failed: ' + err.message + '. Please try again.');
  } finally {
    setLoading(false);
  }
}

function renderDocument(rawText) {
  const doc = document.getElementById('output-document');
  const content = document.getElementById('doc-content');
  const placeholder = document.getElementById('output-placeholder');

  // Parse and format the content
  let html = formatAcademicText(rawText);
  content.innerHTML = html;
  
  placeholder.style.display = 'none';
  doc.style.display = 'block';
  
  // Smooth scroll to document
  doc.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function formatAcademicText(text) {
  // Split into lines and process
  const lines = text.split('\n');
  let html = '';
  let inList = false;
  let listType = '';

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) {
      if (inList) { html += `</${listType}>`;  inList = false; }
      continue;
    }

    // Chapter heading
    if (/^CHAPTER\s+ONE\s*$/i.test(line)) {
      html += `<h1>CHAPTER ONE</h1>`;
      continue;
    }

    // Numbered section headers like 1.1, 1.2, etc.
    if (/^\d+\.\d+\s+/.test(line)) {
      if (inList) { html += `</${listType}>`; inList = false; }
      html += `<h2>${escHtml(line)}</h2>`;
      continue;
    }

    // References heading
    if (/^References\s*$/i.test(line)) {
      if (inList) { html += `</${listType}>`; inList = false; }
      html += `<div class="references-section"><h2>References</h2>`;
      // Process remaining lines as references
      let refs = '';
      for (let j = i + 1; j < lines.length; j++) {
        const ref = lines[j].trim();
        if (ref) refs += `<p class="ref-item">${escHtml(ref)}</p>`;
      }
      html += refs + '</div>';
      break;
    }

    // Sub-headings like "Broad Objective:" or "Specific Objectives:"
    if (/^(Broad Objective|Specific Objectives|Research Questions):?\s*$/i.test(line)) {
      if (inList) { html += `</${listType}>`; inList = false; }
      html += `<h3>${escHtml(line)}</h3>`;
      continue;
    }

    // Numbered list items
    if (/^\d+\.\s+/.test(line) && !/^\d+\.\d+/.test(line)) {
      if (!inList || listType !== 'ol') {
        if (inList) html += `</${listType}>`;
        html += '<ol>'; inList = true; listType = 'ol';
      }
      html += `<li>${escHtml(line.replace(/^\d+\.\s+/, ''))}</li>`;
      continue;
    }

    // Close list if we hit a normal paragraph
    if (inList) { html += `</${listType}>`; inList = false; }

    html += `<p>${escHtml(line)}</p>`;
  }

  if (inList) html += `</${listType}>`;
  return html;
}

function escHtml(str) {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function setLoading(state) {
  const btn = document.getElementById('generate-btn');
  const overlay = document.getElementById('loading-overlay');
  
  btn.classList.toggle('loading', state);
  btn.disabled = state;
  overlay.classList.toggle('active', state);

  if (state) {
    document.getElementById('output-placeholder').style.display = 'block';
    document.getElementById('output-document').style.display = 'none';
  }
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  el.style.display = 'block';
}

function clearError() {
  document.getElementById('error-msg').style.display = 'none';
}

async function copyContent() {
  const content = document.getElementById('doc-content');
  const text = content.innerText;
  try {
    await navigator.clipboard.writeText(text);
    const btn = document.querySelector('.btn-copy');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy Text', 2000);
  } catch(e) {
    alert('Please use Ctrl+A then Ctrl+C to copy the document text.');
  }
}
</script>

</body>
</html>
